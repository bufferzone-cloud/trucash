<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="login-page">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1 class="login-logo">
                        <i class="fas fa-landmark"></i> TruCash
                    </h1>
                    <p class="login-subtitle">Collateral-Based Loan Management System</p>
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-input" placeholder="Enter your email" required>
                        <div class="form-error" id="emailError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                        <div class="form-error" id="passwordError"></div>
                    </div>
                    
                    <div class="form-group">
                        <div class="role-selector">
                            <button type="button" class="role-btn" data-role="customer">Customer</button>
                            <button type="button" class="role-btn" data-role="agent">Agent</button>
                            <button type="button" class="role-btn" data-role="admin">Admin</button>
                            <button type="button" class="role-btn active" data-role="sudo">SUDO</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="login-btn" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login to Dashboard
                    </button>
                    
                    <div class="form-group">
                        <div class="flex justify-between">
                            <a href="#" id="forgotPassword" class="text-sm">Forgot Password?</a>
                            <a href="#" id="registerLink" class="text-sm">Register as Agent</a>
                        </div>
                    </div>
                </form>
                
                <div class="login-footer">
                    <p class="text-xs">
                        <i class="fas fa-lock"></i> Secure Login • 
                        <i class="fas fa-shield-alt"></i> Encrypted Data • 
                        <i class="fas fa-history"></i> Full Audit Trail
                    </p>
                </div>
            </div>
            
            <!-- Registration Modal -->
            <div class="modal" id="registerModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Agent Registration</h3>
                        <button class="modal-close" id="closeRegisterModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="registerForm">
                            <div class="form-group">
                                <label for="regFullName" class="form-label">Full Name *</label>
                                <input type="text" id="regFullName" class="form-input" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="regEmail" class="form-label">Email Address *</label>
                                    <input type="email" id="regEmail" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="regPhone" class="form-label">Phone Number *</label>
                                    <input type="tel" id="regPhone" class="form-input" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="regPassword" class="form-label">Password *</label>
                                    <input type="password" id="regPassword" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="regConfirmPassword" class="form-label">Confirm Password *</label>
                                    <input type="password" id="regConfirmPassword" class="form-input" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="regNRC" class="form-label">NRC Number *</label>
                                <input type="text" id="regNRC" class="form-input" placeholder="e.g., 123456/78/9" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">NRC Photos *</label>
                                <div class="file-upload" id="nrcUploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                    <p class="text-sm mb-2">Click to upload or drag & drop</p>
                                    <p class="text-xs text-gray-500">Front and back of NRC (Max 5MB each)</p>
                                    <input type="file" id="nrcFront" class="file-input" accept="image/*" multiple>
                                </div>
                                <div class="file-preview" id="nrcPreview"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Profile Photo *</label>
                                <div class="file-upload" id="profileUploadArea">
                                    <i class="fas fa-user-circle fa-2x mb-3"></i>
                                    <p class="text-sm mb-2">Click to upload profile photo</p>
                                    <p class="text-xs text-gray-500">Clear face photo (Max 5MB)</p>
                                    <input type="file" id="profilePhoto" class="file-input" accept="image/*">
                                </div>
                                <div class="file-preview" id="profilePreview"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="cancelRegister">Cancel</button>
                        <button class="btn btn-primary" id="submitRegister">
                            <i class="fas fa-user-plus"></i> Register as Agent
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Forgot Password Modal -->
            <div class="modal" id="forgotPasswordModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Reset Password</h3>
                        <button class="modal-close" id="closeForgotModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="resetEmail" class="form-label">Enter your email address</label>
                            <input type="email" id="resetEmail" class="form-input" placeholder="you@example.com">
                        </div>
                        <p class="text-sm text-gray-500 mt-2">
                            We'll send you a link to reset your password.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="cancelReset">Cancel</button>
                        <button class="btn btn-primary" id="submitReset">
                            <i class="fas fa-paper-plane"></i> Send Reset Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    <script src="cloudinary.js"></script>
    <script>
        // Login Page JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const roleBtns = document.querySelectorAll('.role-btn');
            const registerLink = document.getElementById('registerLink');
            const forgotPasswordLink = document.getElementById('forgotPassword');
            
            // Modals
            const registerModal = document.getElementById('registerModal');
            const forgotPasswordModal = document.getElementById('forgotPasswordModal');
            
            // Current role selection
            let currentRole = 'sudo';
            
            // Set SUDO credentials by default
            emailInput.value = 'trucash@gmail.com';
            passwordInput.value = '123456';
            
            // Role selection
            roleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    roleBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentRole = this.dataset.role;
                    
                    // Update placeholder text based on role
                    switch(currentRole) {
                        case 'customer':
                            emailInput.placeholder = 'customer@example.com';
                            break;
                        case 'agent':
                            emailInput.placeholder = 'agent@example.com';
                            break;
                        case 'admin':
                            emailInput.placeholder = 'admin@example.com';
                            break;
                        case 'sudo':
                            emailInput.placeholder = 'trucash@gmail.com';
                            emailInput.value = 'trucash@gmail.com';
                            passwordInput.value = '123456';
                            break;
                    }
                });
            });
            
            // Login form submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                
                // Validate inputs
                if (!email || !password) {
                    showError('Please fill in all fields');
                    return;
                }
                
                // Show loading state
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                loginBtn.disabled = true;
                
                try {
                    const result = await authManager.login(email, password);
                    
                    if (result.success) {
                        // Check if user role matches selected role
                        const userData = await db.getUserData(result.user.uid);
                        
                        if (userData.role !== currentRole && currentRole !== 'sudo') {
                            // If SUDO is logging in as other role for testing
                            if (userData.role === 'sudo') {
                                // Allow SUDO to access any dashboard
                                window.location.href = currentRole + '.html';
                            } else {
                                showError(`Please login as ${userData.role}`);
                                resetLoginButton();
                            }
                        } else {
                            // Successful login - authManager will handle redirect
                            showNotification('Login successful! Redirecting...', 'success');
                        }
                    } else {
                        showError(result.error);
                        resetLoginButton();
                    }
                } catch (error) {
                    showError('An error occurred. Please try again.');
                    console.error('Login error:', error);
                    resetLoginButton();
                }
            });
            
            // Register link click
            registerLink.addEventListener('click', function(e) {
                e.preventDefault();
                registerModal.classList.add('active');
            });
            
            // Forgot password link
            forgotPasswordLink.addEventListener('click', function(e) {
                e.preventDefault();
                forgotPasswordModal.classList.add('active');
            });
            
            // Close modals
            document.getElementById('closeRegisterModal').addEventListener('click', function() {
                registerModal.classList.remove('active');
            });
            
            document.getElementById('cancelRegister').addEventListener('click', function() {
                registerModal.classList.remove('active');
            });
            
            document.getElementById('closeForgotModal').addEventListener('click', function() {
                forgotPasswordModal.classList.remove('active');
            });
            
            document.getElementById('cancelReset').addEventListener('click', function() {
                forgotPasswordModal.classList.remove('active');
            });
            
            // Forgot password submission
            document.getElementById('submitReset').addEventListener('click', async function() {
                const email = document.getElementById('resetEmail').value.trim();
                
                if (!email) {
                    showError('Please enter your email address');
                    return;
                }
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                this.disabled = true;
                
                try {
                    const result = await authManager.resetPassword(email);
                    
                    if (result.success) {
                        showNotification('Password reset link sent to your email', 'success');
                        forgotPasswordModal.classList.remove('active');
                    } else {
                        showError(result.error);
                    }
                } catch (error) {
                    showError('Failed to send reset link');
                }
                
                this.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reset Link';
                this.disabled = false;
            });
            
            // Agent registration
            document.getElementById('submitRegister').addEventListener('click', async function() {
                const form = document.getElementById('registerForm');
                const formData = new FormData(form);
                
                // Validate form
                const fullName = document.getElementById('regFullName').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const phone = document.getElementById('regPhone').value.trim();
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('regConfirmPassword').value;
                const nrc = document.getElementById('regNRC').value.trim();
                
                if (!fullName || !email || !phone || !password || !confirmPassword || !nrc) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }
                
                if (password.length < 6) {
                    showError('Password must be at least 6 characters');
                    return;
                }
                
                // Validate NRC format (Zambian NRC: 123456/78/9)
                const nrcRegex = /^\d{6}\/\d{2}\/\d{1}$/;
                if (!nrcRegex.test(nrc)) {
                    showError('Invalid NRC format. Use: 123456/78/9');
                    return;
                }
                
                // Validate phone number (Zambian format)
                const phoneRegex = /^\+?260?\d{9}$/;
                if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
                    showError('Invalid phone number. Use Zambian format: +260XXXXXXXXX');
                    return;
                }
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
                this.disabled = true;
                
                try {
                    // Upload NRC photos
                    const nrcFrontInput = document.getElementById('nrcFront');
                    const profilePhotoInput = document.getElementById('profilePhoto');
                    
                    if (!nrcFrontInput.files.length || !profilePhotoInput.files.length) {
                        showError('Please upload required documents');
                        this.innerHTML = '<i class="fas fa-user-plus"></i> Register as Agent';
                        this.disabled = false;
                        return;
                    }
                    
                    // Upload files to Cloudinary
                    const nrcFiles = Array.from(nrcFrontInput.files);
                    const profileFile = profilePhotoInput.files[0];
                    
                    showNotification('Uploading documents...', 'info');
                    
                    const uploadResults = await Promise.all([
                        ...nrcFiles.map(file => cloudinary.uploadFile(file, 'nrc')),
                        cloudinary.uploadFile(profileFile, 'profile')
                    ]);
                    
                    const nrcPhotos = uploadResults.slice(0, nrcFiles.length).map(r => r.url);
                    const profilePhoto = uploadResults[uploadResults.length - 1].url;
                    
                    // Prepare agent data
                    const agentData = {
                        fullName: fullName,
                        phone: phone,
                        nrcNumber: nrc,
                        nrcPhotos: nrcPhotos,
                        profilePhoto: profilePhoto,
                        role: 'agent',
                        status: 'pending',
                        registrationDate: new Date().toISOString()
                    };
                    
                    // Register agent
                    const result = await authManager.register(email, password, agentData, 'agent');
                    
                    if (result.success) {
                        showNotification('Registration successful! Awaiting admin approval.', 'success');
                        registerModal.classList.remove('active');
                        form.reset();
                        
                        // Clear previews
                        document.getElementById('nrcPreview').innerHTML = '';
                        document.getElementById('profilePreview').innerHTML = '';
                    } else {
                        showError(result.error);
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    showError('Registration failed. Please try again.');
                }
                
                this.innerHTML = '<i class="fas fa-user-plus"></i> Register as Agent';
                this.disabled = false;
            });
            
            // File upload handling
            setupFileUpload('nrcUploadArea', 'nrcFront', 'nrcPreview', 'NRC');
            setupFileUpload('profileUploadArea', 'profilePhoto', 'profilePreview', 'Profile Photo');
            
            // Helper Functions
            function setupFileUpload(uploadAreaId, inputId, previewId, label) {
                const uploadArea = document.getElementById(uploadAreaId);
                const fileInput = document.getElementById(inputId);
                const previewArea = document.getElementById(previewId);
                
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileSelect(fileInput.files, previewArea, label);
                    }
                });
                
                fileInput.addEventListener('change', () => {
                    handleFileSelect(fileInput.files, previewArea, label);
                });
                
                function handleFileSelect(files, previewArea, label) {
                    previewArea.innerHTML = '';
                    
                    Array.from(files).forEach((file, index) => {
                        if (!file.type.startsWith('image/')) {
                            showError(`${label} must be an image file`);
                            return;
                        }
                        
                        if (file.size > 5 * 1024 * 1024) {
                            showError(`${label} must be less than 5MB`);
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.maxWidth = '100px';
                            img.style.maxHeight = '100px';
                            
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            fileItem.appendChild(img);
                            
                            const removeBtn = document.createElement('div');
                            removeBtn.className = 'file-remove';
                            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                            removeBtn.addEventListener('click', () => {
                                fileItem.remove();
                                // Clear file input
                                fileInput.value = '';
                            });
                            
                            fileItem.appendChild(removeBtn);
                            previewArea.appendChild(fileItem);
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }
            
            function showError(message) {
                const notification = document.createElement('div');
                notification.className = 'notification error';
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div>${message}</div>
                `;
                
                document.querySelector('.login-container').appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('active');
                }, 10);
                
                setTimeout(() => {
                    notification.classList.remove('active');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
            
            function showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    </div>
                    <div>${message}</div>
                `;
                
                document.querySelector('.login-container').appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('active');
                }, 10);
                
                setTimeout(() => {
                    notification.classList.remove('active');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
            
            function resetLoginButton() {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Dashboard';
                loginBtn.disabled = false;
            }
            
            // Initialize auth manager
            authManager.initAuthListener();
        });
    </script>
</body>
</html>
