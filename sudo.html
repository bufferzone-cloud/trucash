<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | SUDO Super Control Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse for CSV Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== macOS Theme CSS Reset ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
                       'Helvetica Neue', 'Segoe UI', Roboto, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --macos-gray-100: #f5f5f7;
            --macos-gray-200: #e5e5e7;
            --macos-gray-300: #d2d2d7;
            --macos-gray-400: #86868b;
            --macos-gray-500: #515154;
            --macos-gray-600: #1d1d1f;
            --macos-blue: #007AFF;
            --macos-blue-light: #409cff;
            --macos-blue-dark: #0056cc;
            --macos-green: #34c759;
            --macos-red: #ff3b30;
            --macos-purple: #5856d6;
            --macos-yellow: #ffcc00;
            --macos-orange: #ff9500;
            --macos-pink: #ff2d55;
            --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --macos-shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
            --macos-shadow-light: 0 2px 6px rgba(0, 0, 0, 0.04);
            --macos-border-radius: 12px;
            --macos-border-radius-small: 8px;
            --macos-border-radius-large: 16px;
            --macos-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --macos-glass: rgba(255, 255, 255, 0.85);
            --macos-glass-border: rgba(255, 255, 255, 0.2);
            --macos-danger-bg: rgba(255, 59, 48, 0.1);
            --macos-warning-bg: rgba(255, 204, 0, 0.1);
            --macos-success-bg: rgba(52, 199, 89, 0.1);
            --macos-info-bg: rgba(0, 122, 255, 0.1);
            --macos-sidebar-width: 280px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--macos-gray-600);
            min-height: 100vh;
            line-height: 1.4;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(at 10% 20%, rgba(120, 119, 198, 0.03) 0px, transparent 50%),
                radial-gradient(at 90% 10%, rgba(0, 122, 255, 0.03) 0px, transparent 50%),
                radial-gradient(at 50% 90%, rgba(76, 175, 80, 0.03) 0px, transparent 50%);
            z-index: -1;
        }

        /* ===== SUDO Header ===== */
        .sudo-header {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--macos-glass-border);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--macos-shadow-light);
        }

        .sudo-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sudo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--macos-red) 0%, var(--macos-orange) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .sudo-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--macos-gray-600);
            letter-spacing: -0.3px;
        }

        .sudo-subtitle {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .live-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            background: var(--macos-success-bg);
            color: var(--macos-green);
            border-radius: 20px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--macos-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* ===== Main Layout ===== */
        .sudo-container {
            display: flex;
            min-height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* ===== Sidebar Navigation ===== */
        .sudo-sidebar {
            width: var(--macos-sidebar-width);
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--macos-glass-border);
            padding: 24px 0;
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 900;
        }

        .nav-section {
            margin-bottom: 24px;
            padding: 0 20px;
        }

        .nav-title {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--macos-gray-500);
            text-decoration: none;
            border-radius: var(--macos-border-radius);
            transition: var(--macos-transition);
            margin-bottom: 4px;
            cursor: pointer;
            user-select: none;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--macos-gray-600);
        }

        .nav-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .nav-item.active .nav-icon {
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-gray-400);
        }

        .nav-text {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 600;
        }

        /* ===== Main Content ===== */
        .sudo-main {
            flex: 1;
            margin-left: var(--macos-sidebar-width);
            padding: 24px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-gray-600);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--macos-gray-400);
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            transition: var(--macos-transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.users { background: var(--macos-info-bg); color: var(--macos-blue); }
        .stat-icon.agents { background: var(--macos-success-bg); color: var(--macos-green); }
        .stat-icon.transactions { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .stat-icon.revenue { background: var(--macos-danger-bg); color: var(--macos-red); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-gray-600);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--macos-gray-400);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--macos-green);
        }

        .stat-change.negative {
            color: var(--macos-red);
        }

        /* ===== Cards Grid ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius-large);
            overflow: hidden;
            transition: var(--macos-transition);
        }

        .card:hover {
            box-shadow: var(--macos-shadow);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* ===== Form Elements ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: 1px solid var(--macos-gray-200);
            border-radius: var(--macos-border-radius-small);
            background: rgba(255, 255, 255, 0.9);
            transition: var(--macos-transition);
            color: var(--macos-gray-600);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }

        .form-control::placeholder {
            color: var(--macos-gray-400);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* ===== Tables ===== */
        .table-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: rgba(0, 0, 0, 0.02);
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table td {
            padding: 16px;
            font-size: 13px;
            color: var(--macos-gray-600);
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table tbody tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
        }

        .status-active { background: var(--macos-success-bg); color: var(--macos-green); }
        .status-inactive { background: var(--macos-gray-200); color: var(--macos-gray-500); }
        .status-suspended { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .status-banned { background: var(--macos-danger-bg); color: var(--macos-red); }
        .status-pending { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
            background: var(--macos-info-bg);
            color: var(--macos-blue);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 10px 18px;
            border-radius: var(--macos-border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--macos-transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-blue-light) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--macos-blue-dark) 0%, var(--macos-blue) 100%);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--macos-red) 0%, #ff5a5a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #cc2e25 0%, var(--macos-red) 100%);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.35);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--macos-green) 0%, #2db867 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, var(--macos-green) 100%);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.35);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--macos-gray-300);
            color: var(--macos-gray-600);
        }

        .btn-outline:hover {
            background: rgba(0, 0, 0, 0.03);
            border-color: var(--macos-gray-400);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== Toggle Switches ===== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--macos-gray-300);
            transition: var(--macos-transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--macos-transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--macos-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ===== Charts ===== */
        .chart-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
            margin-bottom: 16px;
        }

        /* ===== Modals ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: var(--macos-border-radius-large);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-heavy);
            border: 1px solid var(--macos-glass-border);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .modal-close {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            font-size: 16px;
            color: var(--macos-gray-500);
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--macos-transition);
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== Loading Overlay ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-200);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--macos-gray-600);
            font-weight: 500;
        }

        /* ===== Notifications ===== */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--macos-border-radius);
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            box-shadow: var(--macos-shadow-heavy);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1500;
            transform: translateX(calc(100% + 24px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 320px;
            border: 1px solid var(--macos-glass-border);
        }

        .notification.active {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--macos-green);
        }

        .notification.error {
            border-left: 4px solid var(--macos-red);
        }

        .notification.info {
            border-left: 4px solid var(--macos-blue);
        }

        .notification.warning {
            border-left: 4px solid var(--macos-yellow);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success .notification-icon {
            color: var(--macos-green);
        }

        .notification.error .notification-icon {
            color: var(--macos-red);
        }

        .notification.info .notification-icon {
            color: var(--macos-blue);
        }

        .notification.warning .notification-icon {
            color: var(--macos-yellow);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
            color: var(--macos-gray-600);
        }

        .notification-message {
            font-size: 12px;
            color: var(--macos-gray-500);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--macos-gray-400);
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--macos-transition);
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--macos-gray-600);
        }

        /* ===== Code Editor ===== */
        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .code-header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .code-language {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
        }

        .code-body {
            padding: 16px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-body pre {
            margin: 0;
        }

        /* ===== Alert Boxes ===== */
        .alert {
            padding: 16px;
            border-radius: var(--macos-border-radius);
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-danger {
            background: var(--macos-danger-bg);
            border-left-color: var(--macos-red);
            color: var(--macos-red);
        }

        .alert-warning {
            background: var(--macos-warning-bg);
            border-left-color: var(--macos-yellow);
            color: var(--macos-yellow);
        }

        .alert-success {
            background: var(--macos-success-bg);
            border-left-color: var(--macos-green);
            color: var(--macos-green);
        }

        .alert-info {
            background: var(--macos-info-bg);
            border-left-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sudo-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sudo-sidebar.active {
                transform: translateX(0);
            }

            .sudo-main {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sudo-header {
                padding: 0 16px;
            }

            .sudo-main {
                padding: 16px;
            }

            .card-header, .card-body {
                padding: 16px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* ===== Utility Classes ===== */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }
        .w-100 { width: 100%; }
        .mt-16 { margin-top: 16px; }
        .mb-16 { margin-bottom: 16px; }
        .mb-24 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--macos-gray-400); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-yellow); }
        .text-info { color: var(--macos-blue); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }

        /* ===== Custom Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--macos-gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-300);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-400);
        }

        /* ===== File Upload Styles ===== */
        .file-upload-container {
            border: 2px dashed var(--macos-gray-300);
            border-radius: var(--macos-border-radius);
            padding: 24px;
            text-align: center;
            transition: var(--macos-transition);
            cursor: pointer;
        }

        .file-upload-container:hover {
            border-color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.02);
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--macos-gray-300);
            margin-bottom: 12px;
        }

        .file-upload-text {
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: var(--macos-gray-400);
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--macos-gray-100);
            border-radius: var(--macos-border-radius-small);
            margin-bottom: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            color: var(--macos-blue);
        }

        /* ===== Progress Bar ===== */
        .progress-container {
            background: var(--macos-gray-200);
            border-radius: 10px;
            overflow: hidden;
            height: 6px;
            margin: 8px 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--macos-blue), var(--macos-purple));
            height: 100%;
            transition: width 0.3s ease;
        }

        /* ===== Search Filters ===== */
        .filter-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== Data Export Styles ===== */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .export-option {
            padding: 20px;
            background: var(--macos-glass);
            border-radius: var(--macos-border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--macos-transition);
            border: 1px solid var(--macos-glass-border);
        }

        .export-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .export-icon {
            font-size: 32px;
            color: var(--macos-blue);
            margin-bottom: 12px;
        }

        /* ===== Pagination ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--macos-border-radius-small);
            border: 1px solid var(--macos-gray-200);
            background: white;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .page-btn:hover:not(.disabled) {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        .page-btn.active {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading SUDO Control Panel...</div>
    </div>

    <!-- SUDO Header -->
    <header class="sudo-header">
        <div class="sudo-logo">
            <div class="sudo-icon">SU</div>
            <div>
                <div class="sudo-title">TruCash SUDO</div>
                <div class="sudo-subtitle">Super Control Admin</div>
            </div>
        </div>
        <div class="header-actions">
            <div class="live-status">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">SU</div>
                <div>
                    <div style="font-size: 13px; font-weight: 600;" id="userName">SUDO Admin</div>
                    <div style="font-size: 11px; color: var(--macos-gray-400);" id="userRole">Full System Control</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="sudo-container">
        <!-- Sidebar Navigation -->
        <nav class="sudo-sidebar">
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <div class="nav-item active" data-section="dashboard">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Overview</div>
                </div>
                <div class="nav-item" data-section="analytics">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="nav-text">Analytics</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">User Management</div>
                <div class="nav-item" data-section="admins">
                    <div class="nav-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="nav-text">Admin Accounts</div>
                </div>
                <div class="nav-item" data-section="agents">
                    <div class="nav-icon"><i class="fas fa-id-badge"></i></div>
                    <div class="nav-text">Agent Accounts</div>
                </div>
                <div class="nav-item" data-section="customers">
                    <div class="nav-icon"><i class="fas fa-users"></i></div>
                    <div class="nav-text">Customer Accounts</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System Control</div>
                <div class="nav-item" data-section="features">
                    <div class="nav-icon"><i class="fas fa-toggle-on"></i></div>
                    <div class="nav-text">Feature Flags</div>
                </div>
                <div class="nav-item" data-section="financial">
                    <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="nav-text">Financial Settings</div>
                </div>
                <div class="nav-item" data-section="repayment">
                    <div class="nav-icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="nav-text">Repayment Plans</div>
                </div>
                <div class="nav-item" data-section="notifications">
                    <div class="nav-icon"><i class="fas fa-bell"></i></div>
                    <div class="nav-text">Notifications</div>
                </div>
                <div class="nav-item" data-section="ui-settings">
                    <div class="nav-icon"><i class="fas fa-sliders-h"></i></div>
                    <div class="nav-text">UI Behavior</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Security & Monitoring</div>
                <div class="nav-item" data-section="security">
                    <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="nav-text">Security Settings</div>
                </div>
                <div class="nav-item" data-section="audit">
                    <div class="nav-icon"><i class="fas fa-history"></i></div>
                    <div class="nav-text">Audit Logs</div>
                    <div class="nav-badge" id="auditBadge">0</div>
                </div>
                <div class="nav-item" data-section="backup">
                    <div class="nav-icon"><i class="fas fa-database"></i></div>
                    <div class="nav-text">Backup & Export</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Manual Intervention</div>
                <div class="nav-item" data-section="manual">
                    <div class="nav-icon"><i class="fas fa-hands-helping"></i></div>
                    <div class="nav-text">Manual Adjustments</div>
                </div>
                <div class="nav-item" data-section="disputes">
                    <div class="nav-icon"><i class="fas fa-gavel"></i></div>
                    <div class="nav-text">Dispute Resolution</div>
                    <div class="nav-badge" id="disputeBadge">0</div>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item" data-action="logout">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="sudo-main">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1 class="section-title">System Overview</h1>
                    <div class="section-subtitle">Real-time monitoring of the entire TruCash platform</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-icon users"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="userGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Active Agents</div>
                                <div class="stat-value" id="activeAgents">0</div>
                            </div>
                            <div class="stat-icon agents"><i class="fas fa-id-badge"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="agentGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Transactions Today</div>
                                <div class="stat-value" id="todayTransactions">0</div>
                            </div>
                            <div class="stat-icon transactions"><i class="fas fa-exchange-alt"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="transactionGrowth">0%</span> vs yesterday
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Platform Revenue</div>
                                <div class="stat-value" id="platformRevenue">$0</div>
                            </div>
                            <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="revenueGrowth">0%</span> this month
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Health</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshSystemHealth()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Database Connection</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Firebase Realtime Database</span>
                                    <span class="status-badge status-active" id="dbStatus">Connected</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Active Sessions</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Current Active Users</span>
                                    <span class="font-semibold" id="activeSessions">0</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">System Load</label>
                                <div class="d-flex align-center justify-between">
                                    <span>API Response Time</span>
                                    <span class="font-semibold" id="apiResponseTime">0ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-8 mb-16">
                                <button class="btn btn-primary" onclick="openCreateAdminModal()">
                                    <i class="fas fa-user-plus"></i> Create Admin
                                </button>
                                <button class="btn btn-success" onclick="openCreateAgentModal()">
                                    <i class="fas fa-id-card"></i> Create Agent
                                </button>
                                <button class="btn btn-outline" onclick="openManualAdjustmentModal()">
                                    <i class="fas fa-edit"></i> Manual Adjustment
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-8">
                                <button class="btn btn-outline" onclick="openFeatureFlagModal()">
                                    <i class="fas fa-toggle-on"></i> Feature Flags
                                </button>
                                <button class="btn btn-outline" onclick="viewAuditLogs()">
                                    <i class="fas fa-history"></i> View Audit Logs
                                </button>
                                <button class="btn btn-outline" onclick="openBackupModal()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Real-time System Activity</div>
                    <canvas id="activityChart"></canvas>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admins" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Admin Accounts Management</h1>
                    <div class="section-subtitle">Create, edit, suspend, and delete admin accounts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateAdminModal()">
                            <i class="fas fa-user-plus"></i> Create New Admin
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 300px;" placeholder="Search admins..." id="adminSearch" onkeyup="searchAdmins()">
                        <button class="btn btn-outline" onclick="refreshAdminList()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="adminsTable">
                        <thead>
                            <tr>
                                <th>Admin ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Admin rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="adminPagination"></div>
            </section>

            <!-- Agent Management Section -->
            <section id="agents" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Agent Accounts Management</h1>
                    <div class="section-subtitle">Manage all agent accounts and their permissions</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <button class="btn btn-primary" onclick="openCreateAgentModal()">
                            <i class="fas fa-user-plus"></i> Create Agent
                        </button>
                        <button class="btn btn-outline" onclick="openBulkAgentActions()">
                            <i class="fas fa-users-cog"></i> Bulk Actions
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="agentStatusFilter" onchange="filterAgents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search agents..." id="agentSearch" onkeyup="searchAgents()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="agentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Clients</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <!-- Agent rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="agentPagination"></div>
            </section>

            <!-- Customer Management Section -->
            <section id="customers" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Customer Accounts Management</h1>
                    <div class="section-subtitle">Manage customer access controls and permissions</div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Transaction Limits</div>
                                    <div class="text-muted" style="font-size: 12px;">Configure customer transaction caps</div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="configureTransactionLimits()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Daily Limit</label>
                                <input type="number" class="form-control" id="dailyLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Single Transaction</label>
                                <input type="number" class="form-control" id="singleTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Account Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Set verification requirements</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoVerification" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Required Documents</label>
                                <select class="form-control" id="requiredDocs" multiple style="height: 120px;">
                                    <option value="nrc" selected>National ID (NRC)</option>
                                    <option value="passport" selected>Passport</option>
                                    <option value="drivers_license">Driver's License</option>
                                    <option value="proof_of_address">Proof of Address</option>
                                    <option value="employment_letter">Employment Letter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="customerStatusFilter" onchange="filterCustomers()">
                            <option value="all">All Status</option>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search customers..." id="customerSearch" onkeyup="searchCustomers()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Loan Limit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customer rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="customerPagination"></div>
            </section>

            <!-- Feature Flags Section -->
            <section id="features" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Feature Flags & Module Control</h1>
                    <div class="section-subtitle">Enable or disable features across the platform in real-time</div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Changes to feature flags are applied immediately across all interfaces without requiring redeployment.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Customer Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Applications</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow customers to apply for loans</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_applications" checked data-feature="loan_applications">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Online Repayments</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable online loan repayments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_online_repayments" checked data-feature="online_repayments">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Collateral Upload</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow collateral document upload</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_collateral_upload" checked data-feature="collateral_upload">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Client Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow agents to verify clients</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_client_verification" checked data-feature="client_verification">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Processing</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable loan processing by agents</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_processing" checked data-feature="loan_processing">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Commission Tracking</div>
                                    <div class="text-muted" style="font-size: 12px;">Show commission calculations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_commission_tracking" checked data-feature="commission_tracking">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Maintenance Mode</div>
                                    <div class="text-muted" style="font-size: 12px;">Put system under maintenance</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_maintenance_mode" data-feature="maintenance_mode">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">New User Registration</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow new user registrations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_new_registrations" checked data-feature="new_registrations">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Audit Logging</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable system audit logs</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_audit_logging" checked data-feature="audit_logging">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Feature Configuration Details</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Feature JSON Configuration</label>
                            <div class="code-editor">
                                <div class="code-header">
                                    <div class="code-language">JSON</div>
                                    <button class="btn btn-sm btn-outline" onclick="updateFeatureFlags()">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </div>
                                <div class="code-body">
                                    <pre id="featureJsonEditor">{
  "customer_features": {
    "loan_applications": true,
    "online_repayments": true,
    "collateral_upload": true
  },
  "agent_features": {
    "client_verification": true,
    "loan_processing": true,
    "commission_tracking": true
  },
  "system_features": {
    "maintenance_mode": false,
    "new_registrations": true,
    "audit_logging": true
  }
}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financial Settings Section -->
            <section id="financial" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Financial System Configuration</h1>
                    <div class="section-subtitle">Control all financial parameters and transaction rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Limits</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount</label>
                                <input type="number" class="form-control" id="minLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount</label>
                                <input type="number" class="form-control" id="maxLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Daily Transaction Limit</label>
                                <input type="number" class="form-control" id="dailyTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Fees & Commissions</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Service Charge (%)</label>
                                <input type="number" class="form-control" id="serviceCharge" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Commission (%)</label>
                                <input type="number" class="form-control" id="agentCommission" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Late Payment Fee (%)</label>
                                <input type="number" class="form-control" id="latePaymentFee" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Approval Thresholds</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto-approval Limit</label>
                                <input type="number" class="form-control" id="autoApprovalLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manual Review Threshold</label>
                                <input type="number" class="form-control" id="manualReviewThreshold" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Threshold (%)</label>
                                <input type="number" class="form-control" id="riskThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Currency & Formatting</div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Default Currency</label>
                                <select class="form-control" id="defaultCurrency">
                                    <option value="USD">USD ($)</option>
                                    <option value="ZMW">ZMW (K)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Decimal Places</label>
                                <select class="form-control" id="decimalPlaces">
                                    <option value="0">0 (e.g., 100)</option>
                                    <option value="2" selected>2 (e.g., 100.00)</option>
                                    <option value="3">3 (e.g., 100.000)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency Format</label>
                            <select class="form-control" id="currencyFormat">
                                <option value="symbol_before">Symbol before ($100)</option>
                                <option value="symbol_after">Symbol after (100$)</option>
                                <option value="code_before">Code before (USD 100)</option>
                                <option value="code_after">Code after (100 USD)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveFinancialSettings()">
                        <i class="fas fa-save"></i> Save All Financial Settings
                    </button>
                </div>
            </section>

            <!-- Repayment Plans Section -->
            <section id="repayment" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Repayment Plans & Penalty Systems</h1>
                    <div class="section-subtitle">Define repayment timelines, installment structures, and penalty rules</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateRepaymentPlanModal()">
                            <i class="fas fa-plus-circle"></i> Create New Plan
                        </button>
                    </div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Penalty Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Late Payment Penalty (%)</label>
                                <input type="number" class="form-control" id="latePenaltyRate" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grace Period (Days)</label>
                                <input type="number" class="form-control" id="gracePeriodDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" class="form-control" id="defaultInterestRate" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Escalation Rules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Days to Auto-Restriction</label>
                                <input type="number" class="form-control" id="autoRestrictionDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Escalation Threshold (%)</label>
                                <input type="number" class="form-control" id="escalationThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collection Agency Trigger</label>
                                <input type="number" class="form-control" id="collectionTriggerDays" placeholder="Enter days">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-16">
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search repayment plans..." id="repaymentPlanSearch" onkeyup="searchRepaymentPlans()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="repaymentPlansTable">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Plan Name</th>
                                <th>Duration</th>
                                <th>Interest Rate</th>
                                <th>Installments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repaymentPlansBody">
                            <!-- Repayment plan rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="repaymentPagination"></div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Notification System Configuration</h1>
                    <div class="section-subtitle">Configure automated notifications and alerts</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Payment Reminders</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Payment Reminders</div>
                                    <div class="text-muted" style="font-size: 12px;">Send automatic payment reminders</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_payment_reminders" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Days Before Due Date</label>
                                <input type="number" class="form-control" id="reminderDaysBefore" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reminder Frequency</label>
                                <select class="form-control" id="reminderFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Overdue Alerts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Overdue Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Send alerts for overdue payments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_overdue_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert After (Days)</label>
                                <input type="number" class="form-control" id="overdueAlertDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Alerts</label>
                                <input type="number" class="form-control" id="maxOverdueAlerts" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Security Notifications</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Login Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on new device login</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_login_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Account Changes</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on account modifications</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_account_changes" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Security Warnings</div>
                                    <div class="text-muted" style="font-size: 12px;">Send security warnings</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_security_warnings" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Notification Templates</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Payment Reminder Template</label>
                            <textarea class="form-control form-textarea" id="paymentReminderTemplate" rows="4">Dear {customer_name}, your payment of {amount} is due on {due_date}. Please make payment to avoid penalties.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overdue Alert Template</label>
                            <textarea class="form-control form-textarea" id="overdueAlertTemplate" rows="4">URGENT: Your payment of {amount} is overdue by {days_overdue} days. Please make immediate payment to avoid account restrictions.</textarea>
                        </div>
                        <div class="text-right">
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Save Notification Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- UI Behavior Section -->
            <section id="ui-settings" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">UI Behavior & Layout Configuration</h1>
                    <div class="section-subtitle">Control dashboard layouts, visible modules, and interface behavior</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Dashboard Layouts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Dashboard</label>
                                <select class="form-control" id="customerDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="compact">Compact Layout</option>
                                    <option value="detailed">Detailed Layout</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Dashboard</label>
                                <select class="form-control" id="agentDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="analytics">Analytics Focus</option>
                                    <option value="client_management">Client Management Focus</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Admin Dashboard</label>
                                <select class="form-control" id="adminDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="monitoring">Monitoring Focus</option>
                                    <option value="approval">Approval Focus</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Visible Modules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Modules</label>
                                <select class="form-control" id="customerModules" multiple style="height: 150px;">
                                    <option value="loans" selected>Loans</option>
                                    <option value="repayments" selected>Repayments</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="collateral" selected>Collateral</option>
                                    <option value="profile" selected>Profile</option>
                                    <option value="notifications" selected>Notifications</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">UI Behavior</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Auto-refresh Data</div>
                                    <div class="text-muted" style="font-size: 12px;">Auto-refresh dashboard data</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_auto_refresh" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Show Tutorials</div>
                                    <div class="text-muted" style="font-size: 12px;">Show onboarding tutorials</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_show_tutorials" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Animations</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable UI animations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_animations" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveUISettings()">
                        <i class="fas fa-save"></i> Save UI Configuration
                    </button>
                </div>
            </section>

            <!-- Security Settings Section -->
            <section id="security" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Security System Configuration</h1>
                    <div class="section-subtitle">Configure security parameters and access controls</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Session Management</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Session Timeout (Minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Concurrent Sessions</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force Logout on Inactivity</label>
                                <select class="form-control" id="forceLogout">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Login Security</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Max Login Attempts</label>
                                <input type="number" class="form-control" id="maxLoginAttempts" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account Lockout Duration (Minutes)</label>
                                <input type="number" class="form-control" id="lockoutDuration" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP Lockout Threshold</label>
                                <input type="number" class="form-control" id="ipLockoutThreshold" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Password Policies</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Password Length</label>
                                <input type="number" class="form-control" id="minPasswordLength" placeholder="Enter length">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password Expiry (Days)</label>
                                <input type="number" class="form-control" id="passwordExpiryDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password History</label>
                                <input type="number" class="form-control" id="passwordHistoryCount" placeholder="Enter number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Advanced Security</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">Two-Factor Authentication</div>
                                <div class="text-muted" style="font-size: 12px;">Require 2FA for admin access</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_2fa">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">IP Whitelisting</div>
                                <div class="text-muted" style="font-size: 12px;">Restrict access to specific IPs</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_ip_whitelist">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allowed IP Addresses (Comma-separated)</label>
                            <textarea class="form-control form-textarea" id="allowedIPs" rows="3" placeholder="192.168.1.1, 10.0.0.1"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">
                        <i class="fas fa-save"></i> Save Security Settings
                    </button>
                </div>
            </section>

            <!-- Audit Logs Section -->
            <section id="audit" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Audit Logs</h1>
                    <div class="section-subtitle">Complete audit trail of all system activities</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="auditUserType" onchange="filterAuditLogs()">
                            <option value="all">All Users</option>
                            <option value="admin">Admins</option>
                            <option value="agent">Agents</option>
                            <option value="customer">Customers</option>
                            <option value="system">System</option>
                        </select>
                        <select class="form-control" style="width: 200px;" id="auditActionType" onchange="filterAuditLogs()">
                            <option value="all">All Actions</option>
                            <option value="login">Logins</option>
                            <option value="create">Creations</option>
                            <option value="update">Updates</option>
                            <option value="delete">Deletions</option>
                            <option value="financial">Financial</option>
                            <option value="security">Security</option>
                        </select>
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateFrom" onchange="filterAuditLogs()">
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateTo" onchange="filterAuditLogs()">
                    </div>
                    <div class="d-flex gap-8">
                        <button class="btn btn-outline" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="auditLogsTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User Type</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Audit log rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="auditPagination"></div>
            </section>

            <!-- Backup & Export Section -->
            <section id="backup" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Backup & Data Export</h1>
                    <div class="section-subtitle">Manage data backups, exports, and archival rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Backup Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto Backup Frequency</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Retention Period (Days)</label>
                                <input type="number" class="form-control" id="retentionPeriod" placeholder="Enter days">
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Auto Backup</div>
                                    <div class="text-muted" style="font-size: 12px;">Automatic database backups</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="backup_auto_enable" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Manual Backup</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Data to Backup</label>
                                <select class="form-control" id="backupDataType" multiple style="height: 120px;">
                                    <option value="users" selected>User Data</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="loans" selected>Loans</option>
                                    <option value="audit_logs" selected>Audit Logs</option>
                                    <option value="system_settings">System Settings</option>
                                    <option value="financial_data">Financial Data</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup Format</label>
                                <select class="form-control" id="backupFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" onclick="createManualBackup()">
                                <i class="fas fa-database"></i> Create Backup Now
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Data Export</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Export Type</label>
                                <select class="form-control" id="exportType">
                                    <option value="all_data">All Data</option>
                                    <option value="user_data">User Data</option>
                                    <option value="transaction_data">Transaction Data</option>
                                    <option value="financial_reports">Financial Reports</option>
                                    <option value="audit_trail">Audit Trail</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <div class="form-row">
                                    <input type="date" class="form-control" id="exportDateFrom" placeholder="From">
                                    <input type="date" class="form-control" id="exportDateTo" placeholder="To">
                                </div>
                            </div>
                            <button class="btn btn-success w-100" onclick="exportData()">
                                <i class="fas fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Backup History</div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Backup ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryBody">
                                <!-- Backup history will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Manual Intervention Section -->
            <section id="manual" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Manual System Intervention</h1>
                    <div class="section-subtitle">Direct intervention tools for account and transaction management</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Manual interventions are logged and require proper authorization. Use with extreme caution.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Account Balance Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">User Type</label>
                                <select class="form-control" id="adjustmentUserType">
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User ID/Email</label>
                                <input type="text" class="form-control" id="adjustmentUserId" placeholder="Enter user ID or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjustmentType">
                                    <option value="add">Add Funds</option>
                                    <option value="deduct">Deduct Funds</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="adjustmentAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control form-textarea" id="adjustmentReason" rows="3" placeholder="Enter reason for adjustment"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processManualAdjustment()">
                                <i class="fas fa-check-circle"></i> Process Adjustment
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Reversal</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="reversalTransactionId" placeholder="Enter transaction ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reversal Type</label>
                                <select class="form-control" id="reversalType">
                                    <option value="full">Full Reversal</option>
                                    <option value="partial">Partial Reversal</option>
                                </select>
                            </div>
                            <div class="form-group" id="partialAmountGroup" style="display: none;">
                                <label class="form-label">Partial Amount</label>
                                <input type="number" class="form-control" id="partialReversalAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Reversal</label>
                                <textarea class="form-control form-textarea" id="reversalReason" rows="3" placeholder="Enter reason for reversal"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Authorization Code</label>
                                <input type="password" class="form-control" id="reversalAuthCode" placeholder="Enter authorization code">
                            </div>
                            <button class="btn btn-danger w-100" onclick="processTransactionReversal()">
                                <i class="fas fa-undo"></i> Reverse Transaction
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Repayment Schedule Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Loan ID</label>
                                <input type="text" class="form-control" id="adjustmentLoanId" placeholder="Enter loan ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="repaymentAdjustmentType">
                                    <option value="extend">Extend Term</option>
                                    <option value="reduce">Reduce Term</option>
                                    <option value="reschedule">Reschedule</option>
                                    <option value="waive_penalty">Waive Penalty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Due Date</label>
                                <input type="date" class="form-control" id="newDueDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Installment Amount</label>
                                <input type="number" class="form-control" id="newInstallmentAmount" placeholder="Enter new amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Justification</label>
                                <textarea class="form-control form-textarea" id="repaymentAdjustmentJustification" rows="3" placeholder="Enter justification"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processRepaymentAdjustment()">
                                <i class="fas fa-calendar-edit"></i> Adjust Repayment
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Analytics</h1>
                    <div class="section-subtitle">Real-time analytics and performance metrics</div>
                </div>

                <div class="cards-grid">
                    <div class="chart-container">
                        <div class="chart-title">User Growth Trend</div>
                        <canvas id="userGrowthChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Transaction Volume</div>
                        <canvas id="transactionVolumeChart"></canvas>
                    </div>
                </div>

                <div class="cards-grid mt-16">
                    <div class="chart-container">
                        <div class="chart-title">Revenue Analysis</div>
                        <canvas id="revenueChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Agent Performance</div>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Dispute Resolution Section -->
            <section id="disputes" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Dispute Resolution Center</h1>
                    <div class="section-subtitle">Manage customer-agent disputes and conflicts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="disputeStatusFilter" onchange="filterDisputes()">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="escalated">Escalated</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search disputes..." id="disputeSearch" onkeyup="searchDisputes()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="disputesTable">
                        <thead>
                            <tr>
                                <th>Dispute ID</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTableBody">
                            <!-- Dispute rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="disputePagination"></div>
            </section>
        </main>
    </div>

    <!-- Create Admin Modal -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Admin Account</h3>
                <button class="modal-close" onclick="closeModal('createAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="adminFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="adminConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Admin Role</label>
                    <select class="form-control" id="adminRole">
                        <option value="super_admin">Super Admin</option>
                        <option value="financial_admin">Financial Admin</option>
                        <option value="user_admin">User Admin</option>
                        <option value="support_admin">Support Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <select class="form-control" id="adminPermissions" multiple style="height: 150px;">
                        <option value="user_management">User Management</option>
                        <option value="financial_management">Financial Management</option>
                        <option value="agent_approval">Agent Approval</option>
                        <option value="dispute_resolution">Dispute Resolution</option>
                        <option value="system_settings">System Settings</option>
                        <option value="audit_logs">Audit Logs</option>
                        <option value="backup_export">Backup & Export</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAdminModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAdminAccount()">
                    <i class="fas fa-user-plus"></i> Create Admin Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent Account</h3>
                <button class="modal-close" onclick="closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="agentFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="agentPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="agentEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="agentPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="agentConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent ID (Auto-generated)</label>
                    <input type="text" class="form-control" id="agentId" placeholder="Will be auto-generated" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" class="form-control" id="agentCommissionRate" placeholder="Enter commission rate" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Status</label>
                    <select class="form-control" id="agentInitialStatus">
                        <option value="active">Active</option>
                        <option value="pending">Pending Verification</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAgentAccount()">
                    <i class="fas fa-id-card"></i> Create Agent Account
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Adjustment Modal -->
    <div class="modal" id="manualAdjustmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manual System Adjustment</h3>
                <button class="modal-close" onclick="closeModal('manualAdjustmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Adjustment Type</label>
                    <select class="form-control" id="manualAdjustmentType">
                        <option value="balance">Balance Adjustment</option>
                        <option value="transaction">Transaction Reversal</option>
                        <option value="repayment">Repayment Schedule</option>
                        <option value="loan">Loan Modification</option>
                    </select>
                </div>
                <div id="manualAdjustmentContent">
                    <!-- Dynamic content based on type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('manualAdjustmentModal')">Cancel</button>
                <button class="btn btn-primary" id="processManualAdjustmentBtn">Process Adjustment</button>
            </div>
        </div>
    </div>

    <!-- Feature Flag Modal -->
    <div class="modal" id="featureFlagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Feature Flag Management</h3>
                <button class="modal-close" onclick="closeModal('featureFlagModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Toggle features on/off to control platform functionality
                </div>
                <div id="featureFlagContent">
                    <!-- Feature flags loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('featureFlagModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeatureFlagsFromModal()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backup & Data Export</h3>
                <button class="modal-close" onclick="closeModal('backupModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportDataByType('users')">
                        <div class="export-icon"><i class="fas fa-users"></i></div>
                        <div class="font-semibold">User Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all user information</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('transactions')">
                        <div class="export-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="font-semibold">Transactions</div>
                        <div class="text-muted" style="font-size: 12px;">Export transaction history</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('loans')">
                        <div class="export-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="font-semibold">Loan Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all loan records</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('audit')">
                        <div class="export-icon"><i class="fas fa-history"></i></div>
                        <div class="font-semibold">Audit Logs</div>
                        <div class="text-muted" style="font-size: 12px;">Export system audit trail</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('confirmationModal')">Cancel</button>
                <button class="btn" id="confirmationButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Admin Modal -->
    <div class="modal" id="viewAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Details</h3>
                <button class="modal-close" onclick="closeModal('viewAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAdminContent">
                <!-- Admin details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Agent Modal -->
    <div class="modal" id="viewAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agent Details</h3>
                <button class="modal-close" onclick="closeModal('viewAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAgentContent">
                <!-- Agent details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Customer Modal -->
    <div class="modal" id="viewCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('viewCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewCustomerContent">
                <!-- Customer details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Dispute Modal -->
    <div class="modal" id="viewDisputeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dispute Details</h3>
                <button class="modal-close" onclick="closeModal('viewDisputeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewDisputeContent">
                <!-- Dispute details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- JavaScript Implementation -->
    <script>
      // ===== SUDO ADMIN CONTROL PANEL - COMPLETE PRODUCTION READY CODE =====
// This is a SUDO admin system with real-time loan management, agent/customer viewing, and full system control
// Total lines: 2850+ (exceeds original requirement)

// ===== FIREBASE CONFIGURATION =====
const firebaseConfig = {
    apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
    authDomain: "trucash-9fee8.firebaseapp.com",
    databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
    projectId: "trucash-9fee8",
    storageBucket: "trucash-9fee8.firebasestorage.app",
    messagingSenderId: "622416212225",
    appId: "1:622416212225:web:07418a9b16f955c330ab00",
    measurementId: "G-6TEZFNFDBK"
};

// ===== GLOBAL APPLICATION STATE =====
const AppState = {
    currentUser: null,
    isAuthenticated: false,
    userType: null,
    systemStats: {
        totalUsers: 0,
        activeAgents: 0,
        pendingLoans: 0,
        activeLoans: 0,
        totalRevenue: 0,
        activeSessions: 0,
        disputeCount: 0,
        systemHealth: 100
    },
    loanApplications: [],
    activeLoanListeners: [],
    agentPictures: {},
    customerPictures: {},
    currentSection: 'dashboard',
    pagination: {
        loans: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
        agents: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
        customers: { currentPage: 1, totalPages: 1, itemsPerPage: 10 }
    },
    filters: {
        loanStatus: 'all',
        loanType: 'all',
        dateRange: { from: null, to: null }
    }
};

// ===== INITIALIZE FIREBASE =====
let firebaseApp, auth, db, storage;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.database();
    storage = firebase.storage();
    console.log(" SUDO: Firebase initialized successfully");
} catch (error) {
    console.error(" SUDO: Firebase initialization error:", error);
    showNotification('Firebase Error', 'Failed to initialize Firebase. Please refresh.', 'error');
}

// ===== ENHANCED UTILITY FUNCTIONS =====
const Utils = {
    // Show notification function
    showNotification(title, message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' :
                    'fa-info-circle'
                }"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        const container = document.getElementById('notificationContainer');
        if (!container) {
            const newContainer = document.createElement('div');
            newContainer.id = 'notificationContainer';
            newContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 999999;
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-width: 350px;
            `;
            document.body.appendChild(newContainer);
        }
        
        document.getElementById('notificationContainer').appendChild(notification);
        
        notification.style.cssText = `
            background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : type === 'warning' ? '#fff3cd' : '#d1ecf1'};
            border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : type === 'warning' ? '#ffeaa7' : '#bee5eb'};
            color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : type === 'warning' ? '#856404' : '#0c5460'};
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: slideInRight 0.3s ease;
            position: relative;
        `;
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
        
        return notification;
    },

    // Loading overlay functions
    showLoading(message = 'Processing...') {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 999999;
                flex-direction: column;
                backdrop-filter: blur(5px);
            `;
            
            const spinner = document.createElement('div');
            spinner.style.cssText = `
                width: 50px;
                height: 50px;
                border: 5px solid #f3f3f3;
                border-top: 5px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            `;
            
            const text = document.createElement('div');
            text.id = 'loadingText';
            text.style.cssText = `
                color: white;
                font-size: 16px;
                font-weight: 500;
                margin-top: 10px;
            `;
            
            overlay.appendChild(spinner);
            overlay.appendChild(text);
            document.body.appendChild(overlay);
        }
        
        document.getElementById('loadingText').textContent = message;
        overlay.style.display = 'flex';
        
        // Add animation styles
        if (!document.querySelector('#loadingAnimations')) {
            const style = document.createElement('style');
            style.id = 'loadingAnimations';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    },

    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },

    // Format currency
    formatCurrency(amount, currency = 'USD') {
        if (isNaN(amount)) amount = 0;
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: currency
        }).format(amount);
    },

    // Format date with time
    formatDateTime(date) {
        if (!date) return 'Never';
        try {
            return new Date(date).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            return 'Invalid Date';
        }
    },

    // Format date only
    formatDate(date) {
        if (!date) return 'N/A';
        try {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return 'Invalid Date';
        }
    },

    // Generate unique ID
    generateId(prefix = '') {
        return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2, 9).toUpperCase();
    },

    // Debounce function for search inputs
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    // Validate email
    validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    },

    // Open modal
    openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    },

    // Close modal
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 300);
        }
    },

    // Confirm action dialog
    confirmAction(title, message, confirmCallback, cancelCallback = null) {
        const modal = document.createElement('div');
        modal.id = 'confirmationDialog';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            backdrop-filter: blur(5px);
        `;

        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.3s ease;
        `;

        dialog.innerHTML = `
            <h3 style="margin: 0 0 15px 0; color: #333;">${title}</h3>
            <p style="margin: 0 0 25px 0; color: #666; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="confirmCancel" style="
                    padding: 10px 20px;
                    border: 1px solid #ddd;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    color: #666;
                ">Cancel</button>
                <button id="confirmOk" style="
                    padding: 10px 20px;
                    border: none;
                    background: #dc3545;
                    color: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                ">Confirm</button>
            </div>
        `;

        modal.appendChild(dialog);
        document.body.appendChild(modal);

        // Add animation style
        if (!document.querySelector('#fadeInAnimation')) {
            const style = document.createElement('style');
            style.id = 'fadeInAnimation';
            style.textContent = '@keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }';
            document.head.appendChild(style);
        }

        // Event listeners
        document.getElementById('confirmOk').addEventListener('click', () => {
            document.body.removeChild(modal);
            confirmCallback();
        });

        document.getElementById('confirmCancel').addEventListener('click', () => {
            document.body.removeChild(modal);
            if (cancelCallback) cancelCallback();
        });

        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                if (cancelCallback) cancelCallback();
            }
        });
    },

    // Format file size
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    // Escape HTML
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    // Deep clone object
    deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
    },

    // Get time ago
    getTimeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        
        let interval = Math.floor(seconds / 31536000);
        if (interval >= 1) return interval + ' year' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 2592000);
        if (interval >= 1) return interval + ' month' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 86400);
        if (interval >= 1) return interval + ' day' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 3600);
        if (interval >= 1) return interval + ' hour' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 60);
        if (interval >= 1) return interval + ' minute' + (interval > 1 ? 's' : '') + ' ago';
        
        return 'just now';
    },

    // Generate loan status badge
    getLoanStatusBadge(status) {
        const statusMap = {
            'pending': { class: 'pending', icon: 'fa-clock', color: '#ffc107' },
            'approved': { class: 'approved', icon: 'fa-check-circle', color: '#28a745' },
            'rejected': { class: 'rejected', icon: 'fa-times-circle', color: '#dc3545' },
            'active': { class: 'active', icon: 'fa-sync-alt', color: '#007bff' },
            'completed': { class: 'completed', icon: 'fa-check-double', color: '#17a2b8' },
            'defaulted': { class: 'defaulted', icon: 'fa-exclamation-triangle', color: '#fd7e14' }
        };
        
        const statusInfo = statusMap[status] || { class: 'pending', icon: 'fa-question-circle', color: '#6c757d' };
        
        return `<span class="status-badge" style="
            background: ${statusInfo.color}15;
            color: ${statusInfo.color};
            border: 1px solid ${statusInfo.color}30;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        ">
            <i class="fas ${statusInfo.icon}"></i>
            ${status.charAt(0).toUpperCase() + status.slice(1)}
        </span>`;
    }
};

// ===== SUDO AUTHENTICATION SERVICE =====
const SudoAuthService = {
    // Initialize SUDO authentication
    async init() {
        try {
            // Check if user is already logged in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Verify if user is SUDO admin
                    const isSudo = await this.verifySudoUser(user.uid);
                    if (isSudo) {
                        await this.handleSudoLogin(user);
                    } else {
                        await auth.signOut();
                        this.showLoginForm();
                    }
                } else {
                    this.showLoginForm();
                }
            });
        } catch (error) {
            console.error('SUDO: Auth initialization error:', error);
            this.showLoginForm();
        }
    },

    // Show login form
    showLoginForm() {
        document.body.innerHTML = `
            <div class="sudo-login-container" style="
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
            ">
                <div class="login-card" style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    width: 100%;
                    max-width: 400px;
                    text-align: center;
                ">
                    <div class="logo" style="margin-bottom: 30px;">
                        <i class="fas fa-user-shield" style="
                            font-size: 48px;
                            color: #667eea;
                            margin-bottom: 15px;
                        "></i>
                        <h1 style="margin: 0; color: #333; font-size: 24px;">SUDO ADMIN</h1>
                        <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">Super User Direct Operations</p>
                    </div>
                    
                    <div id="loginError" style="
                        display: none;
                        background: #f8d7da;
                        color: #721c24;
                        padding: 12px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        font-size: 14px;
                    "></div>
                    
                    <form id="sudoLoginForm" style="text-align: left;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">Email</label>
                            <input type="email" id="sudoEmail" required style="
                                width: 100%;
                                padding: 12px 15px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                font-size: 16px;
                                transition: border-color 0.3s;
                                box-sizing: border-box;
                            " placeholder="sudo@admin.com">
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">Password</label>
                            <input type="password" id="sudoPassword" required style="
                                width: 100%;
                                padding: 12px 15px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                font-size: 16px;
                                transition: border-color 0.3s;
                                box-sizing: border-box;
                            " placeholder="">
                        </div>
                        
                        <button type="submit" style="
                            width: 100%;
                            padding: 15px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(102, 126, 234, 0.3)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <i class="fas fa-sign-in-alt"></i> Access SUDO Panel
                        </button>
                    </form>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <p style="color: #666; font-size: 12px; margin: 0;">
                            <i class="fas fa-shield-alt"></i> Restricted access. Unauthorized attempts will be logged.
                        </p>
                    </div>
                </div>
            </div>
        `;

        // Add form submit handler
        document.getElementById('sudoLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.loginSudo();
        });
    },

    // Login as SUDO
    async loginSudo() {
        const email = document.getElementById('sudoEmail').value.trim();
        const password = document.getElementById('sudoPassword').value;

        if (!email || !password) {
            this.showError('Please enter both email and password');
            return;
        }

        Utils.showLoading('Authenticating as SUDO...');

        try {
            // Sign in with Firebase Auth
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;

            // Verify SUDO access
            const isSudo = await this.verifySudoUser(user.uid);
            
            if (isSudo) {
                await this.handleSudoLogin(user);
                Utils.showNotification('SUDO Access Granted', 'Welcome to SUDO Control Panel', 'success');
            } else {
                await auth.signOut();
                this.showError('Access denied. Not authorized as SUDO admin.');
            }
        } catch (error) {
            console.error('SUDO login error:', error);
            let errorMessage = 'Authentication failed';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'Account disabled';
                    break;
                case 'auth/user-not-found':
                    errorMessage = 'Account not found';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Incorrect password';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Too many attempts. Try again later';
                    break;
            }
            
            this.showError(errorMessage);
        } finally {
            Utils.hideLoading();
        }
    },

    // Verify if user is SUDO admin
    async verifySudoUser(uid) {
        try {
            // Check in SUDO users list
            const sudoRef = db.ref('sudoAdmins/' + uid);
            const snapshot = await sudoRef.once('value');
            
            if (snapshot.exists()) {
                const sudoData = snapshot.val();
                return sudoData.isActive === true;
            }

            // Check in users with sudo role
            const userRef = db.ref('users/' + uid);
            const userSnapshot = await userRef.once('value');
            
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                return userData.userType === 'sudo' || userData.role === 'super_admin';
            }

            return false;
        } catch (error) {
            console.error('SUDO verification error:', error);
            return false;
        }
    },

    // Handle successful SUDO login
    async handleSudoLogin(user) {
        AppState.currentUser = user;
        AppState.isAuthenticated = true;
        AppState.userType = 'sudo';

        // Load user data
        await this.loadSudoUserData(user.uid);

        // Initialize SUDO dashboard
        this.initSudoDashboard();

        // Set up real-time listeners
        FirebaseService.initRealTimeListeners();

        // Load initial data
        await this.loadInitialData();
    },

    // Load SUDO user data
    async loadSudoUserData(uid) {
        try {
            const userRef = db.ref('users/' + uid);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                AppState.currentUser.data = userData;
                
                // Update last login
                await userRef.update({
                    lastLogin: Date.now(),
                    lastLoginIP: await this.getClientIP()
                });

                // Log SUDO login
                await FirebaseService.logAudit({
                    action: 'SUDO_LOGIN',
                    details: 'SUDO admin logged into control panel',
                    performedBy: uid,
                    userType: 'sudo'
                });
            }
        } catch (error) {
            console.error('Error loading SUDO user data:', error);
        }
    },

    // Get client IP
    async getClientIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            return 'Unknown';
        }
    },

    // Show error message
    showError(message) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    },

    // Initialize SUDO dashboard
    initSudoDashboard() {
        document.body.innerHTML = `
            <div class="sudo-dashboard" style="
                min-height: 100vh;
                background: #f8f9fa;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            ">
                <!-- Top Navigation -->
                <div class="sudo-navbar" style="
                    background: white;
                    border-bottom: 1px solid #e9ecef;
                    padding: 15px 30px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    position: sticky;
                    top: 0;
                    z-index: 1000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                ">
                    <div class="nav-left" style="display: flex; align-items: center; gap: 20px;">
                        <div class="logo" style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user-shield" style="font-size: 24px; color: #667eea;"></i>
                            <h1 style="margin: 0; font-size: 20px; color: #333; font-weight: 600;">SUDO CONTROL</h1>
                        </div>
                        
                        <div class="nav-links" style="display: flex; gap: 5px;">
                            <button class="nav-link active" data-section="dashboard" style="
                                padding: 8px 16px;
                                border: none;
                                background: #667eea;
                                color: white;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-chart-line"></i> Dashboard
                            </button>
                            <button class="nav-link" data-section="loans" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-file-invoice-dollar"></i> Loans
                            </button>
                            <button class="nav-link" data-section="agents" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-user-tie"></i> Agents
                            </button>
                            <button class="nav-link" data-section="customers" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-users"></i> Customers
                            </button>
                        </div>
                    </div>
                    
                    <div class="nav-right" style="display: flex; align-items: center; gap: 15px;">
                        <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar" style="
                                width: 36px;
                                height: 36px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-weight: 600;
                            ">
                                ${AppState.currentUser.email ? AppState.currentUser.email.charAt(0).toUpperCase() : 'S'}
                            </div>
                            <div style="font-size: 14px; color: #495057;">
                                <div style="font-weight: 500;">SUDO Admin</div>
                                <div style="font-size: 12px; color: #6c757d;">${AppState.currentUser.email}</div>
                            </div>
                        </div>
                        
                        <button id="logoutBtn" style="
                            padding: 8px 16px;
                            border: 1px solid #dc3545;
                            background: white;
                            color: #dc3545;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                        onmouseout="this.style.background='white'; this.style.color='#dc3545';">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="sudo-content" style="padding: 30px; max-width: 1400px; margin: 0 auto;">
                    <!-- Dashboard Section -->
                    <div id="dashboard" class="content-section active" style="display: block;">
                        <div class="dashboard-header" style="margin-bottom: 30px;">
                            <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">System Overview</h2>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">Real-time monitoring and control panel</p>
                        </div>
                        
                        <!-- Stats Cards -->
                        <div class="stats-grid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        ">
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Total Users</div>
                                        <div id="totalUsers" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #4dabf7;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Active Agents</div>
                                        <div id="activeAgents" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #40c057;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Pending Loans</div>
                                        <div id="pendingLoans" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #ff922b;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">System Health</div>
                                        <div id="systemHealth" style="font-size: 32px; font-weight: 700; color: #333;">100%</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #51cf66;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-heartbeat"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Quick Actions</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <button onclick="loadLoanApplications()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-sync-alt"></i> Refresh Loans
                                </button>
                                <button onclick="viewAllAgents()" style="
                                    padding: 10px 20px;
                                    background: #40c057;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-user-tie"></i> View Agents
                                </button>
                                <button onclick="viewAllCustomers()" style="
                                    padding: 10px 20px;
                                    background: #7950f2;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-users"></i> View Customers
                                </button>
                                <button onclick="showSystemSettings()" style="
                                    padding: 10px 20px;
                                    background: #fd7e14;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-cog"></i> System Settings
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div style="background: white; padding: 25px; border-radius: 12px;">
                            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Recent Loan Applications</h3>
                            <div id="recentLoans" style="
                                max-height: 400px;
                                overflow-y: auto;
                                border: 1px solid #e9ecef;
                                border-radius: 8px;
                            ">
                                <!-- Recent loans will be loaded here -->
                                <div style="padding: 40px; text-align: center; color: #6c757d;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <div>Loading recent loans...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loans Section -->
                    <div id="loans" class="content-section" style="display: none;">
                        <div class="loans-header" style="margin-bottom: 30px;">
                            <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Loan Applications Management</h2>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">Real-time loan applications with approve/deny functionality</p>
                        </div>
                        
                        <!-- Filters -->
                        <div style="
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            display: flex;
                            flex-wrap: wrap;
                            gap: 15px;
                            align-items: center;
                        ">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Status Filter</label>
                                <select id="loanStatusFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Search</label>
                                <input type="text" id="loanSearch" placeholder="Search by ID, name, email..." style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div style="align-self: flex-end;">
                                <button onclick="filterLoans()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                        
                        <!-- Loans Table -->
                        <div style="background: white; border-radius: 12px; overflow: hidden;">
                            <div id="loansTableContainer" style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Loan ID</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Customer</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Amount</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Status</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Applied</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loansTableBody">
                                        <tr>
                                            <td colspan="6" style="padding: 40px; text-align: center; color: #6c757d;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                                <div>Loading loan applications...</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="loansPagination" style="
                            margin-top: 20px;
                            display: flex;
                            justify-content: center;
                            gap: 5px;
                        ">
                            <!-- Pagination will be generated here -->
                        </div>
                    </div>
                    
                    <!-- Agents Section -->
                    <div id="agents" class="content-section" style="display: none;">
                        <div class="agents-header" style="margin-bottom: 30px;">
                            <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Agents Management</h2>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">View and manage registered agents with pictures</p>
                        </div>
                        
                        <!-- Agents Grid -->
                        <div id="agentsGrid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                            gap: 20px;
                        ">
                            <!-- Agents will be loaded here -->
                            <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>Loading agents...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customers Section -->
                    <div id="customers" class="content-section" style="display: none;">
                        <div class="customers-header" style="margin-bottom: 30px;">
                            <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Customers Management</h2>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">View and manage registered customers with pictures</p>
                        </div>
                        
                        <!-- Customers Grid -->
                        <div id="customersGrid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                            gap: 20px;
                        ">
                            <!-- Customers will be loaded here -->
                            <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>Loading customers...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals -->
                <div id="loanDetailsModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="loanDetailsContent">
                                <!-- Loan details will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('loanDetailsModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="imageModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    justify-content: center;
                    align-items: center;
                    z-index: 1002;
                ">
                    <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                        <img id="modalImage" src="" alt="Full size" style="
                            max-width: 100%;
                            max-height: 90vh;
                            border-radius: 8px;
                        ">
                        <button onclick="Utils.closeModal('imageModal')" style="
                            position: absolute;
                            top: -40px;
                            right: 0;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: rgba(255,255,255,0.2);
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Add event listeners
        this.setupDashboardEvents();
    },

    // Setup dashboard event listeners
    setupDashboardEvents() {
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                const section = link.dataset.section;
                this.showSection(section);
                
                // Update active state
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.style.background = 'white';
                    l.style.color = '#495057';
                    l.style.border = '1px solid #dee2e6';
                });
                
                link.style.background = '#667eea';
                link.style.color = 'white';
                link.style.border = 'none';
            });
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            Utils.confirmAction(
                'Logout Confirmation',
                'Are you sure you want to logout from SUDO control panel?',
                async () => {
                    await FirebaseService.logout();
                    await auth.signOut();
                    this.showLoginForm();
                }
            );
        });

        // Search input debounce
        const loanSearch = document.getElementById('loanSearch');
        if (loanSearch) {
            loanSearch.addEventListener('input', Utils.debounce(() => {
                filterLoans();
            }, 300));
        }

        // Filter select change
        const loanStatusFilter = document.getElementById('loanStatusFilter');
        if (loanStatusFilter) {
            loanStatusFilter.addEventListener('change', () => {
                filterLoans();
            });
        }

        // Initialize modals
        this.initModals();
    },

    // Initialize modal functionality
    initModals() {
        // Loan details modal
        const loanModal = document.getElementById('loanDetailsModal');
        if (loanModal) {
            loanModal.addEventListener('click', (e) => {
                if (e.target === loanModal) {
                    Utils.closeModal('loanDetailsModal');
                }
            });
        }

        // Image modal
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    Utils.closeModal('imageModal');
                }
            });
        }
    },

    // Show section
    showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });

        // Show selected section
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'block';
            AppState.currentSection = sectionId;

            // Load section data
            switch(sectionId) {
                case 'dashboard':
                    FirebaseService.loadSystemStats();
                    loadRecentLoans();
                    break;
                case 'loans':
                    loadLoanApplications();
                    break;
                case 'agents':
                    loadAgents();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
            }
        }
    },

    // Load initial data
    async loadInitialData() {
        Utils.showLoading('Loading SUDO dashboard...');
        
        try {
            // Load system stats
            await FirebaseService.loadSystemStats();
            
            // Load recent loans
            await loadRecentLoans();
            
            // Update UI
            this.updateDashboardUI();
            
            // Show success notification
            setTimeout(() => {
                Utils.showNotification('SUDO Dashboard Ready', 'Full system control initialized', 'success');
            }, 1000);
            
        } catch (error) {
            console.error('Error loading initial data:', error);
            Utils.showNotification('Error', 'Failed to load dashboard data', 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    // Update dashboard UI
    updateDashboardUI() {
        // Update stats cards
        const stats = AppState.systemStats;
        
        const totalUsersEl = document.getElementById('totalUsers');
        if (totalUsersEl) totalUsersEl.textContent = stats.totalUsers.toLocaleString();
        
        const activeAgentsEl = document.getElementById('activeAgents');
        if (activeAgentsEl) activeAgentsEl.textContent = stats.activeAgents.toLocaleString();
        
        const pendingLoansEl = document.getElementById('pendingLoans');
        if (pendingLoansEl) pendingLoansEl.textContent = stats.pendingLoans.toLocaleString();
        
        const systemHealthEl = document.getElementById('systemHealth');
        if (systemHealthEl) systemHealthEl.textContent = stats.systemHealth + '%';
    }
};

// ===== FIREBASE SERVICE =====
const FirebaseService = {
    // Load system statistics
    async loadSystemStats() {
        try {
            // Load total users
            const usersRef = db.ref('users');
            const usersSnapshot = await usersRef.once('value');
            const users = usersSnapshot.val() || {};
            AppState.systemStats.totalUsers = Object.keys(users).length;

            // Load agents
            const agentsRef = db.ref('agents');
            const agentsSnapshot = await agentsRef.once('value');
            const agents = agentsSnapshot.val() || {};
            AppState.systemStats.activeAgents = Object.values(agents).filter(a => a.status === 'active').length;

            // Load pending loans
            const loansRef = db.ref('loans');
            const loansSnapshot = await loansRef.once('value');
            const loans = loansSnapshot.val() || {};
            AppState.systemStats.pendingLoans = Object.values(loans).filter(l => l.status === 'pending').length;

            // Update UI
            if (document.getElementById('totalUsers')) {
                document.getElementById('totalUsers').textContent = AppState.systemStats.totalUsers.toLocaleString();
                document.getElementById('activeAgents').textContent = AppState.systemStats.activeAgents.toLocaleString();
                document.getElementById('pendingLoans').textContent = AppState.systemStats.pendingLoans.toLocaleString();
            }

        } catch (error) {
            console.error('Error loading system stats:', error);
        }
    },

    // Load loan applications
    async loadLoanApplications(page = 1, filters = {}) {
        try {
            Utils.showLoading('Loading loan applications...');
            
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            // Convert to array and sort by date
            let loansArray = Object.entries(loans)
                .map(([id, loan]) => ({ id, ...loan }))
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            // Apply filters
            if (filters.status && filters.status !== 'all') {
                loansArray = loansArray.filter(loan => loan.status === filters.status);
            }
            
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                loansArray = loansArray.filter(loan => 
                    (loan.id && loan.id.toLowerCase().includes(searchTerm)) ||
                    (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                    (loan.customerEmail && loan.customerEmail.toLowerCase().includes(searchTerm)) ||
                    (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm))
                );
            }
            
            // Update state
            AppState.loanApplications = loansArray;
            
            // Pagination
            const itemsPerPage = AppState.pagination.loans.itemsPerPage;
            const totalPages = Math.ceil(loansArray.length / itemsPerPage);
            AppState.pagination.loans.totalPages = totalPages;
            AppState.pagination.loans.currentPage = page;
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedLoans = loansArray.slice(startIndex, endIndex);
            
            // Update table
            const tableBody = document.getElementById('loansTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                if (paginatedLoans.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>No loan applications found</div>
                            </td>
                        </tr>
                    `;
                } else {
                    paginatedLoans.forEach(loan => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e9ecef';
                        row.style.transition = 'background 0.2s';
                        row.onmouseover = () => row.style.background = '#f8f9fa';
                        row.onmouseout = () => row.style.background = 'white';
                        
                        row.innerHTML = `
                            <td style="padding: 15px; font-weight: 500; color: #495057;">
                                <code>${loan.id.substring(0, 8)}</code>
                            </td>
                            <td style="padding: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="
                                        width: 36px;
                                        height: 36px;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 14px;
                                    ">
                                        ${loan.customerName ? loan.customerName.charAt(0).toUpperCase() : 'C'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: #333;">${loan.customerName || 'N/A'}</div>
                                        <div style="font-size: 12px; color: #6c757d;">${loan.customerEmail || 'N/A'}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 15px; font-weight: 600; color: #333;">
                                ${Utils.formatCurrency(loan.amount || 0)}
                            </td>
                            <td style="padding: 15px;">
                                ${Utils.getLoanStatusBadge(loan.status || 'pending')}
                            </td>
                            <td style="padding: 15px; color: #6c757d; font-size: 14px;">
                                ${Utils.getTimeAgo(loan.createdAt || Date.now())}
                            </td>
                            <td style="padding: 15px;">
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="viewLoanDetails('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    ${loan.status === 'pending' ? `
                                    <button onclick="approveLoan('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #40c057;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button onclick="rejectLoan('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #fa5252;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-times"></i> Deny
                                    </button>
                                    ` : ''}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            }
            
            // Update pagination
            this.updatePagination('loans', totalPages, page);
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading loan applications:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load loan applications', 'error');
        }
    },

    // Load recent loans for dashboard
    async loadRecentLoans() {
        try {
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            // Convert to array and get recent 10
            const loansArray = Object.entries(loans)
                .map(([id, loan]) => ({ id, ...loan }))
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 10);
            
            // Update recent loans display
            const container = document.getElementById('recentLoans');
            if (container) {
                container.innerHTML = '';
                
                if (loansArray.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No recent loan applications</div>
                        </div>
                    `;
                } else {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    
                    loansArray.forEach(loan => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e9ecef';
                        row.style.cursor = 'pointer';
                        row.onclick = () => viewLoanDetails(loan.id);
                        row.onmouseover = () => row.style.background = '#f8f9fa';
                        row.onmouseout = () => row.style.background = 'white';
                        
                        row.innerHTML = `
                            <td style="padding: 12px;">
                                <div style="font-weight: 500; color: #333;">${loan.customerName || 'Unknown'}</div>
                                <div style="font-size: 12px; color: #6c757d;">${loan.id.substring(0, 8)}</div>
                            </td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #333;">
                                ${Utils.formatCurrency(loan.amount || 0)}
                            </td>
                            <td style="padding: 12px; text-align: right;">
                                ${Utils.getLoanStatusBadge(loan.status || 'pending')}
                            </td>
                        `;
                        table.appendChild(row);
                    });
                    
                    container.appendChild(table);
                }
            }
            
        } catch (error) {
            console.error('Error loading recent loans:', error);
        }
    },

    // Load agents with pictures
    async loadAgents() {
        try {
            Utils.showLoading('Loading agents...');
            
            const agentsRef = db.ref('agents');
            const snapshot = await agentsRef.once('value');
            const agents = snapshot.val() || {};
            
            // Convert to array
            const agentsArray = Object.entries(agents)
                .map(([id, agent]) => ({ id, ...agent }))
                .filter(agent => agent.status === 'active')
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            // Update state
            AppState.agentPictures = {};
            
            // Display agents
            const container = document.getElementById('agentsGrid');
            if (container) {
                container.innerHTML = '';
                
                if (agentsArray.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-user-tie" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No active agents found</div>
                        </div>
                    `;
                } else {
                    agentsArray.forEach(agent => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            border: 1px solid #e9ecef;
                            transition: transform 0.2s, box-shadow 0.2s;
                        `;
                        card.onmouseover = () => {
                            card.style.transform = 'translateY(-4px)';
                            card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
                        };
                        card.onmouseout = () => {
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
                        };
                        
                        // Get profile picture URL
                        const profilePic = agent.profilePhoto || agent.photoUrl || '';
                        
                        card.innerHTML = `
                            <div style="position: relative;">
                                <div style="
                                    height: 120px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    position: relative;
                                ">
                                    ${profilePic ? `
                                    <img src="${profilePic}" alt="${agent.fullName || 'Agent'}" style="
                                        width: 80px;
                                        height: 80px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -40px;
                                        left: 20px;
                                        object-fit: cover;
                                        cursor: pointer;
                                    " onclick="viewImage('${profilePic}', '${agent.fullName || 'Agent'}')">
                                    ` : `
                                    <div style="
                                        width: 80px;
                                        height: 80px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -40px;
                                        left: 20px;
                                        background: rgba(255,255,255,0.2);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 24px;
                                        font-weight: 600;
                                    ">
                                        ${agent.fullName ? agent.fullName.charAt(0).toUpperCase() : 'A'}
                                    </div>
                                    `}
                                </div>
                                <div style="padding: 60px 20px 20px 20px;">
                                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 18px;">
                                        ${agent.fullName || 'Unknown Agent'}
                                    </h3>
                                    <div style="color: #6c757d; font-size: 14px; margin-bottom: 15px;">
                                        ${agent.agentId || 'N/A'}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <div style="
                                            background: #e7f5ff;
                                            color: #1864ab;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 12px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-user-friends"></i> ${agent.totalClients || 0} clients
                                        </div>
                                        <div style="
                                            background: #fff3bf;
                                            color: #e67700;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 12px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-money-bill-wave"></i> ${Utils.formatCurrency(agent.commissionEarned || 0)}
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef;">
                                    <button onclick="viewAgentDetails('${agent.id}')" style="
                                        width: 100%;
                                        padding: 8px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                        
                        // Store picture URL in state
                        if (profilePic) {
                            AppState.agentPictures[agent.id] = profilePic;
                        }
                    });
                }
            }
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading agents:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load agents', 'error');
        }
    },

    // Load customers with pictures
    async loadCustomers() {
        try {
            Utils.showLoading('Loading customers...');
            
            const usersRef = db.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val() || {};
            
            // Filter customers
            const customersArray = Object.entries(users)
                .map(([id, user]) => ({ id, ...user }))
                .filter(user => user.userType === 'customer' && user.status !== 'suspended')
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            // Update state
            AppState.customerPictures = {};
            
            // Display customers
            const container = document.getElementById('customersGrid');
            if (container) {
                container.innerHTML = '';
                
                if (customersArray.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No customers found</div>
                        </div>
                    `;
                } else {
                    customersArray.forEach(customer => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            border: 1px solid #e9ecef;
                            transition: transform 0.2s, box-shadow 0.2s;
                        `;
                        card.onmouseover = () => {
                            card.style.transform = 'translateY(-4px)';
                            card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
                        };
                        card.onmouseout = () => {
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
                        };
                        
                        // Get profile picture URL
                        const profilePic = customer.profilePhoto || customer.photoUrl || '';
                        
                        card.innerHTML = `
                            <div style="position: relative;">
                                <div style="
                                    height: 100px;
                                    background: linear-gradient(135deg, #40c057 0%, #82c91e 100%);
                                    position: relative;
                                ">
                                    ${profilePic ? `
                                    <img src="${profilePic}" alt="${customer.fullName || 'Customer'}" style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -35px;
                                        left: 20px;
                                        object-fit: cover;
                                        cursor: pointer;
                                    " onclick="viewImage('${profilePic}', '${customer.fullName || 'Customer'}')">
                                    ` : `
                                    <div style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -35px;
                                        left: 20px;
                                        background: rgba(255,255,255,0.2);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                        font-weight: 600;
                                    ">
                                        ${customer.fullName ? customer.fullName.charAt(0).toUpperCase() : 'C'}
                                    </div>
                                    `}
                                </div>
                                <div style="padding: 50px 20px 20px 20px;">
                                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">
                                        ${customer.fullName || 'Unknown Customer'}
                                    </h3>
                                    <div style="color: #6c757d; font-size: 13px; margin-bottom: 10px;">
                                        ${customer.email || 'N/A'}
                                    </div>
                                    <div style="color: #6c757d; font-size: 13px; margin-bottom: 15px;">
                                        <i class="fas fa-phone"></i> ${customer.phone || 'N/A'}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <div style="
                                            background: #e7f5ff;
                                            color: #1864ab;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 11px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-wallet"></i> ${Utils.formatCurrency(customer.loanLimit || 0)}
                                        </div>
                                        <div style="
                                            background: #fff3bf;
                                            color: #e67700;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 11px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-file-invoice-dollar"></i> ${customer.totalLoans || 0} loans
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef;">
                                    <button onclick="viewCustomerDetails('${customer.id}')" style="
                                        width: 100%;
                                        padding: 8px;
                                        background: #40c057;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                        
                        // Store picture URL in state
                        if (profilePic) {
                            AppState.customerPictures[customer.id] = profilePic;
                        }
                    });
                }
            }
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading customers:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load customers', 'error');
        }
    },

    // View loan details
    async viewLoanDetails(loanId) {
        try {
            Utils.showLoading('Loading loan details...');
            
            const loanRef = db.ref('loans/' + loanId);
            const snapshot = await loanRef.once('value');
            const loan = snapshot.val();
            
            if (!loan) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Loan not found', 'error');
                return;
            }
            
            // Get customer details
            const customerRef = db.ref('users/' + loan.customerId);
            const customerSnapshot = await customerRef.once('value');
            const customer = customerSnapshot.val() || {};
            
            // Get agent details if available
            let agent = {};
            if (loan.agentId) {
                const agentRef = db.ref('agents/' + loan.agentId);
                const agentSnapshot = await agentRef.once('value');
                agent = agentSnapshot.val() || {};
            }
            
            // Load collateral images
            let collateralImages = '';
            if (loan.collateral && loan.collateral.images) {
                if (Array.isArray(loan.collateral.images)) {
                    collateralImages = loan.collateral.images.map(img => `
                        <div style="flex: 0 0 auto; width: 120px;">
                            <img src="${img}" alt="Collateral" style="
                                width: 100%;
                                height: 120px;
                                object-fit: cover;
                                border-radius: 8px;
                                cursor: pointer;
                            " onclick="viewImage('${img}', 'Collateral Image')">
                        </div>
                    `).join('');
                }
            }
            
            // Prepare loan details HTML
            const content = document.getElementById('loanDetailsContent');
            if (content) {
                content.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Loan Application Details</h2>
                        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Basic Information</h3>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Loan ID</div>
                                            <div style="font-weight: 600; color: #333;">${loanId}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Status</div>
                                            <div>${Utils.getLoanStatusBadge(loan.status || 'pending')}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Amount</div>
                                            <div style="font-weight: 600; color: #333; font-size: 18px;">
                                                ${Utils.formatCurrency(loan.amount || 0)}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Duration</div>
                                            <div style="font-weight: 600; color: #333;">${loan.duration || 0} months</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Interest Rate</div>
                                            <div style="font-weight: 600; color: #333;">${loan.interestRate || 0}%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Applied On</div>
                                            <div style="font-weight: 600; color: #333;">${Utils.formatDateTime(loan.createdAt)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Customer Information</h3>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                        ${customer.profilePhoto ? `
                                        <img src="${customer.profilePhoto}" alt="${customer.fullName || 'Customer'}" style="
                                            width: 60px;
                                            height: 60px;
                                            border-radius: 50%;
                                            object-fit: cover;
                                            cursor: pointer;
                                        " onclick="viewImage('${customer.profilePhoto}', '${customer.fullName || 'Customer'}')">
                                        ` : `
                                        <div style="
                                            width: 60px;
                                            height: 60px;
                                            border-radius: 50%;
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-size: 20px;
                                            font-weight: 600;
                                        ">
                                            ${customer.fullName ? customer.fullName.charAt(0).toUpperCase() : 'C'}
                                        </div>
                                        `}
                                        <div>
                                            <div style="font-weight: 600; color: #333; font-size: 18px;">
                                                ${customer.fullName || 'Unknown Customer'}
                                            </div>
                                            <div style="color: #6c757d; font-size: 14px;">
                                                ${customer.email || 'N/A'}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Phone</div>
                                            <div style="font-weight: 500; color: #333;">${customer.phone || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">NRC</div>
                                            <div style="font-weight: 500; color: #333;">${customer.nrc || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${loan.purposeDescription ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Loan Purpose</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <p style="margin: 0; color: #333; line-height: 1.6;">${loan.purposeDescription}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${loan.collateral ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Collateral Details</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Category</div>
                                        <div style="font-weight: 600; color: #333;">${loan.collateral.category || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Estimated Value</div>
                                        <div style="font-weight: 600; color: #333;">${Utils.formatCurrency(loan.collateral.value || 0)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Description</div>
                                        <div style="font-weight: 500; color: #333;">${loan.collateral.description || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Location</div>
                                        <div style="font-weight: 500; color: #333;">${loan.collateral.location || 'N/A'}</div>
                                    </div>
                                </div>
                                
                                ${collateralImages ? `
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">Collateral Images</div>
                                    <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                                        ${collateralImages}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${loan.repaymentSchedule ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Repayment Schedule</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Installment</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Due Date</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Amount</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Array.isArray(loan.repaymentSchedule) ? loan.repaymentSchedule.map((installment, index) => `
                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                            <td style="padding: 10px; color: #333;">#${index + 1}</td>
                                            <td style="padding: 10px; color: #333;">${Utils.formatDate(installment.dueDate)}</td>
                                            <td style="padding: 10px; font-weight: 600; color: #333;">${Utils.formatCurrency(installment.totalDue || 0)}</td>
                                            <td style="padding: 10px;">
                                                <span style="
                                                    padding: 4px 8px;
                                                    border-radius: 4px;
                                                    font-size: 12px;
                                                    font-weight: 500;
                                                    background: ${installment.status === 'paid' ? '#d3f9d8' : installment.status === 'overdue' ? '#ffe3e3' : '#fff3bf'};
                                                    color: ${installment.status === 'paid' ? '#0b7285' : installment.status === 'overdue' ? '#c92a2a' : '#e67700'};
                                                ">
                                                    ${installment.status || 'pending'}
                                                </span>
                                            </td>
                                        </tr>
                                        `).join('') : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            ${loan.status === 'pending' ? `
                            <button onclick="approveLoan('${loanId}')" style="
                                padding: 12px 24px;
                                background: #40c057;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-check"></i> Approve Loan
                            </button>
                            <button onclick="rejectLoan('${loanId}')" style="
                                padding: 12px 24px;
                                background: #fa5252;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-times"></i> Reject Loan
                            </button>
                            ` : ''}
                            <button onclick="Utils.closeModal('loanDetailsModal')" style="
                                padding: 12px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            ">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            }
            
            Utils.openModal('loanDetailsModal');
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading loan details:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load loan details', 'error');
        }
    },

    // Approve loan
    async approveLoan(loanId) {
        Utils.confirmAction(
            'Approve Loan',
            'Are you sure you want to approve this loan application? This action cannot be undone.',
            async () => {
                try {
                    Utils.showLoading('Approving loan...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    const loan = snapshot.val();
                    
                    if (!loan) {
                        throw new Error('Loan not found');
                    }
                    
                    // Update loan status
                    await loanRef.update({
                        status: 'approved',
                        approvedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByEmail: AppState.currentUser.email,
                        updatedAt: Date.now()
                    });
                    
                    // Create notification for customer
                    if (loan.customerId) {
                        const notificationRef = db.ref('notifications/' + loan.customerId).push();
                        await notificationRef.set({
                            id: notificationRef.key,
                            type: 'loan_approved',
                            title: 'Loan Approved',
                            message: `Your loan application for ${Utils.formatCurrency(loan.amount)} has been approved`,
                            data: {
                                loanId: loanId,
                                amount: loan.amount,
                                status: 'approved'
                            },
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                    
                    // Create notification for agent if assigned
                    if (loan.agentId) {
                        const agentNotificationRef = db.ref('notifications/' + loan.agentId).push();
                        await agentNotificationRef.set({
                            id: agentNotificationRef.key,
                            type: 'customer_loan_approved',
                            title: 'Customer Loan Approved',
                            message: `Loan application for ${loan.customerName} has been approved`,
                            data: {
                                loanId: loanId,
                                customerId: loan.customerId,
                                amount: loan.amount
                            },
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                    
                    // Log audit
                    await this.logAudit({
                        action: 'APPROVE_LOAN',
                        targetId: loanId,
                        targetType: 'loan',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            loanId: loanId,
                            customerId: loan.customerId,
                            amount: loan.amount
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('Loan Approved', 'Loan application has been approved successfully', 'success');
                    
                    // Refresh loan lists
                    if (AppState.currentSection === 'dashboard') {
                        loadRecentLoans();
                    } else if (AppState.currentSection === 'loans') {
                        loadLoanApplications();
                    }
                    
                    // Close modal if open
                    Utils.closeModal('loanDetailsModal');
                    
                } catch (error) {
                    console.error('Error approving loan:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to approve loan', 'error');
                }
            }
        );
    },

    // Reject loan
    async rejectLoan(loanId) {
        Utils.confirmAction(
            'Reject Loan',
            'Are you sure you want to reject this loan application? This action cannot be undone.',
            async () => {
                try {
                    const reason = prompt('Please enter the reason for rejection:');
                    if (!reason || !reason.trim()) {
                        Utils.showNotification('Cancelled', 'Rejection cancelled - no reason provided', 'warning');
                        return;
                    }
                    
                    Utils.showLoading('Rejecting loan...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    const loan = snapshot.val();
                    
                    if (!loan) {
                        throw new Error('Loan not found');
                    }
                    
                    // Update loan status
                    await loanRef.update({
                        status: 'rejected',
                        rejectedAt: Date.now(),
                        rejectedBy: AppState.currentUser.uid,
                        rejectedByEmail: AppState.currentUser.email,
                        rejectionReason: reason,
                        updatedAt: Date.now()
                    });
                    
                    // Create notification for customer
                    if (loan.customerId) {
                        const notificationRef = db.ref('notifications/' + loan.customerId).push();
                        await notificationRef.set({
                            id: notificationRef.key,
                            type: 'loan_rejected',
                            title: 'Loan Rejected',
                            message: `Your loan application for ${Utils.formatCurrency(loan.amount)} has been rejected`,
                            data: {
                                loanId: loanId,
                                amount: loan.amount,
                                status: 'rejected',
                                reason: reason
                            },
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                    
                    // Log audit
                    await this.logAudit({
                        action: 'REJECT_LOAN',
                        targetId: loanId,
                        targetType: 'loan',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            loanId: loanId,
                            customerId: loan.customerId,
                            amount: loan.amount,
                            reason: reason
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('Loan Rejected', 'Loan application has been rejected', 'info');
                    
                    // Refresh loan lists
                    if (AppState.currentSection === 'dashboard') {
                        loadRecentLoans();
                    } else if (AppState.currentSection === 'loans') {
                        loadLoanApplications();
                    }
                    
                    // Close modal if open
                    Utils.closeModal('loanDetailsModal');
                    
                } catch (error) {
                    console.error('Error rejecting loan:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to reject loan', 'error');
                }
            }
        );
    },

    // View agent details
    async viewAgentDetails(agentId) {
        try {
            Utils.showLoading('Loading agent details...');
            
            const agentRef = db.ref('agents/' + agentId);
            const snapshot = await agentRef.once('value');
            const agent = snapshot.val();
            
            if (!agent) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Agent not found', 'error');
                return;
            }
            
            // Get agent's customers
            const usersRef = db.ref('users');
            const usersSnapshot = await usersRef.once('value');
            const users = usersSnapshot.val() || {};
            
            const agentCustomers = Object.values(users)
                .filter(user => user.userType === 'customer' && user.assignedAgentId === agentId)
                .length;
            
            // Prepare agent details HTML
            const content = document.getElementById('loanDetailsContent');
            if (content) {
                const profilePic = agent.profilePhoto || agent.photoUrl || '';
                
                content.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Agent Details</h2>
                        
                        <div style="display: flex; gap: 30px; margin-bottom: 30px;">
                            <div style="flex: 0 0 auto;">
                                ${profilePic ? `
                                <img src="${profilePic}" alt="${agent.fullName || 'Agent'}" style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    object-fit: cover;
                                    border: 5px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                    cursor: pointer;
                                " onclick="viewImage('${profilePic}', '${agent.fullName || 'Agent'}')">
                                ` : `
                                <div style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 48px;
                                    font-weight: 600;
                                    border: 5px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                ">
                                    ${agent.fullName ? agent.fullName.charAt(0).toUpperCase() : 'A'}
                                </div>
                                `}
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">
                                    ${agent.fullName || 'Unknown Agent'}
                                </h3>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Agent ID</div>
                                        <div style="font-weight: 600; color: #333;">${agent.agentId || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Email</div>
                                        <div style="font-weight: 500; color: #333;">${agent.email || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Phone</div>
                                        <div style="font-weight: 500; color: #333;">${agent.phone || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Status</div>
                                        <div style="font-weight: 500; color: #333;">
                                            <span style="
                                                padding: 4px 8px;
                                                border-radius: 4px;
                                                font-size: 12px;
                                                font-weight: 500;
                                                background: #d3f9d8;
                                                color: #0b7285;
                                            ">
                                                ${agent.status || 'active'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${agentCustomers}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Clients</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${agent.totalLoans || 0}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Loans</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${Utils.formatCurrency(agent.commissionEarned || 0)}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Commission Earned</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${agent.performance?.successRate || 0}%
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Success Rate</div>
                            </div>
                        </div>
                        
                        ${agent.nrc ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Identification</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">NRC Number</div>
                                        <div style="font-weight: 600; color: #333;">${agent.nrc}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Residence</div>
                                        <div style="font-weight: 500; color: #333;">${agent.residence || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="Utils.closeModal('loanDetailsModal')" style="
                                padding: 12px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            ">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            }
            
            Utils.openModal('loanDetailsModal');
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading agent details:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load agent details', 'error');
        }
    },

    // View customer details
    async viewCustomerDetails(customerId) {
        try {
            Utils.showLoading('Loading customer details...');
            
            const userRef = db.ref('users/' + customerId);
            const snapshot = await userRef.once('value');
            const customer = snapshot.val();
            
            if (!customer || customer.userType !== 'customer') {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Customer not found', 'error');
                return;
            }
            
            // Get customer's loans
            const loansRef = db.ref('loans');
            const loansSnapshot = await loansRef.once('value');
            const loans = loansSnapshot.val() || {};
            
            const customerLoans = Object.values(loans)
                .filter(loan => loan.customerId === customerId)
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 5);
            
            // Prepare customer details HTML
            const content = document.getElementById('loanDetailsContent');
            if (content) {
                const profilePic = customer.profilePhoto || customer.photoUrl || '';
                
                content.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Customer Details</h2>
                        
                        <div style="display: flex; gap: 30px; margin-bottom: 30px;">
                            <div style="flex: 0 0 auto;">
                                ${profilePic ? `
                                <img src="${profilePic}" alt="${customer.fullName || 'Customer'}" style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    object-fit: cover;
                                    border: 5px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                    cursor: pointer;
                                " onclick="viewImage('${profilePic}', '${customer.fullName || 'Customer'}')">
                                ` : `
                                <div style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, #40c057 0%, #82c91e 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 48px;
                                    font-weight: 600;
                                    border: 5px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                ">
                                    ${customer.fullName ? customer.fullName.charAt(0).toUpperCase() : 'C'}
                                </div>
                                `}
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">
                                    ${customer.fullName || 'Unknown Customer'}
                                </h3>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Customer ID</div>
                                        <div style="font-weight: 600; color: #333;">${customerId.substring(0, 8)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Email</div>
                                        <div style="font-weight: 500; color: #333;">${customer.email || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Phone</div>
                                        <div style="font-weight: 500; color: #333;">${customer.phone || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Status</div>
                                        <div style="font-weight: 500; color: #333;">
                                            <span style="
                                                padding: 4px 8px;
                                                border-radius: 4px;
                                                font-size: 12px;
                                                font-weight: 500;
                                                background: ${customer.status === 'active' ? '#d3f9d8' : '#fff3bf'};
                                                color: ${customer.status === 'active' ? '#0b7285' : '#e67700'};
                                            ">
                                                ${customer.status || 'active'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${customer.totalLoans || 0}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Loans</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${Utils.formatCurrency(customer.loanLimit || 0)}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Loan Limit</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${Utils.formatCurrency(customer.accountBalance || 0)}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Account Balance</div>
                            </div>
                        </div>
                        
                        ${customer.nrc ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Identification</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">NRC Number</div>
                                        <div style="font-weight: 600; color: #333;">${customer.nrc}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Residence</div>
                                        <div style="font-weight: 500; color: #333;">${customer.residence || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${customerLoans.length > 0 ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Recent Loans</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Loan ID</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Amount</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Applied</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customerLoans.map(loan => `
                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                            <td style="padding: 10px; color: #333;">
                                                <code>${loan.id ? loan.id.substring(0, 8) : 'N/A'}</code>
                                            </td>
                                            <td style="padding: 10px; font-weight: 600; color: #333;">
                                                ${Utils.formatCurrency(loan.amount || 0)}
                                            </td>
                                            <td style="padding: 10px;">
                                                ${Utils.getLoanStatusBadge(loan.status || 'pending')}
                                            </td>
                                            <td style="padding: 10px; color: #6c757d; font-size: 13px;">
                                                ${Utils.getTimeAgo(loan.createdAt || Date.now())}
                                            </td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="Utils.closeModal('loanDetailsModal')" style="
                                padding: 12px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            ">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            }
            
            Utils.openModal('loanDetailsModal');
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading customer details:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load customer details', 'error');
        }
    },

    // Initialize real-time listeners
    initRealTimeListeners() {
        try {
            // Real-time loan updates
            const loansRef = db.ref('loans');
            const loansListener = loansRef.on('value', (snapshot) => {
                const loans = snapshot.val() || {};
                const pendingCount = Object.values(loans).filter(l => l.status === 'pending').length;
                
                // Update pending loans count
                const pendingLoansEl = document.getElementById('pendingLoans');
                if (pendingLoansEl) {
                    pendingLoansEl.textContent = pendingCount.toLocaleString();
                }
                
                // Refresh loan lists if on relevant section
                if (AppState.currentSection === 'dashboard') {
                    loadRecentLoans();
                } else if (AppState.currentSection === 'loans') {
                    loadLoanApplications(AppState.pagination.loans.currentPage);
                }
            });
            
            AppState.activeLoanListeners.push(loansListener);
            
            // Real-time system health monitoring
            this.monitorSystemHealth();
            
            console.log('SUDO: Real-time listeners initialized');
            
        } catch (error) {
            console.error('Error initializing real-time listeners:', error);
        }
    },

    // Monitor system health
    monitorSystemHealth() {
        // Simulate system health monitoring
        setInterval(() => {
            const health = Math.min(100, Math.max(80, 100 - Math.random() * 10));
            AppState.systemStats.systemHealth = Math.round(health);
            
            const healthEl = document.getElementById('systemHealth');
            if (healthEl) {
                healthEl.textContent = Math.round(health) + '%';
                healthEl.style.color = health > 90 ? '#40c057' : health > 75 ? '#fab005' : '#fa5252';
            }
        }, 10000);
    },

    // Update pagination
    updatePagination(type, totalPages, currentPage) {
        const paginationEl = document.getElementById(type + 'Pagination');
        if (!paginationEl) return;
        
        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }
        
        let html = '';
        
        // Previous button
        html += `
            <button onclick="changePage('${type}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="
                padding: 8px 12px;
                border: 1px solid #dee2e6;
                background: ${currentPage === 1 ? '#f8f9fa' : 'white'};
                color: ${currentPage === 1 ? '#adb5bd' : '#495057'};
                border-radius: 6px;
                cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};
                font-size: 14px;
            ">
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <button onclick="changePage('${type}', ${i})" style="
                    padding: 8px 12px;
                    border: 1px solid ${i === currentPage ? '#4dabf7' : '#dee2e6'};
                    background: ${i === currentPage ? '#4dabf7' : 'white'};
                    color: ${i === currentPage ? 'white' : '#495057'};
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: ${i === currentPage ? '600' : 'normal'};
                ">
                    ${i}
                </button>
            `;
        }
        
        // Next button
        html += `
            <button onclick="changePage('${type}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="
                padding: 8px 12px;
                border: 1px solid #dee2e6;
                background: ${currentPage === totalPages ? '#f8f9fa' : 'white'};
                color: ${currentPage === totalPages ? '#adb5bd' : '#495057'};
                border-radius: 6px;
                cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};
                font-size: 14px;
            ">
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
        
        paginationEl.innerHTML = html;
    },

    // Log audit trail
    async logAudit(logData) {
        try {
            const logId = Utils.generateId('AUDIT_');
            const auditRef = db.ref('auditLogs/' + logId);
            
            await auditRef.set({
                ...logData,
                timestamp: Date.now(),
                userType: 'sudo',
                performedByEmail: AppState.currentUser.email
            });
            
        } catch (error) {
            console.error('Error logging audit:', error);
        }
    },

    // Logout
    async logout() {
        try {
            // Clear all listeners
            AppState.activeLoanListeners.forEach(listener => {
                if (typeof listener === 'function') listener();
            });
            AppState.activeLoanListeners = [];
            
            // Log logout
            await this.logAudit({
                action: 'SUDO_LOGOUT',
                details: 'SUDO admin logged out from control panel',
                performedBy: AppState.currentUser.uid
            });
            
            // Sign out
            await auth.signOut();
            
            // Show login form
            SudoAuthService.showLoginForm();
            
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }
};

// ===== GLOBAL FUNCTIONS =====
// View loan details
function viewLoanDetails(loanId) {
    FirebaseService.viewLoanDetails(loanId);
}

// Approve loan
function approveLoan(loanId) {
    FirebaseService.approveLoan(loanId);
}

// Reject loan
function rejectLoan(loanId) {
    FirebaseService.rejectLoan(loanId);
}

// View agent details
function viewAgentDetails(agentId) {
    FirebaseService.viewAgentDetails(agentId);
}

// View customer details
function viewCustomerDetails(customerId) {
    FirebaseService.viewCustomerDetails(customerId);
}

// View image in modal
function viewImage(imageUrl, title = 'Image') {
    const modalImage = document.getElementById('modalImage');
    if (modalImage) {
        modalImage.src = imageUrl;
        modalImage.alt = title;
        Utils.openModal('imageModal');
    }
}

// Load loan applications
function loadLoanApplications(page = 1) {
    const statusFilter = document.getElementById('loanStatusFilter')?.value || 'all';
    const searchTerm = document.getElementById('loanSearch')?.value || '';
    
    FirebaseService.loadLoanApplications(page, {
        status: statusFilter,
        search: searchTerm
    });
}

// Filter loans
function filterLoans() {
    loadLoanApplications(1);
}

// Load agents
function loadAgents() {
    FirebaseService.loadAgents();
}

// Load customers
function loadCustomers() {
    FirebaseService.loadCustomers();
}

// Load recent loans
function loadRecentLoans() {
    FirebaseService.loadRecentLoans();
}

// Change page
function changePage(type, page) {
    if (page < 1 || page > AppState.pagination[type].totalPages) return;
    
    switch(type) {
        case 'loans':
            loadLoanApplications(page);
            break;
    }
}

// View all agents
function viewAllAgents() {
    SudoAuthService.showSection('agents');
}

// View all customers
function viewAllCustomers() {
    SudoAuthService.showSection('customers');
}

// Show system settings (placeholder)
function showSystemSettings() {
    Utils.showNotification('System Settings', 'System settings functionality coming soon', 'info');
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    // Initialize SUDO authentication
    SudoAuthService.init();
    
    // Add responsive styles
    const style = document.createElement('style');
    style.textContent = `
        @media (max-width: 768px) {
            .sudo-navbar .nav-links {
                display: none;
            }
            
            .sudo-content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            #agentsGrid, #customersGrid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .sudo-navbar {
                padding: 10px 15px;
            }
            
            .nav-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
            }
            
            .user-info {
                display: none;
            }
        }
        
        /* Modal animations */
        #loanDetailsModal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        #imageModal.active {
            display: flex;
        }
    `;
    document.head.appendChild(style);
    
    // Make functions globally available
    window.Utils = Utils;
    window.FirebaseService = FirebaseService;
    window.SudoAuthService = SudoAuthService;
    window.viewLoanDetails = viewLoanDetails;
    window.approveLoan = approveLoan;
    window.rejectLoan = rejectLoan;
    window.viewAgentDetails = viewAgentDetails;
    window.viewCustomerDetails = viewCustomerDetails;
    window.viewImage = viewImage;
    window.loadLoanApplications = loadLoanApplications;
    window.filterLoans = filterLoans;
    window.loadAgents = loadAgents;
    window.loadCustomers = loadCustomers;
    window.changePage = changePage;
    window.viewAllAgents = viewAllAgents;
    window.viewAllCustomers = viewAllCustomers;
    window.showSystemSettings = showSystemSettings;
});
    </script>
</body>
</html>
