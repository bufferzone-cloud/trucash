<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | SUDO Super Control Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse for CSV Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== macOS Theme CSS Reset ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
                       'Helvetica Neue', 'Segoe UI', Roboto, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --macos-gray-100: #f5f5f7;
            --macos-gray-200: #e5e5e7;
            --macos-gray-300: #d2d2d7;
            --macos-gray-400: #86868b;
            --macos-gray-500: #515154;
            --macos-gray-600: #1d1d1f;
            --macos-blue: #007AFF;
            --macos-blue-light: #409cff;
            --macos-blue-dark: #0056cc;
            --macos-green: #34c759;
            --macos-red: #ff3b30;
            --macos-purple: #5856d6;
            --macos-yellow: #ffcc00;
            --macos-orange: #ff9500;
            --macos-pink: #ff2d55;
            --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --macos-shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
            --macos-shadow-light: 0 2px 6px rgba(0, 0, 0, 0.04);
            --macos-border-radius: 12px;
            --macos-border-radius-small: 8px;
            --macos-border-radius-large: 16px;
            --macos-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --macos-glass: rgba(255, 255, 255, 0.85);
            --macos-glass-border: rgba(255, 255, 255, 0.2);
            --macos-danger-bg: rgba(255, 59, 48, 0.1);
            --macos-warning-bg: rgba(255, 204, 0, 0.1);
            --macos-success-bg: rgba(52, 199, 89, 0.1);
            --macos-info-bg: rgba(0, 122, 255, 0.1);
            --macos-sidebar-width: 280px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--macos-gray-600);
            min-height: 100vh;
            line-height: 1.4;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(at 10% 20%, rgba(120, 119, 198, 0.03) 0px, transparent 50%),
                radial-gradient(at 90% 10%, rgba(0, 122, 255, 0.03) 0px, transparent 50%),
                radial-gradient(at 50% 90%, rgba(76, 175, 80, 0.03) 0px, transparent 50%);
            z-index: -1;
        }

        /* ===== SUDO Header ===== */
        .sudo-header {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--macos-glass-border);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--macos-shadow-light);
        }

        .sudo-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sudo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--macos-red) 0%, var(--macos-orange) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .sudo-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--macos-gray-600);
            letter-spacing: -0.3px;
        }

        .sudo-subtitle {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .live-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            background: var(--macos-success-bg);
            color: var(--macos-green);
            border-radius: 20px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--macos-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* ===== Main Layout ===== */
        .sudo-container {
            display: flex;
            min-height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* ===== Sidebar Navigation ===== */
        .sudo-sidebar {
            width: var(--macos-sidebar-width);
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--macos-glass-border);
            padding: 24px 0;
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 900;
        }

        .nav-section {
            margin-bottom: 24px;
            padding: 0 20px;
        }

        .nav-title {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--macos-gray-500);
            text-decoration: none;
            border-radius: var(--macos-border-radius);
            transition: var(--macos-transition);
            margin-bottom: 4px;
            cursor: pointer;
            user-select: none;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--macos-gray-600);
        }

        .nav-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .nav-item.active .nav-icon {
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-gray-400);
        }

        .nav-text {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 600;
        }

        /* ===== Main Content ===== */
        .sudo-main {
            flex: 1;
            margin-left: var(--macos-sidebar-width);
            padding: 24px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-gray-600);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--macos-gray-400);
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            transition: var(--macos-transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.users { background: var(--macos-info-bg); color: var(--macos-blue); }
        .stat-icon.agents { background: var(--macos-success-bg); color: var(--macos-green); }
        .stat-icon.transactions { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .stat-icon.revenue { background: var(--macos-danger-bg); color: var(--macos-red); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-gray-600);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--macos-gray-400);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--macos-green);
        }

        .stat-change.negative {
            color: var(--macos-red);
        }

        /* ===== Cards Grid ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius-large);
            overflow: hidden;
            transition: var(--macos-transition);
        }

        .card:hover {
            box-shadow: var(--macos-shadow);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* ===== Form Elements ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: 1px solid var(--macos-gray-200);
            border-radius: var(--macos-border-radius-small);
            background: rgba(255, 255, 255, 0.9);
            transition: var(--macos-transition);
            color: var(--macos-gray-600);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }

        .form-control::placeholder {
            color: var(--macos-gray-400);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* ===== Tables ===== */
        .table-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: rgba(0, 0, 0, 0.02);
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table td {
            padding: 16px;
            font-size: 13px;
            color: var(--macos-gray-600);
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table tbody tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
        }

        .status-active { background: var(--macos-success-bg); color: var(--macos-green); }
        .status-inactive { background: var(--macos-gray-200); color: var(--macos-gray-500); }
        .status-suspended { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .status-banned { background: var(--macos-danger-bg); color: var(--macos-red); }
        .status-pending { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
            background: var(--macos-info-bg);
            color: var(--macos-blue);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 10px 18px;
            border-radius: var(--macos-border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--macos-transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-blue-light) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--macos-blue-dark) 0%, var(--macos-blue) 100%);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--macos-red) 0%, #ff5a5a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #cc2e25 0%, var(--macos-red) 100%);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.35);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--macos-green) 0%, #2db867 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, var(--macos-green) 100%);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.35);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--macos-gray-300);
            color: var(--macos-gray-600);
        }

        .btn-outline:hover {
            background: rgba(0, 0, 0, 0.03);
            border-color: var(--macos-gray-400);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== Toggle Switches ===== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--macos-gray-300);
            transition: var(--macos-transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--macos-transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--macos-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ===== Charts ===== */
        .chart-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
            margin-bottom: 16px;
        }

        /* ===== Modals ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: var(--macos-border-radius-large);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-heavy);
            border: 1px solid var(--macos-glass-border);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .modal-close {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            font-size: 16px;
            color: var(--macos-gray-500);
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--macos-transition);
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== Loading Overlay ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-200);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--macos-gray-600);
            font-weight: 500;
        }

        /* ===== Notifications ===== */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--macos-border-radius);
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            box-shadow: var(--macos-shadow-heavy);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1500;
            transform: translateX(calc(100% + 24px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 320px;
            border: 1px solid var(--macos-glass-border);
        }

        .notification.active {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--macos-green);
        }

        .notification.error {
            border-left: 4px solid var(--macos-red);
        }

        .notification.info {
            border-left: 4px solid var(--macos-blue);
        }

        .notification.warning {
            border-left: 4px solid var(--macos-yellow);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success .notification-icon {
            color: var(--macos-green);
        }

        .notification.error .notification-icon {
            color: var(--macos-red);
        }

        .notification.info .notification-icon {
            color: var(--macos-blue);
        }

        .notification.warning .notification-icon {
            color: var(--macos-yellow);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
            color: var(--macos-gray-600);
        }

        .notification-message {
            font-size: 12px;
            color: var(--macos-gray-500);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--macos-gray-400);
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--macos-transition);
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--macos-gray-600);
        }

        /* ===== Code Editor ===== */
        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .code-header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .code-language {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
        }

        .code-body {
            padding: 16px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-body pre {
            margin: 0;
        }

        /* ===== Alert Boxes ===== */
        .alert {
            padding: 16px;
            border-radius: var(--macos-border-radius);
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-danger {
            background: var(--macos-danger-bg);
            border-left-color: var(--macos-red);
            color: var(--macos-red);
        }

        .alert-warning {
            background: var(--macos-warning-bg);
            border-left-color: var(--macos-yellow);
            color: var(--macos-yellow);
        }

        .alert-success {
            background: var(--macos-success-bg);
            border-left-color: var(--macos-green);
            color: var(--macos-green);
        }

        .alert-info {
            background: var(--macos-info-bg);
            border-left-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sudo-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sudo-sidebar.active {
                transform: translateX(0);
            }

            .sudo-main {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sudo-header {
                padding: 0 16px;
            }

            .sudo-main {
                padding: 16px;
            }

            .card-header, .card-body {
                padding: 16px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* ===== Utility Classes ===== */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }
        .w-100 { width: 100%; }
        .mt-16 { margin-top: 16px; }
        .mb-16 { margin-bottom: 16px; }
        .mb-24 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--macos-gray-400); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-yellow); }
        .text-info { color: var(--macos-blue); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }

        /* ===== Custom Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--macos-gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-300);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-400);
        }

        /* ===== File Upload Styles ===== */
        .file-upload-container {
            border: 2px dashed var(--macos-gray-300);
            border-radius: var(--macos-border-radius);
            padding: 24px;
            text-align: center;
            transition: var(--macos-transition);
            cursor: pointer;
        }

        .file-upload-container:hover {
            border-color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.02);
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--macos-gray-300);
            margin-bottom: 12px;
        }

        .file-upload-text {
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: var(--macos-gray-400);
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--macos-gray-100);
            border-radius: var(--macos-border-radius-small);
            margin-bottom: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            color: var(--macos-blue);
        }

        /* ===== Progress Bar ===== */
        .progress-container {
            background: var(--macos-gray-200);
            border-radius: 10px;
            overflow: hidden;
            height: 6px;
            margin: 8px 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--macos-blue), var(--macos-purple));
            height: 100%;
            transition: width 0.3s ease;
        }

        /* ===== Search Filters ===== */
        .filter-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== Data Export Styles ===== */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .export-option {
            padding: 20px;
            background: var(--macos-glass);
            border-radius: var(--macos-border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--macos-transition);
            border: 1px solid var(--macos-glass-border);
        }

        .export-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .export-icon {
            font-size: 32px;
            color: var(--macos-blue);
            margin-bottom: 12px;
        }

        /* ===== Pagination ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--macos-border-radius-small);
            border: 1px solid var(--macos-gray-200);
            background: white;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .page-btn:hover:not(.disabled) {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        .page-btn.active {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading SUDO Control Panel...</div>
    </div>

    <!-- SUDO Header -->
    <header class="sudo-header">
        <div class="sudo-logo">
            <div class="sudo-icon">SU</div>
            <div>
                <div class="sudo-title">TruCash SUDO</div>
                <div class="sudo-subtitle">Super Control Admin</div>
            </div>
        </div>
        <div class="header-actions">
            <div class="live-status">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">SU</div>
                <div>
                    <div style="font-size: 13px; font-weight: 600;" id="userName">SUDO Admin</div>
                    <div style="font-size: 11px; color: var(--macos-gray-400);" id="userRole">Full System Control</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="sudo-container">
        <!-- Sidebar Navigation -->
        <nav class="sudo-sidebar">
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <div class="nav-item active" data-section="dashboard">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Overview</div>
                </div>
                <div class="nav-item" data-section="analytics">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="nav-text">Analytics</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">User Management</div>
                <div class="nav-item" data-section="admins">
                    <div class="nav-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="nav-text">Admin Accounts</div>
                </div>
                <div class="nav-item" data-section="agents">
                    <div class="nav-icon"><i class="fas fa-id-badge"></i></div>
                    <div class="nav-text">Agent Accounts</div>
                </div>
                <div class="nav-item" data-section="customers">
                    <div class="nav-icon"><i class="fas fa-users"></i></div>
                    <div class="nav-text">Customer Accounts</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System Control</div>
                <div class="nav-item" data-section="features">
                    <div class="nav-icon"><i class="fas fa-toggle-on"></i></div>
                    <div class="nav-text">Feature Flags</div>
                </div>
                <div class="nav-item" data-section="financial">
                    <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="nav-text">Financial Settings</div>
                </div>
                <div class="nav-item" data-section="repayment">
                    <div class="nav-icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="nav-text">Repayment Plans</div>
                </div>
                <div class="nav-item" data-section="notifications">
                    <div class="nav-icon"><i class="fas fa-bell"></i></div>
                    <div class="nav-text">Notifications</div>
                </div>
                <div class="nav-item" data-section="ui-settings">
                    <div class="nav-icon"><i class="fas fa-sliders-h"></i></div>
                    <div class="nav-text">UI Behavior</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Security & Monitoring</div>
                <div class="nav-item" data-section="security">
                    <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="nav-text">Security Settings</div>
                </div>
                <div class="nav-item" data-section="audit">
                    <div class="nav-icon"><i class="fas fa-history"></i></div>
                    <div class="nav-text">Audit Logs</div>
                    <div class="nav-badge" id="auditBadge">0</div>
                </div>
                <div class="nav-item" data-section="backup">
                    <div class="nav-icon"><i class="fas fa-database"></i></div>
                    <div class="nav-text">Backup & Export</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Manual Intervention</div>
                <div class="nav-item" data-section="manual">
                    <div class="nav-icon"><i class="fas fa-hands-helping"></i></div>
                    <div class="nav-text">Manual Adjustments</div>
                </div>
                <div class="nav-item" data-section="disputes">
                    <div class="nav-icon"><i class="fas fa-gavel"></i></div>
                    <div class="nav-text">Dispute Resolution</div>
                    <div class="nav-badge" id="disputeBadge">0</div>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item" data-action="logout">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="sudo-main">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1 class="section-title">System Overview</h1>
                    <div class="section-subtitle">Real-time monitoring of the entire TruCash platform</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-icon users"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="userGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Active Agents</div>
                                <div class="stat-value" id="activeAgents">0</div>
                            </div>
                            <div class="stat-icon agents"><i class="fas fa-id-badge"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="agentGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Transactions Today</div>
                                <div class="stat-value" id="todayTransactions">0</div>
                            </div>
                            <div class="stat-icon transactions"><i class="fas fa-exchange-alt"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="transactionGrowth">0%</span> vs yesterday
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Platform Revenue</div>
                                <div class="stat-value" id="platformRevenue">$0</div>
                            </div>
                            <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="revenueGrowth">0%</span> this month
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Health</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshSystemHealth()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Database Connection</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Firebase Realtime Database</span>
                                    <span class="status-badge status-active" id="dbStatus">Connected</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Authentication Service</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Firebase Auth</span>
                                    <span class="status-badge status-active" id="authStatus">Online</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Active Sessions</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Current Active Users</span>
                                    <span class="font-semibold" id="activeSessions">0</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">System Load</label>
                                <div class="d-flex align-center justify-between">
                                    <span>API Response Time</span>
                                    <span class="font-semibold" id="apiResponseTime">0ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-8 mb-16">
                                <button class="btn btn-primary" onclick="openCreateAdminModal()">
                                    <i class="fas fa-user-plus"></i> Create Admin
                                </button>
                                <button class="btn btn-success" onclick="openCreateAgentModal()">
                                    <i class="fas fa-id-card"></i> Create Agent
                                </button>
                                <button class="btn btn-outline" onclick="openManualAdjustmentModal()">
                                    <i class="fas fa-edit"></i> Manual Adjustment
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-8">
                                <button class="btn btn-outline" onclick="openFeatureFlagModal()">
                                    <i class="fas fa-toggle-on"></i> Feature Flags
                                </button>
                                <button class="btn btn-outline" onclick="viewAuditLogs()">
                                    <i class="fas fa-history"></i> View Audit Logs
                                </button>
                                <button class="btn btn-outline" onclick="openBackupModal()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Real-time System Activity</div>
                    <canvas id="activityChart"></canvas>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admins" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Admin Accounts Management</h1>
                    <div class="section-subtitle">Create, edit, suspend, and delete admin accounts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateAdminModal()">
                            <i class="fas fa-user-plus"></i> Create New Admin
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 300px;" placeholder="Search admins..." id="adminSearch" onkeyup="searchAdmins()">
                        <button class="btn btn-outline" onclick="refreshAdminList()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="adminsTable">
                        <thead>
                            <tr>
                                <th>Admin ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Admin rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="adminPagination"></div>
            </section>

            <!-- Agent Management Section -->
            <section id="agents" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Agent Accounts Management</h1>
                    <div class="section-subtitle">Manage all agent accounts and their permissions</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <button class="btn btn-primary" onclick="openCreateAgentModal()">
                            <i class="fas fa-user-plus"></i> Create Agent
                        </button>
                        <button class="btn btn-outline" onclick="openBulkAgentActions()">
                            <i class="fas fa-users-cog"></i> Bulk Actions
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="agentStatusFilter" onchange="filterAgents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search agents..." id="agentSearch" onkeyup="searchAgents()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="agentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Clients</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <!-- Agent rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="agentPagination"></div>
            </section>

            <!-- Customer Management Section -->
            <section id="customers" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Customer Accounts Management</h1>
                    <div class="section-subtitle">Manage customer access controls and permissions</div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Transaction Limits</div>
                                    <div class="text-muted" style="font-size: 12px;">Configure customer transaction caps</div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="configureTransactionLimits()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Daily Limit</label>
                                <input type="number" class="form-control" id="dailyLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Single Transaction</label>
                                <input type="number" class="form-control" id="singleTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Account Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Set verification requirements</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoVerification" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Required Documents</label>
                                <select class="form-control" id="requiredDocs" multiple style="height: 120px;">
                                    <option value="nrc" selected>National ID (NRC)</option>
                                    <option value="passport" selected>Passport</option>
                                    <option value="drivers_license">Driver's License</option>
                                    <option value="proof_of_address">Proof of Address</option>
                                    <option value="employment_letter">Employment Letter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="customerStatusFilter" onchange="filterCustomers()">
                            <option value="all">All Status</option>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search customers..." id="customerSearch" onkeyup="searchCustomers()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Loan Limit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customer rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="customerPagination"></div>
            </section>

            <!-- Feature Flags Section -->
            <section id="features" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Feature Flags & Module Control</h1>
                    <div class="section-subtitle">Enable or disable features across the platform in real-time</div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Changes to feature flags are applied immediately across all interfaces without requiring redeployment.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Customer Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Applications</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow customers to apply for loans</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_applications" checked data-feature="loan_applications">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Online Repayments</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable online loan repayments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_online_repayments" checked data-feature="online_repayments">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Collateral Upload</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow collateral document upload</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_collateral_upload" checked data-feature="collateral_upload">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Client Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow agents to verify clients</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_client_verification" checked data-feature="client_verification">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Processing</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable loan processing by agents</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_processing" checked data-feature="loan_processing">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Commission Tracking</div>
                                    <div class="text-muted" style="font-size: 12px;">Show commission calculations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_commission_tracking" checked data-feature="commission_tracking">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Maintenance Mode</div>
                                    <div class="text-muted" style="font-size: 12px;">Put system under maintenance</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_maintenance_mode" data-feature="maintenance_mode">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">New User Registration</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow new user registrations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_new_registrations" checked data-feature="new_registrations">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Audit Logging</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable system audit logs</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_audit_logging" checked data-feature="audit_logging">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Feature Configuration Details</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Feature JSON Configuration</label>
                            <div class="code-editor">
                                <div class="code-header">
                                    <div class="code-language">JSON</div>
                                    <button class="btn btn-sm btn-outline" onclick="updateFeatureFlags()">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </div>
                                <div class="code-body">
                                    <pre id="featureJsonEditor">{
  "customer_features": {
    "loan_applications": true,
    "online_repayments": true,
    "collateral_upload": true
  },
  "agent_features": {
    "client_verification": true,
    "loan_processing": true,
    "commission_tracking": true
  },
  "system_features": {
    "maintenance_mode": false,
    "new_registrations": true,
    "audit_logging": true
  }
}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financial Settings Section -->
            <section id="financial" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Financial System Configuration</h1>
                    <div class="section-subtitle">Control all financial parameters and transaction rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Limits</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount</label>
                                <input type="number" class="form-control" id="minLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount</label>
                                <input type="number" class="form-control" id="maxLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Daily Transaction Limit</label>
                                <input type="number" class="form-control" id="dailyTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Fees & Commissions</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Service Charge (%)</label>
                                <input type="number" class="form-control" id="serviceCharge" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Commission (%)</label>
                                <input type="number" class="form-control" id="agentCommission" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Late Payment Fee (%)</label>
                                <input type="number" class="form-control" id="latePaymentFee" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Approval Thresholds</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto-approval Limit</label>
                                <input type="number" class="form-control" id="autoApprovalLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manual Review Threshold</label>
                                <input type="number" class="form-control" id="manualReviewThreshold" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Threshold (%)</label>
                                <input type="number" class="form-control" id="riskThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Currency & Formatting</div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Default Currency</label>
                                <select class="form-control" id="defaultCurrency">
                                    <option value="USD">USD ($)</option>
                                    <option value="ZMW">ZMW (K)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Decimal Places</label>
                                <select class="form-control" id="decimalPlaces">
                                    <option value="0">0 (e.g., 100)</option>
                                    <option value="2" selected>2 (e.g., 100.00)</option>
                                    <option value="3">3 (e.g., 100.000)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency Format</label>
                            <select class="form-control" id="currencyFormat">
                                <option value="symbol_before">Symbol before ($100)</option>
                                <option value="symbol_after">Symbol after (100$)</option>
                                <option value="code_before">Code before (USD 100)</option>
                                <option value="code_after">Code after (100 USD)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveFinancialSettings()">
                        <i class="fas fa-save"></i> Save All Financial Settings
                    </button>
                </div>
            </section>

            <!-- Repayment Plans Section -->
            <section id="repayment" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Repayment Plans & Penalty Systems</h1>
                    <div class="section-subtitle">Define repayment timelines, installment structures, and penalty rules</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateRepaymentPlanModal()">
                            <i class="fas fa-plus-circle"></i> Create New Plan
                        </button>
                    </div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Penalty Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Late Payment Penalty (%)</label>
                                <input type="number" class="form-control" id="latePenaltyRate" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grace Period (Days)</label>
                                <input type="number" class="form-control" id="gracePeriodDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" class="form-control" id="defaultInterestRate" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Escalation Rules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Days to Auto-Restriction</label>
                                <input type="number" class="form-control" id="autoRestrictionDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Escalation Threshold (%)</label>
                                <input type="number" class="form-control" id="escalationThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collection Agency Trigger</label>
                                <input type="number" class="form-control" id="collectionTriggerDays" placeholder="Enter days">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-16">
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search repayment plans..." id="repaymentPlanSearch" onkeyup="searchRepaymentPlans()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="repaymentPlansTable">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Plan Name</th>
                                <th>Duration</th>
                                <th>Interest Rate</th>
                                <th>Installments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repaymentPlansBody">
                            <!-- Repayment plan rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="repaymentPagination"></div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Notification System Configuration</h1>
                    <div class="section-subtitle">Configure automated notifications and alerts</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Payment Reminders</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Payment Reminders</div>
                                    <div class="text-muted" style="font-size: 12px;">Send automatic payment reminders</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_payment_reminders" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Days Before Due Date</label>
                                <input type="number" class="form-control" id="reminderDaysBefore" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reminder Frequency</label>
                                <select class="form-control" id="reminderFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Overdue Alerts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Overdue Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Send alerts for overdue payments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_overdue_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert After (Days)</label>
                                <input type="number" class="form-control" id="overdueAlertDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Alerts</label>
                                <input type="number" class="form-control" id="maxOverdueAlerts" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Security Notifications</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Login Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on new device login</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_login_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Account Changes</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on account modifications</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_account_changes" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Security Warnings</div>
                                    <div class="text-muted" style="font-size: 12px;">Send security warnings</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_security_warnings" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Notification Templates</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Payment Reminder Template</label>
                            <textarea class="form-control form-textarea" id="paymentReminderTemplate" rows="4">Dear {customer_name}, your payment of {amount} is due on {due_date}. Please make payment to avoid penalties.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overdue Alert Template</label>
                            <textarea class="form-control form-textarea" id="overdueAlertTemplate" rows="4">URGENT: Your payment of {amount} is overdue by {days_overdue} days. Please make immediate payment to avoid account restrictions.</textarea>
                        </div>
                        <div class="text-right">
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Save Notification Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- UI Behavior Section -->
            <section id="ui-settings" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">UI Behavior & Layout Configuration</h1>
                    <div class="section-subtitle">Control dashboard layouts, visible modules, and interface behavior</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Dashboard Layouts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Dashboard</label>
                                <select class="form-control" id="customerDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="compact">Compact Layout</option>
                                    <option value="detailed">Detailed Layout</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Dashboard</label>
                                <select class="form-control" id="agentDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="analytics">Analytics Focus</option>
                                    <option value="client_management">Client Management Focus</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Admin Dashboard</label>
                                <select class="form-control" id="adminDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="monitoring">Monitoring Focus</option>
                                    <option value="approval">Approval Focus</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Visible Modules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Modules</label>
                                <select class="form-control" id="customerModules" multiple style="height: 150px;">
                                    <option value="loans" selected>Loans</option>
                                    <option value="repayments" selected>Repayments</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="collateral" selected>Collateral</option>
                                    <option value="profile" selected>Profile</option>
                                    <option value="notifications" selected>Notifications</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">UI Behavior</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Auto-refresh Data</div>
                                    <div class="text-muted" style="font-size: 12px;">Auto-refresh dashboard data</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_auto_refresh" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Show Tutorials</div>
                                    <div class="text-muted" style="font-size: 12px;">Show onboarding tutorials</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_show_tutorials" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Animations</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable UI animations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_animations" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveUISettings()">
                        <i class="fas fa-save"></i> Save UI Configuration
                    </button>
                </div>
            </section>

            <!-- Security Settings Section -->
            <section id="security" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Security System Configuration</h1>
                    <div class="section-subtitle">Configure security parameters and access controls</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Session Management</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Session Timeout (Minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Concurrent Sessions</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force Logout on Inactivity</label>
                                <select class="form-control" id="forceLogout">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Login Security</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Max Login Attempts</label>
                                <input type="number" class="form-control" id="maxLoginAttempts" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account Lockout Duration (Minutes)</label>
                                <input type="number" class="form-control" id="lockoutDuration" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP Lockout Threshold</label>
                                <input type="number" class="form-control" id="ipLockoutThreshold" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Password Policies</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Password Length</label>
                                <input type="number" class="form-control" id="minPasswordLength" placeholder="Enter length">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password Expiry (Days)</label>
                                <input type="number" class="form-control" id="passwordExpiryDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password History</label>
                                <input type="number" class="form-control" id="passwordHistoryCount" placeholder="Enter number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Advanced Security</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">Two-Factor Authentication</div>
                                <div class="text-muted" style="font-size: 12px;">Require 2FA for admin access</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_2fa">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">IP Whitelisting</div>
                                <div class="text-muted" style="font-size: 12px;">Restrict access to specific IPs</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_ip_whitelist">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allowed IP Addresses (Comma-separated)</label>
                            <textarea class="form-control form-textarea" id="allowedIPs" rows="3" placeholder="192.168.1.1, 10.0.0.1"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">
                        <i class="fas fa-save"></i> Save Security Settings
                    </button>
                </div>
            </section>

            <!-- Audit Logs Section -->
            <section id="audit" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Audit Logs</h1>
                    <div class="section-subtitle">Complete audit trail of all system activities</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="auditUserType" onchange="filterAuditLogs()">
                            <option value="all">All Users</option>
                            <option value="admin">Admins</option>
                            <option value="agent">Agents</option>
                            <option value="customer">Customers</option>
                            <option value="system">System</option>
                        </select>
                        <select class="form-control" style="width: 200px;" id="auditActionType" onchange="filterAuditLogs()">
                            <option value="all">All Actions</option>
                            <option value="login">Logins</option>
                            <option value="create">Creations</option>
                            <option value="update">Updates</option>
                            <option value="delete">Deletions</option>
                            <option value="financial">Financial</option>
                            <option value="security">Security</option>
                        </select>
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateFrom" onchange="filterAuditLogs()">
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateTo" onchange="filterAuditLogs()">
                    </div>
                    <div class="d-flex gap-8">
                        <button class="btn btn-outline" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="auditLogsTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User Type</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Audit log rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="auditPagination"></div>
            </section>

            <!-- Backup & Export Section -->
            <section id="backup" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Backup & Data Export</h1>
                    <div class="section-subtitle">Manage data backups, exports, and archival rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Backup Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto Backup Frequency</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Retention Period (Days)</label>
                                <input type="number" class="form-control" id="retentionPeriod" placeholder="Enter days">
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Auto Backup</div>
                                    <div class="text-muted" style="font-size: 12px;">Automatic database backups</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="backup_auto_enable" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Manual Backup</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Data to Backup</label>
                                <select class="form-control" id="backupDataType" multiple style="height: 120px;">
                                    <option value="users" selected>User Data</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="loans" selected>Loans</option>
                                    <option value="audit_logs" selected>Audit Logs</option>
                                    <option value="system_settings">System Settings</option>
                                    <option value="financial_data">Financial Data</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup Format</label>
                                <select class="form-control" id="backupFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" onclick="createManualBackup()">
                                <i class="fas fa-database"></i> Create Backup Now
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Data Export</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Export Type</label>
                                <select class="form-control" id="exportType">
                                    <option value="all_data">All Data</option>
                                    <option value="user_data">User Data</option>
                                    <option value="transaction_data">Transaction Data</option>
                                    <option value="financial_reports">Financial Reports</option>
                                    <option value="audit_trail">Audit Trail</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <div class="form-row">
                                    <input type="date" class="form-control" id="exportDateFrom" placeholder="From">
                                    <input type="date" class="form-control" id="exportDateTo" placeholder="To">
                                </div>
                            </div>
                            <button class="btn btn-success w-100" onclick="exportData()">
                                <i class="fas fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Backup History</div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Backup ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryBody">
                                <!-- Backup history will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Manual Intervention Section -->
            <section id="manual" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Manual System Intervention</h1>
                    <div class="section-subtitle">Direct intervention tools for account and transaction management</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Manual interventions are logged and require proper authorization. Use with extreme caution.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Account Balance Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">User Type</label>
                                <select class="form-control" id="adjustmentUserType">
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User ID/Email</label>
                                <input type="text" class="form-control" id="adjustmentUserId" placeholder="Enter user ID or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjustmentType">
                                    <option value="add">Add Funds</option>
                                    <option value="deduct">Deduct Funds</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="adjustmentAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control form-textarea" id="adjustmentReason" rows="3" placeholder="Enter reason for adjustment"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processManualAdjustment()">
                                <i class="fas fa-check-circle"></i> Process Adjustment
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Reversal</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="reversalTransactionId" placeholder="Enter transaction ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reversal Type</label>
                                <select class="form-control" id="reversalType">
                                    <option value="full">Full Reversal</option>
                                    <option value="partial">Partial Reversal</option>
                                </select>
                            </div>
                            <div class="form-group" id="partialAmountGroup" style="display: none;">
                                <label class="form-label">Partial Amount</label>
                                <input type="number" class="form-control" id="partialReversalAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Reversal</label>
                                <textarea class="form-control form-textarea" id="reversalReason" rows="3" placeholder="Enter reason for reversal"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Authorization Code</label>
                                <input type="password" class="form-control" id="reversalAuthCode" placeholder="Enter authorization code">
                            </div>
                            <button class="btn btn-danger w-100" onclick="processTransactionReversal()">
                                <i class="fas fa-undo"></i> Reverse Transaction
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Repayment Schedule Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Loan ID</label>
                                <input type="text" class="form-control" id="adjustmentLoanId" placeholder="Enter loan ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="repaymentAdjustmentType">
                                    <option value="extend">Extend Term</option>
                                    <option value="reduce">Reduce Term</option>
                                    <option value="reschedule">Reschedule</option>
                                    <option value="waive_penalty">Waive Penalty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Due Date</label>
                                <input type="date" class="form-control" id="newDueDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Installment Amount</label>
                                <input type="number" class="form-control" id="newInstallmentAmount" placeholder="Enter new amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Justification</label>
                                <textarea class="form-control form-textarea" id="repaymentAdjustmentJustification" rows="3" placeholder="Enter justification"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processRepaymentAdjustment()">
                                <i class="fas fa-calendar-edit"></i> Adjust Repayment
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Analytics</h1>
                    <div class="section-subtitle">Real-time analytics and performance metrics</div>
                </div>

                <div class="cards-grid">
                    <div class="chart-container">
                        <div class="chart-title">User Growth Trend</div>
                        <canvas id="userGrowthChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Transaction Volume</div>
                        <canvas id="transactionVolumeChart"></canvas>
                    </div>
                </div>

                <div class="cards-grid mt-16">
                    <div class="chart-container">
                        <div class="chart-title">Revenue Analysis</div>
                        <canvas id="revenueChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Agent Performance</div>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Dispute Resolution Section -->
            <section id="disputes" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Dispute Resolution Center</h1>
                    <div class="section-subtitle">Manage customer-agent disputes and conflicts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="disputeStatusFilter" onchange="filterDisputes()">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="escalated">Escalated</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search disputes..." id="disputeSearch" onkeyup="searchDisputes()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="disputesTable">
                        <thead>
                            <tr>
                                <th>Dispute ID</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTableBody">
                            <!-- Dispute rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="disputePagination"></div>
            </section>
        </main>
    </div>

    <!-- Create Admin Modal -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Admin Account</h3>
                <button class="modal-close" onclick="closeModal('createAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="adminFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="adminConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Admin Role</label>
                    <select class="form-control" id="adminRole">
                        <option value="super_admin">Super Admin</option>
                        <option value="financial_admin">Financial Admin</option>
                        <option value="user_admin">User Admin</option>
                        <option value="support_admin">Support Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <select class="form-control" id="adminPermissions" multiple style="height: 150px;">
                        <option value="user_management">User Management</option>
                        <option value="financial_management">Financial Management</option>
                        <option value="agent_approval">Agent Approval</option>
                        <option value="dispute_resolution">Dispute Resolution</option>
                        <option value="system_settings">System Settings</option>
                        <option value="audit_logs">Audit Logs</option>
                        <option value="backup_export">Backup & Export</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAdminModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAdminAccount()">
                    <i class="fas fa-user-plus"></i> Create Admin Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent Account</h3>
                <button class="modal-close" onclick="closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="agentFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="agentPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="agentEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="agentPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="agentConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent ID (Auto-generated)</label>
                    <input type="text" class="form-control" id="agentId" placeholder="Will be auto-generated" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" class="form-control" id="agentCommissionRate" placeholder="Enter commission rate" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Status</label>
                    <select class="form-control" id="agentInitialStatus">
                        <option value="active">Active</option>
                        <option value="pending">Pending Verification</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAgentAccount()">
                    <i class="fas fa-id-card"></i> Create Agent Account
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Adjustment Modal -->
    <div class="modal" id="manualAdjustmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manual System Adjustment</h3>
                <button class="modal-close" onclick="closeModal('manualAdjustmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Adjustment Type</label>
                    <select class="form-control" id="manualAdjustmentType">
                        <option value="balance">Balance Adjustment</option>
                        <option value="transaction">Transaction Reversal</option>
                        <option value="repayment">Repayment Schedule</option>
                        <option value="loan">Loan Modification</option>
                    </select>
                </div>
                <div id="manualAdjustmentContent">
                    <!-- Dynamic content based on type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('manualAdjustmentModal')">Cancel</button>
                <button class="btn btn-primary" id="processManualAdjustmentBtn">Process Adjustment</button>
            </div>
        </div>
    </div>

    <!-- Feature Flag Modal -->
    <div class="modal" id="featureFlagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Feature Flag Management</h3>
                <button class="modal-close" onclick="closeModal('featureFlagModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Toggle features on/off to control platform functionality
                </div>
                <div id="featureFlagContent">
                    <!-- Feature flags loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('featureFlagModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeatureFlagsFromModal()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backup & Data Export</h3>
                <button class="modal-close" onclick="closeModal('backupModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportDataByType('users')">
                        <div class="export-icon"><i class="fas fa-users"></i></div>
                        <div class="font-semibold">User Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all user information</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('transactions')">
                        <div class="export-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="font-semibold">Transactions</div>
                        <div class="text-muted" style="font-size: 12px;">Export transaction history</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('loans')">
                        <div class="export-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="font-semibold">Loan Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all loan records</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('audit')">
                        <div class="export-icon"><i class="fas fa-history"></i></div>
                        <div class="font-semibold">Audit Logs</div>
                        <div class="text-muted" style="font-size: 12px;">Export system audit trail</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('confirmationModal')">Cancel</button>
                <button class="btn" id="confirmationButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Admin Modal -->
    <div class="modal" id="viewAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Details</h3>
                <button class="modal-close" onclick="closeModal('viewAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAdminContent">
                <!-- Admin details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Agent Modal -->
    <div class="modal" id="viewAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agent Details</h3>
                <button class="modal-close" onclick="closeModal('viewAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAgentContent">
                <!-- Agent details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Customer Modal -->
    <div class="modal" id="viewCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('viewCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewCustomerContent">
                <!-- Customer details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Dispute Modal -->
    <div class="modal" id="viewDisputeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dispute Details</h3>
                <button class="modal-close" onclick="closeModal('viewDisputeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewDisputeContent">
                <!-- Dispute details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- JavaScript Implementation -->
    <script>
        // ===== Firebase Configuration =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // Initialize Firebase
        let firebaseApp, auth, db, storage;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            console.log("SUDO: Firebase initialized successfully");
        } catch (error) {
            console.error("SUDO: Firebase initialization error:", error);
            showNotification('Firebase Error', 'Failed to initialize Firebase. Please refresh the page.', 'error');
        }

        // ===== Application State =====
        const AppState = {
            currentUser: null,
            isAuthenticated: false,
            systemStats: {
                totalUsers: 0,
                activeAgents: 0,
                todayTransactions: 0,
                platformRevenue: 0,
                activeSessions: 0,
                userGrowth: 0,
                agentGrowth: 0,
                transactionGrowth: 0,
                revenueGrowth: 0
            },
            auditLogs: [],
            disputes: [],
            featureFlags: {},
            financialSettings: {},
            securitySettings: {},
            uiSettings: {},
            notificationSettings: {},
            repaymentPlans: [],
            currentSection: 'dashboard',
            pagination: {
                admins: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
                agents: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
                customers: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
                disputes: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
                audit: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
                repayment: { currentPage: 1, totalPages: 1, itemsPerPage: 10 }
            }
        };

        // ===== Utility Functions =====
        const Utils = {
            showNotification(title, message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle' :
                            type === 'error' ? 'fa-exclamation-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' :
                            'fa-info-circle'
                        }"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const container = document.getElementById('notificationContainer');
                if (!container) {
                    const newContainer = document.createElement('div');
                    newContainer.id = 'notificationContainer';
                    document.body.appendChild(newContainer);
                }
                
                document.getElementById('notificationContainer').appendChild(notification);
                
                setTimeout(() => notification.classList.add('active'), 10);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.classList.remove('active');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            },

            showLoading(message = 'Processing...') {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                if (loadingOverlay && loadingText) {
                    loadingText.textContent = message;
                    loadingOverlay.classList.add('active');
                }
            },

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('active');
                }
            },

            formatCurrency(amount, currency = 'USD') {
                if (isNaN(amount)) amount = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currency
                }).format(amount);
            },

            formatDate(date) {
                if (!date) return 'Never';
                try {
                    return new Date(date).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },

            formatDateShort(date) {
                if (!date) return 'N/A';
                try {
                    return new Date(date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                } catch (e) {
                    return 'N/A';
                }
            },

            generateId(prefix = '') {
                return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },

            validatePassword(password) {
                return password && password.length >= 6;
            },

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            },

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            },

            confirmAction(title, message, confirmCallback, confirmText = 'Confirm', confirmType = 'primary') {
                const titleEl = document.getElementById('confirmationTitle');
                const messageEl = document.getElementById('confirmationMessage');
                const button = document.getElementById('confirmationButton');
                
                if (titleEl) titleEl.textContent = title;
                if (messageEl) messageEl.textContent = message;
                if (button) {
                    button.textContent = confirmText;
                    button.className = `btn btn-${confirmType}`;
                    
                    // Remove existing event listeners
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    newButton.onclick = () => {
                        confirmCallback();
                        this.closeModal('confirmationModal');
                    };
                }
                
                this.openModal('confirmationModal');
            },

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            deepClone(obj) {
                return JSON.parse(JSON.stringify(obj));
            },

            calculatePercentageChange(oldValue, newValue) {
                if (oldValue === 0) return newValue > 0 ? 100 : 0;
                return ((newValue - oldValue) / oldValue * 100).toFixed(1);
            }
        };

        // ===== Firebase Service =====
        const FirebaseService = {
            async checkSudoAccess() {
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const user = auth.currentUser;
                    console.log("Current user:", user);
                    
                    if (!user) {
                        console.log("No user found, redirecting to login");
                        window.location.href = 'login.html';
                        return false;
                    }
                    
                    console.log("User email:", user.email);
                    
                    const allowedEmails = ['sudo@gmail.com', 'admin@trucash.com', 'admin@gmail.com'];
                    
                    if (!allowedEmails.includes(user.email.toLowerCase())) {
                        console.log("Email not in allowed list, checking database...");
                        
                        const userRef = db.ref('users/' + user.uid);
                        const snapshot = await userRef.once('value');
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            console.log("User data from DB:", userData);
                            
                            if (userData.userType === 'sudo' || userData.role === 'super_admin') {
                                console.log("User has sudo role, allowing access");
                                AppState.currentUser = user;
                                AppState.isAuthenticated = true;
                                
                                // Update UI with user info
                                const avatar = document.getElementById('userAvatar');
                                const name = document.getElementById('userName');
                                const role = document.getElementById('userRole');
                                
                                if (avatar) avatar.textContent = userData.fullName ? userData.fullName.charAt(0).toUpperCase() : 'SU';
                                if (name) name.textContent = userData.fullName || 'SUDO Admin';
                                if (role) role.textContent = userData.role ? userData.role.replace('_', ' ').toUpperCase() : 'Full System Control';
                                
                                return true;
                            }
                        }
                        
                        Utils.showNotification('Access Denied', 'Only SUDO admin can access this page.', 'error');
                        setTimeout(() => window.location.href = 'admin.html', 2000);
                        return false;
                    }
                    
                    AppState.currentUser = user;
                    AppState.isAuthenticated = true;
                    console.log("Access granted to:", user.email);
                    return true;
                } catch (error) {
                    console.error('SUDO: Authentication error:', error);
                    window.location.href = 'login.html';
                    return false;
                }
            },

            async loadSystemStats() {
                try {
                    // Load total users
                    const usersRef = db.ref('users');
                    usersRef.once('value').then(snapshot => {
                        const users = snapshot.val() || {};
                        const totalUsers = Object.keys(users).length;
                        AppState.systemStats.totalUsers = totalUsers;
                        document.getElementById('totalUsers').textContent = totalUsers;
                        
                        // Calculate growth (simplified)
                        const growth = Math.floor(Math.random() * 20) + 5;
                        AppState.systemStats.userGrowth = growth;
                        document.getElementById('userGrowth').textContent = `${growth}%`;
                    });

                    // Load active agents
                    const agentsRef = db.ref('agents');
                    agentsRef.once('value').then(snapshot => {
                        const agents = snapshot.val() || {};
                        const activeAgents = Object.values(agents).filter(agent => agent.status === 'active').length;
                        AppState.systemStats.activeAgents = activeAgents;
                        document.getElementById('activeAgents').textContent = activeAgents;
                        
                        const growth = Math.floor(Math.random() * 15) + 3;
                        AppState.systemStats.agentGrowth = growth;
                        document.getElementById('agentGrowth').textContent = `${growth}%`;
                    });

                    // Load today's transactions
                    const today = new Date().toISOString().split('T')[0];
                    const transactionsRef = db.ref('transactions');
                    transactionsRef.once('value').then(snapshot => {
                        const transactions = snapshot.val() || {};
                        const todayCount = Object.values(transactions).filter(t => 
                            t.timestamp && new Date(t.timestamp).toISOString().split('T')[0] === today
                        ).length;
                        
                        AppState.systemStats.todayTransactions = todayCount;
                        document.getElementById('todayTransactions').textContent = todayCount;
                        
                        const growth = Math.floor(Math.random() * 25) + 8;
                        AppState.systemStats.transactionGrowth = growth;
                        document.getElementById('transactionGrowth').textContent = `${growth}%`;
                    });

                    // Load platform revenue
                    const revenueRef = db.ref('systemStats/revenue');
                    revenueRef.once('value').then(snapshot => {
                        const revenue = snapshot.val() || 0;
                        AppState.systemStats.platformRevenue = revenue;
                        document.getElementById('platformRevenue').textContent = Utils.formatCurrency(revenue);
                        
                        const growth = Math.floor(Math.random() * 30) + 10;
                        AppState.systemStats.revenueGrowth = growth;
                        document.getElementById('revenueGrowth').textContent = `${growth}%`;
                    });

                    // Load active sessions
                    const sessionsRef = db.ref('activeSessions');
                    sessionsRef.once('value').then(snapshot => {
                        const sessions = snapshot.val() || {};
                        AppState.systemStats.activeSessions = Object.keys(sessions).length;
                        document.getElementById('activeSessions').textContent = AppState.systemStats.activeSessions;
                    });

                    // Update system health indicators
                    document.getElementById('dbStatus').textContent = 'Connected';
                    document.getElementById('authStatus').textContent = 'Online';
                    document.getElementById('apiResponseTime').textContent = `${Math.floor(Math.random() * 50) + 20}ms`;

                } catch (error) {
                    console.error('SUDO: Error loading system stats:', error);
                    document.getElementById('dbStatus').textContent = 'Disconnected';
                    document.getElementById('authStatus').textContent = 'Offline';
                }
            },

            async loadAdmins(page = 1, searchTerm = '', statusFilter = 'all') {
                try {
                    Utils.showLoading('Loading admins...');
                    const adminsRef = db.ref('users');
                    const snapshot = await adminsRef.once('value');
                    const admins = snapshot.val() || {};
                    
                    // Filter admins
                    let adminList = Object.entries(admins)
                        .filter(([userId, admin]) => 
                            admin.userType === 'admin' &&
                            (statusFilter === 'all' || admin.status === statusFilter) &&
                            (searchTerm === '' || 
                             (admin.fullName && admin.fullName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (admin.email && admin.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (admin.adminId && admin.adminId.toLowerCase().includes(searchTerm.toLowerCase())))
                        )
                        .map(([userId, admin]) => ({ userId, ...admin }));
                    
                    // Sort by creation date
                    adminList.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    // Pagination
                    const itemsPerPage = AppState.pagination.admins.itemsPerPage;
                    const totalPages = Math.ceil(adminList.length / itemsPerPage);
                    AppState.pagination.admins.totalPages = totalPages;
                    AppState.pagination.admins.currentPage = page;
                    
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedAdmins = adminList.slice(startIndex, endIndex);
                    
                    // Update table
                    const tableBody = document.getElementById('adminsTableBody');
                    tableBody.innerHTML = '';
                    
                    paginatedAdmins.forEach(admin => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${admin.adminId || admin.userId.substring(0, 8)}</td>
                            <td>${admin.fullName || 'N/A'}</td>
                            <td>${admin.email || 'N/A'}</td>
                            <td><span class="role-badge">${admin.role || 'Admin'}</span></td>
                            <td><span class="status-badge status-${admin.status || 'active'}">${admin.status || 'Active'}</span></td>
                            <td>${Utils.formatDate(admin.lastLogin)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="viewAdminDetails('${admin.userId}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="editAdmin('${admin.userId}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${admin.status === 'active' ? `
                                        <button class="btn btn-sm btn-outline" onclick="suspendAdmin('${admin.userId}')" title="Suspend">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-outline" onclick="reactivateAdmin('${admin.userId}')" title="Reactivate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${admin.userId}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update pagination
                    this.updatePagination('admins', totalPages, page);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('SUDO: Error loading admins:', error);
                    Utils.showNotification('Error', 'Failed to load admin accounts', 'error');
                    Utils.hideLoading();
                }
            },

            async loadAgents(page = 1, searchTerm = '', statusFilter = 'all') {
                try {
                    Utils.showLoading('Loading agents...');
                    const agentsRef = db.ref('agents');
                    const snapshot = await agentsRef.once('value');
                    const agents = snapshot.val() || {};
                    
                    // Filter agents
                    let agentList = Object.entries(agents)
                        .filter(([agentId, agent]) => 
                            (statusFilter === 'all' || agent.status === statusFilter) &&
                            (searchTerm === '' || 
                             (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (agent.email && agent.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (agent.phone && agent.phone.includes(searchTerm)))
                        )
                        .map(([agentId, agent]) => ({ agentId, ...agent }));
                    
                    // Sort by creation date
                    agentList.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    // Pagination
                    const itemsPerPage = AppState.pagination.agents.itemsPerPage;
                    const totalPages = Math.ceil(agentList.length / itemsPerPage);
                    AppState.pagination.agents.totalPages = totalPages;
                    AppState.pagination.agents.currentPage = page;
                    
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedAgents = agentList.slice(startIndex, endIndex);
                    
                    // Update table
                    const tableBody = document.getElementById('agentsTableBody');
                    tableBody.innerHTML = '';
                    
                    paginatedAgents.forEach(agent => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${agent.agentId || 'N/A'}</td>
                            <td>${agent.fullName || 'N/A'}</td>
                            <td>${agent.email || 'N/A'}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agent.totalClients || 0}</td>
                            <td><span class="status-badge status-${agent.status || 'active'}">${agent.status || 'Active'}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="viewAgentDetails('${agent.agentId || agent.userId}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="editAgent('${agent.agentId || agent.userId}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${agent.status === 'active' ? `
                                        <button class="btn btn-sm btn-outline" onclick="suspendAgent('${agent.agentId || agent.userId}')" title="Suspend">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-outline" onclick="reactivateAgent('${agent.agentId || agent.userId}')" title="Reactivate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-sm btn-danger" onclick="deleteAgent('${agent.agentId || agent.userId}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update pagination
                    this.updatePagination('agents', totalPages, page);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('SUDO: Error loading agents:', error);
                    Utils.showNotification('Error', 'Failed to load agent accounts', 'error');
                    Utils.hideLoading();
                }
            },

            async loadCustomers(page = 1, searchTerm = '', statusFilter = 'all') {
                try {
                    Utils.showLoading('Loading customers...');
                    const customersRef = db.ref('users');
                    const snapshot = await customersRef.once('value');
                    const users = snapshot.val() || {};
                    
                    // Filter customers
                    let customerList = Object.entries(users)
                        .filter(([userId, user]) => 
                            user.userType === 'customer' &&
                            (statusFilter === 'all' || user.status === statusFilter) &&
                            (searchTerm === '' || 
                             (user.fullName && user.fullName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (user.userId && user.userId.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (user.phone && user.phone.includes(searchTerm)))
                        )
                        .map(([userId, user]) => ({ userId, ...user }));
                    
                    // Sort by creation date
                    customerList.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    // Pagination
                    const itemsPerPage = AppState.pagination.customers.itemsPerPage;
                    const totalPages = Math.ceil(customerList.length / itemsPerPage);
                    AppState.pagination.customers.totalPages = totalPages;
                    AppState.pagination.customers.currentPage = page;
                    
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedCustomers = customerList.slice(startIndex, endIndex);
                    
                    // Update table
                    const tableBody = document.getElementById('customersTableBody');
                    tableBody.innerHTML = '';
                    
                    paginatedCustomers.forEach(customer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.userId.substring(0, 8)}</td>
                            <td>${customer.fullName || 'N/A'}</td>
                            <td>${customer.email || 'N/A'}</td>
                            <td>${customer.phone || 'N/A'}</td>
                            <td><span class="status-badge ${customer.verified ? 'status-active' : 'status-pending'}">${customer.verified ? 'Verified' : 'Pending'}</span></td>
                            <td><span class="status-badge status-${customer.status || 'active'}">${customer.status || 'Active'}</span></td>
                            <td>${Utils.formatCurrency(customer.loanLimit || 0)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="viewCustomerDetails('${customer.userId}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="editCustomer('${customer.userId}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${customer.status === 'active' ? `
                                        <button class="btn btn-sm btn-outline" onclick="suspendCustomer('${customer.userId}')" title="Suspend">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-outline" onclick="reactivateCustomer('${customer.userId}')" title="Reactivate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-sm btn-outline" onclick="adjustCustomerLimit('${customer.userId}')" title="Adjust Limit">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update pagination
                    this.updatePagination('customers', totalPages, page);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('SUDO: Error loading customers:', error);
                    Utils.showNotification('Error', 'Failed to load customer accounts', 'error');
                    Utils.hideLoading();
                }
            },

            async loadFeatureFlags() {
                try {
                    const flagsRef = db.ref('systemSettings/featureFlags');
                    const snapshot = await flagsRef.once('value');
                    AppState.featureFlags = snapshot.val() || {};
                    
                    // Update toggle switches
                    Object.entries(AppState.featureFlags).forEach(([feature, value]) => {
                        const toggle = document.querySelector(`[data-feature="${feature}"]`);
                        if (toggle) {
                            toggle.checked = value;
                        }
                    });
                    
                    // Update JSON editor
                    const editor = document.getElementById('featureJsonEditor');
                    if (editor) {
                        editor.textContent = JSON.stringify(AppState.featureFlags, null, 2);
                    }
                    
                } catch (error) {
                    console.error('SUDO: Error loading feature flags:', error);
                    // Set default feature flags
                    AppState.featureFlags = {
                        loan_applications: true,
                        online_repayments: true,
                        collateral_upload: true,
                        client_verification: true,
                        loan_processing: true,
                        commission_tracking: true,
                        maintenance_mode: false,
                        new_registrations: true,
                        audit_logging: true
                    };
                }
            },

            async updateFeatureFlags(flags) {
                try {
                    await db.ref('systemSettings/featureFlags').set(flags);
                    AppState.featureFlags = flags;
                    await this.logAudit({
                        action: 'update_feature_flags',
                        details: 'Updated system feature flags',
                        performedBy: AppState.currentUser.uid
                    });
                    return { success: true };
                } catch (error) {
                    console.error('SUDO: Error updating feature flags:', error);
                    return { success: false, error: error.message };
                }
            },

            async loadFinancialSettings() {
                try {
                    const settingsRef = db.ref('systemSettings/financial');
                    const snapshot = await settingsRef.once('value');
                    AppState.financialSettings = snapshot.val() || {};
                    
                    // Set default values if empty
                    if (Object.keys(AppState.financialSettings).length === 0) {
                        AppState.financialSettings = {
                            minLoanAmount: 100,
                            maxLoanAmount: 10000,
                            dailyTransactionLimit: 5000,
                            serviceCharge: 2.5,
                            agentCommission: 5.0,
                            latePaymentFee: 1.5,
                            autoApprovalLimit: 1000,
                            manualReviewThreshold: 5000,
                            riskThreshold: 70,
                            defaultCurrency: 'USD',
                            decimalPlaces: 2,
                            currencyFormat: 'symbol_before'
                        };
                    }
                    
                    // Update form fields
                    Object.keys(AppState.financialSettings).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = AppState.financialSettings[key];
                        }
                    });
                    
                } catch (error) {
                    console.error('SUDO: Error loading financial settings:', error);
                }
            },

            async saveFinancialSettings(settings) {
                try {
                    await db.ref('systemSettings/financial').set(settings);
                    AppState.financialSettings = settings;
                    await this.logAudit({
                        action: 'update_financial_settings',
                        details: 'Updated financial system settings',
                        performedBy: AppState.currentUser.uid
                    });
                    return { success: true };
                } catch (error) {
                    console.error('SUDO: Error saving financial settings:', error);
                    return { success: false, error: error.message };
                }
            },

            async loadAuditLogs(page = 1, filters = {}) {
                try {
                    Utils.showLoading('Loading audit logs...');
                    const logsRef = db.ref('auditLogs');
                    const snapshot = await logsRef.once('value');
                    const logs = snapshot.val() || {};
                    
                    // Convert to array and sort by timestamp
                    let logsArray = Object.entries(logs)
                        .map(([id, log]) => ({ id, ...log }))
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Apply filters
                    if (filters.userType && filters.userType !== 'all') {
                        logsArray = logsArray.filter(log => log.userType === filters.userType);
                    }
                    
                    if (filters.actionType && filters.actionType !== 'all') {
                        logsArray = logsArray.filter(log => log.action === filters.actionType);
                    }
                    
                    if (filters.dateFrom) {
                        const fromDate = new Date(filters.dateFrom).getTime();
                        logsArray = logsArray.filter(log => log.timestamp >= fromDate);
                    }
                    
                    if (filters.dateTo) {
                        const toDate = new Date(filters.dateTo).getTime();
                        logsArray = logsArray.filter(log => log.timestamp <= toDate);
                    }
                    
                    // Pagination
                    const itemsPerPage = AppState.pagination.audit.itemsPerPage;
                    const totalPages = Math.ceil(logsArray.length / itemsPerPage);
                    AppState.pagination.audit.totalPages = totalPages;
                    AppState.pagination.audit.currentPage = page;
                    
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedLogs = logsArray.slice(startIndex, endIndex);
                    
                    // Update table
                    const tableBody = document.getElementById('auditLogsBody');
                    tableBody.innerHTML = '';
                    
                    paginatedLogs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td><span class="role-badge">${log.userType || 'system'}</span></td>
                            <td>${log.userId ? log.userId.substring(0, 8) : 'SYSTEM'}</td>
                            <td>${log.action || 'N/A'}</td>
                            <td>${log.details || 'N/A'}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                            <td><span class="status-badge status-active">Completed</span></td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update badge
                    document.getElementById('auditBadge').textContent = logsArray.length;
                    
                    // Update pagination
                    this.updatePagination('audit', totalPages, page);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('SUDO: Error loading audit logs:', error);
                    Utils.hideLoading();
                }
            },

            async logAudit(logData) {
                try {
                    const logId = Utils.generateId('AUDIT_');
                    const fullLog = {
                        ...logData,
                        timestamp: Date.now(),
                        userType: 'sudo',
                        ipAddress: await this.getClientIP()
                    };
                    
                    await db.ref(`auditLogs/${logId}`).set(fullLog);
                } catch (error) {
                    console.error('SUDO: Error logging audit:', error);
                }
            },

            async getClientIP() {
                // Simplified IP detection
                return '127.0.0.1';
            },

            async loadDisputes(page = 1, searchTerm = '', statusFilter = 'all') {
                try {
                    Utils.showLoading('Loading disputes...');
                    const disputesRef = db.ref('disputes');
                    const snapshot = await disputesRef.once('value');
                    const disputes = snapshot.val() || {};
                    
                    // Convert to array
                    let disputeList = Object.entries(disputes)
                        .map(([id, dispute]) => ({ id, ...dispute }))
                        .filter(dispute => 
                            (statusFilter === 'all' || dispute.status === statusFilter) &&
                            (searchTerm === '' || 
                             (dispute.customerName && dispute.customerName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (dispute.agentName && dispute.agentName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                             (dispute.id && dispute.id.toLowerCase().includes(searchTerm.toLowerCase())))
                        )
                        .sort((a, b) => b.createdAt - a.createdAt);
                    
                    // Update badge
                    document.getElementById('disputeBadge').textContent = disputeList.length;
                    
                    // Pagination
                    const itemsPerPage = AppState.pagination.disputes.itemsPerPage;
                    const totalPages = Math.ceil(disputeList.length / itemsPerPage);
                    AppState.pagination.disputes.totalPages = totalPages;
                    AppState.pagination.disputes.currentPage = page;
                    
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedDisputes = disputeList.slice(startIndex, endIndex);
                    
                    // Update table
                    const tableBody = document.getElementById('disputesTableBody');
                    tableBody.innerHTML = '';
                    
                    paginatedDisputes.forEach(dispute => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${dispute.id.substring(0, 8)}</td>
                            <td>${dispute.type || 'N/A'}</td>
                            <td>${dispute.customerName || 'N/A'}</td>
                            <td>${dispute.agentName || 'N/A'}</td>
                            <td>${Utils.formatCurrency(dispute.amount || 0)}</td>
                            <td><span class="status-badge ${dispute.severity === 'high' ? 'status-banned' : dispute.severity === 'medium' ? 'status-suspended' : 'status-pending'}">${dispute.severity || 'low'}</span></td>
                            <td><span class="status-badge ${dispute.status === 'resolved' ? 'status-active' : dispute.status === 'in_progress' ? 'status-pending' : 'status-suspended'}">${dispute.status || 'open'}</span></td>
                            <td>${Utils.formatDateShort(dispute.createdAt)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="viewDisputeDetails('${dispute.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="resolveDispute('${dispute.id}')" title="Resolve">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="escalateDispute('${dispute.id}')" title="Escalate">
                                        <i class="fas fa-level-up-alt"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update pagination
                    this.updatePagination('disputes', totalPages, page);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('SUDO: Error loading disputes:', error);
                    Utils.hideLoading();
                }
            },

            async loadRepaymentPlans(page = 1, searchTerm = '') {
                try {
                    Utils.showLoading('Loading repayment plans...');
                    const plansRef = db.ref('repaymentPlans');
                    const snapshot = await plansRef.once('value');
                    const plans = snapshot.val() || {};
                    
                    // Convert to array
                    let planList = Object.entries(plans)
                        .map(([id, plan]) => ({ id, ...plan }))
                        .filter(plan => 
                            searchTerm === '' || 
                            (plan.name && plan.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (plan.id && plan.id.toLowerCase().includes(searchTerm.toLowerCase()))
                        )
                        .sort((a, b) => b.createdAt - a.createdAt);
                    
                    // Pagination
                    const itemsPerPage = AppState.pagination.repayment.itemsPerPage;
                    const totalPages = Math.ceil(planList.length / itemsPerPage);
                    AppState.pagination.repayment.totalPages = totalPages;
                    AppState.pagination.repayment.currentPage = page;
                    
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedPlans = planList.slice(startIndex, endIndex);
                    
                    // Update table
                    const tableBody = document.getElementById('repaymentPlansBody');
                    tableBody.innerHTML = '';
                    
                    paginatedPlans.forEach(plan => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${plan.id.substring(0, 8)}</td>
                            <td>${plan.name || 'N/A'}</td>
                            <td>${plan.duration || 0} months</td>
                            <td>${plan.interestRate || 0}%</td>
                            <td>${plan.installments || 0}</td>
                            <td><span class="status-badge ${plan.active ? 'status-active' : 'status-inactive'}">${plan.active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="editRepaymentPlan('${plan.id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${plan.active ? `
                                        <button class="btn btn-sm btn-outline" onclick="deactivateRepaymentPlan('${plan.id}')" title="Deactivate">
                                            <i class="fas fa-toggle-off"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-outline" onclick="activateRepaymentPlan('${plan.id}')" title="Activate">
                                            <i class="fas fa-toggle-on"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-sm btn-danger" onclick="deleteRepaymentPlan('${plan.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update pagination
                    this.updatePagination('repayment', totalPages, page);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('SUDO: Error loading repayment plans:', error);
                    Utils.hideLoading();
                }
            },

            async createAdmin(adminData) {
                try {
                    // Create Firebase Auth user
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        adminData.email,
                        adminData.password
                    );
                    
                    // Generate admin ID
                    const adminId = 'ADM' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
                    
                    // Prepare admin document
                    const adminDoc = {
                        uid: userCredential.user.uid,
                        adminId: adminId,
                        fullName: adminData.fullName,
                        email: adminData.email,
                        role: adminData.role,
                        permissions: adminData.permissions,
                        userType: 'admin',
                        status: 'active',
                        createdAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        lastLogin: null
                    };
                    
                    // Save to database
                    await db.ref(`users/${userCredential.user.uid}`).set(adminDoc);
                    
                    // Log audit trail
                    await this.logAudit({
                        action: 'create_admin',
                        userId: userCredential.user.uid,
                        details: `Created admin account for ${adminData.email}`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true, adminId, userId: userCredential.user.uid };
                } catch (error) {
                    console.error('SUDO: Error creating admin:', error);
                    return { success: false, error: error.message };
                }
            },

            async createAgent(agentData) {
                try {
                    // Create Firebase Auth user
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    // Generate agent ID
                    const agentId = 'AGT' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: userCredential.user.uid,
                        agentId: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        commissionRate: agentData.commissionRate || 5.0,
                        userType: 'agent',
                        status: agentData.initialStatus || 'active',
                        createdAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        totalClients: 0,
                        totalLoans: 0,
                        commissionEarned: 0,
                        lastLogin: null
                    };
                    
                    // Save to database
                    await db.ref(`users/${userCredential.user.uid}`).set(agentDoc);
                    await db.ref(`agents/${userCredential.user.uid}`).set(agentDoc);
                    
                    // Log audit trail
                    await this.logAudit({
                        action: 'create_agent',
                        userId: userCredential.user.uid,
                        details: `Created agent account for ${agentData.email} (ID: ${agentId})`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true, agentId, userId: userCredential.user.uid };
                } catch (error) {
                    console.error('SUDO: Error creating agent:', error);
                    return { success: false, error: error.message };
                }
            },

            async suspendUser(userId, userType) {
                try {
                    await db.ref(`users/${userId}`).update({
                        status: 'suspended',
                        suspendedAt: Date.now(),
                        suspendedBy: AppState.currentUser.uid
                    });
                    
                    await this.logAudit({
                        action: 'suspend_user',
                        userId: userId,
                        details: `Suspended ${userType} account`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error(`SUDO: Error suspending ${userType}:`, error);
                    return { success: false, error: error.message };
                }
            },

            async reactivateUser(userId, userType) {
                try {
                    await db.ref(`users/${userId}`).update({
                        status: 'active',
                        reactivatedAt: Date.now(),
                        reactivatedBy: AppState.currentUser.uid
                    });
                    
                    await this.logAudit({
                        action: 'reactivate_user',
                        userId: userId,
                        details: `Reactivated ${userType} account`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error(`SUDO: Error reactivating ${userType}:`, error);
                    return { success: false, error: error.message };
                }
            },

            async deleteUser(userId, userType) {
                try {
                    // Get user data before deletion
                    const userSnapshot = await db.ref(`users/${userId}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (!userData) {
                        return { success: false, error: 'User not found' };
                    }
                    
                    // Mark as deleted (soft delete)
                    await db.ref(`users/${userId}`).update({
                        status: 'deleted',
                        deletedAt: Date.now(),
                        deletedBy: AppState.currentUser.uid,
                        email: `deleted_${Date.now()}_${userData.email}`
                    });
                    
                    // Also update in agents collection if applicable
                    if (userType === 'agent') {
                        await db.ref(`agents/${userId}`).update({
                            status: 'deleted',
                            deletedAt: Date.now()
                        });
                    }
                    
                    await this.logAudit({
                        action: 'delete_user',
                        userId: userId,
                        details: `Deleted ${userType} account: ${userData.email}`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error(`SUDO: Error deleting ${userType}:`, error);
                    return { success: false, error: error.message };
                }
            },

            async getUserDetails(userId) {
                try {
                    const userRef = db.ref(`users/${userId}`);
                    const snapshot = await userRef.once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error('SUDO: Error getting user details:', error);
                    return null;
                }
            },

            async getAgentDetails(agentId) {
                try {
                    const agentRef = db.ref(`agents/${agentId}`);
                    const snapshot = await agentRef.once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error('SUDO: Error getting agent details:', error);
                    return null;
                }
            },

            async updatePagination(type, totalPages, currentPage) {
                const paginationEl = document.getElementById(`${type}Pagination`);
                if (!paginationEl) return;
                
                paginationEl.innerHTML = '';
                
                if (totalPages <= 1) return;
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.onclick = currentPage > 1 ? () => this.changePage(type, currentPage - 1) : null;
                paginationEl.appendChild(prevBtn);
                
                // Page numbers
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => this.changePage(type, i);
                    paginationEl.appendChild(pageBtn);
                }
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.onclick = currentPage < totalPages ? () => this.changePage(type, currentPage + 1) : null;
                paginationEl.appendChild(nextBtn);
            },

            changePage(type, page) {
                if (page < 1 || page > AppState.pagination[type].totalPages) return;
                
                AppState.pagination[type].currentPage = page;
                
                switch (type) {
                    case 'admins':
                        const adminSearch = document.getElementById('adminSearch')?.value || '';
                        this.loadAdmins(page, adminSearch);
                        break;
                    case 'agents':
                        const agentSearch = document.getElementById('agentSearch')?.value || '';
                        const agentStatus = document.getElementById('agentStatusFilter')?.value || 'all';
                        this.loadAgents(page, agentSearch, agentStatus);
                        break;
                    case 'customers':
                        const customerSearch = document.getElementById('customerSearch')?.value || '';
                        const customerStatus = document.getElementById('customerStatusFilter')?.value || 'all';
                        this.loadCustomers(page, customerSearch, customerStatus);
                        break;
                    case 'disputes':
                        const disputeSearch = document.getElementById('disputeSearch')?.value || '';
                        const disputeStatus = document.getElementById('disputeStatusFilter')?.value || 'all';
                        this.loadDisputes(page, disputeSearch, disputeStatus);
                        break;
                    case 'audit':
                        const filters = this.getAuditFilters();
                        this.loadAuditLogs(page, filters);
                        break;
                    case 'repayment':
                        const repaymentSearch = document.getElementById('repaymentPlanSearch')?.value || '';
                        this.loadRepaymentPlans(page, repaymentSearch);
                        break;
                }
            },

            getAuditFilters() {
                return {
                    userType: document.getElementById('auditUserType')?.value || 'all',
                    actionType: document.getElementById('auditActionType')?.value || 'all',
                    dateFrom: document.getElementById('auditDateFrom')?.value || '',
                    dateTo: document.getElementById('auditDateTo')?.value || ''
                };
            },

            async logout() {
                try {
                    await auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('SUDO: Error logging out:', error);
                }
            },

            async exportData(dataType, format = 'json', dateRange = {}) {
                try {
                    Utils.showLoading(`Exporting ${dataType} data...`);
                    
                    let data = {};
                    let filename = '';
                    
                    switch (dataType) {
                        case 'users':
                            const usersSnapshot = await db.ref('users').once('value');
                            data = usersSnapshot.val() || {};
                            filename = `users_export_${new Date().toISOString().split('T')[0]}`;
                            break;
                            
                        case 'transactions':
                            const transactionsSnapshot = await db.ref('transactions').once('value');
                            data = transactionsSnapshot.val() || {};
                            filename = `transactions_export_${new Date().toISOString().split('T')[0]}`;
                            break;
                            
                        case 'loans':
                            const loansSnapshot = await db.ref('loans').once('value');
                            data = loansSnapshot.val() || {};
                            filename = `loans_export_${new Date().toISOString().split('T')[0]}`;
                            break;
                            
                        case 'audit':
                            const auditSnapshot = await db.ref('auditLogs').once('value');
                            data = auditSnapshot.val() || {};
                            filename = `audit_logs_export_${new Date().toISOString().split('T')[0]}`;
                            break;
                            
                        case 'all_data':
                            const allData = {};
                            const refs = ['users', 'transactions', 'loans', 'auditLogs', 'agents', 'systemSettings'];
                            for (const ref of refs) {
                                const snapshot = await db.ref(ref).once('value');
                                allData[ref] = snapshot.val() || {};
                            }
                            data = allData;
                            filename = `full_export_${new Date().toISOString().split('T')[0]}`;
                            break;
                    }
                    
                    // Apply date range filter if provided
                    if (dateRange.from && dateRange.to) {
                        const filteredData = {};
                        Object.entries(data).forEach(([key, value]) => {
                            if (value.timestamp) {
                                const itemDate = new Date(value.timestamp);
                                const fromDate = new Date(dateRange.from);
                                const toDate = new Date(dateRange.to);
                                
                                if (itemDate >= fromDate && itemDate <= toDate) {
                                    filteredData[key] = value;
                                }
                            } else {
                                filteredData[key] = value;
                            }
                        });
                        data = filteredData;
                    }
                    
                    // Convert to desired format
                    let exportContent = '';
                    let mimeType = '';
                    
                    if (format === 'json') {
                        exportContent = JSON.stringify(data, null, 2);
                        mimeType = 'application/json';
                        filename += '.json';
                    } else if (format === 'csv') {
                        // Convert object to CSV
                        const csv = Papa.unparse(Object.values(data));
                        exportContent = csv;
                        mimeType = 'text/csv';
                        filename += '.csv';
                    }
                    
                    // Create download link
                    const blob = new Blob([exportContent], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Log export
                    await this.logAudit({
                        action: 'export_data',
                        details: `Exported ${dataType} data in ${format} format`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('Success', `Data exported successfully: ${filename}`, 'success');
                    
                } catch (error) {
                    console.error('SUDO: Error exporting data:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to export data', 'error');
                }
            },

            async processManualAdjustment(adjustmentData) {
                try {
                    const adjustmentId = Utils.generateId('ADJ_');
                    
                    // Save adjustment record
                    await db.ref(`manualAdjustments/${adjustmentId}`).set({
                        ...adjustmentData,
                        timestamp: Date.now(),
                        performedBy: AppState.currentUser.uid,
                        status: 'completed'
                    });
                    
                    // Update user balance if applicable
                    if (adjustmentData.userId && adjustmentData.amount) {
                        const userRef = db.ref(`users/${adjustmentData.userId}/balance`);
                        const snapshot = await userRef.once('value');
                        const currentBalance = snapshot.val() || 0;
                        
                        let newBalance = currentBalance;
                        switch (adjustmentData.type) {
                            case 'add':
                                newBalance = currentBalance + adjustmentData.amount;
                                break;
                            case 'deduct':
                                newBalance = Math.max(0, currentBalance - adjustmentData.amount);
                                break;
                            case 'set':
                                newBalance = adjustmentData.amount;
                                break;
                        }
                        
                        await userRef.set(newBalance);
                    }
                    
                    // Log audit
                    await this.logAudit({
                        action: 'manual_adjustment',
                        userId: adjustmentData.userId,
                        details: `Manual adjustment: ${adjustmentData.reason} (Amount: ${adjustmentData.amount})`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true, adjustmentId };
                } catch (error) {
                    console.error('SUDO: Error processing manual adjustment:', error);
                    return { success: false, error: error.message };
                }
            },

            async createRepaymentPlan(planData) {
                try {
                    const planId = Utils.generateId('PLAN_');
                    
                    const planDoc = {
                        id: planId,
                        ...planData,
                        createdAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        active: true
                    };
                    
                    await db.ref(`repaymentPlans/${planId}`).set(planDoc);
                    
                    await this.logAudit({
                        action: 'create_repayment_plan',
                        details: `Created repayment plan: ${planData.name}`,
                        performedBy: AppState.currentUser.uid
                    });
                    
                    return { success: true, planId };
                } catch (error) {
                    console.error('SUDO: Error creating repayment plan:', error);
                    return { success: false, error: error.message };
                }
            },

            async saveNotificationSettings(settings) {
                try {
                    await db.ref('systemSettings/notifications').set(settings);
                    await this.logAudit({
                        action: 'update_notification_settings',
                        details: 'Updated notification system settings',
                        performedBy: AppState.currentUser.uid
                    });
                    return { success: true };
                } catch (error) {
                    console.error('SUDO: Error saving notification settings:', error);
                    return { success: false, error: error.message };
                }
            },

            async saveUISettings(settings) {
                try {
                    await db.ref('systemSettings/ui').set(settings);
                    await this.logAudit({
                        action: 'update_ui_settings',
                        details: 'Updated UI behavior settings',
                        performedBy: AppState.currentUser.uid
                    });
                    return { success: true };
                } catch (error) {
                    console.error('SUDO: Error saving UI settings:', error);
                    return { success: false, error: error.message };
                }
            },

            async saveSecuritySettings(settings) {
                try {
                    await db.ref('systemSettings/security').set(settings);
                    await this.logAudit({
                        action: 'update_security_settings',
                        details: 'Updated security system settings',
                        performedBy: AppState.currentUser.uid
                    });
                    return { success: true };
                } catch (error) {
                    console.error('SUDO: Error saving security settings:', error);
                    return { success: false, error: error.message };
                }
            },

            initRealTimeListeners() {
                // System stats listener
                db.ref('systemStats').on('value', (snapshot) => {
                    const stats = snapshot.val() || {};
                    AppState.systemStats = { ...AppState.systemStats, ...stats };
                    this.updateDashboardStats();
                });

                // Active sessions listener
                db.ref('activeSessions').on('value', (snapshot) => {
                    const sessions = snapshot.val() || {};
                    AppState.systemStats.activeSessions = Object.keys(sessions).length;
                    document.getElementById('activeSessions').textContent = AppState.systemStats.activeSessions;
                });

                // Disputes listener
                db.ref('disputes').on('value', (snapshot) => {
                    const disputes = snapshot.val() || {};
                    AppState.disputes = disputes;
                    document.getElementById('disputeBadge').textContent = Object.keys(disputes).length;
                });

                // Feature flags listener
                db.ref('systemSettings/featureFlags').on('value', (snapshot) => {
                    AppState.featureFlags = snapshot.val() || {};
                    this.updateFeatureFlagToggles();
                });
            },

            updateDashboardStats() {
                const elements = {
                    totalUsers: 'totalUsers',
                    activeAgents: 'activeAgents',
                    todayTransactions: 'todayTransactions',
                    platformRevenue: 'platformRevenue'
                };
                
                Object.entries(elements).forEach(([key, elementId]) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        if (key === 'platformRevenue') {
                            element.textContent = Utils.formatCurrency(AppState.systemStats[key] || 0);
                        } else {
                            element.textContent = AppState.systemStats[key] || 0;
                        }
                    }
                });
            },

            updateFeatureFlagToggles() {
                Object.entries(AppState.featureFlags).forEach(([feature, value]) => {
                    const toggle = document.querySelector(`[data-feature="${feature}"]`);
                    if (toggle) {
                        toggle.checked = value;
                    }
                });
            },

            async uploadToCloudinary(file, folder = 'trucash/documents') {
                return new Promise((resolve, reject) => {
                    // In a real implementation, you would use Cloudinary upload widget
                    // This is a mock implementation
                    setTimeout(() => {
                        resolve({
                            secure_url: `https://res.cloudinary.com/demo/image/upload/v${Date.now()}/${folder}/${file.name}`,
                            public_id: `${folder}/${file.name.split('.')[0]}_${Date.now()}`,
                            format: file.name.split('.').pop()
                        });
                    }, 1000);
                });
            }
        };

        // ===== UI Management =====
        const UIManager = {
            init() {
                this.bindEvents();
                this.initCharts();
                this.setupNavigation();
                this.setupSearchHandlers();
            },

            bindEvents() {
                // Navigation
                document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                    item.addEventListener('click', () => {
                        const section = item.getAttribute('data-section');
                        this.showSection(section);
                    });
                });

                // Logout
                document.querySelector('.nav-item[data-action="logout"]').addEventListener('click', () => {
                    Utils.confirmAction(
                        'Confirm Logout',
                        'Are you sure you want to logout from SUDO control panel?',
                        () => FirebaseService.logout(),
                        'Logout',
                        'danger'
                    );
                });

                // Feature flag toggles
                document.querySelectorAll('[data-feature]').forEach(toggle => {
                    toggle.addEventListener('change', () => {
                        const feature = toggle.getAttribute('data-feature');
                        const value = toggle.checked;
                        this.updateFeatureFlag(feature, value);
                    });
                });

                // Form submissions
                const reversalType = document.getElementById('reversalType');
                if (reversalType) {
                    reversalType.addEventListener('change', (e) => {
                        const partialGroup = document.getElementById('partialAmountGroup');
                        if (partialGroup) {
                            partialGroup.style.display = e.target.value === 'partial' ? 'block' : 'none';
                        }
                    });
                }

                // Manual adjustment modal
                const manualAdjustmentType = document.getElementById('manualAdjustmentType');
                if (manualAdjustmentType) {
                    manualAdjustmentType.addEventListener('change', (e) => {
                        this.loadManualAdjustmentForm(e.target.value);
                    });
                }
            },

            setupSearchHandlers() {
                // Debounced search functions
                const debouncedSearchAdmins = Utils.debounce(searchAdmins, 300);
                const debouncedSearchAgents = Utils.debounce(searchAgents, 300);
                const debouncedSearchCustomers = Utils.debounce(searchCustomers, 300);
                const debouncedSearchDisputes = Utils.debounce(searchDisputes, 300);
                const debouncedSearchRepaymentPlans = Utils.debounce(searchRepaymentPlans, 300);

                // Admin search
                const adminSearch = document.getElementById('adminSearch');
                if (adminSearch) {
                    adminSearch.addEventListener('input', () => debouncedSearchAdmins());
                }

                // Agent search
                const agentSearch = document.getElementById('agentSearch');
                if (agentSearch) {
                    agentSearch.addEventListener('input', () => debouncedSearchAgents());
                }

                // Customer search
                const customerSearch = document.getElementById('customerSearch');
                if (customerSearch) {
                    customerSearch.addEventListener('input', () => debouncedSearchCustomers());
                }

                // Dispute search
                const disputeSearch = document.getElementById('disputeSearch');
                if (disputeSearch) {
                    disputeSearch.addEventListener('input', () => debouncedSearchDisputes());
                }

                // Repayment plan search
                const repaymentSearch = document.getElementById('repaymentPlanSearch');
                if (repaymentSearch) {
                    repaymentSearch.addEventListener('input', () => debouncedSearchRepaymentPlans());
                }
            },

            showSection(sectionId) {
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeNav = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }
                
                // Show section content
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                const activeSection = document.getElementById(sectionId);
                if (activeSection) {
                    activeSection.classList.add('active');
                    AppState.currentSection = sectionId;
                    
                    // Load section-specific data
                    this.loadSectionData(sectionId);
                }
            },

            loadSectionData(sectionId) {
                switch (sectionId) {
                    case 'dashboard':
                        FirebaseService.loadSystemStats();
                        break;
                    case 'admins':
                        FirebaseService.loadAdmins();
                        break;
                    case 'agents':
                        FirebaseService.loadAgents();
                        break;
                    case 'customers':
                        FirebaseService.loadCustomers();
                        break;
                    case 'features':
                        FirebaseService.loadFeatureFlags();
                        break;
                    case 'financial':
                        FirebaseService.loadFinancialSettings();
                        break;
                    case 'repayment':
                        FirebaseService.loadRepaymentPlans();
                        break;
                    case 'audit':
                        FirebaseService.loadAuditLogs();
                        break;
                    case 'disputes':
                        FirebaseService.loadDisputes();
                        break;
                    case 'backup':
                        this.loadBackupHistory();
                        break;
                }
            },

            setupNavigation() {
                // Default to dashboard
                this.showSection('dashboard');
            },

            initCharts() {
                // Activity Chart
                const activityCtx = document.getElementById('activityChart');
                if (activityCtx) {
                    new Chart(activityCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM', '12AM'],
                            datasets: [{
                                label: 'System Activity',
                                data: [12, 19, 3, 5, 2, 3, 15],
                                borderColor: 'rgba(0, 122, 255, 1)',
                                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                // User Growth Chart
                const userGrowthCtx = document.getElementById('userGrowthChart');
                if (userGrowthCtx) {
                    new Chart(userGrowthCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'New Users',
                                data: [65, 59, 80, 81, 56, 55],
                                backgroundColor: 'rgba(52, 199, 89, 0.6)'
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                }

                // Transaction Volume Chart
                const transactionCtx = document.getElementById('transactionVolumeChart');
                if (transactionCtx) {
                    new Chart(transactionCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            datasets: [{
                                label: 'Transaction Volume',
                                data: [45000, 52000, 48000, 61000],
                                borderColor: 'rgba(255, 149, 0, 1)',
                                backgroundColor: 'rgba(255, 149, 0, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                }

                // Revenue Chart
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx) {
                    new Chart(revenueCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['Loan Interest', 'Service Fees', 'Late Fees', 'Other'],
                            datasets: [{
                                data: [45, 30, 15, 10],
                                backgroundColor: [
                                    'rgba(0, 122, 255, 0.8)',
                                    'rgba(52, 199, 89, 0.8)',
                                    'rgba(255, 59, 48, 0.8)',
                                    'rgba(255, 149, 0, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                }
            },

            async updateFeatureFlag(feature, value) {
                try {
                    const updatedFlags = { ...AppState.featureFlags, [feature]: value };
                    const result = await FirebaseService.updateFeatureFlags(updatedFlags);
                    
                    if (result.success) {
                        Utils.showNotification('Feature Updated', `Feature "${feature}" ${value ? 'enabled' : 'disabled'}`, 'success');
                    }
                } catch (error) {
                    Utils.showNotification('Error', 'Failed to update feature flag', 'error');
                }
            },

            loadManualAdjustmentForm(type) {
                const contentEl = document.getElementById('manualAdjustmentContent');
                if (!contentEl) return;

                let formHtml = '';

                switch (type) {
                    case 'balance':
                        formHtml = `
                            <div class="form-group">
                                <label class="form-label">User Type</label>
                                <select class="form-control" id="adjUserType">
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User ID/Email</label>
                                <input type="text" class="form-control" id="adjUserId" placeholder="Enter user ID or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjType">
                                    <option value="add">Add Funds</option>
                                    <option value="deduct">Deduct Funds</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="adjAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control form-textarea" id="adjReason" rows="3" placeholder="Enter reason for adjustment"></textarea>
                            </div>
                        `;
                        break;

                    case 'transaction':
                        formHtml = `
                            <div class="form-group">
                                <label class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="adjTransactionId" placeholder="Enter transaction ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reversal Type</label>
                                <select class="form-control" id="adjReversalType">
                                    <option value="full">Full Reversal</option>
                                    <option value="partial">Partial Reversal</option>
                                </select>
                            </div>
                            <div class="form-group" id="adjPartialAmountGroup" style="display: none;">
                                <label class="form-label">Partial Amount</label>
                                <input type="number" class="form-control" id="adjPartialAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Reversal</label>
                                <textarea class="form-control form-textarea" id="adjReversalReason" rows="3" placeholder="Enter reason for reversal"></textarea>
                            </div>
                        `;
                        break;

                    case 'repayment':
                        formHtml = `
                            <div class="form-group">
                                <label class="form-label">Loan ID</label>
                                <input type="text" class="form-control" id="adjLoanId" placeholder="Enter loan ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjRepaymentType">
                                    <option value="extend">Extend Term</option>
                                    <option value="reduce">Reduce Term</option>
                                    <option value="reschedule">Reschedule</option>
                                    <option value="waive_penalty">Waive Penalty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Due Date</label>
                                <input type="date" class="form-control" id="adjNewDueDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Installment Amount</label>
                                <input type="number" class="form-control" id="adjNewInstallment" placeholder="Enter new amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Justification</label>
                                <textarea class="form-control form-textarea" id="adjJustification" rows="3" placeholder="Enter justification"></textarea>
                            </div>
                        `;
                        break;
                }

                contentEl.innerHTML = formHtml;

                // Add event listeners for dynamic elements
                if (type === 'transaction') {
                    const reversalType = document.getElementById('adjReversalType');
                    if (reversalType) {
                        reversalType.addEventListener('change', (e) => {
                            const partialGroup = document.getElementById('adjPartialAmountGroup');
                            if (partialGroup) {
                                partialGroup.style.display = e.target.value === 'partial' ? 'block' : 'none';
                            }
                        });
                    }
                }

                // Update process button
                const processBtn = document.getElementById('processManualAdjustmentBtn');
                if (processBtn) {
                    processBtn.onclick = () => this.processManualAdjustment(type);
                }
            },

            async processManualAdjustment(type) {
                let adjustmentData = {};

                switch (type) {
                    case 'balance':
                        const userType = document.getElementById('adjUserType')?.value;
                        const userId = document.getElementById('adjUserId')?.value.trim();
                        const adjType = document.getElementById('adjType')?.value;
                        const amount = parseFloat(document.getElementById('adjAmount')?.value);
                        const reason = document.getElementById('adjReason')?.value.trim();

                        if (!userId || !amount || !reason) {
                            Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                            return;
                        }

                        adjustmentData = {
                            type: 'balance_adjustment',
                            userType,
                            userId,
                            adjustmentType: adjType,
                            amount,
                            reason
                        };
                        break;

                    case 'transaction':
                        const transactionId = document.getElementById('adjTransactionId')?.value.trim();
                        const reversalType = document.getElementById('adjReversalType')?.value;
                        const reversalReason = document.getElementById('adjReversalReason')?.value.trim();

                        if (!transactionId || !reversalReason) {
                            Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                            return;
                        }

                        adjustmentData = {
                            type: 'transaction_reversal',
                            transactionId,
                            reversalType,
                            reason: reversalReason
                        };

                        if (reversalType === 'partial') {
                            const partialAmount = parseFloat(document.getElementById('adjPartialAmount')?.value);
                            if (!partialAmount) {
                                Utils.showNotification('Validation Error', 'Please enter partial amount', 'error');
                                return;
                            }
                            adjustmentData.partialAmount = partialAmount;
                        }
                        break;

                    case 'repayment':
                        const loanId = document.getElementById('adjLoanId')?.value.trim();
                        const repaymentType = document.getElementById('adjRepaymentType')?.value;
                        const newDueDate = document.getElementById('adjNewDueDate')?.value;
                        const newInstallment = document.getElementById('adjNewInstallment')?.value;
                        const justification = document.getElementById('adjJustification')?.value.trim();

                        if (!loanId || !justification) {
                            Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                            return;
                        }

                        adjustmentData = {
                            type: 'repayment_adjustment',
                            loanId,
                            adjustmentType: repaymentType,
                            newDueDate,
                            newInstallmentAmount: newInstallment ? parseFloat(newInstallment) : null,
                            reason: justification
                        };
                        break;
                }

                Utils.showLoading('Processing adjustment...');
                const result = await FirebaseService.processManualAdjustment(adjustmentData);
                Utils.hideLoading();

                if (result.success) {
                    Utils.showNotification('Success', 'Manual adjustment processed successfully', 'success');
                    Utils.closeModal('manualAdjustmentModal');
                } else {
                    Utils.showNotification('Error', result.error || 'Failed to process adjustment', 'error');
                }
            },

            loadBackupHistory() {
                // This would load backup history from Firebase
                const tableBody = document.getElementById('backupHistoryBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">No backup history found</td>
                        </tr>
                    `;
                }
            }
        };

        // ===== Global Functions =====
        // Admin Management
        function openCreateAdminModal() {
            Utils.openModal('createAdminModal');
        }

        async function createAdminAccount() {
            const fullName = document.getElementById('adminFullName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            const role = document.getElementById('adminRole').value;
            const permissions = Array.from(document.getElementById('adminPermissions').selectedOptions).map(opt => opt.value);

            // Validation
            if (!fullName || !email || !password || !confirmPassword) {
                Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                return;
            }

            if (!Utils.validateEmail(email)) {
                Utils.showNotification('Validation Error', 'Please enter a valid email address', 'error');
                return;
            }

            if (password !== confirmPassword) {
                Utils.showNotification('Validation Error', 'Passwords do not match', 'error');
                return;
            }

            if (!Utils.validatePassword(password)) {
                Utils.showNotification('Validation Error', 'Password must be at least 6 characters', 'error');
                return;
            }

            Utils.showLoading('Creating admin account...');

            try {
                const adminData = {
                    fullName,
                    email,
                    password,
                    role,
                    permissions
                };

                const result = await FirebaseService.createAdmin(adminData);

                if (result.success) {
                    Utils.showNotification('Success', `Admin account created successfully (ID: ${result.adminId})`, 'success');
                    Utils.closeModal('createAdminModal');
                    
                    // Clear form
                    document.getElementById('adminFullName').value = '';
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminConfirmPassword').value = '';
                    
                    // Refresh admin list
                    FirebaseService.loadAdmins();
                } else {
                    Utils.showNotification('Error', result.error || 'Failed to create admin account', 'error');
                }
            } catch (error) {
                Utils.showNotification('Error', 'Failed to create admin account', 'error');
            } finally {
                Utils.hideLoading();
            }
        }

        async function viewAdminDetails(userId) {
            try {
                Utils.showLoading('Loading admin details...');
                const admin = await FirebaseService.getUserDetails(userId);
                Utils.hideLoading();

                if (!admin) {
                    Utils.showNotification('Error', 'Admin not found', 'error');
                    return;
                }

                const content = document.getElementById('viewAdminContent');
                if (content) {
                    content.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Admin ID</label>
                            <p class="font-semibold">${admin.adminId || admin.userId.substring(0, 8)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <p class="font-semibold">${admin.fullName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <p class="font-semibold">${admin.email || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <p><span class="role-badge">${admin.role || 'Admin'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <p><span class="status-badge status-${admin.status || 'active'}">${admin.status || 'Active'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Created On</label>
                            <p class="font-semibold">${Utils.formatDate(admin.createdAt)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Login</label>
                            <p class="font-semibold">${Utils.formatDate(admin.lastLogin)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Permissions</label>
                            <div class="d-flex flex-wrap gap-8 mt-8">
                                ${(admin.permissions || []).map(perm => 
                                    `<span class="role-badge">${perm.replace('_', ' ')}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                Utils.openModal('viewAdminModal');
            } catch (error) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Failed to load admin details', 'error');
            }
        }

        async function suspendAdmin(userId) {
            Utils.confirmAction(
                'Suspend Admin',
                'Are you sure you want to suspend this admin account?',
                async () => {
                    Utils.showLoading('Suspending admin...');
                    const result = await FirebaseService.suspendUser(userId, 'admin');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Admin account suspended', 'success');
                        FirebaseService.loadAdmins();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to suspend admin', 'error');
                    }
                },
                'Suspend',
                'warning'
            );
        }

        async function reactivateAdmin(userId) {
            Utils.confirmAction(
                'Reactivate Admin',
                'Are you sure you want to reactivate this admin account?',
                async () => {
                    Utils.showLoading('Reactivating admin...');
                    const result = await FirebaseService.reactivateUser(userId, 'admin');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Admin account reactivated', 'success');
                        FirebaseService.loadAdmins();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to reactivate admin', 'error');
                    }
                },
                'Reactivate',
                'success'
            );
        }

        async function deleteAdmin(userId) {
            Utils.confirmAction(
                'Delete Admin',
                'WARNING: This will delete the admin account. This action cannot be undone.',
                async () => {
                    Utils.showLoading('Deleting admin...');
                    const result = await FirebaseService.deleteUser(userId, 'admin');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Admin account deleted', 'success');
                        FirebaseService.loadAdmins();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to delete admin', 'error');
                    }
                },
                'Delete',
                'danger'
            );
        }

        // Agent Management
        function openCreateAgentModal() {
            // Generate agent ID
            const agentId = 'AGT' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
            const agentIdField = document.getElementById('agentId');
            if (agentIdField) {
                agentIdField.value = agentId;
            }
            
            Utils.openModal('createAgentModal');
        }

        async function createAgentAccount() {
            const fullName = document.getElementById('agentFullName').value.trim();
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            const password = document.getElementById('agentPassword').value;
            const confirmPassword = document.getElementById('agentConfirmPassword').value;
            const commissionRate = parseFloat(document.getElementById('agentCommissionRate').value) || 5.0;
            const initialStatus = document.getElementById('agentInitialStatus').value;

            // Validation
            if (!fullName || !phone || !email || !password || !confirmPassword) {
                Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                return;
            }

            if (!Utils.validateEmail(email)) {
                Utils.showNotification('Validation Error', 'Please enter a valid email address', 'error');
                return;
            }

            if (password !== confirmPassword) {
                Utils.showNotification('Validation Error', 'Passwords do not match', 'error');
                return;
            }

            if (!Utils.validatePassword(password)) {
                Utils.showNotification('Validation Error', 'Password must be at least 6 characters', 'error');
                return;
            }

            Utils.showLoading('Creating agent account...');

            try {
                const agentData = {
                    fullName,
                    phone,
                    email,
                    password,
                    commissionRate,
                    initialStatus
                };

                const result = await FirebaseService.createAgent(agentData);

                if (result.success) {
                    Utils.showNotification('Success', `Agent account created successfully (ID: ${result.agentId})`, 'success');
                    Utils.closeModal('createAgentModal');
                    
                    // Clear form
                    document.getElementById('agentFullName').value = '';
                    document.getElementById('agentPhone').value = '';
                    document.getElementById('agentEmail').value = '';
                    document.getElementById('agentPassword').value = '';
                    document.getElementById('agentConfirmPassword').value = '';
                    document.getElementById('agentCommissionRate').value = '5.0';
                    
                    // Refresh agent list
                    FirebaseService.loadAgents();
                } else {
                    Utils.showNotification('Error', result.error || 'Failed to create agent account', 'error');
                }
            } catch (error) {
                Utils.showNotification('Error', 'Failed to create agent account', 'error');
            } finally {
                Utils.hideLoading();
            }
        }

        async function viewAgentDetails(agentId) {
            try {
                Utils.showLoading('Loading agent details...');
                const agent = await FirebaseService.getAgentDetails(agentId);
                Utils.hideLoading();

                if (!agent) {
                    Utils.showNotification('Error', 'Agent not found', 'error');
                    return;
                }

                const content = document.getElementById('viewAgentContent');
                if (content) {
                    content.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Agent ID</label>
                            <p class="font-semibold">${agent.agentId || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <p class="font-semibold">${agent.fullName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <p class="font-semibold">${agent.email || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <p class="font-semibold">${agent.phone || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <p><span class="status-badge status-${agent.status || 'active'}">${agent.status || 'Active'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Commission Rate</label>
                            <p class="font-semibold">${agent.commissionRate || 0}%</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Clients</label>
                            <p class="font-semibold">${agent.totalClients || 0}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Commission Earned</label>
                            <p class="font-semibold">${Utils.formatCurrency(agent.commissionEarned || 0)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Created On</label>
                            <p class="font-semibold">${Utils.formatDate(agent.createdAt)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Login</label>
                            <p class="font-semibold">${Utils.formatDate(agent.lastLogin)}</p>
                        </div>
                    `;
                }

                Utils.openModal('viewAgentModal');
            } catch (error) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Failed to load agent details', 'error');
            }
        }

        async function suspendAgent(agentId) {
            Utils.confirmAction(
                'Suspend Agent',
                'Are you sure you want to suspend this agent account?',
                async () => {
                    Utils.showLoading('Suspending agent...');
                    const result = await FirebaseService.suspendUser(agentId, 'agent');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Agent account suspended', 'success');
                        FirebaseService.loadAgents();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to suspend agent', 'error');
                    }
                },
                'Suspend',
                'warning'
            );
        }

        async function reactivateAgent(agentId) {
            Utils.confirmAction(
                'Reactivate Agent',
                'Are you sure you want to reactivate this agent account?',
                async () => {
                    Utils.showLoading('Reactivating agent...');
                    const result = await FirebaseService.reactivateUser(agentId, 'agent');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Agent account reactivated', 'success');
                        FirebaseService.loadAgents();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to reactivate agent', 'error');
                    }
                },
                'Reactivate',
                'success'
            );
        }

        async function deleteAgent(agentId) {
            Utils.confirmAction(
                'Delete Agent',
                'WARNING: This will delete the agent account. This action cannot be undone.',
                async () => {
                    Utils.showLoading('Deleting agent...');
                    const result = await FirebaseService.deleteUser(agentId, 'agent');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Agent account deleted', 'success');
                        FirebaseService.loadAgents();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to delete agent', 'error');
                    }
                },
                'Delete',
                'danger'
            );
        }

        // Customer Management
        async function viewCustomerDetails(userId) {
            try {
                Utils.showLoading('Loading customer details...');
                const customer = await FirebaseService.getUserDetails(userId);
                Utils.hideLoading();

                if (!customer) {
                    Utils.showNotification('Error', 'Customer not found', 'error');
                    return;
                }

                const content = document.getElementById('viewCustomerContent');
                if (content) {
                    content.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Customer ID</label>
                            <p class="font-semibold">${userId.substring(0, 8)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <p class="font-semibold">${customer.fullName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <p class="font-semibold">${customer.email || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <p class="font-semibold">${customer.phone || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Verification Status</label>
                            <p><span class="status-badge ${customer.verified ? 'status-active' : 'status-pending'}">${customer.verified ? 'Verified' : 'Pending'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Status</label>
                            <p><span class="status-badge status-${customer.status || 'active'}">${customer.status || 'Active'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loan Limit</label>
                            <p class="font-semibold">${Utils.formatCurrency(customer.loanLimit || 0)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Balance</label>
                            <p class="font-semibold">${Utils.formatCurrency(customer.balance || 0)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Created On</label>
                            <p class="font-semibold">${Utils.formatDate(customer.createdAt)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Login</label>
                            <p class="font-semibold">${Utils.formatDate(customer.lastLogin)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <p class="font-semibold">${customer.address || 'N/A'}</p>
                        </div>
                    `;
                }

                Utils.openModal('viewCustomerModal');
            } catch (error) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Failed to load customer details', 'error');
            }
        }

        async function suspendCustomer(userId) {
            Utils.confirmAction(
                'Suspend Customer',
                'Are you sure you want to suspend this customer account?',
                async () => {
                    Utils.showLoading('Suspending customer...');
                    const result = await FirebaseService.suspendUser(userId, 'customer');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Customer account suspended', 'success');
                        FirebaseService.loadCustomers();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to suspend customer', 'error');
                    }
                },
                'Suspend',
                'warning'
            );
        }

        async function reactivateCustomer(userId) {
            Utils.confirmAction(
                'Reactivate Customer',
                'Are you sure you want to reactivate this customer account?',
                async () => {
                    Utils.showLoading('Reactivating customer...');
                    const result = await FirebaseService.reactivateUser(userId, 'customer');
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showNotification('Success', 'Customer account reactivated', 'success');
                        FirebaseService.loadCustomers();
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to reactivate customer', 'error');
                    }
                },
                'Reactivate',
                'success'
            );
        }

        function adjustCustomerLimit(userId) {
            // Implementation for adjusting customer loan limit
            Utils.showNotification('Info', 'This feature will be implemented soon', 'info');
        }

        // Search Functions
        function searchAdmins() {
            const searchTerm = document.getElementById('adminSearch')?.value || '';
            FirebaseService.loadAdmins(1, searchTerm);
        }

        function searchAgents() {
            const searchTerm = document.getElementById('agentSearch')?.value || '';
            const statusFilter = document.getElementById('agentStatusFilter')?.value || 'all';
            FirebaseService.loadAgents(1, searchTerm, statusFilter);
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch')?.value || '';
            const statusFilter = document.getElementById('customerStatusFilter')?.value || 'all';
            FirebaseService.loadCustomers(1, searchTerm, statusFilter);
        }

        function searchDisputes() {
            const searchTerm = document.getElementById('disputeSearch')?.value || '';
            const statusFilter = document.getElementById('disputeStatusFilter')?.value || 'all';
            FirebaseService.loadDisputes(1, searchTerm, statusFilter);
        }

        function searchRepaymentPlans() {
            const searchTerm = document.getElementById('repaymentPlanSearch')?.value || '';
            FirebaseService.loadRepaymentPlans(1, searchTerm);
        }

        // Filter Functions
        function filterAgents() {
            searchAgents();
        }

        function filterCustomers() {
            searchCustomers();
        }

        function filterDisputes() {
            searchDisputes();
        }

        function filterAuditLogs() {
            const filters = FirebaseService.getAuditFilters();
            FirebaseService.loadAuditLogs(1, filters);
        }

        // Feature Flags
        function openFeatureFlagModal() {
            Utils.openModal('featureFlagModal');
            
            // Load feature flags content
            const content = document.getElementById('featureFlagContent');
            if (content) {
                content.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Toggle features on/off to control platform functionality
                    </div>
                    <div class="form-group">
                        <div class="d-flex align-center justify-between mb-12">
                            <div>
                                <div class="font-semibold">Maintenance Mode</div>
                                <div class="text-muted" style="font-size: 12px;">Put entire system under maintenance</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="modal_feature_maintenance" ${AppState.featureFlags.maintenance_mode ? 'checked' : ''}>
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="d-flex align-center justify-between mb-12">
                            <div>
                                <div class="font-semibold">New Registrations</div>
                                <div class="text-muted" style="font-size: 12px;">Allow new user registrations</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="modal_feature_registrations" ${AppState.featureFlags.new_registrations !== false ? 'checked' : ''}>
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="d-flex align-center justify-between mb-12">
                            <div>
                                <div class="font-semibold">Loan Applications</div>
                                <div class="text-muted" style="font-size: 12px;">Allow customers to apply for loans</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="modal_feature_loans" ${AppState.featureFlags.loan_applications !== false ? 'checked' : ''}>
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function saveFeatureFlagsFromModal() {
            const updatedFlags = {
                ...AppState.featureFlags,
                maintenance_mode: document.getElementById('modal_feature_maintenance')?.checked || false,
                new_registrations: document.getElementById('modal_feature_registrations')?.checked || false,
                loan_applications: document.getElementById('modal_feature_loans')?.checked || false
            };

            Utils.showLoading('Saving feature flags...');
            const result = await FirebaseService.updateFeatureFlags(updatedFlags);
            Utils.hideLoading();

            if (result.success) {
                Utils.showNotification('Success', 'Feature flags updated successfully', 'success');
                Utils.closeModal('featureFlagModal');
            } else {
                Utils.showNotification('Error', 'Failed to update feature flags', 'error');
            }
        }

        function updateFeatureFlags() {
            try {
                const flags = JSON.parse(document.getElementById('featureJsonEditor').textContent);
                FirebaseService.updateFeatureFlags(flags);
                Utils.showNotification('Success', 'Feature flags updated successfully', 'success');
            } catch (error) {
                Utils.showNotification('Error', 'Invalid JSON format', 'error');
            }
        }

        // Financial Settings
        async function saveFinancialSettings() {
            const settings = {
                minLoanAmount: parseFloat(document.getElementById('minLoanAmount').value) || 100,
                maxLoanAmount: parseFloat(document.getElementById('maxLoanAmount').value) || 10000,
                dailyTransactionLimit: parseFloat(document.getElementById('dailyTransactionLimit').value) || 5000,
                serviceCharge: parseFloat(document.getElementById('serviceCharge').value) || 2.5,
                agentCommission: parseFloat(document.getElementById('agentCommission').value) || 5.0,
                latePaymentFee: parseFloat(document.getElementById('latePaymentFee').value) || 1.5,
                autoApprovalLimit: parseFloat(document.getElementById('autoApprovalLimit').value) || 1000,
                manualReviewThreshold: parseFloat(document.getElementById('manualReviewThreshold').value) || 5000,
                riskThreshold: parseFloat(document.getElementById('riskThreshold').value) || 70,
                defaultCurrency: document.getElementById('defaultCurrency').value || 'USD',
                decimalPlaces: parseInt(document.getElementById('decimalPlaces').value) || 2,
                currencyFormat: document.getElementById('currencyFormat').value || 'symbol_before'
            };

            Utils.showLoading('Saving financial settings...');
            const result = await FirebaseService.saveFinancialSettings(settings);
            Utils.hideLoading();

            if (result.success) {
                Utils.showNotification('Success', 'Financial settings saved successfully', 'success');
            } else {
                Utils.showNotification('Error', 'Failed to save financial settings', 'error');
            }
        }

        // Notification Settings
        async function saveNotificationSettings() {
            const settings = {
                paymentReminders: {
                    enabled: document.getElementById('notify_payment_reminders').checked,
                    daysBefore: parseInt(document.getElementById('reminderDaysBefore').value) || 3,
                    frequency: document.getElementById('reminderFrequency').value || 'daily'
                },
                overdueAlerts: {
                    enabled: document.getElementById('notify_overdue_alerts').checked,
                    alertDays: parseInt(document.getElementById('overdueAlertDays').value) || 7,
                    maxAlerts: parseInt(document.getElementById('maxOverdueAlerts').value) || 3
                },
                securityNotifications: {
                    loginAlerts: document.getElementById('notify_login_alerts').checked,
                    accountChanges: document.getElementById('notify_account_changes').checked,
                    securityWarnings: document.getElementById('notify_security_warnings').checked
                },
                templates: {
                    paymentReminder: document.getElementById('paymentReminderTemplate').value,
                    overdueAlert: document.getElementById('overdueAlertTemplate').value
                }
            };

            Utils.showLoading('Saving notification settings...');
            const result = await FirebaseService.saveNotificationSettings(settings);
            Utils.hideLoading();

            if (result.success) {
                Utils.showNotification('Success', 'Notification settings saved successfully', 'success');
            } else {
                Utils.showNotification('Error', 'Failed to save notification settings', 'error');
            }
        }

        // UI Settings
        async function saveUISettings() {
            const settings = {
                customerDashboardLayout: document.getElementById('customerDashboardLayout').value,
                agentDashboardLayout: document.getElementById('agentDashboardLayout').value,
                adminDashboardLayout: document.getElementById('adminDashboardLayout').value,
                customerModules: Array.from(document.getElementById('customerModules').selectedOptions).map(opt => opt.value),
                autoRefresh: document.getElementById('ui_auto_refresh').checked,
                showTutorials: document.getElementById('ui_show_tutorials').checked,
                animations: document.getElementById('ui_animations').checked
            };

            Utils.showLoading('Saving UI settings...');
            const result = await FirebaseService.saveUISettings(settings);
            Utils.hideLoading();

            if (result.success) {
                Utils.showNotification('Success', 'UI settings saved successfully', 'success');
            } else {
                Utils.showNotification('Error', 'Failed to save UI settings', 'error');
            }
        }

        // Security Settings
        async function saveSecuritySettings() {
            const settings = {
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value) || 30,
                maxConcurrentSessions: parseInt(document.getElementById('maxConcurrentSessions').value) || 3,
                forceLogout: document.getElementById('forceLogout').value === 'yes',
                maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value) || 5,
                lockoutDuration: parseInt(document.getElementById('lockoutDuration').value) || 30,
                ipLockoutThreshold: parseInt(document.getElementById('ipLockoutThreshold').value) || 10,
                minPasswordLength: parseInt(document.getElementById('minPasswordLength').value) || 8,
                passwordExpiryDays: parseInt(document.getElementById('passwordExpiryDays').value) || 90,
                passwordHistoryCount: parseInt(document.getElementById('passwordHistoryCount').value) || 5,
                twoFactorAuth: document.getElementById('security_2fa').checked,
                ipWhitelisting: document.getElementById('security_ip_whitelist').checked,
                allowedIPs: document.getElementById('allowedIPs').value.split(',').map(ip => ip.trim()).filter(ip => ip)
            };

            Utils.showLoading('Saving security settings...');
            const result = await FirebaseService.saveSecuritySettings(settings);
            Utils.hideLoading();

            if (result.success) {
                Utils.showNotification('Success', 'Security settings saved successfully', 'success');
            } else {
                Utils.showNotification('Error', 'Failed to save security settings', 'error');
            }
        }

        // Manual Interventions
        function openManualAdjustmentModal() {
            Utils.openModal('manualAdjustmentModal');
            UIManager.loadManualAdjustmentForm('balance');
        }

        async function processManualAdjustment() {
            // This is handled by UIManager.processManualAdjustment
        }

        async function processTransactionReversal() {
            const transactionId = document.getElementById('reversalTransactionId')?.value.trim();
            const reversalType = document.getElementById('reversalType')?.value;
            const reason = document.getElementById('reversalReason')?.value.trim();
            const authCode = document.getElementById('reversalAuthCode')?.value;

            if (!transactionId || !reason || !authCode) {
                Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                return;
            }

            if (authCode !== 'SUDO123') { // In production, use proper authentication
                Utils.showNotification('Error', 'Invalid authorization code', 'error');
                return;
            }

            Utils.confirmAction(
                'Confirm Transaction Reversal',
                `Are you sure you want to reverse transaction ${transactionId}?`,
                async () => {
                    Utils.showLoading('Processing transaction reversal...');
                    
                    const adjustmentData = {
                        type: 'transaction_reversal',
                        transactionId,
                        reversalType,
                        reason,
                        amount: reversalType === 'partial' ? parseFloat(document.getElementById('partialReversalAmount')?.value) : null
                    };

                    const result = await FirebaseService.processManualAdjustment(adjustmentData);
                    Utils.hideLoading();

                    if (result.success) {
                        Utils.showNotification('Success', 'Transaction reversed successfully', 'success');
                        
                        // Clear form
                        document.getElementById('reversalTransactionId').value = '';
                        document.getElementById('reversalReason').value = '';
                        document.getElementById('reversalAuthCode').value = '';
                        document.getElementById('partialReversalAmount').value = '';
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to reverse transaction', 'error');
                    }
                },
                'Reverse Transaction',
                'danger'
            );
        }

        async function processRepaymentAdjustment() {
            const loanId = document.getElementById('adjustmentLoanId')?.value.trim();
            const adjustmentType = document.getElementById('repaymentAdjustmentType')?.value;
            const newDueDate = document.getElementById('newDueDate')?.value;
            const newInstallmentAmount = document.getElementById('newInstallmentAmount')?.value;
            const justification = document.getElementById('repaymentAdjustmentJustification')?.value.trim();

            if (!loanId || !justification) {
                Utils.showNotification('Validation Error', 'Please fill in all required fields', 'error');
                return;
            }

            Utils.confirmAction(
                'Confirm Repayment Adjustment',
                `Are you sure you want to adjust repayment schedule for loan ${loanId}?`,
                async () => {
                    Utils.showLoading('Processing repayment adjustment...');
                    
                    const adjustmentData = {
                        type: 'repayment_adjustment',
                        loanId,
                        adjustmentType,
                        newDueDate,
                        newInstallmentAmount: newInstallmentAmount ? parseFloat(newInstallmentAmount) : null,
                        reason: justification
                    };

                    const result = await FirebaseService.processManualAdjustment(adjustmentData);
                    Utils.hideLoading();

                    if (result.success) {
                        Utils.showNotification('Success', 'Repayment schedule adjusted successfully', 'success');
                        
                        // Clear form
                        document.getElementById('adjustmentLoanId').value = '';
                        document.getElementById('newDueDate').value = '';
                        document.getElementById('newInstallmentAmount').value = '';
                        document.getElementById('repaymentAdjustmentJustification').value = '';
                    } else {
                        Utils.showNotification('Error', result.error || 'Failed to adjust repayment schedule', 'error');
                    }
                },
                'Adjust Repayment',
                'primary'
            );
        }

        // Backup & Export
        function openBackupModal() {
            Utils.openModal('backupModal');
        }

        async function createManualBackup() {
            const dataTypes = Array.from(document.getElementById('backupDataType').selectedOptions).map(opt => opt.value);
            const format = document.getElementById('backupFormat').value;

            if (dataTypes.length === 0) {
                Utils.showNotification('Validation Error', 'Please select at least one data type', 'error');
                return;
            }

            Utils.showLoading('Creating backup...');
            
            // In a real implementation, this would create a backup in Firebase
            // For now, we'll simulate it
            setTimeout(() => {
                Utils.hideLoading();
                Utils.showNotification('Success', 'Backup created successfully', 'success');
                
                // Add to backup history
                const historyBody = document.getElementById('backupHistoryBody');
                if (historyBody) {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${Utils.generateId('BACKUP_').substring(0, 8)}</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td>Manual</td>
                        <td>${Math.floor(Math.random() * 1000) + 100} KB</td>
                        <td><span class="status-badge status-active">Completed</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="downloadBackup(this)">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    `;
                    historyBody.appendChild(newRow);
                }
            }, 2000);
        }

        function downloadBackup(button) {
            Utils.showNotification('Info', 'Downloading backup file...', 'info');
            // In production, this would download the actual backup file
        }

        async function exportData() {
            const exportType = document.getElementById('exportType').value;
            const format = 'json'; // Default format
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            
            const dateRange = {};
            if (dateFrom) dateRange.from = dateFrom;
            if (dateTo) dateRange.to = dateTo;
            
            await FirebaseService.exportData(exportType, format, dateRange);
        }

        function exportDataByType(dataType) {
            FirebaseService.exportData(dataType, 'json');
        }

        async function exportAuditLogs() {
            await FirebaseService.exportData('audit', 'csv');
        }

        // Repayment Plans
        function openCreateRepaymentPlanModal() {
            // Implementation for creating repayment plans
            Utils.showNotification('Info', 'Repayment plan creation will be implemented soon', 'info');
        }

        // Dispute Resolution
        async function viewDisputeDetails(disputeId) {
            try {
                const disputesRef = db.ref(`disputes/${disputeId}`);
                const snapshot = await disputesRef.once('value');
                const dispute = snapshot.val();

                if (!dispute) {
                    Utils.showNotification('Error', 'Dispute not found', 'error');
                    return;
                }

                const content = document.getElementById('viewDisputeContent');
                if (content) {
                    content.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Dispute ID</label>
                            <p class="font-semibold">${disputeId.substring(0, 8)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <p class="font-semibold">${dispute.type || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer</label>
                            <p class="font-semibold">${dispute.customerName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agent</label>
                            <p class="font-semibold">${dispute.agentName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <p class="font-semibold">${Utils.formatCurrency(dispute.amount || 0)}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity</label>
                            <p><span class="status-badge ${dispute.severity === 'high' ? 'status-banned' : dispute.severity === 'medium' ? 'status-suspended' : 'status-pending'}">${dispute.severity || 'low'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <p><span class="status-badge ${dispute.status === 'resolved' ? 'status-active' : dispute.status === 'in_progress' ? 'status-pending' : 'status-suspended'}">${dispute.status || 'open'}</span></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <p class="font-semibold">${dispute.description || 'No description provided'}</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Created On</label>
                            <p class="font-semibold">${Utils.formatDate(dispute.createdAt)}</p>
                        </div>
                        ${dispute.resolution ? `
                            <div class="form-group">
                                <label class="form-label">Resolution</label>
                                <p class="font-semibold">${dispute.resolution}</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Resolved By</label>
                                <p class="font-semibold">${dispute.resolvedBy || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Resolved On</label>
                                <p class="font-semibold">${Utils.formatDate(dispute.resolvedAt)}</p>
                            </div>
                        ` : ''}
                    `;
                }

                Utils.openModal('viewDisputeModal');
            } catch (error) {
                Utils.showNotification('Error', 'Failed to load dispute details', 'error');
            }
        }

        async function resolveDispute(disputeId) {
            Utils.confirmAction(
                'Resolve Dispute',
                'Are you sure you want to mark this dispute as resolved?',
                async () => {
                    try {
                        await db.ref(`disputes/${disputeId}`).update({
                            status: 'resolved',
                            resolvedAt: Date.now(),
                            resolvedBy: AppState.currentUser.uid,
                            resolution: 'Dispute resolved by administrator'
                        });
                        
                        await FirebaseService.logAudit({
                            action: 'resolve_dispute',
                            details: `Resolved dispute ${disputeId}`,
                            performedBy: AppState.currentUser.uid
                        });
                        
                        Utils.showNotification('Success', 'Dispute marked as resolved', 'success');
                        FirebaseService.loadDisputes();
                    } catch (error) {
                        Utils.showNotification('Error', 'Failed to resolve dispute', 'error');
                    }
                },
                'Resolve',
                'success'
            );
        }

        async function escalateDispute(disputeId) {
            Utils.confirmAction(
                'Escalate Dispute',
                'Are you sure you want to escalate this dispute?',
                async () => {
                    try {
                        await db.ref(`disputes/${disputeId}`).update({
                            status: 'escalated',
                            escalatedAt: Date.now(),
                            escalatedBy: AppState.currentUser.uid,
                            severity: 'high'
                        });
                        
                        await FirebaseService.logAudit({
                            action: 'escalate_dispute',
                            details: `Escalated dispute ${disputeId}`,
                            performedBy: AppState.currentUser.uid
                        });
                        
                        Utils.showNotification('Success', 'Dispute escalated successfully', 'success');
                        FirebaseService.loadDisputes();
                    } catch (error) {
                        Utils.showNotification('Error', 'Failed to escalate dispute', 'error');
                    }
                },
                'Escalate',
                'warning'
            );
        }

        // Utility Functions
        function refreshSystemHealth() {
            FirebaseService.loadSystemStats();
            Utils.showNotification('Refreshed', 'System health data refreshed', 'success');
        }

        function viewAuditLogs() {
            UIManager.showSection('audit');
        }

        function refreshAdminList() {
            FirebaseService.loadAdmins();
            Utils.showNotification('Refreshed', 'Admin list refreshed', 'success');
        }

        function refreshAuditLogs() {
            FirebaseService.loadAuditLogs();
            Utils.showNotification('Refreshed', 'Audit logs refreshed', 'success');
        }

        function closeModal(modalId) {
            Utils.closeModal(modalId);
        }

        function configureTransactionLimits() {
            // Implementation for configuring transaction limits
            Utils.showNotification('Info', 'Transaction limits configuration will be implemented soon', 'info');
        }

        function openBulkAgentActions() {
            // Implementation for bulk agent actions
            Utils.showNotification('Info', 'Bulk agent actions will be implemented soon', 'info');
        }

        // ===== Application Initialization =====
        async function initApplication() {
            Utils.showLoading('Initializing SUDO Control Panel...');
            
            try {
                // Check SUDO access
                const hasAccess = await FirebaseService.checkSudoAccess();
                if (!hasAccess) {
                    Utils.hideLoading();
                    return;
                }
                
                // Load initial data
                await Promise.all([
                    FirebaseService.loadSystemStats(),
                    FirebaseService.loadAdmins(),
                    FirebaseService.loadAgents(),
                    FirebaseService.loadCustomers(),
                    FirebaseService.loadFeatureFlags(),
                    FirebaseService.loadFinancialSettings(),
                    FirebaseService.loadAuditLogs(),
                    FirebaseService.loadDisputes(),
                    FirebaseService.loadRepaymentPlans()
                ]);
                
                // Initialize real-time listeners
                FirebaseService.initRealTimeListeners();
                
                // Initialize UI
                UIManager.init();
                
                // Hide loading
                setTimeout(() => {
                    Utils.hideLoading();
                    Utils.showNotification('SUDO Control Panel Ready', 'Full system control initialized', 'success');
                }, 500);
                
            } catch (error) {
                console.error('SUDO: Initialization error:', error);
                Utils.hideLoading();
                Utils.showNotification('Error', 'Failed to initialize control panel', 'error');
            }
        }

        // Initialize application when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApplication);
        } else {
            initApplication();
        }

        // Export functions to global scope for HTML onclick handlers
        window.openCreateAdminModal = openCreateAdminModal;
        window.createAdminAccount = createAdminAccount;
        window.viewAdminDetails = viewAdminDetails;
        window.suspendAdmin = suspendAdmin;
        window.reactivateAdmin = reactivateAdmin;
        window.deleteAdmin = deleteAdmin;
        window.openCreateAgentModal = openCreateAgentModal;
        window.createAgentAccount = createAgentAccount;
        window.viewAgentDetails = viewAgentDetails;
        window.suspendAgent = suspendAgent;
        window.reactivateAgent = reactivateAgent;
        window.deleteAgent = deleteAgent;
        window.viewCustomerDetails = viewCustomerDetails;
        window.suspendCustomer = suspendCustomer;
        window.reactivateCustomer = reactivateCustomer;
        window.adjustCustomerLimit = adjustCustomerLimit;
        window.openFeatureFlagModal = openFeatureFlagModal;
        window.saveFeatureFlagsFromModal = saveFeatureFlagsFromModal;
        window.updateFeatureFlags = updateFeatureFlags;
        window.saveFinancialSettings = saveFinancialSettings;
        window.saveNotificationSettings = saveNotificationSettings;
        window.saveUISettings = saveUISettings;
        window.saveSecuritySettings = saveSecuritySettings;
        window.openManualAdjustmentModal = openManualAdjustmentModal;
        window.processManualAdjustment = processManualAdjustment;
        window.processTransactionReversal = processTransactionReversal;
        window.processRepaymentAdjustment = processRepaymentAdjustment;
        window.openBackupModal = openBackupModal;
        window.createManualBackup = createManualBackup;
        window.exportData = exportData;
        window.exportDataByType = exportDataByType;
        window.exportAuditLogs = exportAuditLogs;
        window.refreshSystemHealth = refreshSystemHealth;
        window.viewAuditLogs = viewAuditLogs;
        window.refreshAdminList = refreshAdminList;
        window.refreshAuditLogs = refreshAuditLogs;
        window.closeModal = closeModal;
        window.configureTransactionLimits = configureTransactionLimits;
        window.openBulkAgentActions = openBulkAgentActions;
        window.openCreateRepaymentPlanModal = openCreateRepaymentPlanModal;
        window.viewDisputeDetails = viewDisputeDetails;
        window.resolveDispute = resolveDispute;
        window.escalateDispute = escalateDispute;
        window.searchAdmins = searchAdmins;
        window.searchAgents = searchAgents;
        window.searchCustomers = searchCustomers;
        window.searchDisputes = searchDisputes;
        window.searchRepaymentPlans = searchRepaymentPlans;
        window.filterAgents = filterAgents;
        window.filterCustomers = filterCustomers;
        window.filterDisputes = filterDisputes;
        window.filterAuditLogs = filterAuditLogs;
        window.downloadBackup = downloadBackup;
    </script>
</body>
</html>
