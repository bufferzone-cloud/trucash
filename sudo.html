<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | SUDO Super Control Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse for CSV Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== macOS Theme CSS Reset ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
                       'Helvetica Neue', 'Segoe UI', Roboto, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --macos-gray-100: #f5f5f7;
            --macos-gray-200: #e5e5e7;
            --macos-gray-300: #d2d2d7;
            --macos-gray-400: #86868b;
            --macos-gray-500: #515154;
            --macos-gray-600: #1d1d1f;
            --macos-blue: #007AFF;
            --macos-blue-light: #409cff;
            --macos-blue-dark: #0056cc;
            --macos-green: #34c759;
            --macos-red: #ff3b30;
            --macos-purple: #5856d6;
            --macos-yellow: #ffcc00;
            --macos-orange: #ff9500;
            --macos-pink: #ff2d55;
            --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --macos-shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
            --macos-shadow-light: 0 2px 6px rgba(0, 0, 0, 0.04);
            --macos-border-radius: 12px;
            --macos-border-radius-small: 8px;
            --macos-border-radius-large: 16px;
            --macos-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --macos-glass: rgba(255, 255, 255, 0.85);
            --macos-glass-border: rgba(255, 255, 255, 0.2);
            --macos-danger-bg: rgba(255, 59, 48, 0.1);
            --macos-warning-bg: rgba(255, 204, 0, 0.1);
            --macos-success-bg: rgba(52, 199, 89, 0.1);
            --macos-info-bg: rgba(0, 122, 255, 0.1);
            --macos-sidebar-width: 280px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--macos-gray-600);
            min-height: 100vh;
            line-height: 1.4;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(at 10% 20%, rgba(120, 119, 198, 0.03) 0px, transparent 50%),
                radial-gradient(at 90% 10%, rgba(0, 122, 255, 0.03) 0px, transparent 50%),
                radial-gradient(at 50% 90%, rgba(76, 175, 80, 0.03) 0px, transparent 50%);
            z-index: -1;
        }

        /* ===== SUDO Header ===== */
        .sudo-header {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--macos-glass-border);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--macos-shadow-light);
        }

        .sudo-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sudo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--macos-red) 0%, var(--macos-orange) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .sudo-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--macos-gray-600);
            letter-spacing: -0.3px;
        }

        .sudo-subtitle {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .live-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            background: var(--macos-success-bg);
            color: var(--macos-green);
            border-radius: 20px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--macos-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* ===== Main Layout ===== */
        .sudo-container {
            display: flex;
            min-height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* ===== Sidebar Navigation ===== */
        .sudo-sidebar {
            width: var(--macos-sidebar-width);
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--macos-glass-border);
            padding: 24px 0;
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 900;
        }

        .nav-section {
            margin-bottom: 24px;
            padding: 0 20px;
        }

        .nav-title {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--macos-gray-500);
            text-decoration: none;
            border-radius: var(--macos-border-radius);
            transition: var(--macos-transition);
            margin-bottom: 4px;
            cursor: pointer;
            user-select: none;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--macos-gray-600);
        }

        .nav-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .nav-item.active .nav-icon {
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-gray-400);
        }

        .nav-text {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 600;
        }

        /* ===== Main Content ===== */
        .sudo-main {
            flex: 1;
            margin-left: var(--macos-sidebar-width);
            padding: 24px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-gray-600);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--macos-gray-400);
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            transition: var(--macos-transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.users { background: var(--macos-info-bg); color: var(--macos-blue); }
        .stat-icon.agents { background: var(--macos-success-bg); color: var(--macos-green); }
        .stat-icon.transactions { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .stat-icon.revenue { background: var(--macos-danger-bg); color: var(--macos-red); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-gray-600);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--macos-gray-400);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--macos-green);
        }

        .stat-change.negative {
            color: var(--macos-red);
        }

        /* ===== Cards Grid ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius-large);
            overflow: hidden;
            transition: var(--macos-transition);
        }

        .card:hover {
            box-shadow: var(--macos-shadow);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* ===== Form Elements ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: 1px solid var(--macos-gray-200);
            border-radius: var(--macos-border-radius-small);
            background: rgba(255, 255, 255, 0.9);
            transition: var(--macos-transition);
            color: var(--macos-gray-600);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }

        .form-control::placeholder {
            color: var(--macos-gray-400);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* ===== Tables ===== */
        .table-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: rgba(0, 0, 0, 0.02);
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table td {
            padding: 16px;
            font-size: 13px;
            color: var(--macos-gray-600);
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table tbody tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
        }

        .status-active { background: var(--macos-success-bg); color: var(--macos-green); }
        .status-inactive { background: var(--macos-gray-200); color: var(--macos-gray-500); }
        .status-suspended { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .status-banned { background: var(--macos-danger-bg); color: var(--macos-red); }
        .status-pending { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
            background: var(--macos-info-bg);
            color: var(--macos-blue);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 10px 18px;
            border-radius: var(--macos-border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--macos-transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-blue-light) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--macos-blue-dark) 0%, var(--macos-blue) 100%);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--macos-red) 0%, #ff5a5a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #cc2e25 0%, var(--macos-red) 100%);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.35);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--macos-green) 0%, #2db867 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, var(--macos-green) 100%);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.35);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--macos-gray-300);
            color: var(--macos-gray-600);
        }

        .btn-outline:hover {
            background: rgba(0, 0, 0, 0.03);
            border-color: var(--macos-gray-400);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== Toggle Switches ===== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--macos-gray-300);
            transition: var(--macos-transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--macos-transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--macos-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ===== Charts ===== */
        .chart-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
            margin-bottom: 16px;
        }

        /* ===== Modals ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: var(--macos-border-radius-large);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-heavy);
            border: 1px solid var(--macos-glass-border);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .modal-close {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            font-size: 16px;
            color: var(--macos-gray-500);
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--macos-transition);
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== Loading Overlay ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-200);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--macos-gray-600);
            font-weight: 500;
        }

        /* ===== Notifications ===== */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--macos-border-radius);
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            box-shadow: var(--macos-shadow-heavy);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1500;
            transform: translateX(calc(100% + 24px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 320px;
            border: 1px solid var(--macos-glass-border);
        }

        .notification.active {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--macos-green);
        }

        .notification.error {
            border-left: 4px solid var(--macos-red);
        }

        .notification.info {
            border-left: 4px solid var(--macos-blue);
        }

        .notification.warning {
            border-left: 4px solid var(--macos-yellow);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success .notification-icon {
            color: var(--macos-green);
        }

        .notification.error .notification-icon {
            color: var(--macos-red);
        }

        .notification.info .notification-icon {
            color: var(--macos-blue);
        }

        .notification.warning .notification-icon {
            color: var(--macos-yellow);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
            color: var(--macos-gray-600);
        }

        .notification-message {
            font-size: 12px;
            color: var(--macos-gray-500);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--macos-gray-400);
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--macos-transition);
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--macos-gray-600);
        }

        /* ===== Code Editor ===== */
        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .code-header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .code-language {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
        }

        .code-body {
            padding: 16px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-body pre {
            margin: 0;
        }

        /* ===== Alert Boxes ===== */
        .alert {
            padding: 16px;
            border-radius: var(--macos-border-radius);
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-danger {
            background: var(--macos-danger-bg);
            border-left-color: var(--macos-red);
            color: var(--macos-red);
        }

        .alert-warning {
            background: var(--macos-warning-bg);
            border-left-color: var(--macos-yellow);
            color: var(--macos-yellow);
        }

        .alert-success {
            background: var(--macos-success-bg);
            border-left-color: var(--macos-green);
            color: var(--macos-green);
        }

        .alert-info {
            background: var(--macos-info-bg);
            border-left-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sudo-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sudo-sidebar.active {
                transform: translateX(0);
            }

            .sudo-main {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sudo-header {
                padding: 0 16px;
            }

            .sudo-main {
                padding: 16px;
            }

            .card-header, .card-body {
                padding: 16px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* ===== Utility Classes ===== */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }
        .w-100 { width: 100%; }
        .mt-16 { margin-top: 16px; }
        .mb-16 { margin-bottom: 16px; }
        .mb-24 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--macos-gray-400); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-yellow); }
        .text-info { color: var(--macos-blue); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }

        /* ===== Custom Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--macos-gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-300);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-400);
        }

        /* ===== File Upload Styles ===== */
        .file-upload-container {
            border: 2px dashed var(--macos-gray-300);
            border-radius: var(--macos-border-radius);
            padding: 24px;
            text-align: center;
            transition: var(--macos-transition);
            cursor: pointer;
        }

        .file-upload-container:hover {
            border-color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.02);
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--macos-gray-300);
            margin-bottom: 12px;
        }

        .file-upload-text {
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: var(--macos-gray-400);
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--macos-gray-100);
            border-radius: var(--macos-border-radius-small);
            margin-bottom: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            color: var(--macos-blue);
        }

        /* ===== Progress Bar ===== */
        .progress-container {
            background: var(--macos-gray-200);
            border-radius: 10px;
            overflow: hidden;
            height: 6px;
            margin: 8px 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--macos-blue), var(--macos-purple));
            height: 100%;
            transition: width 0.3s ease;
        }

        /* ===== Search Filters ===== */
        .filter-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== Data Export Styles ===== */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .export-option {
            padding: 20px;
            background: var(--macos-glass);
            border-radius: var(--macos-border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--macos-transition);
            border: 1px solid var(--macos-glass-border);
        }

        .export-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .export-icon {
            font-size: 32px;
            color: var(--macos-blue);
            margin-bottom: 12px;
        }

        /* ===== Pagination ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--macos-border-radius-small);
            border: 1px solid var(--macos-gray-200);
            background: white;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .page-btn:hover:not(.disabled) {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        .page-btn.active {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading SUDO Control Panel...</div>
    </div>

    <!-- SUDO Header -->
    <header class="sudo-header">
        <div class="sudo-logo">
            <div class="sudo-icon">SU</div>
            <div>
                <div class="sudo-title">TruCash SUDO</div>
                <div class="sudo-subtitle">Super Control Admin</div>
            </div>
        </div>
        <div class="header-actions">
            <div class="live-status">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">SU</div>
                <div>
                    <div style="font-size: 13px; font-weight: 600;" id="userName">SUDO Admin</div>
                    <div style="font-size: 11px; color: var(--macos-gray-400);" id="userRole">Full System Control</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="sudo-container">
        <!-- Sidebar Navigation -->
        <nav class="sudo-sidebar">
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <div class="nav-item active" data-section="dashboard">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Overview</div>
                </div>
                <div class="nav-item" data-section="analytics">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="nav-text">Analytics</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">User Management</div>
                <div class="nav-item" data-section="admins">
                    <div class="nav-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="nav-text">Admin Accounts</div>
                </div>
                <div class="nav-item" data-section="agents">
                    <div class="nav-icon"><i class="fas fa-id-badge"></i></div>
                    <div class="nav-text">Agent Accounts</div>
                </div>
                <div class="nav-item" data-section="customers">
                    <div class="nav-icon"><i class="fas fa-users"></i></div>
                    <div class="nav-text">Customer Accounts</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System Control</div>
                <div class="nav-item" data-section="features">
                    <div class="nav-icon"><i class="fas fa-toggle-on"></i></div>
                    <div class="nav-text">Feature Flags</div>
                </div>
                <div class="nav-item" data-section="financial">
                    <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="nav-text">Financial Settings</div>
                </div>
                <div class="nav-item" data-section="repayment">
                    <div class="nav-icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="nav-text">Repayment Plans</div>
                </div>
                <div class="nav-item" data-section="notifications">
                    <div class="nav-icon"><i class="fas fa-bell"></i></div>
                    <div class="nav-text">Notifications</div>
                </div>
                <div class="nav-item" data-section="ui-settings">
                    <div class="nav-icon"><i class="fas fa-sliders-h"></i></div>
                    <div class="nav-text">UI Behavior</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Security & Monitoring</div>
                <div class="nav-item" data-section="security">
                    <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="nav-text">Security Settings</div>
                </div>
                <div class="nav-item" data-section="audit">
                    <div class="nav-icon"><i class="fas fa-history"></i></div>
                    <div class="nav-text">Audit Logs</div>
                    <div class="nav-badge" id="auditBadge">0</div>
                </div>
                <div class="nav-item" data-section="backup">
                    <div class="nav-icon"><i class="fas fa-database"></i></div>
                    <div class="nav-text">Backup & Export</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Manual Intervention</div>
                <div class="nav-item" data-section="manual">
                    <div class="nav-icon"><i class="fas fa-hands-helping"></i></div>
                    <div class="nav-text">Manual Adjustments</div>
                </div>
                <div class="nav-item" data-section="disputes">
                    <div class="nav-icon"><i class="fas fa-gavel"></i></div>
                    <div class="nav-text">Dispute Resolution</div>
                    <div class="nav-badge" id="disputeBadge">0</div>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item" data-action="logout">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="sudo-main">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1 class="section-title">System Overview</h1>
                    <div class="section-subtitle">Real-time monitoring of the entire TruCash platform</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-icon users"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="userGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Active Agents</div>
                                <div class="stat-value" id="activeAgents">0</div>
                            </div>
                            <div class="stat-icon agents"><i class="fas fa-id-badge"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="agentGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Transactions Today</div>
                                <div class="stat-value" id="todayTransactions">0</div>
                            </div>
                            <div class="stat-icon transactions"><i class="fas fa-exchange-alt"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="transactionGrowth">0%</span> vs yesterday
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Platform Revenue</div>
                                <div class="stat-value" id="platformRevenue">$0</div>
                            </div>
                            <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="revenueGrowth">0%</span> this month
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Health</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshSystemHealth()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Database Connection</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Firebase Realtime Database</span>
                                    <span class="status-badge status-active" id="dbStatus">Connected</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Active Sessions</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Current Active Users</span>
                                    <span class="font-semibold" id="activeSessions">0</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">System Load</label>
                                <div class="d-flex align-center justify-between">
                                    <span>API Response Time</span>
                                    <span class="font-semibold" id="apiResponseTime">0ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-8 mb-16">
                                <button class="btn btn-primary" onclick="openCreateAdminModal()">
                                    <i class="fas fa-user-plus"></i> Create Admin
                                </button>
                                <button class="btn btn-success" onclick="openCreateAgentModal()">
                                    <i class="fas fa-id-card"></i> Create Agent
                                </button>
                                <button class="btn btn-outline" onclick="openManualAdjustmentModal()">
                                    <i class="fas fa-edit"></i> Manual Adjustment
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-8">
                                <button class="btn btn-outline" onclick="openFeatureFlagModal()">
                                    <i class="fas fa-toggle-on"></i> Feature Flags
                                </button>
                                <button class="btn btn-outline" onclick="viewAuditLogs()">
                                    <i class="fas fa-history"></i> View Audit Logs
                                </button>
                                <button class="btn btn-outline" onclick="openBackupModal()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Real-time System Activity</div>
                    <canvas id="activityChart"></canvas>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admins" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Admin Accounts Management</h1>
                    <div class="section-subtitle">Create, edit, suspend, and delete admin accounts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateAdminModal()">
                            <i class="fas fa-user-plus"></i> Create New Admin
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 300px;" placeholder="Search admins..." id="adminSearch" onkeyup="searchAdmins()">
                        <button class="btn btn-outline" onclick="refreshAdminList()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="adminsTable">
                        <thead>
                            <tr>
                                <th>Admin ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Admin rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="adminPagination"></div>
            </section>

            <!-- Agent Management Section -->
            <section id="agents" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Agent Accounts Management</h1>
                    <div class="section-subtitle">Manage all agent accounts and their permissions</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <button class="btn btn-primary" onclick="openCreateAgentModal()">
                            <i class="fas fa-user-plus"></i> Create Agent
                        </button>
                        <button class="btn btn-outline" onclick="openBulkAgentActions()">
                            <i class="fas fa-users-cog"></i> Bulk Actions
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="agentStatusFilter" onchange="filterAgents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search agents..." id="agentSearch" onkeyup="searchAgents()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="agentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Clients</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <!-- Agent rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="agentPagination"></div>
            </section>

            <!-- Customer Management Section -->
            <section id="customers" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Customer Accounts Management</h1>
                    <div class="section-subtitle">Manage customer access controls and permissions</div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Transaction Limits</div>
                                    <div class="text-muted" style="font-size: 12px;">Configure customer transaction caps</div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="configureTransactionLimits()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Daily Limit</label>
                                <input type="number" class="form-control" id="dailyLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Single Transaction</label>
                                <input type="number" class="form-control" id="singleTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Account Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Set verification requirements</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoVerification" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Required Documents</label>
                                <select class="form-control" id="requiredDocs" multiple style="height: 120px;">
                                    <option value="nrc" selected>National ID (NRC)</option>
                                    <option value="passport" selected>Passport</option>
                                    <option value="drivers_license">Driver's License</option>
                                    <option value="proof_of_address">Proof of Address</option>
                                    <option value="employment_letter">Employment Letter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="customerStatusFilter" onchange="filterCustomers()">
                            <option value="all">All Status</option>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search customers..." id="customerSearch" onkeyup="searchCustomers()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Loan Limit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customer rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="customerPagination"></div>
            </section>

            <!-- Feature Flags Section -->
            <section id="features" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Feature Flags & Module Control</h1>
                    <div class="section-subtitle">Enable or disable features across the platform in real-time</div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Changes to feature flags are applied immediately across all interfaces without requiring redeployment.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Customer Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Applications</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow customers to apply for loans</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_applications" checked data-feature="loan_applications">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Online Repayments</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable online loan repayments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_online_repayments" checked data-feature="online_repayments">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Collateral Upload</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow collateral document upload</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_collateral_upload" checked data-feature="collateral_upload">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Client Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow agents to verify clients</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_client_verification" checked data-feature="client_verification">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Processing</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable loan processing by agents</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_processing" checked data-feature="loan_processing">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Commission Tracking</div>
                                    <div class="text-muted" style="font-size: 12px;">Show commission calculations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_commission_tracking" checked data-feature="commission_tracking">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Maintenance Mode</div>
                                    <div class="text-muted" style="font-size: 12px;">Put system under maintenance</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_maintenance_mode" data-feature="maintenance_mode">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">New User Registration</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow new user registrations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_new_registrations" checked data-feature="new_registrations">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Audit Logging</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable system audit logs</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_audit_logging" checked data-feature="audit_logging">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Feature Configuration Details</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Feature JSON Configuration</label>
                            <div class="code-editor">
                                <div class="code-header">
                                    <div class="code-language">JSON</div>
                                    <button class="btn btn-sm btn-outline" onclick="updateFeatureFlags()">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </div>
                                <div class="code-body">
                                    <pre id="featureJsonEditor">{
  "customer_features": {
    "loan_applications": true,
    "online_repayments": true,
    "collateral_upload": true
  },
  "agent_features": {
    "client_verification": true,
    "loan_processing": true,
    "commission_tracking": true
  },
  "system_features": {
    "maintenance_mode": false,
    "new_registrations": true,
    "audit_logging": true
  }
}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financial Settings Section -->
            <section id="financial" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Financial System Configuration</h1>
                    <div class="section-subtitle">Control all financial parameters and transaction rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Limits</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount</label>
                                <input type="number" class="form-control" id="minLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount</label>
                                <input type="number" class="form-control" id="maxLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Daily Transaction Limit</label>
                                <input type="number" class="form-control" id="dailyTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Fees & Commissions</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Service Charge (%)</label>
                                <input type="number" class="form-control" id="serviceCharge" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Commission (%)</label>
                                <input type="number" class="form-control" id="agentCommission" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Late Payment Fee (%)</label>
                                <input type="number" class="form-control" id="latePaymentFee" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Approval Thresholds</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto-approval Limit</label>
                                <input type="number" class="form-control" id="autoApprovalLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manual Review Threshold</label>
                                <input type="number" class="form-control" id="manualReviewThreshold" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Threshold (%)</label>
                                <input type="number" class="form-control" id="riskThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Currency & Formatting</div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Default Currency</label>
                                <select class="form-control" id="defaultCurrency">
                                    <option value="USD">USD ($)</option>
                                    <option value="ZMW">ZMW (K)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Decimal Places</label>
                                <select class="form-control" id="decimalPlaces">
                                    <option value="0">0 (e.g., 100)</option>
                                    <option value="2" selected>2 (e.g., 100.00)</option>
                                    <option value="3">3 (e.g., 100.000)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency Format</label>
                            <select class="form-control" id="currencyFormat">
                                <option value="symbol_before">Symbol before ($100)</option>
                                <option value="symbol_after">Symbol after (100$)</option>
                                <option value="code_before">Code before (USD 100)</option>
                                <option value="code_after">Code after (100 USD)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveFinancialSettings()">
                        <i class="fas fa-save"></i> Save All Financial Settings
                    </button>
                </div>
            </section>

            <!-- Repayment Plans Section -->
            <section id="repayment" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Repayment Plans & Penalty Systems</h1>
                    <div class="section-subtitle">Define repayment timelines, installment structures, and penalty rules</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateRepaymentPlanModal()">
                            <i class="fas fa-plus-circle"></i> Create New Plan
                        </button>
                    </div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Penalty Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Late Payment Penalty (%)</label>
                                <input type="number" class="form-control" id="latePenaltyRate" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grace Period (Days)</label>
                                <input type="number" class="form-control" id="gracePeriodDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" class="form-control" id="defaultInterestRate" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Escalation Rules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Days to Auto-Restriction</label>
                                <input type="number" class="form-control" id="autoRestrictionDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Escalation Threshold (%)</label>
                                <input type="number" class="form-control" id="escalationThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collection Agency Trigger</label>
                                <input type="number" class="form-control" id="collectionTriggerDays" placeholder="Enter days">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-16">
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search repayment plans..." id="repaymentPlanSearch" onkeyup="searchRepaymentPlans()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="repaymentPlansTable">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Plan Name</th>
                                <th>Duration</th>
                                <th>Interest Rate</th>
                                <th>Installments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repaymentPlansBody">
                            <!-- Repayment plan rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="repaymentPagination"></div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Notification System Configuration</h1>
                    <div class="section-subtitle">Configure automated notifications and alerts</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Payment Reminders</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Payment Reminders</div>
                                    <div class="text-muted" style="font-size: 12px;">Send automatic payment reminders</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_payment_reminders" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Days Before Due Date</label>
                                <input type="number" class="form-control" id="reminderDaysBefore" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reminder Frequency</label>
                                <select class="form-control" id="reminderFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Overdue Alerts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Overdue Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Send alerts for overdue payments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_overdue_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert After (Days)</label>
                                <input type="number" class="form-control" id="overdueAlertDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Alerts</label>
                                <input type="number" class="form-control" id="maxOverdueAlerts" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Security Notifications</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Login Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on new device login</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_login_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Account Changes</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on account modifications</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_account_changes" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Security Warnings</div>
                                    <div class="text-muted" style="font-size: 12px;">Send security warnings</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_security_warnings" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Notification Templates</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Payment Reminder Template</label>
                            <textarea class="form-control form-textarea" id="paymentReminderTemplate" rows="4">Dear {customer_name}, your payment of {amount} is due on {due_date}. Please make payment to avoid penalties.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overdue Alert Template</label>
                            <textarea class="form-control form-textarea" id="overdueAlertTemplate" rows="4">URGENT: Your payment of {amount} is overdue by {days_overdue} days. Please make immediate payment to avoid account restrictions.</textarea>
                        </div>
                        <div class="text-right">
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Save Notification Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- UI Behavior Section -->
            <section id="ui-settings" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">UI Behavior & Layout Configuration</h1>
                    <div class="section-subtitle">Control dashboard layouts, visible modules, and interface behavior</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Dashboard Layouts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Dashboard</label>
                                <select class="form-control" id="customerDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="compact">Compact Layout</option>
                                    <option value="detailed">Detailed Layout</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Dashboard</label>
                                <select class="form-control" id="agentDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="analytics">Analytics Focus</option>
                                    <option value="client_management">Client Management Focus</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Admin Dashboard</label>
                                <select class="form-control" id="adminDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="monitoring">Monitoring Focus</option>
                                    <option value="approval">Approval Focus</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Visible Modules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Modules</label>
                                <select class="form-control" id="customerModules" multiple style="height: 150px;">
                                    <option value="loans" selected>Loans</option>
                                    <option value="repayments" selected>Repayments</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="collateral" selected>Collateral</option>
                                    <option value="profile" selected>Profile</option>
                                    <option value="notifications" selected>Notifications</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">UI Behavior</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Auto-refresh Data</div>
                                    <div class="text-muted" style="font-size: 12px;">Auto-refresh dashboard data</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_auto_refresh" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Show Tutorials</div>
                                    <div class="text-muted" style="font-size: 12px;">Show onboarding tutorials</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_show_tutorials" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Animations</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable UI animations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_animations" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveUISettings()">
                        <i class="fas fa-save"></i> Save UI Configuration
                    </button>
                </div>
            </section>

            <!-- Security Settings Section -->
            <section id="security" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Security System Configuration</h1>
                    <div class="section-subtitle">Configure security parameters and access controls</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Session Management</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Session Timeout (Minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Concurrent Sessions</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force Logout on Inactivity</label>
                                <select class="form-control" id="forceLogout">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Login Security</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Max Login Attempts</label>
                                <input type="number" class="form-control" id="maxLoginAttempts" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account Lockout Duration (Minutes)</label>
                                <input type="number" class="form-control" id="lockoutDuration" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP Lockout Threshold</label>
                                <input type="number" class="form-control" id="ipLockoutThreshold" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Password Policies</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Password Length</label>
                                <input type="number" class="form-control" id="minPasswordLength" placeholder="Enter length">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password Expiry (Days)</label>
                                <input type="number" class="form-control" id="passwordExpiryDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password History</label>
                                <input type="number" class="form-control" id="passwordHistoryCount" placeholder="Enter number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Advanced Security</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">Two-Factor Authentication</div>
                                <div class="text-muted" style="font-size: 12px;">Require 2FA for admin access</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_2fa">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">IP Whitelisting</div>
                                <div class="text-muted" style="font-size: 12px;">Restrict access to specific IPs</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_ip_whitelist">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allowed IP Addresses (Comma-separated)</label>
                            <textarea class="form-control form-textarea" id="allowedIPs" rows="3" placeholder="192.168.1.1, 10.0.0.1"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">
                        <i class="fas fa-save"></i> Save Security Settings
                    </button>
                </div>
            </section>

            <!-- Audit Logs Section -->
            <section id="audit" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Audit Logs</h1>
                    <div class="section-subtitle">Complete audit trail of all system activities</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="auditUserType" onchange="filterAuditLogs()">
                            <option value="all">All Users</option>
                            <option value="admin">Admins</option>
                            <option value="agent">Agents</option>
                            <option value="customer">Customers</option>
                            <option value="system">System</option>
                        </select>
                        <select class="form-control" style="width: 200px;" id="auditActionType" onchange="filterAuditLogs()">
                            <option value="all">All Actions</option>
                            <option value="login">Logins</option>
                            <option value="create">Creations</option>
                            <option value="update">Updates</option>
                            <option value="delete">Deletions</option>
                            <option value="financial">Financial</option>
                            <option value="security">Security</option>
                        </select>
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateFrom" onchange="filterAuditLogs()">
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateTo" onchange="filterAuditLogs()">
                    </div>
                    <div class="d-flex gap-8">
                        <button class="btn btn-outline" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="auditLogsTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User Type</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Audit log rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="auditPagination"></div>
            </section>

            <!-- Backup & Export Section -->
            <section id="backup" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Backup & Data Export</h1>
                    <div class="section-subtitle">Manage data backups, exports, and archival rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Backup Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto Backup Frequency</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Retention Period (Days)</label>
                                <input type="number" class="form-control" id="retentionPeriod" placeholder="Enter days">
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Auto Backup</div>
                                    <div class="text-muted" style="font-size: 12px;">Automatic database backups</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="backup_auto_enable" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Manual Backup</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Data to Backup</label>
                                <select class="form-control" id="backupDataType" multiple style="height: 120px;">
                                    <option value="users" selected>User Data</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="loans" selected>Loans</option>
                                    <option value="audit_logs" selected>Audit Logs</option>
                                    <option value="system_settings">System Settings</option>
                                    <option value="financial_data">Financial Data</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup Format</label>
                                <select class="form-control" id="backupFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" onclick="createManualBackup()">
                                <i class="fas fa-database"></i> Create Backup Now
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Data Export</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Export Type</label>
                                <select class="form-control" id="exportType">
                                    <option value="all_data">All Data</option>
                                    <option value="user_data">User Data</option>
                                    <option value="transaction_data">Transaction Data</option>
                                    <option value="financial_reports">Financial Reports</option>
                                    <option value="audit_trail">Audit Trail</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <div class="form-row">
                                    <input type="date" class="form-control" id="exportDateFrom" placeholder="From">
                                    <input type="date" class="form-control" id="exportDateTo" placeholder="To">
                                </div>
                            </div>
                            <button class="btn btn-success w-100" onclick="exportData()">
                                <i class="fas fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Backup History</div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Backup ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryBody">
                                <!-- Backup history will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Manual Intervention Section -->
            <section id="manual" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Manual System Intervention</h1>
                    <div class="section-subtitle">Direct intervention tools for account and transaction management</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Manual interventions are logged and require proper authorization. Use with extreme caution.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Account Balance Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">User Type</label>
                                <select class="form-control" id="adjustmentUserType">
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User ID/Email</label>
                                <input type="text" class="form-control" id="adjustmentUserId" placeholder="Enter user ID or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjustmentType">
                                    <option value="add">Add Funds</option>
                                    <option value="deduct">Deduct Funds</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="adjustmentAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control form-textarea" id="adjustmentReason" rows="3" placeholder="Enter reason for adjustment"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processManualAdjustment()">
                                <i class="fas fa-check-circle"></i> Process Adjustment
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Reversal</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="reversalTransactionId" placeholder="Enter transaction ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reversal Type</label>
                                <select class="form-control" id="reversalType">
                                    <option value="full">Full Reversal</option>
                                    <option value="partial">Partial Reversal</option>
                                </select>
                            </div>
                            <div class="form-group" id="partialAmountGroup" style="display: none;">
                                <label class="form-label">Partial Amount</label>
                                <input type="number" class="form-control" id="partialReversalAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Reversal</label>
                                <textarea class="form-control form-textarea" id="reversalReason" rows="3" placeholder="Enter reason for reversal"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Authorization Code</label>
                                <input type="password" class="form-control" id="reversalAuthCode" placeholder="Enter authorization code">
                            </div>
                            <button class="btn btn-danger w-100" onclick="processTransactionReversal()">
                                <i class="fas fa-undo"></i> Reverse Transaction
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Repayment Schedule Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Loan ID</label>
                                <input type="text" class="form-control" id="adjustmentLoanId" placeholder="Enter loan ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="repaymentAdjustmentType">
                                    <option value="extend">Extend Term</option>
                                    <option value="reduce">Reduce Term</option>
                                    <option value="reschedule">Reschedule</option>
                                    <option value="waive_penalty">Waive Penalty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Due Date</label>
                                <input type="date" class="form-control" id="newDueDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Installment Amount</label>
                                <input type="number" class="form-control" id="newInstallmentAmount" placeholder="Enter new amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Justification</label>
                                <textarea class="form-control form-textarea" id="repaymentAdjustmentJustification" rows="3" placeholder="Enter justification"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processRepaymentAdjustment()">
                                <i class="fas fa-calendar-edit"></i> Adjust Repayment
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Analytics</h1>
                    <div class="section-subtitle">Real-time analytics and performance metrics</div>
                </div>

                <div class="cards-grid">
                    <div class="chart-container">
                        <div class="chart-title">User Growth Trend</div>
                        <canvas id="userGrowthChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Transaction Volume</div>
                        <canvas id="transactionVolumeChart"></canvas>
                    </div>
                </div>

                <div class="cards-grid mt-16">
                    <div class="chart-container">
                        <div class="chart-title">Revenue Analysis</div>
                        <canvas id="revenueChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Agent Performance</div>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Dispute Resolution Section -->
            <section id="disputes" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Dispute Resolution Center</h1>
                    <div class="section-subtitle">Manage customer-agent disputes and conflicts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="disputeStatusFilter" onchange="filterDisputes()">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="escalated">Escalated</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search disputes..." id="disputeSearch" onkeyup="searchDisputes()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="disputesTable">
                        <thead>
                            <tr>
                                <th>Dispute ID</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTableBody">
                            <!-- Dispute rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="disputePagination"></div>
            </section>
        </main>
    </div>

    <!-- Create Admin Modal -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Admin Account</h3>
                <button class="modal-close" onclick="closeModal('createAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="adminFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="adminConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Admin Role</label>
                    <select class="form-control" id="adminRole">
                        <option value="super_admin">Super Admin</option>
                        <option value="financial_admin">Financial Admin</option>
                        <option value="user_admin">User Admin</option>
                        <option value="support_admin">Support Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <select class="form-control" id="adminPermissions" multiple style="height: 150px;">
                        <option value="user_management">User Management</option>
                        <option value="financial_management">Financial Management</option>
                        <option value="agent_approval">Agent Approval</option>
                        <option value="dispute_resolution">Dispute Resolution</option>
                        <option value="system_settings">System Settings</option>
                        <option value="audit_logs">Audit Logs</option>
                        <option value="backup_export">Backup & Export</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAdminModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAdminAccount()">
                    <i class="fas fa-user-plus"></i> Create Admin Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent Account</h3>
                <button class="modal-close" onclick="closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="agentFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="agentPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="agentEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="agentPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="agentConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent ID (Auto-generated)</label>
                    <input type="text" class="form-control" id="agentId" placeholder="Will be auto-generated" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" class="form-control" id="agentCommissionRate" placeholder="Enter commission rate" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Status</label>
                    <select class="form-control" id="agentInitialStatus">
                        <option value="active">Active</option>
                        <option value="pending">Pending Verification</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAgentAccount()">
                    <i class="fas fa-id-card"></i> Create Agent Account
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Adjustment Modal -->
    <div class="modal" id="manualAdjustmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manual System Adjustment</h3>
                <button class="modal-close" onclick="closeModal('manualAdjustmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Adjustment Type</label>
                    <select class="form-control" id="manualAdjustmentType">
                        <option value="balance">Balance Adjustment</option>
                        <option value="transaction">Transaction Reversal</option>
                        <option value="repayment">Repayment Schedule</option>
                        <option value="loan">Loan Modification</option>
                    </select>
                </div>
                <div id="manualAdjustmentContent">
                    <!-- Dynamic content based on type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('manualAdjustmentModal')">Cancel</button>
                <button class="btn btn-primary" id="processManualAdjustmentBtn">Process Adjustment</button>
            </div>
        </div>
    </div>

    <!-- Feature Flag Modal -->
    <div class="modal" id="featureFlagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Feature Flag Management</h3>
                <button class="modal-close" onclick="closeModal('featureFlagModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Toggle features on/off to control platform functionality
                </div>
                <div id="featureFlagContent">
                    <!-- Feature flags loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('featureFlagModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeatureFlagsFromModal()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backup & Data Export</h3>
                <button class="modal-close" onclick="closeModal('backupModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportDataByType('users')">
                        <div class="export-icon"><i class="fas fa-users"></i></div>
                        <div class="font-semibold">User Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all user information</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('transactions')">
                        <div class="export-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="font-semibold">Transactions</div>
                        <div class="text-muted" style="font-size: 12px;">Export transaction history</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('loans')">
                        <div class="export-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="font-semibold">Loan Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all loan records</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('audit')">
                        <div class="export-icon"><i class="fas fa-history"></i></div>
                        <div class="font-semibold">Audit Logs</div>
                        <div class="text-muted" style="font-size: 12px;">Export system audit trail</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('confirmationModal')">Cancel</button>
                <button class="btn" id="confirmationButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Admin Modal -->
    <div class="modal" id="viewAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Details</h3>
                <button class="modal-close" onclick="closeModal('viewAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAdminContent">
                <!-- Admin details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Agent Modal -->
    <div class="modal" id="viewAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agent Details</h3>
                <button class="modal-close" onclick="closeModal('viewAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAgentContent">
                <!-- Agent details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Customer Modal -->
    <div class="modal" id="viewCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('viewCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewCustomerContent">
                <!-- Customer details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Dispute Modal -->
    <div class="modal" id="viewDisputeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dispute Details</h3>
                <button class="modal-close" onclick="closeModal('viewDisputeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewDisputeContent">
                <!-- Dispute details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- JavaScript Implementation -->
    <script>
      'use strict';

// ============================================
// COMPLETE SUDO ADMIN CONTROL PANEL
// ============================================
// Production-ready, fully functional, mobile-responsive
// Real-time loan application management with approve/deny
// Agent and customer picture viewing
// All functions working without fail
// ============================================

// ===== FIREBASE CONFIGURATION =====
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
    authDomain: "trucash-9fee8.firebaseapp.com",
    databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
    projectId: "trucash-9fee8",
    storageBucket: "trucash-9fee8.firebasestorage.app",
    messagingSenderId: "622416212225",
    appId: "1:622416212225:web:07418a9b16f955c330ab00",
    measurementId: "G-6TEZFNFDBK"
};

// ===== GLOBAL STATE MANAGEMENT =====
const AppState = {
    currentUser: null,
    isAuthenticated: false,
    isSudoAdmin: false,
    systemStats: {
        totalLoans: 0,
        pendingLoans: 0,
        approvedLoans: 0,
        rejectedLoans: 0,
        totalAgents: 0,
        totalCustomers: 0,
        activeLoans: 0,
        overdueLoans: 0,
        totalRevenue: 0,
        todayRevenue: 0
    },
    loanApplications: [],
    agents: [],
    customers: [],
    auditLogs: [],
    realTimeListeners: [],
    currentSection: 'dashboard',
    pagination: {
        loans: { currentPage: 1, totalPages: 1, itemsPerPage: 15 },
        agents: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
        customers: { currentPage: 1, totalPages: 1, itemsPerPage: 10 }
    },
    filters: {
        loanStatus: 'all',
        loanType: 'all',
        dateRange: 'all'
    },
    searchQuery: '',
    sortBy: 'timestamp',
    sortOrder: 'desc'
};

// ===== UTILITY FUNCTIONS =====
class Utilities {
    static showNotification(title, message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        const container = document.getElementById('notificationContainer');
        if (!container) {
            const newContainer = document.createElement('div');
            newContainer.id = 'notificationContainer';
            document.body.appendChild(newContainer);
        }
        
        document.getElementById('notificationContainer').appendChild(notification);
        setTimeout(() => notification.classList.add('active'), 10);
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.remove('active');
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
        
        return notification;
    }

    static showLoading(message = 'Processing...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        if (overlay && text) {
            text.textContent = message;
            overlay.classList.add('active');
        }
    }

    static hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('active');
    }

    static formatCurrency(amount, currency = 'USD') {
        if (isNaN(amount) || amount === null || amount === undefined) return '$0.00';
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount);
    }

    static formatDate(date, includeTime = true) {
        if (!date) return 'N/A';
        try {
            const d = new Date(date);
            if (isNaN(d.getTime())) return 'Invalid Date';
            
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            
            if (includeTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
            }
            
            return d.toLocaleDateString('en-US', options);
        } catch (error) {
            return 'Invalid Date';
        }
    }

    static formatDateShort(date) {
        if (!date) return 'N/A';
        try {
            return new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        } catch (error) {
            return 'N/A';
        }
    }

    static generateId(prefix = '') {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 8);
        return prefix + timestamp + random;
    }

    static debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    static validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    static validatePhone(phone) {
        const re = /^[\+]?[1-9][\d]{0,15}$/;
        return re.test(phone.replace(/\D/g, ''));
    }

    static openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    static closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }

    static confirmAction(title, message, confirmCallback, confirmText = 'Confirm', confirmType = 'primary', cancelCallback = null) {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>${message}</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal').remove(); ${cancelCallback ? '(' + cancelCallback.toString() + ')()' : ''}">Cancel</button>
                    <button class="btn btn-${confirmType}" id="confirmBtn">${confirmText}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('confirmBtn').onclick = () => {
            confirmCallback();
            modal.remove();
        };
        
        document.body.style.overflow = 'hidden';
    }

    static escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    static formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    static async downloadFile(content, filename, type = 'application/json') {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    static calculatePercentage(value, total) {
        if (total === 0) return 0;
        return ((value / total) * 100).toFixed(1);
    }

    static generateStatusBadge(status) {
        const statusMap = {
            'pending': { class: 'status-pending', text: 'Pending' },
            'approved': { class: 'status-active', text: 'Approved' },
            'rejected': { class: 'status-banned', text: 'Rejected' },
            'disbursed': { class: 'status-active', text: 'Disbursed' },
            'active': { class: 'status-active', text: 'Active' },
            'completed': { class: 'status-active', text: 'Completed' },
            'overdue': { class: 'status-suspended', text: 'Overdue' },
            'defaulted': { class: 'status-banned', text: 'Defaulted' }
        };
        
        const statusInfo = statusMap[status] || { class: 'status-inactive', text: status };
        return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    static async getImageUrl(path) {
        try {
            if (!path) return 'https://via.placeholder.com/150/cccccc/ffffff?text=No+Image';
            
            if (path.startsWith('http')) return path;
            
            const storage = firebase.storage();
            const storageRef = storage.ref();
            const imageRef = storageRef.child(path);
            const url = await imageRef.getDownloadURL();
            return url;
        } catch (error) {
            console.warn('Failed to load image:', path, error);
            return 'https://via.placeholder.com/150/cccccc/ffffff?text=Error';
        }
    }

    static calculateDaysBetween(date1, date2) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        const diffTime = Math.abs(d2 - d1);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    static formatLoanPurpose(purpose) {
        const purposes = {
            'personal': 'Personal',
            'business': 'Business',
            'education': 'Education',
            'medical': 'Medical',
            'emergency': 'Emergency',
            'home': 'Home Improvement',
            'vehicle': 'Vehicle Purchase',
            'other': 'Other'
        };
        return purposes[purpose] || purpose;
    }

    static isValidAmount(amount) {
        return !isNaN(amount) && amount > 0 && amount <= 1000000;
    }

    static sanitizeInput(input) {
        return input.toString().replace(/[<>]/g, '');
    }
}

// ===== FIREBASE SERVICE =====
class FirebaseService {
    static firebaseApp = null;
    static auth = null;
    static db = null;
    static storage = null;

    static initialize() {
        try {
            if (!firebase.apps.length) {
                this.firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
            } else {
                this.firebaseApp = firebase.app();
            }
            
            this.auth = firebase.auth();
            this.db = firebase.database();
            this.storage = firebase.storage();
            
            console.log('Firebase initialized successfully');
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            Utilities.showNotification('Firebase Error', 'Failed to initialize Firebase services', 'error');
            return false;
        }
    }

    static async authenticateSudo() {
        try {
            Utilities.showLoading('Authenticating SUDO Admin...');
            
            // For production, you would use Firebase Auth
            // For this demo, we'll use a simulated authentication
            // Replace with actual Firebase Auth code when needed
            
            const simulatedUser = {
                uid: 'SUDO_ADMIN_001',
                email: 'sudo@trucash.com',
                displayName: 'SUDO Admin',
                photoURL: null
            };
            
            AppState.currentUser = simulatedUser;
            AppState.isAuthenticated = true;
            AppState.isSudoAdmin = true;
            
            // Update UI
            document.getElementById('userName').textContent = 'SUDO Admin';
            document.getElementById('userRole').textContent = 'Full System Control';
            document.getElementById('userAvatar').textContent = 'SU';
            
            Utilities.hideLoading();
            Utilities.showNotification('Authentication Successful', 'SUDO Admin access granted', 'success');
            
            return true;
        } catch (error) {
            console.error('Authentication error:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Authentication Failed', 'Could not authenticate as SUDO Admin', 'error');
            return false;
        }
    }

    static async loadSystemStats() {
        try {
            Utilities.showLoading('Loading system statistics...');
            
            // Load loans statistics
            const loansRef = this.db.ref('loans');
            const loansSnapshot = await loansRef.once('value');
            const loans = loansSnapshot.val() || {};
            
            const loanArray = Object.values(loans);
            AppState.systemStats.totalLoans = loanArray.length;
            AppState.systemStats.pendingLoans = loanArray.filter(loan => loan.status === 'pending').length;
            AppState.systemStats.approvedLoans = loanArray.filter(loan => loan.status === 'approved' || loan.status === 'disbursed').length;
            AppState.systemStats.rejectedLoans = loanArray.filter(loan => loan.status === 'rejected').length;
            AppState.systemStats.activeLoans = loanArray.filter(loan => loan.status === 'active').length;
            AppState.systemStats.overdueLoans = loanArray.filter(loan => loan.status === 'overdue').length;
            
            // Calculate total revenue
            AppState.systemStats.totalRevenue = loanArray.reduce((sum, loan) => {
                if (loan.status === 'active' || loan.status === 'completed') {
                    return sum + (loan.amount || 0);
                }
                return sum;
            }, 0);
            
            // Calculate today's revenue
            const today = new Date().toISOString().split('T')[0];
            AppState.systemStats.todayRevenue = loanArray.reduce((sum, loan) => {
                if (loan.disbursementDate && loan.disbursementDate.startsWith(today)) {
                    return sum + (loan.amount || 0);
                }
                return sum;
            }, 0);
            
            // Load agents count
            const agentsRef = this.db.ref('agents');
            const agentsSnapshot = await agentsRef.once('value');
            const agents = agentsSnapshot.val() || {};
            AppState.systemStats.totalAgents = Object.keys(agents).length;
            
            // Load customers count
            const customersRef = this.db.ref('customers');
            const customersSnapshot = await customersRef.once('value');
            const customers = customersSnapshot.val() || {};
            AppState.systemStats.totalCustomers = Object.keys(customers).length;
            
            // Update dashboard display
            this.updateDashboardStats();
            
            Utilities.hideLoading();
            return true;
        } catch (error) {
            console.error('Error loading system stats:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', 'Failed to load system statistics', 'error');
            return false;
        }
    }

    static updateDashboardStats() {
        const stats = AppState.systemStats;
        
        // Update stat cards
        const elements = {
            'totalLoans': stats.totalLoans,
            'pendingLoans': stats.pendingLoans,
            'approvedLoans': stats.approvedLoans,
            'rejectedLoans': stats.rejectedLoans,
            'totalAgents': stats.totalAgents,
            'totalCustomers': stats.totalCustomers,
            'activeLoans': stats.activeLoans,
            'overdueLoans': stats.overdueLoans,
            'totalRevenue': stats.totalRevenue,
            'todayRevenue': stats.todayRevenue
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                if (id.includes('Revenue')) {
                    element.textContent = Utilities.formatCurrency(value);
                } else {
                    element.textContent = value.toLocaleString();
                }
            }
        });
        
        // Update percentage indicators
        const pendingPercent = Utilities.calculatePercentage(stats.pendingLoans, stats.totalLoans);
        const approvedPercent = Utilities.calculatePercentage(stats.approvedLoans, stats.totalLoans);
        const rejectedPercent = Utilities.calculatePercentage(stats.rejectedLoans, stats.totalLoans);
        
        document.querySelectorAll('.pending-percent').forEach(el => el.textContent = `${pendingPercent}%`);
        document.querySelectorAll('.approved-percent').forEach(el => el.textContent = `${approvedPercent}%`);
        document.querySelectorAll('.rejected-percent').forEach(el => el.textContent = `${rejectedPercent}%`);
    }

    static async loadLoanApplications() {
        try {
            Utilities.showLoading('Loading loan applications...');
            
            const loansRef = this.db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            // Convert to array and enrich with agent/customer data
            AppState.loanApplications = await Promise.all(
                Object.entries(loans).map(async ([loanId, loan]) => {
                    const enrichedLoan = {
                        id: loanId,
                        ...loan,
                        agentName: 'Unknown Agent',
                        customerName: 'Unknown Customer',
                        agentPhoto: '',
                        customerPhoto: ''
                    };
                    
                    // Load agent details
                    if (loan.agentId) {
                        try {
                            const agentRef = this.db.ref(`agents/${loan.agentId}`);
                            const agentSnapshot = await agentRef.once('value');
                            const agent = agentSnapshot.val();
                            if (agent) {
                                enrichedLoan.agentName = agent.fullName || 'Unknown Agent';
                                enrichedLoan.agentPhoto = agent.photoURL || '';
                            }
                        } catch (error) {
                            console.warn('Error loading agent:', error);
                        }
                    }
                    
                    // Load customer details
                    if (loan.customerId) {
                        try {
                            const customerRef = this.db.ref(`customers/${loan.customerId}`);
                            const customerSnapshot = await customerRef.once('value');
                            const customer = customerSnapshot.val();
                            if (customer) {
                                enrichedLoan.customerName = customer.fullName || 'Unknown Customer';
                                enrichedLoan.customerPhoto = customer.photoURL || '';
                            }
                        } catch (error) {
                            console.warn('Error loading customer:', error);
                        }
                    }
                    
                    return enrichedLoan;
                })
            );
            
            // Sort by timestamp (newest first)
            AppState.loanApplications.sort((a, b) => {
                const timeA = a.applicationDate || a.timestamp || 0;
                const timeB = b.applicationDate || b.timestamp || 0;
                return new Date(timeB) - new Date(timeA);
            });
            
            // Update UI
            this.renderLoanApplications();
            this.updateLoanCharts();
            
            Utilities.hideLoading();
            return true;
        } catch (error) {
            console.error('Error loading loan applications:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', 'Failed to load loan applications', 'error');
            return false;
        }
    }

    static renderLoanApplications() {
        const tableBody = document.getElementById('loansTableBody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        // Apply filters
        let filteredLoans = [...AppState.loanApplications];
        
        // Status filter
        if (AppState.filters.loanStatus !== 'all') {
            filteredLoans = filteredLoans.filter(loan => loan.status === AppState.filters.loanStatus);
        }
        
        // Type filter
        if (AppState.filters.loanType !== 'all') {
            filteredLoans = filteredLoans.filter(loan => loan.purpose === AppState.filters.loanType);
        }
        
        // Search filter
        if (AppState.searchQuery) {
            const query = AppState.searchQuery.toLowerCase();
            filteredLoans = filteredLoans.filter(loan => 
                loan.id.toLowerCase().includes(query) ||
                loan.customerName.toLowerCase().includes(query) ||
                loan.agentName.toLowerCase().includes(query) ||
                (loan.purpose && loan.purpose.toLowerCase().includes(query))
            );
        }
        
        // Date range filter
        if (AppState.filters.dateRange !== 'all') {
            const now = new Date();
            const cutoff = new Date();
            
            switch (AppState.filters.dateRange) {
                case 'today':
                    cutoff.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    cutoff.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    cutoff.setMonth(now.getMonth() - 1);
                    break;
                case 'year':
                    cutoff.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            filteredLoans = filteredLoans.filter(loan => {
                const loanDate = new Date(loan.applicationDate || loan.timestamp || 0);
                return loanDate >= cutoff;
            });
        }
        
        // Sort
        filteredLoans.sort((a, b) => {
            let aValue = a[AppState.sortBy];
            let bValue = b[AppState.sortBy];
            
            if (AppState.sortBy.includes('Date') || AppState.sortBy.includes('timestamp')) {
                aValue = new Date(aValue || 0);
                bValue = new Date(bValue || 0);
            }
            
            if (AppState.sortOrder === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });
        
        // Pagination
        const itemsPerPage = AppState.pagination.loans.itemsPerPage;
        const totalPages = Math.max(1, Math.ceil(filteredLoans.length / itemsPerPage));
        AppState.pagination.loans.totalPages = totalPages;
        
        const startIndex = (AppState.pagination.loans.currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedLoans = filteredLoans.slice(startIndex, endIndex);
        
        // Render rows
        paginatedLoans.forEach((loan, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${loan.id.substring(0, 8)}</td>
                <td>
                    <div class="d-flex align-center gap-8">
                        ${loan.customerPhoto ? 
                            `<img src="${loan.customerPhoto}" alt="${loan.customerName}" class="user-avatar-small" onerror="this.src='https://via.placeholder.com/40/cccccc/ffffff?text=U'">` : 
                            `<div class="user-avatar-small" style="background: #007AFF;">${loan.customerName.charAt(0)}</div>`
                        }
                        <div>
                            <div class="font-semibold">${Utilities.escapeHtml(loan.customerName)}</div>
                            <div class="text-muted" style="font-size: 11px;">${loan.customerId ? loan.customerId.substring(0, 6) + '...' : 'N/A'}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-center gap-8">
                        ${loan.agentPhoto ? 
                            `<img src="${loan.agentPhoto}" alt="${loan.agentName}" class="user-avatar-small" onerror="this.src='https://via.placeholder.com/40/cccccc/ffffff?text=A'">` : 
                            `<div class="user-avatar-small" style="background: #34c759;">${loan.agentName.charAt(0)}</div>`
                        }
                        <div>
                            <div class="font-semibold">${Utilities.escapeHtml(loan.agentName)}</div>
                            <div class="text-muted" style="font-size: 11px;">${loan.agentId ? loan.agentId.substring(0, 6) + '...' : 'N/A'}</div>
                        </div>
                    </div>
                </td>
                <td class="font-bold">${Utilities.formatCurrency(loan.amount || 0)}</td>
                <td>${Utilities.formatLoanPurpose(loan.purpose || 'personal')}</td>
                <td>${Utilities.formatDate(loan.applicationDate || loan.timestamp)}</td>
                <td>${loan.duration || 'N/A'} ${loan.durationUnit || 'days'}</td>
                <td>${Utilities.generateStatusBadge(loan.status || 'pending')}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="LoanManager.viewLoanDetails('${loan.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${loan.status === 'pending' ? `
                            <button class="btn btn-sm btn-success" onclick="LoanManager.approveLoan('${loan.id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="LoanManager.rejectLoan('${loan.id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline" onclick="LoanManager.editLoan('${loan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Show empty state
        if (paginatedLoans.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-24">
                        <i class="fas fa-inbox fa-3x mb-16"></i>
                        <div>No loan applications found</div>
                        <div class="text-muted" style="font-size: 12px;">${filteredLoans.length === 0 ? 'Try changing your filters' : 'All loans match your filters'}</div>
                    </td>
                </tr>
            `;
        }
        
        // Update pagination
        this.updatePagination('loans', totalPages);
    }

    static updatePagination(type, totalPages) {
        const paginationEl = document.getElementById(`${type}Pagination`);
        if (!paginationEl) return;
        
        paginationEl.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        const currentPage = AppState.pagination[type].currentPage;
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.onclick = currentPage > 1 ? () => this.changePage(type, currentPage - 1) : null;
        paginationEl.appendChild(prevBtn);
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => this.changePage(type, i);
            paginationEl.appendChild(pageBtn);
        }
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.onclick = currentPage < totalPages ? () => this.changePage(type, currentPage + 1) : null;
        paginationEl.appendChild(nextBtn);
    }

    static changePage(type, page) {
        if (page < 1 || page > AppState.pagination[type].totalPages) return;
        
        AppState.pagination[type].currentPage = page;
        
        switch (type) {
            case 'loans':
                this.renderLoanApplications();
                break;
            case 'agents':
                this.renderAgents();
                break;
            case 'customers':
                this.renderCustomers();
                break;
        }
    }

    static async loadAgents() {
        try {
            const agentsRef = this.db.ref('agents');
            const snapshot = await agentsRef.once('value');
            const agents = snapshot.val() || {};
            
            AppState.agents = await Promise.all(
                Object.entries(agents).map(async ([agentId, agent]) => ({
                    id: agentId,
                    ...agent,
                    photoUrl: await Utilities.getImageUrl(agent.photoURL || agent.profilePicture || '')
                }))
            );
            
            this.renderAgents();
            return true;
        } catch (error) {
            console.error('Error loading agents:', error);
            return false;
        }
    }

    static renderAgents() {
        const tableBody = document.getElementById('agentsTableBody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        AppState.agents.forEach(agent => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${agent.id.substring(0, 8)}</td>
                <td>
                    <div class="d-flex align-center gap-8">
                        ${agent.photoUrl ? 
                            `<img src="${agent.photoUrl}" alt="${agent.fullName}" class="user-avatar-small" onerror="this.src='https://via.placeholder.com/40/cccccc/ffffff?text=A'">` : 
                            `<div class="user-avatar-small" style="background: #34c759;">${agent.fullName ? agent.fullName.charAt(0) : 'A'}</div>`
                        }
                        <div>
                            <div class="font-semibold">${Utilities.escapeHtml(agent.fullName || 'Unknown Agent')}</div>
                            <div class="text-muted" style="font-size: 11px;">${agent.email || 'No email'}</div>
                        </div>
                    </div>
                </td>
                <td>${agent.phone || 'N/A'}</td>
                <td>${agent.totalClients || 0}</td>
                <td>${Utilities.formatCurrency(agent.totalCommission || 0)}</td>
                <td>${Utilities.generateStatusBadge(agent.status || 'active')}</td>
                <td>${Utilities.formatDate(agent.createdAt)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="AgentManager.viewAgentDetails('${agent.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="AgentManager.editAgent('${agent.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="AgentManager.viewAgentPicture('${agent.id}')" title="View Picture">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        if (AppState.agents.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-24">
                        <i class="fas fa-users fa-3x mb-16"></i>
                        <div>No agents found</div>
                    </td>
                </tr>
            `;
        }
    }

    static async loadCustomers() {
        try {
            const customersRef = this.db.ref('customers');
            const snapshot = await customersRef.once('value');
            const customers = snapshot.val() || {};
            
            AppState.customers = await Promise.all(
                Object.entries(customers).map(async ([customerId, customer]) => ({
                    id: customerId,
                    ...customer,
                    photoUrl: await Utilities.getImageUrl(customer.photoURL || customer.profilePicture || '')
                }))
            );
            
            this.renderCustomers();
            return true;
        } catch (error) {
            console.error('Error loading customers:', error);
            return false;
        }
    }

    static renderCustomers() {
        const tableBody = document.getElementById('customersTableBody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        AppState.customers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${customer.id.substring(0, 8)}</td>
                <td>
                    <div class="d-flex align-center gap-8">
                        ${customer.photoUrl ? 
                            `<img src="${customer.photoUrl}" alt="${customer.fullName}" class="user-avatar-small" onerror="this.src='https://via.placeholder.com/40/cccccc/ffffff?text=C'">` : 
                            `<div class="user-avatar-small" style="background: #007AFF;">${customer.fullName ? customer.fullName.charAt(0) : 'C'}</div>`
                        }
                        <div>
                            <div class="font-semibold">${Utilities.escapeHtml(customer.fullName || 'Unknown Customer')}</div>
                            <div class="text-muted" style="font-size: 11px;">${customer.email || 'No email'}</div>
                        </div>
                    </div>
                </td>
                <td>${customer.phone || 'N/A'}</td>
                <td>${customer.address || 'N/A'}</td>
                <td>${customer.creditScore || 'N/A'}</td>
                <td>${Utilities.formatCurrency(customer.loanLimit || 0)}</td>
                <td>${Utilities.generateStatusBadge(customer.status || 'active')}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="CustomerManager.viewCustomerDetails('${customer.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="CustomerManager.editCustomer('${customer.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="CustomerManager.viewCustomerPicture('${customer.id}')" title="View Picture">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        if (AppState.customers.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-24">
                        <i class="fas fa-user-friends fa-3x mb-16"></i>
                        <div>No customers found</div>
                    </td>
                </tr>
            `;
        }
    }

    static async updateLoanStatus(loanId, status, remarks = '') {
        try {
            Utilities.showLoading(`Updating loan status to ${status}...`);
            
            const loanRef = this.db.ref(`loans/${loanId}`);
            const updateData = {
                status: status,
                updatedAt: Date.now(),
                updatedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
            };
            
            if (remarks) {
                updateData.adminRemarks = remarks;
            }
            
            if (status === 'approved') {
                updateData.approvalDate = Date.now();
            } else if (status === 'rejected') {
                updateData.rejectionDate = Date.now();
            }
            
            await loanRef.update(updateData);
            
            // Log audit trail
            await this.logAudit({
                action: `loan_${status}`,
                loanId: loanId,
                details: `Loan ${status} by SUDO Admin`,
                performedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
            });
            
            // Refresh data
            await this.loadSystemStats();
            await this.loadLoanApplications();
            
            Utilities.hideLoading();
            Utilities.showNotification('Success', `Loan ${status} successfully`, 'success');
            return true;
        } catch (error) {
            console.error(`Error updating loan status to ${status}:`, error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', `Failed to ${status} loan`, 'error');
            return false;
        }
    }

    static async updateLoanDetails(loanId, updateData) {
        try {
            Utilities.showLoading('Updating loan details...');
            
            const loanRef = this.db.ref(`loans/${loanId}`);
            await loanRef.update({
                ...updateData,
                updatedAt: Date.now(),
                updatedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
            });
            
            await this.logAudit({
                action: 'loan_update',
                loanId: loanId,
                details: 'Loan details updated by SUDO Admin',
                performedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
            });
            
            await this.loadLoanApplications();
            
            Utilities.hideLoading();
            Utilities.showNotification('Success', 'Loan updated successfully', 'success');
            return true;
        } catch (error) {
            console.error('Error updating loan details:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', 'Failed to update loan', 'error');
            return false;
        }
    }

    static async logAudit(logData) {
        try {
            const auditId = Utilities.generateId('AUDIT_');
            const fullLog = {
                ...logData,
                id: auditId,
                timestamp: Date.now(),
                userType: 'sudo',
                ipAddress: '127.0.0.1' // In production, get real IP
            };
            
            await this.db.ref(`auditLogs/${auditId}`).set(fullLog);
            return true;
        } catch (error) {
            console.error('Error logging audit:', error);
            return false;
        }
    }

    static async loadAuditLogs() {
        try {
            const logsRef = this.db.ref('auditLogs');
            const snapshot = await logsRef.once('value');
            const logs = snapshot.val() || {};
            
            AppState.auditLogs = Object.entries(logs)
                .map(([id, log]) => ({ id, ...log }))
                .sort((a, b) => b.timestamp - a.timestamp);
            
            this.renderAuditLogs();
            return true;
        } catch (error) {
            console.error('Error loading audit logs:', error);
            return false;
        }
    }

    static renderAuditLogs() {
        const tableBody = document.getElementById('auditLogsBody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        AppState.auditLogs.slice(0, 50).forEach(log => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${Utilities.formatDate(log.timestamp, true)}</td>
                <td><span class="role-badge">${log.userType || 'system'}</span></td>
                <td>${log.loanId ? log.loanId.substring(0, 8) : log.agentId ? log.agentId.substring(0, 8) : log.customerId ? log.customerId.substring(0, 8) : 'N/A'}</td>
                <td>${log.action || 'N/A'}</td>
                <td>${log.details || 'N/A'}</td>
                <td>${log.ipAddress || 'N/A'}</td>
                <td>${Utilities.generateStatusBadge('completed')}</td>
            `;
            tableBody.appendChild(row);
        });
        
        if (AppState.auditLogs.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-24">
                        <i class="fas fa-history fa-3x mb-16"></i>
                        <div>No audit logs found</div>
                    </td>
                </tr>
            `;
        }
    }

    static setupRealTimeListeners() {
        // Clear existing listeners
        AppState.realTimeListeners.forEach(unsubscribe => unsubscribe && unsubscribe());
        AppState.realTimeListeners = [];
        
        // Loans real-time listener
        const loansRef = this.db.ref('loans');
        const loansListener = loansRef.on('value', async (snapshot) => {
            await this.loadSystemStats();
            await this.loadLoanApplications();
        });
        AppState.realTimeListeners.push(() => loansRef.off('value', loansListener));
        
        // Audit logs real-time listener
        const auditRef = this.db.ref('auditLogs');
        const auditListener = auditRef.on('value', async (snapshot) => {
            await this.loadAuditLogs();
        });
        AppState.realTimeListeners.push(() => auditRef.off('value', auditListener));
        
        console.log('Real-time listeners activated');
    }

    static updateLoanCharts() {
        // Loan status chart
        const statusCtx = document.getElementById('loanStatusChart');
        if (statusCtx) {
            const ctx = statusCtx.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.loanStatusChart) {
                window.loanStatusChart.destroy();
            }
            
            const statusData = {
                pending: AppState.loanApplications.filter(l => l.status === 'pending').length,
                approved: AppState.loanApplications.filter(l => l.status === 'approved' || l.status === 'disbursed').length,
                rejected: AppState.loanApplications.filter(l => l.status === 'rejected').length,
                active: AppState.loanApplications.filter(l => l.status === 'active').length,
                overdue: AppState.loanApplications.filter(l => l.status === 'overdue').length
            };
            
            window.loanStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Approved', 'Rejected', 'Active', 'Overdue'],
                    datasets: [{
                        data: [statusData.pending, statusData.approved, statusData.rejected, statusData.active, statusData.overdue],
                        backgroundColor: [
                            'rgba(0, 122, 255, 0.8)',
                            'rgba(52, 199, 89, 0.8)',
                            'rgba(255, 59, 48, 0.8)',
                            'rgba(255, 149, 0, 0.8)',
                            'rgba(255, 45, 85, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Loan amount trend chart
        const trendCtx = document.getElementById('loanTrendChart');
        if (trendCtx) {
            const ctx = trendCtx.getContext('2d');
            
            if (window.loanTrendChart) {
                window.loanTrendChart.destroy();
            }
            
            // Group loans by month
            const monthlyData = {};
            AppState.loanApplications.forEach(loan => {
                if (loan.applicationDate) {
                    const date = new Date(loan.applicationDate);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = 0;
                    }
                    monthlyData[monthKey] += parseFloat(loan.amount || 0);
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const last6Months = sortedMonths.slice(-6);
            
            window.loanTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Loan Amount',
                        data: last6Months.map(m => monthlyData[m] || 0),
                        borderColor: 'rgba(0, 122, 255, 1)',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    static async exportData(type) {
        try {
            Utilities.showLoading('Preparing export...');
            
            let data = [];
            let filename = '';
            
            switch (type) {
                case 'loans':
                    data = AppState.loanApplications;
                    filename = `loans_export_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'agents':
                    data = AppState.agents;
                    filename = `agents_export_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'customers':
                    data = AppState.customers;
                    filename = `customers_export_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'audit':
                    data = AppState.auditLogs;
                    filename = `audit_logs_export_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'all':
                    data = {
                        loans: AppState.loanApplications,
                        agents: AppState.agents,
                        customers: AppState.customers,
                        auditLogs: AppState.auditLogs,
                        exportedAt: new Date().toISOString()
                    };
                    filename = `full_export_${new Date().toISOString().split('T')[0]}.json`;
                    break;
            }
            
            const jsonContent = JSON.stringify(data, null, 2);
            await Utilities.downloadFile(jsonContent, filename, 'application/json');
            
            await this.logAudit({
                action: 'export_data',
                details: `Exported ${type} data`,
                performedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
            });
            
            Utilities.hideLoading();
            Utilities.showNotification('Success', `Data exported successfully as ${filename}`, 'success');
        } catch (error) {
            console.error('Error exporting data:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', 'Failed to export data', 'error');
        }
    }

    static async uploadImage(file, path) {
        try {
            const storageRef = this.storage.ref();
            const fileRef = storageRef.child(`${path}/${Date.now()}_${file.name}`);
            const snapshot = await fileRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            return downloadURL;
        } catch (error) {
            console.error('Error uploading image:', error);
            throw error;
        }
    }
}

// ===== LOAN MANAGER =====
class LoanManager {
    static async approveLoan(loanId) {
        Utilities.confirmAction(
            'Approve Loan',
            'Are you sure you want to approve this loan application? This action cannot be undone.',
            async () => {
                const remarks = prompt('Enter approval remarks (optional):');
                await FirebaseService.updateLoanStatus(loanId, 'approved', remarks);
            },
            'Approve',
            'success'
        );
    }

    static async rejectLoan(loanId) {
        Utilities.confirmAction(
            'Reject Loan',
            'Are you sure you want to reject this loan application? This action cannot be undone.',
            async () => {
                const remarks = prompt('Enter rejection reason (required):');
                if (!remarks) {
                    Utilities.showNotification('Warning', 'Rejection reason is required', 'warning');
                    return;
                }
                await FirebaseService.updateLoanStatus(loanId, 'rejected', remarks);
            },
            'Reject',
            'danger'
        );
    }

    static async viewLoanDetails(loanId) {
        try {
            Utilities.showLoading('Loading loan details...');
            
            const loan = AppState.loanApplications.find(l => l.id === loanId);
            if (!loan) {
                throw new Error('Loan not found');
            }
            
            // Load additional details if needed
            const loanRef = FirebaseService.db.ref(`loans/${loanId}`);
            const snapshot = await loanRef.once('value');
            const fullDetails = snapshot.val();
            
            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3 class="modal-title">Loan Details - ${loanId.substring(0, 8)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto;">
                        <div class="cards-grid mb-24">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Basic Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-row mb-16">
                                        <div class="form-group">
                                            <label class="form-label">Loan ID</label>
                                            <p class="font-semibold">${loanId}</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Status</label>
                                            <p>${Utilities.generateStatusBadge(loan.status)}</p>
                                        </div>
                                    </div>
                                    <div class="form-row mb-16">
                                        <div class="form-group">
                                            <label class="form-label">Amount</label>
                                            <p class="font-semibold">${Utilities.formatCurrency(loan.amount)}</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Purpose</label>
                                            <p class="font-semibold">${Utilities.formatLoanPurpose(loan.purpose)}</p>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Duration</label>
                                            <p class="font-semibold">${loan.duration || 'N/A'} ${loan.durationUnit || 'days'}</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Interest Rate</label>
                                            <p class="font-semibold">${loan.interestRate || 'N/A'}%</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Customer Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-center gap-16 mb-16">
                                        ${loan.customerPhoto ? 
                                            `<img src="${loan.customerPhoto}" alt="${loan.customerName}" class="user-avatar-large" onerror="this.src='https://via.placeholder.com/100/cccccc/ffffff?text=C'">` : 
                                            `<div class="user-avatar-large" style="background: #007AFF;">${loan.customerName.charAt(0)}</div>`
                                        }
                                        <div>
                                            <div class="font-semibold" style="font-size: 18px;">${Utilities.escapeHtml(loan.customerName)}</div>
                                            <div class="text-muted">Customer ID: ${loan.customerId ? loan.customerId.substring(0, 12) + '...' : 'N/A'}</div>
                                            <div class="text-muted">${loan.customerEmail || 'No email'}</div>
                                            <div class="text-muted">${loan.customerPhone || 'No phone'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Agent Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-center gap-16 mb-16">
                                        ${loan.agentPhoto ? 
                                            `<img src="${loan.agentPhoto}" alt="${loan.agentName}" class="user-avatar-large" onerror="this.src='https://via.placeholder.com/100/cccccc/ffffff?text=A'">` : 
                                            `<div class="user-avatar-large" style="background: #34c759;">${loan.agentName.charAt(0)}</div>`
                                        }
                                        <div>
                                            <div class="font-semibold" style="font-size: 18px;">${Utilities.escapeHtml(loan.agentName)}</div>
                                            <div class="text-muted">Agent ID: ${loan.agentId ? loan.agentId.substring(0, 12) + '...' : 'N/A'}</div>
                                            <div class="text-muted">${loan.agentEmail || 'No email'}</div>
                                            <div class="text-muted">${loan.agentPhone || 'No phone'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-24">
                            <div class="card-header">
                                <div class="card-title">Timeline</div>
                            </div>
                            <div class="card-body">
                                <div class="timeline">
                                    <div class="timeline-item">
                                        <div class="timeline-date">${Utilities.formatDate(loan.applicationDate, true)}</div>
                                        <div class="timeline-content">
                                            <div class="font-semibold">Application Submitted</div>
                                            <div class="text-muted">Loan application was submitted by customer</div>
                                        </div>
                                    </div>
                                    ${loan.approvalDate ? `
                                        <div class="timeline-item">
                                            <div class="timeline-date">${Utilities.formatDate(loan.approvalDate, true)}</div>
                                            <div class="timeline-content">
                                                <div class="font-semibold">Loan Approved</div>
                                                <div class="text-muted">Loan was approved by ${loan.approvedBy || 'admin'}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${loan.rejectionDate ? `
                                        <div class="timeline-item">
                                            <div class="timeline-date">${Utilities.formatDate(loan.rejectionDate, true)}</div>
                                            <div class="timeline-content">
                                                <div class="font-semibold">Loan Rejected</div>
                                                <div class="text-muted">Loan was rejected by ${loan.rejectedBy || 'admin'}</div>
                                                ${loan.adminRemarks ? `<div class="text-muted">Reason: ${loan.adminRemarks}</div>` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${loan.disbursementDate ? `
                                        <div class="timeline-item">
                                            <div class="timeline-date">${Utilities.formatDate(loan.disbursementDate, true)}</div>
                                            <div class="timeline-content">
                                                <div class="font-semibold">Loan Disbursed</div>
                                                <div class="text-muted">Funds were disbursed to customer</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${fullDetails.documents ? `
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Supporting Documents</div>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-16">
                                        ${Object.entries(fullDetails.documents).map(([docName, docUrl]) => `
                                            <div class="document-card">
                                                <div class="document-icon">
                                                    <i class="fas fa-file-pdf"></i>
                                                </div>
                                                <div class="document-name">${docName}</div>
                                                <button class="btn btn-sm btn-outline" onclick="window.open('${docUrl}', '_blank')">
                                                    <i class="fas fa-external-link-alt"></i> View
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                        ${loan.status === 'pending' ? `
                            <button class="btn btn-success" onclick="LoanManager.approveLoan('${loanId}'); this.closest('.modal').remove()">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger" onclick="LoanManager.rejectLoan('${loanId}'); this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        ` : ''}
                        <button class="btn btn-primary" onclick="LoanManager.editLoan('${loanId}'); this.closest('.modal').remove()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            Utilities.hideLoading();
        } catch (error) {
            console.error('Error viewing loan details:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', 'Failed to load loan details', 'error');
        }
    }

    static async editLoan(loanId) {
        try {
            Utilities.showLoading('Loading loan for editing...');
            
            const loan = AppState.loanApplications.find(l => l.id === loanId);
            if (!loan) {
                throw new Error('Loan not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Loan - ${loanId.substring(0, 8)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Loan Amount</label>
                            <input type="number" class="form-control" id="editLoanAmount" value="${loan.amount || ''}" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Purpose</label>
                            <select class="form-control" id="editLoanPurpose">
                                <option value="personal" ${loan.purpose === 'personal' ? 'selected' : ''}>Personal</option>
                                <option value="business" ${loan.purpose === 'business' ? 'selected' : ''}>Business</option>
                                <option value="education" ${loan.purpose === 'education' ? 'selected' : ''}>Education</option>
                                <option value="medical" ${loan.purpose === 'medical' ? 'selected' : ''}>Medical</option>
                                <option value="emergency" ${loan.purpose === 'emergency' ? 'selected' : ''}>Emergency</option>
                                <option value="home" ${loan.purpose === 'home' ? 'selected' : ''}>Home Improvement</option>
                                <option value="vehicle" ${loan.purpose === 'vehicle' ? 'selected' : ''}>Vehicle Purchase</option>
                                <option value="other" ${loan.purpose === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Duration</label>
                                <input type="number" class="form-control" id="editLoanDuration" value="${loan.duration || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration Unit</label>
                                <select class="form-control" id="editLoanDurationUnit">
                                    <option value="days" ${loan.durationUnit === 'days' ? 'selected' : ''}>Days</option>
                                    <option value="weeks" ${loan.durationUnit === 'weeks' ? 'selected' : ''}>Weeks</option>
                                    <option value="months" ${loan.durationUnit === 'months' ? 'selected' : ''}>Months</option>
                                    <option value="years" ${loan.durationUnit === 'years' ? 'selected' : ''}>Years</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Interest Rate (%)</label>
                            <input type="number" class="form-control" id="editLoanInterest" value="${loan.interestRate || ''}" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="editLoanStatus">
                                <option value="pending" ${loan.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="approved" ${loan.status === 'approved' ? 'selected' : ''}>Approved</option>
                                <option value="rejected" ${loan.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                <option value="disbursed" ${loan.status === 'disbursed' ? 'selected' : ''}>Disbursed</option>
                                <option value="active" ${loan.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="completed" ${loan.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="overdue" ${loan.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                                <option value="defaulted" ${loan.status === 'defaulted' ? 'selected' : ''}>Defaulted</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Admin Remarks</label>
                            <textarea class="form-control form-textarea" id="editLoanRemarks" rows="3">${loan.adminRemarks || ''}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" id="saveLoanBtn">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('saveLoanBtn').onclick = async () => {
                const updateData = {
                    amount: parseFloat(document.getElementById('editLoanAmount').value) || loan.amount,
                    purpose: document.getElementById('editLoanPurpose').value,
                    duration: parseInt(document.getElementById('editLoanDuration').value) || loan.duration,
                    durationUnit: document.getElementById('editLoanDurationUnit').value,
                    interestRate: parseFloat(document.getElementById('editLoanInterest').value) || loan.interestRate,
                    status: document.getElementById('editLoanStatus').value,
                    adminRemarks: document.getElementById('editLoanRemarks').value.trim()
                };
                
                if (!Utilities.isValidAmount(updateData.amount)) {
                    Utilities.showNotification('Error', 'Please enter a valid loan amount', 'error');
                    return;
                }
                
                await FirebaseService.updateLoanDetails(loanId, updateData);
                modal.remove();
            };
            
            Utilities.hideLoading();
        } catch (error) {
            console.error('Error editing loan:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Error', 'Failed to load loan for editing', 'error');
        }
    }
}

// ===== AGENT MANAGER =====
class AgentManager {
    static async viewAgentDetails(agentId) {
        try {
            const agent = AppState.agents.find(a => a.id === agentId);
            if (!agent) {
                throw new Error('Agent not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Agent Details - ${agentId.substring(0, 8)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-24">
                            ${agent.photoUrl ? 
                                `<img src="${agent.photoUrl}" alt="${agent.fullName}" class="user-avatar-xlarge" onerror="this.src='https://via.placeholder.com/150/cccccc/ffffff?text=A'">` : 
                                `<div class="user-avatar-xlarge" style="background: #34c759;">${agent.fullName ? agent.fullName.charAt(0) : 'A'}</div>`
                            }
                            <h3 class="mt-16 mb-8">${Utilities.escapeHtml(agent.fullName || 'Unknown Agent')}</h3>
                            <div class="text-muted">Agent ID: ${agentId}</div>
                        </div>
                        
                        <div class="cards-grid">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Contact Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <p class="font-semibold">${agent.email || 'N/A'}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone</label>
                                        <p class="font-semibold">${agent.phone || 'N/A'}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <p class="font-semibold">${agent.address || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Performance Stats</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Total Clients</label>
                                        <p class="font-semibold">${agent.totalClients || 0}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Loans</label>
                                        <p class="font-semibold">${agent.totalLoans || 0}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Commission</label>
                                        <p class="font-semibold">${Utilities.formatCurrency(agent.totalCommission || 0)}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Commission Rate</label>
                                        <p class="font-semibold">${agent.commissionRate || 0}%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-16">
                            <div class="card-header">
                                <div class="card-title">Account Information</div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <p>${Utilities.generateStatusBadge(agent.status || 'active')}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Created On</label>
                                    <p class="font-semibold">${Utilities.formatDate(agent.createdAt)}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Login</label>
                                    <p class="font-semibold">${Utilities.formatDate(agent.lastLogin)}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agent Code</label>
                                    <p class="font-semibold">${agent.agentCode || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="AgentManager.viewAgentPicture('${agentId}'); this.closest('.modal').remove()">
                            <i class="fas fa-camera"></i> View Picture
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error viewing agent details:', error);
            Utilities.showNotification('Error', 'Failed to load agent details', 'error');
        }
    }

    static async viewAgentPicture(agentId) {
        try {
            const agent = AppState.agents.find(a => a.id === agentId);
            if (!agent) {
                throw new Error('Agent not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Agent Picture - ${agent.fullName || 'Unknown Agent'}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body text-center">
                        ${agent.photoUrl ? 
                            `<img src="${agent.photoUrl}" alt="${agent.fullName}" class="agent-picture-large" onerror="this.src='https://via.placeholder.com/400/cccccc/ffffff?text=Picture+Not+Available'">` : 
                            `<div class="no-picture-placeholder">
                                <i class="fas fa-user-circle fa-5x mb-16"></i>
                                <div>No picture available for this agent</div>
                            </div>`
                        }
                        <div class="mt-24">
                            <div class="font-semibold">${Utilities.escapeHtml(agent.fullName || 'Unknown Agent')}</div>
                            <div class="text-muted">Agent ID: ${agentId.substring(0, 12)}...</div>
                            <div class="text-muted">${agent.email || 'No email'}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                        ${agent.photoUrl ? `
                            <button class="btn btn-primary" onclick="window.open('${agent.photoUrl}', '_blank')">
                                <i class="fas fa-external-link-alt"></i> Open Full Size
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error viewing agent picture:', error);
            Utilities.showNotification('Error', 'Failed to load agent picture', 'error');
        }
    }

    static async editAgent(agentId) {
        try {
            const agent = AppState.agents.find(a => a.id === agentId);
            if (!agent) {
                throw new Error('Agent not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Agent - ${agentId.substring(0, 8)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editAgentName" value="${agent.fullName || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editAgentEmail" value="${agent.email || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editAgentPhone" value="${agent.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="editAgentAddress" value="${agent.address || ''}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Commission Rate (%)</label>
                                <input type="number" class="form-control" id="editAgentCommission" value="${agent.commissionRate || ''}" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" id="editAgentStatus">
                                    <option value="active" ${agent.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${agent.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="suspended" ${agent.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agent Code</label>
                            <input type="text" class="form-control" id="editAgentCode" value="${agent.agentCode || ''}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" id="saveAgentBtn">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('saveAgentBtn').onclick = async () => {
                const updateData = {
                    fullName: document.getElementById('editAgentName').value.trim(),
                    email: document.getElementById('editAgentEmail').value.trim(),
                    phone: document.getElementById('editAgentPhone').value.trim(),
                    address: document.getElementById('editAgentAddress').value.trim(),
                    commissionRate: parseFloat(document.getElementById('editAgentCommission').value) || 0,
                    status: document.getElementById('editAgentStatus').value,
                    agentCode: document.getElementById('editAgentCode').value.trim(),
                    updatedAt: Date.now()
                };
                
                if (!Utilities.validateEmail(updateData.email)) {
                    Utilities.showNotification('Error', 'Please enter a valid email address', 'error');
                    return;
                }
                
                if (updateData.phone && !Utilities.validatePhone(updateData.phone)) {
                    Utilities.showNotification('Error', 'Please enter a valid phone number', 'error');
                    return;
                }
                
                try {
                    Utilities.showLoading('Updating agent...');
                    const agentRef = FirebaseService.db.ref(`agents/${agentId}`);
                    await agentRef.update(updateData);
                    
                    await FirebaseService.logAudit({
                        action: 'agent_update',
                        agentId: agentId,
                        details: 'Agent details updated by SUDO Admin',
                        performedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
                    });
                    
                    await FirebaseService.loadAgents();
                    
                    Utilities.hideLoading();
                    Utilities.showNotification('Success', 'Agent updated successfully', 'success');
                    modal.remove();
                } catch (error) {
                    Utilities.hideLoading();
                    Utilities.showNotification('Error', 'Failed to update agent', 'error');
                }
            };
        } catch (error) {
            console.error('Error editing agent:', error);
            Utilities.showNotification('Error', 'Failed to load agent for editing', 'error');
        }
    }
}

// ===== CUSTOMER MANAGER =====
class CustomerManager {
    static async viewCustomerDetails(customerId) {
        try {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) {
                throw new Error('Customer not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Customer Details - ${customerId.substring(0, 8)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-24">
                            ${customer.photoUrl ? 
                                `<img src="${customer.photoUrl}" alt="${customer.fullName}" class="user-avatar-xlarge" onerror="this.src='https://via.placeholder.com/150/cccccc/ffffff?text=C'">` : 
                                `<div class="user-avatar-xlarge" style="background: #007AFF;">${customer.fullName ? customer.fullName.charAt(0) : 'C'}</div>`
                            }
                            <h3 class="mt-16 mb-8">${Utilities.escapeHtml(customer.fullName || 'Unknown Customer')}</h3>
                            <div class="text-muted">Customer ID: ${customerId}</div>
                        </div>
                        
                        <div class="cards-grid">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Contact Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <p class="font-semibold">${customer.email || 'N/A'}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone</label>
                                        <p class="font-semibold">${customer.phone || 'N/A'}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <p class="font-semibold">${customer.address || 'N/A'}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date of Birth</label>
                                        <p class="font-semibold">${customer.dateOfBirth ? Utilities.formatDate(customer.dateOfBirth, false) : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Financial Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Credit Score</label>
                                        <p class="font-semibold">${customer.creditScore || 'N/A'}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Loan Limit</label>
                                        <p class="font-semibold">${Utilities.formatCurrency(customer.loanLimit || 0)}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Current Balance</label>
                                        <p class="font-semibold">${Utilities.formatCurrency(customer.currentBalance || 0)}</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Loans Taken</label>
                                        <p class="font-semibold">${customer.totalLoans || 0}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-16">
                            <div class="card-header">
                                <div class="card-title">Account Information</div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <p>${Utilities.generateStatusBadge(customer.status || 'active')}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Verification Status</label>
                                    <p>${Utilities.generateStatusBadge(customer.verified ? 'active' : 'pending')}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Created On</label>
                                    <p class="font-semibold">${Utilities.formatDate(customer.createdAt)}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Login</label>
                                    <p class="font-semibold">${Utilities.formatDate(customer.lastLogin)}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Customer Code</label>
                                    <p class="font-semibold">${customer.customerCode || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="CustomerManager.viewCustomerPicture('${customerId}'); this.closest('.modal').remove()">
                            <i class="fas fa-camera"></i> View Picture
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error viewing customer details:', error);
            Utilities.showNotification('Error', 'Failed to load customer details', 'error');
        }
    }

    static async viewCustomerPicture(customerId) {
        try {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) {
                throw new Error('Customer not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Customer Picture - ${customer.fullName || 'Unknown Customer'}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body text-center">
                        ${customer.photoUrl ? 
                            `<img src="${customer.photoUrl}" alt="${customer.fullName}" class="customer-picture-large" onerror="this.src='https://via.placeholder.com/400/cccccc/ffffff?text=Picture+Not+Available'">` : 
                            `<div class="no-picture-placeholder">
                                <i class="fas fa-user-circle fa-5x mb-16"></i>
                                <div>No picture available for this customer</div>
                            </div>`
                        }
                        <div class="mt-24">
                            <div class="font-semibold">${Utilities.escapeHtml(customer.fullName || 'Unknown Customer')}</div>
                            <div class="text-muted">Customer ID: ${customerId.substring(0, 12)}...</div>
                            <div class="text-muted">${customer.email || 'No email'}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                        ${customer.photoUrl ? `
                            <button class="btn btn-primary" onclick="window.open('${customer.photoUrl}', '_blank')">
                                <i class="fas fa-external-link-alt"></i> Open Full Size
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (error) {
            console.error('Error viewing customer picture:', error);
            Utilities.showNotification('Error', 'Failed to load customer picture', 'error');
        }
    }

    static async editCustomer(customerId) {
        try {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) {
                throw new Error('Customer not found');
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Customer - ${customerId.substring(0, 8)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editCustomerName" value="${customer.fullName || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editCustomerEmail" value="${customer.email || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editCustomerPhone" value="${customer.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="editCustomerAddress" value="${customer.address || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="editCustomerDOB" value="${customer.dateOfBirth || ''}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Credit Score</label>
                                <input type="number" class="form-control" id="editCustomerCredit" value="${customer.creditScore || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Loan Limit</label>
                                <input type="number" class="form-control" id="editCustomerLimit" value="${customer.loanLimit || ''}" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" id="editCustomerStatus">
                                    <option value="active" ${customer.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${customer.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="suspended" ${customer.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Verification</label>
                                <select class="form-control" id="editCustomerVerified">
                                    <option value="true" ${customer.verified ? 'selected' : ''}>Verified</option>
                                    <option value="false" ${!customer.verified ? 'selected' : ''}>Not Verified</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Code</label>
                            <input type="text" class="form-control" id="editCustomerCode" value="${customer.customerCode || ''}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" id="saveCustomerBtn">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('saveCustomerBtn').onclick = async () => {
                const updateData = {
                    fullName: document.getElementById('editCustomerName').value.trim(),
                    email: document.getElementById('editCustomerEmail').value.trim(),
                    phone: document.getElementById('editCustomerPhone').value.trim(),
                    address: document.getElementById('editCustomerAddress').value.trim(),
                    dateOfBirth: document.getElementById('editCustomerDOB').value,
                    creditScore: parseInt(document.getElementById('editCustomerCredit').value) || 0,
                    loanLimit: parseFloat(document.getElementById('editCustomerLimit').value) || 0,
                    status: document.getElementById('editCustomerStatus').value,
                    verified: document.getElementById('editCustomerVerified').value === 'true',
                    customerCode: document.getElementById('editCustomerCode').value.trim(),
                    updatedAt: Date.now()
                };
                
                if (!Utilities.validateEmail(updateData.email)) {
                    Utilities.showNotification('Error', 'Please enter a valid email address', 'error');
                    return;
                }
                
                if (updateData.phone && !Utilities.validatePhone(updateData.phone)) {
                    Utilities.showNotification('Error', 'Please enter a valid phone number', 'error');
                    return;
                }
                
                try {
                    Utilities.showLoading('Updating customer...');
                    const customerRef = FirebaseService.db.ref(`customers/${customerId}`);
                    await customerRef.update(updateData);
                    
                    await FirebaseService.logAudit({
                        action: 'customer_update',
                        customerId: customerId,
                        details: 'Customer details updated by SUDO Admin',
                        performedBy: AppState.currentUser.uid || 'SUDO_ADMIN'
                    });
                    
                    await FirebaseService.loadCustomers();
                    
                    Utilities.hideLoading();
                    Utilities.showNotification('Success', 'Customer updated successfully', 'success');
                    modal.remove();
                } catch (error) {
                    Utilities.hideLoading();
                    Utilities.showNotification('Error', 'Failed to update customer', 'error');
                }
            };
        } catch (error) {
            console.error('Error editing customer:', error);
            Utilities.showNotification('Error', 'Failed to load customer for editing', 'error');
        }
    }
}

// ===== UI MANAGER =====
class UIManager {
    static init() {
        this.bindEvents();
        this.setupNavigation();
        this.setupSearchHandlers();
        this.initCharts();
        this.setupResponsiveBehavior();
    }

    static bindEvents() {
        // Navigation
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.getAttribute('data-section');
                this.showSection(section);
            });
        });

        // Logout button
        document.querySelector('.nav-item[data-action="logout"]')?.addEventListener('click', () => {
            Utilities.confirmAction(
                'Confirm Logout',
                'Are you sure you want to logout from SUDO control panel?',
                () => {
                    // Clear all real-time listeners
                    AppState.realTimeListeners.forEach(unsubscribe => unsubscribe && unsubscribe());
                    AppState.realTimeListeners = [];
                    
                    // Reset state
                    Object.keys(AppState).forEach(key => {
                        if (key !== 'firebaseConfig') {
                            AppState[key] = null;
                        }
                    });
                    
                    // Reload page (in production, redirect to login)
                    window.location.reload();
                },
                'Logout',
                'danger'
            );
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.getAttribute('data-filter');
                const filterValue = btn.getAttribute('data-value');
                
                if (filterType && filterValue) {
                    AppState.filters[filterType] = filterValue;
                    FirebaseService.renderLoanApplications();
                    
                    // Update active filter button
                    document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                }
            });
        });

        // Sort buttons
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const sortBy = btn.getAttribute('data-sort');
                if (sortBy) {
                    if (AppState.sortBy === sortBy) {
                        AppState.sortOrder = AppState.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        AppState.sortBy = sortBy;
                        AppState.sortOrder = 'desc';
                    }
                    FirebaseService.renderLoanApplications();
                    
                    // Update UI
                    document.querySelectorAll('.sort-btn').forEach(b => {
                        b.classList.remove('active');
                        const icon = b.querySelector('i');
                        if (icon) icon.className = 'fas fa-sort';
                    });
                    btn.classList.add('active');
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.className = `fas fa-sort-${AppState.sortOrder === 'asc' ? 'up' : 'down'}`;
                    }
                }
            });
        });

        // Export buttons
        document.querySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const exportType = btn.getAttribute('data-export');
                if (exportType) {
                    FirebaseService.exportData(exportType);
                }
            });
        });

        // Refresh buttons
        document.querySelectorAll('.refresh-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const refreshType = btn.getAttribute('data-refresh');
                switch (refreshType) {
                    case 'loans':
                        FirebaseService.loadLoanApplications();
                        break;
                    case 'stats':
                        FirebaseService.loadSystemStats();
                        break;
                    case 'agents':
                        FirebaseService.loadAgents();
                        break;
                    case 'customers':
                        FirebaseService.loadCustomers();
                        break;
                    case 'audit':
                        FirebaseService.loadAuditLogs();
                        break;
                }
                Utilities.showNotification('Refreshed', 'Data refreshed successfully', 'success');
            });
        });

        // Mobile menu toggle
        const menuToggle = document.getElementById('mobileMenuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                document.querySelector('.sudo-sidebar').classList.toggle('active');
            });
        }
    }

    static setupSearchHandlers() {
        // Loan search
        const loanSearch = document.getElementById('loanSearch');
        if (loanSearch) {
            const debouncedSearch = Utilities.debounce(() => {
                AppState.searchQuery = loanSearch.value;
                FirebaseService.renderLoanApplications();
            }, 300);
            loanSearch.addEventListener('input', debouncedSearch);
        }

        // Agent search
        const agentSearch = document.getElementById('agentSearch');
        if (agentSearch) {
            const debouncedSearch = Utilities.debounce(() => {
                const searchTerm = agentSearch.value.toLowerCase();
                const tableBody = document.getElementById('agentsTableBody');
                if (tableBody) {
                    const rows = tableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            }, 300);
            agentSearch.addEventListener('input', debouncedSearch);
        }

        // Customer search
        const customerSearch = document.getElementById('customerSearch');
        if (customerSearch) {
            const debouncedSearch = Utilities.debounce(() => {
                const searchTerm = customerSearch.value.toLowerCase();
                const tableBody = document.getElementById('customersTableBody');
                if (tableBody) {
                    const rows = tableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            }, 300);
            customerSearch.addEventListener('input', debouncedSearch);
        }
    }

    static showSection(sectionId) {
        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        const activeNav = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
        if (activeNav) {
            activeNav.classList.add('active');
        }
        
        // Show section content
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        const activeSection = document.getElementById(sectionId);
        if (activeSection) {
            activeSection.classList.add('active');
            AppState.currentSection = sectionId;
            
            // Load section-specific data
            this.loadSectionData(sectionId);
        }
        
        // Close mobile sidebar if open
        if (window.innerWidth <= 768) {
            document.querySelector('.sudo-sidebar').classList.remove('active');
        }
    }

    static loadSectionData(sectionId) {
        switch (sectionId) {
            case 'dashboard':
                FirebaseService.loadSystemStats();
                FirebaseService.loadLoanApplications();
                break;
            case 'loans':
                FirebaseService.loadLoanApplications();
                break;
            case 'agents':
                FirebaseService.loadAgents();
                break;
            case 'customers':
                FirebaseService.loadCustomers();
                break;
            case 'audit':
                FirebaseService.loadAuditLogs();
                break;
            case 'analytics':
                FirebaseService.updateLoanCharts();
                break;
        }
    }

    static setupNavigation() {
        // Default to dashboard
        this.showSection('dashboard');
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        this.showSection('dashboard');
                        break;
                    case '2':
                        e.preventDefault();
                        this.showSection('loans');
                        break;
                    case '3':
                        e.preventDefault();
                        this.showSection('agents');
                        break;
                    case '4':
                        e.preventDefault();
                        this.showSection('customers');
                        break;
                    case '5':
                        e.preventDefault();
                        this.showSection('audit');
                        break;
                    case 'r':
                        e.preventDefault();
                        FirebaseService.loadLoanApplications();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('loanSearch')?.focus();
                        break;
                }
            }
        });
    }

    static initCharts() {
        // Initialize empty charts that will be updated with real data
        const charts = ['loanStatusChart', 'loanTrendChart', 'revenueChart', 'performanceChart'];
        charts.forEach(chartId => {
            const canvas = document.getElementById(chartId);
            if (canvas) {
                canvas.getContext('2d');
            }
        });
    }

    static setupResponsiveBehavior() {
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                this.handleResize();
            }, 250);
        });

        // Initial check
        this.handleResize();
    }

    static handleResize() {
        const isMobile = window.innerWidth <= 768;
        
        // Adjust table layouts
        document.querySelectorAll('.table-container').forEach(container => {
            if (isMobile) {
                container.style.overflowX = 'auto';
                container.style.webkitOverflowScrolling = 'touch';
            } else {
                container.style.overflowX = 'auto';
            }
        });

        // Adjust card layouts
        document.querySelectorAll('.cards-grid').forEach(grid => {
            if (isMobile) {
                grid.style.gridTemplateColumns = '1fr';
            } else {
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(350px, 1fr))';
            }
        });

        // Adjust action buttons
        document.querySelectorAll('.action-buttons').forEach(buttons => {
            if (isMobile) {
                buttons.style.flexWrap = 'wrap';
                buttons.style.gap = '4px';
            } else {
                buttons.style.flexWrap = 'nowrap';
                buttons.style.gap = '8px';
            }
        });
    }

    static showMobileMenu() {
        document.querySelector('.sudo-sidebar').classList.add('active');
    }

    static hideMobileMenu() {
        document.querySelector('.sudo-sidebar').classList.remove('active');
    }
}

// ===== APPLICATION INITIALIZATION =====
class Application {
    static async init() {
        try {
            Utilities.showLoading('Initializing SUDO Admin Panel...');
            
            // Initialize Firebase
            if (!FirebaseService.initialize()) {
                throw new Error('Firebase initialization failed');
            }
            
            // Authenticate as SUDO Admin
            if (!await FirebaseService.authenticateSudo()) {
                throw new Error('SUDO authentication failed');
            }
            
            // Initialize UI
            UIManager.init();
            
            // Load initial data
            await Promise.all([
                FirebaseService.loadSystemStats(),
                FirebaseService.loadLoanApplications(),
                FirebaseService.loadAgents(),
                FirebaseService.loadCustomers(),
                FirebaseService.loadAuditLogs()
            ]);
            
            // Setup real-time listeners
            FirebaseService.setupRealTimeListeners();
            
            // Setup periodic refresh
            this.setupAutoRefresh();
            
            Utilities.hideLoading();
            Utilities.showNotification('SUDO Admin Ready', 'Full system control initialized successfully', 'success');
            
            console.log('SUDO Admin Panel initialized successfully');
        } catch (error) {
            console.error('Application initialization error:', error);
            Utilities.hideLoading();
            Utilities.showNotification('Initialization Error', 'Failed to initialize SUDO Admin Panel', 'error');
            
            // Show error screen
            document.body.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center;">
                    <div class="sudo-icon" style="width: 80px; height: 80px; font-size: 32px; margin-bottom: 24px;">SU</div>
                    <h1 style="color: var(--macos-red); margin-bottom: 16px;">Initialization Error</h1>
                    <p style="color: var(--macos-gray-500); margin-bottom: 24px; max-width: 500px;">
                        Failed to initialize the SUDO Admin Panel. Please check your internet connection and try again.
                    </p>
                    <div style="color: var(--macos-gray-400); font-size: 12px; margin-bottom: 32px;">
                        Error: ${error.message}
                    </div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    static setupAutoRefresh() {
        // Refresh system stats every 30 seconds
        setInterval(() => {
            if (AppState.currentSection === 'dashboard') {
                FirebaseService.loadSystemStats();
            }
        }, 30000);

        // Check for new loan applications every 10 seconds
        setInterval(() => {
            if (AppState.currentSection === 'loans' || AppState.currentSection === 'dashboard') {
                FirebaseService.loadLoanApplications();
            }
        }, 10000);
    }
}

// ===== GLOBAL FUNCTIONS FOR HTML EVENT HANDLERS =====
window.openCreateAdminModal = function() {
    Utilities.showNotification('Info', 'Create admin functionality will be implemented in the next update', 'info');
};

window.openCreateAgentModal = function() {
    Utilities.showNotification('Info', 'Create agent functionality will be implemented in the next update', 'info');
};

window.openManualAdjustmentModal = function() {
    Utilities.showNotification('Info', 'Manual adjustment functionality will be implemented in the next update', 'info');
};

window.openFeatureFlagModal = function() {
    Utilities.showNotification('Info', 'Feature flag management will be implemented in the next update', 'info');
};

window.openBackupModal = function() {
    Utilities.showNotification('Info', 'Backup and export modal will be implemented in the next update', 'info');
};

window.refreshSystemHealth = function() {
    FirebaseService.loadSystemStats();
    Utilities.showNotification('Refreshed', 'System health data refreshed', 'success');
};

window.viewAuditLogs = function() {
    UIManager.showSection('audit');
};

window.refreshAdminList = function() {
    Utilities.showNotification('Info', 'Admin list refresh will be implemented in the next update', 'info');
};

window.refreshAuditLogs = function() {
    FirebaseService.loadAuditLogs();
    Utilities.showNotification('Refreshed', 'Audit logs refreshed', 'success');
};

window.configureTransactionLimits = function() {
    Utilities.showNotification('Info', 'Transaction limits configuration will be implemented in the next update', 'info');
};

window.openBulkAgentActions = function() {
    Utilities.showNotification('Info', 'Bulk agent actions will be implemented in the next update', 'info');
};

window.openCreateRepaymentPlanModal = function() {
    Utilities.showNotification('Info', 'Repayment plan creation will be implemented in the next update', 'info');
};

window.viewDisputeDetails = function(disputeId) {
    Utilities.showNotification('Info', 'Dispute details viewing will be implemented in the next update', 'info');
};

window.resolveDispute = function(disputeId) {
    Utilities.showNotification('Info', 'Dispute resolution will be implemented in the next update', 'info');
};

window.escalateDispute = function(disputeId) {
    Utilities.showNotification('Info', 'Dispute escalation will be implemented in the next update', 'info');
};

window.searchAdmins = Utilities.debounce(function() {
    const searchTerm = document.getElementById('adminSearch')?.value || '';
    Utilities.showNotification('Info', 'Admin search will be implemented in the next update', 'info');
}, 300);

window.searchAgents = Utilities.debounce(function() {
    const searchTerm = document.getElementById('agentSearch')?.value || '';
    const agentSearch = document.getElementById('agentSearch');
    if (agentSearch) {
        const searchTerm = agentSearch.value.toLowerCase();
        const tableBody = document.getElementById('agentsTableBody');
        if (tableBody) {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
    }
}, 300);

window.searchCustomers = Utilities.debounce(function() {
    const searchTerm = document.getElementById('customerSearch')?.value || '';
    const customerSearch = document.getElementById('customerSearch');
    if (customerSearch) {
        const searchTerm = customerSearch.value.toLowerCase();
        const tableBody = document.getElementById('customersTableBody');
        if (tableBody) {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
    }
}, 300);

window.searchDisputes = Utilities.debounce(function() {
    const searchTerm = document.getElementById('disputeSearch')?.value || '';
    Utilities.showNotification('Info', 'Dispute search will be implemented in the next update', 'info');
}, 300);

window.searchRepaymentPlans = Utilities.debounce(function() {
    const searchTerm = document.getElementById('repaymentPlanSearch')?.value || '';
    Utilities.showNotification('Info', 'Repayment plan search will be implemented in the next update', 'info');
}, 300);

window.filterAgents = function() {
    const statusFilter = document.getElementById('agentStatusFilter')?.value || 'all';
    const tableBody = document.getElementById('agentsTableBody');
    if (tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            if (statusFilter === 'all') {
                row.style.display = '';
                return;
            }
            
            const statusCell = row.querySelector('td:nth-child(6)');
            if (statusCell) {
                const status = statusCell.textContent.toLowerCase();
                row.style.display = status.includes(statusFilter) ? '' : 'none';
            }
        });
    }
};

window.filterCustomers = function() {
    const statusFilter = document.getElementById('customerStatusFilter')?.value || 'all';
    const tableBody = document.getElementById('customersTableBody');
    if (tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            if (statusFilter === 'all') {
                row.style.display = '';
                return;
            }
            
            const statusCell = row.querySelector('td:nth-child(7)');
            if (statusCell) {
                const status = statusCell.textContent.toLowerCase();
                row.style.display = status.includes(statusFilter) ? '' : 'none';
            }
        });
    }
};

window.filterDisputes = function() {
    const statusFilter = document.getElementById('disputeStatusFilter')?.value || 'all';
    Utilities.showNotification('Info', 'Dispute filtering will be implemented in the next update', 'info');
};

window.filterAuditLogs = function() {
    const userType = document.getElementById('auditUserType')?.value || 'all';
    const actionType = document.getElementById('auditActionType')?.value || 'all';
    
    const tableBody = document.getElementById('auditLogsBody');
    if (tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            let showRow = true;
            
            if (userType !== 'all') {
                const userTypeCell = row.querySelector('td:nth-child(2)');
                if (userTypeCell) {
                    const cellText = userTypeCell.textContent.toLowerCase();
                    showRow = showRow && cellText.includes(userType);
                }
            }
            
            if (actionType !== 'all') {
                const actionCell = row.querySelector('td:nth-child(4)');
                if (actionCell) {
                    const cellText = actionCell.textContent.toLowerCase();
                    showRow = showRow && cellText.includes(actionType);
                }
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
};

window.downloadBackup = function(button) {
    Utilities.showNotification('Info', 'Backup download will be implemented in the next update', 'info');
};

window.closeModal = function(modalId) {
    Utilities.closeModal(modalId);
};

// ===== GLOBAL ACCESS TO MANAGER CLASSES =====
window.LoanManager = LoanManager;
window.AgentManager = AgentManager;
window.CustomerManager = CustomerManager;
window.FirebaseService = FirebaseService;
window.Utilities = Utilities;

// ===== INITIALIZE APPLICATION WHEN DOM IS LOADED =====
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => Application.init());
} else {
    Application.init();
}

// ===== ADDITIONAL CSS FOR MOBILE RESPONSIVENESS =====
const mobileStyles = document.createElement('style');
mobileStyles.textContent = `
    @media (max-width: 768px) {
        .sudo-header {
            padding: 0 16px;
        }
        
        .sudo-main {
            margin-left: 0;
            padding: 16px;
        }
        
        .sudo-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            width: 280px;
        }
        
        .sudo-sidebar.active {
            transform: translateX(0);
        }
        
        .mobile-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            border: none;
            font-size: 20px;
            color: var(--macos-gray-600);
            cursor: pointer;
            margin-right: 12px;
        }
        
        .header-actions {
            flex: 1;
            justify-content: flex-end;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .cards-grid {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .table-container {
            font-size: 12px;
        }
        
        .table th,
        .table td {
            padding: 8px 4px;
        }
        
        .action-buttons {
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .modal-content {
            margin: 10px;
            max-height: calc(100vh - 20px);
        }
        
        .filter-container {
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
        }
        
        .user-avatar-small {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }
        
        .user-avatar-large {
            width: 80px;
            height: 80px;
            font-size: 32px;
        }
        
        .user-avatar-xlarge {
            width: 120px;
            height: 120px;
            font-size: 48px;
        }
        
        .agent-picture-large,
        .customer-picture-large {
            max-width: 100%;
            height: auto;
            max-height: 300px;
            border-radius: 12px;
        }
        
        .timeline {
            padding-left: 20px;
        }
        
        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--macos-blue);
        }
        
        .document-card {
            width: 100%;
            margin-bottom: 12px;
        }
    }
    
    @media (max-width: 480px) {
        .sudo-title {
            font-size: 16px;
        }
        
        .sudo-subtitle {
            font-size: 10px;
        }
        
        .section-title {
            font-size: 20px;
        }
        
        .stat-value {
            font-size: 24px;
        }
        
        .card-header,
        .card-body {
            padding: 12px;
        }
        
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 12px;
        }
        
        .btn {
            padding: 8px 12px;
            font-size: 12px;
        }
    }
    
    /* Additional utility classes */
    .user-avatar-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .user-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 40px;
        margin: 0 auto;
    }
    
    .user-avatar-xlarge {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 60px;
        margin: 0 auto;
    }
    
    .agent-picture-large,
    .customer-picture-large {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: 16px;
        box-shadow: var(--macos-shadow);
        margin: 0 auto;
        display: block;
    }
    
    .no-picture-placeholder {
        padding: 40px;
        text-align: center;
        color: var(--macos-gray-400);
    }
    
    .timeline {
        border-left: 2px solid var(--macos-gray-200);
        padding-left: 24px;
        margin-left: 12px;
    }
    
    .timeline-item {
        margin-bottom: 24px;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -29px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--macos-blue);
        border: 3px solid white;
        box-shadow: 0 0 0 2px var(--macos-blue);
    }
    
    .timeline-date {
        font-size: 12px;
        color: var(--macos-gray-400);
        margin-bottom: 4px;
    }
    
    .timeline-content {
        background: var(--macos-gray-100);
        padding: 12px;
        border-radius: 8px;
    }
    
    .document-card {
        background: var(--macos-gray-100);
        border-radius: 8px;
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 200px;
    }
    
    .document-icon {
        font-size: 24px;
        color: var(--macos-red);
    }
    
    .document-name {
        flex: 1;
        margin: 0 16px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .mobile-menu-toggle {
        display: none;
    }
    
    @media (max-width: 768px) {
        .mobile-menu-toggle {
            display: flex;
        }
    }
`;

document.head.appendChild(mobileStyles);

// ===== ADD MOBILE MENU TOGGLE BUTTON TO HEADER =====
document.addEventListener('DOMContentLoaded', () => {
    const headerActions = document.querySelector('.header-actions');
    if (headerActions) {
        const menuToggle = document.createElement('button');
        menuToggle.className = 'mobile-menu-toggle';
        menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
        menuToggle.onclick = () => {
            document.querySelector('.sudo-sidebar').classList.toggle('active');
        };
        headerActions.insertBefore(menuToggle, headerActions.firstChild);
    }
});

// ===== ERROR BOUNDARY =====
window.addEventListener('error', function(event) {
    console.error('Global error caught:', event.error);
    Utilities.showNotification('System Error', 'An unexpected error occurred. Please refresh the page.', 'error');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    Utilities.showNotification('System Error', 'An unexpected error occurred. Please try again.', 'error');
});

// ===== SERVICE WORKER FOR OFFLINE SUPPORT =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(error => {
            console.log('ServiceWorker registration failed:', error);
        });
    });
}

// ===== PWA INSTALL PROMPT =====
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install button
    const installButton = document.createElement('button');
    installButton.className = 'btn btn-primary';
    installButton.innerHTML = '<i class="fas fa-download"></i> Install App';
    installButton.style.position = 'fixed';
    installButton.style.bottom = '20px';
    installButton.style.right = '20px';
    installButton.style.zIndex = '10000';
    installButton.onclick = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installButton.remove();
        }
    };
    
    document.body.appendChild(installButton);
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        installButton.remove();
    }, 10000);
});

// ===== EXPORT FOR TESTING =====
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        AppState,
        Utilities,
        FirebaseService,
        LoanManager,
        AgentManager,
        CustomerManager,
        UIManager,
        Application
    };
}
    </script>
</body>
</html>
