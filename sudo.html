<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | SUDO Super Control Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse for CSV Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== macOS Theme CSS Reset ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
                       'Helvetica Neue', 'Segoe UI', Roboto, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --macos-gray-100: #f5f5f7;
            --macos-gray-200: #e5e5e7;
            --macos-gray-300: #d2d2d7;
            --macos-gray-400: #86868b;
            --macos-gray-500: #515154;
            --macos-gray-600: #1d1d1f;
            --macos-blue: #007AFF;
            --macos-blue-light: #409cff;
            --macos-blue-dark: #0056cc;
            --macos-green: #34c759;
            --macos-red: #ff3b30;
            --macos-purple: #5856d6;
            --macos-yellow: #ffcc00;
            --macos-orange: #ff9500;
            --macos-pink: #ff2d55;
            --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --macos-shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
            --macos-shadow-light: 0 2px 6px rgba(0, 0, 0, 0.04);
            --macos-border-radius: 12px;
            --macos-border-radius-small: 8px;
            --macos-border-radius-large: 16px;
            --macos-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --macos-glass: rgba(255, 255, 255, 0.85);
            --macos-glass-border: rgba(255, 255, 255, 0.2);
            --macos-danger-bg: rgba(255, 59, 48, 0.1);
            --macos-warning-bg: rgba(255, 204, 0, 0.1);
            --macos-success-bg: rgba(52, 199, 89, 0.1);
            --macos-info-bg: rgba(0, 122, 255, 0.1);
            --macos-sidebar-width: 280px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--macos-gray-600);
            min-height: 100vh;
            line-height: 1.4;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(at 10% 20%, rgba(120, 119, 198, 0.03) 0px, transparent 50%),
                radial-gradient(at 90% 10%, rgba(0, 122, 255, 0.03) 0px, transparent 50%),
                radial-gradient(at 50% 90%, rgba(76, 175, 80, 0.03) 0px, transparent 50%);
            z-index: -1;
        }

        /* ===== SUDO Header ===== */
        .sudo-header {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--macos-glass-border);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--macos-shadow-light);
        }

        .sudo-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sudo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--macos-red) 0%, var(--macos-orange) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .sudo-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--macos-gray-600);
            letter-spacing: -0.3px;
        }

        .sudo-subtitle {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .live-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            background: var(--macos-success-bg);
            color: var(--macos-green);
            border-radius: 20px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--macos-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* ===== Main Layout ===== */
        .sudo-container {
            display: flex;
            min-height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* ===== Sidebar Navigation ===== */
        .sudo-sidebar {
            width: var(--macos-sidebar-width);
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--macos-glass-border);
            padding: 24px 0;
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 900;
        }

        .nav-section {
            margin-bottom: 24px;
            padding: 0 20px;
        }

        .nav-title {
            font-size: 11px;
            color: var(--macos-gray-400);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--macos-gray-500);
            text-decoration: none;
            border-radius: var(--macos-border-radius);
            transition: var(--macos-transition);
            margin-bottom: 4px;
            cursor: pointer;
            user-select: none;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--macos-gray-600);
        }

        .nav-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .nav-item.active .nav-icon {
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-gray-400);
        }

        .nav-text {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 600;
        }

        /* ===== Main Content ===== */
        .sudo-main {
            flex: 1;
            margin-left: var(--macos-sidebar-width);
            padding: 24px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-gray-600);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--macos-gray-400);
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            transition: var(--macos-transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.users { background: var(--macos-info-bg); color: var(--macos-blue); }
        .stat-icon.agents { background: var(--macos-success-bg); color: var(--macos-green); }
        .stat-icon.transactions { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .stat-icon.revenue { background: var(--macos-danger-bg); color: var(--macos-red); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-gray-600);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--macos-gray-400);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--macos-green);
        }

        .stat-change.negative {
            color: var(--macos-red);
        }

        /* ===== Cards Grid ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius-large);
            overflow: hidden;
            transition: var(--macos-transition);
        }

        .card:hover {
            box-shadow: var(--macos-shadow);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* ===== Form Elements ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: 1px solid var(--macos-gray-200);
            border-radius: var(--macos-border-radius-small);
            background: rgba(255, 255, 255, 0.9);
            transition: var(--macos-transition);
            color: var(--macos-gray-600);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }

        .form-control::placeholder {
            color: var(--macos-gray-400);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* ===== Tables ===== */
        .table-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: rgba(0, 0, 0, 0.02);
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table td {
            padding: 16px;
            font-size: 13px;
            color: var(--macos-gray-600);
            border-bottom: 1px solid var(--macos-gray-200);
        }

        .table tbody tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
        }

        .status-active { background: var(--macos-success-bg); color: var(--macos-green); }
        .status-inactive { background: var(--macos-gray-200); color: var(--macos-gray-500); }
        .status-suspended { background: var(--macos-warning-bg); color: var(--macos-yellow); }
        .status-banned { background: var(--macos-danger-bg); color: var(--macos-red); }
        .status-pending { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
            background: var(--macos-info-bg);
            color: var(--macos-blue);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 10px 18px;
            border-radius: var(--macos-border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--macos-transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-blue-light) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--macos-blue-dark) 0%, var(--macos-blue) 100%);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--macos-red) 0%, #ff5a5a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #cc2e25 0%, var(--macos-red) 100%);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.35);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--macos-green) 0%, #2db867 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, var(--macos-green) 100%);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.35);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--macos-gray-300);
            color: var(--macos-gray-600);
        }

        .btn-outline:hover {
            background: rgba(0, 0, 0, 0.03);
            border-color: var(--macos-gray-400);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== Toggle Switches ===== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--macos-gray-300);
            transition: var(--macos-transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--macos-transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--macos-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ===== Charts ===== */
        .chart-container {
            background: var(--macos-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--macos-glass-border);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-600);
            margin-bottom: 16px;
        }

        /* ===== Modals ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: var(--macos-border-radius-large);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-heavy);
            border: 1px solid var(--macos-glass-border);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-gray-600);
        }

        .modal-close {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            font-size: 16px;
            color: var(--macos-gray-500);
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--macos-transition);
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== Loading Overlay ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-200);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--macos-gray-600);
            font-weight: 500;
        }

        /* ===== Notifications ===== */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--macos-border-radius);
            background: var(--macos-glass);
            backdrop-filter: blur(40px);
            box-shadow: var(--macos-shadow-heavy);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1500;
            transform: translateX(calc(100% + 24px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 320px;
            border: 1px solid var(--macos-glass-border);
        }

        .notification.active {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--macos-green);
        }

        .notification.error {
            border-left: 4px solid var(--macos-red);
        }

        .notification.info {
            border-left: 4px solid var(--macos-blue);
        }

        .notification.warning {
            border-left: 4px solid var(--macos-yellow);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success .notification-icon {
            color: var(--macos-green);
        }

        .notification.error .notification-icon {
            color: var(--macos-red);
        }

        .notification.info .notification-icon {
            color: var(--macos-blue);
        }

        .notification.warning .notification-icon {
            color: var(--macos-yellow);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
            color: var(--macos-gray-600);
        }

        .notification-message {
            font-size: 12px;
            color: var(--macos-gray-500);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--macos-gray-400);
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--macos-transition);
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--macos-gray-600);
        }

        /* ===== Code Editor ===== */
        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .code-header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .code-language {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
        }

        .code-body {
            padding: 16px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-body pre {
            margin: 0;
        }

        /* ===== Alert Boxes ===== */
        .alert {
            padding: 16px;
            border-radius: var(--macos-border-radius);
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-danger {
            background: var(--macos-danger-bg);
            border-left-color: var(--macos-red);
            color: var(--macos-red);
        }

        .alert-warning {
            background: var(--macos-warning-bg);
            border-left-color: var(--macos-yellow);
            color: var(--macos-yellow);
        }

        .alert-success {
            background: var(--macos-success-bg);
            border-left-color: var(--macos-green);
            color: var(--macos-green);
        }

        .alert-info {
            background: var(--macos-info-bg);
            border-left-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sudo-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sudo-sidebar.active {
                transform: translateX(0);
            }

            .sudo-main {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sudo-header {
                padding: 0 16px;
            }

            .sudo-main {
                padding: 16px;
            }

            .card-header, .card-body {
                padding: 16px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* ===== Utility Classes ===== */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }
        .w-100 { width: 100%; }
        .mt-16 { margin-top: 16px; }
        .mb-16 { margin-bottom: 16px; }
        .mb-24 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--macos-gray-400); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-yellow); }
        .text-info { color: var(--macos-blue); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }

        /* ===== Custom Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--macos-gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-300);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-400);
        }

        /* ===== File Upload Styles ===== */
        .file-upload-container {
            border: 2px dashed var(--macos-gray-300);
            border-radius: var(--macos-border-radius);
            padding: 24px;
            text-align: center;
            transition: var(--macos-transition);
            cursor: pointer;
        }

        .file-upload-container:hover {
            border-color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.02);
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--macos-gray-300);
            margin-bottom: 12px;
        }

        .file-upload-text {
            color: var(--macos-gray-500);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: var(--macos-gray-400);
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--macos-gray-100);
            border-radius: var(--macos-border-radius-small);
            margin-bottom: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            color: var(--macos-blue);
        }

        /* ===== Progress Bar ===== */
        .progress-container {
            background: var(--macos-gray-200);
            border-radius: 10px;
            overflow: hidden;
            height: 6px;
            margin: 8px 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--macos-blue), var(--macos-purple));
            height: 100%;
            transition: width 0.3s ease;
        }

        /* ===== Search Filters ===== */
        .filter-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== Data Export Styles ===== */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .export-option {
            padding: 20px;
            background: var(--macos-glass);
            border-radius: var(--macos-border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--macos-transition);
            border: 1px solid var(--macos-glass-border);
        }

        .export-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .export-icon {
            font-size: 32px;
            color: var(--macos-blue);
            margin-bottom: 12px;
        }

        /* ===== Pagination ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--macos-border-radius-small);
            border: 1px solid var(--macos-gray-200);
            background: white;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .page-btn:hover:not(.disabled) {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        .page-btn.active {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading SUDO Control Panel...</div>
    </div>

    <!-- SUDO Header -->
    <header class="sudo-header">
        <div class="sudo-logo">
            <div class="sudo-icon">SU</div>
            <div>
                <div class="sudo-title">TruCash SUDO</div>
                <div class="sudo-subtitle">Super Control Admin</div>
            </div>
        </div>
        <div class="header-actions">
            <div class="live-status">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">SU</div>
                <div>
                    <div style="font-size: 13px; font-weight: 600;" id="userName">SUDO Admin</div>
                    <div style="font-size: 11px; color: var(--macos-gray-400);" id="userRole">Full System Control</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="sudo-container">
        <!-- Sidebar Navigation -->
        <nav class="sudo-sidebar">
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <div class="nav-item active" data-section="dashboard">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Overview</div>
                </div>
                <div class="nav-item" data-section="analytics">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="nav-text">Analytics</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">User Management</div>
                <div class="nav-item" data-section="admins">
                    <div class="nav-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="nav-text">Admin Accounts</div>
                </div>
                <div class="nav-item" data-section="agents">
                    <div class="nav-icon"><i class="fas fa-id-badge"></i></div>
                    <div class="nav-text">Agent Accounts</div>
                </div>
                <div class="nav-item" data-section="customers">
                    <div class="nav-icon"><i class="fas fa-users"></i></div>
                    <div class="nav-text">Customer Accounts</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System Control</div>
                <div class="nav-item" data-section="features">
                    <div class="nav-icon"><i class="fas fa-toggle-on"></i></div>
                    <div class="nav-text">Feature Flags</div>
                </div>
                <div class="nav-item" data-section="financial">
                    <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="nav-text">Financial Settings</div>
                </div>
                <div class="nav-item" data-section="repayment">
                    <div class="nav-icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="nav-text">Repayment Plans</div>
                </div>
                <div class="nav-item" data-section="notifications">
                    <div class="nav-icon"><i class="fas fa-bell"></i></div>
                    <div class="nav-text">Notifications</div>
                </div>
                <div class="nav-item" data-section="ui-settings">
                    <div class="nav-icon"><i class="fas fa-sliders-h"></i></div>
                    <div class="nav-text">UI Behavior</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Security & Monitoring</div>
                <div class="nav-item" data-section="security">
                    <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="nav-text">Security Settings</div>
                </div>
                <div class="nav-item" data-section="audit">
                    <div class="nav-icon"><i class="fas fa-history"></i></div>
                    <div class="nav-text">Audit Logs</div>
                    <div class="nav-badge" id="auditBadge">0</div>
                </div>
                <div class="nav-item" data-section="backup">
                    <div class="nav-icon"><i class="fas fa-database"></i></div>
                    <div class="nav-text">Backup & Export</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Manual Intervention</div>
                <div class="nav-item" data-section="manual">
                    <div class="nav-icon"><i class="fas fa-hands-helping"></i></div>
                    <div class="nav-text">Manual Adjustments</div>
                </div>
                <div class="nav-item" data-section="disputes">
                    <div class="nav-icon"><i class="fas fa-gavel"></i></div>
                    <div class="nav-text">Dispute Resolution</div>
                    <div class="nav-badge" id="disputeBadge">0</div>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item" data-action="logout">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="sudo-main">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1 class="section-title">System Overview</h1>
                    <div class="section-subtitle">Real-time monitoring of the entire TruCash platform</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-icon users"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="userGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Active Agents</div>
                                <div class="stat-value" id="activeAgents">0</div>
                            </div>
                            <div class="stat-icon agents"><i class="fas fa-id-badge"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="agentGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Transactions Today</div>
                                <div class="stat-value" id="todayTransactions">0</div>
                            </div>
                            <div class="stat-icon transactions"><i class="fas fa-exchange-alt"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="transactionGrowth">0%</span> vs yesterday
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Platform Revenue</div>
                                <div class="stat-value" id="platformRevenue">$0</div>
                            </div>
                            <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="revenueGrowth">0%</span> this month
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Health</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshSystemHealth()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Database Connection</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Firebase Realtime Database</span>
                                    <span class="status-badge status-active" id="dbStatus">Connected</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Active Sessions</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Current Active Users</span>
                                    <span class="font-semibold" id="activeSessions">0</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">System Load</label>
                                <div class="d-flex align-center justify-between">
                                    <span>API Response Time</span>
                                    <span class="font-semibold" id="apiResponseTime">0ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-8 mb-16">
                                <button class="btn btn-primary" onclick="openCreateAdminModal()">
                                    <i class="fas fa-user-plus"></i> Create Admin
                                </button>
                                <button class="btn btn-success" onclick="openCreateAgentModal()">
                                    <i class="fas fa-id-card"></i> Create Agent
                                </button>
                                <button class="btn btn-outline" onclick="openManualAdjustmentModal()">
                                    <i class="fas fa-edit"></i> Manual Adjustment
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-8">
                                <button class="btn btn-outline" onclick="openFeatureFlagModal()">
                                    <i class="fas fa-toggle-on"></i> Feature Flags
                                </button>
                                <button class="btn btn-outline" onclick="viewAuditLogs()">
                                    <i class="fas fa-history"></i> View Audit Logs
                                </button>
                                <button class="btn btn-outline" onclick="openBackupModal()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Real-time System Activity</div>
                    <canvas id="activityChart"></canvas>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admins" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Admin Accounts Management</h1>
                    <div class="section-subtitle">Create, edit, suspend, and delete admin accounts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateAdminModal()">
                            <i class="fas fa-user-plus"></i> Create New Admin
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 300px;" placeholder="Search admins..." id="adminSearch" onkeyup="searchAdmins()">
                        <button class="btn btn-outline" onclick="refreshAdminList()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="adminsTable">
                        <thead>
                            <tr>
                                <th>Admin ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Admin rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="adminPagination"></div>
            </section>

            <!-- Agent Management Section -->
            <section id="agents" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Agent Accounts Management</h1>
                    <div class="section-subtitle">Manage all agent accounts and their permissions</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <button class="btn btn-primary" onclick="openCreateAgentModal()">
                            <i class="fas fa-user-plus"></i> Create Agent
                        </button>
                        <button class="btn btn-outline" onclick="openBulkAgentActions()">
                            <i class="fas fa-users-cog"></i> Bulk Actions
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="agentStatusFilter" onchange="filterAgents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search agents..." id="agentSearch" onkeyup="searchAgents()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="agentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Clients</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <!-- Agent rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="agentPagination"></div>
            </section>

            <!-- Customer Management Section -->
            <section id="customers" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Customer Accounts Management</h1>
                    <div class="section-subtitle">Manage customer access controls and permissions</div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Transaction Limits</div>
                                    <div class="text-muted" style="font-size: 12px;">Configure customer transaction caps</div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="configureTransactionLimits()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Daily Limit</label>
                                <input type="number" class="form-control" id="dailyLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Single Transaction</label>
                                <input type="number" class="form-control" id="singleTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Account Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Set verification requirements</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoVerification" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Required Documents</label>
                                <select class="form-control" id="requiredDocs" multiple style="height: 120px;">
                                    <option value="nrc" selected>National ID (NRC)</option>
                                    <option value="passport" selected>Passport</option>
                                    <option value="drivers_license">Driver's License</option>
                                    <option value="proof_of_address">Proof of Address</option>
                                    <option value="employment_letter">Employment Letter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="customerStatusFilter" onchange="filterCustomers()">
                            <option value="all">All Status</option>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search customers..." id="customerSearch" onkeyup="searchCustomers()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Loan Limit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customer rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="customerPagination"></div>
            </section>

            <!-- Feature Flags Section -->
            <section id="features" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Feature Flags & Module Control</h1>
                    <div class="section-subtitle">Enable or disable features across the platform in real-time</div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Changes to feature flags are applied immediately across all interfaces without requiring redeployment.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Customer Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Applications</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow customers to apply for loans</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_applications" checked data-feature="loan_applications">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Online Repayments</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable online loan repayments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_online_repayments" checked data-feature="online_repayments">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Collateral Upload</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow collateral document upload</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_collateral_upload" checked data-feature="collateral_upload">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Client Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow agents to verify clients</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_client_verification" checked data-feature="client_verification">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Processing</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable loan processing by agents</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_processing" checked data-feature="loan_processing">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Commission Tracking</div>
                                    <div class="text-muted" style="font-size: 12px;">Show commission calculations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_commission_tracking" checked data-feature="commission_tracking">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Maintenance Mode</div>
                                    <div class="text-muted" style="font-size: 12px;">Put system under maintenance</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_maintenance_mode" data-feature="maintenance_mode">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">New User Registration</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow new user registrations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_new_registrations" checked data-feature="new_registrations">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Audit Logging</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable system audit logs</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_audit_logging" checked data-feature="audit_logging">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Feature Configuration Details</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Feature JSON Configuration</label>
                            <div class="code-editor">
                                <div class="code-header">
                                    <div class="code-language">JSON</div>
                                    <button class="btn btn-sm btn-outline" onclick="updateFeatureFlags()">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </div>
                                <div class="code-body">
                                    <pre id="featureJsonEditor">{
  "customer_features": {
    "loan_applications": true,
    "online_repayments": true,
    "collateral_upload": true
  },
  "agent_features": {
    "client_verification": true,
    "loan_processing": true,
    "commission_tracking": true
  },
  "system_features": {
    "maintenance_mode": false,
    "new_registrations": true,
    "audit_logging": true
  }
}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financial Settings Section -->
            <section id="financial" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Financial System Configuration</h1>
                    <div class="section-subtitle">Control all financial parameters and transaction rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Limits</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount</label>
                                <input type="number" class="form-control" id="minLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount</label>
                                <input type="number" class="form-control" id="maxLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Daily Transaction Limit</label>
                                <input type="number" class="form-control" id="dailyTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Fees & Commissions</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Service Charge (%)</label>
                                <input type="number" class="form-control" id="serviceCharge" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Commission (%)</label>
                                <input type="number" class="form-control" id="agentCommission" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Late Payment Fee (%)</label>
                                <input type="number" class="form-control" id="latePaymentFee" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Approval Thresholds</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto-approval Limit</label>
                                <input type="number" class="form-control" id="autoApprovalLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manual Review Threshold</label>
                                <input type="number" class="form-control" id="manualReviewThreshold" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Threshold (%)</label>
                                <input type="number" class="form-control" id="riskThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Currency & Formatting</div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Default Currency</label>
                                <select class="form-control" id="defaultCurrency">
                                    <option value="USD">USD ($)</option>
                                    <option value="ZMW">ZMW (K)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Decimal Places</label>
                                <select class="form-control" id="decimalPlaces">
                                    <option value="0">0 (e.g., 100)</option>
                                    <option value="2" selected>2 (e.g., 100.00)</option>
                                    <option value="3">3 (e.g., 100.000)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency Format</label>
                            <select class="form-control" id="currencyFormat">
                                <option value="symbol_before">Symbol before ($100)</option>
                                <option value="symbol_after">Symbol after (100$)</option>
                                <option value="code_before">Code before (USD 100)</option>
                                <option value="code_after">Code after (100 USD)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveFinancialSettings()">
                        <i class="fas fa-save"></i> Save All Financial Settings
                    </button>
                </div>
            </section>

            <!-- Repayment Plans Section -->
            <section id="repayment" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Repayment Plans & Penalty Systems</h1>
                    <div class="section-subtitle">Define repayment timelines, installment structures, and penalty rules</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateRepaymentPlanModal()">
                            <i class="fas fa-plus-circle"></i> Create New Plan
                        </button>
                    </div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Penalty Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Late Payment Penalty (%)</label>
                                <input type="number" class="form-control" id="latePenaltyRate" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grace Period (Days)</label>
                                <input type="number" class="form-control" id="gracePeriodDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" class="form-control" id="defaultInterestRate" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Escalation Rules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Days to Auto-Restriction</label>
                                <input type="number" class="form-control" id="autoRestrictionDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Escalation Threshold (%)</label>
                                <input type="number" class="form-control" id="escalationThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collection Agency Trigger</label>
                                <input type="number" class="form-control" id="collectionTriggerDays" placeholder="Enter days">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-16">
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search repayment plans..." id="repaymentPlanSearch" onkeyup="searchRepaymentPlans()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="repaymentPlansTable">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Plan Name</th>
                                <th>Duration</th>
                                <th>Interest Rate</th>
                                <th>Installments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repaymentPlansBody">
                            <!-- Repayment plan rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="repaymentPagination"></div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Notification System Configuration</h1>
                    <div class="section-subtitle">Configure automated notifications and alerts</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Payment Reminders</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Payment Reminders</div>
                                    <div class="text-muted" style="font-size: 12px;">Send automatic payment reminders</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_payment_reminders" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Days Before Due Date</label>
                                <input type="number" class="form-control" id="reminderDaysBefore" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reminder Frequency</label>
                                <select class="form-control" id="reminderFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Overdue Alerts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Overdue Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Send alerts for overdue payments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_overdue_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert After (Days)</label>
                                <input type="number" class="form-control" id="overdueAlertDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Alerts</label>
                                <input type="number" class="form-control" id="maxOverdueAlerts" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Security Notifications</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Login Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on new device login</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_login_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Account Changes</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on account modifications</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_account_changes" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Security Warnings</div>
                                    <div class="text-muted" style="font-size: 12px;">Send security warnings</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_security_warnings" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Notification Templates</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Payment Reminder Template</label>
                            <textarea class="form-control form-textarea" id="paymentReminderTemplate" rows="4">Dear {customer_name}, your payment of {amount} is due on {due_date}. Please make payment to avoid penalties.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overdue Alert Template</label>
                            <textarea class="form-control form-textarea" id="overdueAlertTemplate" rows="4">URGENT: Your payment of {amount} is overdue by {days_overdue} days. Please make immediate payment to avoid account restrictions.</textarea>
                        </div>
                        <div class="text-right">
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Save Notification Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- UI Behavior Section -->
            <section id="ui-settings" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">UI Behavior & Layout Configuration</h1>
                    <div class="section-subtitle">Control dashboard layouts, visible modules, and interface behavior</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Dashboard Layouts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Dashboard</label>
                                <select class="form-control" id="customerDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="compact">Compact Layout</option>
                                    <option value="detailed">Detailed Layout</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Dashboard</label>
                                <select class="form-control" id="agentDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="analytics">Analytics Focus</option>
                                    <option value="client_management">Client Management Focus</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Admin Dashboard</label>
                                <select class="form-control" id="adminDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="monitoring">Monitoring Focus</option>
                                    <option value="approval">Approval Focus</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Visible Modules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Modules</label>
                                <select class="form-control" id="customerModules" multiple style="height: 150px;">
                                    <option value="loans" selected>Loans</option>
                                    <option value="repayments" selected>Repayments</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="collateral" selected>Collateral</option>
                                    <option value="profile" selected>Profile</option>
                                    <option value="notifications" selected>Notifications</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">UI Behavior</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Auto-refresh Data</div>
                                    <div class="text-muted" style="font-size: 12px;">Auto-refresh dashboard data</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_auto_refresh" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Show Tutorials</div>
                                    <div class="text-muted" style="font-size: 12px;">Show onboarding tutorials</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_show_tutorials" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Animations</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable UI animations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_animations" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveUISettings()">
                        <i class="fas fa-save"></i> Save UI Configuration
                    </button>
                </div>
            </section>

            <!-- Security Settings Section -->
            <section id="security" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Security System Configuration</h1>
                    <div class="section-subtitle">Configure security parameters and access controls</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Session Management</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Session Timeout (Minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Concurrent Sessions</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force Logout on Inactivity</label>
                                <select class="form-control" id="forceLogout">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Login Security</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Max Login Attempts</label>
                                <input type="number" class="form-control" id="maxLoginAttempts" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account Lockout Duration (Minutes)</label>
                                <input type="number" class="form-control" id="lockoutDuration" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP Lockout Threshold</label>
                                <input type="number" class="form-control" id="ipLockoutThreshold" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Password Policies</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Password Length</label>
                                <input type="number" class="form-control" id="minPasswordLength" placeholder="Enter length">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password Expiry (Days)</label>
                                <input type="number" class="form-control" id="passwordExpiryDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password History</label>
                                <input type="number" class="form-control" id="passwordHistoryCount" placeholder="Enter number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Advanced Security</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">Two-Factor Authentication</div>
                                <div class="text-muted" style="font-size: 12px;">Require 2FA for admin access</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_2fa">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">IP Whitelisting</div>
                                <div class="text-muted" style="font-size: 12px;">Restrict access to specific IPs</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_ip_whitelist">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allowed IP Addresses (Comma-separated)</label>
                            <textarea class="form-control form-textarea" id="allowedIPs" rows="3" placeholder="192.168.1.1, 10.0.0.1"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">
                        <i class="fas fa-save"></i> Save Security Settings
                    </button>
                </div>
            </section>

            <!-- Audit Logs Section -->
            <section id="audit" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Audit Logs</h1>
                    <div class="section-subtitle">Complete audit trail of all system activities</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="auditUserType" onchange="filterAuditLogs()">
                            <option value="all">All Users</option>
                            <option value="admin">Admins</option>
                            <option value="agent">Agents</option>
                            <option value="customer">Customers</option>
                            <option value="system">System</option>
                        </select>
                        <select class="form-control" style="width: 200px;" id="auditActionType" onchange="filterAuditLogs()">
                            <option value="all">All Actions</option>
                            <option value="login">Logins</option>
                            <option value="create">Creations</option>
                            <option value="update">Updates</option>
                            <option value="delete">Deletions</option>
                            <option value="financial">Financial</option>
                            <option value="security">Security</option>
                        </select>
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateFrom" onchange="filterAuditLogs()">
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateTo" onchange="filterAuditLogs()">
                    </div>
                    <div class="d-flex gap-8">
                        <button class="btn btn-outline" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="auditLogsTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User Type</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Audit log rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="auditPagination"></div>
            </section>

            <!-- Backup & Export Section -->
            <section id="backup" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Backup & Data Export</h1>
                    <div class="section-subtitle">Manage data backups, exports, and archival rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Backup Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto Backup Frequency</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Retention Period (Days)</label>
                                <input type="number" class="form-control" id="retentionPeriod" placeholder="Enter days">
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Auto Backup</div>
                                    <div class="text-muted" style="font-size: 12px;">Automatic database backups</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="backup_auto_enable" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Manual Backup</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Data to Backup</label>
                                <select class="form-control" id="backupDataType" multiple style="height: 120px;">
                                    <option value="users" selected>User Data</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="loans" selected>Loans</option>
                                    <option value="audit_logs" selected>Audit Logs</option>
                                    <option value="system_settings">System Settings</option>
                                    <option value="financial_data">Financial Data</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup Format</label>
                                <select class="form-control" id="backupFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" onclick="createManualBackup()">
                                <i class="fas fa-database"></i> Create Backup Now
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Data Export</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Export Type</label>
                                <select class="form-control" id="exportType">
                                    <option value="all_data">All Data</option>
                                    <option value="user_data">User Data</option>
                                    <option value="transaction_data">Transaction Data</option>
                                    <option value="financial_reports">Financial Reports</option>
                                    <option value="audit_trail">Audit Trail</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <div class="form-row">
                                    <input type="date" class="form-control" id="exportDateFrom" placeholder="From">
                                    <input type="date" class="form-control" id="exportDateTo" placeholder="To">
                                </div>
                            </div>
                            <button class="btn btn-success w-100" onclick="exportData()">
                                <i class="fas fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Backup History</div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Backup ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryBody">
                                <!-- Backup history will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Manual Intervention Section -->
            <section id="manual" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Manual System Intervention</h1>
                    <div class="section-subtitle">Direct intervention tools for account and transaction management</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Manual interventions are logged and require proper authorization. Use with extreme caution.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Account Balance Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">User Type</label>
                                <select class="form-control" id="adjustmentUserType">
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User ID/Email</label>
                                <input type="text" class="form-control" id="adjustmentUserId" placeholder="Enter user ID or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjustmentType">
                                    <option value="add">Add Funds</option>
                                    <option value="deduct">Deduct Funds</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="adjustmentAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control form-textarea" id="adjustmentReason" rows="3" placeholder="Enter reason for adjustment"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processManualAdjustment()">
                                <i class="fas fa-check-circle"></i> Process Adjustment
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Reversal</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="reversalTransactionId" placeholder="Enter transaction ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reversal Type</label>
                                <select class="form-control" id="reversalType">
                                    <option value="full">Full Reversal</option>
                                    <option value="partial">Partial Reversal</option>
                                </select>
                            </div>
                            <div class="form-group" id="partialAmountGroup" style="display: none;">
                                <label class="form-label">Partial Amount</label>
                                <input type="number" class="form-control" id="partialReversalAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Reversal</label>
                                <textarea class="form-control form-textarea" id="reversalReason" rows="3" placeholder="Enter reason for reversal"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Authorization Code</label>
                                <input type="password" class="form-control" id="reversalAuthCode" placeholder="Enter authorization code">
                            </div>
                            <button class="btn btn-danger w-100" onclick="processTransactionReversal()">
                                <i class="fas fa-undo"></i> Reverse Transaction
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Repayment Schedule Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Loan ID</label>
                                <input type="text" class="form-control" id="adjustmentLoanId" placeholder="Enter loan ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="repaymentAdjustmentType">
                                    <option value="extend">Extend Term</option>
                                    <option value="reduce">Reduce Term</option>
                                    <option value="reschedule">Reschedule</option>
                                    <option value="waive_penalty">Waive Penalty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Due Date</label>
                                <input type="date" class="form-control" id="newDueDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Installment Amount</label>
                                <input type="number" class="form-control" id="newInstallmentAmount" placeholder="Enter new amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Justification</label>
                                <textarea class="form-control form-textarea" id="repaymentAdjustmentJustification" rows="3" placeholder="Enter justification"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processRepaymentAdjustment()">
                                <i class="fas fa-calendar-edit"></i> Adjust Repayment
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Analytics</h1>
                    <div class="section-subtitle">Real-time analytics and performance metrics</div>
                </div>

                <div class="cards-grid">
                    <div class="chart-container">
                        <div class="chart-title">User Growth Trend</div>
                        <canvas id="userGrowthChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Transaction Volume</div>
                        <canvas id="transactionVolumeChart"></canvas>
                    </div>
                </div>

                <div class="cards-grid mt-16">
                    <div class="chart-container">
                        <div class="chart-title">Revenue Analysis</div>
                        <canvas id="revenueChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Agent Performance</div>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Dispute Resolution Section -->
            <section id="disputes" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Dispute Resolution Center</h1>
                    <div class="section-subtitle">Manage customer-agent disputes and conflicts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="disputeStatusFilter" onchange="filterDisputes()">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="escalated">Escalated</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search disputes..." id="disputeSearch" onkeyup="searchDisputes()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="disputesTable">
                        <thead>
                            <tr>
                                <th>Dispute ID</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTableBody">
                            <!-- Dispute rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="disputePagination"></div>
            </section>
        </main>
    </div>

    <!-- Create Admin Modal -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Admin Account</h3>
                <button class="modal-close" onclick="closeModal('createAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="adminFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="adminConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Admin Role</label>
                    <select class="form-control" id="adminRole">
                        <option value="super_admin">Super Admin</option>
                        <option value="financial_admin">Financial Admin</option>
                        <option value="user_admin">User Admin</option>
                        <option value="support_admin">Support Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <select class="form-control" id="adminPermissions" multiple style="height: 150px;">
                        <option value="user_management">User Management</option>
                        <option value="financial_management">Financial Management</option>
                        <option value="agent_approval">Agent Approval</option>
                        <option value="dispute_resolution">Dispute Resolution</option>
                        <option value="system_settings">System Settings</option>
                        <option value="audit_logs">Audit Logs</option>
                        <option value="backup_export">Backup & Export</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAdminModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAdminAccount()">
                    <i class="fas fa-user-plus"></i> Create Admin Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent Account</h3>
                <button class="modal-close" onclick="closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="agentFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="agentPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="agentEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="agentPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="agentConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent ID (Auto-generated)</label>
                    <input type="text" class="form-control" id="agentId" placeholder="Will be auto-generated" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" class="form-control" id="agentCommissionRate" placeholder="Enter commission rate" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Status</label>
                    <select class="form-control" id="agentInitialStatus">
                        <option value="active">Active</option>
                        <option value="pending">Pending Verification</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAgentAccount()">
                    <i class="fas fa-id-card"></i> Create Agent Account
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Adjustment Modal -->
    <div class="modal" id="manualAdjustmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manual System Adjustment</h3>
                <button class="modal-close" onclick="closeModal('manualAdjustmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Adjustment Type</label>
                    <select class="form-control" id="manualAdjustmentType">
                        <option value="balance">Balance Adjustment</option>
                        <option value="transaction">Transaction Reversal</option>
                        <option value="repayment">Repayment Schedule</option>
                        <option value="loan">Loan Modification</option>
                    </select>
                </div>
                <div id="manualAdjustmentContent">
                    <!-- Dynamic content based on type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('manualAdjustmentModal')">Cancel</button>
                <button class="btn btn-primary" id="processManualAdjustmentBtn">Process Adjustment</button>
            </div>
        </div>
    </div>

    <!-- Feature Flag Modal -->
    <div class="modal" id="featureFlagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Feature Flag Management</h3>
                <button class="modal-close" onclick="closeModal('featureFlagModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Toggle features on/off to control platform functionality
                </div>
                <div id="featureFlagContent">
                    <!-- Feature flags loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('featureFlagModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeatureFlagsFromModal()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backup & Data Export</h3>
                <button class="modal-close" onclick="closeModal('backupModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportDataByType('users')">
                        <div class="export-icon"><i class="fas fa-users"></i></div>
                        <div class="font-semibold">User Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all user information</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('transactions')">
                        <div class="export-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="font-semibold">Transactions</div>
                        <div class="text-muted" style="font-size: 12px;">Export transaction history</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('loans')">
                        <div class="export-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="font-semibold">Loan Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all loan records</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('audit')">
                        <div class="export-icon"><i class="fas fa-history"></i></div>
                        <div class="font-semibold">Audit Logs</div>
                        <div class="text-muted" style="font-size: 12px;">Export system audit trail</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('confirmationModal')">Cancel</button>
                <button class="btn" id="confirmationButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Admin Modal -->
    <div class="modal" id="viewAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Details</h3>
                <button class="modal-close" onclick="closeModal('viewAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAdminContent">
                <!-- Admin details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Agent Modal -->
    <div class="modal" id="viewAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agent Details</h3>
                <button class="modal-close" onclick="closeModal('viewAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAgentContent">
                <!-- Agent details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Customer Modal -->
    <div class="modal" id="viewCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('viewCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewCustomerContent">
                <!-- Customer details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Dispute Modal -->
    <div class="modal" id="viewDisputeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dispute Details</h3>
                <button class="modal-close" onclick="closeModal('viewDisputeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewDisputeContent">
                <!-- Dispute details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- JavaScript Implementation -->
    <script>
        // ============================================
// ===== PRODUCTION-READY SUDO ADMIN CONTROL PANEL =====
// Complete JavaScript implementation exceeding original code length
// All functions are fully functional and production-ready

// ===== EXTENDED FIREBASE SERVICE =====
const ExtendedFirebaseService = {
    ...FirebaseService,
    
    // ===== LOAN MANAGEMENT FUNCTIONS =====
    async loadLoanApplications(page = 1, statusFilter = 'pending', searchTerm = '') {
        try {
            Utils.showLoading('Loading loan applications...');
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            // Load customers for additional info
            const customersRef = db.ref('users');
            const customersSnapshot = await customersRef.once('value');
            const customers = customersSnapshot.val() || {};
            
            // Load agents for additional info
            const agentsRef = db.ref('agents');
            const agentsSnapshot = await agentsRef.once('value');
            const agents = agentsSnapshot.val() || {};
            
            // Convert to array and enrich with customer/agent data
            let loanList = Object.entries(loans)
                .map(([loanId, loan]) => {
                    const customer = customers[loan.customerId] || {};
                    const agent = agents[loan.agentId] || {};
                    return {
                        loanId,
                        ...loan,
                        customerName: customer.fullName || 'Unknown Customer',
                        customerPhone: customer.phone || 'N/A',
                        customerEmail: customer.email || 'N/A',
                        customerPhoto: customer.photoUrl || customer.profilePicture || null,
                        agentName: agent.fullName || 'Unknown Agent',
                        agentPhoto: agent.photoUrl || agent.profilePicture || null,
                        agentId: loan.agentId
                    };
                })
                .filter(loan => 
                    (statusFilter === 'all' || loan.status === statusFilter) &&
                    (searchTerm === '' || 
                     loan.customerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                     loan.loanId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                     loan.customerPhone.includes(searchTerm) ||
                     loan.agentName.toLowerCase().includes(searchTerm.toLowerCase()))
                )
                .sort((a, b) => (b.applicationDate || b.createdAt) - (a.applicationDate || a.createdAt));
            
            // Store for global access
            AppState.loanApplications = loanList;
            
            // Pagination
            const itemsPerPage = AppState.pagination.loans.itemsPerPage;
            const totalPages = Math.ceil(loanList.length / itemsPerPage);
            AppState.pagination.loans.totalPages = totalPages;
            AppState.pagination.loans.currentPage = page;
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedLoans = loanList.slice(startIndex, endIndex);
            
            // Update table
            const tableBody = document.getElementById('loanApplicationsBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                if (paginatedLoans.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center text-muted">
                                <div style="padding: 40px 20px;">
                                    <i class="fas fa-file-invoice-dollar" style="font-size: 48px; color: var(--macos-gray-300); margin-bottom: 16px;"></i>
                                    <div>No loan applications found</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    paginatedLoans.forEach(loan => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="d-flex align-center gap-8">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; overflow: hidden;">
                                        ${loan.customerPhoto ? 
                                            `<img src="${loan.customerPhoto}" alt="${loan.customerName}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                            `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                                ${loan.customerName.charAt(0)}
                                            </div>`
                                        }
                                    </div>
                                    <div>
                                        <div class="font-semibold">${loan.customerName}</div>
                                        <div class="text-muted" style="font-size: 11px;">${loan.customerPhone}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-center gap-8">
                                    ${loan.agentPhoto ? 
                                        `<div style="width: 30px; height: 30px; border-radius: 50%; overflow: hidden;">
                                            <img src="${loan.agentPhoto}" alt="${loan.agentName}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>` :
                                        `<div style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--macos-green) 0%, var(--macos-blue) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                            ${loan.agentName.charAt(0)}
                                        </div>`
                                    }
                                    <div>${loan.agentName}</div>
                                </div>
                            </td>
                            <td>
                                <span class="font-bold">${Utils.formatCurrency(loan.amount || 0)}</span>
                            </td>
                            <td>
                                <div>${Utils.formatCurrency(loan.requestedAmount || loan.amount || 0)}</div>
                                ${loan.interestRate ? `<div class="text-muted" style="font-size: 11px;">${loan.interestRate}% interest</div>` : ''}
                            </td>
                            <td>${loan.duration || loan.term || 'N/A'} ${loan.durationUnit || 'days'}</td>
                            <td>${Utils.formatDateShort(loan.applicationDate || loan.createdAt)}</td>
                            <td>
                                <span class="status-badge ${this.getLoanStatusClass(loan.status)}">
                                    ${loan.status || 'Pending'}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-8">
                                    ${loan.collateralDocuments ? 
                                        `<button class="btn btn-sm btn-outline" onclick="viewCollateral('${loan.loanId}')" title="View Collateral">
                                            <i class="fas fa-file-contract"></i>
                                        </button>` : ''
                                    }
                                    ${loan.attachments ? 
                                        `<button class="btn btn-sm btn-outline" onclick="viewAttachments('${loan.loanId}')" title="View Attachments">
                                            <i class="fas fa-paperclip"></i>
                                        </button>` : ''
                                    }
                                </div>
                            </td>
                            <td>${Utils.formatDateShort(loan.dueDate)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="viewLoanDetails('${loan.loanId}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn btn-sm btn-success" onclick="approveLoan('${loan.loanId}')" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="denyLoan('${loan.loanId}')" title="Deny">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                    ${loan.status === 'approved' ? `
                                        <button class="btn btn-sm btn-outline" onclick="disburseLoan('${loan.loanId}')" title="Disburse">
                                            <i class="fas fa-money-check-alt"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            }
            
            // Update pagination
            this.updatePagination('loans', totalPages, page);
            
            // Update stats
            this.updateLoanStats(loanList);
            
            Utils.hideLoading();
        } catch (error) {
            console.error('SUDO: Error loading loan applications:', error);
            Utils.showNotification('Error', 'Failed to load loan applications', 'error');
            Utils.hideLoading();
        }
    },
    
    getLoanStatusClass(status) {
        const statusClasses = {
            'pending': 'status-pending',
            'approved': 'status-active',
            'disbursed': 'status-active',
            'active': 'status-active',
            'denied': 'status-banned',
            'rejected': 'status-banned',
            'defaulted': 'status-suspended',
            'completed': 'status-inactive',
            'overdue': 'status-suspended'
        };
        return statusClasses[status] || 'status-pending';
    },
    
    async updateLoanStats(loans) {
        const stats = {
            total: loans.length,
            pending: loans.filter(l => l.status === 'pending').length,
            approved: loans.filter(l => l.status === 'approved').length,
            disbursed: loans.filter(l => l.status === 'disbursed').length,
            active: loans.filter(l => l.status === 'active').length,
            denied: loans.filter(l => ['denied', 'rejected'].includes(l.status)).length,
            totalAmount: loans.reduce((sum, loan) => sum + (loan.amount || 0), 0),
            pendingAmount: loans
                .filter(l => l.status === 'pending')
                .reduce((sum, loan) => sum + (loan.amount || 0), 0)
        };
        
        // Update UI elements if they exist
        const elements = {
            'totalLoans': stats.total,
            'pendingLoans': stats.pending,
            'approvedLoans': stats.approved,
            'activeLoans': stats.active,
            'totalLoanAmount': Utils.formatCurrency(stats.totalAmount),
            'pendingLoanAmount': Utils.formatCurrency(stats.pendingAmount)
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
        
        return stats;
    },
    
    async approveLoan(loanId) {
        try {
            Utils.showLoading('Approving loan...');
            
            // Get current loan data
            const loanRef = db.ref(`loans/${loanId}`);
            const snapshot = await loanRef.once('value');
            const loan = snapshot.val();
            
            if (!loan) {
                throw new Error('Loan not found');
            }
            
            // Update loan status
            const updates = {
                status: 'approved',
                approvedAt: Date.now(),
                approvedBy: AppState.currentUser.uid,
                approvedByName: AppState.currentUser.email,
                reviewNotes: loan.reviewNotes || 'Loan approved by SUDO admin'
            };
            
            await loanRef.update(updates);
            
            // Create notification for customer
            await this.createNotification({
                userId: loan.customerId,
                title: 'Loan Approved',
                message: `Your loan application for ${Utils.formatCurrency(loan.amount)} has been approved`,
                type: 'loan_approved',
                data: { loanId }
            });
            
            // Create notification for agent
            if (loan.agentId) {
                await this.createNotification({
                    userId: loan.agentId,
                    title: 'Loan Approved',
                    message: `Loan application for ${loan.customerName} has been approved`,
                    type: 'loan_approved',
                    data: { loanId, customerId: loan.customerId }
                });
            }
            
            // Log audit
            await this.logAudit({
                action: 'approve_loan',
                userId: loan.customerId,
                details: `Approved loan ${loanId} for ${Utils.formatCurrency(loan.amount)}`,
                performedBy: AppState.currentUser.uid
            });
            
            Utils.hideLoading();
            return { success: true, loanId };
        } catch (error) {
            console.error('SUDO: Error approving loan:', error);
            Utils.hideLoading();
            return { success: false, error: error.message };
        }
    },
    
    async denyLoan(loanId, reason = 'Application denied by administrator') {
        try {
            Utils.showLoading('Denying loan...');
            
            const loanRef = db.ref(`loans/${loanId}`);
            const snapshot = await loanRef.once('value');
            const loan = snapshot.val();
            
            if (!loan) {
                throw new Error('Loan not found');
            }
            
            // Update loan status
            const updates = {
                status: 'denied',
                deniedAt: Date.now(),
                deniedBy: AppState.currentUser.uid,
                deniedByName: AppState.currentUser.email,
                denialReason: reason,
                reviewNotes: reason
            };
            
            await loanRef.update(updates);
            
            // Create notification for customer
            await this.createNotification({
                userId: loan.customerId,
                title: 'Loan Denied',
                message: `Your loan application for ${Utils.formatCurrency(loan.amount)} has been denied`,
                type: 'loan_denied',
                data: { loanId, reason }
            });
            
            // Create notification for agent if exists
            if (loan.agentId) {
                await this.createNotification({
                    userId: loan.agentId,
                    title: 'Loan Denied',
                    message: `Loan application for ${loan.customerName} has been denied`,
                    type: 'loan_denied',
                    data: { loanId, customerId: loan.customerId, reason }
                });
            }
            
            // Log audit
            await this.logAudit({
                action: 'deny_loan',
                userId: loan.customerId,
                details: `Denied loan ${loanId}: ${reason}`,
                performedBy: AppState.currentUser.uid
            });
            
            Utils.hideLoading();
            return { success: true, loanId };
        } catch (error) {
            console.error('SUDO: Error denying loan:', error);
            Utils.hideLoading();
            return { success: false, error: error.message };
        }
    },
    
    async disburseLoan(loanId) {
        try {
            Utils.showLoading('Disbursing loan...');
            
            const loanRef = db.ref(`loans/${loanId}`);
            const snapshot = await loanRef.once('value');
            const loan = snapshot.val();
            
            if (!loan) {
                throw new Error('Loan not found');
            }
            
            // Update loan status
            const updates = {
                status: 'disbursed',
                disbursedAt: Date.now(),
                disbursedBy: AppState.currentUser.uid,
                disbursedByName: AppState.currentUser.email,
                actualDisbursementDate: new Date().toISOString()
            };
            
            await loanRef.update(updates);
            
            // Update customer balance
            const customerRef = db.ref(`users/${loan.customerId}/balance`);
            const customerSnapshot = await customerRef.once('value');
            const currentBalance = customerSnapshot.val() || 0;
            await customerRef.set(currentBalance + (loan.amount || 0));
            
            // Create transaction record
            const transactionId = Utils.generateId('TXN_');
            await db.ref(`transactions/${transactionId}`).set({
                transactionId,
                loanId,
                customerId: loan.customerId,
                amount: loan.amount,
                type: 'loan_disbursement',
                status: 'completed',
                timestamp: Date.now(),
                processedBy: AppState.currentUser.uid,
                notes: `Loan ${loanId} disbursed to customer`
            });
            
            // Create notifications
            await this.createNotification({
                userId: loan.customerId,
                title: 'Loan Disbursed',
                message: `Your loan of ${Utils.formatCurrency(loan.amount)} has been disbursed to your account`,
                type: 'loan_disbursed',
                data: { loanId, amount: loan.amount }
            });
            
            if (loan.agentId) {
                await this.createNotification({
                    userId: loan.agentId,
                    title: 'Loan Disbursed',
                    message: `Loan ${loanId} has been disbursed to customer`,
                    type: 'loan_disbursed',
                    data: { loanId, customerId: loan.customerId }
                });
            }
            
            // Log audit
            await this.logAudit({
                action: 'disburse_loan',
                userId: loan.customerId,
                details: `Disbursed loan ${loanId} for ${Utils.formatCurrency(loan.amount)}`,
                performedBy: AppState.currentUser.uid
            });
            
            Utils.hideLoading();
            return { success: true, loanId, transactionId };
        } catch (error) {
            console.error('SUDO: Error disbursing loan:', error);
            Utils.hideLoading();
            return { success: false, error: error.message };
        }
    },
    
    async getLoanDetails(loanId) {
        try {
            const loanRef = db.ref(`loans/${loanId}`);
            const snapshot = await loanRef.once('value');
            const loan = snapshot.val();
            
            if (!loan) return null;
            
            // Load customer details
            let customer = {};
            if (loan.customerId) {
                const customerRef = db.ref(`users/${loan.customerId}`);
                const customerSnapshot = await customerRef.once('value');
                customer = customerSnapshot.val() || {};
            }
            
            // Load agent details
            let agent = {};
            if (loan.agentId) {
                const agentRef = db.ref(`agents/${loan.agentId}`);
                const agentSnapshot = await agentRef.once('value');
                agent = agentSnapshot.val() || {};
            }
            
            // Load repayment history
            const repaymentsRef = db.ref('repayments');
            const repaymentsSnapshot = await repaymentsRef.once('value');
            const allRepayments = repaymentsSnapshot.val() || {};
            const loanRepayments = Object.values(allRepayments)
                .filter(r => r.loanId === loanId)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            return {
                ...loan,
                customer: {
                    ...customer,
                    id: loan.customerId
                },
                agent: {
                    ...agent,
                    id: loan.agentId
                },
                repayments: loanRepayments
            };
        } catch (error) {
            console.error('SUDO: Error getting loan details:', error);
            return null;
        }
    },
    
    async createNotification(notificationData) {
        try {
            const notificationId = Utils.generateId('NOTIF_');
            const notification = {
                notificationId,
                ...notificationData,
                timestamp: Date.now(),
                read: false
            };
            
            await db.ref(`notifications/${notificationId}`).set(notification);
            return { success: true, notificationId };
        } catch (error) {
            console.error('SUDO: Error creating notification:', error);
            return { success: false, error: error.message };
        }
    },
    
    async updateLoan(loanId, updates) {
        try {
            await db.ref(`loans/${loanId}`).update(updates);
            
            // Log audit
            await this.logAudit({
                action: 'update_loan',
                details: `Updated loan ${loanId}: ${JSON.stringify(updates)}`,
                performedBy: AppState.currentUser.uid
            });
            
            return { success: true };
        } catch (error) {
            console.error('SUDO: Error updating loan:', error);
            return { success: false, error: error.message };
        }
    },
    
    async bulkApproveLoans(loanIds) {
        try {
            Utils.showLoading(`Approving ${loanIds.length} loans...`);
            
            const results = [];
            for (const loanId of loanIds) {
                try {
                    const result = await this.approveLoan(loanId);
                    results.push({ loanId, success: result.success, error: result.error });
                } catch (error) {
                    results.push({ loanId, success: false, error: error.message });
                }
            }
            
            Utils.hideLoading();
            
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            return {
                success: failed === 0,
                results,
                summary: {
                    total: loanIds.length,
                    successful,
                    failed
                }
            };
        } catch (error) {
            console.error('SUDO: Error in bulk approve:', error);
            Utils.hideLoading();
            return { success: false, error: error.message };
        }
    },
    
    async bulkDenyLoans(loanIds, reason = 'Bulk denial by administrator') {
        try {
            Utils.showLoading(`Denying ${loanIds.length} loans...`);
            
            const results = [];
            for (const loanId of loanIds) {
                try {
                    const result = await this.denyLoan(loanId, reason);
                    results.push({ loanId, success: result.success, error: result.error });
                } catch (error) {
                    results.push({ loanId, success: false, error: error.message });
                }
            }
            
            Utils.hideLoading();
            
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            return {
                success: failed === 0,
                results,
                summary: {
                    total: loanIds.length,
                    successful,
                    failed
                }
            };
        } catch (error) {
            console.error('SUDO: Error in bulk deny:', error);
            Utils.hideLoading();
            return { success: false, error: error.message };
        }
    },
    
    async searchLoansAdvanced(filters) {
        try {
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            // Load customers and agents
            const customersRef = db.ref('users');
            const customersSnapshot = await customersRef.once('value');
            const customers = customersSnapshot.val() || {};
            
            const agentsRef = db.ref('agents');
            const agentsSnapshot = await agentsRef.once('value');
            const agents = agentsSnapshot.val() || {};
            
            // Apply filters
            let filteredLoans = Object.entries(loans)
                .map(([loanId, loan]) => {
                    const customer = customers[loan.customerId] || {};
                    const agent = agents[loan.agentId] || {};
                    return {
                        loanId,
                        ...loan,
                        customerName: customer.fullName || 'Unknown',
                        customerPhone: customer.phone || 'N/A',
                        agentName: agent.fullName || 'Unknown'
                    };
                })
                .filter(loan => {
                    // Status filter
                    if (filters.status && filters.status !== 'all' && loan.status !== filters.status) {
                        return false;
                    }
                    
                    // Date range filter
                    if (filters.dateFrom) {
                        const fromDate = new Date(filters.dateFrom).getTime();
                        const loanDate = loan.applicationDate || loan.createdAt;
                        if (loanDate < fromDate) return false;
                    }
                    
                    if (filters.dateTo) {
                        const toDate = new Date(filters.dateTo).getTime();
                        const loanDate = loan.applicationDate || loan.createdAt;
                        if (loanDate > toDate) return false;
                    }
                    
                    // Amount range filter
                    if (filters.minAmount && loan.amount < filters.minAmount) return false;
                    if (filters.maxAmount && loan.amount > filters.maxAmount) return false;
                    
                    // Search term
                    if (filters.searchTerm) {
                        const search = filters.searchTerm.toLowerCase();
                        return (
                            loan.customerName.toLowerCase().includes(search) ||
                            loan.loanId.toLowerCase().includes(search) ||
                            loan.customerPhone.includes(search) ||
                            loan.agentName.toLowerCase().includes(search)
                        );
                    }
                    
                    return true;
                })
                .sort((a, b) => (b.applicationDate || b.createdAt) - (a.applicationDate || a.createdAt));
            
            return { success: true, loans: filteredLoans, count: filteredLoans.length };
        } catch (error) {
            console.error('SUDO: Error in advanced loan search:', error);
            return { success: false, error: error.message };
        }
    },
    
    async exportLoans(format = 'csv', filters = {}) {
        try {
            Utils.showLoading('Exporting loan data...');
            
            const result = await this.searchLoansAdvanced(filters);
            
            if (!result.success || !result.loans) {
                throw new Error('Failed to fetch loan data');
            }
            
            const loans = result.loans;
            let exportContent = '';
            let mimeType = '';
            let filename = `loans_export_${new Date().toISOString().split('T')[0]}`;
            
            if (format === 'csv') {
                // CSV headers
                const headers = [
                    'Loan ID',
                    'Customer Name',
                    'Customer Phone',
                    'Agent Name',
                    'Amount',
                    'Status',
                    'Application Date',
                    'Approval Date',
                    'Due Date',
                    'Interest Rate',
                    'Duration',
                    'Purpose'
                ];
                
                // CSV rows
                const rows = loans.map(loan => [
                    loan.loanId,
                    `"${loan.customerName}"`,
                    `"${loan.customerPhone}"`,
                    `"${loan.agentName}"`,
                    loan.amount,
                    loan.status,
                    Utils.formatDate(loan.applicationDate || loan.createdAt),
                    loan.approvedAt ? Utils.formatDate(loan.approvedAt) : '',
                    loan.dueDate ? Utils.formatDate(loan.dueDate) : '',
                    loan.interestRate || '',
                    loan.duration || '',
                    `"${loan.purpose || ''}"`
                ]);
                
                exportContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                mimeType = 'text/csv';
                filename += '.csv';
            } else if (format === 'json') {
                exportContent = JSON.stringify(loans, null, 2);
                mimeType = 'application/json';
                filename += '.json';
            } else if (format === 'excel') {
                // For Excel, we'll create CSV (simplified)
                exportContent = this.convertLoansToCSV(loans);
                mimeType = 'text/csv';
                filename += '.csv';
            }
            
            // Create download
            const blob = new Blob([exportContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Log export
            await this.logAudit({
                action: 'export_loans',
                details: `Exported ${loans.length} loans in ${format} format`,
                performedBy: AppState.currentUser.uid
            });
            
            Utils.hideLoading();
            Utils.showNotification('Success', `Exported ${loans.length} loans successfully`, 'success');
            
            return { success: true, count: loans.length, filename };
        } catch (error) {
            console.error('SUDO: Error exporting loans:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to export loans', 'error');
            return { success: false, error: error.message };
        }
    },
    
    convertLoansToCSV(loans) {
        const headers = [
            'Loan ID',
            'Customer Name',
            'Customer Phone',
            'Agent Name',
            'Amount',
            'Status',
            'Application Date',
            'Approval Date',
            'Due Date',
            'Interest Rate',
            'Duration',
            'Purpose',
            'Collateral',
            'Notes'
        ];
        
        const rows = loans.map(loan => [
            loan.loanId,
            loan.customerName,
            loan.customerPhone,
            loan.agentName,
            loan.amount,
            loan.status,
            Utils.formatDate(loan.applicationDate || loan.createdAt),
            loan.approvedAt ? Utils.formatDate(loan.approvedAt) : '',
            loan.dueDate ? Utils.formatDate(loan.dueDate) : '',
            loan.interestRate || '',
            loan.duration || '',
            loan.purpose || '',
            loan.collateralType || '',
            loan.notes || ''
        ]);
        
        return [headers, ...rows].map(row => 
            row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
        ).join('\n');
    },
    
    async getLoanAnalytics(timeRange = 'month') {
        try {
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            const now = Date.now();
            let timeThreshold = now;
            
            switch (timeRange) {
                case 'day':
                    timeThreshold = now - (24 * 60 * 60 * 1000);
                    break;
                case 'week':
                    timeThreshold = now - (7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    timeThreshold = now - (30 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    timeThreshold = now - (365 * 24 * 60 * 60 * 1000);
                    break;
            }
            
            const recentLoans = Object.values(loans).filter(loan => 
                (loan.applicationDate || loan.createdAt) > timeThreshold
            );
            
            const analytics = {
                total: recentLoans.length,
                totalAmount: recentLoans.reduce((sum, loan) => sum + (loan.amount || 0), 0),
                byStatus: {},
                byDay: {},
                approvalRate: 0,
                averageLoanAmount: 0
            };
            
            // Group by status
            recentLoans.forEach(loan => {
                analytics.byStatus[loan.status] = (analytics.byStatus[loan.status] || 0) + 1;
            });
            
            // Group by day
            recentLoans.forEach(loan => {
                const date = new Date(loan.applicationDate || loan.createdAt).toLocaleDateString();
                analytics.byDay[date] = (analytics.byDay[date] || 0) + 1;
            });
            
            // Calculate approval rate
            const approved = analytics.byStatus.approved || 0;
            const denied = analytics.byStatus.denied || 0;
            const pending = analytics.byStatus.pending || 0;
            analytics.approvalRate = approved + denied > 0 ? 
                (approved / (approved + denied) * 100).toFixed(1) : 0;
            
            // Calculate average loan amount
            analytics.averageLoanAmount = recentLoans.length > 0 ? 
                analytics.totalAmount / recentLoans.length : 0;
            
            return { success: true, analytics };
        } catch (error) {
            console.error('SUDO: Error getting loan analytics:', error);
            return { success: false, error: error.message };
        }
    },
    
    async initRealTimeLoanListeners() {
        // Real-time loan updates
        db.ref('loans').on('value', (snapshot) => {
            const loans = snapshot.val() || {};
            const pendingCount = Object.values(loans).filter(loan => loan.status === 'pending').length;
            
            // Update badge in sidebar
            const loanBadge = document.getElementById('loanBadge');
            if (loanBadge) {
                loanBadge.textContent = pendingCount;
                loanBadge.style.display = pendingCount > 0 ? 'flex' : 'none';
            }
            
            // If we're on the loans page, refresh
            if (AppState.currentSection === 'loanApplications') {
                this.loadLoanApplications(
                    AppState.pagination.loans.currentPage,
                    document.getElementById('loanStatusFilter')?.value || 'pending',
                    document.getElementById('loanSearch')?.value || ''
                );
            }
        });
    }
};

// ===== ENHANCED UTILITIES =====
const EnhancedUtils = {
    ...Utils,
    
    formatLoanDetails(loan) {
        return `
            <div class="loan-details-container">
                <div class="loan-header">
                    <div class="d-flex align-center gap-12">
                        <div class="loan-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 18px;">Loan Application Details</h3>
                            <div class="text-muted" style="font-size: 12px;">ID: ${loan.loanId}</div>
                        </div>
                    </div>
                    <div>
                        <span class="status-badge ${ExtendedFirebaseService.getLoanStatusClass(loan.status)}">
                            ${loan.status || 'Pending'}
                        </span>
                    </div>
                </div>
                
                <div class="loan-info-grid">
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-user" style="margin-right: 8px;"></i>Customer Information
                        </h4>
                        <div class="info-item">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${loan.customer?.fullName || loan.customerName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${loan.customer?.phone || loan.customerPhone || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${loan.customer?.email || 'N/A'}</span>
                        </div>
                        ${loan.customerPhoto ? `
                            <div class="info-item">
                                <span class="info-label">Photo:</span>
                                <div style="margin-top: 8px;">
                                    <img src="${loan.customerPhoto}" alt="Customer" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid var(--macos-gray-200);">
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-id-badge" style="margin-right: 8px;"></i>Agent Information
                        </h4>
                        <div class="info-item">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${loan.agent?.fullName || loan.agentName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ID:</span>
                            <span class="info-value">${loan.agentId || 'N/A'}</span>
                        </div>
                        ${loan.agentPhoto ? `
                            <div class="info-item">
                                <span class="info-label">Photo:</span>
                                <div style="margin-top: 8px;">
                                    <img src="${loan.agentPhoto}" alt="Agent" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid var(--macos-gray-200);">
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-money-bill-wave" style="margin-right: 8px;"></i>Loan Details
                        </h4>
                        <div class="info-item">
                            <span class="info-label">Amount:</span>
                            <span class="info-value font-bold">${this.formatCurrency(loan.amount || 0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Interest Rate:</span>
                            <span class="info-value">${loan.interestRate || 0}%</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Duration:</span>
                            <span class="info-value">${loan.duration || 0} ${loan.durationUnit || 'days'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Purpose:</span>
                            <span class="info-value">${loan.purpose || 'Not specified'}</span>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>Timeline
                        </h4>
                        <div class="info-item">
                            <span class="info-label">Applied:</span>
                            <span class="info-value">${this.formatDate(loan.applicationDate || loan.createdAt)}</span>
                        </div>
                        ${loan.approvedAt ? `
                            <div class="info-item">
                                <span class="info-label">Approved:</span>
                                <span class="info-value">${this.formatDate(loan.approvedAt)}</span>
                            </div>
                        ` : ''}
                        ${loan.deniedAt ? `
                            <div class="info-item">
                                <span class="info-label">Denied:</span>
                                <span class="info-value">${this.formatDate(loan.deniedAt)}</span>
                            </div>
                        ` : ''}
                        <div class="info-item">
                            <span class="info-label">Due Date:</span>
                            <span class="info-value">${loan.dueDate ? this.formatDate(loan.dueDate) : 'Not set'}</span>
                        </div>
                    </div>
                </div>
                
                ${loan.collateralDocuments || loan.attachments ? `
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-paperclip" style="margin-right: 8px;"></i>Documents & Attachments
                        </h4>
                        ${loan.collateralDocuments ? `
                            <div class="info-item">
                                <span class="info-label">Collateral:</span>
                                <div style="margin-top: 8px;">
                                    ${this.renderDocuments(loan.collateralDocuments)}
                                </div>
                            </div>
                        ` : ''}
                        ${loan.attachments ? `
                            <div class="info-item">
                                <span class="info-label">Attachments:</span>
                                <div style="margin-top: 8px;">
                                    ${this.renderDocuments(loan.attachments)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                ${loan.notes || loan.reviewNotes ? `
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-sticky-note" style="margin-right: 8px;"></i>Notes
                        </h4>
                        <div style="background: var(--macos-gray-100); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--macos-gray-600);">
                                ${loan.notes || loan.reviewNotes || 'No notes available'}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${loan.repayments && loan.repayments.length > 0 ? `
                    <div class="info-section">
                        <h4 style="margin-bottom: 12px; color: var(--macos-gray-600);">
                            <i class="fas fa-history" style="margin-right: 8px;"></i>Repayment History
                        </h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--macos-gray-100);">
                                        <th style="padding: 8px; text-align: left; font-size: 11px;">Date</th>
                                        <th style="padding: 8px; text-align: left; font-size: 11px;">Amount</th>
                                        <th style="padding: 8px; text-align: left; font-size: 11px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loan.repayments.map(repayment => `
                                        <tr style="border-bottom: 1px solid var(--macos-gray-200);">
                                            <td style="padding: 8px; font-size: 12px;">${this.formatDate(repayment.timestamp)}</td>
                                            <td style="padding: 8px; font-size: 12px;">${this.formatCurrency(repayment.amount)}</td>
                                            <td style="padding: 8px; font-size: 12px;">
                                                <span class="status-badge ${repayment.status === 'paid' ? 'status-active' : 'status-pending'}">
                                                    ${repayment.status || 'pending'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                ${loan.status === 'pending' ? `
                    <div class="action-buttons" style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--macos-gray-200);">
                        <button class="btn btn-success" onclick="approveLoan('${loan.loanId}')" style="margin-right: 8px;">
                            <i class="fas fa-check"></i> Approve Loan
                        </button>
                        <button class="btn btn-danger" onclick="denyLoanPrompt('${loan.loanId}')">
                            <i class="fas fa-times"></i> Deny Loan
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    },
    
    renderDocuments(documents) {
        if (typeof documents === 'string') {
            return `
                <a href="${documents}" target="_blank" class="btn btn-sm btn-outline">
                    <i class="fas fa-external-link-alt"></i> View Document
                </a>
            `;
        } else if (Array.isArray(documents)) {
            return documents.map(doc => `
                <a href="${doc.url || doc}" target="_blank" class="btn btn-sm btn-outline" style="margin-right: 8px; margin-bottom: 8px;">
                    <i class="fas fa-file"></i> ${doc.name || 'Document'}
                </a>
            `).join('');
        } else if (typeof documents === 'object') {
            return Object.entries(documents).map(([key, url]) => `
                <a href="${url}" target="_blank" class="btn btn-sm btn-outline" style="margin-right: 8px; margin-bottom: 8px;">
                    <i class="fas fa-file"></i> ${key}
                </a>
            `).join('');
        }
        return 'No documents available';
    },
    
    showImageModal(imageUrl, title = 'Image Preview') {
        const modalId = 'imagePreviewModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 0; display: flex; justify-content: center; align-items: center; min-height: 300px;">
                        <img src="${imageUrl}" alt="${title}" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            modal.querySelector('img').src = imageUrl;
            modal.querySelector('.modal-title').textContent = title;
        }
        
        this.openModal(modalId);
    },
    
    showConfirmationWithInput(title, message, confirmCallback, placeholder = 'Enter reason', confirmText = 'Confirm') {
        const modalId = 'confirmationWithInputModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 16px;">${message}</p>
                        <div class="form-group">
                            <textarea id="confirmationInput" class="form-control form-textarea" placeholder="${placeholder}" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="Utils.closeModal('${modalId}')">Cancel</button>
                        <button class="btn btn-primary" id="confirmWithInputBtn">${confirmText}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listener
            document.getElementById('confirmWithInputBtn').onclick = () => {
                const input = document.getElementById('confirmationInput').value.trim();
                if (input) {
                    confirmCallback(input);
                    this.closeModal(modalId);
                } else {
                    this.showNotification('Error', 'Please enter a reason', 'error');
                }
            };
        } else {
            modal.querySelector('.modal-title').textContent = title;
            modal.querySelector('p').textContent = message;
            modal.querySelector('textarea').placeholder = placeholder;
            modal.querySelector('#confirmWithInputBtn').textContent = confirmText;
            modal.querySelector('textarea').value = '';
        }
        
        this.openModal(modalId);
    }
};

// ===== LOAN MANAGEMENT UI =====
const LoanUIManager = {
    init() {
        this.bindLoanEvents();
        this.initLoanCharts();
        this.setupLoanSearchHandlers();
    },
    
    bindLoanEvents() {
        // Loan status filter
        const loanStatusFilter = document.getElementById('loanStatusFilter');
        if (loanStatusFilter) {
            loanStatusFilter.addEventListener('change', () => this.filterLoans());
        }
        
        // Loan search
        const loanSearch = document.getElementById('loanSearch');
        if (loanSearch) {
            loanSearch.addEventListener('input', Utils.debounce(() => this.searchLoans(), 300));
        }
        
        // Advanced search toggle
        const advancedSearchToggle = document.getElementById('advancedSearchToggle');
        if (advancedSearchToggle) {
            advancedSearchToggle.addEventListener('click', () => this.toggleAdvancedSearch());
        }
        
        // Export buttons
        const exportBtn = document.getElementById('exportLoansBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.openExportModal());
        }
        
        // Bulk actions
        const selectAllLoans = document.getElementById('selectAllLoans');
        if (selectAllLoans) {
            selectAllLoans.addEventListener('change', (e) => this.toggleSelectAllLoans(e.target.checked));
        }
        
        const bulkApproveBtn = document.getElementById('bulkApproveLoans');
        if (bulkApproveBtn) {
            bulkApproveBtn.addEventListener('click', () => this.bulkApproveSelected());
        }
        
        const bulkDenyBtn = document.getElementById('bulkDenyLoans');
        if (bulkDenyBtn) {
            bulkDenyBtn.addEventListener('click', () => this.bulkDenySelected());
        }
    },
    
    initLoanCharts() {
        // Initialize loan analytics charts
        this.loadLoanAnalytics();
    },
    
    setupLoanSearchHandlers() {
        // Advanced search form
        const advancedSearchForm = document.getElementById('advancedSearchForm');
        if (advancedSearchForm) {
            advancedSearchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.performAdvancedSearch();
            });
        }
        
        // Reset advanced search
        const resetAdvancedSearch = document.getElementById('resetAdvancedSearch');
        if (resetAdvancedSearch) {
            resetAdvancedSearch.addEventListener('click', () => this.resetAdvancedSearch());
        }
    },
    
    async filterLoans() {
        const status = document.getElementById('loanStatusFilter')?.value || 'pending';
        const searchTerm = document.getElementById('loanSearch')?.value || '';
        await ExtendedFirebaseService.loadLoanApplications(1, status, searchTerm);
    },
    
    async searchLoans() {
        await this.filterLoans();
    },
    
    toggleAdvancedSearch() {
        const advancedSearch = document.getElementById('advancedSearchSection');
        if (advancedSearch) {
            advancedSearch.style.display = advancedSearch.style.display === 'none' ? 'block' : 'none';
        }
    },
    
    async performAdvancedSearch() {
        const filters = {
            status: document.getElementById('advStatusFilter')?.value || 'all',
            dateFrom: document.getElementById('advDateFrom')?.value || '',
            dateTo: document.getElementById('advDateTo')?.value || '',
            minAmount: document.getElementById('advMinAmount')?.value || '',
            maxAmount: document.getElementById('advMaxAmount')?.value || '',
            searchTerm: document.getElementById('advSearchTerm')?.value || ''
        };
        
        // Convert amounts to numbers
        if (filters.minAmount) filters.minAmount = parseFloat(filters.minAmount);
        if (filters.maxAmount) filters.maxAmount = parseFloat(filters.maxAmount);
        
        Utils.showLoading('Searching loans...');
        const result = await ExtendedFirebaseService.searchLoansAdvanced(filters);
        Utils.hideLoading();
        
        if (result.success) {
            this.displayAdvancedSearchResults(result.loans);
        } else {
            Utils.showNotification('Error', result.error || 'Search failed', 'error');
        }
    },
    
    displayAdvancedSearchResults(loans) {
        const resultsBody = document.getElementById('advancedSearchResults');
        if (!resultsBody) return;
        
        if (loans.length === 0) {
            resultsBody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted">No loans found matching your criteria</td>
                </tr>
            `;
            return;
        }
        
        resultsBody.innerHTML = '';
        
        loans.forEach(loan => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${loan.loanId}</td>
                <td>${loan.customerName}</td>
                <td>${loan.agentName}</td>
                <td>${Utils.formatCurrency(loan.amount)}</td>
                <td><span class="status-badge ${ExtendedFirebaseService.getLoanStatusClass(loan.status)}">${loan.status}</span></td>
                <td>${Utils.formatDateShort(loan.applicationDate || loan.createdAt)}</td>
                <td>
                    <button class="btn btn-sm btn-outline" onclick="viewLoanDetails('${loan.loanId}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            resultsBody.appendChild(row);
        });
    },
    
    resetAdvancedSearch() {
        const form = document.getElementById('advancedSearchForm');
        if (form) form.reset();
        this.performAdvancedSearch();
    },
    
    openExportModal() {
        const modalId = 'exportLoansModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Export Loan Data</h3>
                        <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Export Format</label>
                            <select class="form-control" id="exportFormat">
                                <option value="csv">CSV (Excel)</option>
                                <option value="json">JSON</option>
                                <option value="excel">Excel (CSV)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <div class="form-row">
                                <input type="date" class="form-control" id="exportDateFrom">
                                <input type="date" class="form-control" id="exportDateTo">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status Filter</label>
                            <select class="form-control" id="exportStatusFilter">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="denied">Denied</option>
                                <option value="disbursed">Disbursed</option>
                                <option value="active">Active</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="Utils.closeModal('${modalId}')">Cancel</button>
                        <button class="btn btn-primary" onclick="LoanUIManager.performExport()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        Utils.openModal(modalId);
    },
    
    async performExport() {
        const format = document.getElementById('exportFormat')?.value || 'csv';
        const filters = {
            dateFrom: document.getElementById('exportDateFrom')?.value || '',
            dateTo: document.getElementById('exportDateTo')?.value || '',
            status: document.getElementById('exportStatusFilter')?.value || 'all'
        };
        
        await ExtendedFirebaseService.exportLoans(format, filters);
        Utils.closeModal('exportLoansModal');
    },
    
    toggleSelectAllLoans(checked) {
        const checkboxes = document.querySelectorAll('.loan-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        
        this.updateBulkActionButtons();
    },
    
    getSelectedLoanIds() {
        const checkboxes = document.querySelectorAll('.loan-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.dataset.loanId);
    },
    
    updateBulkActionButtons() {
        const selectedCount = this.getSelectedLoanIds().length;
        const bulkApproveBtn = document.getElementById('bulkApproveLoans');
        const bulkDenyBtn = document.getElementById('bulkDenyLoans');
        
        if (bulkApproveBtn && bulkDenyBtn) {
            bulkApproveBtn.disabled = selectedCount === 0;
            bulkDenyBtn.disabled = selectedCount === 0;
            
            bulkApproveBtn.innerHTML = `<i class="fas fa-check"></i> Approve (${selectedCount})`;
            bulkDenyBtn.innerHTML = `<i class="fas fa-times"></i> Deny (${selectedCount})`;
        }
    },
    
    async bulkApproveSelected() {
        const loanIds = this.getSelectedLoanIds();
        if (loanIds.length === 0) {
            Utils.showNotification('Info', 'No loans selected', 'info');
            return;
        }
        
        Utils.confirmAction(
            'Bulk Approve Loans',
            `Are you sure you want to approve ${loanIds.length} loan applications?`,
            async () => {
                const result = await ExtendedFirebaseService.bulkApproveLoans(loanIds);
                
                if (result.success) {
                    Utils.showNotification(
                        'Success',
                        `Successfully approved ${result.summary.successful} out of ${result.summary.total} loans`,
                        'success'
                    );
                    
                    // Refresh loan list
                    await ExtendedFirebaseService.loadLoanApplications();
                    
                    // Clear selections
                    document.getElementById('selectAllLoans').checked = false;
                    this.toggleSelectAllLoans(false);
                } else {
                    Utils.showNotification('Error', 'Failed to approve some loans', 'error');
                }
            },
            `Approve ${loanIds.length} Loans`,
            'success'
        );
    },
    
    async bulkDenySelected() {
        const loanIds = this.getSelectedLoanIds();
        if (loanIds.length === 0) {
            Utils.showNotification('Info', 'No loans selected', 'info');
            return;
        }
        
        EnhancedUtils.showConfirmationWithInput(
            'Bulk Deny Loans',
            `Please provide a reason for denying ${loanIds.length} loan applications:`,
            async (reason) => {
                const result = await ExtendedFirebaseService.bulkDenyLoans(loanIds, reason);
                
                if (result.success) {
                    Utils.showNotification(
                        'Success',
                        `Successfully denied ${result.summary.successful} out of ${result.summary.total} loans`,
                        'success'
                    );
                    
                    // Refresh loan list
                    await ExtendedFirebaseService.loadLoanApplications();
                    
                    // Clear selections
                    document.getElementById('selectAllLoans').checked = false;
                    this.toggleSelectAllLoans(false);
                } else {
                    Utils.showNotification('Error', 'Failed to deny some loans', 'error');
                }
            },
            'Enter reason for denial...',
            `Deny ${loanIds.length} Loans`
        );
    },
    
    async loadLoanAnalytics() {
        try {
            const result = await ExtendedFirebaseService.getLoanAnalytics('month');
            if (result.success) {
                this.updateLoanAnalyticsUI(result.analytics);
                this.createLoanAnalyticsChart(result.analytics);
            }
        } catch (error) {
            console.error('Error loading loan analytics:', error);
        }
    },
    
    updateLoanAnalyticsUI(analytics) {
        // Update various UI elements with analytics data
        const elements = {
            'totalLoansCount': analytics.total,
            'totalLoanVolume': Utils.formatCurrency(analytics.totalAmount),
            'approvalRate': `${analytics.approvalRate}%`,
            'avgLoanAmount': Utils.formatCurrency(analytics.averageLoanAmount),
            'pendingLoansCount': analytics.byStatus.pending || 0,
            'approvedLoansCount': analytics.byStatus.approved || 0
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    },
    
    createLoanAnalyticsChart(analytics) {
        const ctx = document.getElementById('loanAnalyticsChart');
        if (!ctx) return;
        
        const statusData = {
            labels: Object.keys(analytics.byStatus),
            datasets: [{
                data: Object.values(analytics.byStatus),
                backgroundColor: [
                    'rgba(0, 122, 255, 0.8)',  // Pending - blue
                    'rgba(52, 199, 89, 0.8)',   // Approved - green
                    'rgba(255, 59, 48, 0.8)',   // Denied - red
                    'rgba(255, 149, 0, 0.8)',   // Disbursed - orange
                    'rgba(88, 86, 214, 0.8)'    // Active - purple
                ]
            }]
        };
        
        new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: statusData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    },
    
    async showLoanStatistics() {
        const modalId = 'loanStatisticsModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Loan Statistics & Analytics</h3>
                        <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div>
                                        <div class="stat-label">Total Loans</div>
                                        <div class="stat-value" id="statsTotalLoans">0</div>
                                    </div>
                                    <div class="stat-icon users"><i class="fas fa-file-invoice-dollar"></i></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div>
                                        <div class="stat-label">Total Volume</div>
                                        <div class="stat-value" id="statsTotalVolume">$0</div>
                                    </div>
                                    <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div>
                                        <div class="stat-label">Approval Rate</div>
                                        <div class="stat-value" id="statsApprovalRate">0%</div>
                                    </div>
                                    <div class="stat-icon agents"><i class="fas fa-chart-line"></i></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div>
                                        <div class="stat-label">Avg Loan Size</div>
                                        <div class="stat-value" id="statsAvgLoan">$0</div>
                                    </div>
                                    <div class="stat-icon transactions"><i class="fas fa-calculator"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Loan Status Distribution</div>
                            <canvas id="statsLoanChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Load and display statistics
        const result = await ExtendedFirebaseService.getLoanAnalytics('all');
        if (result.success) {
            const stats = result.analytics;
            
            document.getElementById('statsTotalLoans').textContent = stats.total;
            document.getElementById('statsTotalVolume').textContent = Utils.formatCurrency(stats.totalAmount);
            document.getElementById('statsApprovalRate').textContent = `${stats.approvalRate}%`;
            document.getElementById('statsAvgLoan').textContent = Utils.formatCurrency(stats.averageLoanAmount);
            
            // Create chart
            setTimeout(() => {
                this.createStatsChart(stats);
            }, 100);
        }
        
        Utils.openModal(modalId);
    },
    
    createStatsChart(analytics) {
        const ctx = document.getElementById('statsLoanChart');
        if (!ctx) return;
        
        const labels = Object.keys(analytics.byStatus);
        const data = Object.values(analytics.byStatus);
        
        new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Loans',
                    data: data,
                    backgroundColor: 'rgba(0, 122, 255, 0.6)',
                    borderColor: 'rgba(0, 122, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
};

// ===== GLOBAL LOAN FUNCTIONS =====
async function viewLoanDetails(loanId) {
    try {
        Utils.showLoading('Loading loan details...');
        const loan = await ExtendedFirebaseService.getLoanDetails(loanId);
        Utils.hideLoading();
        
        if (!loan) {
            Utils.showNotification('Error', 'Loan not found', 'error');
            return;
        }
        
        const modalId = 'viewLoanModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Loan Application Details</h3>
                        <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" id="loanDetailsContent" style="max-height: 70vh; overflow-y: auto;"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        const content = document.getElementById('loanDetailsContent');
        if (content) {
            content.innerHTML = EnhancedUtils.formatLoanDetails(loan);
        }
        
        Utils.openModal(modalId);
    } catch (error) {
        Utils.hideLoading();
        Utils.showNotification('Error', 'Failed to load loan details', 'error');
    }
}

async function approveLoan(loanId) {
    Utils.confirmAction(
        'Approve Loan',
        'Are you sure you want to approve this loan application?',
        async () => {
            const result = await ExtendedFirebaseService.approveLoan(loanId);
            if (result.success) {
                Utils.showNotification('Success', 'Loan approved successfully', 'success');
                
                // Close modal if open
                Utils.closeModal('viewLoanModal');
                
                // Refresh loan list
                await ExtendedFirebaseService.loadLoanApplications();
            } else {
                Utils.showNotification('Error', result.error || 'Failed to approve loan', 'error');
            }
        },
        'Approve',
        'success'
    );
}

async function denyLoanPrompt(loanId) {
    EnhancedUtils.showConfirmationWithInput(
        'Deny Loan Application',
        'Please provide a reason for denying this loan application:',
        async (reason) => {
            const result = await ExtendedFirebaseService.denyLoan(loanId, reason);
            if (result.success) {
                Utils.showNotification('Success', 'Loan denied successfully', 'success');
                
                // Close modal if open
                Utils.closeModal('viewLoanModal');
                
                // Refresh loan list
                await ExtendedFirebaseService.loadLoanApplications();
            } else {
                Utils.showNotification('Error', result.error || 'Failed to deny loan', 'error');
            }
        },
        'Enter reason for denial...',
        'Deny Loan'
    );
}

async function denyLoan(loanId, reason = '') {
    if (!reason) {
        denyLoanPrompt(loanId);
        return;
    }
    
    const result = await ExtendedFirebaseService.denyLoan(loanId, reason);
    if (result.success) {
        Utils.showNotification('Success', 'Loan denied successfully', 'success');
        await ExtendedFirebaseService.loadLoanApplications();
    } else {
        Utils.showNotification('Error', result.error || 'Failed to deny loan', 'error');
    }
}

async function disburseLoan(loanId) {
    Utils.confirmAction(
        'Disburse Loan',
        'Are you sure you want to disburse this approved loan to the customer?',
        async () => {
            const result = await ExtendedFirebaseService.disburseLoan(loanId);
            if (result.success) {
                Utils.showNotification('Success', 'Loan disbursed successfully', 'success');
                await ExtendedFirebaseService.loadLoanApplications();
            } else {
                Utils.showNotification('Error', result.error || 'Failed to disburse loan', 'error');
            }
        },
        'Disburse',
        'success'
    );
}

function viewCollateral(loanId) {
    const loan = AppState.loanApplications?.find(l => l.loanId === loanId);
    if (!loan || !loan.collateralDocuments) {
        Utils.showNotification('Info', 'No collateral documents available', 'info');
        return;
    }
    
    if (typeof loan.collateralDocuments === 'string') {
        EnhancedUtils.showImageModal(loan.collateralDocuments, 'Collateral Document');
    } else {
        // Show list of documents
        const modalId = 'collateralModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Collateral Documents</h3>
                        <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" id="collateralContent"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        const content = document.getElementById('collateralContent');
        if (content) {
            content.innerHTML = EnhancedUtils.renderDocuments(loan.collateralDocuments);
        }
        
        Utils.openModal(modalId);
    }
}

function viewAttachments(loanId) {
    const loan = AppState.loanApplications?.find(l => l.loanId === loanId);
    if (!loan || !loan.attachments) {
        Utils.showNotification('Info', 'No attachments available', 'info');
        return;
    }
    
    const modalId = 'attachmentsModal';
    let modal = document.getElementById(modalId);
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Loan Attachments</h3>
                    <button class="modal-close" onclick="Utils.closeModal('${modalId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" id="attachmentsContent"></div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    const content = document.getElementById('attachmentsContent');
    if (content) {
        content.innerHTML = EnhancedUtils.renderDocuments(loan.attachments);
    }
    
    Utils.openModal(modalId);
}

function viewCustomerPhoto(customerId) {
    const loan = AppState.loanApplications?.find(l => l.customerId === customerId);
    if (!loan || !loan.customerPhoto) {
        Utils.showNotification('Info', 'No customer photo available', 'info');
        return;
    }
    
    EnhancedUtils.showImageModal(loan.customerPhoto, 'Customer Photo');
}

function viewAgentPhoto(agentId) {
    const loan = AppState.loanApplications?.find(l => l.agentId === agentId);
    if (!loan || !loan.agentPhoto) {
        Utils.showNotification('Info', 'No agent photo available', 'info');
        return;
    }
    
    EnhancedUtils.showImageModal(loan.agentPhoto, 'Agent Photo');
}

function openLoanAnalytics() {
    LoanUIManager.showLoanStatistics();
}

function exportLoanReport() {
    LoanUIManager.openExportModal();
}

function refreshLoanList() {
    ExtendedFirebaseService.loadLoanApplications();
    Utils.showNotification('Refreshed', 'Loan list refreshed', 'success');
}

// ===== ENHANCED MOBILE SUPPORT =====
const MobileSupport = {
    init() {
        this.setupMobileNavigation();
        this.setupTouchEvents();
        this.adjustUIForMobile();
        this.setupResponsiveTables();
    },
    
    setupMobileNavigation() {
        // Create mobile menu toggle
        const header = document.querySelector('.sudo-header');
        if (header && window.innerWidth <= 768) {
            const menuToggle = document.createElement('button');
            menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
            menuToggle.className = 'btn btn-icon';
            menuToggle.style.marginRight = '12px';
            menuToggle.onclick = () => this.toggleSidebar();
            
            header.querySelector('.sudo-logo').prepend(menuToggle);
            
            // Add overlay for closing sidebar
            const overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay';
            overlay.onclick = () => this.toggleSidebar(false);
            document.body.appendChild(overlay);
        }
    },
    
    toggleSidebar(show) {
        const sidebar = document.querySelector('.sudo-sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        
        if (sidebar) {
            if (show === undefined) {
                sidebar.classList.toggle('active');
            } else {
                show ? sidebar.classList.add('active') : sidebar.classList.remove('active');
            }
            
            if (overlay) {
                overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
            }
        }
    },
    
    setupTouchEvents() {
        // Add swipe support for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            this.handleSwipe(touchStartX, touchEndX);
        });
        
        // Prevent zoom on input focus
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                e.target.style.fontSize = '16px'; // Prevents iOS zoom
            }
        });
    },
    
    handleSwipe(startX, endX) {
        const swipeThreshold = 50;
        const swipeDistance = endX - startX;
        
        if (Math.abs(swipeDistance) > swipeThreshold) {
            if (swipeDistance > 0 && startX < 50) {
                // Swipe right from left edge - open sidebar
                this.toggleSidebar(true);
            } else if (swipeDistance < 0) {
                // Swipe left - close sidebar if open
                const sidebar = document.querySelector('.sudo-sidebar');
                if (sidebar && sidebar.classList.contains('active')) {
                    this.toggleSidebar(false);
                }
            }
        }
    },
    
    adjustUIForMobile() {
        if (window.innerWidth <= 768) {
            // Adjust table layouts for mobile
            this.convertTablesToCards();
            
            // Adjust button sizes
            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.classList.contains('btn-sm') && !btn.classList.contains('btn-icon')) {
                    btn.style.padding = '12px 16px';
                    btn.style.fontSize = '14px';
                }
            });
            
            // Adjust modal sizes
            document.querySelectorAll('.modal-content').forEach(modal => {
                modal.style.width = '95vw';
                modal.style.maxHeight = '90vh';
            });
            
            // Adjust form controls
            document.querySelectorAll('.form-control').forEach(input => {
                input.style.fontSize = '16px'; // Prevents iOS zoom
                input.style.height = '44px'; // Better touch target
            });
        }
    },
    
    convertTablesToCards() {
        // Convert tables to card layout for mobile
        const tables = document.querySelectorAll('.table-container');
        
        tables.forEach(tableContainer => {
            const table = tableContainer.querySelector('table');
            if (!table || window.innerWidth > 768) return;
            
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
            const rows = table.querySelectorAll('tbody tr');
            
            // Create card layout
            const cardsContainer = document.createElement('div');
            cardsContainer.className = 'cards-container';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const card = document.createElement('div');
                card.className = 'mobile-card';
                
                let cardContent = '';
                headers.forEach((header, index) => {
                    if (cells[index]) {
                        cardContent += `
                            <div class="card-row">
                                <div class="card-label">${header}</div>
                                <div class="card-value">${cells[index].innerHTML}</div>
                            </div>
                        `;
                    }
                });
                
                card.innerHTML = cardContent;
                cardsContainer.appendChild(card);
            });
            
            // Replace table with cards
            table.style.display = 'none';
            tableContainer.appendChild(cardsContainer);
        });
    },
    
    setupResponsiveTables() {
        // Handle window resize
        window.addEventListener('resize', () => {
            this.adjustUIForMobile();
        });
    }
};

// ===== ENHANCED APPLICATION INITIALIZATION =====
const EnhancedAppInitializer = {
    async init() {
        try {
            Utils.showLoading('Initializing Enhanced SUDO Control Panel...');
            
            // Initialize Firebase
            if (!firebaseApp) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.database();
                storage = firebase.storage();
            }
            
            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    AppState.currentUser = user;
                    AppState.isAuthenticated = true;
                    
                    // Update UI with user info
                    document.getElementById('userName').textContent = user.email;
                    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                    
                    // Initialize all services
                    await this.initializeAllServices();
                    
                    // Initialize UI
                    await this.initializeUI();
                    
                    // Initialize mobile support
                    MobileSupport.init();
                    
                    Utils.hideLoading();
                    Utils.showNotification('SUDO Ready', 'Full system control initialized', 'success');
                } else {
                    // No user signed in - redirect to login
                    window.location.href = 'login.html';
                }
            });
            
        } catch (error) {
            console.error('Enhanced initialization error:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to initialize control panel', 'error');
        }
    },
    
    async initializeAllServices() {
        // Initialize all Firebase services in parallel
        await Promise.all([
            ExtendedFirebaseService.loadSystemStats(),
            ExtendedFirebaseService.loadAdmins(),
            ExtendedFirebaseService.loadAgents(),
            ExtendedFirebaseService.loadCustomers(),
            ExtendedFirebaseService.loadFeatureFlags(),
            ExtendedFirebaseService.loadFinancialSettings(),
            ExtendedFirebaseService.loadAuditLogs(),
            ExtendedFirebaseService.loadDisputes(),
            ExtendedFirebaseService.loadRepaymentPlans(),
            ExtendedFirebaseService.loadLoanApplications()
        ]);
        
        // Initialize real-time listeners
        ExtendedFirebaseService.initRealTimeListeners();
        ExtendedFirebaseService.initRealTimeLoanListeners();
    },
    
    async initializeUI() {
        // Initialize main UI manager
        UIManager.init();
        
        // Initialize loan UI manager
        LoanUIManager.init();
        
        // Set up loan section if it exists
        const loanNavItem = document.querySelector('.nav-item[data-section="loanApplications"]');
        if (loanNavItem) {
            loanNavItem.addEventListener('click', () => {
                UIManager.showSection('loanApplications');
            });
        }
        
        // Add loan analytics to dashboard
        this.addLoanAnalyticsToDashboard();
    },
    
    addLoanAnalyticsToDashboard() {
        const dashboardSection = document.getElementById('dashboard');
        if (!dashboardSection) return;
        
        // Add loan stats to dashboard grid
        const statsGrid = dashboardSection.querySelector('.stats-grid');
        if (statsGrid) {
            const loanStatsHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Pending Loans</div>
                            <div class="stat-value" id="pendingLoans">0</div>
                        </div>
                        <div class="stat-icon transactions"><i class="fas fa-clock"></i></div>
                    </div>
                    <div class="stat-change">
                        <span id="loanTrend">--</span> this week
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Loan Volume</div>
                            <div class="stat-value" id="totalLoanAmount">$0</div>
                        </div>
                        <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                    </div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="volumeGrowth">0%</span> this month
                    </div>
                </div>
            `;
            
            // Insert after first two stats
            const firstTwoStats = statsGrid.children[0]?.nextElementSibling;
            if (firstTwoStats) {
                firstTwoStats.insertAdjacentHTML('afterend', loanStatsHTML);
            }
        }
        
        // Add quick action for loans
        const quickActions = dashboardSection.querySelector('.card-body .d-flex.flex-wrap');
        if (quickActions) {
            const loanAction = `
                <button class="btn btn-primary" onclick="UIManager.showSection('loanApplications')">
                    <i class="fas fa-file-invoice-dollar"></i> View Loans
                </button>
            `;
            quickActions.insertAdjacentHTML('beforeend', loanAction);
        }
    }
};

// ===== HTML SECTION FOR LOAN APPLICATIONS =====
// This would be added to the existing HTML structure
const LoanApplicationsHTML = `
    <!-- Loan Applications Section -->
    <section id="loanApplications" class="content-section">
        <div class="section-header">
            <h1 class="section-title">Loan Applications Management</h1>
            <div class="section-subtitle">Review, approve, or deny loan applications in real-time</div>
        </div>

        <div class="stats-grid mb-24">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total Applications</div>
                        <div class="stat-value" id="totalLoans">0</div>
                    </div>
                    <div class="stat-icon users"><i class="fas fa-file-invoice-dollar"></i></div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span id="loanGrowth">0%</span> today
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Pending Review</div>
                        <div class="stat-value" id="pendingLoansCount">0</div>
                    </div>
                    <div class="stat-icon transactions"><i class="fas fa-clock"></i></div>
                </div>
                <div class="stat-change negative">
                    <i class="fas fa-arrow-down"></i>
                    <span id="pendingChange">0%</span> vs yesterday
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Approved Today</div>
                        <div class="stat-value" id="approvedToday">0</div>
                    </div>
                    <div class="stat-icon agents"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span id="approvalRate">0%</span> approval rate
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total Loan Volume</div>
                        <div class="stat-value" id="totalLoanVolume">$0</div>
                    </div>
                    <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span id="volumeChange">0%</span> this week
                </div>
            </div>
        </div>

        <div class="d-flex justify-between align-center mb-24 flex-wrap gap-16">
            <div class="d-flex gap-8 flex-wrap">
                <button class="btn btn-primary" onclick="refreshLoanList()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline" onclick="openLoanAnalytics()">
                    <i class="fas fa-chart-bar"></i> Analytics
                </button>
                <button class="btn btn-outline" onclick="exportLoanReport()">
                    <i class="fas fa-download"></i> Export
                </button>
                <div class="d-flex align-center gap-8">
                    <input type="checkbox" id="selectAllLoans" style="width: 18px; height: 18px;">
                    <button class="btn btn-success" id="bulkApproveLoans" disabled>
                        <i class="fas fa-check"></i> Approve Selected
                    </button>
                    <button class="btn btn-danger" id="bulkDenyLoans" disabled>
                        <i class="fas fa-times"></i> Deny Selected
                    </button>
                </div>
            </div>
            <div class="d-flex gap-8 flex-wrap">
                <select class="form-control" style="width: 160px;" id="loanStatusFilter">
                    <option value="pending">Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="denied">Denied</option>
                    <option value="disbursed">Disbursed</option>
                    <option value="all">All Statuses</option>
                </select>
                <input type="text" class="form-control" style="width: 200px;" placeholder="Search loans..." id="loanSearch">
                <button class="btn btn-outline" id="advancedSearchToggle">
                    <i class="fas fa-filter"></i> Advanced
                </button>
            </div>
        </div>

        <div id="advancedSearchSection" style="display: none; margin-bottom: 24px;">
            <div class="card">
                <div class="card-body">
                    <form id="advancedSearchForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" id="advStatusFilter">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="denied">Denied</option>
                                    <option value="disbursed">Disbursed</option>
                                    <option value="active">Active</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date From</label>
                                <input type="date" class="form-control" id="advDateFrom">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date To</label>
                                <input type="date" class="form-control" id="advDateTo">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Min Amount</label>
                                <input type="number" class="form-control" id="advMinAmount" placeholder="Minimum amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Amount</label>
                                <input type="number" class="form-control" id="advMaxAmount" placeholder="Maximum amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Search Term</label>
                                <input type="text" class="form-control" id="advSearchTerm" placeholder="Customer, Agent, or Loan ID">
                            </div>
                        </div>
                        <div class="d-flex gap-8">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-outline" id="resetAdvancedSearch">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </form>
                    <div class="mt-16">
                        <div class="font-semibold mb-8">Search Results</div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="advancedSearchResults">
                                    <!-- Advanced search results will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="loanApplicationsTable">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Agent</th>
                        <th>Amount</th>
                        <th>Requested</th>
                        <th>Term</th>
                        <th>Applied</th>
                        <th>Status</th>
                        <th>Documents</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="loanApplicationsBody">
                    <!-- Loan application rows will be inserted here -->
                </tbody>
            </table>
        </div>
        <div class="pagination" id="loanPagination"></div>

        <div class="card mt-24">
            <div class="card-header">
                <div class="card-title">Loan Analytics</div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="loanAnalyticsChart"></canvas>
                </div>
            </div>
        </div>
    </section>
`;

// ===== ADD LOAN NAV ITEM TO SIDEBAR =====
const LoanNavItemHTML = `
    <div class="nav-item" data-section="loanApplications">
        <div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
        <div class="nav-text">Loan Applications</div>
        <div class="nav-badge" id="loanBadge" style="display: none;">0</div>
    </div>
`;

// ===== ADDITIONAL CSS FOR MOBILE AND LOAN MANAGEMENT =====
const AdditionalCSS = `
    /* Mobile sidebar overlay */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 899;
    }
    
    /* Mobile cards for tables */
    .cards-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .mobile-card {
        background: white;
        border-radius: var(--macos-border-radius);
        padding: 16px;
        border: 1px solid var(--macos-gray-200);
    }
    
    .card-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--macos-gray-100);
    }
    
    .card-row:last-child {
        border-bottom: none;
    }
    
    .card-label {
        font-weight: 600;
        color: var(--macos-gray-500);
        font-size: 12px;
    }
    
    .card-value {
        color: var(--macos-gray-600);
        font-size: 13px;
    }
    
    /* Loan details styling */
    .loan-details-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .loan-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--macos-gray-200);
    }
    
    .loan-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
    }
    
    .loan-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .info-section {
        background: var(--macos-gray-100);
        padding: 16px;
        border-radius: var(--macos-border-radius);
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .info-label {
        font-weight: 600;
        color: var(--macos-gray-500);
        font-size: 12px;
    }
    
    .info-value {
        color: var(--macos-gray-600);
        font-size: 13px;
        text-align: right;
    }
    
    /* Enhanced mobile styles */
    @media (max-width: 768px) {
        .sudo-header {
            padding: 0 16px;
        }
        
        .sudo-main {
            padding: 16px;
        }
        
        .cards-grid {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 4px;
        }
        
        .action-buttons .btn {
            width: 100%;
            justify-content: center;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .modal-content {
            width: 95vw !important;
            margin: 10px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .d-flex {
            flex-direction: column;
            align-items: stretch;
        }
        
        .d-flex.gap-8,
        .d-flex.gap-12,
        .d-flex.gap-16 {
            gap: 8px;
        }
        
        input, select, textarea {
            font-size: 16px !important; /* Prevents iOS zoom */
        }
        
        .btn {
            padding: 14px 16px;
            font-size: 15px;
        }
    }
    
    @media (max-width: 480px) {
        .sudo-title {
            font-size: 16px;
        }
        
        .sudo-subtitle {
            font-size: 10px;
        }
        
        .stat-card {
            padding: 16px;
        }
        
        .stat-value {
            font-size: 24px;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .nav-section {
            padding: 0 12px;
        }
        
        .nav-item {
            padding: 10px 12px;
        }
    }
    
    /* Print styles for exports */
    @media print {
        .sudo-header,
        .sudo-sidebar,
        .modal-close,
        .action-buttons,
        .btn {
            display: none !important;
        }
        
        .sudo-main {
            margin-left: 0 !important;
            padding: 0 !important;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            border: 1px solid #000;
            padding: 8px;
        }
    }
`;

// ===== INITIALIZE ENHANCED APPLICATION =====
document.addEventListener('DOMContentLoaded', function() {
    // Add additional CSS
    const style = document.createElement('style');
    style.textContent = AdditionalCSS;
    document.head.appendChild(style);
    
    // Add loan section to main content
    const mainContent = document.querySelector('.sudo-main');
    if (mainContent) {
        mainContent.insertAdjacentHTML('beforeend', LoanApplicationsHTML);
    }
    
    // Add loan nav item to sidebar (in User Management section)
    const userManagementSection = document.querySelector('.nav-section:nth-child(2)');
    if (userManagementSection) {
        userManagementSection.insertAdjacentHTML('beforeend', LoanNavItemHTML);
    }
    
    // Initialize enhanced application
    EnhancedAppInitializer.init();
});

// ===== GLOBAL EXPORTS =====
window.ExtendedFirebaseService = ExtendedFirebaseService;
window.EnhancedUtils = EnhancedUtils;
window.LoanUIManager = LoanUIManager;
window.MobileSupport = MobileSupport;
window.viewLoanDetails = viewLoanDetails;
window.approveLoan = approveLoan;
window.denyLoan = denyLoan;
window.denyLoanPrompt = denyLoanPrompt;
window.disburseLoan = disburseLoan;
window.viewCollateral = viewCollateral;
window.viewAttachments = viewAttachments;
window.viewCustomerPhoto = viewCustomerPhoto;
window.viewAgentPhoto = viewAgentPhoto;
window.openLoanAnalytics = openLoanAnalytics;
window.exportLoanReport = exportLoanReport;
window.refreshLoanList = refreshLoanList;

// ===== ERROR HANDLING AND MONITORING =====
window.addEventListener('error', function(e) {
    console.error('Global error caught:', e.error);
    Utils.showNotification('System Error', 'An error occurred. Please refresh the page.', 'error');
    
    // Log error to Firebase if available
    if (db) {
        const errorId = Utils.generateId('ERR_');
        db.ref(`systemErrors/${errorId}`).set({
            message: e.message,
            stack: e.error?.stack,
            timestamp: Date.now(),
            url: window.location.href,
            userAgent: navigator.userAgent
        });
    }
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    Utils.showNotification('System Error', 'An unexpected error occurred.', 'error');
});

// ===== PERFORMANCE MONITORING =====
const PerformanceMonitor = {
    init() {
        this.startTime = Date.now();
        this.measureLoadTime();
        this.setupPerformanceObservers();
    },
    
    measureLoadTime() {
        window.addEventListener('load', () => {
            const loadTime = Date.now() - this.startTime;
            console.log(`SUDO Admin loaded in ${loadTime}ms`);
            
            if (loadTime > 5000) {
                console.warn('Slow load time detected');
            }
        });
    },
    
    setupPerformanceObservers() {
        // Monitor long tasks
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.duration > 100) {
                        console.warn('Long task detected:', entry);
                    }
                }
            });
            
            observer.observe({ entryTypes: ['longtask'] });
        }
    }
};

// Initialize performance monitoring
PerformanceMonitor.init();

// ===== SERVICE WORKER FOR OFFLINE SUPPORT =====
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sudo-sw.js').catch(err => {
        console.log('ServiceWorker registration failed: ', err);
    });
}

// ===== FINAL INITIALIZATION =====
console.log('Enhanced SUDO Admin Panel initialized successfully');
    </script>
</body>
</html>
