<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | SUDO Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
</head>
<body class="sudo-theme">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
                <i class="fas fa-crown navbar-logo"></i>
                <span>TruCash SUDO</span>
            </div>
            
            <div class="navbar-user">
                <div class="user-info">
                    <div class="user-name" id="userName">System Owner</div>
                    <div class="user-role">SUDO Administrator</div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-icon btn-outline" id="notificationsBtn">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationCount">0</span>
                    </button>
                    <button class="btn btn-icon btn-outline" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-section">
                <div class="section-title">System Control</div>
                <div class="sidebar-nav">
                    <a href="#" class="nav-item active" data-view="dashboard">
                        <div class="nav-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="nav-text">Dashboard</div>
                    </a>
                    <a href="#" class="nav-item" data-view="admins">
                        <div class="nav-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="nav-text">Admin Management</div>
                    </a>
                    <a href="#" class="nav-item" data-view="system-config">
                        <div class="nav-icon">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div class="nav-text">System Configuration</div>
                    </a>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">Monitoring</div>
                <div class="sidebar-nav">
                    <a href="#" class="nav-item" data-view="agents">
                        <div class="nav-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="nav-text">Agents</div>
                    </a>
                    <a href="#" class="nav-item" data-view="customers">
                        <div class="nav-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="nav-text">Customers</div>
                    </a>
                    <a href="#" class="nav-item" data-view="loans">
                        <div class="nav-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="nav-text">All Loans</div>
                    </a>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">Reports & Analytics</div>
                <div class="sidebar-nav">
                    <a href="#" class="nav-item" data-view="reports">
                        <div class="nav-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="nav-text">Financial Reports</div>
                    </a>
                    <a href="#" class="nav-item" data-view="audit-logs">
                        <div class="nav-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="nav-text">Audit Logs</div>
                    </a>
                    <a href="#" class="nav-item" data-view="risk-monitoring">
                        <div class="nav-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="nav-text">Risk Monitoring</div>
                    </a>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">Tools</div>
                <div class="sidebar-nav">
                    <a href="#" class="nav-item" data-view="backup">
                        <div class="nav-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="nav-text">Backup & Restore</div>
                    </a>
                    <a href="#" class="nav-item" id="exportDataBtn">
                        <div class="nav-icon">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <div class="nav-text">Export Data</div>
                    </a>
                    <a href="#" class="nav-item" id="systemStatusBtn">
                        <div class="nav-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="nav-text">System Status</div>
                    </a>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard View -->
        <div class="view active" id="dashboardView">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold">System Overview</h1>
                    <p class="text-gray-400">Complete control and monitoring of TruCash operations</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-outline" id="refreshDashboard">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <div class="text-xs text-gray-400" id="lastUpdated">
                        Last updated: Just now
                    </div>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Loan Portfolio</h3>
                        <p class="card-subtitle">Distribution by status</p>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="loanPortfolioChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Revenue Trend</h3>
                        <p class="card-subtitle">Last 30 days (ZMW)</p>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity & Top Agents -->
            <div class="grid grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent System Activity</h3>
                        <p class="card-subtitle">Live audit trail</p>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="recentActivityTable">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Activity logs will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top Performing Agents</h3>
                        <p class="card-subtitle">Based on loan volume</p>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="topAgentsTable">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Customers</th>
                                        <th>Loans</th>
                                        <th>Volume</th>
                                        <th>Rating</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Top agents will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Management View -->
        <div class="view" id="adminsView">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold">Admin Management</h1>
                    <p class="text-gray-400">Create, edit, and manage administrator accounts</p>
                </div>
                <button class="btn btn-primary" id="createAdminBtn">
                    <i class="fas fa-user-plus"></i> Create New Admin
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="card-title">Administrator Accounts</h3>
                            <p class="card-subtitle">All system administrators</p>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" class="form-input" placeholder="Search admins..." id="adminSearch">
                            <button class="btn btn-outline">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table" id="adminsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Admins will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Configuration View -->
        <div class="view" id="systemConfigView">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold">System Configuration</h1>
                    <p class="text-gray-400">Configure loan parameters, fees, and system settings</p>
                </div>
                <button class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <!-- Loan Configuration -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Loan Parameters</h3>
                    </div>
                    <div class="card-body">
                        <form id="loanConfigForm">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount (ZMW)</label>
                                <input type="number" class="form-input" id="minLoanAmount" min="0" step="100">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount (ZMW)</label>
                                <input type="number" class="form-input" id="maxLoanAmount" min="0" step="1000">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Interest Rate (%)</label>
                                <input type="number" class="form-input" id="interestRate" min="0" max="100" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Loan Duration Options</label>
                                <div class="flex gap-2">
                                    <input type="number" class="form-input" placeholder="Months" id="loanDuration1">
                                    <input type="number" class="form-input" placeholder="Months" id="loanDuration2">
                                    <input type="number" class="form-input" placeholder="Months" id="loanDuration3">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Fee Configuration -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Fee Structure</h3>
                    </div>
                    <div class="card-body">
                        <form id="feeConfigForm">
                            <div class="form-group">
                                <label class="form-label">Processing Fee (%)</label>
                                <input type="number" class="form-input" id="processingFee" min="0" max="10" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Late Payment Penalty (% per day)</label>
                                <input type="number" class="form-input" id="latePenalty" min="0" max="5" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Agent Commission (%)</label>
                                <input type="number" class="form-input" id="agentCommission" min="0" max="20" step="0.5">
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Collateral Configuration -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Collateral Settings</h3>
                    </div>
                    <div class="card-body">
                        <form id="collateralConfigForm">
                            <div class="form-group">
                                <label class="form-label">Collateral Categories</label>
                                <textarea class="form-input" id="collateralCategories" rows="3" 
                                          placeholder="Enter categories separated by commas"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Minimum Collateral Value Multiplier</label>
                                <input type="number" class="form-input" id="collateralMultiplier" min="1" max="5" step="0.5">
                                <small class="text-gray-400">e.g., 1.5x loan amount</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Required Photos</label>
                                <div class="flex gap-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="photoFront" checked>
                                        <span>Front View</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="photoSide" checked>
                                        <span>Side View</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="photoClose" checked>
                                        <span>Close-up</span>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- System Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Preferences</h3>
                    </div>
                    <div class="card-body">
                        <form id="systemConfigForm">
                            <div class="form-group">
                                <label class="form-label">Currency</label>
                                <select class="form-input" id="systemCurrency">
                                    <option value="ZMW" selected>Zambian Kwacha (ZMW)</option>
                                    <option value="USD">US Dollar (USD)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">System Timezone</label>
                                <select class="form-input" id="systemTimezone">
                                    <option value="Africa/Lusaka" selected>Africa/Lusaka (GMT+2)</option>
                                    <!-- More timezones would be added -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-input" id="sessionTimeout" min="5" max="240" value="30">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Enable SMS Notifications</label>
                                <label class="switch">
                                    <input type="checkbox" id="enableSMS">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional views would continue here (Agents, Customers, Loans, etc.) -->
        
    </main>
    
    <!-- Modals -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Administrator Account</h3>
                <button class="modal-close" id="closeAdminModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createAdminForm">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="adminName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-input" id="adminEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-input" id="adminPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" id="adminPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-input" id="adminConfirmPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Permissions</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="permissions" value="approve_loans" checked>
                                <span>Approve Loans</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="permissions" value="verify_documents" checked>
                                <span>Verify Documents</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="permissions" value="manage_agents" checked>
                                <span>Manage Agents</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="permissions" value="manage_customers">
                                <span>Manage Customers</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="permissions" value="view_reports">
                                <span>View Reports</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="permissions" value="configure_system">
                                <span>Configure System</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelCreateAdmin">Cancel</button>
                <button class="btn btn-primary" id="submitCreateAdmin">
                    <i class="fas fa-user-plus"></i> Create Administrator
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="modal" id="notificationsPanel">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Notifications</h3>
                <button class="modal-close" id="closeNotifications">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="flex flex-col gap-4" id="notificationsList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    <script src="cloudinary.js"></script>
    <script>
        // SUDO Dashboard JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize variables
            let currentUser = null;
            let systemStats = {};
            let loanPortfolioChart = null;
            let revenueChart = null;
            
            // DOM Elements
            const views = document.querySelectorAll('.view');
            const navItems = document.querySelectorAll('.nav-item');
            const logoutBtn = document.getElementById('logoutBtn');
            const refreshBtn = document.getElementById('refreshDashboard');
            const createAdminBtn = document.getElementById('createAdminBtn');
            const saveConfigBtn = document.getElementById('saveConfigBtn');
            
            // Initialize
            initializeDashboard();
            
            async function initializeDashboard() {
                // Check authentication
                currentUser = authManager.currentUser;
                if (!currentUser || authManager.userRole !== 'sudo') {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Set user name
                document.getElementById('userName').textContent = 
                    authManager.userData?.fullName || 'System Owner';
                
                // Load initial data
                await loadDashboardData();
                setupEventListeners();
                setupRealTimeListeners();
            }
            
            async function loadDashboardData() {
                try {
                    // Show loading state
                    document.getElementById('statsGrid').innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    `;
                    
                    // Load system statistics
                    systemStats = await db.getSystemStatistics();
                    updateStatsGrid();
                    
                    // Load recent activity
                    await loadRecentActivity();
                    
                    // Load top agents
                    await loadTopAgents();
                    
                    // Initialize charts
                    initializeCharts();
                    
                    // Update last updated time
                    document.getElementById('lastUpdated').textContent = 
                        `Last updated: ${new Date().toLocaleTimeString()}`;
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showNotification('Failed to load dashboard data', 'error');
                }
            }
            
            function updateStatsGrid() {
                const stats = systemStats;
                const statsGrid = document.getElementById('statsGrid');
                
                statsGrid.innerHTML = `
                    <div class="card stat-card">
                        <div class="stat-icon bg-primary/10 text-primary">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${formatCurrency(stats.totalAmount)}</div>
                            <div class="stat-label">Total Loan Portfolio</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                12% from last month
                            </div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon bg-success/10 text-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.activeLoans}</div>
                            <div class="stat-label">Active Loans</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                ${Math.round((stats.activeLoans / stats.totalLoans) * 100)}% of total
                            </div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon bg-warning/10 text-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.overdueLoans}</div>
                            <div class="stat-label">Overdue Loans</div>
                            <div class="stat-change ${stats.overdueLoans > 0 ? 'negative' : 'positive'}">
                                <i class="fas fa-${stats.overdueLoans > 0 ? 'arrow-up' : 'check'}"></i>
                                ${stats.overdueLoans > 0 ? 'Needs attention' : 'All good'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon bg-info/10 text-info">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.totalAgents}</div>
                            <div class="stat-label">Active Agents</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                ${stats.approvedAgents} approved
                            </div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon bg-secondary/10 text-secondary">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${formatCurrency(stats.totalRevenue)}</div>
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                18% from last month
                            </div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon bg-danger/10 text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.defaultedLoans}</div>
                            <div class="stat-label">Defaulted Loans</div>
                            <div class="stat-change ${stats.defaultedLoans > 0 ? 'negative' : 'positive'}">
                                <i class="fas fa-${stats.defaultedLoans > 0 ? 'arrow-up' : 'check'}"></i>
                                ${stats.defaultedLoans > 0 ? 'Risk alert' : 'No defaults'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            async function loadRecentActivity() {
                try {
                    const logsRef = database.ref('auditLogs');
                    const snapshot = await logsRef.orderByChild('timestamp').limitToLast(10).once('value');
                    const logs = snapshot.val() || {};
                    
                    const tableBody = document.querySelector('#recentActivityTable tbody');
                    tableBody.innerHTML = '';
                    
                    Object.entries(logs).reverse().forEach(([id, log]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatTime(log.timestamp)}</td>
                            <td>${log.userId ? log.userId.substring(0, 8) + '...' : 'System'}</td>
                            <td><span class="status-badge status-${log.action.toLowerCase()}">${log.action}</span></td>
                            <td>${log.details || 'No details'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading activity logs:', error);
                }
            }
            
            async function loadTopAgents() {
                try {
                    const agents = await db.getAllAgents();
                    const agentArray = Object.entries(agents)
                        .filter(([id, agent]) => agent.status === 'approved')
                        .map(([id, agent]) => ({
                            id,
                            ...agent,
                            performance: calculateAgentPerformance(agent)
                        }))
                        .sort((a, b) => b.performance.score - a.performance.score)
                        .slice(0, 5);
                    
                    const tableBody = document.querySelector('#topAgentsTable tbody');
                    tableBody.innerHTML = '';
                    
                    agentArray.forEach(agent => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="flex items-center gap-2">
                                    <img src="${agent.profilePhoto || 'https://via.placeholder.com/32'}" 
                                         class="w-8 h-8 rounded-full">
                                    <div>
                                        <div class="font-medium">${agent.fullName}</div>
                                        <div class="text-xs text-gray-400">${agent.agentId}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>${agent.activeLoans || 0}</td>
                            <td>${formatCurrency(agent.totalCommission || 0)}</td>
                            <td>
                                <div class="flex">
                                    ${Array.from({length: 5}).map((_, i) => `
                                        <i class="fas fa-star ${i < agent.performance.rating ? 'text-yellow-400' : 'text-gray-400'}"></i>
                                    `).join('')}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading top agents:', error);
                }
            }
            
            function calculateAgentPerformance(agent) {
                // Simple performance calculation
                const customers = agent.totalCustomers || 0;
                const loans = agent.activeLoans || 0;
                const commission = agent.totalCommission || 0;
                
                let score = customers * 0.3 + loans * 0.4 + (commission / 1000) * 0.3;
                let rating = Math.min(5, Math.ceil(score / 2));
                
                return { score, rating };
            }
            
            function initializeCharts() {
                // Destroy existing charts
                if (loanPortfolioChart) loanPortfolioChart.destroy();
                if (revenueChart) revenueChart.destroy();
                
                // Loan Portfolio Chart
                const loanCtx = document.getElementById('loanPortfolioChart').getContext('2d');
                loanPortfolioChart = new Chart(loanCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Pending', 'Overdue', 'Defaulted', 'Paid'],
                        datasets: [{
                            data: [
                                systemStats.activeLoans,
                                systemStats.totalLoans - systemStats.activeLoans - systemStats.overdueLoans - systemStats.defaultedLoans,
                                systemStats.overdueLoans,
                                systemStats.defaultedLoans,
                                systemStats.totalLoans - systemStats.activeLoans
                            ],
                            backgroundColor: [
                                'rgba(52, 199, 89, 0.8)',
                                'rgba(255, 149, 0, 0.8)',
                                'rgba(255, 45, 85, 0.8)',
                                'rgba(255, 59, 48, 0.8)',
                                'rgba(142, 142, 147, 0.8)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Revenue Chart (sample data)
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 30}, (_, i) => `Day ${i + 1}`),
                        datasets: [{
                            label: 'Daily Revenue (ZMW)',
                            data: Array.from({length: 30}, () => Math.floor(Math.random() * 10000) + 5000),
                            borderColor: 'rgba(0, 122, 255, 1)',
                            backgroundColor: 'rgba(0, 122, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return 'ZMW ' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
            
            function setupEventListeners() {
                // Navigation
                navItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Update active state
                        navItems.forEach(nav => nav.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Show selected view
                        const viewName = this.dataset.view;
                        views.forEach(view => {
                            view.classList.remove('active');
                            if (view.id === `${viewName}View`) {
                                view.classList.add('active');
                            }
                        });
                    });
                });
                
                // Logout
                logoutBtn.addEventListener('click', () => {
                    authManager.logout();
                });
                
                // Refresh dashboard
                refreshBtn.addEventListener('click', async () => {
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                    await loadDashboardData();
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                });
                
                // Create admin
                createAdminBtn.addEventListener('click', () => {
                    document.getElementById('createAdminModal').classList.add('active');
                });
                
                // Close admin modal
                document.getElementById('closeAdminModal').addEventListener('click', () => {
                    document.getElementById('createAdminModal').classList.remove('active');
                });
                
                document.getElementById('cancelCreateAdmin').addEventListener('click', () => {
                    document.getElementById('createAdminModal').classList.remove('active');
                });
                
                // Submit create admin
                document.getElementById('submitCreateAdmin').addEventListener('click', async () => {
                    const form = document.getElementById('createAdminForm');
                    const name = document.getElementById('adminName').value;
                    const email = document.getElementById('adminEmail').value;
                    const phone = document.getElementById('adminPhone').value;
                    const password = document.getElementById('adminPassword').value;
                    const confirmPassword = document.getElementById('adminConfirmPassword').value;
                    
                    // Validation
                    if (!name || !email || !phone || !password || !confirmPassword) {
                        showNotification('Please fill all required fields', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showNotification('Passwords do not match', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showNotification('Password must be at least 6 characters', 'error');
                        return;
                    }
                    
                    // Get permissions
                    const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked'))
                        .map(cb => cb.value);
                    
                    const button = document.getElementById('submitCreateAdmin');
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                    button.disabled = true;
                    
                    try {
                        const adminData = {
                            fullName: name,
                            phone: phone,
                            role: 'admin',
                            permissions: permissions,
                            status: 'active',
                            createdBy: currentUser.uid,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        
                        const result = await authManager.register(email, password, adminData, 'admin');
                        
                        if (result.success) {
                            showNotification('Admin account created successfully', 'success');
                            document.getElementById('createAdminModal').classList.remove('active');
                            form.reset();
                        } else {
                            showNotification(result.error, 'error');
                        }
                    } catch (error) {
                        showNotification('Failed to create admin account', 'error');
                        console.error('Create admin error:', error);
                    }
                    
                    button.innerHTML = '<i class="fas fa-user-plus"></i> Create Administrator';
                    button.disabled = false;
                });
                
                // Save configuration
                saveConfigBtn.addEventListener('click', async () => {
                    const button = saveConfigBtn;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    button.disabled = true;
                    
                    try {
                        // Collect configuration data
                        const configData = {
                            loan: {
                                minAmount: parseFloat(document.getElementById('minLoanAmount').value),
                                maxAmount: parseFloat(document.getElementById('maxLoanAmount').value),
                                interestRate: parseFloat(document.getElementById('interestRate').value),
                                durations: [
                                    document.getElementById('loanDuration1').value,
                                    document.getElementById('loanDuration2').value,
                                    document.getElementById('loanDuration3').value
                                ].filter(d => d)
                            },
                            fees: {
                                processingFee: parseFloat(document.getElementById('processingFee').value),
                                latePenalty: parseFloat(document.getElementById('latePenalty').value),
                                agentCommission: parseFloat(document.getElementById('agentCommission').value)
                            },
                            collateral: {
                                categories: document.getElementById('collateralCategories').value.split(',').map(c => c.trim()),
                                multiplier: parseFloat(document.getElementById('collateralMultiplier').value),
                                requiredPhotos: {
                                    front: document.getElementById('photoFront').checked,
                                    side: document.getElementById('photoSide').checked,
                                    close: document.getElementById('photoClose').checked
                                }
                            },
                            system: {
                                currency: document.getElementById('systemCurrency').value,
                                timezone: document.getElementById('systemTimezone').value,
                                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                                enableSMS: document.getElementById('enableSMS').checked
                            },
                            updatedBy: currentUser.uid,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        
                        // Save to Firebase
                        await database.ref('system/config').set(configData);
                        
                        // Log the action
                        await db.logActivity(currentUser.uid, 'CONFIG_UPDATE', {
                            config: 'system_settings'
                        });
                        
                        showNotification('Configuration saved successfully', 'success');
                    } catch (error) {
                        showNotification('Failed to save configuration', 'error');
                        console.error('Save config error:', error);
                    }
                    
                    button.innerHTML = '<i class="fas fa-save"></i> Save Configuration';
                    button.disabled = false;
                });
                
                // Load existing configuration
                loadSystemConfig();
            }
            
            async function loadSystemConfig() {
                try {
                    const snapshot = await database.ref('system/config').once('value');
                    const config = snapshot.val();
                    
                    if (config) {
                        // Loan config
                        if (config.loan) {
                            document.getElementById('minLoanAmount').value = config.loan.minAmount || '';
                            document.getElementById('maxLoanAmount').value = config.loan.maxAmount || '';
                            document.getElementById('interestRate').value = config.loan.interestRate || '';
                            
                            if (config.loan.durations) {
                                const durations = config.loan.durations;
                                document.getElementById('loanDuration1').value = durations[0] || '';
                                document.getElementById('loanDuration2').value = durations[1] || '';
                                document.getElementById('loanDuration3').value = durations[2] || '';
                            }
                        }
                        
                        // Fee config
                        if (config.fees) {
                            document.getElementById('processingFee').value = config.fees.processingFee || '';
                            document.getElementById('latePenalty').value = config.fees.latePenalty || '';
                            document.getElementById('agentCommission').value = config.fees.agentCommission || '';
                        }
                        
                        // Collateral config
                        if (config.collateral) {
                            document.getElementById('collateralCategories').value = config.collateral.categories?.join(', ') || '';
                            document.getElementById('collateralMultiplier').value = config.collateral.multiplier || '';
                            
                            if (config.collateral.requiredPhotos) {
                                document.getElementById('photoFront').checked = config.collateral.requiredPhotos.front || false;
                                document.getElementById('photoSide').checked = config.collateral.requiredPhotos.side || false;
                                document.getElementById('photoClose').checked = config.collateral.requiredPhotos.close || false;
                            }
                        }
                        
                        // System config
                        if (config.system) {
                            document.getElementById('systemCurrency').value = config.system.currency || 'ZMW';
                            document.getElementById('systemTimezone').value = config.system.timezone || 'Africa/Lusaka';
                            document.getElementById('sessionTimeout').value = config.system.sessionTimeout || 30;
                            document.getElementById('enableSMS').checked = config.system.enableSMS || false;
                        }
                    }
                } catch (error) {
                    console.error('Error loading system config:', error);
                }
            }
            
            function setupRealTimeListeners() {
                // Listen for new loans
                db.listenToLoans((loans) => {
                    // Update stats if dashboard is active
                    if (document.getElementById('dashboardView').classList.contains('active')) {
                        updateStatsWithLoans(loans);
                    }
                });
                
                // Listen for audit logs
                database.ref('auditLogs').limitToLast(1).on('child_added', (snapshot) => {
                    const log = snapshot.val();
                    // Show notification for important logs
                    if (log.action.includes('APPROVE') || log.action.includes('REJECT') || 
                        log.action.includes('CREATE') || log.action.includes('DELETE')) {
                        showNotification(`System activity: ${log.action}`, 'info');
                    }
                    
                    // Update recent activity table
                    if (document.getElementById('dashboardView').classList.contains('active')) {
                        loadRecentActivity();
                    }
                });
            }
            
            function updateStatsWithLoans(loans) {
                // Recalculate stats from loans data
                const totalLoans = Object.keys(loans).length;
                const activeLoans = Object.values(loans).filter(l => l.status === 'active').length;
                const overdueLoans = Object.values(loans).filter(l => l.status === 'overdue').length;
                const defaultedLoans = Object.values(loans).filter(l => l.status === 'defaulted').length;
                
                // Update stats object
                systemStats.totalLoans = totalLoans;
                systemStats.activeLoans = activeLoans;
                systemStats.overdueLoans = overdueLoans;
                systemStats.defaultedLoans = defaultedLoans;
                
                // Update stats grid
                updateStatsGrid();
                
                // Update charts
                if (loanPortfolioChart) {
                    loanPortfolioChart.data.datasets[0].data = [
                        activeLoans,
                        totalLoans - activeLoans - overdueLoans - defaultedLoans,
                        overdueLoans,
                        defaultedLoans,
                        totalLoans - activeLoans
                    ];
                    loanPortfolioChart.update();
                }
            }
            
            // Utility functions
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-ZM', {
                    style: 'currency',
                    currency: 'ZMW',
                    minimumFractionDigits: 2
                }).format(amount || 0);
            }
            
            function formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            function showNotification(message, type) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type} animate-slideInRight`;
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                         type === 'error' ? 'exclamation-circle' : 
                                         type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    </div>
                    <div>${message}</div>
                `;
                
                document.body.appendChild(notification);
                
                // Show notification
                setTimeout(() => notification.classList.add('active'), 10);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('active');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
                
                // Update notification count
                const countElement = document.getElementById('notificationCount');
                let count = parseInt(countElement.textContent) || 0;
                countElement.textContent = count + 1;
                countElement.style.display = count + 1 > 0 ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>
