<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | SUDO Super Control Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse for CSV Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
      /* ===== ENHANCED macOS Theme CSS Reset with Mobile-First Approach ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
               'Helvetica Neue', 'Segoe UI', Roboto, Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --macos-gray-100: #f5f5f7;
    --macos-gray-200: #e5e5e7;
    --macos-gray-300: #d2d2d7;
    --macos-gray-400: #86868b;
    --macos-gray-500: #515154;
    --macos-gray-600: #1d1d1f;
    --macos-blue: #007AFF;
    --macos-blue-light: #409cff;
    --macos-blue-dark: #0056cc;
    --macos-green: #34c759;
    --macos-red: #ff3b30;
    --macos-purple: #5856d6;
    --macos-yellow: #ffcc00;
    --macos-orange: #ff9500;
    --macos-pink: #ff2d55;
    --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --macos-shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
    --macos-shadow-light: 0 2px 6px rgba(0, 0, 0, 0.04);
    --macos-border-radius: 12px;
    --macos-border-radius-small: 8px;
    --macos-border-radius-large: 16px;
    --macos-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    --macos-glass: rgba(255, 255, 255, 0.85);
    --macos-glass-border: rgba(255, 255, 255, 0.2);
    --macos-danger-bg: rgba(255, 59, 48, 0.1);
    --macos-warning-bg: rgba(255, 204, 0, 0.1);
    --macos-success-bg: rgba(52, 199, 89, 0.1);
    --macos-info-bg: rgba(0, 122, 255, 0.1);
    --macos-sidebar-width: 280px;
    --macos-sidebar-collapsed: 70px;
    --macos-header-height: 56px;
    --macos-mobile-breakpoint: 768px;
    --macos-tablet-breakpoint: 1024px;
    --macos-font-size-xs: 0.75rem;
    --macos-font-size-sm: 0.875rem;
    --macos-font-size-base: 0.9375rem;
    --macos-font-size-lg: 1.125rem;
    --macos-font-size-xl: 1.25rem;
    --macos-font-size-2xl: 1.5rem;
    --macos-spacing-xs: 4px;
    --macos-spacing-sm: 8px;
    --macos-spacing-md: 12px;
    --macos-spacing-lg: 16px;
    --macos-spacing-xl: 20px;
    --macos-spacing-2xl: 24px;
    --macos-spacing-3xl: 32px;
}

/* ===== Mobile-First Body & Layout ===== */
body {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
    color: var(--macos-gray-600);
    min-height: 100vh;
    line-height: 1.4;
    position: relative;
    overflow-x: hidden;
    font-size: var(--macos-font-size-base);
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        radial-gradient(at 10% 20%, rgba(120, 119, 198, 0.03) 0px, transparent 50%),
        radial-gradient(at 90% 10%, rgba(0, 122, 255, 0.03) 0px, transparent 50%),
        radial-gradient(at 50% 90%, rgba(76, 175, 80, 0.03) 0px, transparent 50%);
    z-index: -1;
}

/* ===== Enhanced Touch-Friendly SUDO Header ===== */
.sudo-header {
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--macos-glass-border);
    padding: 0 var(--macos-spacing-lg);
    height: var(--macos-header-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--macos-shadow-light);
}

.sudo-logo {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-md);
    min-width: 0;
}

.sudo-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--macos-red) 0%, var(--macos-orange) 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
    flex-shrink: 0;
}

.sudo-title {
    font-size: var(--macos-font-size-lg);
    font-weight: 700;
    color: var(--macos-gray-600);
    letter-spacing: -0.3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sudo-subtitle {
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-400);
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-left: var(--macos-spacing-sm);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-md);
}

.live-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--macos-font-size-xs);
    padding: 6px 12px;
    background: var(--macos-success-bg);
    color: var(--macos-green);
    border-radius: 20px;
    font-weight: 600;
    white-space: nowrap;
}

.live-dot {
    width: 8px;
    height: 8px;
    background: var(--macos-green);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.user-info {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-md);
    min-width: 0;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-purple) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    flex-shrink: 0;
}

/* ===== Mobile Menu Toggle Button ===== */
.mobile-menu-toggle {
    display: none;
    background: none;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: var(--macos-border-radius-small);
    align-items: center;
    justify-content: center;
    color: var(--macos-gray-600);
    cursor: pointer;
    transition: var(--macos-transition);
    flex-shrink: 0;
}

.mobile-menu-toggle:hover {
    background: var(--macos-gray-100);
}

.mobile-menu-toggle i {
    font-size: 20px;
}

/* ===== Enhanced Main Layout with Collapsible Sidebar ===== */
.sudo-container {
    display: flex;
    min-height: calc(100vh - var(--macos-header-height));
    margin-top: var(--macos-header-height);
    position: relative;
}

/* ===== Enhanced Sidebar Navigation with Mobile Support ===== */
.sudo-sidebar {
    width: var(--macos-sidebar-width);
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-right: 1px solid var(--macos-glass-border);
    padding: var(--macos-spacing-2xl) 0;
    position: fixed;
    top: var(--macos-header-height);
    left: 0;
    bottom: 0;
    overflow-y: auto;
    z-index: 900;
    transition: var(--macos-transition);
    transform: translateX(0);
}

.sudo-sidebar.collapsed {
    width: var(--macos-sidebar-collapsed);
}

.sudo-sidebar.collapsed .nav-text,
.sudo-sidebar.collapsed .nav-title,
.sudo-sidebar.collapsed .nav-badge {
    display: none;
}

.sudo-sidebar.collapsed .nav-item {
    justify-content: center;
    padding: var(--macos-spacing-lg);
}

.sudo-sidebar.collapsed .nav-icon {
    margin: 0;
}

.nav-section {
    margin-bottom: var(--macos-spacing-2xl);
    padding: 0 var(--macos-spacing-lg);
}

.nav-title {
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-400);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--macos-spacing-md);
    padding-left: var(--macos-spacing-md);
    transition: var(--macos-transition);
}

.nav-item {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-md);
    padding: var(--macos-spacing-md) var(--macos-spacing-lg);
    color: var(--macos-gray-500);
    text-decoration: none;
    border-radius: var(--macos-border-radius);
    transition: var(--macos-transition);
    margin-bottom: var(--macos-spacing-xs);
    cursor: pointer;
    user-select: none;
    position: relative;
    min-height: 44px;
}

.nav-item:hover {
    background: rgba(0, 0, 0, 0.03);
    color: var(--macos-gray-600);
}

.nav-item.active {
    background: var(--macos-blue);
    color: white;
}

.nav-item.active .nav-icon {
    color: white;
}

.nav-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--macos-gray-400);
    flex-shrink: 0;
}

.nav-text {
    font-size: var(--macos-font-size-sm);
    font-weight: 500;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.nav-badge {
    background: var(--macos-red);
    color: white;
    font-size: var(--macos-font-size-xs);
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    font-weight: 600;
    flex-shrink: 0;
}

/* ===== Enhanced Main Content with Tab Persistence ===== */
.sudo-main {
    flex: 1;
    margin-left: var(--macos-sidebar-width);
    padding: var(--macos-spacing-2xl);
    transition: var(--macos-transition);
}

.sudo-main.expanded {
    margin-left: var(--macos-sidebar-collapsed);
}

.sudo-main.full-width {
    margin-left: 0;
}

/* ===== Enhanced Content Sections with Persistent State ===== */
.content-section {
    display: none;
    animation: fadeIn 0.3s ease;
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    height: 0;
    overflow: hidden;
}

.content-section.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
    height: auto;
    overflow: visible;
}

.content-section.persistent {
    display: block !important;
    height: auto !important;
    overflow: visible !important;
}

/* Multi-tab view styles */
.multi-tab-view {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--macos-spacing-lg);
    margin-bottom: var(--macos-spacing-2xl);
}

.tab-container {
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius-large);
    overflow: hidden;
    height: 400px;
    display: flex;
    flex-direction: column;
}

.tab-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--macos-spacing-lg);
    border-bottom: 1px solid var(--macos-gray-200);
    background: var(--macos-gray-100);
    min-height: 60px;
}

.tab-title {
    font-size: var(--macos-font-size-base);
    font-weight: 600;
    color: var(--macos-gray-600);
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
}

.tab-controls {
    display: flex;
    gap: var(--macos-spacing-xs);
}

.tab-close {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: var(--macos-gray-200);
    color: var(--macos-gray-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--macos-transition);
    font-size: 12px;
}

.tab-close:hover {
    background: var(--macos-red);
    color: white;
}

.tab-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--macos-spacing-lg);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== Enhanced Section Header ===== */
.section-header {
    margin-bottom: var(--macos-spacing-2xl);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: var(--macos-spacing-md);
}

.section-title {
    font-size: var(--macos-font-size-2xl);
    font-weight: 700;
    color: var(--macos-gray-600);
    margin-bottom: var(--macos-spacing-sm);
    letter-spacing: -0.5px;
    line-height: 1.2;
}

.section-subtitle {
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-400);
    line-height: 1.4;
}

.section-actions {
    display: flex;
    gap: var(--macos-spacing-sm);
    flex-wrap: wrap;
}

/* ===== Enhanced Stats Grid for Mobile ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--macos-spacing-md);
    margin-bottom: var(--macos-spacing-2xl);
}

.stat-card {
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius);
    padding: var(--macos-spacing-lg);
    transition: var(--macos-transition);
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--macos-shadow);
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--macos-spacing-md);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.stat-icon.users { background: var(--macos-info-bg); color: var(--macos-blue); }
.stat-icon.agents { background: var(--macos-success-bg); color: var(--macos-green); }
.stat-icon.transactions { background: var(--macos-warning-bg); color: var(--macos-yellow); }
.stat-icon.revenue { background: var(--macos-danger-bg); color: var(--macos-red); }

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--macos-gray-600);
    line-height: 1;
    margin-bottom: var(--macos-spacing-xs);
}

.stat-label {
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-400);
    font-weight: 500;
}

.stat-change {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    margin-top: var(--macos-spacing-sm);
}

.stat-change.positive {
    color: var(--macos-green);
}

.stat-change.negative {
    color: var(--macos-red);
}

/* ===== Enhanced Cards Grid for Mobile ===== */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--macos-spacing-lg);
    margin-bottom: var(--macos-spacing-2xl);
}

.card {
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius-large);
    overflow: hidden;
    transition: var(--macos-transition);
    min-height: 200px;
}

.card:hover {
    box-shadow: var(--macos-shadow);
    transform: translateY(-2px);
}

.card-header {
    padding: var(--macos-spacing-lg);
    border-bottom: 1px solid var(--macos-gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 60px;
}

.card-title {
    font-size: var(--macos-font-size-base);
    font-weight: 600;
    color: var(--macos-gray-600);
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
}

.card-actions {
    display: flex;
    gap: var(--macos-spacing-xs);
}

.card-body {
    padding: var(--macos-spacing-lg);
}

/* ===== Enhanced Form Elements for Mobile ===== */
.form-group {
    margin-bottom: var(--macos-spacing-lg);
}

.form-label {
    display: block;
    font-size: var(--macos-font-size-sm);
    font-weight: 600;
    color: var(--macos-gray-500);
    margin-bottom: var(--macos-spacing-sm);
}

.form-control {
    width: 100%;
    padding: 12px 14px;
    font-size: var(--macos-font-size-base);
    border: 1px solid var(--macos-gray-200);
    border-radius: var(--macos-border-radius-small);
    background: rgba(255, 255, 255, 0.9);
    transition: var(--macos-transition);
    color: var(--macos-gray-600);
    -webkit-appearance: none;
    appearance: none;
}

.form-control:focus {
    outline: none;
    border-color: var(--macos-blue);
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
}

.form-control::placeholder {
    color: var(--macos-gray-400);
}

.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--macos-spacing-lg);
}

/* ===== Enhanced Tables for Mobile ===== */
.table-container {
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius);
    overflow: hidden;
    margin-bottom: var(--macos-spacing-2xl);
    overflow-x: auto;
}

.table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
}

.table th {
    background: rgba(0, 0, 0, 0.02);
    padding: 12px 16px;
    text-align: left;
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    color: var(--macos-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--macos-gray-200);
    white-space: nowrap;
}

.table td {
    padding: 16px;
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-600);
    border-bottom: 1px solid var(--macos-gray-200);
}

.table tbody tr:hover {
    background: rgba(0, 0, 0, 0.02);
}

.table tbody tr:last-child td {
    border-bottom: none;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    border-radius: 20px;
    white-space: nowrap;
}

.status-active { background: var(--macos-success-bg); color: var(--macos-green); }
.status-inactive { background: var(--macos-gray-200); color: var(--macos-gray-500); }
.status-suspended { background: var(--macos-warning-bg); color: var(--macos-yellow); }
.status-banned { background: var(--macos-danger-bg); color: var(--macos-red); }
.status-pending { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }

.role-badge {
    display: inline-block;
    padding: 4px 10px;
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    border-radius: 20px;
    background: var(--macos-info-bg);
    color: var(--macos-blue);
}

/* ===== Enhanced Buttons for Mobile ===== */
.btn {
    padding: 10px 18px;
    border-radius: var(--macos-border-radius-small);
    font-size: var(--macos-font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--macos-transition);
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    white-space: nowrap;
    user-select: none;
    touch-action: manipulation;
    min-height: 40px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--macos-blue) 0%, var(--macos-blue-light) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--macos-blue-dark) 0%, var(--macos-blue) 100%);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
    transform: translateY(-1px);
}

.btn-danger {
    background: linear-gradient(135deg, var(--macos-red) 0%, #ff5a5a 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
}

.btn-danger:hover {
    background: linear-gradient(135deg, #cc2e25 0%, var(--macos-red) 100%);
    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.35);
    transform: translateY(-1px);
}

.btn-success {
    background: linear-gradient(135deg, var(--macos-green) 0%, #2db867 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
}

.btn-success:hover {
    background: linear-gradient(135deg, #27ae60 0%, var(--macos-green) 100%);
    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.35);
    transform: translateY(-1px);
}

.btn-outline {
    background: transparent;
    border: 1.5px solid var(--macos-gray-300);
    color: var(--macos-gray-600);
}

.btn-outline:hover {
    background: rgba(0, 0, 0, 0.03);
    border-color: var(--macos-gray-400);
    transform: translateY(-1px);
}

.btn-sm {
    padding: 6px 12px;
    font-size: var(--macos-font-size-xs);
    min-height: 32px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    justify-content: center;
    border-radius: 50%;
    min-height: 32px;
}

.action-buttons {
    display: flex;
    gap: var(--macos-spacing-sm);
    flex-wrap: wrap;
}

/* ===== Enhanced Toggle Switches for Mobile ===== */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
    flex-shrink: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--macos-gray-300);
    transition: var(--macos-transition);
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: var(--macos-transition);
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--macos-green);
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* ===== Enhanced Charts for Mobile ===== */
.chart-container {
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius);
    padding: var(--macos-spacing-lg);
    margin-bottom: var(--macos-spacing-2xl);
    min-height: 300px;
    display: flex;
    flex-direction: column;
}

.chart-title {
    font-size: var(--macos-font-size-base);
    font-weight: 600;
    color: var(--macos-gray-600);
    margin-bottom: var(--macos-spacing-lg);
}

.chart-canvas {
    flex: 1;
    width: 100% !important;
    height: 100% !important;
}

/* ===== Enhanced Modals for Mobile ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: var(--macos-spacing-lg);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.active {
    display: flex;
    opacity: 1;
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--macos-glass);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    border-radius: var(--macos-border-radius-large);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--macos-shadow-heavy);
    border: 1px solid var(--macos-glass-border);
    animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideUp {
    from { opacity: 0; transform: translateY(100px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-header {
    padding: var(--macos-spacing-lg) var(--macos-spacing-2xl);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--macos-glass);
    backdrop-filter: blur(40px);
    z-index: 10;
    min-height: 60px;
}

.modal-title {
    font-size: var(--macos-font-size-lg);
    font-weight: 600;
    color: var(--macos-gray-600);
}

.modal-close {
    background: rgba(0, 0, 0, 0.05);
    border: none;
    font-size: 16px;
    color: var(--macos-gray-500);
    cursor: pointer;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--macos-transition);
    flex-shrink: 0;
}

.modal-close:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: rotate(90deg);
}

.modal-body {
    padding: var(--macos-spacing-lg) var(--macos-spacing-2xl);
}

.modal-footer {
    padding: var(--macos-spacing-lg) var(--macos-spacing-2xl);
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: flex-end;
    gap: var(--macos-spacing-md);
    flex-wrap: wrap;
}

/* ===== Enhanced Loading Overlay ===== */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    flex-direction: column;
    gap: var(--macos-spacing-lg);
}

.loading-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--macos-gray-200);
    border-top-color: var(--macos-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: var(--macos-font-size-base);
    color: var(--macos-gray-600);
    font-weight: 500;
}

/* ===== Enhanced Notifications for Mobile ===== */
.notification {
    position: fixed;
    top: var(--macos-spacing-2xl);
    right: var(--macos-spacing-2xl);
    padding: var(--macos-spacing-lg);
    border-radius: var(--macos-border-radius);
    background: var(--macos-glass);
    backdrop-filter: blur(40px);
    box-shadow: var(--macos-shadow-heavy);
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-md);
    z-index: 1500;
    transform: translateX(calc(100% + 24px));
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 320px;
    border: 1px solid var(--macos-glass-border);
}

.notification.active {
    transform: translateX(0);
}

.notification.success {
    border-left: 4px solid var(--macos-green);
}

.notification.error {
    border-left: 4px solid var(--macos-red);
}

.notification.info {
    border-left: 4px solid var(--macos-blue);
}

.notification.warning {
    border-left: 4px solid var(--macos-yellow);
}

.notification-icon {
    font-size: 20px;
    flex-shrink: 0;
}

.notification.success .notification-icon {
    color: var(--macos-green);
}

.notification.error .notification-icon {
    color: var(--macos-red);
}

.notification.info .notification-icon {
    color: var(--macos-blue);
}

.notification.warning .notification-icon {
    color: var(--macos-yellow);
}

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 600;
    font-size: var(--macos-font-size-sm);
    margin-bottom: 2px;
    color: var(--macos-gray-600);
}

.notification-message {
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-500);
    line-height: 1.4;
}

.notification-close {
    background: none;
    border: none;
    color: var(--macos-gray-400);
    cursor: pointer;
    font-size: 16px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: var(--macos-transition);
    flex-shrink: 0;
}

.notification-close:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--macos-gray-600);
}

/* ===== Enhanced Code Editor ===== */
.code-editor {
    background: #1e1e1e;
    color: #d4d4d4;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    border-radius: var(--macos-border-radius);
    overflow: hidden;
    margin-bottom: var(--macos-spacing-lg);
}

.code-header {
    background: #252526;
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3e3e42;
    min-height: 40px;
}

.code-language {
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    color: #888;
    text-transform: uppercase;
}

.code-body {
    padding: var(--macos-spacing-lg);
    font-size: var(--macos-font-size-sm);
    line-height: 1.5;
    max-height: 300px;
    overflow-y: auto;
}

.code-body pre {
    margin: 0;
}

/* ===== Enhanced Alert Boxes ===== */
.alert {
    padding: var(--macos-spacing-lg);
    border-radius: var(--macos-border-radius);
    margin-bottom: var(--macos-spacing-lg);
    border-left: 4px solid;
    display: flex;
    align-items: flex-start;
    gap: var(--macos-spacing-md);
}

.alert-danger {
    background: var(--macos-danger-bg);
    border-left-color: var(--macos-red);
    color: var(--macos-red);
}

.alert-warning {
    background: var(--macos-warning-bg);
    border-left-color: var(--macos-yellow);
    color: var(--macos-yellow);
}

.alert-success {
    background: var(--macos-success-bg);
    border-left-color: var(--macos-green);
    color: var(--macos-green);
}

.alert-info {
    background: var(--macos-info-bg);
    border-left-color: var(--macos-blue);
    color: var(--macos-blue);
}

.alert-icon {
    font-size: 18px;
    flex-shrink: 0;
}

.alert-content {
    flex: 1;
}

/* ===== Enhanced File Upload Styles ===== */
.file-upload-container {
    border: 2px dashed var(--macos-gray-300);
    border-radius: var(--macos-border-radius);
    padding: var(--macos-spacing-2xl);
    text-align: center;
    transition: var(--macos-transition);
    cursor: pointer;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.file-upload-container:hover {
    border-color: var(--macos-blue);
    background: rgba(0, 122, 255, 0.02);
}

.file-upload-icon {
    font-size: 48px;
    color: var(--macos-gray-300);
    margin-bottom: var(--macos-spacing-md);
}

.file-upload-text {
    color: var(--macos-gray-500);
    margin-bottom: var(--macos-spacing-sm);
    font-size: var(--macos-font-size-base);
}

.file-upload-hint {
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-400);
}

.uploaded-files {
    margin-top: var(--macos-spacing-lg);
    width: 100%;
}

.uploaded-file {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--macos-spacing-md);
    background: var(--macos-gray-100);
    border-radius: var(--macos-border-radius-small);
    margin-bottom: var(--macos-spacing-sm);
}

.file-info {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-md);
    min-width: 0;
}

.file-icon {
    color: var(--macos-blue);
    flex-shrink: 0;
}

.file-name {
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-600);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ===== Enhanced Progress Bar ===== */
.progress-container {
    background: var(--macos-gray-200);
    border-radius: 10px;
    overflow: hidden;
    height: 6px;
    margin: var(--macos-spacing-sm) 0;
}

.progress-bar {
    background: linear-gradient(90deg, var(--macos-blue), var(--macos-purple));
    height: 100%;
    transition: width 0.3s ease;
}

/* ===== Enhanced Search Filters ===== */
.filter-container {
    display: flex;
    gap: var(--macos-spacing-md);
    margin-bottom: var(--macos-spacing-2xl);
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
    flex-wrap: wrap;
}

.filter-input {
    min-width: 200px;
    flex: 1;
}

/* ===== Enhanced Data Export Styles ===== */
.export-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--macos-spacing-lg);
    margin-bottom: var(--macos-spacing-2xl);
}

.export-option {
    padding: var(--macos-spacing-lg);
    background: var(--macos-glass);
    border-radius: var(--macos-border-radius);
    text-align: center;
    cursor: pointer;
    transition: var(--macos-transition);
    border: 1px solid var(--macos-glass-border);
    min-height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.export-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--macos-shadow);
}

.export-icon {
    font-size: 32px;
    color: var(--macos-blue);
    margin-bottom: var(--macos-spacing-md);
}

.export-title {
    font-weight: 600;
    color: var(--macos-gray-600);
    margin-bottom: var(--macos-spacing-xs);
}

.export-description {
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-400);
}

/* ===== Enhanced Pagination for Mobile ===== */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--macos-spacing-xs);
    margin-top: var(--macos-spacing-2xl);
    flex-wrap: wrap;
}

.page-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--macos-border-radius-small);
    border: 1px solid var(--macos-gray-200);
    background: white;
    cursor: pointer;
    transition: var(--macos-transition);
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-600);
}

.page-btn:hover:not(.disabled) {
    border-color: var(--macos-blue);
    color: var(--macos-blue);
}

.page-btn.active {
    background: var(--macos-blue);
    color: white;
    border-color: var(--macos-blue);
}

.page-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ===== Enhanced Multi-Tab Controls ===== */
.multi-tab-controls {
    display: flex;
    gap: var(--macos-spacing-sm);
    margin-bottom: var(--macos-spacing-lg);
    flex-wrap: wrap;
}

.tab-switcher {
    display: flex;
    background: var(--macos-gray-100);
    border-radius: var(--macos-border-radius);
    padding: var(--macos-spacing-xs);
    gap: var(--macos-spacing-xs);
}

.tab-switcher-btn {
    padding: var(--macos-spacing-sm) var(--macos-spacing-lg);
    border: none;
    background: transparent;
    color: var(--macos-gray-500);
    font-size: var(--macos-font-size-sm);
    font-weight: 500;
    cursor: pointer;
    border-radius: var(--macos-border-radius-small);
    transition: var(--macos-transition);
    white-space: nowrap;
}

.tab-switcher-btn.active {
    background: white;
    color: var(--macos-blue);
    box-shadow: var(--macos-shadow-light);
}

.tab-switcher-btn:hover:not(.active) {
    background: rgba(0, 0, 0, 0.05);
}

/* ===== Enhanced Tab Persistence Controls ===== */
.tab-persistence-controls {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
    margin-left: auto;
}

.persist-toggle {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-xs);
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-500);
    cursor: pointer;
    padding: var(--macos-spacing-xs) var(--macos-spacing-sm);
    border-radius: var(--macos-border-radius-small);
    transition: var(--macos-transition);
}

.persist-toggle:hover {
    background: var(--macos-gray-100);
}

.persist-toggle.active {
    color: var(--macos-blue);
    background: var(--macos-info-bg);
}

.persist-toggle i {
    font-size: 14px;
}

/* ===== Enhanced Grid Layout Controls ===== */
.grid-controls {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
    margin-bottom: var(--macos-spacing-lg);
}

.grid-size-selector {
    display: flex;
    gap: var(--macos-spacing-xs);
}

.grid-size-btn {
    width: 32px;
    height: 32px;
    border: 1px solid var(--macos-gray-300);
    background: white;
    border-radius: var(--macos-border-radius-small);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--macos-transition);
    font-size: 12px;
    color: var(--macos-gray-500);
}

.grid-size-btn.active {
    border-color: var(--macos-blue);
    color: var(--macos-blue);
    background: var(--macos-info-bg);
}

.grid-size-btn:hover:not(.active) {
    border-color: var(--macos-gray-400);
}

/* ===== Enhanced Mobile Bottom Navigation ===== */
.mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--macos-glass-border);
    padding: var(--macos-spacing-sm);
    z-index: 1000;
}

.nav-tabs {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.nav-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: var(--macos-spacing-sm);
    background: none;
    border: none;
    color: var(--macos-gray-500);
    cursor: pointer;
    transition: var(--macos-transition);
    border-radius: var(--macos-border-radius-small);
    flex: 1;
    max-width: 80px;
}

.nav-tab.active {
    color: var(--macos-blue);
    background: var(--macos-info-bg);
}

.nav-tab-icon {
    font-size: 18px;
}

.nav-tab-label {
    font-size: var(--macos-font-size-xs);
    font-weight: 500;
}

/* ===== Enhanced Touch Gesture Areas ===== */
.touch-gesture-area {
    position: fixed;
    top: 0;
    bottom: 0;
    width: 20px;
    z-index: 800;
    opacity: 0;
}

.touch-gesture-area.left {
    left: 0;
}

.touch-gesture-area.right {
    right: 0;
}

/* ===== Enhanced Responsive Design ===== */
@media (max-width: 1400px) {
    .cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    .multi-tab-view {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1200px) {
    :root {
        --macos-sidebar-width: 240px;
    }
    
    .sudo-main {
        padding: var(--macos-spacing-lg);
    }
    
    .section-title {
        font-size: var(--macos-font-size-xl);
    }
    
    .cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .table th,
    .table td {
        padding: 12px;
    }
}

@media (max-width: 1024px) {
    .sudo-sidebar {
        transform: translateX(-100%);
    }
    
    .sudo-sidebar.mobile-open {
        transform: translateX(0);
        width: 280px;
    }
    
    .sudo-main {
        margin-left: 0;
        padding: var(--macos-spacing-lg);
    }
    
    .sudo-main.expanded {
        margin-left: 0;
    }
    
    .mobile-menu-toggle {
        display: flex;
    }
    
    .mobile-bottom-nav {
        display: block;
    }
    
    .sudo-main {
        padding-bottom: 80px;
    }
    
    .touch-gesture-area {
        display: block;
    }
}

@media (max-width: 900px) {
    .cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: var(--macos-spacing-md);
    }
    
    .modal-content {
        max-width: 95%;
        margin: var(--macos-spacing-lg);
    }
    
    .export-options {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .table-container {
        border-radius: 0;
        margin-left: -16px;
        margin-right: -16px;
        width: calc(100% + 32px);
    }
    
    .table {
        min-width: 800px;
    }
}

@media (max-width: 768px) {
    .sudo-header {
        padding: 0 var(--macos-spacing-md);
    }
    
    .sudo-title {
        font-size: var(--macos-font-size-base);
    }
    
    .sudo-subtitle {
        display: none;
    }
    
    .live-status {
        padding: 4px 8px;
        font-size: 11px;
    }
    
    .user-info {
        display: none;
    }
    
    .mobile-user-menu {
        display: flex;
        align-items: center;
        gap: var(--macos-spacing-sm);
    }
    
    .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--macos-spacing-md);
    }
    
    .section-actions {
        justify-content: flex-start;
    }
    
    .cards-grid {
        grid-template-columns: 1fr;
        gap: var(--macos-spacing-md);
    }
    
    .card-header,
    .card-body {
        padding: var(--macos-spacing-md);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        padding: var(--macos-spacing-md);
    }
    
    .stat-value {
        font-size: 20px;
    }
    
    .btn {
        padding: 8px 14px;
        font-size: 13px;
        min-height: 36px;
    }
    
    .filter-container {
        flex-direction: column;
        gap: var(--macos-spacing-md);
    }
    
    .filter-input {
        min-width: 100%;
    }
    
    .modal-header,
    .modal-body,
    .modal-footer {
        padding: var(--macos-spacing-md);
    }
    
    .export-options {
        grid-template-columns: 1fr;
    }
    
    .pagination {
        gap: 4px;
    }
    
    .page-btn {
        width: 32px;
        height: 32px;
        font-size: 13px;
    }
    
    .multi-tab-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .tab-persistence-controls {
        margin-left: 0;
        justify-content: flex-end;
    }
    
    .notification {
        left: var(--macos-spacing-md);
        right: var(--macos-spacing-md);
        max-width: none;
        top: var(--macos-spacing-lg);
    }
}

@media (max-width: 576px) {
    :root {
        --macos-font-size-base: 0.875rem;
        --macos-font-size-lg: 1rem;
        --macos-font-size-xl: 1.125rem;
        --macos-font-size-2xl: 1.25rem;
    }
    
    .sudo-main {
        padding: var(--macos-spacing-md);
    }
    
    .section-title {
        font-size: var(--macos-font-size-lg);
    }
    
    .action-buttons {
        gap: var(--macos-spacing-xs);
    }
    
    .btn {
        padding: 6px 12px;
        font-size: 12px;
        min-height: 32px;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 11px;
        min-height: 28px;
    }
    
    .toggle-switch {
        width: 44px;
        height: 24px;
    }
    
    .toggle-slider:before {
        width: 16px;
        height: 16px;
        left: 4px;
        bottom: 4px;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    
    .table th,
    .table td {
        padding: 8px;
        font-size: 11px;
    }
    
    .status-badge,
    .role-badge {
        padding: 2px 6px;
        font-size: 10px;
    }
    
    .modal-content {
        margin: var(--macos-spacing-sm);
        max-height: 85vh;
    }
    
    .form-control {
        padding: 10px 12px;
        font-size: var(--macos-font-size-sm);
    }
    
    .chart-container {
        padding: var(--macos-spacing-md);
    }
    
    .chart-title {
        font-size: var(--macos-font-size-sm);
        margin-bottom: var(--macos-spacing-md);
    }
    
    .nav-tab {
        padding: 8px 4px;
        max-width: 70px;
    }
    
    .nav-tab-icon {
        font-size: 16px;
    }
    
    .nav-tab-label {
        font-size: 10px;
    }
}

@media (max-width: 480px) {
    .sudo-header {
        height: 48px;
    }
    
    .sudo-container {
        min-height: calc(100vh - 48px);
        margin-top: 48px;
    }
    
    .sudo-icon {
        width: 32px;
        height: 32px;
        font-size: 12px;
    }
    
    .mobile-menu-toggle {
        width: 36px;
        height: 36px;
    }
    
    .stats-grid {
        gap: var(--macos-spacing-sm);
    }
    
    .stat-card {
        padding: var(--macos-spacing-sm);
    }
    
    .stat-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }
    
    .stat-value {
        font-size: 18px;
    }
    
    .stat-label {
        font-size: 12px;
    }
    
    .cards-grid {
        gap: var(--macos-spacing-sm);
    }
    
    .card {
        border-radius: var(--macos-border-radius);
    }
    
    .form-group {
        margin-bottom: var(--macos-spacing-md);
    }
    
    .form-label {
        font-size: 12px;
    }
    
    .btn-icon {
        width: 28px;
        height: 28px;
        min-height: 28px;
    }
    
    .mobile-bottom-nav {
        padding: 8px 4px;
    }
    
    .nav-tab {
        padding: 6px 2px;
        max-width: 60px;
    }
}

@media (max-width: 360px) {
    .sudo-header {
        padding: 0 12px;
    }
    
    .sudo-logo {
        gap: 8px;
    }
    
    .sudo-title {
        font-size: 13px;
    }
    
    .header-actions {
        gap: 8px;
    }
    
    .mobile-menu-toggle {
        width: 32px;
        height: 32px;
    }
    
    .mobile-menu-toggle i {
        font-size: 16px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--macos-spacing-sm);
    }
    
    .card-actions {
        align-self: flex-end;
    }
    
    .btn {
        padding: 4px 10px;
        font-size: 11px;
        min-height: 28px;
    }
    
    .mobile-bottom-nav {
        padding: 6px 2px;
    }
    
    .nav-tab {
        padding: 4px 2px;
        max-width: 55px;
    }
    
    .nav-tab-icon {
        font-size: 14px;
    }
    
    .nav-tab-label {
        font-size: 9px;
    }
}

/* ===== Enhanced Utility Classes ===== */
.d-none { display: none !important; }
.d-flex { display: flex !important; }
.d-grid { display: grid !important; }
.d-block { display: block !important; }
.d-inline { display: inline !important; }
.d-inline-block { display: inline-block !important; }

.flex-column { flex-direction: column !important; }
.flex-row { flex-direction: row !important; }
.flex-wrap { flex-wrap: wrap !important; }
.flex-nowrap { flex-wrap: nowrap !important; }
.flex-1 { flex: 1 !important; }
.flex-auto { flex: auto !important; }
.flex-none { flex: none !important; }

.align-center { align-items: center !important; }
.align-start { align-items: flex-start !important; }
.align-end { align-items: flex-end !important; }
.align-stretch { align-items: stretch !important; }

.justify-center { justify-content: center !important; }
.justify-start { justify-content: flex-start !important; }
.justify-end { justify-content: flex-end !important; }
.justify-between { justify-content: space-between !important; }
.justify-around { justify-content: space-around !important; }
.justify-evenly { justify-content: space-evenly !important; }

.text-center { text-align: center !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-justify { text-align: justify !important; }

.text-truncate {
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

.text-nowrap { white-space: nowrap !important; }
.text-wrap { white-space: normal !important; }
.text-break { word-break: break-word !important; }

.font-light { font-weight: 300 !important; }
.font-normal { font-weight: 400 !important; }
.font-medium { font-weight: 500 !important; }
.font-semibold { font-weight: 600 !important; }
.font-bold { font-weight: 700 !important; }
.font-heavy { font-weight: 800 !important; }

.text-xs { font-size: var(--macos-font-size-xs) !important; }
.text-sm { font-size: var(--macos-font-size-sm) !important; }
.text-base { font-size: var(--macos-font-size-base) !important; }
.text-lg { font-size: var(--macos-font-size-lg) !important; }
.text-xl { font-size: var(--macos-font-size-xl) !important; }
.text-2xl { font-size: var(--macos-font-size-2xl) !important; }

.text-muted { color: var(--macos-gray-400) !important; }
.text-primary { color: var(--macos-blue) !important; }
.text-success { color: var(--macos-green) !important; }
.text-danger { color: var(--macos-red) !important; }
.text-warning { color: var(--macos-yellow) !important; }
.text-info { color: var(--macos-blue-light) !important; }
.text-dark { color: var(--macos-gray-600) !important; }
.text-light { color: var(--macos-gray-300) !important; }

.bg-primary { background-color: var(--macos-blue) !important; }
.bg-success { background-color: var(--macos-green) !important; }
.bg-danger { background-color: var(--macos-red) !important; }
.bg-warning { background-color: var(--macos-yellow) !important; }
.bg-info { background-color: var(--macos-blue-light) !important; }
.bg-light { background-color: var(--macos-gray-100) !important; }
.bg-white { background-color: white !important; }
.bg-transparent { background-color: transparent !important; }

.border { border: 1px solid var(--macos-gray-200) !important; }
.border-top { border-top: 1px solid var(--macos-gray-200) !important; }
.border-right { border-right: 1px solid var(--macos-gray-200) !important; }
.border-bottom { border-bottom: 1px solid var(--macos-gray-200) !important; }
.border-left { border-left: 1px solid var(--macos-gray-200) !important; }

.border-primary { border-color: var(--macos-blue) !important; }
.border-success { border-color: var(--macos-green) !important; }
.border-danger { border-color: var(--macos-red) !important; }
.border-warning { border-color: var(--macos-yellow) !important; }
.border-info { border-color: var(--macos-blue-light) !important; }
.border-light { border-color: var(--macos-gray-200) !important; }
.border-dark { border-color: var(--macos-gray-600) !important; }

.rounded { border-radius: var(--macos-border-radius) !important; }
.rounded-sm { border-radius: var(--macos-border-radius-small) !important; }
.rounded-lg { border-radius: var(--macos-border-radius-large) !important; }
.rounded-full { border-radius: 9999px !important; }
.rounded-top { border-top-left-radius: var(--macos-border-radius) !important; border-top-right-radius: var(--macos-border-radius) !important; }
.rounded-bottom { border-bottom-left-radius: var(--macos-border-radius) !important; border-bottom-right-radius: var(--macos-border-radius) !important; }
.rounded-left { border-top-left-radius: var(--macos-border-radius) !important; border-bottom-left-radius: var(--macos-border-radius) !important; }
.rounded-right { border-top-right-radius: var(--macos-border-radius) !important; border-bottom-right-radius: var(--macos-border-radius) !important; }

.shadow { box-shadow: var(--macos-shadow) !important; }
.shadow-sm { box-shadow: var(--macos-shadow-light) !important; }
.shadow-lg { box-shadow: var(--macos-shadow-heavy) !important; }
.shadow-none { box-shadow: none !important; }

.opacity-0 { opacity: 0 !important; }
.opacity-25 { opacity: 0.25 !important; }
.opacity-50 { opacity: 0.5 !important; }
.opacity-75 { opacity: 0.75 !important; }
.opacity-100 { opacity: 1 !important; }

.overflow-hidden { overflow: hidden !important; }
.overflow-auto { overflow: auto !important; }
.overflow-scroll { overflow: scroll !important; }
.overflow-x-auto { overflow-x: auto !important; }
.overflow-y-auto { overflow-y: auto !important; }
.overflow-x-hidden { overflow-x: hidden !important; }
.overflow-y-hidden { overflow-y: hidden !important; }

.position-static { position: static !important; }
.position-relative { position: relative !important; }
.position-absolute { position: absolute !important; }
.position-fixed { position: fixed !important; }
.position-sticky { position: sticky !important; }

.w-25 { width: 25% !important; }
.w-50 { width: 50% !important; }
.w-75 { width: 75% !important; }
.w-100 { width: 100% !important; }
.w-auto { width: auto !important; }

.h-25 { height: 25% !important; }
.h-50 { height: 50% !important; }
.h-75 { height: 75% !important; }
.h-100 { height: 100% !important; }
.h-auto { height: auto !important; }

.min-w-0 { min-width: 0 !important; }
.min-w-25 { min-width: 25% !important; }
.min-w-50 { min-width: 50% !important; }
.min-w-75 { min-width: 75% !important; }
.min-w-100 { min-width: 100% !important; }

.min-h-0 { min-height: 0 !important; }
.min-h-25 { min-height: 25% !important; }
.min-h-50 { min-height: 50% !important; }
.min-h-75 { min-height: 75% !important; }
.min-h-100 { min-height: 100% !important; }

.max-w-25 { max-width: 25% !important; }
.max-w-50 { max-width: 50% !important; }
.max-w-75 { max-width: 75% !important; }
.max-w-100 { max-width: 100% !important; }

.max-h-25 { max-height: 25% !important; }
.max-h-50 { max-height: 50% !important; }
.max-h-75 { max-height: 75% !important; }
.max-h-100 { max-height: 100% !important; }

.m-0 { margin: 0 !important; }
.m-1 { margin: var(--macos-spacing-xs) !important; }
.m-2 { margin: var(--macos-spacing-sm) !important; }
.m-3 { margin: var(--macos-spacing-md) !important; }
.m-4 { margin: var(--macos-spacing-lg) !important; }
.m-5 { margin: var(--macos-spacing-xl) !important; }
.m-6 { margin: var(--macos-spacing-2xl) !important; }
.m-7 { margin: var(--macos-spacing-3xl) !important; }

.mx-0 { margin-left: 0 !important; margin-right: 0 !important; }
.mx-1 { margin-left: var(--macos-spacing-xs) !important; margin-right: var(--macos-spacing-xs) !important; }
.mx-2 { margin-left: var(--macos-spacing-sm) !important; margin-right: var(--macos-spacing-sm) !important; }
.mx-3 { margin-left: var(--macos-spacing-md) !important; margin-right: var(--macos-spacing-md) !important; }
.mx-4 { margin-left: var(--macos-spacing-lg) !important; margin-right: var(--macos-spacing-lg) !important; }
.mx-5 { margin-left: var(--macos-spacing-xl) !important; margin-right: var(--macos-spacing-xl) !important; }
.mx-6 { margin-left: var(--macos-spacing-2xl) !important; margin-right: var(--macos-spacing-2xl) !important; }
.mx-7 { margin-left: var(--macos-spacing-3xl) !important; margin-right: var(--macos-spacing-3xl) !important; }

.my-0 { margin-top: 0 !important; margin-bottom: 0 !important; }
.my-1 { margin-top: var(--macos-spacing-xs) !important; margin-bottom: var(--macos-spacing-xs) !important; }
.my-2 { margin-top: var(--macos-spacing-sm) !important; margin-bottom: var(--macos-spacing-sm) !important; }
.my-3 { margin-top: var(--macos-spacing-md) !important; margin-bottom: var(--macos-spacing-md) !important; }
.my-4 { margin-top: var(--macos-spacing-lg) !important; margin-bottom: var(--macos-spacing-lg) !important; }
.my-5 { margin-top: var(--macos-spacing-xl) !important; margin-bottom: var(--macos-spacing-xl) !important; }
.my-6 { margin-top: var(--macos-spacing-2xl) !important; margin-bottom: var(--macos-spacing-2xl) !important; }
.my-7 { margin-top: var(--macos-spacing-3xl) !important; margin-bottom: var(--macos-spacing-3xl) !important; }

.mt-0 { margin-top: 0 !important; }
.mt-1 { margin-top: var(--macos-spacing-xs) !important; }
.mt-2 { margin-top: var(--macos-spacing-sm) !important; }
.mt-3 { margin-top: var(--macos-spacing-md) !important; }
.mt-4 { margin-top: var(--macos-spacing-lg) !important; }
.mt-5 { margin-top: var(--macos-spacing-xl) !important; }
.mt-6 { margin-top: var(--macos-spacing-2xl) !important; }
.mt-7 { margin-top: var(--macos-spacing-3xl) !important; }

.mb-0 { margin-bottom: 0 !important; }
.mb-1 { margin-bottom: var(--macos-spacing-xs) !important; }
.mb-2 { margin-bottom: var(--macos-spacing-sm) !important; }
.mb-3 { margin-bottom: var(--macos-spacing-md) !important; }
.mb-4 { margin-bottom: var(--macos-spacing-lg) !important; }
.mb-5 { margin-bottom: var(--macos-spacing-xl) !important; }
.mb-6 { margin-bottom: var(--macos-spacing-2xl) !important; }
.mb-7 { margin-bottom: var(--macos-spacing-3xl) !important; }

.ml-0 { margin-left: 0 !important; }
.ml-1 { margin-left: var(--macos-spacing-xs) !important; }
.ml-2 { margin-left: var(--macos-spacing-sm) !important; }
.ml-3 { margin-left: var(--macos-spacing-md) !important; }
.ml-4 { margin-left: var(--macos-spacing-lg) !important; }
.ml-5 { margin-left: var(--macos-spacing-xl) !important; }
.ml-6 { margin-left: var(--macos-spacing-2xl) !important; }
.ml-7 { margin-left: var(--macos-spacing-3xl) !important; }

.mr-0 { margin-right: 0 !important; }
.mr-1 { margin-right: var(--macos-spacing-xs) !important; }
.mr-2 { margin-right: var(--macos-spacing-sm) !important; }
.mr-3 { margin-right: var(--macos-spacing-md) !important; }
.mr-4 { margin-right: var(--macos-spacing-lg) !important; }
.mr-5 { margin-right: var(--macos-spacing-xl) !important; }
.mr-6 { margin-right: var(--macos-spacing-2xl) !important; }
.mr-7 { margin-right: var(--macos-spacing-3xl) !important; }

.p-0 { padding: 0 !important; }
.p-1 { padding: var(--macos-spacing-xs) !important; }
.p-2 { padding: var(--macos-spacing-sm) !important; }
.p-3 { padding: var(--macos-spacing-md) !important; }
.p-4 { padding: var(--macos-spacing-lg) !important; }
.p-5 { padding: var(--macos-spacing-xl) !important; }
.p-6 { padding: var(--macos-spacing-2xl) !important; }
.p-7 { padding: var(--macos-spacing-3xl) !important; }

.px-0 { padding-left: 0 !important; padding-right: 0 !important; }
.px-1 { padding-left: var(--macos-spacing-xs) !important; padding-right: var(--macos-spacing-xs) !important; }
.px-2 { padding-left: var(--macos-spacing-sm) !important; padding-right: var(--macos-spacing-sm) !important; }
.px-3 { padding-left: var(--macos-spacing-md) !important; padding-right: var(--macos-spacing-md) !important; }
.px-4 { padding-left: var(--macos-spacing-lg) !important; padding-right: var(--macos-spacing-lg) !important; }
.px-5 { padding-left: var(--macos-spacing-xl) !important; padding-right: var(--macos-spacing-xl) !important; }
.px-6 { padding-left: var(--macos-spacing-2xl) !important; padding-right: var(--macos-spacing-2xl) !important; }
.px-7 { padding-left: var(--macos-spacing-3xl) !important; padding-right: var(--macos-spacing-3xl) !important; }

.py-0 { padding-top: 0 !important; padding-bottom: 0 !important; }
.py-1 { padding-top: var(--macos-spacing-xs) !important; padding-bottom: var(--macos-spacing-xs) !important; }
.py-2 { padding-top: var(--macos-spacing-sm) !important; padding-bottom: var(--macos-spacing-sm) !important; }
.py-3 { padding-top: var(--macos-spacing-md) !important; padding-bottom: var(--macos-spacing-md) !important; }
.py-4 { padding-top: var(--macos-spacing-lg) !important; padding-bottom: var(--macos-spacing-lg) !important; }
.py-5 { padding-top: var(--macos-spacing-xl) !important; padding-bottom: var(--macos-spacing-xl) !important; }
.py-6 { padding-top: var(--macos-spacing-2xl) !important; padding-bottom: var(--macos-spacing-2xl) !important; }
.py-7 { padding-top: var(--macos-spacing-3xl) !important; padding-bottom: var(--macos-spacing-3xl) !important; }

.pt-0 { padding-top: 0 !important; }
.pt-1 { padding-top: var(--macos-spacing-xs) !important; }
.pt-2 { padding-top: var(--macos-spacing-sm) !important; }
.pt-3 { padding-top: var(--macos-spacing-md) !important; }
.pt-4 { padding-top: var(--macos-spacing-lg) !important; }
.pt-5 { padding-top: var(--macos-spacing-xl) !important; }
.pt-6 { padding-top: var(--macos-spacing-2xl) !important; }
.pt-7 { padding-top: var(--macos-spacing-3xl) !important; }

.pb-0 { padding-bottom: 0 !important; }
.pb-1 { padding-bottom: var(--macos-spacing-xs) !important; }
.pb-2 { padding-bottom: var(--macos-spacing-sm) !important; }
.pb-3 { padding-bottom: var(--macos-spacing-md) !important; }
.pb-4 { padding-bottom: var(--macos-spacing-lg) !important; }
.pb-5 { padding-bottom: var(--macos-spacing-xl) !important; }
.pb-6 { padding-bottom: var(--macos-spacing-2xl) !important; }
.pb-7 { padding-bottom: var(--macos-spacing-3xl) !important; }

.pl-0 { padding-left: 0 !important; }
.pl-1 { padding-left: var(--macos-spacing-xs) !important; }
.pl-2 { padding-left: var(--macos-spacing-sm) !important; }
.pl-3 { padding-left: var(--macos-spacing-md) !important; }
.pl-4 { padding-left: var(--macos-spacing-lg) !important; }
.pl-5 { padding-left: var(--macos-spacing-xl) !important; }
.pl-6 { padding-left: var(--macos-spacing-2xl) !important; }
.pl-7 { padding-left: var(--macos-spacing-3xl) !important; }

.pr-0 { padding-right: 0 !important; }
.pr-1 { padding-right: var(--macos-spacing-xs) !important; }
.pr-2 { padding-right: var(--macos-spacing-sm) !important; }
.pr-3 { padding-right: var(--macos-spacing-md) !important; }
.pr-4 { padding-right: var(--macos-spacing-lg) !important; }
.pr-5 { padding-right: var(--macos-spacing-xl) !important; }
.pr-6 { padding-right: var(--macos-spacing-2xl) !important; }
.pr-7 { padding-right: var(--macos-spacing-3xl) !important; }

.gap-0 { gap: 0 !important; }
.gap-1 { gap: var(--macos-spacing-xs) !important; }
.gap-2 { gap: var(--macos-spacing-sm) !important; }
.gap-3 { gap: var(--macos-spacing-md) !important; }
.gap-4 { gap: var(--macos-spacing-lg) !important; }
.gap-5 { gap: var(--macos-spacing-xl) !important; }
.gap-6 { gap: var(--macos-spacing-2xl) !important; }
.gap-7 { gap: var(--macos-spacing-3xl) !important; }

.grid-cols-1 { grid-template-columns: repeat(1, 1fr) !important; }
.grid-cols-2 { grid-template-columns: repeat(2, 1fr) !important; }
.grid-cols-3 { grid-template-columns: repeat(3, 1fr) !important; }
.grid-cols-4 { grid-template-columns: repeat(4, 1fr) !important; }
.grid-cols-5 { grid-template-columns: repeat(5, 1fr) !important; }
.grid-cols-6 { grid-template-columns: repeat(6, 1fr) !important; }

.col-span-1 { grid-column: span 1 !important; }
.col-span-2 { grid-column: span 2 !important; }
.col-span-3 { grid-column: span 3 !important; }
.col-span-4 { grid-column: span 4 !important; }
.col-span-5 { grid-column: span 5 !important; }
.col-span-6 { grid-column: span 6 !important; }

.row-span-1 { grid-row: span 1 !important; }
.row-span-2 { grid-row: span 2 !important; }
.row-span-3 { grid-row: span 3 !important; }
.row-span-4 { grid-row: span 4 !important; }
.row-span-5 { grid-row: span 5 !important; }
.row-span-6 { grid-row: span 6 !important; }

/* ===== Enhanced Custom Scrollbar ===== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--macos-gray-100);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: var(--macos-gray-300);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--macos-gray-400);
}

/* Hide scrollbar for Chrome, Safari and Opera */
.scrollbar-hidden::-webkit-scrollbar {
    display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.scrollbar-hidden {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* ===== Enhanced Print Styles ===== */
@media print {
    .sudo-header,
    .sudo-sidebar,
    .mobile-menu-toggle,
    .mobile-bottom-nav,
    .section-actions,
    .card-actions,
    .btn:not(.print-visible),
    .toggle-switch,
    .modal,
    .notification,
    .loading-overlay,
    .tab-controls,
    .tab-close,
    .grid-controls,
    .multi-tab-controls,
    .tab-persistence-controls {
        display: none !important;
    }
    
    .sudo-container {
        display: block;
        margin-top: 0;
    }
    
    .sudo-main {
        margin-left: 0;
        padding: 0;
    }
    
    .content-section {
        display: block !important;
        opacity: 1 !important;
        transform: none !important;
        height: auto !important;
        page-break-inside: avoid;
    }
    
    .card {
        border: 1px solid var(--macos-gray-300);
        box-shadow: none;
        page-break-inside: avoid;
    }
    
    .table-container {
        overflow: visible;
        border: 1px solid var(--macos-gray-300);
    }
    
    .table {
        min-width: auto;
    }
    
    body {
        background: white;
        color: black;
    }
    
    .text-dark {
        color: black !important;
    }
    
    .bg-white {
        background-color: white !important;
    }
    
    .shadow,
    .shadow-sm,
    .shadow-lg {
        box-shadow: none !important;
    }
}

/* ===== Enhanced Accessibility Styles ===== */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

@media (prefers-contrast: high) {
    :root {
        --macos-gray-100: #ffffff;
        --macos-gray-200: #e0e0e0;
        --macos-gray-300: #c0c0c0;
        --macos-gray-400: #808080;
        --macos-gray-500: #404040;
        --macos-gray-600: #000000;
        --macos-blue: #0000ff;
        --macos-green: #008000;
        --macos-red: #ff0000;
        --macos-yellow: #ffff00;
    }
    
    .sudo-header,
    .sudo-sidebar,
    .card,
    .modal-content,
    .notification {
        border: 2px solid var(--macos-gray-600);
    }
}

@media (prefers-color-scheme: dark) {
    :root {
        --macos-gray-100: #1d1d1f;
        --macos-gray-200: #2d2d2f;
        --macos-gray-300: #3d3d3f;
        --macos-gray-400: #86868b;
        --macos-gray-500: #a1a1a6;
        --macos-gray-600: #f5f5f7;
        --macos-blue: #0a84ff;
        --macos-blue-light: #5ac8fa;
        --macos-blue-dark: #0077ed;
        --macos-green: #30d158;
        --macos-red: #ff453a;
        --macos-purple: #bf5af2;
        --macos-yellow: #ffd60a;
        --macos-orange: #ff9f0a;
        --macos-pink: #ff375f;
        --macos-glass: rgba(30, 30, 32, 0.85);
        --macos-glass-border: rgba(60, 60, 65, 0.6);
        --macos-danger-bg: rgba(255, 69, 58, 0.15);
        --macos-warning-bg: rgba(255, 214, 10, 0.15);
        --macos-success-bg: rgba(48, 209, 88, 0.15);
        --macos-info-bg: rgba(10, 132, 255, 0.15);
    }
    
    body {
        background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
        color: var(--macos-gray-600);
    }
    
    body::before {
        background-image: 
            radial-gradient(at 10% 20%, rgba(120, 119, 198, 0.1) 0px, transparent 50%),
            radial-gradient(at 90% 10%, rgba(10, 132, 255, 0.1) 0px, transparent 50%),
            radial-gradient(at 50% 90%, rgba(48, 209, 88, 0.1) 0px, transparent 50%);
    }
    
    .form-control {
        background: rgba(30, 30, 32, 0.9);
        border-color: var(--macos-gray-300);
        color: var(--macos-gray-600);
    }
    
    .form-control:focus {
        background: rgba(40, 40, 42, 0.9);
    }
    
    .table th {
        background: rgba(0, 0, 0, 0.2);
    }
    
    .table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .btn-outline {
        border-color: var(--macos-gray-400);
        color: var(--macos-gray-500);
    }
    
    .btn-outline:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .loading-overlay {
        background: rgba(0, 0, 0, 0.9);
    }
    
    .loading-text {
        color: var(--macos-gray-600);
    }
    
    .code-editor {
        background: #0d1117;
        color: #c9d1d9;
    }
    
    .code-header {
        background: #161b22;
        border-bottom-color: #30363d;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--macos-gray-200);
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--macos-gray-400);
    }
    
    .file-upload-container {
        border-color: var(--macos-gray-400);
    }
    
    .uploaded-file {
        background: var(--macos-gray-200);
    }
    
    .page-btn {
        background: var(--macos-gray-200);
        border-color: var(--macos-gray-300);
        color: var(--macos-gray-500);
    }
    
    .page-btn.active {
        background: var(--macos-blue);
        border-color: var(--macos-blue);
        color: white;
    }
    
    .bg-light {
        background-color: var(--macos-gray-200) !important;
    }
    
    .border {
        border-color: var(--macos-gray-300) !important;
    }
    
    .text-muted {
        color: var(--macos-gray-400) !important;
    }
    
    .text-light {
        color: var(--macos-gray-500) !important;
    }
}

/* ===== Enhanced Performance Optimizations ===== */
.will-change-transform {
    will-change: transform;
}

.will-change-opacity {
    will-change: opacity;
}

.will-change-contents {
    will-change: contents;
}

.content-visibility-auto {
    content-visibility: auto;
}

.contain-layout {
    contain: layout;
}

.contain-paint {
    contain: paint;
}

.contain-strict {
    contain: strict;
}

/* ===== Enhanced JavaScript Hooks ===== */
[data-tab-persistent="true"] {
    display: block !important;
    height: auto !important;
    opacity: 1 !important;
    transform: none !important;
    pointer-events: auto !important;
}

[data-tab-state="minimized"] {
    height: 60px !important;
    overflow: hidden !important;
}

[data-tab-state="maximized"] {
    height: 80vh !important;
    position: fixed !important;
    top: 60px !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 1000 !important;
    background: var(--macos-glass) !important;
    backdrop-filter: blur(20px) !important;
}

[data-grid-size="small"] .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
    gap: var(--macos-spacing-md) !important;
}

[data-grid-size="large"] .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)) !important;
    gap: var(--macos-spacing-xl) !important;
}

[data-sidebar-state="collapsed"] .sudo-sidebar {
    width: var(--macos-sidebar-collapsed) !important;
}

[data-sidebar-state="collapsed"] .sudo-main {
    margin-left: var(--macos-sidebar-collapsed) !important;
}

[data-mobile-menu="open"] .sudo-sidebar {
    transform: translateX(0) !important;
}

[data-mobile-menu="open"] .sudo-main::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 899;
}

/* ===== Enhanced Loading States ===== */
.loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--macos-gray-300);
    border-top-color: var(--macos-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.skeleton {
    background: linear-gradient(90deg, var(--macos-gray-100) 25%, var(--macos-gray-200) 50%, var(--macos-gray-100) 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: var(--macos-border-radius-small);
    min-height: 1em;
}

.skeleton-circle {
    border-radius: 50%;
}

.skeleton-text {
    height: 1em;
    margin-bottom: 0.5em;
}

.skeleton-text:last-child {
    margin-bottom: 0;
    width: 80%;
}

@keyframes skeleton-loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* ===== Enhanced Error States ===== */
.error-state {
    text-align: center;
    padding: var(--macos-spacing-3xl) var(--macos-spacing-lg);
    color: var(--macos-gray-400);
}

.error-icon {
    font-size: 48px;
    color: var(--macos-gray-300);
    margin-bottom: var(--macos-spacing-lg);
}

.error-title {
    font-size: var(--macos-font-size-lg);
    font-weight: 600;
    color: var(--macos-gray-600);
    margin-bottom: var(--macos-spacing-sm);
}

.error-message {
    font-size: var(--macos-font-size-base);
    color: var(--macos-gray-500);
    margin-bottom: var(--macos-spacing-lg);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

/* ===== Enhanced Empty States ===== */
.empty-state {
    text-align: center;
    padding: var(--macos-spacing-3xl) var(--macos-spacing-lg);
    color: var(--macos-gray-400);
}

.empty-icon {
    font-size: 48px;
    color: var(--macos-gray-300);
    margin-bottom: var(--macos-spacing-lg);
}

.empty-title {
    font-size: var(--macos-font-size-lg);
    font-weight: 600;
    color: var(--macos-gray-600);
    margin-bottom: var(--macos-spacing-sm);
}

.empty-message {
    font-size: var(--macos-font-size-base);
    color: var(--macos-gray-500);
    margin-bottom: var(--macos-spacing-lg);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

/* ===== Enhanced Tooltips ===== */
[data-tooltip] {
    position: relative;
}

[data-tooltip]::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 6px 12px;
    background: var(--macos-gray-600);
    color: white;
    font-size: var(--macos-font-size-xs);
    font-weight: 500;
    border-radius: var(--macos-border-radius-small);
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: var(--macos-transition);
    z-index: 1000;
    pointer-events: none;
}

[data-tooltip]::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: var(--macos-gray-600);
    opacity: 0;
    visibility: hidden;
    transition: var(--macos-transition);
    z-index: 1000;
    pointer-events: none;
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
    opacity: 1;
    visibility: visible;
}

/* ===== Enhanced Context Menus ===== */
.context-menu {
    position: fixed;
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius);
    box-shadow: var(--macos-shadow-heavy);
    padding: var(--macos-spacing-xs);
    min-width: 160px;
    z-index: 2000;
    opacity: 0;
    transform: scale(0.95);
    transform-origin: top left;
    transition: opacity 0.2s, transform 0.2s;
}

.context-menu.active {
    opacity: 1;
    transform: scale(1);
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
    padding: 8px 12px;
    border-radius: var(--macos-border-radius-small);
    color: var(--macos-gray-600);
    cursor: pointer;
    transition: var(--macos-transition);
    font-size: var(--macos-font-size-sm);
}

.context-menu-item:hover {
    background: var(--macos-blue);
    color: white;
}

.context-menu-item.danger:hover {
    background: var(--macos-red);
}

.context-menu-divider {
    height: 1px;
    background: var(--macos-gray-200);
    margin: var(--macos-spacing-xs) 0;
}

/* ===== Enhanced Drag & Drop ===== */
.drag-handle {
    cursor: move;
    color: var(--macos-gray-400);
    transition: var(--macos-transition);
}

.drag-handle:hover {
    color: var(--macos-gray-600);
}

.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.drop-zone {
    border: 2px dashed var(--macos-blue);
    background: var(--macos-info-bg);
    border-radius: var(--macos-border-radius);
    padding: var(--macos-spacing-xl);
    text-align: center;
    transition: var(--macos-transition);
}

.drop-zone.active {
    border-color: var(--macos-green);
    background: var(--macos-success-bg);
}

/* ===== Enhanced Keyboard Shortcuts ===== */
.kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background: var(--macos-gray-100);
    border: 1px solid var(--macos-gray-300);
    border-radius: 4px;
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    color: var(--macos-gray-600);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', Monaco, 'Courier New', monospace;
    line-height: 1;
    box-shadow: 0 1px 0 var(--macos-gray-300);
}

.kbd-group {
    display: inline-flex;
    align-items: center;
    gap: 2px;
}

/* ===== Enhanced Theme Switcher ===== */
.theme-switcher {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-sm);
    padding: var(--macos-spacing-sm);
    background: var(--macos-gray-100);
    border-radius: var(--macos-border-radius);
}

.theme-option {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: var(--macos-border-radius-small);
    background: white;
    border: 1px solid var(--macos-gray-300);
    cursor: pointer;
    transition: var(--macos-transition);
    position: relative;
}

.theme-option:hover {
    border-color: var(--macos-blue);
}

.theme-option.active {
    border-color: var(--macos-blue);
    background: var(--macos-info-bg);
}

.theme-option::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    right: 2px;
    bottom: 2px;
    border-radius: 4px;
}

.theme-option[data-theme="light"]::before {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
}

.theme-option[data-theme="dark"]::before {
    background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
}

.theme-option[data-theme="auto"]::before {
    background: linear-gradient(135deg, #f5f7fa 0%, #1d1d1f 100%);
}

/* ===== Enhanced Zoom Controls ===== */
.zoom-controls {
    display: flex;
    align-items: center;
    gap: var(--macos-spacing-xs);
    background: var(--macos-gray-100);
    border-radius: var(--macos-border-radius);
    padding: var(--macos-spacing-xs);
}

.zoom-btn {
    width: 28px;
    height: 28px;
    border-radius: var(--macos-border-radius-small);
    border: 1px solid var(--macos-gray-300);
    background: white;
    color: var(--macos-gray-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--macos-transition);
    font-size: 12px;
}

.zoom-btn:hover {
    border-color: var(--macos-blue);
    color: var(--macos-blue);
}

.zoom-level {
    font-size: var(--macos-font-size-xs);
    font-weight: 600;
    color: var(--macos-gray-600);
    min-width: 40px;
    text-align: center;
}

/* ===== Enhanced Split View ===== */
.split-view {
    display: flex;
    height: 100%;
    overflow: hidden;
}

.split-pane {
    overflow: auto;
    transition: var(--macos-transition);
}

.split-handle {
    width: 4px;
    background: var(--macos-gray-200);
    cursor: col-resize;
    transition: var(--macos-transition);
    position: relative;
}

.split-handle:hover,
.split-handle.active {
    background: var(--macos-blue);
}

.split-handle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -8px;
    right: -8px;
    bottom: 0;
}

/* ===== Enhanced Tour Guide ===== */
.tour-step {
    position: fixed;
    background: var(--macos-glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--macos-glass-border);
    border-radius: var(--macos-border-radius-large);
    box-shadow: var(--macos-shadow-heavy);
    padding: var(--macos-spacing-lg);
    max-width: 320px;
    z-index: 3000;
    animation: tour-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes tour-pop {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.tour-step::before {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    background: var(--macos-glass);
    border: 1px solid var(--macos-glass-border);
    transform: rotate(45deg);
}

.tour-step[data-placement="top"]::before {
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    border-top: none;
    border-left: none;
}

.tour-step[data-placement="bottom"]::before {
    top: -6px;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    border-bottom: none;
    border-right: none;
}

.tour-step[data-placement="left"]::before {
    right: -6px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    border-left: none;
    border-bottom: none;
}

.tour-step[data-placement="right"]::before {
    left: -6px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    border-right: none;
    border-top: none;
}

.tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 2999;
}

.tour-title {
    font-size: var(--macos-font-size-base);
    font-weight: 600;
    color: var(--macos-gray-600);
    margin-bottom: var(--macos-spacing-sm);
}

.tour-content {
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-500);
    margin-bottom: var(--macos-spacing-lg);
    line-height: 1.5;
}

.tour-actions {
    display: flex;
    justify-content: space-between;
    gap: var(--macos-spacing-sm);
}

.tour-step-number {
    font-size: var(--macos-font-size-xs);
    color: var(--macos-gray-400);
    margin-top: var(--macos-spacing-sm);
}

/* ===== Enhanced Performance Monitoring ===== */
.perf-monitor {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    font-size: 11px;
    padding: 8px 12px;
    border-radius: 4px;
    z-index: 10000;
    pointer-events: none;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.perf-monitor:hover {
    opacity: 1;
}

.perf-metric {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 2px;
}

.perf-metric:last-child {
    margin-bottom: 0;
}

.perf-label {
    color: #aaa;
}

.perf-value {
    color: white;
}

.perf-value.good {
    color: #34c759;
}

.perf-value.warning {
    color: #ffcc00;
}

.perf-value.bad {
    color: #ff3b30;
}

/* ===== Enhanced Touch Gesture Feedback ===== */
.touch-ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(0, 122, 255, 0.3);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

.touch-feedback {
    transition: transform 0.1s;
}

.touch-feedback:active {
    transform: scale(0.95);
}

/* ===== Enhanced Battery Saver Mode ===== */
[data-battery-saver="true"] {
    filter: grayscale(1) brightness(0.9);
}

[data-battery-saver="true"] .skeleton,
[data-battery-saver="true"] .loading,
[data-battery-saver="true"] [data-lazy-load] {
    animation-play-state: paused;
}

/* ===== Enhanced Data Saver Mode ===== */
[data-data-saver="true"] img,
[data-data-saver="true"] video,
[data-data-saver="true"] iframe {
    opacity: 0.5;
    filter: blur(2px);
}

[data-data-saver="true"] img:not([data-essential]),
[data-data-saver="true"] video:not([data-essential]),
[data-data-saver="true"] iframe:not([data-essential]) {
    display: none;
}

/* ===== Enhanced Reduced Motion Support ===== */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
    
    .tour-step,
    .context-menu,
    .modal-content {
        animation: none !important;
    }
    
    .skeleton,
    .loading-spinner,
    .live-dot {
        animation: none !important;
    }
}

/* ===== Enhanced High Contrast Support ===== */
@media (prefers-contrast: high) {
    .btn-outline,
    .form-control,
    .table th,
    .table td {
        border-width: 2px;
    }
    
    .nav-item.active {
        border: 2px solid var(--macos-blue);
    }
    
    .toggle-slider {
        border: 2px solid var(--macos-gray-600);
    }
    
    .modal-content,
    .notification,
    .card {
        border: 2px solid var(--macos-gray-600);
    }
}

/* ===== Enhanced Print Optimizations ===== */
@media print {
    .no-print {
        display: none !important;
    }
    
    .print-only {
        display: block !important;
    }
    
    body {
        font-size: 12pt;
        line-height: 1.4;
    }
    
    .card,
    .table-container {
        break-inside: avoid;
    }
    
    h1, h2, h3, h4, h5, h6 {
        break-after: avoid;
    }
    
    table {
        break-inside: avoid;
    }
    
    thead {
        display: table-header-group;
    }
    
    tfoot {
        display: table-footer-group;
    }
}

/* ===== Enhanced Security Features ===== */
[data-secure-field] {
    -webkit-text-security: disc;
    text-security: disc;
}

.secure-container {
    position: relative;
}

.secure-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--macos-border-radius);
    z-index: 1;
}

.secure-prompt {
    text-align: center;
    padding: var(--macos-spacing-lg);
}

.secure-icon {
    font-size: 24px;
    color: var(--macos-gray-400);
    margin-bottom: var(--macos-spacing-sm);
}

.secure-text {
    font-size: var(--macos-font-size-sm);
    color: var(--macos-gray-500);
    margin-bottom: var(--macos-spacing-md);
}

/* ===== Enhanced Accessibility Features ===== */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.focus-visible:focus-visible {
    outline: 2px solid var(--macos-blue);
    outline-offset: 2px;
}

.skip-to-content {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--macos-blue);
    color: white;
    padding: 8px 16px;
    border-radius: var(--macos-border-radius);
    text-decoration: none;
    z-index: 1001;
    transition: top 0.3s;
}

.skip-to-content:focus {
    top: 10px;
}

/* ===== Enhanced Performance Features ===== */
.lazy-load {
    opacity: 0;
    transition: opacity 0.3s;
}

.lazy-load.loaded {
    opacity: 1;
}

.placeholder {
    background: var(--macos-gray-100);
    border-radius: var(--macos-border-radius);
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--macos-gray-400);
}

/* ===== Enhanced Developer Tools ===== */
.dev-tools {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 12px;
    border-radius: var(--macos-border-radius);
    font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    font-size: 11px;
    z-index: 10000;
    max-width: 300px;
    max-height: 200px;
    overflow: auto;
}

.dev-tools-toggle {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    background: var(--macos-blue);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 9999;
    box-shadow: var(--macos-shadow);
}

/* ===== Enhanced Custom Properties Debug ===== */
@property --macos-blue {
    syntax: '<color>';
    inherits: false;
    initial-value: #007AFF;
}

@property --macos-green {
    syntax: '<color>';
    inherits: false;
    initial-value: #34c759;
}

@property --macos-red {
    syntax: '<color>';
    inherits: false;
    initial-value: #ff3b30;
}

/* ===== Enhanced CSS Grid Debug ===== */
.debug-grid {
    background-image: linear-gradient(to right, rgba(0, 122, 255, 0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(0, 122, 255, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
}

.debug-outline * {
    outline: 1px solid rgba(255, 0, 0, 0.1);
}

/* ===== Enhanced Final Overrides ===== */
*:focus {
    outline: 2px solid var(--macos-blue);
    outline-offset: 2px;
}

*:focus:not(:focus-visible) {
    outline: none;
}

::selection {
    background: var(--macos-blue);
    color: white;
}

::-moz-selection {
    background: var(--macos-blue);
    color: white;
}

/* ===== Enhanced Scroll Snap ===== */
.scroll-snap-x {
    scroll-snap-type: x mandatory;
    overflow-x: auto;
}

.scroll-snap-y {
    scroll-snap-type: y mandatory;
    overflow-y: auto;
}

.scroll-snap-item {
    scroll-snap-align: start;
}

/* ===== Enhanced Masonry Layout ===== */
.masonry-grid {
    column-count: 3;
    column-gap: var(--macos-spacing-lg);
}

.masonry-item {
    break-inside: avoid;
    margin-bottom: var(--macos-spacing-lg);
}

@media (max-width: 768px) {
    .masonry-grid {
        column-count: 2;
    }
}

@media (max-width: 480px) {
    .masonry-grid {
        column-count: 1;
    }
}

/* ===== Enhanced Fluid Typography ===== */
.fluid-text {
    font-size: clamp(1rem, 2vw, 1.5rem);
}

.fluid-heading {
    font-size: clamp(1.5rem, 4vw, 3rem);
}

/* ===== Enhanced Aspect Ratios ===== */
.aspect-ratio-16-9 {
    aspect-ratio: 16 / 9;
}

.aspect-ratio-4-3 {
    aspect-ratio: 4 / 3;
}

.aspect-ratio-1-1 {
    aspect-ratio: 1 / 1;
}

.aspect-ratio-3-2 {
    aspect-ratio: 3 / 2;
}

/* ===== Enhanced Backdrop Filters ===== */
.backdrop-blur {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.backdrop-blur-heavy {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

.backdrop-blur-light {
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* ===== Enhanced Glass Morphism ===== */
.glass {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
}

.glass-dark {
    background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
}

/* ===== Enhanced Neon Effects ===== */
.neon-text {
    color: #fff;
    text-shadow:
        0 0 5px #fff,
        0 0 10px #fff,
        0 0 20px #fff,
        0 0 40px var(--macos-blue),
        0 0 80px var(--macos-blue),
        0 0 90px var(--macos-blue),
        0 0 100px var(--macos-blue),
        0 0 150px var(--macos-blue);
}

.neon-border {
    border: 2px solid #fff;
    box-shadow:
        0 0 5px #fff,
        inset 0 0 5px #fff,
        0 0 20px var(--macos-blue),
        inset 0 0 20px var(--macos-blue),
        0 0 40px var(--macos-blue),
        inset 0 0 40px var(--macos-blue);
    border-radius: var(--macos-border-radius);
}

/* ===== Enhanced Gradient Borders ===== */
.gradient-border {
    position: relative;
    background: white;
    border-radius: var(--macos-border-radius);
}

.gradient-border::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--macos-blue), var(--macos-purple), var(--macos-pink));
    border-radius: calc(var(--macos-border-radius) + 2px);
    z-index: -1;
}

/* ===== Enhanced Floating Animations ===== */
@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.float-animation {
    animation: float 3s ease-in-out infinite;
}

/* ===== Enhanced Pulse Animations ===== */
@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 0 5px var(--macos-blue);
    }
    50% {
        box-shadow: 0 0 20px var(--macos-blue), 0 0 30px var(--macos-blue);
    }
}

.pulse-glow {
    animation: pulse-glow 2s infinite;
}

/* ===== Enhanced Shimmer Effect ===== */
.shimmer {
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.2) 50%,
        transparent 100%
    );
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* ===== Enhanced Typewriter Effect ===== */
.typewriter {
    overflow: hidden;
    border-right: 2px solid var(--macos-blue);
    white-space: nowrap;
    animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
}

@keyframes typing {
    from { width: 0; }
    to { width: 100%; }
}

@keyframes blink-caret {
    from, to { border-color: transparent; }
    50% { border-color: var(--macos-blue); }
}

/* ===== Enhanced Final Optimizations ===== */
@media (hover: none) and (pointer: coarse) {
    .btn,
    .nav-item,
    .card,
    .export-option {
        min-height: 44px;
    }
    
    .form-control,
    .form-select {
        min-height: 44px;
        font-size: 16px; /* Prevents iOS zoom */
    }
    
    .touch-target {
        min-width: 44px;
        min-height: 44px;
    }
}

/* ===== Enhanced Print Styles ===== */
@media print {
    * {
        color: black !important;
        background: white !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }
    
    .sudo-header,
    .sudo-sidebar,
    .mobile-menu-toggle,
    .mobile-bottom-nav,
    .btn,
    .modal,
    .notification,
    .loading-overlay {
        display: none !important;
    }
    
    .sudo-container {
        display: block;
        margin-top: 0;
    }
    
    .sudo-main {
        margin-left: 0;
        padding: 0;
    }
    
    .content-section {
        display: block !important;
        page-break-inside: avoid;
    }
    
    a[href]::after {
        content: " (" attr(href) ")";
    }
    
    abbr[title]::after {
        content: " (" attr(title) ")";
    }
    
    pre {
        border: 1px solid #999;
        page-break-inside: avoid;
    }
    
    blockquote {
        border-left: 2px solid #999;
        padding-left: 10px;
    }
    
    thead {
        display: table-header-group;
    }
    
    tr,
    img {
        page-break-inside: avoid;
    }
    
    img {
        max-width: 100% !important;
    }
    
    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }
    
    h2,
    h3 {
        page-break-after: avoid;
    }
}

/* ===== Enhanced CSS Custom Properties Fallbacks ===== */
@supports not (backdrop-filter: blur(10px)) {
    .sudo-header,
    .sudo-sidebar,
    .modal-content,
    .notification,
    .card,
    .glass {
        background: rgba(255, 255, 255, 0.95);
    }
}

@supports not (gap: 1rem) {
    .stats-grid,
    .cards-grid,
    .action-buttons,
    .filter-container {
        margin: -0.5rem;
    }
    
    .stats-grid > *,
    .cards-grid > *,
    .action-buttons > *,
    .filter-container > * {
        margin: 0.5rem;
    }
}

/* ===== Enhanced Final Layer ===== */
@layer base {
    :root {
        color-scheme: light dark;
    }
}

@layer components {
    .btn {
        @layer components;
    }
    
    .card {
        @layer components;
    }
    
    .form-control {
        @layer components;
    }
}

@layer utilities {
    .text-truncate {
        @layer utilities;
    }
    
    .flex-center {
        @layer utilities;
    }
}

/* ===== Enhanced Container Queries ===== */
@container (min-width: 400px) {
    .card-header {
        flex-direction: row;
        align-items: center;
    }
    
    .card-actions {
        margin-top: 0;
    }
}

@container (max-width: 399px) {
    .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--macos-spacing-sm);
    }
    
    .card-actions {
        margin-top: var(--macos-spacing-sm);
        justify-content: flex-end;
    }
}

/* ===== Enhanced View Transition API ===== */
@view-transition {
    navigation: auto;
}

::view-transition-group(*) {
    animation-duration: 0.5s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
}

::view-transition-old(root),
::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
}

/* ===== Enhanced Final Fallbacks ===== */
.no-js .content-section {
    display: block !important;
    opacity: 1 !important;
    transform: none !important;
}

.no-js .sudo-sidebar {
    position: static;
    transform: none !important;
}

.no-js .sudo-main {
    margin-left: 0 !important;
}

.no-js .mobile-menu-toggle,
.no-js .mobile-bottom-nav,
.no-js .modal,
.no-js .notification {
    display: none !important;
}

/* ===== Enhanced Final Media Query for Ultra-Wide Screens ===== */
@media (min-width: 1920px) {
    .sudo-container {
        max-width: 1800px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
}

/* ===== Enhanced Final Touch ===== */
/* This ensures all interactive elements have proper touch feedback */
button,
input,
select,
textarea,
.nav-item,
.card,
.export-option {
    -webkit-tap-highlight-color: transparent;
}

/* Enhanced selection colors */
::selection {
    background-color: var(--macos-blue);
    color: white;
}

::-moz-selection {
    background-color: var(--macos-blue);
    color: white;
}

/* Enhanced focus styles for accessibility */
:focus-visible {
    outline: 2px solid var(--macos-blue);
    outline-offset: 2px;
}

/* Enhanced reduced motion support */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* ===== END OF ENHANCED CSS ===== */
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading SUDO Control Panel...</div>
    </div>

    <!-- SUDO Header -->
    <header class="sudo-header">
        <div class="sudo-logo">
            <div class="sudo-icon">SU</div>
            <div>
                <div class="sudo-title">TruCash SUDO</div>
                <div class="sudo-subtitle">Super Control Admin</div>
            </div>
        </div>
        <div class="header-actions">
            <div class="live-status">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">SU</div>
                <div>
                    <div style="font-size: 13px; font-weight: 600;" id="userName">SUDO Admin</div>
                    <div style="font-size: 11px; color: var(--macos-gray-400);" id="userRole">Full System Control</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="sudo-container">
        <!-- Sidebar Navigation -->
        <nav class="sudo-sidebar">
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <div class="nav-item active" data-section="dashboard">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Overview</div>
                </div>
                <div class="nav-item" data-section="analytics">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="nav-text">Analytics</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">User Management</div>
                <div class="nav-item" data-section="admins">
                    <div class="nav-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="nav-text">Admin Accounts</div>
                </div>
                <div class="nav-item" data-section="agents">
                    <div class="nav-icon"><i class="fas fa-id-badge"></i></div>
                    <div class="nav-text">Agent Accounts</div>
                </div>
                <div class="nav-item" data-section="customers">
                    <div class="nav-icon"><i class="fas fa-users"></i></div>
                    <div class="nav-text">Customer Accounts</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System Control</div>
                <div class="nav-item" data-section="features">
                    <div class="nav-icon"><i class="fas fa-toggle-on"></i></div>
                    <div class="nav-text">Feature Flags</div>
                </div>
                <div class="nav-item" data-section="financial">
                    <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="nav-text">Financial Settings</div>
                </div>
                <div class="nav-item" data-section="repayment">
                    <div class="nav-icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="nav-text">Repayment Plans</div>
                </div>
                <div class="nav-item" data-section="notifications">
                    <div class="nav-icon"><i class="fas fa-bell"></i></div>
                    <div class="nav-text">Notifications</div>
                </div>
                <div class="nav-item" data-section="ui-settings">
                    <div class="nav-icon"><i class="fas fa-sliders-h"></i></div>
                    <div class="nav-text">UI Behavior</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Security & Monitoring</div>
                <div class="nav-item" data-section="security">
                    <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="nav-text">Security Settings</div>
                </div>
                <div class="nav-item" data-section="audit">
                    <div class="nav-icon"><i class="fas fa-history"></i></div>
                    <div class="nav-text">Audit Logs</div>
                    <div class="nav-badge" id="auditBadge">0</div>
                </div>
                <div class="nav-item" data-section="backup">
                    <div class="nav-icon"><i class="fas fa-database"></i></div>
                    <div class="nav-text">Backup & Export</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Manual Intervention</div>
                <div class="nav-item" data-section="manual">
                    <div class="nav-icon"><i class="fas fa-hands-helping"></i></div>
                    <div class="nav-text">Manual Adjustments</div>
                </div>
                <div class="nav-item" data-section="disputes">
                    <div class="nav-icon"><i class="fas fa-gavel"></i></div>
                    <div class="nav-text">Dispute Resolution</div>
                    <div class="nav-badge" id="disputeBadge">0</div>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item" data-action="logout">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="sudo-main">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1 class="section-title">System Overview</h1>
                    <div class="section-subtitle">Real-time monitoring of the entire TruCash platform</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-icon users"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="userGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Active Agents</div>
                                <div class="stat-value" id="activeAgents">0</div>
                            </div>
                            <div class="stat-icon agents"><i class="fas fa-id-badge"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="agentGrowth">0%</span> this week
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Transactions Today</div>
                                <div class="stat-value" id="todayTransactions">0</div>
                            </div>
                            <div class="stat-icon transactions"><i class="fas fa-exchange-alt"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="transactionGrowth">0%</span> vs yesterday
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Platform Revenue</div>
                                <div class="stat-value" id="platformRevenue">$0</div>
                            </div>
                            <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="revenueGrowth">0%</span> this month
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Health</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="refreshSystemHealth()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Database Connection</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Firebase Realtime Database</span>
                                    <span class="status-badge status-active" id="dbStatus">Connected</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Active Sessions</label>
                                <div class="d-flex align-center justify-between">
                                    <span>Current Active Users</span>
                                    <span class="font-semibold" id="activeSessions">0</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">System Load</label>
                                <div class="d-flex align-center justify-between">
                                    <span>API Response Time</span>
                                    <span class="font-semibold" id="apiResponseTime">0ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-8 mb-16">
                                <button class="btn btn-primary" onclick="openCreateAdminModal()">
                                    <i class="fas fa-user-plus"></i> Create Admin
                                </button>
                                <button class="btn btn-success" onclick="openCreateAgentModal()">
                                    <i class="fas fa-id-card"></i> Create Agent
                                </button>
                                <button class="btn btn-outline" onclick="openManualAdjustmentModal()">
                                    <i class="fas fa-edit"></i> Manual Adjustment
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-8">
                                <button class="btn btn-outline" onclick="openFeatureFlagModal()">
                                    <i class="fas fa-toggle-on"></i> Feature Flags
                                </button>
                                <button class="btn btn-outline" onclick="viewAuditLogs()">
                                    <i class="fas fa-history"></i> View Audit Logs
                                </button>
                                <button class="btn btn-outline" onclick="openBackupModal()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Real-time System Activity</div>
                    <canvas id="activityChart"></canvas>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admins" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Admin Accounts Management</h1>
                    <div class="section-subtitle">Create, edit, suspend, and delete admin accounts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateAdminModal()">
                            <i class="fas fa-user-plus"></i> Create New Admin
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 300px;" placeholder="Search admins..." id="adminSearch" onkeyup="searchAdmins()">
                        <button class="btn btn-outline" onclick="refreshAdminList()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="adminsTable">
                        <thead>
                            <tr>
                                <th>Admin ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Admin rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="adminPagination"></div>
            </section>

            <!-- Agent Management Section -->
            <section id="agents" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Agent Accounts Management</h1>
                    <div class="section-subtitle">Manage all agent accounts and their permissions</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <button class="btn btn-primary" onclick="openCreateAgentModal()">
                            <i class="fas fa-user-plus"></i> Create Agent
                        </button>
                        <button class="btn btn-outline" onclick="openBulkAgentActions()">
                            <i class="fas fa-users-cog"></i> Bulk Actions
                        </button>
                    </div>
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="agentStatusFilter" onchange="filterAgents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search agents..." id="agentSearch" onkeyup="searchAgents()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="agentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Clients</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <!-- Agent rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="agentPagination"></div>
            </section>

            <!-- Customer Management Section -->
            <section id="customers" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Customer Accounts Management</h1>
                    <div class="section-subtitle">Manage customer access controls and permissions</div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Transaction Limits</div>
                                    <div class="text-muted" style="font-size: 12px;">Configure customer transaction caps</div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="configureTransactionLimits()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Daily Limit</label>
                                <input type="number" class="form-control" id="dailyLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Single Transaction</label>
                                <input type="number" class="form-control" id="singleTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between mb-16">
                                <div>
                                    <div class="font-semibold">Account Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Set verification requirements</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoVerification" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Required Documents</label>
                                <select class="form-control" id="requiredDocs" multiple style="height: 120px;">
                                    <option value="nrc" selected>National ID (NRC)</option>
                                    <option value="passport" selected>Passport</option>
                                    <option value="drivers_license">Driver's License</option>
                                    <option value="proof_of_address">Proof of Address</option>
                                    <option value="employment_letter">Employment Letter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="customerStatusFilter" onchange="filterCustomers()">
                            <option value="all">All Status</option>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search customers..." id="customerSearch" onkeyup="searchCustomers()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Loan Limit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customer rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="customerPagination"></div>
            </section>

            <!-- Feature Flags Section -->
            <section id="features" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Feature Flags & Module Control</h1>
                    <div class="section-subtitle">Enable or disable features across the platform in real-time</div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Changes to feature flags are applied immediately across all interfaces without requiring redeployment.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Customer Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Applications</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow customers to apply for loans</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_applications" checked data-feature="loan_applications">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Online Repayments</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable online loan repayments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_online_repayments" checked data-feature="online_repayments">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Collateral Upload</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow collateral document upload</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_collateral_upload" checked data-feature="collateral_upload">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Client Verification</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow agents to verify clients</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_client_verification" checked data-feature="client_verification">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Loan Processing</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable loan processing by agents</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_loan_processing" checked data-feature="loan_processing">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Commission Tracking</div>
                                    <div class="text-muted" style="font-size: 12px;">Show commission calculations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_commission_tracking" checked data-feature="commission_tracking">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Features</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Maintenance Mode</div>
                                    <div class="text-muted" style="font-size: 12px;">Put system under maintenance</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_maintenance_mode" data-feature="maintenance_mode">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">New User Registration</div>
                                    <div class="text-muted" style="font-size: 12px;">Allow new user registrations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_new_registrations" checked data-feature="new_registrations">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Audit Logging</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable system audit logs</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="feature_audit_logging" checked data-feature="audit_logging">
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Feature Configuration Details</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Feature JSON Configuration</label>
                            <div class="code-editor">
                                <div class="code-header">
                                    <div class="code-language">JSON</div>
                                    <button class="btn btn-sm btn-outline" onclick="updateFeatureFlags()">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </div>
                                <div class="code-body">
                                    <pre id="featureJsonEditor">{
  "customer_features": {
    "loan_applications": true,
    "online_repayments": true,
    "collateral_upload": true
  },
  "agent_features": {
    "client_verification": true,
    "loan_processing": true,
    "commission_tracking": true
  },
  "system_features": {
    "maintenance_mode": false,
    "new_registrations": true,
    "audit_logging": true
  }
}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financial Settings Section -->
            <section id="financial" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Financial System Configuration</h1>
                    <div class="section-subtitle">Control all financial parameters and transaction rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Limits</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount</label>
                                <input type="number" class="form-control" id="minLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount</label>
                                <input type="number" class="form-control" id="maxLoanAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Daily Transaction Limit</label>
                                <input type="number" class="form-control" id="dailyTransactionLimit" placeholder="Enter amount">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Fees & Commissions</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Service Charge (%)</label>
                                <input type="number" class="form-control" id="serviceCharge" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Commission (%)</label>
                                <input type="number" class="form-control" id="agentCommission" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Late Payment Fee (%)</label>
                                <input type="number" class="form-control" id="latePaymentFee" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Approval Thresholds</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto-approval Limit</label>
                                <input type="number" class="form-control" id="autoApprovalLimit" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manual Review Threshold</label>
                                <input type="number" class="form-control" id="manualReviewThreshold" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Threshold (%)</label>
                                <input type="number" class="form-control" id="riskThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Currency & Formatting</div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Default Currency</label>
                                <select class="form-control" id="defaultCurrency">
                                    <option value="USD">USD ($)</option>
                                    <option value="ZMW">ZMW (K)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Decimal Places</label>
                                <select class="form-control" id="decimalPlaces">
                                    <option value="0">0 (e.g., 100)</option>
                                    <option value="2" selected>2 (e.g., 100.00)</option>
                                    <option value="3">3 (e.g., 100.000)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency Format</label>
                            <select class="form-control" id="currencyFormat">
                                <option value="symbol_before">Symbol before ($100)</option>
                                <option value="symbol_after">Symbol after (100$)</option>
                                <option value="code_before">Code before (USD 100)</option>
                                <option value="code_after">Code after (100 USD)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveFinancialSettings()">
                        <i class="fas fa-save"></i> Save All Financial Settings
                    </button>
                </div>
            </section>

            <!-- Repayment Plans Section -->
            <section id="repayment" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Repayment Plans & Penalty Systems</h1>
                    <div class="section-subtitle">Define repayment timelines, installment structures, and penalty rules</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div>
                        <button class="btn btn-primary" onclick="openCreateRepaymentPlanModal()">
                            <i class="fas fa-plus-circle"></i> Create New Plan
                        </button>
                    </div>
                </div>

                <div class="cards-grid mb-24">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Penalty Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Late Payment Penalty (%)</label>
                                <input type="number" class="form-control" id="latePenaltyRate" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grace Period (Days)</label>
                                <input type="number" class="form-control" id="gracePeriodDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" class="form-control" id="defaultInterestRate" placeholder="Enter percentage" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Escalation Rules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Days to Auto-Restriction</label>
                                <input type="number" class="form-control" id="autoRestrictionDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Escalation Threshold (%)</label>
                                <input type="number" class="form-control" id="escalationThreshold" placeholder="Enter percentage" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collection Agency Trigger</label>
                                <input type="number" class="form-control" id="collectionTriggerDays" placeholder="Enter days">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mb-16">
                    <div class="d-flex gap-8">
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search repayment plans..." id="repaymentPlanSearch" onkeyup="searchRepaymentPlans()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="repaymentPlansTable">
                        <thead>
                            <tr>
                                <th>Plan ID</th>
                                <th>Plan Name</th>
                                <th>Duration</th>
                                <th>Interest Rate</th>
                                <th>Installments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repaymentPlansBody">
                            <!-- Repayment plan rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="repaymentPagination"></div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Notification System Configuration</h1>
                    <div class="section-subtitle">Configure automated notifications and alerts</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Payment Reminders</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Payment Reminders</div>
                                    <div class="text-muted" style="font-size: 12px;">Send automatic payment reminders</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_payment_reminders" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Days Before Due Date</label>
                                <input type="number" class="form-control" id="reminderDaysBefore" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reminder Frequency</label>
                                <select class="form-control" id="reminderFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Overdue Alerts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Overdue Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Send alerts for overdue payments</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_overdue_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert After (Days)</label>
                                <input type="number" class="form-control" id="overdueAlertDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Alerts</label>
                                <input type="number" class="form-control" id="maxOverdueAlerts" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Security Notifications</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Login Alerts</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on new device login</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_login_alerts" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Account Changes</div>
                                    <div class="text-muted" style="font-size: 12px;">Notify on account modifications</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_account_changes" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Security Warnings</div>
                                    <div class="text-muted" style="font-size: 12px;">Send security warnings</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="notify_security_warnings" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Notification Templates</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Payment Reminder Template</label>
                            <textarea class="form-control form-textarea" id="paymentReminderTemplate" rows="4">Dear {customer_name}, your payment of {amount} is due on {due_date}. Please make payment to avoid penalties.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overdue Alert Template</label>
                            <textarea class="form-control form-textarea" id="overdueAlertTemplate" rows="4">URGENT: Your payment of {amount} is overdue by {days_overdue} days. Please make immediate payment to avoid account restrictions.</textarea>
                        </div>
                        <div class="text-right">
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Save Notification Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- UI Behavior Section -->
            <section id="ui-settings" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">UI Behavior & Layout Configuration</h1>
                    <div class="section-subtitle">Control dashboard layouts, visible modules, and interface behavior</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Dashboard Layouts</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Dashboard</label>
                                <select class="form-control" id="customerDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="compact">Compact Layout</option>
                                    <option value="detailed">Detailed Layout</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Dashboard</label>
                                <select class="form-control" id="agentDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="analytics">Analytics Focus</option>
                                    <option value="client_management">Client Management Focus</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Admin Dashboard</label>
                                <select class="form-control" id="adminDashboardLayout">
                                    <option value="standard">Standard Layout</option>
                                    <option value="monitoring">Monitoring Focus</option>
                                    <option value="approval">Approval Focus</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Visible Modules</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Customer Modules</label>
                                <select class="form-control" id="customerModules" multiple style="height: 150px;">
                                    <option value="loans" selected>Loans</option>
                                    <option value="repayments" selected>Repayments</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="collateral" selected>Collateral</option>
                                    <option value="profile" selected>Profile</option>
                                    <option value="notifications" selected>Notifications</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">UI Behavior</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Auto-refresh Data</div>
                                    <div class="text-muted" style="font-size: 12px;">Auto-refresh dashboard data</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_auto_refresh" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Show Tutorials</div>
                                    <div class="text-muted" style="font-size: 12px;">Show onboarding tutorials</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_show_tutorials" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Animations</div>
                                    <div class="text-muted" style="font-size: 12px;">Enable UI animations</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ui_animations" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveUISettings()">
                        <i class="fas fa-save"></i> Save UI Configuration
                    </button>
                </div>
            </section>

            <!-- Security Settings Section -->
            <section id="security" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Security System Configuration</h1>
                    <div class="section-subtitle">Configure security parameters and access controls</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Session Management</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Session Timeout (Minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Concurrent Sessions</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force Logout on Inactivity</label>
                                <select class="form-control" id="forceLogout">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Login Security</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Max Login Attempts</label>
                                <input type="number" class="form-control" id="maxLoginAttempts" placeholder="Enter number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account Lockout Duration (Minutes)</label>
                                <input type="number" class="form-control" id="lockoutDuration" placeholder="Enter minutes">
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP Lockout Threshold</label>
                                <input type="number" class="form-control" id="ipLockoutThreshold" placeholder="Enter number">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Password Policies</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Minimum Password Length</label>
                                <input type="number" class="form-control" id="minPasswordLength" placeholder="Enter length">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password Expiry (Days)</label>
                                <input type="number" class="form-control" id="passwordExpiryDays" placeholder="Enter days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password History</label>
                                <input type="number" class="form-control" id="passwordHistoryCount" placeholder="Enter number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Advanced Security</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">Two-Factor Authentication</div>
                                <div class="text-muted" style="font-size: 12px;">Require 2FA for admin access</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_2fa">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex align-center justify-between">
                            <div>
                                <div class="font-semibold">IP Whitelisting</div>
                                <div class="text-muted" style="font-size: 12px;">Restrict access to specific IPs</div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="security_ip_whitelist">
                                <label class="toggle-slider"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allowed IP Addresses (Comma-separated)</label>
                            <textarea class="form-control form-textarea" id="allowedIPs" rows="3" placeholder="192.168.1.1, 10.0.0.1"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-right mt-16">
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">
                        <i class="fas fa-save"></i> Save Security Settings
                    </button>
                </div>
            </section>

            <!-- Audit Logs Section -->
            <section id="audit" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Audit Logs</h1>
                    <div class="section-subtitle">Complete audit trail of all system activities</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="auditUserType" onchange="filterAuditLogs()">
                            <option value="all">All Users</option>
                            <option value="admin">Admins</option>
                            <option value="agent">Agents</option>
                            <option value="customer">Customers</option>
                            <option value="system">System</option>
                        </select>
                        <select class="form-control" style="width: 200px;" id="auditActionType" onchange="filterAuditLogs()">
                            <option value="all">All Actions</option>
                            <option value="login">Logins</option>
                            <option value="create">Creations</option>
                            <option value="update">Updates</option>
                            <option value="delete">Deletions</option>
                            <option value="financial">Financial</option>
                            <option value="security">Security</option>
                        </select>
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateFrom" onchange="filterAuditLogs()">
                        <input type="date" class="form-control" style="width: 150px;" id="auditDateTo" onchange="filterAuditLogs()">
                    </div>
                    <div class="d-flex gap-8">
                        <button class="btn btn-outline" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="auditLogsTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User Type</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Audit log rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="auditPagination"></div>
            </section>

            <!-- Backup & Export Section -->
            <section id="backup" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Backup & Data Export</h1>
                    <div class="section-subtitle">Manage data backups, exports, and archival rules</div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Backup Configuration</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Auto Backup Frequency</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Retention Period (Days)</label>
                                <input type="number" class="form-control" id="retentionPeriod" placeholder="Enter days">
                            </div>
                            <div class="form-group d-flex align-center justify-between">
                                <div>
                                    <div class="font-semibold">Enable Auto Backup</div>
                                    <div class="text-muted" style="font-size: 12px;">Automatic database backups</div>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="backup_auto_enable" checked>
                                    <label class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Manual Backup</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Data to Backup</label>
                                <select class="form-control" id="backupDataType" multiple style="height: 120px;">
                                    <option value="users" selected>User Data</option>
                                    <option value="transactions" selected>Transactions</option>
                                    <option value="loans" selected>Loans</option>
                                    <option value="audit_logs" selected>Audit Logs</option>
                                    <option value="system_settings">System Settings</option>
                                    <option value="financial_data">Financial Data</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup Format</label>
                                <select class="form-control" id="backupFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" onclick="createManualBackup()">
                                <i class="fas fa-database"></i> Create Backup Now
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Data Export</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Export Type</label>
                                <select class="form-control" id="exportType">
                                    <option value="all_data">All Data</option>
                                    <option value="user_data">User Data</option>
                                    <option value="transaction_data">Transaction Data</option>
                                    <option value="financial_reports">Financial Reports</option>
                                    <option value="audit_trail">Audit Trail</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <div class="form-row">
                                    <input type="date" class="form-control" id="exportDateFrom" placeholder="From">
                                    <input type="date" class="form-control" id="exportDateTo" placeholder="To">
                                </div>
                            </div>
                            <button class="btn btn-success w-100" onclick="exportData()">
                                <i class="fas fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-16">
                    <div class="card-header">
                        <div class="card-title">Backup History</div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Backup ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryBody">
                                <!-- Backup history will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Manual Intervention Section -->
            <section id="manual" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Manual System Intervention</h1>
                    <div class="section-subtitle">Direct intervention tools for account and transaction management</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Manual interventions are logged and require proper authorization. Use with extreme caution.
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Account Balance Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">User Type</label>
                                <select class="form-control" id="adjustmentUserType">
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User ID/Email</label>
                                <input type="text" class="form-control" id="adjustmentUserId" placeholder="Enter user ID or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="adjustmentType">
                                    <option value="add">Add Funds</option>
                                    <option value="deduct">Deduct Funds</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="adjustmentAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control form-textarea" id="adjustmentReason" rows="3" placeholder="Enter reason for adjustment"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processManualAdjustment()">
                                <i class="fas fa-check-circle"></i> Process Adjustment
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Transaction Reversal</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="reversalTransactionId" placeholder="Enter transaction ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reversal Type</label>
                                <select class="form-control" id="reversalType">
                                    <option value="full">Full Reversal</option>
                                    <option value="partial">Partial Reversal</option>
                                </select>
                            </div>
                            <div class="form-group" id="partialAmountGroup" style="display: none;">
                                <label class="form-label">Partial Amount</label>
                                <input type="number" class="form-control" id="partialReversalAmount" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Reversal</label>
                                <textarea class="form-control form-textarea" id="reversalReason" rows="3" placeholder="Enter reason for reversal"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Authorization Code</label>
                                <input type="password" class="form-control" id="reversalAuthCode" placeholder="Enter authorization code">
                            </div>
                            <button class="btn btn-danger w-100" onclick="processTransactionReversal()">
                                <i class="fas fa-undo"></i> Reverse Transaction
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Repayment Schedule Adjustment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Loan ID</label>
                                <input type="text" class="form-control" id="adjustmentLoanId" placeholder="Enter loan ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" id="repaymentAdjustmentType">
                                    <option value="extend">Extend Term</option>
                                    <option value="reduce">Reduce Term</option>
                                    <option value="reschedule">Reschedule</option>
                                    <option value="waive_penalty">Waive Penalty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Due Date</label>
                                <input type="date" class="form-control" id="newDueDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Installment Amount</label>
                                <input type="number" class="form-control" id="newInstallmentAmount" placeholder="Enter new amount">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Justification</label>
                                <textarea class="form-control form-textarea" id="repaymentAdjustmentJustification" rows="3" placeholder="Enter justification"></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="processRepaymentAdjustment()">
                                <i class="fas fa-calendar-edit"></i> Adjust Repayment
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">System Analytics</h1>
                    <div class="section-subtitle">Real-time analytics and performance metrics</div>
                </div>

                <div class="cards-grid">
                    <div class="chart-container">
                        <div class="chart-title">User Growth Trend</div>
                        <canvas id="userGrowthChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Transaction Volume</div>
                        <canvas id="transactionVolumeChart"></canvas>
                    </div>
                </div>

                <div class="cards-grid mt-16">
                    <div class="chart-container">
                        <div class="chart-title">Revenue Analysis</div>
                        <canvas id="revenueChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Agent Performance</div>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Dispute Resolution Section -->
            <section id="disputes" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Dispute Resolution Center</h1>
                    <div class="section-subtitle">Manage customer-agent disputes and conflicts</div>
                </div>

                <div class="d-flex justify-between align-center mb-24">
                    <div class="d-flex gap-8">
                        <select class="form-control" style="width: 200px;" id="disputeStatusFilter" onchange="filterDisputes()">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="escalated">Escalated</option>
                        </select>
                        <input type="text" class="form-control" style="width: 250px;" placeholder="Search disputes..." id="disputeSearch" onkeyup="searchDisputes()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="disputesTable">
                        <thead>
                            <tr>
                                <th>Dispute ID</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTableBody">
                            <!-- Dispute rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="disputePagination"></div>
            </section>
        </main>
    </div>

    <!-- Create Admin Modal -->
    <div class="modal" id="createAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Admin Account</h3>
                <button class="modal-close" onclick="closeModal('createAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="adminFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="adminConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Admin Role</label>
                    <select class="form-control" id="adminRole">
                        <option value="super_admin">Super Admin</option>
                        <option value="financial_admin">Financial Admin</option>
                        <option value="user_admin">User Admin</option>
                        <option value="support_admin">Support Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <select class="form-control" id="adminPermissions" multiple style="height: 150px;">
                        <option value="user_management">User Management</option>
                        <option value="financial_management">Financial Management</option>
                        <option value="agent_approval">Agent Approval</option>
                        <option value="dispute_resolution">Dispute Resolution</option>
                        <option value="system_settings">System Settings</option>
                        <option value="audit_logs">Audit Logs</option>
                        <option value="backup_export">Backup & Export</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAdminModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAdminAccount()">
                    <i class="fas fa-user-plus"></i> Create Admin Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent Account</h3>
                <button class="modal-close" onclick="closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="agentFullName" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="agentPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="agentEmail" placeholder="Enter email address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="agentPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="agentConfirmPassword" placeholder="Confirm password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent ID (Auto-generated)</label>
                    <input type="text" class="form-control" id="agentId" placeholder="Will be auto-generated" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" class="form-control" id="agentCommissionRate" placeholder="Enter commission rate" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Status</label>
                    <select class="form-control" id="agentInitialStatus">
                        <option value="active">Active</option>
                        <option value="pending">Pending Verification</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAgentAccount()">
                    <i class="fas fa-id-card"></i> Create Agent Account
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Adjustment Modal -->
    <div class="modal" id="manualAdjustmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manual System Adjustment</h3>
                <button class="modal-close" onclick="closeModal('manualAdjustmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Adjustment Type</label>
                    <select class="form-control" id="manualAdjustmentType">
                        <option value="balance">Balance Adjustment</option>
                        <option value="transaction">Transaction Reversal</option>
                        <option value="repayment">Repayment Schedule</option>
                        <option value="loan">Loan Modification</option>
                    </select>
                </div>
                <div id="manualAdjustmentContent">
                    <!-- Dynamic content based on type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('manualAdjustmentModal')">Cancel</button>
                <button class="btn btn-primary" id="processManualAdjustmentBtn">Process Adjustment</button>
            </div>
        </div>
    </div>

    <!-- Feature Flag Modal -->
    <div class="modal" id="featureFlagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Feature Flag Management</h3>
                <button class="modal-close" onclick="closeModal('featureFlagModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Toggle features on/off to control platform functionality
                </div>
                <div id="featureFlagContent">
                    <!-- Feature flags loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('featureFlagModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeatureFlagsFromModal()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backup & Data Export</h3>
                <button class="modal-close" onclick="closeModal('backupModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportDataByType('users')">
                        <div class="export-icon"><i class="fas fa-users"></i></div>
                        <div class="font-semibold">User Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all user information</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('transactions')">
                        <div class="export-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="font-semibold">Transactions</div>
                        <div class="text-muted" style="font-size: 12px;">Export transaction history</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('loans')">
                        <div class="export-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="font-semibold">Loan Data</div>
                        <div class="text-muted" style="font-size: 12px;">Export all loan records</div>
                    </div>
                    <div class="export-option" onclick="exportDataByType('audit')">
                        <div class="export-icon"><i class="fas fa-history"></i></div>
                        <div class="font-semibold">Audit Logs</div>
                        <div class="text-muted" style="font-size: 12px;">Export system audit trail</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('confirmationModal')">Cancel</button>
                <button class="btn" id="confirmationButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Admin Modal -->
    <div class="modal" id="viewAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Details</h3>
                <button class="modal-close" onclick="closeModal('viewAdminModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAdminContent">
                <!-- Admin details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Agent Modal -->
    <div class="modal" id="viewAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agent Details</h3>
                <button class="modal-close" onclick="closeModal('viewAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewAgentContent">
                <!-- Agent details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Customer Modal -->
    <div class="modal" id="viewCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('viewCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewCustomerContent">
                <!-- Customer details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- View Dispute Modal -->
    <div class="modal" id="viewDisputeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dispute Details</h3>
                <button class="modal-close" onclick="closeModal('viewDisputeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewDisputeContent">
                <!-- Dispute details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- JavaScript Implementation -->
    <script>
     // ===== SUDO ADMIN CONTROL PANEL - ENHANCED WITH COMPLETE SYSTEM CONTROL =====
// Enhanced features: Full agent/customer/admin management, deletion, suspension, banning, creation
// Currency: Zambian Kwacha (ZMW)
// Total lines: 3200+ (exceeds original)

// ===== FIREBASE CONFIGURATION =====
const firebaseConfig = {
    apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
    authDomain: "trucash-9fee8.firebaseapp.com",
    databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
    projectId: "trucash-9fee8",
    storageBucket: "trucash-9fee8.firebasestorage.app",
    messagingSenderId: "622416212225",
    appId: "1:622416212225:web:07418a9b16f955c330ab00",
    measurementId: "G-6TEZFNFDBK"
};

// ===== GLOBAL APPLICATION STATE =====
const AppState = {
    currentUser: null,
    isAuthenticated: false,
    userType: null,
    systemStats: {
        totalUsers: 0,
        activeAgents: 0,
        pendingLoans: 0,
        activeLoans: 0,
        totalRevenue: 0,
        activeSessions: 0,
        disputeCount: 0,
        systemHealth: 100,
        totalAdmins: 0,
        suspendedAccounts: 0,
        bannedAccounts: 0
    },
    loanApplications: [],
    agents: [],
    customers: [],
    admins: [],
    activeLoanListeners: [],
    agentPictures: {},
    customerPictures: {},
    adminPictures: {},
    currentSection: 'dashboard',
    pagination: {
        loans: { currentPage: 1, totalPages: 1, itemsPerPage: 10 },
        agents: { currentPage: 1, totalPages: 1, itemsPerPage: 12 },
        customers: { currentPage: 1, totalPages: 1, itemsPerPage: 12 },
        admins: { currentPage: 1, totalPages: 1, itemsPerPage: 12 }
    },
    filters: {
        loanStatus: 'all',
        loanType: 'all',
        userStatus: 'all',
        userType: 'all',
        dateRange: { from: null, to: null }
    }
};

// ===== ENHANCED UTILITY FUNCTIONS =====
const Utils = {
    showNotification(title, message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' :
                    'fa-info-circle'
                }"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        const container = document.getElementById('notificationContainer');
        if (!container) {
            const newContainer = document.createElement('div');
            newContainer.id = 'notificationContainer';
            newContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 999999;
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-width: 350px;
            `;
            document.body.appendChild(newContainer);
        }
        
        document.getElementById('notificationContainer').appendChild(notification);
        
        notification.style.cssText = `
            background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : type === 'warning' ? '#fff3cd' : '#d1ecf1'};
            border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : type === 'warning' ? '#ffeaa7' : '#bee5eb'};
            color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : type === 'warning' ? '#856404' : '#0c5460'};
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: slideInRight 0.3s ease;
            position: relative;
        `;
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
        
        return notification;
    },

    showLoading(message = 'Processing...') {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 999999;
                flex-direction: column;
                backdrop-filter: blur(5px);
            `;
            
            const spinner = document.createElement('div');
            spinner.style.cssText = `
                width: 50px;
                height: 50px;
                border: 5px solid #f3f3f3;
                border-top: 5px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            `;
            
            const text = document.createElement('div');
            text.id = 'loadingText';
            text.style.cssText = `
                color: white;
                font-size: 16px;
                font-weight: 500;
                margin-top: 10px;
            `;
            
            overlay.appendChild(spinner);
            overlay.appendChild(text);
            document.body.appendChild(overlay);
        }
        
        document.getElementById('loadingText').textContent = message;
        overlay.style.display = 'flex';
        
        if (!document.querySelector('#loadingAnimations')) {
            const style = document.createElement('style');
            style.id = 'loadingAnimations';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    },

    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },

    formatCurrency(amount, currency = 'ZMW') {
        if (isNaN(amount)) amount = 0;
        return new Intl.NumberFormat('en-ZM', {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 2
        }).format(amount);
    },

    formatDateTime(date) {
        if (!date) return 'Never';
        try {
            return new Date(date).toLocaleString('en-ZM', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            return 'Invalid Date';
        }
    },

    formatDate(date) {
        if (!date) return 'N/A';
        try {
            return new Date(date).toLocaleDateString('en-ZM', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return 'Invalid Date';
        }
    },

    generateId(prefix = '') {
        return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2, 9).toUpperCase();
    },

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    },

    validatePhone(phone) {
        const re = /^(\+260|0)?[967]\d{8}$/;
        return re.test(phone);
    },

    validateNRC(nrc) {
        const re = /^\d{6}\/\d{2}\/\d{1}$/;
        return re.test(nrc);
    },

    openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    },

    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 300);
        }
    },

    confirmAction(title, message, confirmCallback, cancelCallback = null, confirmText = 'Confirm', cancelText = 'Cancel', confirmColor = '#dc3545') {
        const modal = document.createElement('div');
        modal.id = 'confirmationDialog';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            backdrop-filter: blur(5px);
        `;

        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.3s ease;
        `;

        dialog.innerHTML = `
            <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">${title}</h3>
            <p style="margin: 0 0 25px 0; color: #666; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="confirmCancel" style="
                    padding: 10px 20px;
                    border: 1px solid #ddd;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    color: #666;
                ">${cancelText}</button>
                <button id="confirmOk" style="
                    padding: 10px 20px;
                    border: none;
                    background: ${confirmColor};
                    color: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                ">${confirmText}</button>
            </div>
        `;

        modal.appendChild(dialog);
        document.body.appendChild(modal);

        if (!document.querySelector('#fadeInAnimation')) {
            const style = document.createElement('style');
            style.id = 'fadeInAnimation';
            style.textContent = '@keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }';
            document.head.appendChild(style);
        }

        document.getElementById('confirmOk').addEventListener('click', () => {
            document.body.removeChild(modal);
            confirmCallback();
        });

        document.getElementById('confirmCancel').addEventListener('click', () => {
            document.body.removeChild(modal);
            if (cancelCallback) cancelCallback();
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                if (cancelCallback) cancelCallback();
            }
        });
    },

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
    },

    getTimeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        
        let interval = Math.floor(seconds / 31536000);
        if (interval >= 1) return interval + ' year' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 2592000);
        if (interval >= 1) return interval + ' month' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 86400);
        if (interval >= 1) return interval + ' day' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 3600);
        if (interval >= 1) return interval + ' hour' + (interval > 1 ? 's' : '') + ' ago';
        
        interval = Math.floor(seconds / 60);
        if (interval >= 1) return interval + ' minute' + (interval > 1 ? 's' : '') + ' ago';
        
        return 'just now';
    },

    getLoanStatusBadge(status) {
        const statusMap = {
            'pending': { class: 'pending', icon: 'fa-clock', color: '#ffc107' },
            'approved': { class: 'approved', icon: 'fa-check-circle', color: '#28a745' },
            'rejected': { class: 'rejected', icon: 'fa-times-circle', color: '#dc3545' },
            'active': { class: 'active', icon: 'fa-sync-alt', color: '#007bff' },
            'completed': { class: 'completed', icon: 'fa-check-double', color: '#17a2b8' },
            'defaulted': { class: 'defaulted', icon: 'fa-exclamation-triangle', color: '#fd7e14' },
            'disbursed': { class: 'disbursed', icon: 'fa-money-check-alt', color: '#20c997' },
            'overdue': { class: 'overdue', icon: 'fa-exclamation-circle', color: '#dc3545' }
        };
        
        const statusInfo = statusMap[status] || { class: 'pending', icon: 'fa-question-circle', color: '#6c757d' };
        
        return `<span class="status-badge" style="
            background: ${statusInfo.color}15;
            color: ${statusInfo.color};
            border: 1px solid ${statusInfo.color}30;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        ">
            <i class="fas ${statusInfo.icon}"></i>
            ${status.charAt(0).toUpperCase() + status.slice(1)}
        </span>`;
    },

    getUserStatusBadge(status) {
        const statusMap = {
            'active': { color: '#28a745', icon: 'fa-check-circle' },
            'suspended': { color: '#ffc107', icon: 'fa-pause-circle' },
            'banned': { color: '#dc3545', icon: 'fa-ban' },
            'pending': { color: '#6c757d', icon: 'fa-clock' },
            'inactive': { color: '#6c757d', icon: 'fa-moon' }
        };
        
        const statusInfo = statusMap[status] || { color: '#6c757d', icon: 'fa-question-circle' };
        
        return `<span class="status-badge" style="
            background: ${statusInfo.color}15;
            color: ${statusInfo.color};
            border: 1px solid ${statusInfo.color}30;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        ">
            <i class="fas ${statusInfo.icon}"></i>
            ${status.charAt(0).toUpperCase() + status.slice(1)}
        </span>`;
    },

    getRoleBadge(role) {
        const roleMap = {
            'sudo': { color: '#6f42c1', text: 'SUDO', icon: 'fa-user-shield' },
            'admin': { color: '#007bff', text: 'Admin', icon: 'fa-user-cog' },
            'agent': { color: '#20c997', text: 'Agent', icon: 'fa-user-tie' },
            'customer': { color: '#6c757d', text: 'Customer', icon: 'fa-user' },
            'supervisor': { color: '#fd7e14', text: 'Supervisor', icon: 'fa-user-check' }
        };
        
        const roleInfo = roleMap[role] || { color: '#6c757d', text: 'User', icon: 'fa-user' };
        
        return `<span class="role-badge" style="
            background: ${roleInfo.color}15;
            color: ${roleInfo.color};
            border: 1px solid ${roleInfo.color}30;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        ">
            <i class="fas ${roleInfo.icon}"></i>
            ${roleInfo.text}
        </span>`;
    },

    generatePassword(length = 12) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < length; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }
};

// ===== FIREBASE INITIALIZATION =====
let firebaseApp, auth, db, storage;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.database();
    storage = firebase.storage();
    console.log(" SUDO: Firebase initialized successfully");
} catch (error) {
    console.error(" SUDO: Firebase initialization error:", error);
    Utils.showNotification('Firebase Error', 'Failed to initialize Firebase. Please refresh.', 'error');
}

// ===== SUDO AUTHENTICATION SERVICE =====
const SudoAuthService = {
    async init() {
        try {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const isSudo = await this.verifySudoUser(user.uid);
                    if (isSudo) {
                        await this.handleSudoLogin(user);
                    } else {
                        await auth.signOut();
                        this.showLoginForm();
                    }
                } else {
                    this.showLoginForm();
                }
            });
        } catch (error) {
            console.error('SUDO: Auth initialization error:', error);
            this.showLoginForm();
        }
    },

    showLoginForm() {
        document.body.innerHTML = `
            <div class="sudo-login-container" style="
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
            ">
                <div class="login-card" style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    width: 100%;
                    max-width: 400px;
                    text-align: center;
                ">
                    <div class="logo" style="margin-bottom: 30px;">
                        <i class="fas fa-user-shield" style="
                            font-size: 48px;
                            color: #667eea;
                            margin-bottom: 15px;
                        "></i>
                        <h1 style="margin: 0; color: #333; font-size: 24px;">SUDO ADMIN</h1>
                        <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">Super User Direct Operations</p>
                    </div>
                    
                    <div id="loginError" style="
                        display: none;
                        background: #f8d7da;
                        color: #721c24;
                        padding: 12px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        font-size: 14px;
                    "></div>
                    
                    <form id="sudoLoginForm" style="text-align: left;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">Email</label>
                            <input type="email" id="sudoEmail" required style="
                                width: 100%;
                                padding: 12px 15px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                font-size: 16px;
                                transition: border-color 0.3s;
                                box-sizing: border-box;
                            " placeholder="sudo@admin.com">
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">Password</label>
                            <input type="password" id="sudoPassword" required style="
                                width: 100%;
                                padding: 12px 15px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                font-size: 16px;
                                transition: border-color 0.3s;
                                box-sizing: border-box;
                            " placeholder="">
                        </div>
                        
                        <button type="submit" style="
                            width: 100%;
                            padding: 15px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(102, 126, 234, 0.3)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <i class="fas fa-sign-in-alt"></i> Access SUDO Panel
                        </button>
                    </form>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <p style="color: #666; font-size: 12px; margin: 0;">
                            <i class="fas fa-shield-alt"></i> Restricted access. Unauthorized attempts will be logged.
                        </p>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('sudoLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.loginSudo();
        });
    },

    async loginSudo() {
        const email = document.getElementById('sudoEmail').value.trim();
        const password = document.getElementById('sudoPassword').value;

        if (!email || !password) {
            this.showError('Please enter both email and password');
            return;
        }

        Utils.showLoading('Authenticating as SUDO...');

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;

            const isSudo = await this.verifySudoUser(user.uid);
            
            if (isSudo) {
                await this.handleSudoLogin(user);
                Utils.showNotification('SUDO Access Granted', 'Welcome to SUDO Control Panel', 'success');
            } else {
                await auth.signOut();
                this.showError('Access denied. Not authorized as SUDO admin.');
            }
        } catch (error) {
            console.error('SUDO login error:', error);
            let errorMessage = 'Authentication failed';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'Account disabled';
                    break;
                case 'auth/user-not-found':
                    errorMessage = 'Account not found';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Incorrect password';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Too many attempts. Try again later';
                    break;
            }
            
            this.showError(errorMessage);
        } finally {
            Utils.hideLoading();
        }
    },

    async verifySudoUser(uid) {
        try {
            const sudoRef = db.ref('sudoAdmins/' + uid);
            const snapshot = await sudoRef.once('value');
            
            if (snapshot.exists()) {
                const sudoData = snapshot.val();
                return sudoData.isActive === true;
            }

            const userRef = db.ref('users/' + uid);
            const userSnapshot = await userRef.once('value');
            
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                return userData.userType === 'sudo' || userData.role === 'super_admin';
            }

            return false;
        } catch (error) {
            console.error('SUDO verification error:', error);
            return false;
        }
    },

    async handleSudoLogin(user) {
        AppState.currentUser = user;
        AppState.isAuthenticated = true;
        AppState.userType = 'sudo';

        await this.loadSudoUserData(user.uid);
        this.initSudoDashboard();
        FirebaseService.initRealTimeListeners();
        await this.loadInitialData();
    },

    async loadSudoUserData(uid) {
        try {
            const userRef = db.ref('users/' + uid);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                AppState.currentUser.data = userData;
                
                await userRef.update({
                    lastLogin: Date.now(),
                    lastLoginIP: await this.getClientIP()
                });

                await FirebaseService.logAudit({
                    action: 'SUDO_LOGIN',
                    details: 'SUDO admin logged into control panel',
                    performedBy: uid,
                    userType: 'sudo'
                });
            }
        } catch (error) {
            console.error('Error loading SUDO user data:', error);
        }
    },

    async getClientIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            return 'Unknown';
        }
    },

    showError(message) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    },

    initSudoDashboard() {
        document.body.innerHTML = `
            <div class="sudo-dashboard" style="
                min-height: 100vh;
                background: #f8f9fa;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            ">
                <!-- Top Navigation -->
                <div class="sudo-navbar" style="
                    background: white;
                    border-bottom: 1px solid #e9ecef;
                    padding: 15px 30px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    position: sticky;
                    top: 0;
                    z-index: 1000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                ">
                    <div class="nav-left" style="display: flex; align-items: center; gap: 20px;">
                        <div class="logo" style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user-shield" style="font-size: 24px; color: #667eea;"></i>
                            <h1 style="margin: 0; font-size: 20px; color: #333; font-weight: 600;">SUDO CONTROL</h1>
                        </div>
                        
                        <div class="nav-links" style="display: flex; gap: 5px;">
                            <button class="nav-link active" data-section="dashboard" style="
                                padding: 8px 16px;
                                border: none;
                                background: #667eea;
                                color: white;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-chart-line"></i> Dashboard
                            </button>
                            <button class="nav-link" data-section="loans" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-file-invoice-dollar"></i> Loans
                            </button>
                            <button class="nav-link" data-section="agents" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-user-tie"></i> Agents
                            </button>
                            <button class="nav-link" data-section="customers" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-users"></i> Customers
                            </button>
                            <button class="nav-link" data-section="admins" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-user-cog"></i> Admins
                            </button>
                            <button class="nav-link" data-section="system" style="
                                padding: 8px 16px;
                                border: 1px solid #dee2e6;
                                background: white;
                                color: #495057;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-cogs"></i> System
                            </button>
                        </div>
                    </div>
                    
                    <div class="nav-right" style="display: flex; align-items: center; gap: 15px;">
                        <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar" style="
                                width: 36px;
                                height: 36px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-weight: 600;
                            ">
                                ${AppState.currentUser.email ? AppState.currentUser.email.charAt(0).toUpperCase() : 'S'}
                            </div>
                            <div style="font-size: 14px; color: #495057;">
                                <div style="font-weight: 500;">SUDO Admin</div>
                                <div style="font-size: 12px; color: #6c757d;">${AppState.currentUser.email}</div>
                            </div>
                        </div>
                        
                        <button id="logoutBtn" style="
                            padding: 8px 16px;
                            border: 1px solid #dc3545;
                            background: white;
                            color: #dc3545;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                        onmouseout="this.style.background='white'; this.style.color='#dc3545';">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="sudo-content" style="padding: 30px; max-width: 1600px; margin: 0 auto;">
                    <!-- Dashboard Section -->
                    <div id="dashboard" class="content-section active" style="display: block;">
                        <div class="dashboard-header" style="margin-bottom: 30px;">
                            <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">System Overview</h2>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">Real-time monitoring and control panel</p>
                        </div>
                        
                        <!-- Enhanced Stats Cards -->
                        <div class="stats-grid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        ">
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Total Users</div>
                                        <div id="totalUsers" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #4dabf7;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Active Agents</div>
                                        <div id="activeAgents" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #40c057;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Pending Loans</div>
                                        <div id="pendingLoans" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #ff922b;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Total Revenue</div>
                                        <div id="totalRevenue" style="font-size: 24px; font-weight: 700; color: #333;">ZMW 0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #20c997;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Suspended Accounts</div>
                                        <div id="suspendedAccounts" style="font-size: 32px; font-weight: 700; color: #333;">0</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #ff922b;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-user-slash"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card" style="
                                background: white;
                                padding: 25px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                border: 1px solid #e9ecef;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">System Health</div>
                                        <div id="systemHealth" style="font-size: 32px; font-weight: 700; color: #333;">100%</div>
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: #51cf66;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                    ">
                                        <i class="fas fa-heartbeat"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Quick Actions -->
                        <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Quick Actions</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <button onclick="loadLoanApplications()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-sync-alt"></i> Refresh Loans
                                </button>
                                <button onclick="showCreateUserModal('agent')" style="
                                    padding: 10px 20px;
                                    background: #40c057;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-user-plus"></i> Create Agent
                                </button>
                                <button onclick="showCreateUserModal('customer')" style="
                                    padding: 10px 20px;
                                    background: #7950f2;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-user-plus"></i> Create Customer
                                </button>
                                <button onclick="showCreateUserModal('admin')" style="
                                    padding: 10px 20px;
                                    background: #fd7e14;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-user-cog"></i> Create Admin
                                </button>
                                <button onclick="showCreateLoanModal()" style="
                                    padding: 10px 20px;
                                    background: #20c997;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-file-invoice-dollar"></i> Create Loan
                                </button>
                                <button onclick="showSystemSettings()" style="
                                    padding: 10px 20px;
                                    background: #868e96;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-cog"></i> System Settings
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: white; padding: 25px; border-radius: 12px;">
                                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Recent Loan Applications</h3>
                                <div id="recentLoans" style="
                                    max-height: 400px;
                                    overflow-y: auto;
                                    border: 1px solid #e9ecef;
                                    border-radius: 8px;
                                ">
                                    <div style="padding: 40px; text-align: center; color: #6c757d;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                        <div>Loading recent loans...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 25px; border-radius: 12px;">
                                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Recent User Registrations</h3>
                                <div id="recentUsers" style="
                                    max-height: 400px;
                                    overflow-y: auto;
                                    border: 1px solid #e9ecef;
                                    border-radius: 8px;
                                ">
                                    <div style="padding: 40px; text-align: center; color: #6c757d;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                        <div>Loading recent users...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loans Section -->
                    <div id="loans" class="content-section" style="display: none;">
                        <div class="loans-header" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Loan Management</h2>
                                <p style="margin: 0; color: #6c757d; font-size: 14px;">Full control over all loan applications and management</p>
                            </div>
                            <button onclick="showCreateLoanModal()" style="
                                padding: 10px 20px;
                                background: #20c997;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-plus"></i> Create New Loan
                            </button>
                        </div>
                        
                        <!-- Enhanced Filters -->
                        <div style="
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        ">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Status Filter</label>
                                <select id="loanStatusFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="active">Active</option>
                                    <option value="disbursed">Disbursed</option>
                                    <option value="completed">Completed</option>
                                    <option value="defaulted">Defaulted</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Type</label>
                                <select id="loanTypeFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Types</option>
                                    <option value="personal">Personal</option>
                                    <option value="business">Business</option>
                                    <option value="education">Education</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="agriculture">Agriculture</option>
                                    <option value="vehicle">Vehicle</option>
                                    <option value="mortgage">Mortgage</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Date From</label>
                                <input type="date" id="loanDateFrom" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Date To</label>
                                <input type="date" id="loanDateTo" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Search</label>
                                <input type="text" id="loanSearch" placeholder="Search by ID, name, email..." style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div style="align-self: flex-end; display: flex; gap: 10px;">
                                <button onclick="filterLoans()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                                <button onclick="resetLoanFilters()" style="
                                    padding: 10px 20px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Enhanced Loans Table -->
                        <div style="background: white; border-radius: 12px; overflow: hidden;">
                            <div id="loansTableContainer" style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; min-width: 1200px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Loan ID</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Customer</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Amount</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Status</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Type</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Applied</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Agent</th>
                                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loansTableBody">
                                        <tr>
                                            <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                                <div>Loading loan applications...</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="loansPagination" style="
                            margin-top: 20px;
                            display: flex;
                            justify-content: center;
                            gap: 5px;
                        ">
                        </div>
                    </div>
                    
                    <!-- Agents Section -->
                    <div id="agents" class="content-section" style="display: none;">
                        <div class="agents-header" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Agents Management</h2>
                                <p style="margin: 0; color: #6c757d; font-size: 14px;">Create, manage, and control all agents</p>
                            </div>
                            <button onclick="showCreateUserModal('agent')" style="
                                padding: 10px 20px;
                                background: #40c057;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-user-plus"></i> Create Agent
                            </button>
                        </div>
                        
                        <!-- Agents Filters -->
                        <div style="
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        ">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Status Filter</label>
                                <select id="agentStatusFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Search</label>
                                <input type="text" id="agentSearch" placeholder="Search by name, email, ID..." style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div style="align-self: flex-end; display: flex; gap: 10px;">
                                <button onclick="filterAgents()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                                <button onclick="resetAgentFilters()" style="
                                    padding: 10px 20px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Agents Grid -->
                        <div id="agentsGrid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                            gap: 20px;
                        ">
                            <!-- Agents will be loaded here -->
                            <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>Loading agents...</div>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="agentsPagination" style="
                            margin-top: 20px;
                            display: flex;
                            justify-content: center;
                            gap: 5px;
                        ">
                        </div>
                    </div>
                    
                    <!-- Customers Section -->
                    <div id="customers" class="content-section" style="display: none;">
                        <div class="customers-header" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Customers Management</h2>
                                <p style="margin: 0; color: #6c757d; font-size: 14px;">Create, manage, and control all customers</p>
                            </div>
                            <button onclick="showCreateUserModal('customer')" style="
                                padding: 10px 20px;
                                background: #7950f2;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-user-plus"></i> Create Customer
                            </button>
                        </div>
                        
                        <!-- Customers Filters -->
                        <div style="
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        ">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Status Filter</label>
                                <select id="customerStatusFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Search</label>
                                <input type="text" id="customerSearch" placeholder="Search by name, email, NRC..." style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div style="align-self: flex-end; display: flex; gap: 10px;">
                                <button onclick="filterCustomers()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                                <button onclick="resetCustomerFilters()" style="
                                    padding: 10px 20px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Customers Grid -->
                        <div id="customersGrid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                            gap: 20px;
                        ">
                            <!-- Customers will be loaded here -->
                            <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>Loading customers...</div>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="customersPagination" style="
                            margin-top: 20px;
                            display: flex;
                            justify-content: center;
                            gap: 5px;
                        ">
                        </div>
                    </div>
                    
                    <!-- Admins Section -->
                    <div id="admins" class="content-section" style="display: none;">
                        <div class="admins-header" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Admins Management</h2>
                                <p style="margin: 0; color: #6c757d; font-size: 14px;">Create and manage admin users</p>
                            </div>
                            <button onclick="showCreateUserModal('admin')" style="
                                padding: 10px 20px;
                                background: #fd7e14;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-user-plus"></i> Create Admin
                            </button>
                        </div>
                        
                        <!-- Admins Filters -->
                        <div style="
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        ">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Role Filter</label>
                                <select id="adminRoleFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="sudo">SUDO</option>
                                    <option value="supervisor">Supervisor</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Status Filter</label>
                                <select id="adminStatusFilter" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Search</label>
                                <input type="text" id="adminSearch" placeholder="Search by name, email..." style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ced4da;
                                    border-radius: 6px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <div style="align-self: flex-end; display: flex; gap: 10px;">
                                <button onclick="filterAdmins()" style="
                                    padding: 10px 20px;
                                    background: #4dabf7;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                                <button onclick="resetAdminFilters()" style="
                                    padding: 10px 20px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    height: 40px;
                                ">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Admins Grid -->
                        <div id="adminsGrid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                            gap: 20px;
                        ">
                            <!-- Admins will be loaded here -->
                            <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>Loading admins...</div>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="adminsPagination" style="
                            margin-top: 20px;
                            display: flex;
                            justify-content: center;
                            gap: 5px;
                        ">
                        </div>
                    </div>
                    
                    <!-- System Section -->
                    <div id="system" class="content-section" style="display: none;">
                        <div class="system-header" style="margin-bottom: 30px;">
                            <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">System Configuration</h2>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">Configure system settings and parameters</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <!-- System Settings -->
                            <div style="background: white; padding: 25px; border-radius: 12px;">
                                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Loan Settings</h3>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Default Interest Rate (%)</label>
                                        <input type="number" id="defaultInterestRate" value="15" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Maximum Loan Amount (ZMW)</label>
                                        <input type="number" id="maxLoanAmount" value="50000" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Minimum Loan Amount (ZMW)</label>
                                        <input type="number" id="minLoanAmount" value="1000" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Default Loan Duration (months)</label>
                                        <input type="number" id="defaultLoanDuration" value="12" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <button onclick="saveLoanSettings()" style="
                                        padding: 12px 20px;
                                        background: #20c997;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 8px;
                                        margin-top: 10px;
                                    ">
                                        <i class="fas fa-save"></i> Save Loan Settings
                                    </button>
                                </div>
                            </div>
                            
                            <!-- User Management Settings -->
                            <div style="background: white; padding: 25px; border-radius: 12px;">
                                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">User Settings</h3>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Default Customer Loan Limit (ZMW)</label>
                                        <input type="number" id="defaultCustomerLimit" value="10000" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Agent Commission Rate (%)</label>
                                        <input type="number" id="agentCommissionRate" value="5" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Auto-suspend inactive days</label>
                                        <input type="number" id="autoSuspendDays" value="90" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Maximum Login Attempts</label>
                                        <input type="number" id="maxLoginAttempts" value="5" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid #ced4da;
                                            border-radius: 6px;
                                            font-size: 14px;
                                        ">
                                    </div>
                                    
                                    <button onclick="saveUserSettings()" style="
                                        padding: 12px 20px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 8px;
                                        margin-top: 10px;
                                    ">
                                        <i class="fas fa-save"></i> Save User Settings
                                    </button>
                                </div>
                            </div>
                            
                            <!-- System Actions -->
                            <div style="background: white; padding: 25px; border-radius: 12px; grid-column: 1 / -1;">
                                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">System Actions</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    <button onclick="clearSystemCache()" style="
                                        padding: 12px 20px;
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <i class="fas fa-broom"></i> Clear Cache
                                    </button>
                                    
                                    <button onclick="backupDatabase()" style="
                                        padding: 12px 20px;
                                        background: #20c997;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <i class="fas fa-database"></i> Backup Database
                                    </button>
                                    
                                    <button onclick="exportAllData()" style="
                                        padding: 12px 20px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <i class="fas fa-file-export"></i> Export All Data
                                    </button>
                                    
                                    <button onclick="runSystemDiagnostics()" style="
                                        padding: 12px 20px;
                                        background: #fd7e14;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <i class="fas fa-stethoscope"></i> Run Diagnostics
                                    </button>
                                    
                                    <button onclick="purgeOldData()" style="
                                        padding: 12px 20px;
                                        background: #dc3545;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <i class="fas fa-trash"></i> Purge Old Data
                                    </button>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                                    <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">System Information</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Database Size</div>
                                            <div id="dbSize" style="font-weight: 600; color: #333;">Calculating...</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Storage Usage</div>
                                            <div id="storageUsage" style="font-weight: 600; color: #333;">Calculating...</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Uptime</div>
                                            <div id="systemUptime" style="font-weight: 600; color: #333;">--</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Last Backup</div>
                                            <div id="lastBackup" style="font-weight: 600; color: #333;">Never</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals -->
                <div id="loanDetailsModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="loanDetailsContent">
                                <!-- Loan details will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('loanDetailsModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="userDetailsModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="userDetailsContent">
                                <!-- User details will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('userDetailsModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="createUserModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 600px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="createUserContent">
                                <!-- Create user form will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('createUserModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="createLoanModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 700px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="createLoanContent">
                                <!-- Create loan form will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('createLoanModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="editLoanModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 700px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="editLoanContent">
                                <!-- Edit loan form will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('editLoanModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="imageModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    justify-content: center;
                    align-items: center;
                    z-index: 1002;
                ">
                    <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                        <img id="modalImage" src="" alt="Full size" style="
                            max-width: 100%;
                            max-height: 90vh;
                            border-radius: 8px;
                        ">
                        <button onclick="Utils.closeModal('imageModal')" style="
                            position: absolute;
                            top: -40px;
                            right: 0;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: rgba(255,255,255,0.2);
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="uploadImageModal" class="modal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 500px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div style="padding: 30px;">
                            <div id="uploadImageContent">
                                <!-- Upload image form will be loaded here -->
                            </div>
                        </div>
                        <button onclick="Utils.closeModal('uploadImageModal')" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border: none;
                            background: #f8f9fa;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            color: #495057;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        this.setupDashboardEvents();
    },

    setupDashboardEvents() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                const section = link.dataset.section;
                this.showSection(section);
                
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.style.background = 'white';
                    l.style.color = '#495057';
                    l.style.border = '1px solid #dee2e6';
                });
                
                link.style.background = '#667eea';
                link.style.color = 'white';
                link.style.border = 'none';
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            Utils.confirmAction(
                'Logout Confirmation',
                'Are you sure you want to logout from SUDO control panel?',
                async () => {
                    await FirebaseService.logout();
                    await auth.signOut();
                    this.showLoginForm();
                }
            );
        });

        const loanSearch = document.getElementById('loanSearch');
        if (loanSearch) {
            loanSearch.addEventListener('input', Utils.debounce(() => {
                filterLoans();
            }, 300));
        }

        const loanStatusFilter = document.getElementById('loanStatusFilter');
        if (loanStatusFilter) {
            loanStatusFilter.addEventListener('change', () => {
                filterLoans();
            });
        }

        this.initModals();
    },

    initModals() {
        const modals = ['loanDetailsModal', 'userDetailsModal', 'createUserModal', 'createLoanModal', 'editLoanModal', 'imageModal', 'uploadImageModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        Utils.closeModal(modalId);
                    }
                });
            }
        });
    },

    showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });

        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'block';
            AppState.currentSection = sectionId;

            switch(sectionId) {
                case 'dashboard':
                    FirebaseService.loadSystemStats();
                    loadRecentLoans();
                    loadRecentUsers();
                    break;
                case 'loans':
                    loadLoanApplications();
                    break;
                case 'agents':
                    loadAgents();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'admins':
                    loadAdmins();
                    break;
                case 'system':
                    loadSystemInfo();
                    break;
            }
        }
    },

    async loadInitialData() {
        Utils.showLoading('Loading SUDO dashboard...');
        
        try {
            await FirebaseService.loadSystemStats();
            await loadRecentLoans();
            await loadRecentUsers();
            this.updateDashboardUI();
            
            setTimeout(() => {
                Utils.showNotification('SUDO Dashboard Ready', 'Full system control initialized', 'success');
            }, 1000);
            
        } catch (error) {
            console.error('Error loading initial data:', error);
            Utils.showNotification('Error', 'Failed to load dashboard data', 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    updateDashboardUI() {
        const stats = AppState.systemStats;
        
        const totalUsersEl = document.getElementById('totalUsers');
        if (totalUsersEl) totalUsersEl.textContent = stats.totalUsers.toLocaleString();
        
        const activeAgentsEl = document.getElementById('activeAgents');
        if (activeAgentsEl) activeAgentsEl.textContent = stats.activeAgents.toLocaleString();
        
        const pendingLoansEl = document.getElementById('pendingLoans');
        if (pendingLoansEl) pendingLoansEl.textContent = stats.pendingLoans.toLocaleString();
        
        const totalRevenueEl = document.getElementById('totalRevenue');
        if (totalRevenueEl) totalRevenueEl.textContent = Utils.formatCurrency(stats.totalRevenue);
        
        const suspendedAccountsEl = document.getElementById('suspendedAccounts');
        if (suspendedAccountsEl) suspendedAccountsEl.textContent = stats.suspendedAccounts.toLocaleString();
        
        const systemHealthEl = document.getElementById('systemHealth');
        if (systemHealthEl) systemHealthEl.textContent = stats.systemHealth + '%';
    }
};

// ===== ENHANCED FIREBASE SERVICE =====
const FirebaseService = {
    async loadSystemStats() {
        try {
            const usersRef = db.ref('users');
            const usersSnapshot = await usersRef.once('value');
            const users = usersSnapshot.val() || {};
            AppState.systemStats.totalUsers = Object.keys(users).length;

            const agentsRef = db.ref('agents');
            const agentsSnapshot = await agentsRef.once('value');
            const agents = agentsSnapshot.val() || {};
            AppState.systemStats.activeAgents = Object.values(agents).filter(a => a.status === 'active').length;
            AppState.systemStats.suspendedAccounts = Object.values(agents).filter(a => a.status === 'suspended').length;

            const loansRef = db.ref('loans');
            const loansSnapshot = await loansRef.once('value');
            const loans = loansSnapshot.val() || {};
            AppState.systemStats.pendingLoans = Object.values(loans).filter(l => l.status === 'pending').length;
            
            let totalRevenue = 0;
            Object.values(loans).forEach(loan => {
                if (loan.status === 'completed' || loan.status === 'active') {
                    totalRevenue += (loan.interestEarned || 0) + (loan.fees || 0);
                }
            });
            AppState.systemStats.totalRevenue = totalRevenue;

            if (document.getElementById('totalUsers')) {
                document.getElementById('totalUsers').textContent = AppState.systemStats.totalUsers.toLocaleString();
                document.getElementById('activeAgents').textContent = AppState.systemStats.activeAgents.toLocaleString();
                document.getElementById('pendingLoans').textContent = AppState.systemStats.pendingLoans.toLocaleString();
                document.getElementById('totalRevenue').textContent = Utils.formatCurrency(AppState.systemStats.totalRevenue);
                document.getElementById('suspendedAccounts').textContent = AppState.systemStats.suspendedAccounts.toLocaleString();
            }

        } catch (error) {
            console.error('Error loading system stats:', error);
        }
    },

    async loadLoanApplications(page = 1, filters = {}) {
        try {
            Utils.showLoading('Loading loan applications...');
            
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            let loansArray = Object.entries(loans)
                .map(([id, loan]) => ({ id, ...loan }))
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            if (filters.status && filters.status !== 'all') {
                loansArray = loansArray.filter(loan => loan.status === filters.status);
            }
            
            if (filters.loanType && filters.loanType !== 'all') {
                loansArray = loansArray.filter(loan => loan.loanType === filters.loanType);
            }
            
            if (filters.dateFrom) {
                const fromDate = new Date(filters.dateFrom).getTime();
                loansArray = loansArray.filter(loan => (loan.createdAt || 0) >= fromDate);
            }
            
            if (filters.dateTo) {
                const toDate = new Date(filters.dateTo).getTime() + 86400000;
                loansArray = loansArray.filter(loan => (loan.createdAt || 0) <= toDate);
            }
            
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                loansArray = loansArray.filter(loan => 
                    (loan.id && loan.id.toLowerCase().includes(searchTerm)) ||
                    (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                    (loan.customerEmail && loan.customerEmail.toLowerCase().includes(searchTerm)) ||
                    (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm)) ||
                    (loan.loanId && loan.loanId.toLowerCase().includes(searchTerm))
                );
            }
            
            AppState.loanApplications = loansArray;
            
            const itemsPerPage = AppState.pagination.loans.itemsPerPage;
            const totalPages = Math.ceil(loansArray.length / itemsPerPage);
            AppState.pagination.loans.totalPages = totalPages;
            AppState.pagination.loans.currentPage = page;
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedLoans = loansArray.slice(startIndex, endIndex);
            
            const tableBody = document.getElementById('loansTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                if (paginatedLoans.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">
                                <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>No loan applications found</div>
                            </td>
                        </tr>
                    `;
                } else {
                    paginatedLoans.forEach(loan => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e9ecef';
                        row.style.transition = 'background 0.2s';
                        row.onmouseover = () => row.style.background = '#f8f9fa';
                        row.onmouseout = () => row.style.background = 'white';
                        
                        row.innerHTML = `
                            <td style="padding: 15px; font-weight: 500; color: #495057;">
                                <code>${loan.id ? loan.id.substring(0, 10) : 'N/A'}</code>
                            </td>
                            <td style="padding: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="
                                        width: 36px;
                                        height: 36px;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 14px;
                                    ">
                                        ${loan.customerName ? loan.customerName.charAt(0).toUpperCase() : 'C'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: #333;">${loan.customerName || 'N/A'}</div>
                                        <div style="font-size: 12px; color: #6c757d;">${loan.customerEmail || 'N/A'}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 15px; font-weight: 600; color: #333;">
                                ${Utils.formatCurrency(loan.amount || 0)}
                            </td>
                            <td style="padding: 15px;">
                                ${Utils.getLoanStatusBadge(loan.status || 'pending')}
                            </td>
                            <td style="padding: 15px; color: #495057; font-size: 14px;">
                                ${loan.loanType || 'Personal'}
                            </td>
                            <td style="padding: 15px; color: #6c757d; font-size: 14px;">
                                ${Utils.getTimeAgo(loan.createdAt || Date.now())}
                            </td>
                            <td style="padding: 15px; color: #6c757d; font-size: 14px;">
                                ${loan.agentName || 'Unassigned'}
                            </td>
                            <td style="padding: 15px;">
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="viewLoanDetails('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="showEditLoanModal('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #20c997;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    ${loan.status === 'pending' ? `
                                    <button onclick="approveLoan('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #40c057;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button onclick="rejectLoan('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #fa5252;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-times"></i> Deny
                                    </button>
                                    ` : ''}
                                    <button onclick="deleteLoan('${loan.id}')" style="
                                        padding: 6px 12px;
                                        background: #dc3545;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            }
            
            this.updatePagination('loans', totalPages, page);
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading loan applications:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load loan applications', 'error');
        }
    },

    async loadRecentLoans() {
        try {
            const loansRef = db.ref('loans');
            const snapshot = await loansRef.once('value');
            const loans = snapshot.val() || {};
            
            const loansArray = Object.entries(loans)
                .map(([id, loan]) => ({ id, ...loan }))
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 10);
            
            const container = document.getElementById('recentLoans');
            if (container) {
                container.innerHTML = '';
                
                if (loansArray.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No recent loan applications</div>
                        </div>
                    `;
                } else {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    
                    loansArray.forEach(loan => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e9ecef';
                        row.style.cursor = 'pointer';
                        row.onclick = () => viewLoanDetails(loan.id);
                        row.onmouseover = () => row.style.background = '#f8f9fa';
                        row.onmouseout = () => row.style.background = 'white';
                        
                        row.innerHTML = `
                            <td style="padding: 12px;">
                                <div style="font-weight: 500; color: #333;">${loan.customerName || 'Unknown'}</div>
                                <div style="font-size: 12px; color: #6c757d;">${loan.id ? loan.id.substring(0, 8) : 'N/A'}</div>
                            </td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #333;">
                                ${Utils.formatCurrency(loan.amount || 0)}
                            </td>
                            <td style="padding: 12px; text-align: right;">
                                ${Utils.getLoanStatusBadge(loan.status || 'pending')}
                            </td>
                        `;
                        table.appendChild(row);
                    });
                    
                    container.appendChild(table);
                }
            }
            
        } catch (error) {
            console.error('Error loading recent loans:', error);
        }
    },

    async loadRecentUsers() {
        try {
            const usersRef = db.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val() || {};
            
            const usersArray = Object.entries(users)
                .map(([id, user]) => ({ id, ...user }))
                .filter(user => user.userType !== 'sudo')
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 10);
            
            const container = document.getElementById('recentUsers');
            if (container) {
                container.innerHTML = '';
                
                if (usersArray.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No recent user registrations</div>
                        </div>
                    `;
                } else {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    
                    usersArray.forEach(user => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e9ecef';
                        row.style.cursor = 'pointer';
                        row.onclick = () => viewUserDetails(user.id, user.userType || 'customer');
                        row.onmouseover = () => row.style.background = '#f8f9fa';
                        row.onmouseout = () => row.style.background = 'white';
                        
                        row.innerHTML = `
                            <td style="padding: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="
                                        width: 32px;
                                        height: 32px;
                                        background: linear-gradient(135deg, ${user.userType === 'agent' ? '#40c057' : user.userType === 'admin' ? '#fd7e14' : '#7950f2'} 0%, ${user.userType === 'agent' ? '#82c91e' : user.userType === 'admin' ? '#fa5252' : '#4c6ef5'} 100%);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 12px;
                                    ">
                                        ${user.fullName ? user.fullName.charAt(0).toUpperCase() : user.userType ? user.userType.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: #333;">${user.fullName || 'Unknown User'}</div>
                                        <div style="font-size: 12px; color: #6c757d;">${Utils.getRoleBadge(user.userType || 'customer')}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 12px; text-align: right; font-size: 12px; color: #6c757d;">
                                ${Utils.getTimeAgo(user.createdAt || Date.now())}
                            </td>
                        `;
                        table.appendChild(row);
                    });
                    
                    container.appendChild(table);
                }
            }
            
        } catch (error) {
            console.error('Error loading recent users:', error);
        }
    },

    async loadAgents(page = 1, filters = {}) {
        try {
            Utils.showLoading('Loading agents...');
            
            const agentsRef = db.ref('agents');
            const snapshot = await agentsRef.once('value');
            const agents = snapshot.val() || {};
            
            let agentsArray = Object.entries(agents)
                .map(([id, agent]) => ({ id, ...agent }))
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            if (filters.status && filters.status !== 'all') {
                agentsArray = agentsArray.filter(agent => agent.status === filters.status);
            }
            
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                agentsArray = agentsArray.filter(agent => 
                    (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm)) ||
                    (agent.email && agent.email.toLowerCase().includes(searchTerm)) ||
                    (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm)) ||
                    (agent.phone && agent.phone.includes(searchTerm)) ||
                    (agent.nrc && agent.nrc.toLowerCase().includes(searchTerm))
                );
            }
            
            AppState.agents = agentsArray;
            
            const itemsPerPage = AppState.pagination.agents.itemsPerPage;
            const totalPages = Math.ceil(agentsArray.length / itemsPerPage);
            AppState.pagination.agents.totalPages = totalPages;
            AppState.pagination.agents.currentPage = page;
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAgents = agentsArray.slice(startIndex, endIndex);
            
            AppState.agentPictures = {};
            
            const container = document.getElementById('agentsGrid');
            if (container) {
                container.innerHTML = '';
                
                if (paginatedAgents.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-user-tie" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No agents found</div>
                        </div>
                    `;
                } else {
                    paginatedAgents.forEach(agent => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            border: 1px solid #e9ecef;
                            transition: transform 0.2s, box-shadow 0.2s;
                        `;
                        card.onmouseover = () => {
                            card.style.transform = 'translateY(-4px)';
                            card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
                        };
                        card.onmouseout = () => {
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
                        };
                        
                        const profilePic = agent.profilePhoto || agent.photoUrl || '';
                        
                        card.innerHTML = `
                            <div style="position: relative;">
                                <div style="
                                    height: 120px;
                                    background: linear-gradient(135deg, #40c057 0%, #82c91e 100%);
                                    position: relative;
                                ">
                                    ${profilePic ? `
                                    <img src="${profilePic}" alt="${agent.fullName || 'Agent'}" style="
                                        width: 80px;
                                        height: 80px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -40px;
                                        left: 20px;
                                        object-fit: cover;
                                        cursor: pointer;
                                    " onclick="viewImage('${profilePic}', '${agent.fullName || 'Agent'}')">
                                    ` : `
                                    <div style="
                                        width: 80px;
                                        height: 80px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -40px;
                                        left: 20px;
                                        background: rgba(255,255,255,0.2);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 24px;
                                        font-weight: 600;
                                    ">
                                        ${agent.fullName ? agent.fullName.charAt(0).toUpperCase() : 'A'}
                                    </div>
                                    `}
                                </div>
                                <div style="padding: 60px 20px 20px 20px;">
                                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 18px;">
                                        ${agent.fullName || 'Unknown Agent'}
                                    </h3>
                                    <div style="color: #6c757d; font-size: 14px; margin-bottom: 5px;">
                                        ${agent.email || 'N/A'}
                                    </div>
                                    <div style="color: #6c757d; font-size: 12px; margin-bottom: 15px;">
                                        ${agent.agentId || 'ID: N/A'}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            ${Utils.getUserStatusBadge(agent.status || 'active')}
                                        </div>
                                        <div style="font-size: 12px; color: #6c757d;">
                                            ${agent.totalClients || 0} clients
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <div style="
                                            background: #e7f5ff;
                                            color: #1864ab;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 12px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-money-bill-wave"></i> ${Utils.formatCurrency(agent.commissionEarned || 0)}
                                        </div>
                                        <div style="
                                            background: #fff3bf;
                                            color: #e67700;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 12px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-chart-line"></i> ${agent.performance?.successRate || 0}%
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; display: flex; gap: 8px;">
                                    <button onclick="viewUserDetails('${agent.id}', 'agent')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="showEditUserModal('${agent.id}', 'agent')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #20c997;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="showUserActionsMenu('${agent.id}', 'agent')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-cog"></i> Actions
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                        
                        if (profilePic) {
                            AppState.agentPictures[agent.id] = profilePic;
                        }
                    });
                }
            }
            
            this.updatePagination('agents', totalPages, page);
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading agents:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load agents', 'error');
        }
    },

    async loadCustomers(page = 1, filters = {}) {
        try {
            Utils.showLoading('Loading customers...');
            
            const usersRef = db.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val() || {};
            
            let customersArray = Object.entries(users)
                .map(([id, user]) => ({ id, ...user }))
                .filter(user => user.userType === 'customer')
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            if (filters.status && filters.status !== 'all') {
                customersArray = customersArray.filter(customer => customer.status === filters.status);
            }
            
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                customersArray = customersArray.filter(customer => 
                    (customer.fullName && customer.fullName.toLowerCase().includes(searchTerm)) ||
                    (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                    (customer.phone && customer.phone.includes(searchTerm)) ||
                    (customer.nrc && customer.nrc.toLowerCase().includes(searchTerm))
                );
            }
            
            AppState.customers = customersArray;
            
            const itemsPerPage = AppState.pagination.customers.itemsPerPage;
            const totalPages = Math.ceil(customersArray.length / itemsPerPage);
            AppState.pagination.customers.totalPages = totalPages;
            AppState.pagination.customers.currentPage = page;
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCustomers = customersArray.slice(startIndex, endIndex);
            
            AppState.customerPictures = {};
            
            const container = document.getElementById('customersGrid');
            if (container) {
                container.innerHTML = '';
                
                if (paginatedCustomers.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No customers found</div>
                        </div>
                    `;
                } else {
                    paginatedCustomers.forEach(customer => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            border: 1px solid #e9ecef;
                            transition: transform 0.2s, box-shadow 0.2s;
                        `;
                        card.onmouseover = () => {
                            card.style.transform = 'translateY(-4px)';
                            card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
                        };
                        card.onmouseout = () => {
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
                        };
                        
                        const profilePic = customer.profilePhoto || customer.photoUrl || '';
                        
                        card.innerHTML = `
                            <div style="position: relative;">
                                <div style="
                                    height: 100px;
                                    background: linear-gradient(135deg, #7950f2 0%, #4c6ef5 100%);
                                    position: relative;
                                ">
                                    ${profilePic ? `
                                    <img src="${profilePic}" alt="${customer.fullName || 'Customer'}" style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -35px;
                                        left: 20px;
                                        object-fit: cover;
                                        cursor: pointer;
                                    " onclick="viewImage('${profilePic}', '${customer.fullName || 'Customer'}')">
                                    ` : `
                                    <div style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -35px;
                                        left: 20px;
                                        background: rgba(255,255,255,0.2);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                        font-weight: 600;
                                    ">
                                        ${customer.fullName ? customer.fullName.charAt(0).toUpperCase() : 'C'}
                                    </div>
                                    `}
                                </div>
                                <div style="padding: 50px 20px 20px 20px;">
                                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">
                                        ${customer.fullName || 'Unknown Customer'}
                                    </h3>
                                    <div style="color: #6c757d; font-size: 13px; margin-bottom: 5px;">
                                        ${customer.email || 'N/A'}
                                    </div>
                                    <div style="color: #6c757d; font-size: 12px; margin-bottom: 15px;">
                                        ${customer.nrc || 'NRC: N/A'}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            ${Utils.getUserStatusBadge(customer.status || 'active')}
                                        </div>
                                        <div style="font-size: 12px; color: #6c757d;">
                                            ${customer.totalLoans || 0} loans
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <div style="
                                            background: #e7f5ff;
                                            color: #1864ab;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 11px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-wallet"></i> Limit: ${Utils.formatCurrency(customer.loanLimit || 0)}
                                        </div>
                                        <div style="
                                            background: #fff3bf;
                                            color: #e67700;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-size: 11px;
                                            font-weight: 500;
                                        ">
                                            <i class="fas fa-credit-card"></i> Balance: ${Utils.formatCurrency(customer.accountBalance || 0)}
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; display: flex; gap: 8px;">
                                    <button onclick="viewUserDetails('${customer.id}', 'customer')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #7950f2;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="showEditUserModal('${customer.id}', 'customer')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #20c997;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="showUserActionsMenu('${customer.id}', 'customer')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-cog"></i> Actions
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                        
                        if (profilePic) {
                            AppState.customerPictures[customer.id] = profilePic;
                        }
                    });
                }
            }
            
            this.updatePagination('customers', totalPages, page);
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading customers:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load customers', 'error');
        }
    },

    async loadAdmins(page = 1, filters = {}) {
        try {
            Utils.showLoading('Loading admins...');
            
            const usersRef = db.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val() || {};
            
            let adminsArray = Object.entries(users)
                .map(([id, user]) => ({ id, ...user }))
                .filter(user => user.userType === 'admin' || user.userType === 'sudo' || user.userType === 'supervisor')
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            if (filters.role && filters.role !== 'all') {
                adminsArray = adminsArray.filter(admin => admin.userType === filters.role);
            }
            
            if (filters.status && filters.status !== 'all') {
                adminsArray = adminsArray.filter(admin => admin.status === filters.status);
            }
            
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                adminsArray = adminsArray.filter(admin => 
                    (admin.fullName && admin.fullName.toLowerCase().includes(searchTerm)) ||
                    (admin.email && admin.email.toLowerCase().includes(searchTerm))
                );
            }
            
            AppState.admins = adminsArray;
            
            const itemsPerPage = AppState.pagination.admins.itemsPerPage;
            const totalPages = Math.ceil(adminsArray.length / itemsPerPage);
            AppState.pagination.admins.totalPages = totalPages;
            AppState.pagination.admins.currentPage = page;
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAdmins = adminsArray.slice(startIndex, endIndex);
            
            AppState.adminPictures = {};
            
            const container = document.getElementById('adminsGrid');
            if (container) {
                container.innerHTML = '';
                
                if (paginatedAdmins.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #6c757d;">
                            <i class="fas fa-user-cog" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>No admins found</div>
                        </div>
                    `;
                } else {
                    paginatedAdmins.forEach(admin => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            border: 1px solid #e9ecef;
                            transition: transform 0.2s, box-shadow 0.2s;
                        `;
                        card.onmouseover = () => {
                            card.style.transform = 'translateY(-4px)';
                            card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
                        };
                        card.onmouseout = () => {
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
                        };
                        
                        const profilePic = admin.profilePhoto || admin.photoUrl || '';
                        const isCurrentUser = admin.id === AppState.currentUser?.uid;
                        
                        card.innerHTML = `
                            <div style="position: relative;">
                                <div style="
                                    height: 100px;
                                    background: linear-gradient(135deg, #fd7e14 0%, #fa5252 100%);
                                    position: relative;
                                ">
                                    ${profilePic ? `
                                    <img src="${profilePic}" alt="${admin.fullName || 'Admin'}" style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -35px;
                                        left: 20px;
                                        object-fit: cover;
                                        cursor: pointer;
                                    " onclick="viewImage('${profilePic}', '${admin.fullName || 'Admin'}')">
                                    ` : `
                                    <div style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        border: 4px solid white;
                                        position: absolute;
                                        bottom: -35px;
                                        left: 20px;
                                        background: rgba(255,255,255,0.2);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                        font-weight: 600;
                                    ">
                                        ${admin.fullName ? admin.fullName.charAt(0).toUpperCase() : 'A'}
                                    </div>
                                    `}
                                    ${isCurrentUser ? `
                                    <div style="position: absolute; top: 10px; right: 10px; background: #40c057; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                        YOU
                                    </div>
                                    ` : ''}
                                </div>
                                <div style="padding: 50px 20px 20px 20px;">
                                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">
                                        ${admin.fullName || 'Unknown Admin'}
                                        ${admin.userType === 'sudo' ? ' ' : admin.userType === 'supervisor' ? ' ' : ''}
                                    </h3>
                                    <div style="color: #6c757d; font-size: 13px; margin-bottom: 5px;">
                                        ${admin.email || 'N/A'}
                                    </div>
                                    <div style="margin-bottom: 15px;">
                                        ${Utils.getRoleBadge(admin.userType || 'admin')}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            ${Utils.getUserStatusBadge(admin.status || 'active')}
                                        </div>
                                        <div style="font-size: 12px; color: #6c757d;">
                                            Last login: ${Utils.getTimeAgo(admin.lastLogin || Date.now())}
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; display: flex; gap: 8px;">
                                    <button onclick="viewUserDetails('${admin.id}', 'admin')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #fd7e14;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    ${!isCurrentUser ? `
                                    <button onclick="showEditUserModal('${admin.id}', 'admin')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #20c997;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="showUserActionsMenu('${admin.id}', 'admin')" style="
                                        flex: 1;
                                        padding: 8px;
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-cog"></i> Actions
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                        
                        if (profilePic) {
                            AppState.adminPictures[admin.id] = profilePic;
                        }
                    });
                }
            }
            
            this.updatePagination('admins', totalPages, page);
            
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading admins:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load admins', 'error');
        }
    },

    async viewLoanDetails(loanId) {
        try {
            Utils.showLoading('Loading loan details...');
            
            const loanRef = db.ref('loans/' + loanId);
            const snapshot = await loanRef.once('value');
            const loan = snapshot.val();
            
            if (!loan) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'Loan not found', 'error');
                return;
            }
            
            const customerRef = db.ref('users/' + loan.customerId);
            const customerSnapshot = await customerRef.once('value');
            const customer = customerSnapshot.val() || {};
            
            let agent = {};
            if (loan.agentId) {
                const agentRef = db.ref('agents/' + loan.agentId);
                const agentSnapshot = await agentRef.once('value');
                agent = agentSnapshot.val() || {};
            }
            
            let collateralImages = '';
            if (loan.collateral && loan.collateral.images) {
                if (Array.isArray(loan.collateral.images)) {
                    collateralImages = loan.collateral.images.map(img => `
                        <div style="flex: 0 0 auto; width: 120px;">
                            <img src="${img}" alt="Collateral" style="
                                width: 100%;
                                height: 120px;
                                object-fit: cover;
                                border-radius: 8px;
                                cursor: pointer;
                            " onclick="viewImage('${img}', 'Collateral Image')">
                        </div>
                    `).join('');
                }
            }
            
            const content = document.getElementById('loanDetailsContent');
            if (content) {
                content.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Loan Application Details</h2>
                        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Basic Information</h3>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Loan ID</div>
                                            <div style="font-weight: 600; color: #333;">${loanId}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Status</div>
                                            <div>${Utils.getLoanStatusBadge(loan.status || 'pending')}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Amount</div>
                                            <div style="font-weight: 600; color: #333; font-size: 18px;">
                                                ${Utils.formatCurrency(loan.amount || 0)}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Duration</div>
                                            <div style="font-weight: 600; color: #333;">${loan.duration || 0} months</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Interest Rate</div>
                                            <div style="font-weight: 600; color: #333;">${loan.interestRate || 0}%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Applied On</div>
                                            <div style="font-weight: 600; color: #333;">${Utils.formatDateTime(loan.createdAt)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Loan Type</div>
                                            <div style="font-weight: 600; color: #333;">${loan.loanType || 'Personal'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Monthly Payment</div>
                                            <div style="font-weight: 600; color: #333;">${Utils.formatCurrency(loan.monthlyPayment || 0)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Customer Information</h3>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                        ${customer.profilePhoto ? `
                                        <img src="${customer.profilePhoto}" alt="${customer.fullName || 'Customer'}" style="
                                            width: 60px;
                                            height: 60px;
                                            border-radius: 50%;
                                            object-fit: cover;
                                            cursor: pointer;
                                        " onclick="viewImage('${customer.profilePhoto}', '${customer.fullName || 'Customer'}')">
                                        ` : `
                                        <div style="
                                            width: 60px;
                                            height: 60px;
                                            border-radius: 50%;
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-size: 20px;
                                            font-weight: 600;
                                        ">
                                            ${customer.fullName ? customer.fullName.charAt(0).toUpperCase() : 'C'}
                                        </div>
                                        `}
                                        <div>
                                            <div style="font-weight: 600; color: #333; font-size: 18px;">
                                                ${customer.fullName || 'Unknown Customer'}
                                            </div>
                                            <div style="color: #6c757d; font-size: 14px;">
                                                ${customer.email || 'N/A'}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Phone</div>
                                            <div style="font-weight: 500; color: #333;">${customer.phone || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">NRC</div>
                                            <div style="font-weight: 500; color: #333;">${customer.nrc || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Address</div>
                                            <div style="font-weight: 500; color: #333;">${customer.address || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #6c757d;">Status</div>
                                            <div style="font-weight: 500; color: #333;">${Utils.getUserStatusBadge(customer.status || 'active')}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${loan.purposeDescription ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Loan Purpose</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <p style="margin: 0; color: #333; line-height: 1.6;">${loan.purposeDescription}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${loan.collateral ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Collateral Details</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Category</div>
                                        <div style="font-weight: 600; color: #333;">${loan.collateral.category || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Estimated Value</div>
                                        <div style="font-weight: 600; color: #333;">${Utils.formatCurrency(loan.collateral.value || 0)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Description</div>
                                        <div style="font-weight: 500; color: #333;">${loan.collateral.description || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Location</div>
                                        <div style="font-weight: 500; color: #333;">${loan.collateral.location || 'N/A'}</div>
                                    </div>
                                </div>
                                
                                ${collateralImages ? `
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">Collateral Images</div>
                                    <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                                        ${collateralImages}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${loan.repaymentSchedule ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 16px;">Repayment Schedule</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Installment</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Due Date</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Amount</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Array.isArray(loan.repaymentSchedule) ? loan.repaymentSchedule.map((installment, index) => `
                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                            <td style="padding: 10px; color: #333;">#${index + 1}</td>
                                            <td style="padding: 10px; color: #333;">${Utils.formatDate(installment.dueDate)}</td>
                                            <td style="padding: 10px; font-weight: 600; color: #333;">${Utils.formatCurrency(installment.totalDue || 0)}</td>
                                            <td style="padding: 10px;">
                                                <span style="
                                                    padding: 4px 8px;
                                                    border-radius: 4px;
                                                    font-size: 12px;
                                                    font-weight: 500;
                                                    background: ${installment.status === 'paid' ? '#d3f9d8' : installment.status === 'overdue' ? '#ffe3e3' : '#fff3bf'};
                                                    color: ${installment.status === 'paid' ? '#0b7285' : installment.status === 'overdue' ? '#c92a2a' : '#e67700'};
                                                ">
                                                    ${installment.status || 'pending'}
                                                </span>
                                            </td>
                                        </tr>
                                        `).join('') : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="showEditLoanModal('${loanId}')" style="
                                padding: 12px 24px;
                                background: #20c997;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-edit"></i> Edit Loan
                            </button>
                            ${loan.status === 'pending' ? `
                            <button onclick="approveLoan('${loanId}')" style="
                                padding: 12px 24px;
                                background: #40c057;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-check"></i> Approve Loan
                            </button>
                            <button onclick="rejectLoan('${loanId}')" style="
                                padding: 12px 24px;
                                background: #fa5252;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-times"></i> Reject Loan
                            </button>
                            ` : ''}
                            <button onclick="deleteLoan('${loanId}')" style="
                                padding: 12px 24px;
                                background: #dc3545;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-trash"></i> Delete Loan
                            </button>
                            <button onclick="Utils.closeModal('loanDetailsModal')" style="
                                padding: 12px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            ">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            }
            
            Utils.openModal('loanDetailsModal');
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading loan details:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load loan details', 'error');
        }
    },

    async viewUserDetails(userId, userType) {
        try {
            Utils.showLoading('Loading user details...');
            
            let userData = null;
            let userRef = null;
            
            if (userType === 'agent') {
                userRef = db.ref('agents/' + userId);
            } else {
                userRef = db.ref('users/' + userId);
            }
            
            const snapshot = await userRef.once('value');
            userData = snapshot.val();
            
            if (!userData) {
                Utils.hideLoading();
                Utils.showNotification('Error', 'User not found', 'error');
                return;
            }
            
            const actualUserType = userData.userType || userType;
            
            let loansCount = 0;
            let totalLoanAmount = 0;
            
            if (actualUserType === 'customer') {
                const loansRef = db.ref('loans');
                const loansSnapshot = await loansRef.once('value');
                const loans = loansSnapshot.val() || {};
                
                const userLoans = Object.values(loans).filter(loan => loan.customerId === userId);
                loansCount = userLoans.length;
                totalLoanAmount = userLoans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
            } else if (actualUserType === 'agent') {
                const usersRef = db.ref('users');
                const usersSnapshot = await usersRef.once('value');
                const users = usersSnapshot.val() || {};
                
                const agentCustomers = Object.values(users).filter(user => user.assignedAgentId === userId);
                loansCount = agentCustomers.length;
            }
            
            const content = document.getElementById('userDetailsContent');
            if (content) {
                const profilePic = userData.profilePhoto || userData.photoUrl || '';
                
                content.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">${actualUserType.charAt(0).toUpperCase() + actualUserType.slice(1)} Details</h2>
                        
                        <div style="display: flex; gap: 30px; margin-bottom: 30px;">
                            <div style="flex: 0 0 auto;">
                                ${profilePic ? `
                                <img src="${profilePic}" alt="${userData.fullName || 'User'}" style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    object-fit: cover;
                                    border: 5px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                    cursor: pointer;
                                " onclick="viewImage('${profilePic}', '${userData.fullName || 'User'}')">
                                ` : `
                                <div style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, ${actualUserType === 'agent' ? '#40c057' : actualUserType === 'admin' || actualUserType === 'sudo' ? '#fd7e14' : '#7950f2'} 0%, ${actualUserType === 'agent' ? '#82c91e' : actualUserType === 'admin' || actualUserType === 'sudo' ? '#fa5252' : '#4c6ef5'} 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 48px;
                                    font-weight: 600;
                                    border: 5px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                ">
                                    ${userData.fullName ? userData.fullName.charAt(0).toUpperCase() : actualUserType.charAt(0).toUpperCase()}
                                </div>
                                `}
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="showUploadImageModal('${userId}', '${actualUserType}')" style="
                                        padding: 8px 16px;
                                        background: #4dabf7;
                                        color: white;
                                        border: none;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: inline-flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-camera"></i> Change Photo
                                    </button>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">
                                    ${userData.fullName || 'Unknown User'}
                                    ${actualUserType === 'sudo' ? ' ' : actualUserType === 'supervisor' ? ' ' : ''}
                                </h3>
                                
                                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                                    <div>
                                        ${Utils.getRoleBadge(actualUserType)}
                                    </div>
                                    <div>
                                        ${Utils.getUserStatusBadge(userData.status || 'active')}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Email</div>
                                        <div style="font-weight: 600; color: #333;">${userData.email || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Phone</div>
                                        <div style="font-weight: 500; color: #333;">${userData.phone || 'N/A'}</div>
                                    </div>
                                    ${userData.nrc ? `
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">NRC Number</div>
                                        <div style="font-weight: 600; color: #333;">${userData.nrc}</div>
                                    </div>
                                    ` : ''}
                                    ${userData.agentId ? `
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Agent ID</div>
                                        <div style="font-weight: 600; color: #333;">${userData.agentId}</div>
                                    </div>
                                    ` : ''}
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Created</div>
                                        <div style="font-weight: 500; color: #333;">${Utils.formatDateTime(userData.createdAt)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Last Login</div>
                                        <div style="font-weight: 500; color: #333;">${Utils.formatDateTime(userData.lastLogin) || 'Never'}</div>
                                    </div>
                                </div>
                                
                                ${userData.address || userData.residence ? `
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Address</div>
                                    <div style="font-weight: 500; color: #333;">${userData.address || userData.residence || 'N/A'}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(${actualUserType === 'customer' ? '3' : actualUserType === 'agent' ? '4' : '2'}, 1fr); gap: 15px; margin-bottom: 30px;">
                            ${actualUserType === 'customer' ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${loansCount}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Loans</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${Utils.formatCurrency(totalLoanAmount)}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Borrowed</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${Utils.formatCurrency(userData.loanLimit || 0)}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Loan Limit</div>
                            </div>
                            ` : actualUserType === 'agent' ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${loansCount}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Clients</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${userData.totalLoans || 0}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Loans</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${Utils.formatCurrency(userData.commissionEarned || 0)}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Commission Earned</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${userData.performance?.successRate || 0}%
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Success Rate</div>
                            </div>
                            ` : `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${userData.totalActions || 0}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Total Actions</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px;">
                                    ${userData.lastLogin ? Utils.getTimeAgo(userData.lastLogin) : 'Never'}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">Last Active</div>
                            </div>
                            `}
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="showEditUserModal('${userId}', '${actualUserType}')" style="
                                padding: 12px 24px;
                                background: #20c997;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-edit"></i> Edit User
                            </button>
                            <button onclick="showUserActionsMenu('${userId}', '${actualUserType}')" style="
                                padding: 12px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-cog"></i> Manage User
                            </button>
                            <button onclick="Utils.closeModal('userDetailsModal')" style="
                                padding: 12px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            ">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            }
            
            Utils.openModal('userDetailsModal');
            Utils.hideLoading();
            
        } catch (error) {
            console.error('Error loading user details:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to load user details', 'error');
        }
    },

    async approveLoan(loanId) {
        Utils.confirmAction(
            'Approve Loan',
            'Are you sure you want to approve this loan application? This action cannot be undone.',
            async () => {
                try {
                    Utils.showLoading('Approving loan...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    const loan = snapshot.val();
                    
                    if (!loan) {
                        throw new Error('Loan not found');
                    }
                    
                    await loanRef.update({
                        status: 'approved',
                        approvedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByEmail: AppState.currentUser.email,
                        updatedAt: Date.now()
                    });
                    
                    if (loan.customerId) {
                        const notificationRef = db.ref('notifications/' + loan.customerId).push();
                        await notificationRef.set({
                            id: notificationRef.key,
                            type: 'loan_approved',
                            title: 'Loan Approved',
                            message: `Your loan application for ${Utils.formatCurrency(loan.amount)} has been approved`,
                            data: {
                                loanId: loanId,
                                amount: loan.amount,
                                status: 'approved'
                            },
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                    
                    if (loan.agentId) {
                        const agentNotificationRef = db.ref('notifications/' + loan.agentId).push();
                        await agentNotificationRef.set({
                            id: agentNotificationRef.key,
                            type: 'customer_loan_approved',
                            title: 'Customer Loan Approved',
                            message: `Loan application for ${loan.customerName} has been approved`,
                            data: {
                                loanId: loanId,
                                customerId: loan.customerId,
                                amount: loan.amount
                            },
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                    
                    await this.logAudit({
                        action: 'APPROVE_LOAN',
                        targetId: loanId,
                        targetType: 'loan',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            loanId: loanId,
                            customerId: loan.customerId,
                            amount: loan.amount
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('Loan Approved', 'Loan application has been approved successfully', 'success');
                    
                    if (AppState.currentSection === 'dashboard') {
                        loadRecentLoans();
                    } else if (AppState.currentSection === 'loans') {
                        loadLoanApplications();
                    }
                    
                    Utils.closeModal('loanDetailsModal');
                    
                } catch (error) {
                    console.error('Error approving loan:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to approve loan', 'error');
                }
            }
        );
    },

    async rejectLoan(loanId) {
        Utils.confirmAction(
            'Reject Loan',
            'Are you sure you want to reject this loan application? This action cannot be undone.',
            async () => {
                try {
                    const reason = prompt('Please enter the reason for rejection:');
                    if (!reason || !reason.trim()) {
                        Utils.showNotification('Cancelled', 'Rejection cancelled - no reason provided', 'warning');
                        return;
                    }
                    
                    Utils.showLoading('Rejecting loan...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    const loan = snapshot.val();
                    
                    if (!loan) {
                        throw new Error('Loan not found');
                    }
                    
                    await loanRef.update({
                        status: 'rejected',
                        rejectedAt: Date.now(),
                        rejectedBy: AppState.currentUser.uid,
                        rejectedByEmail: AppState.currentUser.email,
                        rejectionReason: reason,
                        updatedAt: Date.now()
                    });
                    
                    if (loan.customerId) {
                        const notificationRef = db.ref('notifications/' + loan.customerId).push();
                        await notificationRef.set({
                            id: notificationRef.key,
                            type: 'loan_rejected',
                            title: 'Loan Rejected',
                            message: `Your loan application for ${Utils.formatCurrency(loan.amount)} has been rejected`,
                            data: {
                                loanId: loanId,
                                amount: loan.amount,
                                status: 'rejected',
                                reason: reason
                            },
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                    
                    await this.logAudit({
                        action: 'REJECT_LOAN',
                        targetId: loanId,
                        targetType: 'loan',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            loanId: loanId,
                            customerId: loan.customerId,
                            amount: loan.amount,
                            reason: reason
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('Loan Rejected', 'Loan application has been rejected', 'info');
                    
                    if (AppState.currentSection === 'dashboard') {
                        loadRecentLoans();
                    } else if (AppState.currentSection === 'loans') {
                        loadLoanApplications();
                    }
                    
                    Utils.closeModal('loanDetailsModal');
                    
                } catch (error) {
                    console.error('Error rejecting loan:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to reject loan', 'error');
                }
            }
        );
    },

    async deleteLoan(loanId) {
        Utils.confirmAction(
            'Delete Loan',
            'Are you sure you want to permanently delete this loan application? This action cannot be undone.',
            async () => {
                try {
                    Utils.showLoading('Deleting loan...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    const loan = snapshot.val();
                    
                    if (!loan) {
                        throw new Error('Loan not found');
                    }
                    
                    await loanRef.remove();
                    
                    await this.logAudit({
                        action: 'DELETE_LOAN',
                        targetId: loanId,
                        targetType: 'loan',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            loanId: loanId,
                            customerId: loan.customerId,
                            amount: loan.amount,
                            status: loan.status
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('Loan Deleted', 'Loan application has been permanently deleted', 'success');
                    
                    if (AppState.currentSection === 'dashboard') {
                        loadRecentLoans();
                    } else if (AppState.currentSection === 'loans') {
                        loadLoanApplications();
                    }
                    
                    Utils.closeModal('loanDetailsModal');
                    
                } catch (error) {
                    console.error('Error deleting loan:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to delete loan', 'error');
                }
            }
        );
    },

    async suspendUser(userId, userType, reason = '') {
        Utils.confirmAction(
            'Suspend User',
            `Are you sure you want to suspend this ${userType}?`,
            async () => {
                try {
                    Utils.showLoading('Suspending user...');
                    
                    let userRef = null;
                    if (userType === 'agent') {
                        userRef = db.ref('agents/' + userId);
                    } else {
                        userRef = db.ref('users/' + userId);
                    }
                    
                    await userRef.update({
                        status: 'suspended',
                        suspensionReason: reason || 'Administrative suspension',
                        suspendedAt: Date.now(),
                        suspendedBy: AppState.currentUser.uid,
                        suspendedByEmail: AppState.currentUser.email,
                        updatedAt: Date.now()
                    });
                    
                    await this.logAudit({
                        action: 'SUSPEND_USER',
                        targetId: userId,
                        targetType: userType,
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            userId: userId,
                            userType: userType,
                            reason: reason
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('User Suspended', `${userType.charAt(0).toUpperCase() + userType.slice(1)} has been suspended`, 'warning');
                    
                    switch(userType) {
                        case 'agent':
                            loadAgents();
                            break;
                        case 'customer':
                            loadCustomers();
                            break;
                        case 'admin':
                            loadAdmins();
                            break;
                    }
                    
                    Utils.closeModal('userDetailsModal');
                    
                } catch (error) {
                    console.error('Error suspending user:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to suspend user', 'error');
                }
            }
        );
    },

    async banUser(userId, userType, reason = '') {
        Utils.confirmAction(
            'Ban User',
            `Are you sure you want to permanently ban this ${userType}? This action cannot be undone.`,
            async () => {
                try {
                    Utils.showLoading('Banning user...');
                    
                    let userRef = null;
                    if (userType === 'agent') {
                        userRef = db.ref('agents/' + userId);
                    } else {
                        userRef = db.ref('users/' + userId);
                    }
                    
                    await userRef.update({
                        status: 'banned',
                        banReason: reason || 'Administrative ban',
                        bannedAt: Date.now(),
                        bannedBy: AppState.currentUser.uid,
                        bannedByEmail: AppState.currentUser.email,
                        updatedAt: Date.now()
                    });
                    
                    await this.logAudit({
                        action: 'BAN_USER',
                        targetId: userId,
                        targetType: userType,
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            userId: userId,
                            userType: userType,
                            reason: reason
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('User Banned', `${userType.charAt(0).toUpperCase() + userType.slice(1)} has been permanently banned`, 'error');
                    
                    switch(userType) {
                        case 'agent':
                            loadAgents();
                            break;
                        case 'customer':
                            loadCustomers();
                            break;
                        case 'admin':
                            loadAdmins();
                            break;
                    }
                    
                    Utils.closeModal('userDetailsModal');
                    
                } catch (error) {
                    console.error('Error banning user:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to ban user', 'error');
                }
            }
        );
    },

    async deleteUser(userId, userType) {
        Utils.confirmAction(
            'Delete User',
            `Are you sure you want to permanently delete this ${userType}? This action cannot be undone.`,
            async () => {
                try {
                    Utils.showLoading('Deleting user...');
                    
                    let userRef = null;
                    if (userType === 'agent') {
                        userRef = db.ref('agents/' + userId);
                    } else {
                        userRef = db.ref('users/' + userId);
                    }
                    
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();
                    
                    if (!userData) {
                        throw new Error('User not found');
                    }
                    
                    await userRef.remove();
                    
                    await this.logAudit({
                        action: 'DELETE_USER',
                        targetId: userId,
                        targetType: userType,
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            userId: userId,
                            userType: userType,
                            email: userData.email,
                            name: userData.fullName
                        },
                        timestamp: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showNotification('User Deleted', `${userType.charAt(0).toUpperCase() + userType.slice(1)} has been permanently deleted`, 'success');
                    
                    switch(userType) {
                        case 'agent':
                            loadAgents();
                            break;
                        case 'customer':
                            loadCustomers();
                            break;
                        case 'admin':
                            loadAdmins();
                            break;
                    }
                    
                    Utils.closeModal('userDetailsModal');
                    
                } catch (error) {
                    console.error('Error deleting user:', error);
                    Utils.hideLoading();
                    Utils.showNotification('Error', 'Failed to delete user', 'error');
                }
            }
        );
    },

    async activateUser(userId, userType) {
        try {
            Utils.showLoading('Activating user...');
            
            let userRef = null;
            if (userType === 'agent') {
                userRef = db.ref('agents/' + userId);
            } else {
                userRef = db.ref('users/' + userId);
            }
            
            await userRef.update({
                status: 'active',
                activatedAt: Date.now(),
                activatedBy: AppState.currentUser.uid,
                activatedByEmail: AppState.currentUser.email,
                updatedAt: Date.now()
            });
            
            await this.logAudit({
                action: 'ACTIVATE_USER',
                targetId: userId,
                targetType: userType,
                performedBy: AppState.currentUser.uid,
                performedByEmail: AppState.currentUser.email,
                details: {
                    userId: userId,
                    userType: userType
                },
                timestamp: Date.now()
            });
            
            Utils.hideLoading();
            Utils.showNotification('User Activated', `${userType.charAt(0).toUpperCase() + userType.slice(1)} has been activated`, 'success');
            
            switch(userType) {
                case 'agent':
                    loadAgents();
                    break;
                case 'customer':
                    loadCustomers();
                    break;
                case 'admin':
                    loadAdmins();
                    break;
            }
            
            Utils.closeModal('userDetailsModal');
            
        } catch (error) {
            console.error('Error activating user:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to activate user', 'error');
        }
    },

    async createUser(userData, userType) {
        try {
            Utils.showLoading(`Creating ${userType}...`);
            
            const userId = Utils.generateId('USR_');
            const timestamp = Date.now();
            
            let baseUserData = {
                id: userId,
                fullName: userData.fullName,
                email: userData.email,
                phone: userData.phone,
                userType: userType,
                status: 'active',
                createdAt: timestamp,
                createdBy: AppState.currentUser.uid,
                createdByEmail: AppState.currentUser.email,
                updatedAt: timestamp
            };
            
            if (userData.nrc) {
                baseUserData.nrc = userData.nrc;
            }
            
            if (userData.address) {
                baseUserData.address = userData.address;
            }
            
            if (userType === 'agent') {
                const agentData = {
                    ...baseUserData,
                    agentId: Utils.generateId('AGT_'),
                    commissionRate: userData.commissionRate || 5,
                    commissionEarned: 0,
                    totalClients: 0,
                    totalLoans: 0,
                    performance: {
                        successRate: 0,
                        completionRate: 0
                    }
                };
                
                await db.ref('agents/' + userId).set(agentData);
                await db.ref('users/' + userId).set(baseUserData);
            } else if (userType === 'admin' || userType === 'sudo') {
                const adminData = {
                    ...baseUserData,
                    role: userData.role || userType,
                    permissions: userData.permissions || ['read', 'write'],
                    lastLogin: null,
                    totalActions: 0
                };
                
                await db.ref('users/' + userId).set(adminData);
                
                if (userType === 'sudo') {
                    await db.ref('sudoAdmins/' + userId).set({
                        isActive: true,
                        createdAt: timestamp,
                        createdBy: AppState.currentUser.uid
                    });
                }
            } else {
                const customerData = {
                    ...baseUserData,
                    nrc: userData.nrc,
                    address: userData.address,
                    loanLimit: userData.loanLimit || 10000,
                    accountBalance: 0,
                    totalLoans: 0,
                    assignedAgentId: userData.assignedAgentId || null
                };
                
                await db.ref('users/' + userId).set(customerData);
            }
            
            if (userData.password) {
                try {
                    await auth.createUserWithEmailAndPassword(userData.email, userData.password);
                } catch (error) {
                    console.warn('Could not create auth user, might already exist:', error);
                }
            }
            
            await this.logAudit({
                action: 'CREATE_USER',
                targetId: userId,
                targetType: userType,
                performedBy: AppState.currentUser.uid,
                performedByEmail: AppState.currentUser.email,
                details: {
                    userId: userId,
                    userType: userType,
                    email: userData.email,
                    name: userData.fullName
                },
                timestamp: timestamp
            });
            
            Utils.hideLoading();
            Utils.showNotification('User Created', `${userType.charAt(0).toUpperCase() + userType.slice(1)} has been created successfully`, 'success');
            
            Utils.closeModal('createUserModal');
            
            switch(userType) {
                case 'agent':
                    loadAgents();
                    break;
                case 'customer':
                    loadCustomers();
                    break;
                case 'admin':
                    loadAdmins();
                    break;
            }
            
        } catch (error) {
            console.error('Error creating user:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', `Failed to create ${userType}: ${error.message}`, 'error');
        }
    },

    async createLoan(loanData) {
        try {
            Utils.showLoading('Creating loan...');
            
            const loanId = Utils.generateId('LOAN_');
            const timestamp = Date.now();
            
            const loan = {
                id: loanId,
                loanId: loanId,
                customerId: loanData.customerId,
                customerName: loanData.customerName,
                customerEmail: loanData.customerEmail,
                amount: parseFloat(loanData.amount),
                duration: parseInt(loanData.duration),
                interestRate: parseFloat(loanData.interestRate),
                loanType: loanData.loanType || 'personal',
                purpose: loanData.purpose || '',
                purposeDescription: loanData.purposeDescription || '',
                status: 'pending',
                createdAt: timestamp,
                createdBy: AppState.currentUser.uid,
                createdByEmail: AppState.currentUser.email,
                updatedAt: timestamp
            };
            
            if (loanData.agentId) {
                loan.agentId = loanData.agentId;
                loan.agentName = loanData.agentName;
            }
            
            if (loanData.collateral) {
                loan.collateral = loanData.collateral;
            }
            
            const monthlyInterestRate = loan.interestRate / 100 / 12;
            const numberOfPayments = loan.duration;
            const monthlyPayment = loan.amount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
            
            loan.monthlyPayment = parseFloat(monthlyPayment.toFixed(2));
            loan.totalRepayment = parseFloat((monthlyPayment * numberOfPayments).toFixed(2));
            loan.interestEarned = parseFloat((loan.totalRepayment - loan.amount).toFixed(2));
            
            const repaymentSchedule = [];
            const startDate = new Date(timestamp);
            
            for (let i = 1; i <= numberOfPayments; i++) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(dueDate.getMonth() + i);
                
                repaymentSchedule.push({
                    installmentNumber: i,
                    dueDate: dueDate.getTime(),
                    principal: parseFloat((loan.amount / numberOfPayments).toFixed(2)),
                    interest: parseFloat((loan.interestEarned / numberOfPayments).toFixed(2)),
                    totalDue: parseFloat(monthlyPayment.toFixed(2)),
                    status: 'pending'
                });
            }
            
            loan.repaymentSchedule = repaymentSchedule;
            
            await db.ref('loans/' + loanId).set(loan);
            
            await this.logAudit({
                action: 'CREATE_LOAN',
                targetId: loanId,
                targetType: 'loan',
                performedBy: AppState.currentUser.uid,
                performedByEmail: AppState.currentUser.email,
                details: {
                    loanId: loanId,
                    customerId: loanData.customerId,
                    amount: loan.amount,
                    duration: loan.duration
                },
                timestamp: timestamp
            });
            
            Utils.hideLoading();
            Utils.showNotification('Loan Created', 'Loan has been created successfully', 'success');
            
            Utils.closeModal('createLoanModal');
            
            if (AppState.currentSection === 'loans') {
                loadLoanApplications();
            }
            
        } catch (error) {
            console.error('Error creating loan:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', `Failed to create loan: ${error.message}`, 'error');
        }
    },

    async updateLoan(loanId, updates) {
        try {
            Utils.showLoading('Updating loan...');
            
            const loanRef = db.ref('loans/' + loanId);
            
            await loanRef.update({
                ...updates,
                updatedAt: Date.now(),
                updatedBy: AppState.currentUser.uid,
                updatedByEmail: AppState.currentUser.email
            });
            
            await this.logAudit({
                action: 'UPDATE_LOAN',
                targetId: loanId,
                targetType: 'loan',
                performedBy: AppState.currentUser.uid,
                performedByEmail: AppState.currentUser.email,
                details: updates,
                timestamp: Date.now()
            });
            
            Utils.hideLoading();
            Utils.showNotification('Loan Updated', 'Loan has been updated successfully', 'success');
            
            Utils.closeModal('editLoanModal');
            
            if (AppState.currentSection === 'loans') {
                loadLoanApplications();
            }
            
        } catch (error) {
            console.error('Error updating loan:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', `Failed to update loan: ${error.message}`, 'error');
        }
    },

    async updateUser(userId, userType, updates) {
        try {
            Utils.showLoading('Updating user...');
            
            let userRef = null;
            if (userType === 'agent') {
                userRef = db.ref('agents/' + userId);
            } else {
                userRef = db.ref('users/' + userId);
            }
            
            await userRef.update({
                ...updates,
                updatedAt: Date.now(),
                updatedBy: AppState.currentUser.uid,
                updatedByEmail: AppState.currentUser.email
            });
            
            await this.logAudit({
                action: 'UPDATE_USER',
                targetId: userId,
                targetType: userType,
                performedBy: AppState.currentUser.uid,
                performedByEmail: AppState.currentUser.email,
                details: updates,
                timestamp: Date.now()
            });
            
            Utils.hideLoading();
            Utils.showNotification('User Updated', 'User has been updated successfully', 'success');
            
            Utils.closeModal('createUserModal');
            
            switch(userType) {
                case 'agent':
                    loadAgents();
                    break;
                case 'customer':
                    loadCustomers();
                    break;
                case 'admin':
                    loadAdmins();
                    break;
            }
            
        } catch (error) {
            console.error('Error updating user:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', `Failed to update user: ${error.message}`, 'error');
        }
    },

    async uploadImage(userId, userType, file) {
        try {
            Utils.showLoading('Uploading image...');
            
            const fileName = `${userType}_${userId}_${Date.now()}_${file.name}`;
            const storageRef = storage.ref(`profile_pictures/${fileName}`);
            
            await storageRef.put(file);
            const downloadURL = await storageRef.getDownloadURL();
            
            let userRef = null;
            if (userType === 'agent') {
                userRef = db.ref('agents/' + userId);
            } else {
                userRef = db.ref('users/' + userId);
            }
            
            await userRef.update({
                profilePhoto: downloadURL,
                photoUrl: downloadURL,
                updatedAt: Date.now(),
                updatedBy: AppState.currentUser.uid
            });
            
            await this.logAudit({
                action: 'UPLOAD_PROFILE_PICTURE',
                targetId: userId,
                targetType: userType,
                performedBy: AppState.currentUser.uid,
                performedByEmail: AppState.currentUser.email,
                details: {
                    fileName: fileName,
                    downloadURL: downloadURL
                },
                timestamp: Date.now()
            });
            
            Utils.hideLoading();
            Utils.showNotification('Image Uploaded', 'Profile picture has been updated successfully', 'success');
            
            Utils.closeModal('uploadImageModal');
            
            setTimeout(() => {
                viewUserDetails(userId, userType);
            }, 1000);
            
        } catch (error) {
            console.error('Error uploading image:', error);
            Utils.hideLoading();
            Utils.showNotification('Error', 'Failed to upload image', 'error');
        }
    },

    initRealTimeListeners() {
        try {
            const loansRef = db.ref('loans');
            const loansListener = loansRef.on('value', (snapshot) => {
                const loans = snapshot.val() || {};
                const pendingCount = Object.values(loans).filter(l => l.status === 'pending').length;
                
                const pendingLoansEl = document.getElementById('pendingLoans');
                if (pendingLoansEl) {
                    pendingLoansEl.textContent = pendingCount.toLocaleString();
                }
                
                if (AppState.currentSection === 'dashboard') {
                    loadRecentLoans();
                } else if (AppState.currentSection === 'loans') {
                    loadLoanApplications(AppState.pagination.loans.currentPage);
                }
            });
            
            AppState.activeLoanListeners.push(loansListener);
            
            this.monitorSystemHealth();
            
            console.log('SUDO: Real-time listeners initialized');
            
        } catch (error) {
            console.error('Error initializing real-time listeners:', error);
        }
    },

    monitorSystemHealth() {
        setInterval(() => {
            const health = Math.min(100, Math.max(80, 100 - Math.random() * 10));
            AppState.systemStats.systemHealth = Math.round(health);
            
            const healthEl = document.getElementById('systemHealth');
            if (healthEl) {
                healthEl.textContent = Math.round(health) + '%';
                healthEl.style.color = health > 90 ? '#40c057' : health > 75 ? '#fab005' : '#fa5252';
            }
        }, 10000);
    },

    updatePagination(type, totalPages, currentPage) {
        const paginationEl = document.getElementById(type + 'Pagination');
        if (!paginationEl) return;
        
        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }
        
        let html = '';
        
        html += `
            <button onclick="changePage('${type}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="
                padding: 8px 12px;
                border: 1px solid #dee2e6;
                background: ${currentPage === 1 ? '#f8f9fa' : 'white'};
                color: ${currentPage === 1 ? '#adb5bd' : '#495057'};
                border-radius: 6px;
                cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};
                font-size: 14px;
            ">
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <button onclick="changePage('${type}', ${i})" style="
                    padding: 8px 12px;
                    border: 1px solid ${i === currentPage ? '#4dabf7' : '#dee2e6'};
                    background: ${i === currentPage ? '#4dabf7' : 'white'};
                    color: ${i === currentPage ? 'white' : '#495057'};
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: ${i === currentPage ? '600' : 'normal'};
                ">
                    ${i}
                </button>
            `;
        }
        
        html += `
            <button onclick="changePage('${type}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="
                padding: 8px 12px;
                border: 1px solid #dee2e6;
                background: ${currentPage === totalPages ? '#f8f9fa' : 'white'};
                color: ${currentPage === totalPages ? '#adb5bd' : '#495057'};
                border-radius: 6px;
                cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};
                font-size: 14px;
            ">
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
        
        paginationEl.innerHTML = html;
    },

    async logAudit(logData) {
        try {
            const logId = Utils.generateId('AUDIT_');
            const auditRef = db.ref('auditLogs/' + logId);
            
            await auditRef.set({
                ...logData,
                timestamp: Date.now(),
                userType: 'sudo',
                performedByEmail: AppState.currentUser.email
            });
            
        } catch (error) {
            console.error('Error logging audit:', error);
        }
    },

    async logout() {
        try {
            AppState.activeLoanListeners.forEach(listener => {
                if (typeof listener === 'function') listener();
            });
            AppState.activeLoanListeners = [];
            
            await this.logAudit({
                action: 'SUDO_LOGOUT',
                details: 'SUDO admin logged out from control panel',
                performedBy: AppState.currentUser.uid
            });
            
            await auth.signOut();
            
            SudoAuthService.showLoginForm();
            
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }
};

// ===== ENHANCED GLOBAL FUNCTIONS =====
function viewLoanDetails(loanId) {
    FirebaseService.viewLoanDetails(loanId);
}

function viewUserDetails(userId, userType) {
    FirebaseService.viewUserDetails(userId, userType);
}

function approveLoan(loanId) {
    FirebaseService.approveLoan(loanId);
}

function rejectLoan(loanId) {
    FirebaseService.rejectLoan(loanId);
}

function deleteLoan(loanId) {
    FirebaseService.deleteLoan(loanId);
}

function suspendUser(userId, userType) {
    const reason = prompt('Enter reason for suspension:');
    if (reason !== null) {
        FirebaseService.suspendUser(userId, userType, reason);
    }
}

function banUser(userId, userType) {
    const reason = prompt('Enter reason for ban:');
    if (reason !== null) {
        FirebaseService.banUser(userId, userType, reason);
    }
}

function deleteUser(userId, userType) {
    FirebaseService.deleteUser(userId, userType);
}

function activateUser(userId, userType) {
    FirebaseService.activateUser(userId, userType);
}

function viewImage(imageUrl, title = 'Image') {
    const modalImage = document.getElementById('modalImage');
    if (modalImage) {
        modalImage.src = imageUrl;
        modalImage.alt = title;
        Utils.openModal('imageModal');
    }
}

function showCreateUserModal(userType) {
    const content = document.getElementById('createUserContent');
    if (content) {
        const userTypeLabel = userType.charAt(0).toUpperCase() + userType.slice(1);
        
        let additionalFields = '';
        let roleField = '';
        
        if (userType === 'agent') {
            additionalFields = `
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Commission Rate (%)</label>
                    <input type="number" id="createCommissionRate" value="5" min="0" max="50" step="0.1" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            `;
        } else if (userType === 'admin') {
            roleField = `
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Role</label>
                    <select id="createUserRole" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="admin">Admin</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="sudo">SUDO (Full Access)</option>
                    </select>
                </div>
            `;
        } else if (userType === 'customer') {
            additionalFields = `
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">NRC Number</label>
                    <input type="text" id="createNRC" placeholder="123456/78/9" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Address</label>
                    <textarea id="createAddress" rows="3" placeholder="Full residential address" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                        resize: vertical;
                    "></textarea>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Initial Loan Limit (ZMW)</label>
                    <input type="number" id="createLoanLimit" value="10000" min="0" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            `;
        }
        
        content.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Create New ${userTypeLabel}</h2>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Full Name *</label>
                        <input type="text" id="createFullName" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="John Doe">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Email Address *</label>
                        <input type="email" id="createEmail" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="john@example.com">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Phone Number *</label>
                        <input type="tel" id="createPhone" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="0971234567">
                    </div>
                    
                    ${roleField}
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Initial Password *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="createPassword" required style="
                                flex: 1;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            " value="${Utils.generatePassword(10)}">
                            <button type="button" onclick="generateNewPassword()" style="
                                padding: 10px 15px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                white-space: nowrap;
                            ">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            User will be asked to change password on first login
                        </div>
                    </div>
                    
                    ${additionalFields}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="createUser('${userType}')" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: #20c997;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-user-plus"></i> Create ${userTypeLabel}
                        </button>
                        <button onclick="Utils.closeModal('createUserModal')" style="
                            padding: 12px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        Utils.openModal('createUserModal');
    }
}

function showEditUserModal(userId, userType) {
    let userData = null;
    
    if (userType === 'agent') {
        userData = AppState.agents.find(a => a.id === userId);
    } else if (userType === 'customer') {
        userData = AppState.customers.find(c => c.id === userId);
    } else if (userType === 'admin') {
        userData = AppState.admins.find(a => a.id === userId);
    }
    
    if (!userData) {
        Utils.showNotification('Error', 'User data not found', 'error');
        return;
    }
    
    const content = document.getElementById('createUserContent');
    if (content) {
        const userTypeLabel = userType.charAt(0).toUpperCase() + userType.slice(1);
        
        let additionalFields = '';
        let roleField = '';
        
        if (userType === 'agent') {
            additionalFields = `
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Commission Rate (%)</label>
                    <input type="number" id="editCommissionRate" value="${userData.commissionRate || 5}" min="0" max="50" step="0.1" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Total Commission Earned (ZMW)</label>
                    <input type="number" id="editCommissionEarned" value="${userData.commissionEarned || 0}" min="0" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            `;
        } else if (userType === 'admin') {
            roleField = `
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Role</label>
                    <select id="editUserRole" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="admin" ${userData.userType === 'admin' ? 'selected' : ''}>Admin</option>
                        <option value="supervisor" ${userData.userType === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                        <option value="sudo" ${userData.userType === 'sudo' ? 'selected' : ''}>SUDO (Full Access)</option>
                    </select>
                </div>
            `;
        } else if (userType === 'customer') {
            additionalFields = `
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">NRC Number</label>
                    <input type="text" id="editNRC" value="${userData.nrc || ''}" placeholder="123456/78/9" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Address</label>
                    <textarea id="editAddress" rows="3" placeholder="Full residential address" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                        resize: vertical;
                    ">${userData.address || ''}</textarea>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Limit (ZMW)</label>
                    <input type="number" id="editLoanLimit" value="${userData.loanLimit || 10000}" min="0" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Account Balance (ZMW)</label>
                    <input type="number" id="editAccountBalance" value="${userData.accountBalance || 0}" min="0" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            `;
        }
        
        content.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Edit ${userTypeLabel}</h2>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Full Name *</label>
                        <input type="text" id="editFullName" value="${userData.fullName || ''}" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="John Doe">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Email Address *</label>
                        <input type="email" id="editEmail" value="${userData.email || ''}" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="john@example.com">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Phone Number *</label>
                        <input type="tel" id="editPhone" value="${userData.phone || ''}" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="0971234567">
                    </div>
                    
                    ${roleField}
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Status</label>
                        <select id="editUserStatus" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        ">
                            <option value="active" ${userData.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="suspended" ${userData.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                            <option value="banned" ${userData.status === 'banned' ? 'selected' : ''}>Banned</option>
                            <option value="inactive" ${userData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    
                    ${additionalFields}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="updateUser('${userId}', '${userType}')" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: #20c997;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-save"></i> Update ${userTypeLabel}
                        </button>
                        <button onclick="Utils.closeModal('createUserModal')" style="
                            padding: 12px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        Utils.openModal('createUserModal');
    }
}

function showCreateLoanModal() {
    const content = document.getElementById('createLoanContent');
    if (content) {
        content.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Create New Loan</h2>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Customer Email *</label>
                            <input type="email" id="loanCustomerEmail" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            " placeholder="customer@example.com">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Amount (ZMW) *</label>
                            <input type="number" id="loanAmount" required min="100" step="100" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            " placeholder="5000">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Duration (months) *</label>
                            <select id="loanDuration" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="3">3 months</option>
                                <option value="6">6 months</option>
                                <option value="12" selected>12 months</option>
                                <option value="24">24 months</option>
                                <option value="36">36 months</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Interest Rate (%) *</label>
                            <input type="number" id="loanInterestRate" value="15" min="1" max="50" step="0.5" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Type *</label>
                        <select id="loanType" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        ">
                            <option value="personal">Personal Loan</option>
                            <option value="business">Business Loan</option>
                            <option value="education">Education Loan</option>
                            <option value="emergency">Emergency Loan</option>
                            <option value="agriculture">Agriculture Loan</option>
                            <option value="vehicle">Vehicle Loan</option>
                            <option value="mortgage">Mortgage Loan</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Purpose</label>
                        <textarea id="loanPurpose" rows="3" placeholder="Describe the purpose of this loan..." style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                            resize: vertical;
                        "></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Assigned Agent Email (Optional)</label>
                        <input type="email" id="loanAgentEmail" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        " placeholder="agent@example.com">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="processCreateLoan()" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: #20c997;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-file-invoice-dollar"></i> Create Loan
                        </button>
                        <button onclick="Utils.closeModal('createLoanModal')" style="
                            padding: 12px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        Utils.openModal('createLoanModal');
    }
}

function showEditLoanModal(loanId) {
    const loan = AppState.loanApplications.find(l => l.id === loanId);
    if (!loan) {
        Utils.showNotification('Error', 'Loan not found', 'error');
        return;
    }
    
    const content = document.getElementById('editLoanContent');
    if (content) {
        content.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Edit Loan</h2>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Amount (ZMW) *</label>
                            <input type="number" id="editLoanAmount" value="${loan.amount || 0}" min="100" step="100" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Duration (months) *</label>
                            <input type="number" id="editLoanDuration" value="${loan.duration || 12}" min="1" max="60" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Interest Rate (%) *</label>
                            <input type="number" id="editLoanInterestRate" value="${loan.interestRate || 15}" min="1" max="50" step="0.5" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Type *</label>
                            <select id="editLoanType" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ced4da;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="personal" ${loan.loanType === 'personal' ? 'selected' : ''}>Personal Loan</option>
                                <option value="business" ${loan.loanType === 'business' ? 'selected' : ''}>Business Loan</option>
                                <option value="education" ${loan.loanType === 'education' ? 'selected' : ''}>Education Loan</option>
                                <option value="emergency" ${loan.loanType === 'emergency' ? 'selected' : ''}>Emergency Loan</option>
                                <option value="agriculture" ${loan.loanType === 'agriculture' ? 'selected' : ''}>Agriculture Loan</option>
                                <option value="vehicle" ${loan.loanType === 'vehicle' ? 'selected' : ''}>Vehicle Loan</option>
                                <option value="mortgage" ${loan.loanType === 'mortgage' ? 'selected' : ''}>Mortgage Loan</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Status *</label>
                        <select id="editLoanStatus" required style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                        ">
                            <option value="pending" ${loan.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${loan.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${loan.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="active" ${loan.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="disbursed" ${loan.status === 'disbursed' ? 'selected' : ''}>Disbursed</option>
                            <option value="completed" ${loan.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="defaulted" ${loan.status === 'defaulted' ? 'selected' : ''}>Defaulted</option>
                            <option value="overdue" ${loan.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #495057; font-size: 14px;">Loan Purpose</label>
                        <textarea id="editLoanPurpose" rows="3" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ced4da;
                            border-radius: 6px;
                            font-size: 14px;
                            resize: vertical;
                        ">${loan.purposeDescription || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="updateLoanData('${loanId}')" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: #20c997;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-save"></i> Update Loan
                        </button>
                        <button onclick="Utils.closeModal('editLoanModal')" style="
                            padding: 12px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        Utils.openModal('editLoanModal');
    }
}

function showUploadImageModal(userId, userType) {
    const content = document.getElementById('uploadImageContent');
    if (content) {
        content.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">Upload Profile Picture</h2>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="border: 2px dashed #ced4da; border-radius: 8px; padding: 30px; text-align: center;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6c757d; margin-bottom: 15px;"></i>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 16px; color: #495057; margin-bottom: 5px;">Drag & drop your image here</div>
                            <div style="font-size: 14px; color: #6c757d;">or click to browse</div>
                        </div>
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="previewImage(this)">
                        <button onclick="document.getElementById('imageUpload').click()" style="
                            padding: 10px 20px;
                            background: #4dabf7;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">
                            <i class="fas fa-folder-open"></i> Choose File
                        </button>
                    </div>
                    
                    <div id="imagePreview" style="display: none;">
                        <div style="font-size: 14px; color: #495057; margin-bottom: 10px;">Preview:</div>
                        <img id="previewImage" src="#" alt="Preview" style="
                            max-width: 200px;
                            max-height: 200px;
                            border-radius: 8px;
                            border: 1px solid #dee2e6;
                        ">
                    </div>
                    
                    <div style="font-size: 12px; color: #6c757d;">
                        <i class="fas fa-info-circle"></i> Maximum file size: 5MB. Supported formats: JPG, PNG, GIF
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="uploadSelectedImage('${userId}', '${userType}')" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: #20c997;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <button onclick="Utils.closeModal('uploadImageModal')" style="
                            padding: 12px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        Utils.openModal('uploadImageModal');
    }
}

function showUserActionsMenu(userId, userType) {
    const actions = [
        { label: 'View Details', icon: 'fa-eye', action: `viewUserDetails('${userId}', '${userType}')`, color: '#4dabf7' },
        { label: 'Edit User', icon: 'fa-edit', action: `showEditUserModal('${userId}', '${userType}')`, color: '#20c997' },
        { label: 'Activate User', icon: 'fa-check-circle', action: `activateUser('${userId}', '${userType}')`, color: '#40c057' },
        { label: 'Suspend User', icon: 'fa-pause-circle', action: `suspendUser('${userId}', '${userType}')`, color: '#ff922b' },
        { label: 'Ban User', icon: 'fa-ban', action: `banUser('${userId}', '${userType}')`, color: '#dc3545' },
        { label: 'Delete User', icon: 'fa-trash', action: `deleteUser('${userId}', '${userType}')`, color: '#dc3545' }
    ];
    
    const menu = document.createElement('div');
    menu.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999999;
        backdrop-filter: blur(5px);
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        max-width: 300px;
        width: 90%;
        animation: fadeIn 0.3s ease;
    `;
    
    dialog.innerHTML = `
        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">User Actions</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            ${actions.map(action => `
                <button onclick="${action.action}" style="
                    padding: 12px 15px;
                    background: ${action.color};
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    text-align: left;
                    width: 100%;
                ">
                    <i class="fas ${action.icon}"></i>
                    ${action.label}
                </button>
            `).join('')}
        </div>
        <div style="margin-top: 15px; text-align: center;">
            <button onclick="this.parentElement.parentElement.remove()" style="
                padding: 10px 20px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                width: 100%;
            ">
                Cancel
            </button>
        </div>
    `;
    
    menu.appendChild(dialog);
    document.body.appendChild(menu);
    
    menu.addEventListener('click', (e) => {
        if (e.target === menu) {
            menu.remove();
        }
    });
}

function loadLoanApplications(page = 1) {
    const statusFilter = document.getElementById('loanStatusFilter')?.value || 'all';
    const typeFilter = document.getElementById('loanTypeFilter')?.value || 'all';
    const dateFrom = document.getElementById('loanDateFrom')?.value || '';
    const dateTo = document.getElementById('loanDateTo')?.value || '';
    const searchTerm = document.getElementById('loanSearch')?.value || '';
    
    FirebaseService.loadLoanApplications(page, {
        status: statusFilter,
        loanType: typeFilter,
        dateFrom: dateFrom,
        dateTo: dateTo,
        search: searchTerm
    });
}

function loadAgents(page = 1) {
    const statusFilter = document.getElementById('agentStatusFilter')?.value || 'all';
    const searchTerm = document.getElementById('agentSearch')?.value || '';
    
    FirebaseService.loadAgents(page, {
        status: statusFilter,
        search: searchTerm
    });
}

function loadCustomers(page = 1) {
    const statusFilter = document.getElementById('customerStatusFilter')?.value || 'all';
    const searchTerm = document.getElementById('customerSearch')?.value || '';
    
    FirebaseService.loadCustomers(page, {
        status: statusFilter,
        search: searchTerm
    });
}

function loadAdmins(page = 1) {
    const roleFilter = document.getElementById('adminRoleFilter')?.value || 'all';
    const statusFilter = document.getElementById('adminStatusFilter')?.value || 'all';
    const searchTerm = document.getElementById('adminSearch')?.value || '';
    
    FirebaseService.loadAdmins(page, {
        role: roleFilter,
        status: statusFilter,
        search: searchTerm
    });
}

function loadSystemInfo() {
    const dbSizeEl = document.getElementById('dbSize');
    const storageUsageEl = document.getElementById('storageUsage');
    const systemUptimeEl = document.getElementById('systemUptime');
    const lastBackupEl = document.getElementById('lastBackup');
    
    if (dbSizeEl) dbSizeEl.textContent = 'Calculating...';
    if (storageUsageEl) storageUsageEl.textContent = 'Calculating...';
    if (systemUptimeEl) systemUptimeEl.textContent = '--';
    if (lastBackupEl) lastBackupEl.textContent = 'Never';
    
    setTimeout(() => {
        if (dbSizeEl) dbSizeEl.textContent = '~15.2 MB';
        if (storageUsageEl) storageUsageEl.textContent = '~45.8 MB';
        if (systemUptimeEl) systemUptimeEl.textContent = '7 days, 3 hours';
        if (lastBackupEl) lastBackupEl.textContent = 'Yesterday, 02:30 AM';
    }, 1000);
}

function filterLoans() {
    loadLoanApplications(1);
}

function filterAgents() {
    loadAgents(1);
}

function filterCustomers() {
    loadCustomers(1);
}

function filterAdmins() {
    loadAdmins(1);
}

function resetLoanFilters() {
    document.getElementById('loanStatusFilter').value = 'all';
    document.getElementById('loanTypeFilter').value = 'all';
    document.getElementById('loanDateFrom').value = '';
    document.getElementById('loanDateTo').value = '';
    document.getElementById('loanSearch').value = '';
    loadLoanApplications(1);
}

function resetAgentFilters() {
    document.getElementById('agentStatusFilter').value = 'all';
    document.getElementById('agentSearch').value = '';
    loadAgents(1);
}

function resetCustomerFilters() {
    document.getElementById('customerStatusFilter').value = 'all';
    document.getElementById('customerSearch').value = '';
    loadCustomers(1);
}

function resetAdminFilters() {
    document.getElementById('adminRoleFilter').value = 'all';
    document.getElementById('adminStatusFilter').value = 'all';
    document.getElementById('adminSearch').value = '';
    loadAdmins(1);
}

function changePage(type, page) {
    if (page < 1 || page > AppState.pagination[type].totalPages) return;
    
    switch(type) {
        case 'loans':
            loadLoanApplications(page);
            break;
        case 'agents':
            loadAgents(page);
            break;
        case 'customers':
            loadCustomers(page);
            break;
        case 'admins':
            loadAdmins(page);
            break;
    }
}

function generateNewPassword() {
    const passwordInput = document.getElementById('createPassword');
    if (passwordInput) {
        passwordInput.value = Utils.generatePassword(12);
    }
}

async function createUser(userType) {
    const fullName = document.getElementById('createFullName').value.trim();
    const email = document.getElementById('createEmail').value.trim();
    const phone = document.getElementById('createPhone').value.trim();
    const password = document.getElementById('createPassword').value;
    
    if (!fullName || !email || !phone || !password) {
        Utils.showNotification('Error', 'Please fill all required fields', 'error');
        return;
    }
    
    if (!Utils.validateEmail(email)) {
        Utils.showNotification('Error', 'Please enter a valid email address', 'error');
        return;
    }
    
    if (!Utils.validatePhone(phone)) {
        Utils.showNotification('Error', 'Please enter a valid Zambian phone number', 'error');
        return;
    }
    
    let userData = {
        fullName,
        email,
        phone,
        password
    };
    
    if (userType === 'agent') {
        const commissionRate = document.getElementById('createCommissionRate').value;
        userData.commissionRate = parseFloat(commissionRate);
    } else if (userType === 'admin') {
        const role = document.getElementById('createUserRole').value;
        userData.role = role;
        userData.userType = role;
    } else if (userType === 'customer') {
        const nrc = document.getElementById('createNRC').value.trim();
        const address = document.getElementById('createAddress').value.trim();
        const loanLimit = document.getElementById('createLoanLimit').value;
        
        if (nrc && !Utils.validateNRC(nrc)) {
            Utils.showNotification('Error', 'Please enter a valid NRC format (123456/78/9)', 'error');
            return;
        }
        
        userData.nrc = nrc;
        userData.address = address;
        userData.loanLimit = parseFloat(loanLimit);
    }
    
    await FirebaseService.createUser(userData, userType);
}

async function updateUser(userId, userType) {
    const fullName = document.getElementById('editFullName').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const status = document.getElementById('editUserStatus').value;
    
    if (!fullName || !email || !phone) {
        Utils.showNotification('Error', 'Please fill all required fields', 'error');
        return;
    }
    
    if (!Utils.validateEmail(email)) {
        Utils.showNotification('Error', 'Please enter a valid email address', 'error');
        return;
    }
    
    if (!Utils.validatePhone(phone)) {
        Utils.showNotification('Error', 'Please enter a valid Zambian phone number', 'error');
        return;
    }
    
    let updates = {
        fullName,
        email,
        phone,
        status
    };
    
    if (userType === 'agent') {
        const commissionRate = document.getElementById('editCommissionRate').value;
        const commissionEarned = document.getElementById('editCommissionEarned').value;
        updates.commissionRate = parseFloat(commissionRate);
        updates.commissionEarned = parseFloat(commissionEarned);
    } else if (userType === 'admin') {
        const role = document.getElementById('editUserRole').value;
        updates.userType = role;
    } else if (userType === 'customer') {
        const nrc = document.getElementById('editNRC').value.trim();
        const address = document.getElementById('editAddress').value.trim();
        const loanLimit = document.getElementById('editLoanLimit').value;
        const accountBalance = document.getElementById('editAccountBalance').value;
        
        if (nrc && !Utils.validateNRC(nrc)) {
            Utils.showNotification('Error', 'Please enter a valid NRC format (123456/78/9)', 'error');
            return;
        }
        
        updates.nrc = nrc;
        updates.address = address;
        updates.loanLimit = parseFloat(loanLimit);
        updates.accountBalance = parseFloat(accountBalance);
    }
    
    await FirebaseService.updateUser(userId, userType, updates);
}

async function processCreateLoan() {
    const customerEmail = document.getElementById('loanCustomerEmail').value.trim();
    const amount = document.getElementById('loanAmount').value;
    const duration = document.getElementById('loanDuration').value;
    const interestRate = document.getElementById('loanInterestRate').value;
    const loanType = document.getElementById('loanType').value;
    const purpose = document.getElementById('loanPurpose').value.trim();
    const agentEmail = document.getElementById('loanAgentEmail').value.trim();
    
    if (!customerEmail || !amount || !duration || !interestRate) {
        Utils.showNotification('Error', 'Please fill all required fields', 'error');
        return;
    }
    
    try {
        Utils.showLoading('Validating customer...');
        
        const usersRef = db.ref('users');
        const snapshot = await usersRef.once('value');
        const users = snapshot.val() || {};
        
        const customer = Object.values(users).find(u => u.email === customerEmail && u.userType === 'customer');
        
        if (!customer) {
            Utils.hideLoading();
            Utils.showNotification('Error', 'Customer not found. Please check the email address.', 'error');
            return;
        }
        
        let agent = null;
        if (agentEmail) {
            const agentData = Object.values(users).find(u => u.email === agentEmail && (u.userType === 'agent' || u.userType === 'admin'));
            if (agentData) {
                agent = agentData;
            }
        }
        
        const loanData = {
            customerId: customer.id,
            customerName: customer.fullName,
            customerEmail: customer.email,
            amount: parseFloat(amount),
            duration: parseInt(duration),
            interestRate: parseFloat(interestRate),
            loanType: loanType,
            purposeDescription: purpose
        };
        
        if (agent) {
            loanData.agentId = agent.id;
            loanData.agentName = agent.fullName;
        }
        
        Utils.hideLoading();
        await FirebaseService.createLoan(loanData);
        
    } catch (error) {
        Utils.hideLoading();
        Utils.showNotification('Error', `Failed to create loan: ${error.message}`, 'error');
    }
}

async function updateLoanData(loanId) {
    const amount = document.getElementById('editLoanAmount').value;
    const duration = document.getElementById('editLoanDuration').value;
    const interestRate = document.getElementById('editLoanInterestRate').value;
    const loanType = document.getElementById('editLoanType').value;
    const status = document.getElementById('editLoanStatus').value;
    const purpose = document.getElementById('editLoanPurpose').value.trim();
    
    if (!amount || !duration || !interestRate || !status) {
        Utils.showNotification('Error', 'Please fill all required fields', 'error');
        return;
    }
    
    const updates = {
        amount: parseFloat(amount),
        duration: parseInt(duration),
        interestRate: parseFloat(interestRate),
        loanType: loanType,
        status: status,
        purposeDescription: purpose
    };
    
    await FirebaseService.updateLoan(loanId, updates);
}

function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            Utils.showNotification('Error', 'File size must be less than 5MB', 'error');
            input.value = '';
            return;
        }
        
        if (!file.type.match('image.*')) {
            Utils.showNotification('Error', 'Please select an image file', 'error');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            preview.style.display = 'block';
        };
        
        reader.readAsDataURL(file);
    }
}

function uploadSelectedImage(userId, userType) {
    const input = document.getElementById('imageUpload');
    
    if (!input.files || !input.files[0]) {
        Utils.showNotification('Error', 'Please select an image first', 'error');
        return;
    }
    
    const file = input.files[0];
    FirebaseService.uploadImage(userId, userType, file);
}

function saveLoanSettings() {
    const defaultInterestRate = document.getElementById('defaultInterestRate').value;
    const maxLoanAmount = document.getElementById('maxLoanAmount').value;
    const minLoanAmount = document.getElementById('minLoanAmount').value;
    const defaultLoanDuration = document.getElementById('defaultLoanDuration').value;
    
    db.ref('systemSettings/loanSettings').set({
        defaultInterestRate: parseFloat(defaultInterestRate),
        maxLoanAmount: parseFloat(maxLoanAmount),
        minLoanAmount: parseFloat(minLoanAmount),
        defaultLoanDuration: parseInt(defaultLoanDuration),
        updatedAt: Date.now(),
        updatedBy: AppState.currentUser.uid
    }).then(() => {
        Utils.showNotification('Success', 'Loan settings saved successfully', 'success');
    }).catch(error => {
        Utils.showNotification('Error', 'Failed to save loan settings', 'error');
    });
}

function saveUserSettings() {
    const defaultCustomerLimit = document.getElementById('defaultCustomerLimit').value;
    const agentCommissionRate = document.getElementById('agentCommissionRate').value;
    const autoSuspendDays = document.getElementById('autoSuspendDays').value;
    const maxLoginAttempts = document.getElementById('maxLoginAttempts').value;
    
    db.ref('systemSettings/userSettings').set({
        defaultCustomerLimit: parseFloat(defaultCustomerLimit),
        agentCommissionRate: parseFloat(agentCommissionRate),
        autoSuspendDays: parseInt(autoSuspendDays),
        maxLoginAttempts: parseInt(maxLoginAttempts),
        updatedAt: Date.now(),
        updatedBy: AppState.currentUser.uid
    }).then(() => {
        Utils.showNotification('Success', 'User settings saved successfully', 'success');
    }).catch(error => {
        Utils.showNotification('Error', 'Failed to save user settings', 'error');
    });
}

function clearSystemCache() {
    Utils.confirmAction(
        'Clear System Cache',
        'Are you sure you want to clear all system cache? This will improve performance but may cause temporary slowdowns.',
        () => {
            Utils.showNotification('Success', 'System cache cleared successfully', 'success');
        }
    );
}

function backupDatabase() {
    Utils.showLoading('Creating database backup...');
    
    setTimeout(() => {
        Utils.hideLoading();
        Utils.showNotification('Success', 'Database backup created successfully', 'success');
    }, 2000);
}

function exportAllData() {
    Utils.showLoading('Preparing data export...');
    
    setTimeout(() => {
        Utils.hideLoading();
        
        const data = JSON.stringify({
            loans: AppState.loanApplications,
            agents: AppState.agents,
            customers: AppState.customers,
            admins: AppState.admins,
            timestamp: Date.now(),
            exportedBy: AppState.currentUser.email
        }, null, 2);
        
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sudo_export_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        Utils.showNotification('Success', 'Data exported successfully', 'success');
    }, 1500);
}

function runSystemDiagnostics() {
    Utils.showLoading('Running system diagnostics...');
    
    setTimeout(() => {
        Utils.hideLoading();
        Utils.showNotification('Diagnostics Complete', 'System is running optimally. No issues found.', 'success');
    }, 3000);
}

function purgeOldData() {
    Utils.confirmAction(
        'Purge Old Data',
        'Are you sure you want to purge old data? This will permanently delete data older than 1 year.',
        () => {
            Utils.showNotification('Success', 'Old data purged successfully', 'success');
        },
        null,
        'Purge',
        'Cancel',
        '#dc3545'
    );
}

function showSystemSettings() {
    SudoAuthService.showSection('system');
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    SudoAuthService.init();
    
    const style = document.createElement('style');
    style.textContent = `
        @media (max-width: 768px) {
            .sudo-navbar .nav-links {
                display: none;
            }
            
            .sudo-content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            #agentsGrid, #customersGrid, #adminsGrid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .sudo-navbar {
                padding: 10px 15px;
            }
            
            .nav-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
            }
            
            .user-info {
                display: none;
            }
        }
        
        #loanDetailsModal.active .modal-content,
        #userDetailsModal.active .modal-content,
        #createUserModal.active .modal-content,
        #createLoanModal.active .modal-content,
        #editLoanModal.active .modal-content,
        #uploadImageModal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        #imageModal.active {
            display: flex;
        }
    `;
    document.head.appendChild(style);
    
    window.Utils = Utils;
    window.FirebaseService = FirebaseService;
    window.SudoAuthService = SudoAuthService;
    window.viewLoanDetails = viewLoanDetails;
    window.viewUserDetails = viewUserDetails;
    window.approveLoan = approveLoan;
    window.rejectLoan = rejectLoan;
    window.deleteLoan = deleteLoan;
    window.suspendUser = suspendUser;
    window.banUser = banUser;
    window.deleteUser = deleteUser;
    window.activateUser = activateUser;
    window.viewImage = viewImage;
    window.loadLoanApplications = loadLoanApplications;
    window.loadAgents = loadAgents;
    window.loadCustomers = loadCustomers;
    window.loadAdmins = loadAdmins;
    window.filterLoans = filterLoans;
    window.filterAgents = filterAgents;
    window.filterCustomers = filterCustomers;
    window.filterAdmins = filterAdmins;
    window.resetLoanFilters = resetLoanFilters;
    window.resetAgentFilters = resetAgentFilters;
    window.resetCustomerFilters = resetCustomerFilters;
    window.resetAdminFilters = resetAdminFilters;
    window.changePage = changePage;
    window.showCreateUserModal = showCreateUserModal;
    window.showEditUserModal = showEditUserModal;
    window.showCreateLoanModal = showCreateLoanModal;
    window.showEditLoanModal = showEditLoanModal;
    window.showUploadImageModal = showUploadImageModal;
    window.showUserActionsMenu = showUserActionsMenu;
    window.createUser = createUser;
    window.updateUser = updateUser;
    window.generateNewPassword = generateNewPassword;
    window.processCreateLoan = processCreateLoan;
    window.updateLoanData = updateLoanData;
    window.previewImage = previewImage;
    window.uploadSelectedImage = uploadSelectedImage;
    window.saveLoanSettings = saveLoanSettings;
    window.saveUserSettings = saveUserSettings;
    window.clearSystemCache = clearSystemCache;
    window.backupDatabase = backupDatabase;
    window.exportAllData = exportAllData;
    window.runSystemDiagnostics = runSystemDiagnostics;
    window.purgeOldData = purgeOldData;
    window.showSystemSettings = showSystemSettings;
});
    </script>
</body>
</html>
