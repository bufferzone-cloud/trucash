<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TruCash</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- Cloudinary -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== MAC OS THEME ===== */
        :root {
            /* Mac OS Colors */
            --macos-white: #ffffff;
            --macos-gray-1: #f5f5f7;
            --macos-gray-2: #e8e8ed;
            --macos-gray-3: #d2d2d7;
            --macos-gray-4: #8e8e93;
            --macos-gray-5: #6c6c70;
            --macos-gray-6: #3a3a3c;
            --macos-black: #000000;
            
            /* Mac OS Accent Colors */
            --macos-blue: #007aff;
            --macos-green: #34c759;
            --macos-red: #ff3b30;
            --macos-orange: #ff9500;
            --macos-yellow: #ffcc00;
            --macos-purple: #af52de;
            --macos-pink: #ff2d55;
            
            /* UI Elements */
            --macos-sidebar: #f5f5f7;
            --macos-card: #ffffff;
            --macos-border: #e5e5e7;
            --macos-shadow: rgba(0, 0, 0, 0.1);
            --macos-text-primary: #000000;
            --macos-text-secondary: #6c6c70;
            --macos-text-tertiary: #8e8e93;
            
            /* Border Radius */
            --macos-radius-sm: 8px;
            --macos-radius-md: 12px;
            --macos-radius-lg: 18px;
            --macos-radius-xl: 24px;
            
            /* Shadows */
            --macos-shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.05);
            --macos-shadow-md: 0 4px 20px rgba(0, 0, 0, 0.08);
            --macos-shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            
            /* Transitions */
            --macos-transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--macos-white);
            color: var(--macos-text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: var(--macos-white);
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            background: var(--macos-sidebar);
            border-right: 1px solid var(--macos-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: var(--macos-transition);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .app-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }

        .nav-section {
            padding: 20px 0;
            border-bottom: 1px solid var(--macos-border);
        }

        .nav-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 24px 12px;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--macos-text-secondary);
            text-decoration: none;
            transition: var(--macos-transition);
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover {
            background: var(--macos-gray-1);
            color: var(--macos-text-primary);
        }

        .nav-item.active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
            border-left: 3px solid var(--macos-blue);
        }

        .nav-item i {
            width: 20px;
            font-size: 16px;
        }

        .nav-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--macos-border);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--macos-card);
            border-radius: var(--macos-radius-md);
            border: 1px solid var(--macos-border);
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--macos-blue);
        }

        .admin-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .admin-info p {
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: var(--macos-red);
            color: white;
            border: none;
            border-radius: var(--macos-radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: var(--macos-transition);
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: #ff1a1a;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 0;
            min-height: 100vh;
            background: var(--macos-white);
        }

        .top-bar {
            padding: 20px 30px;
            border-bottom: 1px solid var(--macos-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--macos-white);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-text-primary);
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-gray-4);
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-md);
            background: var(--macos-gray-1);
            font-size: 14px;
            transition: var(--macos-transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: var(--macos-white);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .stat-card {
            background: var(--macos-card);
            border-radius: var(--macos-radius-md);
            padding: 24px;
            border: 1px solid var(--macos-border);
            box-shadow: var(--macos-shadow-sm);
            transition: var(--macos-transition);
        }

        .stat-card:hover {
            box-shadow: var(--macos-shadow-md);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            color: var(--macos-text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--macos-text-primary);
            margin-bottom: 4px;
        }

        .stat-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up {
            color: var(--macos-green);
        }

        .trend-down {
            color: var(--macos-red);
        }

        /* ===== CONTENT SECTIONS ===== */
        .content-section {
            display: none;
            padding: 0 30px 30px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-top: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--macos-text-primary);
        }

        .section-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--macos-radius-md);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--macos-transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0056cc;
        }

        .btn-success {
            background: var(--macos-green);
            color: white;
        }

        .btn-success:hover {
            background: #2aab58;
        }

        .btn-danger {
            background: var(--macos-red);
            color: white;
        }

        .btn-danger:hover {
            background: #cc2a24;
        }

        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }

        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* ===== DATA TABLES ===== */
        .data-table-container {
            background: var(--macos-card);
            border-radius: var(--macos-radius-md);
            border: 1px solid var(--macos-border);
            overflow: hidden;
            box-shadow: var(--macos-shadow-sm);
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--macos-gray-1);
            border-bottom: 1px solid var(--macos-border);
        }

        .data-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            border-bottom: 1px solid var(--macos-border);
            transition: var(--macos-transition);
        }

        .data-table tbody tr:hover {
            background: rgba(0, 122, 255, 0.05);
        }

        .data-table td {
            padding: 16px;
            font-size: 14px;
            color: var(--macos-text-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }

        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }

        .status-approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }

        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }

        .status-suspended {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }

        .status-banned {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }

        .status-completed {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--macos-white);
            border-radius: var(--macos-radius-lg);
            box-shadow: var(--macos-shadow-lg);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--macos-text-tertiary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--macos-transition);
        }

        .modal-close:hover {
            background: var(--macos-gray-1);
            color: var(--macos-text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--macos-border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--macos-text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            transition: var(--macos-transition);
            background: var(--macos-white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            background: var(--macos-white);
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--macos-blue);
        }

        /* ===== DOCUMENT VIEWER ===== */
        .document-viewer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .document-card {
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius-md);
            overflow: hidden;
            border: 1px solid var(--macos-border);
        }

        .document-header {
            padding: 16px;
            background: var(--macos-card);
            border-bottom: 1px solid var(--macos-border);
        }

        .document-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }

        .document-preview {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .document-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--macos-radius-sm);
            box-shadow: var(--macos-shadow-sm);
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .document-image:hover {
            transform: scale(1.02);
            box-shadow: var(--macos-shadow-md);
        }

        .document-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--macos-blue);
            color: white;
            text-decoration: none;
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            transition: var(--macos-transition);
        }

        .document-link:hover {
            background: #0056cc;
        }

        /* ===== LOAN DETAILS ===== */
        .loan-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .loan-detail-card {
            background: var(--macos-gray-1);
            padding: 16px;
            border-radius: var(--macos-radius-md);
            border: 1px solid var(--macos-border);
        }

        .loan-detail-label {
            font-size: 12px;
            color: var(--macos-text-secondary);
            margin-bottom: 4px;
        }

        .loan-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                border-radius: var(--macos-radius-md);
                background: var(--macos-gray-1);
                border: none;
                cursor: pointer;
                font-size: 18px;
                color: var(--macos-text-primary);
            }
            
            .search-box {
                width: 200px;
            }
            
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                padding: 16px;
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .top-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .content-section {
                padding: 0 20px 20px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .section-actions {
                flex-wrap: wrap;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 10px;
                max-height: 80vh;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-value {
                font-size: 24px;
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .d-none {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--macos-text-tertiary);
        }

        .text-success {
            color: var(--macos-green);
        }

        .text-danger {
            color: var(--macos-red);
        }

        .text-warning {
            color: var(--macos-orange);
        }

        .mt-3 {
            margin-top: 16px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .p-3 {
            padding: 16px;
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 16px;
            color: var(--macos-text-primary);
            font-weight: 500;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .toast {
            background: var(--macos-card);
            border-radius: var(--macos-radius-md);
            border-left: 4px solid var(--macos-blue);
            box-shadow: var(--macos-shadow-lg);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.active {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            color: var(--macos-blue);
            font-size: 18px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--macos-text-primary);
        }

        .toast-message {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }

        .toast.success {
            border-left-color: var(--macos-green);
        }

        .toast.success .toast-icon {
            color: var(--macos-green);
        }

        .toast.error {
            border-left-color: var(--macos-red);
        }

        .toast.error .toast-icon {
            color: var(--macos-red);
        }

        .toast.warning {
            border-left-color: var(--macos-orange);
        }

        .toast.warning .toast-icon {
            color: var(--macos-orange);
        }

        /* ===== AGENT APPROVAL FORM ===== */
        .credential-form-group {
            margin-bottom: 20px;
        }

        .credential-display {
            background: var(--macos-gray-1);
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-md);
            padding: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            margin-top: 8px;
            word-break: break-all;
        }

        .credential-note {
            font-size: 12px;
            color: var(--macos-text-tertiary);
            margin-top: 4px;
        }

        /* ===== IMAGE MODAL ===== */
        .image-modal {
            background: rgba(0, 0, 0, 0.9);
        }

        .image-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .image-modal-body {
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .full-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: var(--macos-radius-sm);
        }

        /* ===== COMMISSION DISPLAY ===== */
        .commission-card {
            background: linear-gradient(135deg, var(--macos-purple), var(--macos-blue));
            color: white;
            padding: 24px;
            border-radius: var(--macos-radius-md);
            margin-bottom: 20px;
        }

        .commission-amount {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .commission-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid var(--macos-border);
        }

        .page-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--macos-radius-md);
            border: 1px solid var(--macos-border);
            background: var(--macos-white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .page-btn:hover {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }

        .page-btn.active {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .page-info {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--macos-text-tertiary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--macos-text-secondary);
        }

        /* ===== FILTERS ===== */
        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }

        /* ===== MOBILE MENU OVERLAY ===== */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .mobile-menu-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading Admin Panel...</div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo">TC</div>
                <div class="app-name">TruCash Admin</div>
            </div>

            <!-- Navigation -->
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <ul class="nav-list">
                    <li class="nav-item active" data-section="overview">
                        <i class="fas fa-chart-line"></i>
                        <span class="nav-text">Overview</span>
                    </li>
                    <li class="nav-item" data-section="loans">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span class="nav-text">Loan Approvals</span>
                        <span id="pendingLoansBadge" class="nav-badge" style="display: none;">0</span>
                    </li>
                    <li class="nav-item" data-section="agents">
                        <i class="fas fa-user-tie"></i>
                        <span class="nav-text">Agent Management</span>
                        <span id="pendingAgentsBadge" class="nav-badge" style="display: none;">0</span>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <div class="nav-title">Management</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="customers">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">Customer Management</span>
                    </li>
                    <li class="nav-item" data-section="assignments">
                        <i class="fas fa-handshake"></i>
                        <span class="nav-text">Assign Agents</span>
                    </li>
                    <li class="nav-item" data-section="commissions">
                        <i class="fas fa-money-check-alt"></i>
                        <span class="nav-text">Commissions</span>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="audit">
                        <i class="fas fa-history"></i>
                        <span class="nav-text">Audit Log</span>
                    </li>
                    <li class="nav-item" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span class="nav-text">Settings</span>
                    </li>
                </ul>
            </div>

            <!-- Footer -->
            <div class="sidebar-footer">
                <div class="admin-profile">
                    <img id="adminAvatar" src="https://ui-avatars.com/api/?name=Admin&background=007AFF&color=fff" class="admin-avatar" alt="Admin">
                    <div class="admin-info">
                        <h4 id="adminName">Admin User</h4>
                        <p id="adminEmail">admin@trucash.com</p>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Mobile Menu Overlay -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button id="mobileMenuToggle" class="mobile-menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="pageTitle" class="page-title">Overview</h1>
                </div>
                <div class="top-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" class="search-input" placeholder="Search everything...">
                    </div>
                    <div id="connectionStatus" class="status-badge status-active">
                        <i class="fas fa-circle"></i> Online
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div id="quickStatsSection" class="quick-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Loans</div>
                        <div class="stat-icon" style="background: var(--macos-blue);">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalLoans">0</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>12% from last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Active Agents</div>
                        <div class="stat-icon" style="background: var(--macos-green);">
                            <i class="fas fa-user-tie"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="activeAgents">0</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>8% from last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Customers</div>
                        <div class="stat-icon" style="background: var(--macos-purple);">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>15% from last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Revenue</div>
                        <div class="stat-icon" style="background: var(--macos-orange);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalRevenue">K0</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>20% from last month</span>
                    </div>
                </div>
            </div>

            <!-- Content Sections -->
            
            <!-- Overview Section -->
            <div id="overviewSection" class="content-section active">
                <div class="section-header">
                    <div class="section-title">Dashboard Overview</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="refreshDashboard">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 30px;">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Loan Status Distribution</div>
                        </div>
                        <div style="padding: 20px;">
                            <canvas id="loanStatusChart"></canvas>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Monthly Performance</div>
                        </div>
                        <div style="padding: 20px;">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Recent Activity</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" id="viewAllActivity">
                                View All
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div id="recentActivityList">
                            <!-- Activity items will be loaded here -->
                            <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                                <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                <p>Loading recent activity...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loan Approvals Section -->
            <div id="loansSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Loan Applications</div>
                    <div class="section-actions">
                        <div class="filters-bar">
                            <div class="filter-group">
                                <span class="filter-label">Status:</span>
                                <select id="loanFilter" class="form-select" style="width: 150px;">
                                    <option value="all">All Loans</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Date Range:</span>
                                <select id="dateFilter" class="form-select" style="width: 150px;">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="exportLoans">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Loan Applications</div>
                        <div class="table-actions">
                            <div class="search-box" style="width: 200px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="loanSearch" class="search-input" placeholder="Search loans...">
                            </div>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                        <h3>No Loan Applications</h3>
                                        <p>Loan applications will appear here when submitted</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                        <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                        <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- Agent Management Section -->
            <div id="agentsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Agent Management</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="createAgentBtn">
                            <i class="fas fa-user-plus"></i> Create Agent
                        </button>
                        <button class="btn btn-outline" id="viewPendingApps">
                            <i class="fas fa-clipboard-list"></i> Pending Applications
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">All Agents</div>
                        <div class="table-actions">
                            <div class="search-box" style="width: 200px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="agentSearch" class="search-input" placeholder="Search agents...">
                            </div>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Branch</th>
                                <th>Status</th>
                                <th>Customers</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i class="fas fa-user-tie"></i>
                                        <h3>No Agents Found</h3>
                                        <p>Agents will appear here when created</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Customer Management Section -->
            <div id="customersSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Customer Management</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="createCustomerBtn">
                            <i class="fas fa-user-plus"></i> Create Customer
                        </button>
                        <div class="filters-bar">
                            <div class="filter-group">
                                <span class="filter-label">Status:</span>
                                <select id="customerFilter" class="form-select" style="width: 150px;">
                                    <option value="all">All Customers</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">All Customers</div>
                        <div class="table-actions">
                            <div class="search-box" style="width: 200px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="customerSearch" class="search-input" placeholder="Search customers...">
                            </div>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Agent</th>
                                <th>Loans</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <h3>No Customers Found</h3>
                                        <p>Customers will appear here when created</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Assign Agents Section -->
            <div id="assignmentsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Agent Assignment</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="bulkAssignBtn">
                            <i class="fas fa-users-cog"></i> Bulk Assignment
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 30px;">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Unassigned Customers</div>
                        </div>
                        <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                            <div id="unassignedCustomersList">
                                <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                                    <i class="fas fa-user-check" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                    <p>No unassigned customers found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Available Agents</div>
                        </div>
                        <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                            <div id="availableAgentsList">
                                <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                                    <i class="fas fa-user-tie" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                    <p>No available agents found</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Current Assignments</div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Assigned On</th>
                                <th>Loans</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i class="fas fa-handshake"></i>
                                        <h3>No Assignments Found</h3>
                                        <p>Assignments will appear here when created</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Commissions Section -->
            <div id="commissionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Commission Management</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="processPayouts">
                            <i class="fas fa-money-check-alt"></i> Process Payouts
                        </button>
                        <button class="btn btn-outline" id="exportCommissions">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Commission Summary -->
                <div class="commission-card">
                    <div class="commission-amount" id="totalCommissions">K0.00</div>
                    <div class="commission-label">Total Commissions Payable</div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Commission Records</div>
                        <div class="table-actions">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <span class="filter-label">Status:</span>
                                    <select id="commissionFilter" class="form-select" style="width: 150px;">
                                        <option value="all">All Commissions</option>
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Customer</th>
                                <th>Loan ID</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commissionsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i class="fas fa-money-check-alt"></i>
                                        <h3>No Commissions Found</h3>
                                        <p>Commissions will appear here when earned</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Log Section -->
            <div id="auditSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Audit Log</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="exportAuditLog">
                            <i class="fas fa-file-export"></i> Export Log
                        </button>
                        <button class="btn btn-outline" id="clearOldLogs">
                            <i class="fas fa-trash"></i> Clear Old Logs
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">System Activity Log</div>
                        <div class="table-actions">
                            <div class="search-box" style="width: 200px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="auditSearch" class="search-input" placeholder="Search logs...">
                            </div>
                        </div>
                    </div>
                    <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                        <div id="auditLogList">
                            <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                                <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                <p>Loading audit log...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">System Settings</div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="saveSettings">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Loan Settings</div>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" id="interestRate" class="form-input" step="0.01" min="1" max="50" value="15">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount (ZMW)</label>
                                <input type="number" id="maxLoanAmount" class="form-input" min="100" value="50000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount (ZMW)</label>
                                <input type="number" id="minLoanAmount" class="form-input" min="50" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Loan Duration (Months)</label>
                                <input type="number" id="loanDuration" class="form-input" min="1" max="36" value="12">
                            </div>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Commission Settings</div>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label class="form-label">Agent Commission Rate (%)</label>
                                <input type="number" id="commissionRate" class="form-input" step="0.01" min="0" max="50" value="2.5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Onboarding Commission (ZMW)</label>
                                <input type="number" id="onboardingCommission" class="form-input" min="0" value="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payout Schedule</label>
                                <select id="payoutSchedule" class="form-select">
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">System Configuration</div>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label class="form-label">System Name</label>
                                <input type="text" id="systemName" class="form-input" value="TruCash Admin">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Currency</label>
                                <select id="defaultCurrency" class="form-select">
                                    <option value="ZMW">Zambian Kwacha (ZMW)</option>
                                    <option value="USD">US Dollar (USD)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Auto-approve Loans</label>
                                <select id="autoApproveLoans" class="form-select">
                                    <option value="false">No - Manual Approval</option>
                                    <option value="true">Yes - Auto Approve</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maintenance Mode</label>
                                <select id="maintenanceMode" class="form-select">
                                    <option value="false">Disabled</option>
                                    <option value="true">Enabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->

    <!-- Loan Details Modal -->
    <div id="loanDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Loan Details</h2>
                <button class="modal-close" onclick="ModalManager.closeLoanModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="loanDetailContent">
                    <!-- Loan details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeLoanModal()">Close</button>
                <button class="btn btn-primary" id="approveLoanBtn">Approve Loan</button>
                <button class="btn btn-danger" id="rejectLoanBtn">Reject Loan</button>
            </div>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div id="agentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agent Details</h2>
                <button class="modal-close" onclick="ModalManager.closeAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="agentDetailContent">
                    <!-- Agent details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeAgentModal()">Close</button>
                <button class="btn btn-danger" id="suspendAgentBtn">Suspend Agent</button>
                <button class="btn btn-danger" id="deleteAgentBtn">Delete Agent</button>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customerDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Customer Details</h2>
                <button class="modal-close" onclick="ModalManager.closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailContent">
                    <!-- Customer details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCustomerModal()">Close</button>
                <button class="btn btn-danger" id="suspendCustomerBtn">Suspend Customer</button>
                <button class="btn btn-danger" id="deleteCustomerBtn">Delete Customer</button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div id="createAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Agent</h2>
                <button class="modal-close" onclick="ModalManager.closeCreateAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createAgentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="agentFullName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" id="agentPhone" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" id="agentEmail" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agent ID *</label>
                            <input type="text" id="agentId" class="form-input" required>
                            <div class="credential-note">Manually assign a unique Agent ID</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" id="agentPassword" class="form-input" required>
                            <div class="credential-note">Manually set the agent's password</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" id="agentConfirmPassword" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Branch/Region</label>
                            <input type="text" id="agentBranch" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" id="agentCommissionRate" class="form-input" step="0.01" value="2.5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">NRC Number *</label>
                        <input type="text" id="agentNRC" class="form-input" placeholder="123456/78/9" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Residence Address</label>
                        <textarea id="agentAddress" class="form-input form-textarea"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="agentNotes" class="form-input form-textarea" placeholder="Any additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCreateAgentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="AgentManager.createAgent()">Create Agent</button>
            </div>
        </div>
    </div>

    <!-- Create Customer Modal -->
    <div id="createCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Customer</h2>
                <button class="modal-close" onclick="ModalManager.closeCreateCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createCustomerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="customerFullName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" id="customerEmail" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" id="customerPhone" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">NRC Number *</label>
                            <input type="text" id="customerNRC" class="form-input" placeholder="123456/78/9" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" id="customerPassword" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" id="customerConfirmPassword" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Residence Address *</label>
                        <textarea id="customerAddress" class="form-input form-textarea" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">House Number</label>
                            <input type="text" id="customerHouseNumber" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <input type="text" id="customerOccupation" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Monthly Income (ZMW)</label>
                        <input type="number" id="customerMonthlyIncome" class="form-input" min="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Assign to Agent</label>
                        <select id="assignAgentSelect" class="form-select">
                            <option value="">Select an agent (optional)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="customerNotes" class="form-input form-textarea" placeholder="Any additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCreateCustomerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="CustomerManager.createCustomer()">Create Customer</button>
            </div>
        </div>
    </div>

    <!-- Assign Agent Modal -->
    <div id="assignAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Agent to Customer</h2>
                <button class="modal-close" onclick="ModalManager.closeAssignAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="assignAgentContent">
                    <!-- Assignment form will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeAssignAgentModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmAssignBtn">Assign Agent</button>
            </div>
        </div>
    </div>

    <!-- Commission Details Modal -->
    <div id="commissionDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Commission Details</h2>
                <button class="modal-close" onclick="ModalManager.closeCommissionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="commissionDetailContent">
                    <!-- Commission details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCommissionModal()">Close</button>
                <button class="btn btn-success" id="payCommissionBtn">Mark as Paid</button>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentViewerModal" class="modal image-modal">
        <div class="modal-content image-modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="ModalManager.closeDocumentViewer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body image-modal-body">
                <img id="documentViewerImage" class="full-image" src="" alt="Document">
            </div>
        </div>
    </div>

    <!-- Pending Applications Modal -->
    <div id="pendingApplicationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Pending Agent Applications</h2>
                <button class="modal-close" onclick="ModalManager.closePendingApplicationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="pendingApplicationsList">
                    <!-- Pending applications will be loaded here -->
                    <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                        <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>Loading pending applications...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Application Modal -->
    <div id="approveApplicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Approve Agent Application</h2>
                <button class="modal-close" onclick="ModalManager.closeApproveApplicationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="approveApplicationContent">
                    <!-- Application details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeApproveApplicationModal()">Cancel</button>
                <button class="btn btn-success" onclick="AgentManager.approveApplication()">Approve & Create Agent</button>
            </div>
        </div>
    </div>

    <!-- Image Modal (for viewing larger images) -->
    <div id="imageModal" class="modal image-modal">
        <div class="modal-content image-modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="ModalManager.closeImageModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body image-modal-body">
                <img id="modalImage" class="full-image" src="" alt="Image">
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // ===== ENHANCED ADMIN PANEL SCRIPT =====

        // ===== CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx']
        };

        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            loans: [],
            agents: [],
            customers: [],
            commissions: [],
            agentApplications: [],
            auditLogs: [],
            systemSettings: null,
            currentSection: 'overview',
            pagination: {
                loans: { page: 1, limit: 10, total: 0, filtered: [] },
                agents: { page: 1, limit: 10, total: 0, filtered: [] },
                customers: { page: 1, limit: 10, total: 0, filtered: [] },
                commissions: { page: 1, limit: 10, total: 0, filtered: [] }
            },
            filters: {
                loans: { status: 'all', dateRange: 'all', search: '' },
                agents: { status: 'all', search: '' },
                customers: { status: 'all', search: '' },
                commissions: { status: 'all', search: '' }
            },
            selectedLoan: null,
            selectedAgent: null,
            selectedCustomer: null,
            selectedCommission: null,
            selectedApplication: null,
            charts: {},
            realtimeListeners: []
        };

        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                container.appendChild(toast);
                
                // Show with animation
                setTimeout(() => toast.classList.add('active'), 10);
                
                // Auto remove after duration
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            calculateCommission(loanAmount, commissionRate = 2.5) {
                return (loanAmount * commissionRate) / 100;
            },
            
            truncateText(text, maxLength = 30) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            getStatusColor(status) {
                switch(status) {
                    case 'pending': return 'var(--macos-orange)';
                    case 'active': 
                    case 'approved': return 'var(--macos-green)';
                    case 'rejected':
                    case 'banned': return 'var(--macos-red)';
                    case 'suspended': return 'var(--macos-orange)';
                    case 'completed': return 'var(--macos-blue)';
                    default: return 'var(--macos-gray-4)';
                }
            },
            
            calculateAge(birthDate) {
                if (!birthDate) return null;
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }
        };

        // ===== FIREBASE SERVICE =====
        const FirebaseService = {
            async checkAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        unsubscribe();
                        
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const userRef = db.ref('users/' + currentUser.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            // Only allow admin users
                            if (userData.userType !== 'admin' && userData.email !== 'sudo@gmail.com') {
                                Utils.showToast('Access Denied', 'This panel is for administrators only', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = currentUser;
                            AppState.adminData = userData;
                            
                            resolve(userData);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            window.location.href = 'login.html';
                            resolve(null);
                        }
                    }, (error) => {
                        console.error('Auth state listener error:', error);
                        window.location.href = 'login.html';
                        resolve(null);
                    });
                });
            },
            
            async loadAllLoans() {
                try {
                    Utils.showLoading('Loading loans...');
                    const loansRef = db.ref('loans');
                    const snapshot = await loansRef.once('value');
                    
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    // Sort by creation date (newest first)
                    loans.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    AppState.loans = loans;
                    AppState.pagination.loans.filtered = loans;
                    AppState.pagination.loans.total = loans.length;
                    
                    Utils.hideLoading();
                    return loans;
                } catch (error) {
                    console.error('Error loading loans:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loans', 'error');
                    return [];
                }
            },
            
            async loadAllAgents() {
                try {
                    const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                    const snapshot = await agentsRef.once('value');
                    
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    AppState.pagination.agents.filtered = agents;
                    AppState.pagination.agents.total = agents.length;
                    
                    return agents;
                } catch (error) {
                    console.error('Error loading agents:', error);
                    return [];
                }
            },
            
            async loadAllCustomers() {
                try {
                    const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                    const snapshot = await customersRef.once('value');
                    
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    AppState.pagination.customers.filtered = customers;
                    AppState.pagination.customers.total = customers.length;
                    
                    return customers;
                } catch (error) {
                    console.error('Error loading customers:', error);
                    return [];
                }
            },
            
            async loadCommissions() {
                try {
                    const commissionsRef = db.ref('commissions');
                    const snapshot = await commissionsRef.once('value');
                    
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    AppState.pagination.commissions.filtered = commissions;
                    AppState.pagination.commissions.total = commissions.length;
                    
                    return commissions;
                } catch (error) {
                    console.error('Error loading commissions:', error);
                    return [];
                }
            },
            
            async loadAgentApplications() {
                try {
                    const applicationsRef = db.ref('agentApplications');
                    const snapshot = await applicationsRef.once('value');
                    
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        if (application.status === 'pending') {
                            applications.push(application);
                        }
                    });
                    
                    AppState.agentApplications = applications;
                    return applications;
                } catch (error) {
                    console.error('Error loading agent applications:', error);
                    return [];
                }
            },
            
            async loadAuditLogs() {
                try {
                    const auditRef = db.ref('auditLogs');
                    const snapshot = await auditRef.once('value');
                    
                    const logs = [];
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        log.id = childSnapshot.key;
                        logs.push(log);
                    });
                    
                    // Sort by timestamp (newest first)
                    logs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    
                    AppState.auditLogs = logs.slice(0, 50); // Only keep recent 50 logs
                    return AppState.auditLogs;
                } catch (error) {
                    console.error('Error loading audit logs:', error);
                    return [];
                }
            },
            
            async loadSystemSettings() {
                try {
                    const settingsRef = db.ref('systemSettings');
                    const snapshot = await settingsRef.once('value');
                    
                    if (snapshot.exists()) {
                        AppState.systemSettings = snapshot.val();
                    } else {
                        // Default settings
                        AppState.systemSettings = {
                            interestRate: 15,
                            maxLoanAmount: 50000,
                            minLoanAmount: 100,
                            loanDuration: 12,
                            commissionRate: 2.5,
                            onboardingCommission: 50,
                            payoutSchedule: 'monthly',
                            systemName: 'TruCash Admin',
                            defaultCurrency: 'ZMW',
                            autoApproveLoans: false,
                            maintenanceMode: false
                        };
                        await settingsRef.set(AppState.systemSettings);
                    }
                    
                    return AppState.systemSettings;
                } catch (error) {
                    console.error('Error loading system settings:', error);
                    return null;
                }
            },
            
            async updateSystemSettings(settings) {
                try {
                    const settingsRef = db.ref('systemSettings');
                    await settingsRef.update(settings);
                    
                    AppState.systemSettings = { ...AppState.systemSettings, ...settings };
                    
                    return { success: true, message: 'Settings updated successfully' };
                } catch (error) {
                    console.error('Error updating settings:', error);
                    return { success: false, error: 'Failed to update settings' };
                }
            },
            
            async approveLoan(loanId, adminId, adminName) {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    
                    // Update loan status
                    await loanRef.update({
                        status: 'approved',
                        approvedAt: Date.now(),
                        approvedBy: adminId,
                        approvedByName: adminName,
                        updatedAt: Date.now()
                    });
                    
                    // Create commission record for agent
                    const loanSnapshot = await loanRef.once('value');
                    const loan = loanSnapshot.val();
                    
                    if (loan.agentId) {
                        const commissionId = Utils.generateId('COM');
                        const commissionRef = db.ref('commissions/' + commissionId);
                        
                        const commission = {
                            id: commissionId,
                            agentId: loan.agentId,
                            agentName: loan.agentName,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            loanId: loanId,
                            loanAmount: loan.amount,
                            type: 'loan_approval',
                            amount: Utils.calculateCommission(loan.amount, AppState.systemSettings?.commissionRate || 2.5),
                            status: 'pending',
                            createdAt: Date.now(),
                            dueDate: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days from now
                        };
                        
                        await commissionRef.set(commission);
                    }
                    
                    // Create audit log
                    await this.createAuditLog('loan_approved', {
                        loanId: loanId,
                        customerId: loan.customerId,
                        customerName: loan.customerName,
                        amount: loan.amount,
                        adminId: adminId,
                        adminName: adminName
                    });
                    
                    // Create notification for customer
                    await this.createNotification(loan.customerId, 'loan_approved', {
                        loanId: loanId,
                        amount: loan.amount,
                        timestamp: Date.now()
                    });
                    
                    // Create notification for agent if exists
                    if (loan.agentId) {
                        await this.createNotification(loan.agentId, 'loan_approved_agent', {
                            loanId: loanId,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            amount: loan.amount,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: 'Loan approved successfully' };
                } catch (error) {
                    console.error('Error approving loan:', error);
                    return { success: false, error: 'Failed to approve loan' };
                }
            },
            
            async rejectLoan(loanId, adminId, adminName, reason = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    
                    await loanRef.update({
                        status: 'rejected',
                        rejectedAt: Date.now(),
                        rejectedBy: adminId,
                        rejectedByName: adminName,
                        rejectionReason: reason,
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('loan_rejected', {
                        loanId: loanId,
                        adminId: adminId,
                        adminName: adminName,
                        reason: reason
                    });
                    
                    // Create notification for customer
                    const loanSnapshot = await loanRef.once('value');
                    const loan = loanSnapshot.val();
                    
                    await this.createNotification(loan.customerId, 'loan_rejected', {
                        loanId: loanId,
                        reason: reason,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Loan rejected successfully' };
                } catch (error) {
                    console.error('Error rejecting loan:', error);
                    return { success: false, error: 'Failed to reject loan' };
                }
            },
            
            async createAgent(agentData) {
                try {
                    // Create Firebase Auth account with manually assigned email and password
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.address,
                        userType: 'agent',
                        agentId: agentData.customAgentId, // Manually assigned agent ID
                        status: 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        branch: agentData.branch || '',
                        commissionRate: parseFloat(agentData.commissionRate) || 2.5,
                        isApproved: true,
                        approvedBy: AppState.adminData.fullName,
                        approvedAt: Date.now(),
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0,
                        profilePhoto: agentData.profilePhoto || '',
                        nrcFront: agentData.nrcFront || '',
                        nrcBack: agentData.nrcBack || ''
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Also save to agents collection for easy querying
                    await db.ref('agents/' + agentId).set({
                        agentId: agentData.customAgentId,
                        email: agentData.email,
                        fullName: agentData.fullName,
                        phone: agentData.phone,
                        status: 'active',
                        createdAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_created', {
                        agentId: agentId,
                        agentName: agentData.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        customAgentId: agentData.customAgentId
                    });
                    
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    
                    let errorMessage = 'Failed to create agent';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateAgentStatus(agentId, status, reason = '') {
                try {
                    const agentRef = db.ref('users/' + agentId);
                    
                    await agentRef.update({
                        status: status,
                        updatedAt: Date.now(),
                        statusReason: reason,
                        updatedByAdmin: AppState.adminData.fullName,
                        statusUpdatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_status_updated', {
                        agentId: agentId,
                        status: status,
                        reason: reason,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: `Agent status updated to ${status}` };
                } catch (error) {
                    console.error('Error updating agent status:', error);
                    return { success: false, error: 'Failed to update agent status' };
                }
            },
            
            async deleteAgent(agentId) {
                try {
                    // First, unassign all customers from this agent
                    const customersRef = db.ref('users').orderByChild('assignedAgentId').equalTo(agentId);
                    const customersSnapshot = await customersRef.once('value');
                    
                    const updates = {};
                    customersSnapshot.forEach((childSnapshot) => {
                        updates[`users/${childSnapshot.key}/assignedAgentId`] = null;
                        updates[`users/${childSnapshot.key}/updatedAt`] = Date.now();
                    });
                    
                    // Remove agent from users collection
                    updates[`users/${agentId}`] = null;
                    
                    // Remove from agents collection
                    updates[`agents/${agentId}`] = null;
                    
                    // Delete Firebase Auth account (this would require Cloud Functions in production)
                    // For now, we just disable the account in the database
                    
                    await db.ref().update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('agent_deleted', {
                        agentId: agentId,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: 'Agent deleted successfully' };
                } catch (error) {
                    console.error('Error deleting agent:', error);
                    return { success: false, error: 'Failed to delete agent' };
                }
            },
            
            async createCustomer(customerData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        customerData.password
                    );
                    
                    const customerId = userCredential.user.uid;
                    
                    // Prepare customer document
                    const customerDoc = {
                        uid: customerId,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        nrc: customerData.nrc,
                        residence: customerData.address,
                        houseNumber: customerData.houseNumber,
                        occupation: customerData.occupation || '',
                        monthlyIncome: customerData.monthlyIncome || 0,
                        userType: 'customer',
                        status: 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        verified: true,
                        accountBalance: 0,
                        totalLoans: 0,
                        activeLoans: 0,
                        assignedAgentId: customerData.assignedAgentId || null,
                        createdByAdmin: AppState.adminData.fullName,
                        profilePhoto: customerData.profilePhoto || '',
                        nrcFront: customerData.nrcFront || '',
                        nrcBack: customerData.nrcBack || ''
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + customerId).set(customerDoc);
                    
                    // If assigned to agent, update agent's customer count
                    if (customerData.assignedAgentId) {
                        const agentRef = db.ref('users/' + customerData.assignedAgentId);
                        await agentRef.update({
                            totalCustomers: firebase.database.ServerValue.increment(1),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('customer_created', {
                        customerId: customerId,
                        customerName: customerData.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return {
                        success: true,
                        customerId: customerId,
                        message: 'Customer created successfully'
                    };
                } catch (error) {
                    console.error('Error creating customer:', error);
                    
                    let errorMessage = 'Failed to create customer';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateCustomerStatus(customerId, status, reason = '') {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    
                    await customerRef.update({
                        status: status,
                        updatedAt: Date.now(),
                        statusReason: reason,
                        updatedByAdmin: AppState.adminData.fullName,
                        statusUpdatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('customer_status_updated', {
                        customerId: customerId,
                        status: status,
                        reason: reason,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: `Customer status updated to ${status}` };
                } catch (error) {
                    console.error('Error updating customer status:', error);
                    return { success: false, error: 'Failed to update customer status' };
                }
            },
            
            async deleteCustomer(customerId) {
                try {
                    // Check if customer has active loans
                    const loansRef = db.ref('loans').orderByChild('customerId').equalTo(customerId);
                    const loansSnapshot = await loansRef.once('value');
                    
                    let hasActiveLoans = false;
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        if (loan.status === 'active' || loan.status === 'pending') {
                            hasActiveLoans = true;
                        }
                    });
                    
                    if (hasActiveLoans) {
                        return { 
                            success: false, 
                            error: 'Cannot delete customer with active or pending loans' 
                        };
                    }
                    
                    // Get customer data to check assigned agent
                    const customerRef = db.ref('users/' + customerId);
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    // Remove customer from users collection
                    await customerRef.remove();
                    
                    // If assigned to agent, update agent's customer count
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        await agentRef.update({
                            totalCustomers: firebase.database.ServerValue.increment(-1),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('customer_deleted', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: 'Customer deleted successfully' };
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    return { success: false, error: 'Failed to delete customer' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId, agentName) {
                try {
                    // Get current assignment
                    const customerRef = db.ref('users/' + customerId);
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    const oldAgentId = customer.assignedAgentId;
                    
                    // Update customer
                    await customerRef.update({
                        assignedAgentId: agentId,
                        assignedAgentName: agentName,
                        updatedAt: Date.now(),
                        assignedByAdmin: AppState.adminData.fullName,
                        assignedAt: Date.now()
                    });
                    
                    // Update old agent's customer count (if exists)
                    if (oldAgentId && oldAgentId !== agentId) {
                        const oldAgentRef = db.ref('users/' + oldAgentId);
                        await oldAgentRef.update({
                            totalCustomers: firebase.database.ServerValue.increment(-1),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Update new agent's customer count
                    const newAgentRef = db.ref('users/' + agentId);
                    await newAgentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_assigned', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        agentId: agentId,
                        agentName: agentName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    // Create notification for customer
                    await this.createNotification(customerId, 'agent_assigned', {
                        agentId: agentId,
                        agentName: agentName,
                        timestamp: Date.now()
                    });
                    
                    // Create notification for agent
                    await this.createNotification(agentId, 'customer_assigned', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async updateCommissionStatus(commissionId, status, paymentDetails = {}) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedByAdmin: AppState.adminData.fullName
                    };
                    
                    if (status === 'paid') {
                        updates.paidAt = Date.now();
                        updates.paymentDetails = paymentDetails;
                        
                        // Update agent's total commission
                        const commissionSnapshot = await commissionRef.once('value');
                        const commission = commissionSnapshot.val();
                        
                        const agentRef = db.ref('users/' + commission.agentId);
                        await agentRef.update({
                            totalCommission: firebase.database.ServerValue.increment(commission.amount),
                            updatedAt: Date.now()
                        });
                    }
                    
                    await commissionRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('commission_updated', {
                        commissionId: commissionId,
                        status: status,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: `Commission marked as ${status}` };
                } catch (error) {
                    console.error('Error updating commission:', error);
                    return { success: false, error: 'Failed to update commission' };
                }
            },
            
            async approveAgentApplication(applicationId, credentials) {
                try {
                    // Get application details
                    const applicationRef = db.ref('agentApplications/' + applicationId);
                    const applicationSnapshot = await applicationRef.once('value');
                    const application = applicationSnapshot.val();
                    
                    // Create agent account
                    const agentResult = await this.createAgent({
                        fullName: application.fullName,
                        email: credentials.email,
                        password: credentials.password,
                        phone: application.phone,
                        nrc: application.nrc,
                        address: application.residence,
                        customAgentId: credentials.agentId,
                        branch: application.branch || '',
                        commissionRate: 2.5,
                        profilePhoto: application.profilePhoto || '',
                        nrcFront: application.nrcFront || '',
                        nrcBack: application.nrcBack || ''
                    });
                    
                    if (!agentResult.success) {
                        throw new Error(agentResult.error);
                    }
                    
                    // Update application status
                    await applicationRef.update({
                        status: 'approved',
                        reviewedAt: Date.now(),
                        reviewedBy: AppState.adminData.fullName,
                        assignedCredentials: credentials,
                        agentId: agentResult.agentId
                    });
                    
                    // Remove from pending applications
                    await db.ref('pendingApplications/' + applicationId).remove();
                    
                    return { 
                        success: true, 
                        message: 'Agent application approved and account created successfully' 
                    };
                } catch (error) {
                    console.error('Error approving application:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName,
                        userRole: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    // Add to local state
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 50) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 50);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createNotification(userId, type, data) {
                try {
                    const notificationId = Utils.generateId('NOT');
                    const notificationRef = db.ref('notifications/' + userId + '/' + notificationId);
                    
                    const notification = {
                        id: notificationId,
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        read: false,
                        priority: 'medium'
                    };
                    
                    await notificationRef.set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return null;
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.loans = [];
                    AppState.agents = [];
                    AppState.customers = [];
                    AppState.commissions = [];
                    AppState.agentApplications = [];
                    AppState.auditLogs = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    Utils.showToast('Logout Error', 'Failed to sign out properly', 'error');
                }
            },
            
            setupRealtimeListeners() {
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    AppState.loans = loans;
                    
                    // Update UI based on current section
                    if (AppState.currentSection === 'loans') {
                        UIManager.updateLoansUI();
                    }
                    if (AppState.currentSection === 'overview') {
                        UIManager.updateDashboardUI();
                    }
                    
                    // Update badges
                    UIManager.updateNavBadges();
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Agents listener
                const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    
                    if (AppState.currentSection === 'agents') {
                        UIManager.updateAgentsUI();
                    }
                    if (AppState.currentSection === 'assignments') {
                        UIManager.updateAssignmentsUI();
                    }
                    if (AppState.currentSection === 'overview') {
                        UIManager.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Customers listener
                const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                const customersListener = customersRef.on('value', (snapshot) => {
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    
                    if (AppState.currentSection === 'customers') {
                        UIManager.updateCustomersUI();
                    }
                    if (AppState.currentSection === 'assignments') {
                        UIManager.updateAssignmentsUI();
                    }
                    if (AppState.currentSection === 'overview') {
                        UIManager.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => customersRef.off('value', customersListener));
                
                // Commissions listener
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    
                    if (AppState.currentSection === 'commissions') {
                        UIManager.updateCommissionsUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Pending applications listener
                const pendingRef = db.ref('pendingApplications');
                const pendingListener = pendingRef.on('value', (snapshot) => {
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    AppState.agentApplications = applications;
                    UIManager.updateNavBadges();
                });
                
                AppState.realtimeListeners.push(() => pendingRef.off('value', pendingListener));
            }
        };

        // ===== UI MANAGER =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupResponsive();
                this.setupCharts();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.mobileMenuToggle = document.getElementById('mobileMenuToggle');
                this.mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
                
                // Stats
                this.totalLoans = document.getElementById('totalLoans');
                this.activeAgents = document.getElementById('activeAgents');
                this.totalCustomers = document.getElementById('totalCustomers');
                this.totalRevenue = document.getElementById('totalRevenue');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                this.createAgentBtn = document.getElementById('createAgentBtn');
                this.createCustomerBtn = document.getElementById('createCustomerBtn');
                this.viewPendingApps = document.getElementById('viewPendingApps');
                this.refreshDashboard = document.getElementById('refreshDashboard');
                
                // Tables
                this.loansTableBody = document.getElementById('loansTableBody');
                this.agentsTableBody = document.getElementById('agentsTableBody');
                this.customersTableBody = document.getElementById('customersTableBody');
                this.commissionsTableBody = document.getElementById('commissionsTableBody');
                this.assignmentsTableBody = document.getElementById('assignmentsTableBody');
                
                // Search and filters
                this.globalSearch = document.getElementById('globalSearch');
                this.loanSearch = document.getElementById('loanSearch');
                this.agentSearch = document.getElementById('agentSearch');
                this.customerSearch = document.getElementById('customerSearch');
                
                // Admin info
                this.adminName = document.getElementById('adminName');
                this.adminEmail = document.getElementById('adminEmail');
                this.adminAvatar = document.getElementById('adminAvatar');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Close mobile menu
                        if (window.innerWidth <= 1024) {
                            document.getElementById('sidebar').classList.remove('active');
                            this.mobileMenuOverlay.classList.remove('active');
                        }
                    });
                });
                
                // Mobile menu
                this.mobileMenuToggle.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.add('active');
                    this.mobileMenuOverlay.classList.add('active');
                });
                
                this.mobileMenuOverlay.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('active');
                    this.mobileMenuOverlay.classList.remove('active');
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Create agent
                this.createAgentBtn.addEventListener('click', () => {
                    AgentManager.showCreateAgentModal();
                });
                
                // Create customer
                this.createCustomerBtn.addEventListener('click', () => {
                    CustomerManager.showCreateCustomerModal();
                });
                
                // View pending applications
                this.viewPendingApps.addEventListener('click', () => {
                    AgentManager.showPendingApplicationsModal();
                });
                
                // Refresh dashboard
                this.refreshDashboard.addEventListener('click', () => {
                    this.updateDashboardUI();
                });
                
                // Search functionality
                this.setupSearchHandlers();
                
                // Filter functionality
                this.setupFilterHandlers();
                
                // Online/offline detection
                window.addEventListener('online', this.updateConnectionStatus);
                window.addEventListener('offline', this.updateConnectionStatus);
            },
            
            setupResponsive() {
                const handleResize = () => {
                    if (window.innerWidth > 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                        this.mobileMenuOverlay.classList.remove('active');
                    }
                };
                
                window.addEventListener('resize', handleResize);
            },
            
            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                if (navigator.onLine) {
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> Online';
                    statusElement.style.background = 'var(--macos-green)';
                    statusElement.style.color = 'white';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> Offline';
                    statusElement.style.background = 'var(--macos-red)';
                    statusElement.style.color = 'white';
                    Utils.showToast('Connection Lost', 'You are offline. Some features may not work.', 'warning');
                }
            },
            
            setupSearchHandlers() {
                // Global search
                this.globalSearch.addEventListener('input', Utils.debounce(() => {
                    this.performGlobalSearch();
                }, 500));
                
                // Loan search
                this.loanSearch.addEventListener('input', Utils.debounce(() => {
                    AppState.filters.loans.search = this.loanSearch.value.trim().toLowerCase();
                    this.filterLoans();
                }, 300));
                
                // Agent search
                this.agentSearch.addEventListener('input', Utils.debounce(() => {
                    AppState.filters.agents.search = this.agentSearch.value.trim().toLowerCase();
                    this.filterAgents();
                }, 300));
                
                // Customer search
                this.customerSearch.addEventListener('input', Utils.debounce(() => {
                    AppState.filters.customers.search = this.customerSearch.value.trim().toLowerCase();
                    this.filterCustomers();
                }, 300));
            },
            
            setupFilterHandlers() {
                // Loan filters
                document.getElementById('loanFilter').addEventListener('change', (e) => {
                    AppState.filters.loans.status = e.target.value;
                    this.filterLoans();
                });
                
                document.getElementById('dateFilter').addEventListener('change', (e) => {
                    AppState.filters.loans.dateRange = e.target.value;
                    this.filterLoans();
                });
                
                // Customer filter
                document.getElementById('customerFilter').addEventListener('change', (e) => {
                    AppState.filters.customers.status = e.target.value;
                    this.filterCustomers();
                });
                
                // Commission filter
                document.getElementById('commissionFilter').addEventListener('change', (e) => {
                    AppState.filters.commissions.status = e.target.value;
                    this.filterCommissions();
                });
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Load initial data
                    await this.loadInitialData();
                    
                    // Setup real-time listeners
                    FirebaseService.setupRealtimeListeners();
                    
                    // Update UI
                    this.updateAdminProfileUI();
                    this.updateDashboardUI();
                    this.updateNavBadges();
                    
                    Utils.hideLoading();
                    
                    // Show welcome
                    Utils.showToast('Welcome Admin', 
                        `Hello ${adminData.fullName || 'Admin'}!`, 
                        'success');
                    
                } catch (error) {
                    console.error('Authentication initialization error:', error);
                    Utils.hideLoading();
                    Utils.showToast('Authentication Error', 'Failed to authenticate. Please try again.', 'error');
                }
            },
            
            async loadInitialData() {
                await FirebaseService.loadAllLoans();
                await FirebaseService.loadAllAgents();
                await FirebaseService.loadAllCustomers();
                await FirebaseService.loadCommissions();
                await FirebaseService.loadAgentApplications();
                await FirebaseService.loadAuditLogs();
                await FirebaseService.loadSystemSettings();
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Update page title
                const titles = {
                    overview: 'Overview',
                    loans: 'Loan Approvals',
                    agents: 'Agent Management',
                    customers: 'Customer Management',
                    assignments: 'Assign Agents',
                    commissions: 'Commissions',
                    audit: 'Audit Log',
                    settings: 'Settings'
                };
                
                document.getElementById('pageTitle').textContent = titles[sectionId] || 'Admin Panel';
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                }
                
                // Load section data
                switch(sectionId) {
                    case 'overview':
                        this.updateDashboardUI();
                        break;
                    case 'loans':
                        this.updateLoansUI();
                        break;
                    case 'agents':
                        this.updateAgentsUI();
                        break;
                    case 'customers':
                        this.updateCustomersUI();
                        break;
                    case 'assignments':
                        this.updateAssignmentsUI();
                        break;
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                    case 'audit':
                        this.updateAuditUI();
                        break;
                    case 'settings':
                        this.updateSettingsUI();
                        break;
                }
            },
            
            updateAdminProfileUI() {
                if (!AppState.adminData) return;
                
                this.adminName.textContent = AppState.adminData.fullName || 'Admin User';
                this.adminEmail.textContent = AppState.adminData.email || 'admin@trucash.com';
                
                if (AppState.adminData.profilePhoto) {
                    this.adminAvatar.src = AppState.adminData.profilePhoto;
                }
            },
            
            updateDashboardUI() {
                // Update stats
                this.totalLoans.textContent = AppState.loans.length;
                
                const activeAgentsCount = AppState.agents.filter(a => a.status === 'active').length;
                this.activeAgents.textContent = activeAgentsCount;
                
                this.totalCustomers.textContent = AppState.customers.length;
                
                // Calculate total revenue from completed loans
                const totalRevenue = AppState.loans
                    .filter(l => l.status === 'completed')
                    .reduce((sum, loan) => sum + (loan.totalInterest || 0), 0);
                this.totalRevenue.textContent = Utils.formatCurrency(totalRevenue);
                
                // Update charts
                this.updateCharts();
                
                // Update recent activity
                this.updateRecentActivity();
            },
            
            updateNavBadges() {
                // Pending loans badge
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const pendingLoansBadge = document.getElementById('pendingLoansBadge');
                if (pendingLoansBadge) {
                    pendingLoansBadge.textContent = pendingLoans;
                    pendingLoansBadge.style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                }
                
                // Pending agents badge
                const pendingAgents = AppState.agentApplications.length;
                const pendingAgentsBadge = document.getElementById('pendingAgentsBadge');
                if (pendingAgentsBadge) {
                    pendingAgentsBadge.textContent = pendingAgents;
                    pendingAgentsBadge.style.display = pendingAgents > 0 ? 'inline-block' : 'none';
                }
            },
            
            updateLoansUI() {
                this.filterLoans();
            },
            
            filterLoans() {
                let filtered = [...AppState.loans];
                
                // Apply status filter
                if (AppState.filters.loans.status !== 'all') {
                    filtered = filtered.filter(loan => loan.status === AppState.filters.loans.status);
                }
                
                // Apply date range filter
                if (AppState.filters.loans.dateRange !== 'all') {
                    const now = new Date();
                    let startDate;
                    
                    switch(AppState.filters.loans.dateRange) {
                        case 'today':
                            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            break;
                    }
                    
                    if (startDate) {
                        filtered = filtered.filter(loan => loan.createdAt >= startDate.getTime());
                    }
                }
                
                // Apply search filter
                if (AppState.filters.loans.search) {
                    filtered = filtered.filter(loan => 
                        (loan.id && loan.id.toLowerCase().includes(AppState.filters.loans.search)) ||
                        (loan.customerName && loan.customerName.toLowerCase().includes(AppState.filters.loans.search)) ||
                        (loan.agentName && loan.agentName.toLowerCase().includes(AppState.filters.loans.search)) ||
                        (loan.purpose && loan.purpose.toLowerCase().includes(AppState.filters.loans.search))
                    );
                }
                
                AppState.pagination.loans.filtered = filtered;
                AppState.pagination.loans.total = filtered.length;
                
                this.renderLoansTable();
            },
            
            renderLoansTable() {
                const startIndex = (AppState.pagination.loans.page - 1) * AppState.pagination.loans.limit;
                const endIndex = startIndex + AppState.pagination.loans.limit;
                const pageLoans = AppState.pagination.loans.filtered.slice(startIndex, endIndex);
                
                if (pageLoans.length === 0) {
                    this.loansTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <h3>No Loans Found</h3>
                                    <p>Try adjusting your filters or search criteria</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                pageLoans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id || 'N/A'}</strong></td>
                            <td>${loan.customerName || 'Unknown'}</td>
                            <td>${loan.agentName || 'Not assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn btn-success btn-small" onclick="LoanManager.approveLoan('${loan.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="LoanManager.rejectLoan('${loan.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                this.loansTableBody.innerHTML = html;
                
                // Update pagination
                this.updatePagination('loans');
            },
            
            updateAgentsUI() {
                this.filterAgents();
            },
            
            filterAgents() {
                let filtered = [...AppState.agents];
                
                // Apply search filter
                if (AppState.filters.agents.search) {
                    filtered = filtered.filter(agent => 
                        (agent.agentId && agent.agentId.toLowerCase().includes(AppState.filters.agents.search)) ||
                        (agent.fullName && agent.fullName.toLowerCase().includes(AppState.filters.agents.search)) ||
                        (agent.email && agent.email.toLowerCase().includes(AppState.filters.agents.search)) ||
                        (agent.phone && agent.phone.toLowerCase().includes(AppState.filters.agents.search))
                    );
                }
                
                AppState.pagination.agents.filtered = filtered;
                AppState.pagination.agents.total = filtered.length;
                
                this.renderAgentsTable();
            },
            
            renderAgentsTable() {
                const startIndex = (AppState.pagination.agents.page - 1) * AppState.pagination.agents.limit;
                const endIndex = startIndex + AppState.pagination.agents.limit;
                const pageAgents = AppState.pagination.agents.filtered.slice(startIndex, endIndex);
                
                if (pageAgents.length === 0) {
                    this.agentsTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-user-tie"></i>
                                    <h3>No Agents Found</h3>
                                    <p>Try adjusting your search criteria</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                pageAgents.forEach(agent => {
                    const statusClass = `status-${agent.status}`;
                    const statusText = agent.status.charAt(0).toUpperCase() + agent.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${agent.agentId || 'N/A'}</strong></td>
                            <td>${agent.fullName}</td>
                            <td>${agent.email}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agent.branch || 'Main'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="AgentManager.viewAgentDetails('${agent.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="AgentManager.suspendAgent('${agent.id}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                this.agentsTableBody.innerHTML = html;
            },
            
            updateCustomersUI() {
                this.filterCustomers();
            },
            
            filterCustomers() {
                let filtered = [...AppState.customers];
                
                // Apply status filter
                if (AppState.filters.customers.status !== 'all') {
                    filtered = filtered.filter(customer => customer.status === AppState.filters.customers.status);
                }
                
                // Apply search filter
                if (AppState.filters.customers.search) {
                    filtered = filtered.filter(customer => 
                        (customer.id && customer.id.toLowerCase().includes(AppState.filters.customers.search)) ||
                        (customer.fullName && customer.fullName.toLowerCase().includes(AppState.filters.customers.search)) ||
                        (customer.email && customer.email.toLowerCase().includes(AppState.filters.customers.search)) ||
                        (customer.phone && customer.phone.toLowerCase().includes(AppState.filters.customers.search)) ||
                        (customer.nrc && customer.nrc.toLowerCase().includes(AppState.filters.customers.search))
                    );
                }
                
                AppState.pagination.customers.filtered = filtered;
                AppState.pagination.customers.total = filtered.length;
                
                this.renderCustomersTable();
            },
            
            renderCustomersTable() {
                const startIndex = (AppState.pagination.customers.page - 1) * AppState.pagination.customers.limit;
                const endIndex = startIndex + AppState.pagination.customers.limit;
                const pageCustomers = AppState.pagination.customers.filtered.slice(startIndex, endIndex);
                
                if (pageCustomers.length === 0) {
                    this.customersTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>No Customers Found</h3>
                                    <p>Try adjusting your filters or search criteria</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                pageCustomers.forEach(customer => {
                    const statusClass = `status-${customer.status}`;
                    const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                    
                    // Find agent name
                    let agentName = 'Not assigned';
                    if (customer.assignedAgentId) {
                        const agent = AppState.agents.find(a => a.id === customer.assignedAgentId);
                        if (agent) {
                            agentName = agent.fullName;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${customer.id.substring(0, 8)}...</strong></td>
                            <td>${customer.fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone || 'N/A'}</td>
                            <td>${agentName}</td>
                            <td>${customer.activeLoans || 0}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="CustomerManager.viewCustomerDetails('${customer.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    <button class="btn btn-primary btn-small" onclick="AssignmentManager.showAssignModal('${customer.id}')">
                                        <i class="fas fa-user-tie"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                this.customersTableBody.innerHTML = html;
            },
            
            updateAssignmentsUI() {
                this.renderUnassignedCustomers();
                this.renderAvailableAgents();
                this.renderAssignmentsTable();
            },
            
            renderUnassignedCustomers() {
                const unassignedCustomers = AppState.customers.filter(c => !c.assignedAgentId);
                const container = document.getElementById('unassignedCustomersList');
                
                if (unassignedCustomers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--macos-text-tertiary);">
                            <i class="fas fa-user-check" style="font-size: 24px; margin-bottom: 8px; opacity: 0.3;"></i>
                            <p>All customers are assigned to agents</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                unassignedCustomers.slice(0, 5).forEach(customer => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--macos-border);">
                            <div>
                                <div style="font-weight: 500;">${customer.fullName}</div>
                                <div style="font-size: 12px; color: var(--macos-text-tertiary);">${customer.email}</div>
                            </div>
                            <button class="btn btn-primary btn-small" onclick="AssignmentManager.showAssignModal('${customer.id}')">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            renderAvailableAgents() {
                const availableAgents = AppState.agents.filter(a => a.status === 'active');
                const container = document.getElementById('availableAgentsList');
                
                if (availableAgents.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--macos-text-tertiary);">
                            <i class="fas fa-user-tie" style="font-size: 24px; margin-bottom: 8px; opacity: 0.3;"></i>
                            <p>No active agents available</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                availableAgents.slice(0, 5).forEach(agent => {
                    const customerCount = AppState.customers.filter(c => c.assignedAgentId === agent.id).length;
                    
                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid var(--macos-border);">
                            <div style="font-weight: 500;">${agent.fullName}</div>
                            <div style="font-size: 12px; color: var(--macos-text-tertiary);">
                                <div>ID: ${agent.agentId}</div>
                                <div>Customers: ${customerCount}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            renderAssignmentsTable() {
                const assignedCustomers = AppState.customers.filter(c => c.assignedAgentId);
                const container = this.assignmentsTableBody;
                
                if (assignedCustomers.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-handshake"></i>
                                    <h3>No Assignments Found</h3>
                                    <p>Assign agents to customers to see assignments here</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                assignedCustomers.forEach(customer => {
                    const agent = AppState.agents.find(a => a.id === customer.assignedAgentId);
                    const agentName = agent ? agent.fullName : 'Unknown Agent';
                    
                    html += `
                        <tr>
                            <td>${customer.fullName}</td>
                            <td>${agentName}</td>
                            <td>${customer.assignedAt ? Utils.formatDateOnly(customer.assignedAt) : 'N/A'}</td>
                            <td>${customer.activeLoans || 0}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="AssignmentManager.showAssignModal('${customer.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="AssignmentManager.removeAssignment('${customer.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateCommissionsUI() {
                this.filterCommissions();
            },
            
            filterCommissions() {
                let filtered = [...AppState.commissions];
                
                // Apply status filter
                if (AppState.filters.commissions.status !== 'all') {
                    filtered = filtered.filter(commission => commission.status === AppState.filters.commissions.status);
                }
                
                AppState.pagination.commissions.filtered = filtered;
                AppState.pagination.commissions.total = filtered.length;
                
                this.renderCommissionsTable();
                
                // Update total commissions
                const totalCommissions = filtered
                    .filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                document.getElementById('totalCommissions').textContent = Utils.formatCurrency(totalCommissions);
            },
            
            renderCommissionsTable() {
                const startIndex = (AppState.pagination.commissions.page - 1) * AppState.pagination.commissions.limit;
                const endIndex = startIndex + AppState.pagination.commissions.limit;
                const pageCommissions = AppState.pagination.commissions.filtered.slice(startIndex, endIndex);
                
                if (pageCommissions.length === 0) {
                    this.commissionsTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-money-check-alt"></i>
                                    <h3>No Commissions Found</h3>
                                    <p>Try adjusting your filters</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                pageCommissions.forEach(commission => {
                    const statusClass = `status-${commission.status}`;
                    const statusText = commission.status.charAt(0).toUpperCase() + commission.status.slice(1);
                    
                    html += `
                        <tr>
                            <td>${commission.agentName}</td>
                            <td>${commission.customerName}</td>
                            <td><strong>${commission.loanId || 'N/A'}</strong></td>
                            <td>${Utils.formatCurrency(commission.amount)}</td>
                            <td>${commission.type || 'loan_approval'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${commission.dueDate ? Utils.formatDateOnly(commission.dueDate) : 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="CommissionManager.viewCommissionDetails('${commission.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${commission.status === 'pending' ? `
                                        <button class="btn btn-success btn-small" onclick="CommissionManager.markAsPaid('${commission.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                this.commissionsTableBody.innerHTML = html;
            },
            
            updateAuditUI() {
                const container = document.getElementById('auditLogList');
                const logs = AppState.auditLogs;
                
                if (logs.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <p>No audit logs found</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                logs.forEach(log => {
                    let actionText = '';
                    let details = '';
                    
                    switch(log.action) {
                        case 'loan_approved':
                            actionText = 'Loan Approved';
                            details = `${log.data.loanId} - ${log.data.customerName}`;
                            break;
                        case 'loan_rejected':
                            actionText = 'Loan Rejected';
                            details = `${log.data.loanId}`;
                            break;
                        case 'agent_created':
                            actionText = 'Agent Created';
                            details = `${log.data.agentName} (ID: ${log.data.customAgentId})`;
                            break;
                        case 'customer_created':
                            actionText = 'Customer Created';
                            details = `${log.data.customerName}`;
                            break;
                        case 'agent_assigned':
                            actionText = 'Agent Assigned';
                            details = `${log.data.agentName}  ${log.data.customerName}`;
                            break;
                        default:
                            actionText = log.action.replace(/_/g, ' ');
                            details = JSON.stringify(log.data);
                    }
                    
                    html += `
                        <div style="display: flex; align-items: flex-start; padding: 16px; border-bottom: 1px solid var(--macos-border);">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--macos-gray-1); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-history" style="color: var(--macos-blue);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; margin-bottom: 4px;">${actionText}</div>
                                <div style="font-size: 13px; color: var(--macos-text-secondary); margin-bottom: 4px;">${details}</div>
                                <div style="font-size: 12px; color: var(--macos-text-tertiary);">
                                    By ${log.userName}  ${Utils.formatDate(log.timestamp)}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateSettingsUI() {
                if (!AppState.systemSettings) return;
                
                const settings = AppState.systemSettings;
                
                document.getElementById('interestRate').value = settings.interestRate || 15;
                document.getElementById('maxLoanAmount').value = settings.maxLoanAmount || 50000;
                document.getElementById('minLoanAmount').value = settings.minLoanAmount || 100;
                document.getElementById('loanDuration').value = settings.loanDuration || 12;
                document.getElementById('commissionRate').value = settings.commissionRate || 2.5;
                document.getElementById('onboardingCommission').value = settings.onboardingCommission || 50;
                document.getElementById('payoutSchedule').value = settings.payoutSchedule || 'monthly';
                document.getElementById('systemName').value = settings.systemName || 'TruCash Admin';
                document.getElementById('defaultCurrency').value = settings.defaultCurrency || 'ZMW';
                document.getElementById('autoApproveLoans').value = settings.autoApproveLoans ? 'true' : 'false';
                document.getElementById('maintenanceMode').value = settings.maintenanceMode ? 'true' : 'false';
            },
            
            updateCharts() {
                // Loan Status Chart
                const loanStatusCtx = document.getElementById('loanStatusChart');
                if (loanStatusCtx) {
                    const statusCounts = {
                        pending: AppState.loans.filter(l => l.status === 'pending').length,
                        approved: AppState.loans.filter(l => l.status === 'approved').length,
                        active: AppState.loans.filter(l => l.status === 'active').length,
                        completed: AppState.loans.filter(l => l.status === 'completed').length,
                        rejected: AppState.loans.filter(l => l.status === 'rejected').length
                    };
                    
                    if (AppState.charts.loanStatus) {
                        AppState.charts.loanStatus.destroy();
                    }
                    
                    AppState.charts.loanStatus = new Chart(loanStatusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Pending', 'Approved', 'Active', 'Completed', 'Rejected'],
                            datasets: [{
                                data: [
                                    statusCounts.pending,
                                    statusCounts.appended,
                                    statusCounts.active,
                                    statusCounts.completed,
                                    statusCounts.rejected
                                ],
                                backgroundColor: [
                                    'var(--macos-orange)',
                                    'var(--macos-green)',
                                    'var(--macos-blue)',
                                    'var(--macos-purple)',
                                    'var(--macos-red)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
                
                // Performance Chart
                const performanceCtx = document.getElementById('performanceChart');
                if (performanceCtx) {
                    // Generate sample monthly data
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    const loanData = [12000, 19000, 15000, 25000, 22000, 30000];
                    const revenueData = [2400, 3800, 3000, 5000, 4400, 6000];
                    
                    if (AppState.charts.performance) {
                        AppState.charts.performance.destroy();
                    }
                    
                    AppState.charts.performance = new Chart(performanceCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Loans Disbursed',
                                    data: loanData,
                                    borderColor: 'var(--macos-blue)',
                                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Revenue',
                                    data: revenueData,
                                    borderColor: 'var(--macos-green)',
                                    backgroundColor: 'rgba(52, 199, 89, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            },
            
            updateRecentActivity() {
                const container = document.getElementById('recentActivityList');
                const recentLogs = AppState.auditLogs.slice(0, 5);
                
                if (recentLogs.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--macos-text-tertiary);">
                            <i class="fas fa-history" style="font-size: 24px; margin-bottom: 8px; opacity: 0.3;"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                recentLogs.forEach(log => {
                    let icon = 'history';
                    let color = 'var(--macos-blue)';
                    let actionText = '';
                    
                    switch(log.action) {
                        case 'loan_approved':
                            icon = 'file-invoice-dollar';
                            color = 'var(--macos-green)';
                            actionText = 'Loan approved';
                            break;
                        case 'loan_rejected':
                            icon = 'file-invoice-dollar';
                            color = 'var(--macos-red)';
                            actionText = 'Loan rejected';
                            break;
                        case 'agent_created':
                            icon = 'user-tie';
                            color = 'var(--macos-purple)';
                            actionText = 'Agent created';
                            break;
                        case 'customer_created':
                            icon = 'user-plus';
                            color = 'var(--macos-blue)';
                            actionText = 'Customer created';
                            break;
                        case 'agent_assigned':
                            icon = 'handshake';
                            color = 'var(--macos-orange)';
                            actionText = 'Agent assigned';
                            break;
                    }
                    
                    html += `
                        <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--macos-border);">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: ${color}20; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-${icon}" style="color: ${color}; font-size: 14px;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500;">${actionText}</div>
                                <div style="font-size: 12px; color: var(--macos-text-tertiary);">
                                    ${Utils.formatDate(log.timestamp)}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updatePagination(type) {
                const pagination = AppState.pagination[type];
                const totalPages = Math.ceil(pagination.total / pagination.limit);
                
                // Update page info
                document.getElementById('currentPage').textContent = pagination.page;
                document.getElementById('totalPages').textContent = totalPages;
                
                // Update button states
                document.getElementById('prevPage').disabled = pagination.page <= 1;
                document.getElementById('nextPage').disabled = pagination.page >= totalPages;
            },
            
            performGlobalSearch() {
                const searchTerm = this.globalSearch.value.trim().toLowerCase();
                
                if (!searchTerm) return;
                
                // Search across all data
                const results = {
                    loans: AppState.loans.filter(loan => 
                        (loan.id && loan.id.toLowerCase().includes(searchTerm)) ||
                        (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                        (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm))
                    ),
                    agents: AppState.agents.filter(agent => 
                        (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm)) ||
                        (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm)) ||
                        (agent.email && agent.email.toLowerCase().includes(searchTerm))
                    ),
                    customers: AppState.customers.filter(customer => 
                        (customer.id && customer.id.toLowerCase().includes(searchTerm)) ||
                        (customer.fullName && customer.fullName.toLowerCase().includes(searchTerm)) ||
                        (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                        (customer.nrc && customer.nrc.toLowerCase().includes(searchTerm))
                    )
                };
                
                // Show results in a modal or switch to appropriate section
                if (results.loans.length > 0) {
                    this.showSection('loans');
                    AppState.filters.loans.search = searchTerm;
                    this.filterLoans();
                } else if (results.agents.length > 0) {
                    this.showSection('agents');
                    AppState.filters.agents.search = searchTerm;
                    this.filterAgents();
                } else if (results.customers.length > 0) {
                    this.showSection('customers');
                    AppState.filters.customers.search = searchTerm;
                    this.filterCustomers();
                } else {
                    Utils.showToast('Search', 'No results found', 'info');
                }
            },
            
            setupCharts() {
                // Initialize empty charts
                this.updateCharts();
            }
        };

        // ===== LOAN MANAGER =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    // Get customer details
                    const customerRef = db.ref('users/' + loan.customerId);
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    // Get agent details if exists
                    let agent = null;
                    if (loan.agentId) {
                        const agentRef = db.ref('users/' + loan.agentId);
                        const agentSnapshot = await agentRef.once('value');
                        agent = agentSnapshot.val();
                    }
                    
                    this.displayLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loan details', 'error');
                }
            },
            
            displayLoanModal(loan, customer, agent) {
                AppState.selectedLoan = loan;
                
                const modal = document.getElementById('loanDetailModal');
                const content = document.getElementById('loanDetailContent');
                
                const statusClass = `status-${loan.status}`;
                const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                
                // Calculate commission
                const commissionAmount = Utils.calculateCommission(loan.amount, AppState.systemSettings?.commissionRate || 2.5);
                
                // Prepare document viewer
                let documentsHTML = '';
                if (loan.documents) {
                    documentsHTML = `
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 16px;">Uploaded Documents</h4>
                            <div class="document-viewer">
                                ${loan.documents.nrcFront ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">NRC Front</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${loan.documents.nrcFront}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${loan.documents.nrcFront}', 'NRC Front')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${loan.documents.nrcBack ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">NRC Back</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${loan.documents.nrcBack}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${loan.documents.nrcBack}', 'NRC Back')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${loan.documents.profilePhoto ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">Profile Photo</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${loan.documents.profilePhoto}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${loan.documents.profilePhoto}', 'Profile Photo')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${loan.collateral && loan.collateral.images && loan.collateral.images.length > 0 ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">Collateral Images (${loan.collateral.images.length})</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${loan.collateral.images[0]}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${loan.collateral.images[0]}', 'Collateral')">
                                            ${loan.collateral.images.length > 1 ? `
                                                <div style="position: absolute; top: 8px; right: 8px; background: var(--macos-blue); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                                    +${loan.collateral.images.length - 1}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="loan-detail-view">
                        <div class="section-header" style="margin-bottom: 24px;">
                            <div>
                                <h3 style="margin-bottom: 4px;">Loan ${loan.id}</h3>
                                <p style="color: var(--macos-text-secondary);">${loan.customerName}</p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Loan Amount</div>
                                <div class="loan-detail-value">${Utils.formatCurrency(loan.amount)}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Interest Rate</div>
                                <div class="loan-detail-value">${loan.interestRate || 15}%</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Duration</div>
                                <div class="loan-detail-value">${loan.duration} months</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Monthly Payment</div>
                                <div class="loan-detail-value">${Utils.formatCurrency(loan.monthlyPayment)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Loan Details</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div style="margin-bottom: 8px;"><strong>Purpose:</strong> ${loan.purpose || 'Not specified'}</div>
                                <div style="margin-bottom: 8px;"><strong>Applied:</strong> ${Utils.formatDate(loan.createdAt)}</div>
                                ${loan.approvedAt ? `<div style="margin-bottom: 8px;"><strong>Approved:</strong> ${Utils.formatDate(loan.approvedAt)} by ${loan.approvedByName || 'Admin'}</div>` : ''}
                                ${loan.rejectionReason ? `<div style="margin-bottom: 8px;"><strong>Rejection Reason:</strong> ${loan.rejectionReason}</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Customer Information</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div style="margin-bottom: 8px;"><strong>Name:</strong> ${customer.fullName}</div>
                                <div style="margin-bottom: 8px;"><strong>NRC:</strong> ${customer.nrc || 'Not provided'}</div>
                                <div style="margin-bottom: 8px;"><strong>Phone:</strong> ${customer.phone || 'Not provided'}</div>
                                <div style="margin-bottom: 8px;"><strong>Email:</strong> ${customer.email || 'Not provided'}</div>
                                ${customer.nrcFront ? `
                                    <div style="margin-top: 12px;">
                                        <a href="${customer.nrcFront}" target="_blank" class="document-link">
                                            <i class="fas fa-id-card"></i> View Customer NRC
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${agent ? `
                            <div style="margin: 24px 0;">
                                <h4 style="margin-bottom: 16px;">Agent Information</h4>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                    <div style="margin-bottom: 8px;"><strong>Name:</strong> ${agent.fullName}</div>
                                    <div style="margin-bottom: 8px;"><strong>Agent ID:</strong> ${agent.agentId}</div>
                                    <div style="margin-bottom: 8px;"><strong>Phone:</strong> ${agent.phone || 'Not provided'}</div>
                                    <div style="margin-bottom: 8px;"><strong>Email:</strong> ${agent.email || 'Not provided'}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Commission</h4>
                            <div class="commission-card">
                                <div class="commission-amount">${Utils.formatCurrency(commissionAmount)}</div>
                                <div class="commission-label">Agent Commission (${AppState.systemSettings?.commissionRate || 2.5}%)</div>
                            </div>
                        </div>
                        
                        ${documentsHTML}
                    </div>
                `;
                
                // Update button visibility based on loan status
                const approveBtn = document.getElementById('approveLoanBtn');
                const rejectBtn = document.getElementById('rejectLoanBtn');
                
                if (loan.status === 'pending') {
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                } else {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                }
                
                // Update button event handlers
                approveBtn.onclick = () => this.approveLoan(loan.id);
                rejectBtn.onclick = () => this.showRejectModal(loan.id);
                
                modal.classList.add('active');
            },
            
            async approveLoan(loanId) {
                if (!confirm('Are you sure you want to approve this loan?')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Approving loan...');
                    
                    const result = await FirebaseService.approveLoan(
                        loanId,
                        AppState.currentUser.uid,
                        AppState.adminData.fullName
                    );
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeLoanModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error approving loan:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to approve loan', 'error');
                }
            },
            
            showRejectModal(loanId) {
                const reason = prompt('Please enter the reason for rejection:', '');
                
                if (reason === null) return;
                
                if (!reason.trim()) {
                    Utils.showToast('Error', 'Please enter a rejection reason', 'error');
                    return;
                }
                
                this.rejectLoan(loanId, reason);
            },
            
            async rejectLoan(loanId, reason) {
                try {
                    Utils.showLoading('Rejecting loan...');
                    
                    const result = await FirebaseService.rejectLoan(
                        loanId,
                        AppState.currentUser.uid,
                        AppState.adminData.fullName,
                        reason
                    );
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeLoanModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error rejecting loan:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to reject loan', 'error');
                }
            }
        };

        // ===== AGENT MANAGER =====
        const AgentManager = {
            showCreateAgentModal() {
                ModalManager.closeAllModals();
                document.getElementById('createAgentModal').classList.add('active');
            },
            
            async createAgent() {
                const formData = {
                    fullName: document.getElementById('agentFullName').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    customAgentId: document.getElementById('agentId').value.trim(),
                    password: document.getElementById('agentPassword').value,
                    confirmPassword: document.getElementById('agentConfirmPassword').value,
                    nrc: document.getElementById('agentNRC').value.trim(),
                    address: document.getElementById('agentAddress').value.trim(),
                    branch: document.getElementById('agentBranch').value.trim(),
                    commissionRate: document.getElementById('agentCommissionRate').value,
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!formData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(formData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(formData.phone)) errors.push('Valid phone number is required');
                if (!formData.customAgentId) errors.push('Agent ID is required');
                if (!Utils.validateNRC(formData.nrc)) errors.push('Valid NRC (123456/78/9) is required');
                if (formData.password.length < 6) errors.push('Password must be at least 6 characters');
                if (formData.password !== formData.confirmPassword) errors.push('Passwords do not match');
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                try {
                    Utils.showLoading('Creating agent account...');
                    
                    const result = await FirebaseService.createAgent(formData);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeCreateAgentModal();
                        
                        // Reset form
                        document.getElementById('createAgentForm').reset();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error creating agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to create agent', 'error');
                }
            },
            
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    agent.id = agentId;
                    
                    // Get agent's customers
                    const customersRef = db.ref('users').orderByChild('assignedAgentId').equalTo(agentId);
                    const customersSnapshot = await customersRef.once('value');
                    const customers = [];
                    customersSnapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        if (customer.userType === 'customer') {
                            customers.push(customer);
                        }
                    });
                    
                    // Get agent's loans
                    const loansRef = db.ref('loans').orderByChild('agentId').equalTo(agentId);
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    // Get agent's commissions
                    const commissionsRef = db.ref('commissions').orderByChild('agentId').equalTo(agentId);
                    const commissionsSnapshot = await commissionsRef.once('value');
                    const commissions = [];
                    commissionsSnapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    this.displayAgentModal(agent, customers, loans, commissions);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load agent details', 'error');
                }
            },
            
            displayAgentModal(agent, customers, loans, commissions) {
                AppState.selectedAgent = agent;
                
                const modal = document.getElementById('agentDetailModal');
                const content = document.getElementById('agentDetailContent');
                
                const statusClass = `status-${agent.status}`;
                const statusText = agent.status.charAt(0).toUpperCase() + agent.status.slice(1);
                
                // Calculate total commission
                const totalCommission = commissions
                    .filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                const pendingCommission = commissions
                    .filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                let documentsHTML = '';
                if (agent.nrcFront || agent.nrcBack || agent.profilePhoto) {
                    documentsHTML = `
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 16px;">Agent Documents</h4>
                            <div class="document-viewer">
                                ${agent.nrcFront ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">NRC Front</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${agent.nrcFront}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${agent.nrcFront}', 'NRC Front')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${agent.nrcBack ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">NRC Back</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${agent.nrcBack}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${agent.nrcBack}', 'NRC Back')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${agent.profilePhoto ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">Profile Photo</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${agent.profilePhoto}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${agent.profilePhoto}', 'Profile Photo')">
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="agent-detail-view">
                        <div class="section-header" style="margin-bottom: 24px;">
                            <div>
                                <h3 style="margin-bottom: 4px;">${agent.fullName}</h3>
                                <p style="color: var(--macos-text-secondary);">Agent ID: ${agent.agentId}</p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Email</div>
                                <div class="loan-detail-value">${agent.email}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Phone</div>
                                <div class="loan-detail-value">${agent.phone || 'N/A'}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">NRC</div>
                                <div class="loan-detail-value">${agent.nrc || 'N/A'}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Branch</div>
                                <div class="loan-detail-value">${agent.branch || 'Main'}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Performance Statistics</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm); text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--macos-blue);">${customers.length}</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Customers</div>
                                </div>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm); text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--macos-green);">${loans.length}</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Loans</div>
                                </div>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm); text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--macos-purple);">${Utils.formatCurrency(totalCommission)}</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Commission Earned</div>
                                </div>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm); text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--macos-orange);">${Utils.formatCurrency(pendingCommission)}</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Pending Commission</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Agent Information</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div style="margin-bottom: 8px;"><strong>Address:</strong> ${agent.residence || 'Not provided'}</div>
                                <div style="margin-bottom: 8px;"><strong>Commission Rate:</strong> ${agent.commissionRate || 2.5}%</div>
                                <div style="margin-bottom: 8px;"><strong>Joined:</strong> ${Utils.formatDate(agent.createdAt)}</div>
                                ${agent.approvedBy ? `<div style="margin-bottom: 8px;"><strong>Approved By:</strong> ${agent.approvedBy}</div>` : ''}
                                ${agent.statusReason ? `<div style="margin-bottom: 8px;"><strong>Status Reason:</strong> ${agent.statusReason}</div>` : ''}
                            </div>
                        </div>
                        
                        ${documentsHTML}
                    </div>
                `;
                
                // Update button event handlers
                document.getElementById('suspendAgentBtn').onclick = () => this.suspendAgent(agent.id);
                document.getElementById('deleteAgentBtn').onclick = () => this.deleteAgent(agent.id);
                
                modal.classList.add('active');
            },
            
            async suspendAgent(agentId) {
                const status = prompt('Enter new status (suspended/banned/active):', 'suspended');
                
                if (!status || !['suspended', 'banned', 'active'].includes(status.toLowerCase())) {
                    Utils.showToast('Error', 'Invalid status. Use: suspended, banned, or active', 'error');
                    return;
                }
                
                const reason = prompt('Enter reason for status change:', '');
                
                if (reason === null) return;
                
                try {
                    Utils.showLoading('Updating agent status...');
                    
                    const result = await FirebaseService.updateAgentStatus(agentId, status.toLowerCase(), reason);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeAgentModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error suspending agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to update agent status', 'error');
                }
            },
            
            async deleteAgent(agentId) {
                if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Deleting agent...');
                    
                    const result = await FirebaseService.deleteAgent(agentId);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeAgentModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error deleting agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to delete agent', 'error');
                }
            },
            
            async showPendingApplicationsModal() {
                ModalManager.closeAllModals();
                
                try {
                    Utils.showLoading('Loading applications...');
                    
                    await FirebaseService.loadAgentApplications();
                    
                    const modal = document.getElementById('pendingApplicationsModal');
                    const container = document.getElementById('pendingApplicationsList');
                    
                    if (AppState.agentApplications.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                                <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                <p>No pending applications</p>
                            </div>
                        `;
                    } else {
                        let html = '';
                        AppState.agentApplications.forEach(app => {
                            html += `
                                <div style="margin-bottom: 16px; padding: 16px; border: 1px solid var(--macos-border); border-radius: var(--macos-radius-sm);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                        <div>
                                            <div style="font-weight: 600; margin-bottom: 4px;">${app.fullName}</div>
                                            <div style="font-size: 14px; color: var(--macos-text-secondary);">${app.phone}</div>
                                        </div>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                    <div style="font-size: 14px; color: var(--macos-text-secondary); margin-bottom: 12px;">
                                        <div><strong>NRC:</strong> ${app.nrc}</div>
                                        <div><strong>Address:</strong> ${app.residence}</div>
                                        <div><strong>Applied:</strong> ${Utils.formatDate(app.submittedAt)}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-outline btn-small" style="flex: 1;" onclick="AgentManager.viewApplication('${app.id}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                        <button class="btn btn-success btn-small" style="flex: 1;" onclick="AgentManager.showApproveModal('${app.id}')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    }
                    
                    Utils.hideLoading();
                    modal.classList.add('active');
                } catch (error) {
                    console.error('Error loading applications:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load applications', 'error');
                }
            },
            
            async viewApplication(applicationId) {
                try {
                    Utils.showLoading('Loading application...');
                    
                    const applicationRef = db.ref('agentApplications/' + applicationId);
                    const snapshot = await applicationRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Application not found', 'error');
                        return;
                    }
                    
                    const application = snapshot.val();
                    
                    // Show application details in a modal
                    let html = `
                        <div style="max-width: 500px;">
                            <h3 style="margin-bottom: 16px;">Agent Application Details</h3>
                            
                            <div style="background: var(--macos-gray-1); padding: 20px; border-radius: var(--macos-radius-sm); margin-bottom: 20px;">
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Full Name</div>
                                    <div style="font-weight: 600;">${application.fullName}</div>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Phone</div>
                                    <div>${application.phone}</div>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">NRC</div>
                                    <div>${application.nrc}</div>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Address</div>
                                    <div>${application.residence}</div>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Applied On</div>
                                    <div>${Utils.formatDate(application.submittedAt)}</div>
                                </div>
                            </div>
                            
                            <h4 style="margin-bottom: 12px;">Documents</h4>
                            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                ${application.nrcFront ? `
                                    <a href="${application.nrcFront}" target="_blank" class="document-link" style="flex: 1;">
                                        <i class="fas fa-id-card"></i> NRC Front
                                    </a>
                                ` : ''}
                                
                                ${application.nrcBack ? `
                                    <a href="${application.nrcBack}" target="_blank" class="document-link" style="flex: 1;">
                                        <i class="fas fa-id-card"></i> NRC Back
                                    </a>
                                ` : ''}
                                
                                ${application.profilePhoto ? `
                                    <a href="${application.profilePhoto}" target="_blank" class="document-link" style="flex: 1;">
                                        <i class="fas fa-user-circle"></i> Profile Photo
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    // Create a custom modal
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Application Details</h2>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${html}
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                                <button class="btn btn-success" onclick="AgentManager.showApproveModal('${applicationId}')">Approve</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing application:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load application', 'error');
                }
            },
            
            showApproveModal(applicationId) {
                AppState.selectedApplication = applicationId;
                
                const modal = document.getElementById('approveApplicationModal');
                const content = document.getElementById('approveApplicationContent');
                
                // Generate credentials
                const agentId = 'AG' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
                const agentEmail = `agent.${Date.now()}@trucash.com`;
                const agentPassword = Math.random().toString(36).slice(-8) + 'A1!';
                
                content.innerHTML = `
                    <div style="max-width: 500px;">
                        <h3 style="margin-bottom: 16px;">Approve Agent Application</h3>
                        
                        <div class="credential-form-group">
                            <label class="form-label">Agent Email</label>
                            <div class="credential-display">${agentEmail}</div>
                            <div class="credential-note">This email will be used for login</div>
                        </div>
                        
                        <div class="credential-form-group">
                            <label class="form-label">Agent Password</label>
                            <div class="credential-display">${agentPassword}</div>
                            <div class="credential-note">Share this password securely with the agent</div>
                        </div>
                        
                        <div class="credential-form-group">
                            <label class="form-label">Agent ID</label>
                            <div class="credential-display">${agentId}</div>
                            <div class="credential-note">Unique identifier for the agent</div>
                        </div>
                        
                        <div style="background: rgba(255, 204, 0, 0.1); padding: 12px; border-radius: var(--macos-radius-sm); margin-top: 20px;">
                            <div style="font-size: 12px; color: var(--macos-orange);">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Important:</strong> Save these credentials securely. They cannot be retrieved later.
                            </div>
                        </div>
                    </div>
                `;
                
                // Store credentials
                AppState.generatedCredentials = {
                    email: agentEmail,
                    password: agentPassword,
                    agentId: agentId
                };
                
                ModalManager.closeAllModals();
                modal.classList.add('active');
            },
            
            async approveApplication() {
                if (!AppState.selectedApplication || !AppState.generatedCredentials) {
                    Utils.showToast('Error', 'No application selected', 'error');
                    return;
                }
                
                try {
                    Utils.showLoading('Approving application...');
                    
                    const result = await FirebaseService.approveAgentApplication(
                        AppState.selectedApplication,
                        AppState.generatedCredentials
                    );
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeApproveApplicationModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error approving application:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to approve application', 'error');
                }
            }
        };

        // ===== CUSTOMER MANAGER =====
        const CustomerManager = {
            showCreateCustomerModal() {
                ModalManager.closeAllModals();
                
                // Load agents for assignment dropdown
                const select = document.getElementById('assignAgentSelect');
                select.innerHTML = '<option value="">Select an agent (optional)</option>';
                
                AppState.agents
                    .filter(agent => agent.status === 'active')
                    .forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.fullName} (${agent.agentId})`;
                        select.appendChild(option);
                    });
                
                document.getElementById('createCustomerModal').classList.add('active');
            },
            
            async createCustomer() {
                const formData = {
                    fullName: document.getElementById('customerFullName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    nrc: document.getElementById('customerNRC').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    houseNumber: document.getElementById('customerHouseNumber').value.trim(),
                    occupation: document.getElementById('customerOccupation').value.trim(),
                    monthlyIncome: parseFloat(document.getElementById('customerMonthlyIncome').value) || 0,
                    password: document.getElementById('customerPassword').value,
                    confirmPassword: document.getElementById('customerConfirmPassword').value,
                    assignedAgentId: document.getElementById('assignAgentSelect').value,
                    notes: document.getElementById('customerNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!formData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(formData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(formData.phone)) errors.push('Valid phone number is required');
                if (!Utils.validateNRC(formData.nrc)) errors.push('Valid NRC (123456/78/9) is required');
                if (!formData.address) errors.push('Address is required');
                if (formData.password.length < 6) errors.push('Password must be at least 6 characters');
                if (formData.password !== formData.confirmPassword) errors.push('Passwords do not match');
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                try {
                    Utils.showLoading('Creating customer account...');
                    
                    const result = await FirebaseService.createCustomer(formData);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeCreateCustomerModal();
                        
                        // Reset form
                        document.getElementById('createCustomerForm').reset();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error creating customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to create customer', 'error');
                }
            },
            
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    customer.id = customerId;
                    
                    // Get agent details if assigned
                    let agent = null;
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        const agentSnapshot = await agentRef.once('value');
                        agent = agentSnapshot.val();
                    }
                    
                    // Get customer's loans
                    const loansRef = db.ref('loans').orderByChild('customerId').equalTo(customerId);
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    this.displayCustomerModal(customer, agent, loans);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load customer details', 'error');
                }
            },
            
            displayCustomerModal(customer, agent, loans) {
                AppState.selectedCustomer = customer;
                
                const modal = document.getElementById('customerDetailModal');
                const content = document.getElementById('customerDetailContent');
                
                const statusClass = `status-${customer.status}`;
                const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                
                // Calculate total borrowed
                const totalBorrowed = loans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                const activeLoans = loans.filter(l => l.status === 'active').length;
                
                let documentsHTML = '';
                if (customer.nrcFront || customer.nrcBack || customer.profilePhoto) {
                    documentsHTML = `
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 16px;">Customer Documents</h4>
                            <div class="document-viewer">
                                ${customer.nrcFront ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">NRC Front</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${customer.nrcFront}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${customer.nrcFront}', 'NRC Front')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.nrcBack ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">NRC Back</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${customer.nrcBack}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${customer.nrcBack}', 'NRC Back')">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.profilePhoto ? `
                                    <div class="document-card">
                                        <div class="document-header">
                                            <div class="document-title">Profile Photo</div>
                                        </div>
                                        <div class="document-preview">
                                            <img src="${customer.profilePhoto}" class="document-image" 
                                                 onclick="DocumentManager.viewImage('${customer.profilePhoto}', 'Profile Photo')">
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="customer-detail-view">
                        <div class="section-header" style="margin-bottom: 24px;">
                            <div>
                                <h3 style="margin-bottom: 4px;">${customer.fullName}</h3>
                                <p style="color: var(--macos-text-secondary);">Customer since ${Utils.formatDateOnly(customer.createdAt)}</p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Email</div>
                                <div class="loan-detail-value">${customer.email}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Phone</div>
                                <div class="loan-detail-value">${customer.phone || 'N/A'}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">NRC</div>
                                <div class="loan-detail-value">${customer.nrc || 'N/A'}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Occupation</div>
                                <div class="loan-detail-value">${customer.occupation || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Customer Information</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div style="margin-bottom: 8px;"><strong>Address:</strong> ${customer.residence}</div>
                                ${customer.houseNumber ? `<div style="margin-bottom: 8px;"><strong>House Number:</strong> ${customer.houseNumber}</div>` : ''}
                                <div style="margin-bottom: 8px;"><strong>Monthly Income:</strong> ${Utils.formatCurrency(customer.monthlyIncome || 0)}</div>
                                <div style="margin-bottom: 8px;"><strong>Account Balance:</strong> ${Utils.formatCurrency(customer.accountBalance || 0)}</div>
                                ${customer.statusReason ? `<div style="margin-bottom: 8px;"><strong>Status Reason:</strong> ${customer.statusReason}</div>` : ''}
                            </div>
                        </div>
                        
                        ${agent ? `
                            <div style="margin: 24px 0;">
                                <h4 style="margin-bottom: 16px;">Assigned Agent</h4>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                    <div style="margin-bottom: 8px;"><strong>Name:</strong> ${agent.fullName}</div>
                                    <div style="margin-bottom: 8px;"><strong>Agent ID:</strong> ${agent.agentId}</div>
                                    <div style="margin-bottom: 8px;"><strong>Phone:</strong> ${agent.phone || 'Not provided'}</div>
                                    ${customer.assignedAt ? `<div style="margin-bottom: 8px;"><strong>Assigned:</strong> ${Utils.formatDate(customer.assignedAt)}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Loan History</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div style="margin-bottom: 8px;"><strong>Total Loans:</strong> ${loans.length}</div>
                                <div style="margin-bottom: 8px;"><strong>Active Loans:</strong> ${activeLoans}</div>
                                <div style="margin-bottom: 8px;"><strong>Total Borrowed:</strong> ${Utils.formatCurrency(totalBorrowed)}</div>
                                <div style="margin-bottom: 8px;"><strong>Completed Loans:</strong> ${loans.filter(l => l.status === 'completed').length}</div>
                            </div>
                        </div>
                        
                        ${documentsHTML}
                    </div>
                `;
                
                // Update button event handlers
                document.getElementById('suspendCustomerBtn').onclick = () => this.suspendCustomer(customer.id);
                document.getElementById('deleteCustomerBtn').onclick = () => this.deleteCustomer(customer.id);
                
                modal.classList.add('active');
            },
            
            async suspendCustomer(customerId) {
                const status = prompt('Enter new status (suspended/banned/active):', 'suspended');
                
                if (!status || !['suspended', 'banned', 'active'].includes(status.toLowerCase())) {
                    Utils.showToast('Error', 'Invalid status. Use: suspended, banned, or active', 'error');
                    return;
                }
                
                const reason = prompt('Enter reason for status change:', '');
                
                if (reason === null) return;
                
                try {
                    Utils.showLoading('Updating customer status...');
                    
                    const result = await FirebaseService.updateCustomerStatus(customerId, status.toLowerCase(), reason);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeCustomerModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error suspending customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to update customer status', 'error');
                }
            },
            
            async deleteCustomer(customerId) {
                if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Deleting customer...');
                    
                    const result = await FirebaseService.deleteCustomer(customerId);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeCustomerModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to delete customer', 'error');
                }
            }
        };

        // ===== ASSIGNMENT MANAGER =====
        const AssignmentManager = {
            async showAssignModal(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    
                    // Get available agents
                    const availableAgents = AppState.agents.filter(agent => agent.status === 'active');
                    
                    const modal = document.getElementById('assignAgentModal');
                    const content = document.getElementById('assignAgentContent');
                    
                    let options = '<option value="">Select an agent</option>';
                    availableAgents.forEach(agent => {
                        const selected = customer.assignedAgentId === agent.id ? 'selected' : '';
                        options += `<option value="${agent.id}" ${selected}>${agent.fullName} (${agent.agentId})</option>`;
                    });
                    
                    content.innerHTML = `
                        <div style="max-width: 500px;">
                            <h3 style="margin-bottom: 16px;">Assign Agent to Customer</h3>
                            
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm); margin-bottom: 20px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">${customer.fullName}</div>
                                <div style="font-size: 14px; color: var(--macos-text-secondary);">
                                    <div>Email: ${customer.email}</div>
                                    <div>Phone: ${customer.phone || 'N/A'}</div>
                                    ${customer.assignedAgentId ? `<div>Current Agent: ${customer.assignedAgentName || 'Unknown'}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Select Agent</label>
                                <select id="selectedAgentId" class="form-select">
                                    ${options}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Assignment Notes (Optional)</label>
                                <textarea id="assignmentNotes" class="form-input form-textarea" placeholder="Any notes about this assignment..."></textarea>
                            </div>
                        </div>
                    `;
                    
                    // Update button event handler
                    document.getElementById('confirmAssignBtn').onclick = () => {
                        this.assignAgent(customerId);
                    };
                    
                    Utils.hideLoading();
                    modal.classList.add('active');
                } catch (error) {
                    console.error('Error loading assignment modal:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load assignment details', 'error');
                }
            },
            
            async assignAgent(customerId) {
                const agentId = document.getElementById('selectedAgentId').value;
                const notes = document.getElementById('assignmentNotes').value.trim();
                
                if (!agentId) {
                    Utils.showToast('Error', 'Please select an agent', 'error');
                    return;
                }
                
                // Get agent name
                const agent = AppState.agents.find(a => a.id === agentId);
                if (!agent) {
                    Utils.showToast('Error', 'Selected agent not found', 'error');
                    return;
                }
                
                try {
                    Utils.showLoading('Assigning agent...');
                    
                    const result = await FirebaseService.assignAgentToCustomer(customerId, agentId, agent.fullName);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeAssignAgentModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to assign agent', 'error');
                }
            },
            
            async removeAssignment(customerId) {
                if (!confirm('Are you sure you want to remove the agent assignment from this customer?')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Removing assignment...');
                    
                    // This would be implemented in FirebaseService
                    // For now, we'll just show a message
                    
                    Utils.hideLoading();
                    Utils.showToast('Success', 'Assignment removed successfully', 'success');
                    
                    // Refresh the assignments UI
                    UIManager.updateAssignmentsUI();
                } catch (error) {
                    console.error('Error removing assignment:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to remove assignment', 'error');
                }
            }
        };

        // ===== COMMISSION MANAGER =====
        const CommissionManager = {
            async viewCommissionDetails(commissionId) {
                try {
                    Utils.showLoading('Loading commission details...');
                    
                    const commissionRef = db.ref('commissions/' + commissionId);
                    const snapshot = await commissionRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Commission not found', 'error');
                        return;
                    }
                    
                    const commission = snapshot.val();
                    commission.id = commissionId;
                    
                    this.displayCommissionModal(commission);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing commission details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load commission details', 'error');
                }
            },
            
            displayCommissionModal(commission) {
                AppState.selectedCommission = commission;
                
                const modal = document.getElementById('commissionDetailModal');
                const content = document.getElementById('commissionDetailContent');
                
                const statusClass = `status-${commission.status}`;
                const statusText = commission.status.charAt(0).toUpperCase() + commission.status.slice(1);
                
                content.innerHTML = `
                    <div class="commission-detail-view">
                        <div class="section-header" style="margin-bottom: 24px;">
                            <div>
                                <h3 style="margin-bottom: 4px;">Commission Details</h3>
                                <p style="color: var(--macos-text-secondary);">ID: ${commission.id}</p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Agent</div>
                                <div class="loan-detail-value">${commission.agentName}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Customer</div>
                                <div class="loan-detail-value">${commission.customerName}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Loan ID</div>
                                <div class="loan-detail-value">${commission.loanId || 'N/A'}</div>
                            </div>
                            <div class="loan-detail-card">
                                <div class="loan-detail-label">Amount</div>
                                <div class="loan-detail-value">${Utils.formatCurrency(commission.amount)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Commission Information</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div style="margin-bottom: 8px;"><strong>Type:</strong> ${commission.type || 'loan_approval'}</div>
                                <div style="margin-bottom: 8px;"><strong>Created:</strong> ${Utils.formatDate(commission.createdAt)}</div>
                                <div style="margin-bottom: 8px;"><strong>Due Date:</strong> ${commission.dueDate ? Utils.formatDate(commission.dueDate) : 'N/A'}</div>
                                ${commission.paidAt ? `<div style="margin-bottom: 8px;"><strong>Paid:</strong> ${Utils.formatDate(commission.paidAt)}</div>` : ''}
                                ${commission.paymentDetails ? `<div style="margin-bottom: 8px;"><strong>Payment Details:</strong> ${JSON.stringify(commission.paymentDetails)}</div>` : ''}
                                ${commission.updatedByAdmin ? `<div style="margin-bottom: 8px;"><strong>Updated By:</strong> ${commission.updatedByAdmin}</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <div class="commission-card">
                                <div class="commission-amount">${Utils.formatCurrency(commission.amount)}</div>
                                <div class="commission-label">Total Commission Amount</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update button visibility based on commission status
                const payBtn = document.getElementById('payCommissionBtn');
                
                if (commission.status === 'pending') {
                    payBtn.style.display = 'inline-block';
                } else {
                    payBtn.style.display = 'none';
                }
                
                // Update button event handler
                payBtn.onclick = () => this.markAsPaid(commission.id);
                
                modal.classList.add('active');
            },
            
            async markAsPaid(commissionId) {
                const paymentMethod = prompt('Enter payment method (e.g., Bank Transfer, Mobile Money):', 'Bank Transfer');
                
                if (!paymentMethod) {
                    Utils.showToast('Error', 'Payment method is required', 'error');
                    return;
                }
                
                const reference = prompt('Enter payment reference number:', '');
                
                if (!reference) {
                    Utils.showToast('Error', 'Payment reference is required', 'error');
                    return;
                }
                
                const paymentDetails = {
                    method: paymentMethod,
                    reference: reference,
                    paidBy: AppState.adminData.fullName,
                    paidAt: Date.now()
                };
                
                try {
                    Utils.showLoading('Updating commission status...');
                    
                    const result = await FirebaseService.updateCommissionStatus(
                        commissionId,
                        'paid',
                        paymentDetails
                    );
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                        ModalManager.closeCommissionModal();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error updating commission:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to update commission', 'error');
                }
            }
        };

        // ===== DOCUMENT MANAGER =====
        const DocumentManager = {
            viewImage(imageUrl, title) {
                const modal = document.getElementById('imageModal');
                const image = document.getElementById('modalImage');
                
                image.src = imageUrl;
                image.alt = title;
                
                modal.classList.add('active');
            },
            
            viewDocument(url, title) {
                const modal = document.getElementById('documentViewerModal');
                const image = document.getElementById('documentViewerImage');
                
                // Check if it's an image or PDF
                if (url.toLowerCase().endsWith('.pdf')) {
                    // For PDFs, we should open in a new tab
                    window.open(url, '_blank');
                    return;
                }
                
                image.src = url;
                image.alt = title;
                
                modal.classList.add('active');
            }
        };

        // ===== MODAL MANAGER =====
        const ModalManager = {
            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            },
            
            closeLoanModal() {
                document.getElementById('loanDetailModal').classList.remove('active');
                AppState.selectedLoan = null;
            },
            
            closeAgentModal() {
                document.getElementById('agentDetailModal').classList.remove('active');
                AppState.selectedAgent = null;
            },
            
            closeCustomerModal() {
                document.getElementById('customerDetailModal').classList.remove('active');
                AppState.selectedCustomer = null;
            },
            
            closeCreateAgentModal() {
                document.getElementById('createAgentModal').classList.remove('active');
                document.getElementById('createAgentForm').reset();
            },
            
            closeCreateCustomerModal() {
                document.getElementById('createCustomerModal').classList.remove('active');
                document.getElementById('createCustomerForm').reset();
            },
            
            closeAssignAgentModal() {
                document.getElementById('assignAgentModal').classList.remove('active');
            },
            
            closeCommissionModal() {
                document.getElementById('commissionDetailModal').classList.remove('active');
                AppState.selectedCommission = null;
            },
            
            closeDocumentViewer() {
                document.getElementById('documentViewerModal').classList.remove('active');
            },
            
            closePendingApplicationsModal() {
                document.getElementById('pendingApplicationsModal').classList.remove('active');
            },
            
            closeApproveApplicationModal() {
                document.getElementById('approveApplicationModal').classList.remove('active');
                AppState.selectedApplication = null;
                AppState.generatedCredentials = null;
            },
            
            closeImageModal() {
                document.getElementById('imageModal').classList.remove('active');
            }
        };

        // ===== SETTINGS MANAGER =====
        const SettingsManager = {
            async saveSettings() {
                const settings = {
                    interestRate: parseFloat(document.getElementById('interestRate').value) || 15,
                    maxLoanAmount: parseFloat(document.getElementById('maxLoanAmount').value) || 50000,
                    minLoanAmount: parseFloat(document.getElementById('minLoanAmount').value) || 100,
                    loanDuration: parseInt(document.getElementById('loanDuration').value) || 12,
                    commissionRate: parseFloat(document.getElementById('commissionRate').value) || 2.5,
                    onboardingCommission: parseFloat(document.getElementById('onboardingCommission').value) || 50,
                    payoutSchedule: document.getElementById('payoutSchedule').value,
                    systemName: document.getElementById('systemName').value.trim(),
                    defaultCurrency: document.getElementById('defaultCurrency').value,
                    autoApproveLoans: document.getElementById('autoApproveLoans').value === 'true',
                    maintenanceMode: document.getElementById('maintenanceMode').value === 'true'
                };
                
                // Validation
                if (settings.interestRate < 1 || settings.interestRate > 50) {
                    Utils.showToast('Error', 'Interest rate must be between 1% and 50%', 'error');
                    return;
                }
                
                if (settings.maxLoanAmount < settings.minLoanAmount) {
                    Utils.showToast('Error', 'Maximum loan amount must be greater than minimum', 'error');
                    return;
                }
                
                if (settings.commissionRate < 0 || settings.commissionRate > 50) {
                    Utils.showToast('Error', 'Commission rate must be between 0% and 50%', 'error');
                    return;
                }
                
                try {
                    Utils.showLoading('Saving settings...');
                    
                    const result = await FirebaseService.updateSystemSettings(settings);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Success', result.message, 'success');
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to save settings', 'error');
                }
            }
        };

        // ===== PAGINATION HANDLERS =====
        document.getElementById('prevPage').addEventListener('click', () => {
            if (AppState.pagination.loans.page > 1) {
                AppState.pagination.loans.page--;
                UIManager.renderLoansTable();
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(AppState.pagination.loans.total / AppState.pagination.loans.limit);
            if (AppState.pagination.loans.page < totalPages) {
                AppState.pagination.loans.page++;
                UIManager.renderLoansTable();
            }
        });

        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Initialize connection status
            UIManager.updateConnectionStatus();
            
            // Setup settings save button
            document.getElementById('saveSettings').addEventListener('click', SettingsManager.saveSettings);
            
            // Setup export buttons (placeholder functionality)
            document.getElementById('exportLoans').addEventListener('click', () => {
                Utils.showToast('Export', 'Loan export feature coming soon', 'info');
            });
            
            document.getElementById('exportCommissions').addEventListener('click', () => {
                Utils.showToast('Export', 'Commission export feature coming soon', 'info');
            });
            
            document.getElementById('processPayouts').addEventListener('click', () => {
                Utils.showToast('Payouts', 'Payout processing feature coming soon', 'info');
            });
            
            document.getElementById('bulkAssignBtn').addEventListener('click', () => {
                Utils.showToast('Bulk Assignment', 'Bulk assignment feature coming soon', 'info');
            });
            
            document.getElementById('viewAllActivity').addEventListener('click', () => {
                UIManager.showSection('audit');
            });
            
            document.getElementById('clearOldLogs').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear old audit logs?')) {
                    Utils.showToast('Info', 'Log clearing feature coming soon', 'info');
                }
            });
            
            document.getElementById('exportAuditLog').addEventListener('click', () => {
                Utils.showToast('Export', 'Audit log export feature coming soon', 'info');
            });
        });

        // ===== GLOBAL EXPORTS =====
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.AssignmentManager = AssignmentManager;
        window.CommissionManager = CommissionManager;
        window.DocumentManager = DocumentManager;
        window.ModalManager = ModalManager;
        window.Utils = Utils;
    </script>
</body>
</html>
