<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>TruCash - Admin Panel</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Cloudinary -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        /* ===== MAC OS THEME ===== */
        :root {
            /* Mac OS Colors */
            --macos-blue: #007AFF;
            --macos-green: #34C759;
            --macos-red: #FF3B30;
            --macos-orange: #FF9500;
            --macos-purple: #AF52DE;
            --macos-pink: #FF2D55;
            
            /* Gray Scale */
            --macos-gray-1: #F5F5F7;
            --macos-gray-2: #E8E8ED;
            --macos-gray-3: #D1D1D6;
            --macos-gray-4: #8E8E93;
            --macos-gray-5: #636366;
            --macos-gray-6: #48484A;
            
            /* Text Colors */
            --macos-text-primary: #1D1D1F;
            --macos-text-secondary: #666666;
            --macos-text-tertiary: #8E8E93;
            
            /* Backgrounds */
            --macos-bg-primary: #FFFFFF;
            --macos-bg-secondary: #F9F9FB;
            --macos-bg-tertiary: #F2F2F7;
            
            /* Shadows */
            --macos-shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --macos-shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --macos-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Radius */
            --macos-radius-sm: 8px;
            --macos-radius-md: 12px;
            --macos-radius-lg: 16px;
            --macos-radius-xl: 20px;
            
            /* Transitions */
            --macos-transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
            height: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--macos-bg-primary);
            color: var(--macos-text-primary);
            line-height: 1.5;
            height: 100%;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            height: 100vh;
            background: var(--macos-bg-primary);
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: var(--macos-bg-primary);
            border-right: 1px solid var(--macos-gray-2);
            display: flex;
            flex-direction: column;
            transition: var(--macos-transition);
            z-index: 1000;
            box-shadow: var(--macos-shadow-sm);
        }
        
        .sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: var(--macos-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .nav-section {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-group {
            margin-bottom: 24px;
        }
        
        .nav-group-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-text-tertiary);
            padding: 8px 24px;
            margin-bottom: 4px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            text-decoration: none;
            color: var(--macos-text-secondary);
            transition: var(--macos-transition);
            cursor: pointer;
            position: relative;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: var(--macos-bg-secondary);
            color: var(--macos-text-primary);
        }
        
        .nav-item.active {
            background: var(--macos-bg-secondary);
            color: var(--macos-blue);
            border-left-color: var(--macos-blue);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        .nav-item span {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }
        
        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--macos-gray-2);
            background: var(--macos-bg-secondary);
        }
        
        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .admin-info {
            flex: 1;
        }
        
        .admin-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .admin-role {
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .top-bar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--macos-bg-primary);
            z-index: 100;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .search-box {
            position: relative;
            width: 240px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            background: var(--macos-bg-secondary);
            transition: var(--macos-transition);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-text-tertiary);
            font-size: 14px;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--macos-radius-md);
            border: 1px solid var(--macos-gray-2);
            background: var(--macos-bg-primary);
            color: var(--macos-text-secondary);
            cursor: pointer;
            transition: var(--macos-transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover {
            background: var(--macos-bg-secondary);
            color: var(--macos-text-primary);
        }
        
        .content-wrapper {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--macos-bg-secondary);
        }
        
        /* ===== SECTIONS ===== */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DASHBOARD ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--macos-bg-primary);
            border-radius: var(--macos-radius-lg);
            padding: 24px;
            border: 1px solid var(--macos-gray-2);
            transition: var(--macos-transition);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-md);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }
        .stat-icon.green { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .stat-icon.orange { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .stat-icon.purple { background: rgba(175, 82, 222, 0.1); color: var(--macos-purple); }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--macos-text-primary);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        
        .chart-card {
            background: var(--macos-bg-primary);
            border-radius: var(--macos-radius-lg);
            padding: 24px;
            border: 1px solid var(--macos-gray-2);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--macos-text-primary);
        }
        
        /* ===== TABLES ===== */
        .data-card {
            background: var(--macos-bg-primary);
            border-radius: var(--macos-radius-lg);
            border: 1px solid var(--macos-gray-2);
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .card-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--macos-bg-secondary);
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-text-secondary);
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .data-table td {
            padding: 16px 20px;
            font-size: 14px;
            color: var(--macos-text-primary);
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .data-table tr {
            transition: var(--macos-transition);
        }
        
        .data-table tr:hover {
            background: var(--macos-bg-secondary);
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .status-approved { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .status-rejected { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }
        .status-active { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .status-suspended { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .status-banned { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }
        .status-inactive { background: rgba(142, 142, 147, 0.1); color: var(--macos-gray-4); }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: 10px 20px;
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: var(--macos-transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0066CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }
        
        .btn-success {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #2DA44E;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.2);
        }
        
        .btn-danger {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #DC2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }
        
        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--macos-bg-primary);
            border-radius: var(--macos-radius-lg);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--macos-shadow-lg);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--macos-text-tertiary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--macos-radius-sm);
            transition: var(--macos-transition);
        }
        
        .modal-close:hover {
            background: var(--macos-bg-secondary);
            color: var(--macos-text-primary);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--macos-bg-secondary);
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--macos-text-primary);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            font-family: inherit;
            background: var(--macos-bg-primary);
            color: var(--macos-text-primary);
            transition: var(--macos-transition);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ===== DOCUMENT VIEWER ===== */
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .document-card {
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            overflow: hidden;
            transition: var(--macos-transition);
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-md);
        }
        
        .document-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .document-info {
            padding: 12px;
        }
        
        .document-type {
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .document-date {
            font-size: 11px;
            color: var(--macos-text-tertiary);
        }
        
        /* ===== LOAN DETAILS ===== */
        .loan-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .detail-card {
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-md);
            padding: 20px;
            border: 1px solid var(--macos-gray-2);
        }
        
        .detail-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-text-tertiary);
            margin-bottom: 8px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100%;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .top-bar-actions {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--macos-bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: var(--macos-transition);
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 4000;
            max-width: 400px;
        }
        
        .toast {
            background: var(--macos-bg-primary);
            border-radius: var(--macos-radius-md);
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--macos-blue);
            box-shadow: var(--macos-shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .toast.active {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            color: var(--macos-blue);
            font-size: 20px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--macos-text-primary);
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }
        
        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }
        
        .empty-state i {
            font-size: 48px;
            color: var(--macos-gray-3);
            margin-bottom: 16px;
        }
        
        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-text-primary);
            margin-bottom: 8px;
        }
        
        .empty-state p {
            color: var(--macos-text-secondary);
            margin-bottom: 24px;
        }
        
        /* ===== AGENT ASSIGNMENT ===== */
        .agent-assignment {
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-md);
            padding: 20px;
            border: 1px solid var(--macos-gray-2);
            margin-top: 20px;
        }
        
        .agent-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .agent-card {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            padding: 12px;
            cursor: pointer;
            transition: var(--macos-transition);
        }
        
        .agent-card:hover {
            border-color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.05);
        }
        
        .agent-card.selected {
            border-color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.1);
        }
        
        .agent-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .agent-id {
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }
    </style>
</head>
<body>
    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">TC</div>
                <div class="logo-text">TruCash Admin</div>
            </div>
            
            <div class="nav-section">
                <div class="nav-group">
                    <div class="nav-group-title">Main</div>
                    <a href="#" class="nav-item active" data-section="dashboard">
                        <i class="fas fa-chart-bar"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Loans</div>
                    <a href="#" class="nav-item" data-section="loans">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Loan Applications</span>
                        <span class="nav-badge" id="pendingLoansBadge">0</span>
                    </a>
                    <a href="#" class="nav-item" data-section="activeLoans">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span>Active Loans</span>
                    </a>
                    <a href="#" class="nav-item" data-section="repayments">
                        <i class="fas fa-money-check-alt"></i>
                        <span>Repayments</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Users</div>
                    <a href="#" class="nav-item" data-section="agents">
                        <i class="fas fa-user-tie"></i>
                        <span>Agents</span>
                        <span class="nav-badge" id="pendingAgentsBadge">0</span>
                    </a>
                    <a href="#" class="nav-item" data-section="customers">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </a>
                    <a href="#" class="nav-item" data-section="agentApplications">
                        <i class="fas fa-user-clock"></i>
                        <span>Agent Applications</span>
                        <span class="nav-badge" id="applicationsBadge">0</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Financial</div>
                    <a href="#" class="nav-item" data-section="commissions">
                        <i class="fas fa-coins"></i>
                        <span>Commissions</span>
                    </a>
                    <a href="#" class="nav-item" data-section="transactions">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transactions</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">System</div>
                    <a href="#" class="nav-item" data-section="audit">
                        <i class="fas fa-history"></i>
                        <span>Audit Log</span>
                    </a>
                    <a href="#" class="nav-item" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar" id="adminAvatar">A</div>
                    <div class="admin-info">
                        <div class="admin-name" id="adminName">Loading...</div>
                        <div class="admin-role">System Administrator</div>
                    </div>
                    <button class="icon-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title" id="pageTitle">Dashboard</div>
                <div class="top-bar-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="Search...">
                    </div>
                    <button class="icon-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="icon-btn" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
            
            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="content-section active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" id="totalLoans">0</div>
                                    <div class="stat-label">Total Loans</div>
                                </div>
                                <div class="stat-icon blue">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span id="pendingLoansStat">0 pending</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" id="totalAgents">0</div>
                                    <div class="stat-label">Active Agents</div>
                                </div>
                                <div class="stat-icon green">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span id="pendingAgentsStat">0 pending</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" id="totalCustomers">0</div>
                                    <div class="stat-label">Total Customers</div>
                                </div>
                                <div class="stat-icon orange">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span id="activeCustomersStat">0 active</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" id="totalRevenue">K0</div>
                                    <div class="stat-label">Total Revenue</div>
                                </div>
                                <div class="stat-icon purple">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span id="monthlyRevenue">This month: K0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-title">Loan Applications Trend</div>
                            <canvas id="loanTrendChart"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">Agent Performance</div>
                            <canvas id="agentPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <div class="data-card">
                            <div class="card-header">
                                <div class="card-title">Recent Activities</div>
                                <div class="card-actions">
                                    <button class="btn btn-outline btn-sm" onclick="UIManager.loadAuditLogs()">
                                        <i class="fas fa-sync"></i>
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Action</th>
                                            <th>User</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentActivities">
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 40px;">
                                                <div class="empty-state">
                                                    <i class="fas fa-history"></i>
                                                    <h3>No Recent Activities</h3>
                                                    <p>Activities will appear here as they happen</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loan Applications Section -->
                <div id="loansSection" class="content-section">
                    <div class="data-card">
                        <div class="card-header">
                            <div class="card-title">Loan Applications</div>
                            <div class="card-actions">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="loanSearch" placeholder="Search loans...">
                                </div>
                                <select class="form-select" id="loanFilter" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="defaulted">Defaulted</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Purpose</th>
                                        <th>Applied</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="loanApplicationsTable">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px;">
                                            <div class="empty-state">
                                                <i class="fas fa-file-invoice-dollar"></i>
                                                <h3>No Loan Applications</h3>
                                                <p>Loan applications will appear here</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Active Loans Section -->
                <div id="activeLoansSection" class="content-section">
                    <div class="data-card">
                        <div class="card-header">
                            <div class="card-title">Active Loans</div>
                            <div class="card-actions">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="activeLoanSearch" placeholder="Search active loans...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Disbursed</th>
                                        <th>Due Date</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="activeLoansTable">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px;">
                                            <div class="empty-state">
                                                <i class="fas fa-hand-holding-usd"></i>
                                                <h3>No Active Loans</h3>
                                                <p>Active loans will appear here</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Agents Section -->
                <div id="agentsSection" class="content-section">
                    <div class="data-card">
                        <div class="card-header">
                            <div class="card-title">Agents</div>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="AgentManager.createNewAgent()">
                                    <i class="fas fa-plus"></i>
                                    Create Agent
                                </button>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="agentSearch" placeholder="Search agents...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Agent ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Customers</th>
                                        <th>Commission</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTable">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px;">
                                            <div class="empty-state">
                                                <i class="fas fa-user-tie"></i>
                                                <h3>No Agents</h3>
                                                <p>Agents will appear here</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Customers Section -->
                <div id="customersSection" class="content-section">
                    <div class="data-card">
                        <div class="card-header">
                            <div class="card-title">Customers</div>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="CustomerManager.createNewCustomer()">
                                    <i class="fas fa-plus"></i>
                                    Create Customer
                                </button>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="customerSearch" placeholder="Search customers...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Agent</th>
                                        <th>Loans</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTable">
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: 40px;">
                                            <div class="empty-state">
                                                <i class="fas fa-users"></i>
                                                <h3>No Customers</h3>
                                                <p>Customers will appear here</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Applications Section -->
                <div id="agentApplicationsSection" class="content-section">
                    <div class="data-card">
                        <div class="card-header">
                            <div class="card-title">Agent Applications</div>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="UIManager.loadAgentApplications()">
                                    <i class="fas fa-sync"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Application ID</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>NRC</th>
                                        <th>Applied</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentApplicationsTable">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <div class="empty-state">
                                                <i class="fas fa-user-clock"></i>
                                                <h3>No Applications</h3>
                                                <p>Agent applications will appear here</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Other sections (Repayments, Commissions, Transactions, Audit, Settings) -->
                <!-- Similar structure as above sections -->
                
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Loan Details Modal -->
    <div class="modal" id="loanDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Loan Details</h2>
                <button class="modal-close" onclick="ModalManager.closeLoanModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="loanDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Agent Details Modal -->
    <div class="modal" id="agentDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agent Details</h2>
                <button class="modal-close" onclick="ModalManager.closeAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="agentDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Customer Details Modal -->
    <div class="modal" id="customerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Customer Details</h2>
                <button class="modal-close" onclick="ModalManager.closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="customerDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Agent</h2>
                <button class="modal-close" onclick="ModalManager.closeCreateAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createAgentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="agentFullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="agentPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="agentEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agent ID</label>
                            <input type="text" class="form-input" id="agentId" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="agentPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-input" id="agentConfirmPassword" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Branch/Region</label>
                        <input type="text" class="form-input" id="agentBranch">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="agentNotes" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="ModalManager.closeCreateAgentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Agent</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Document Viewer Modal -->
    <div class="modal" id="documentViewerModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Document Viewer</h2>
                <button class="modal-close" onclick="ModalManager.closeDocumentViewer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="documentViewerContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx']
        };

        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            isSuperAdmin: false,
            
            // Data Collections
            loans: [],
            agents: [],
            customers: [],
            agentApplications: [],
            repayments: [],
            commissions: [],
            transactions: [],
            auditLogs: [],
            
            // UI State
            currentSection: 'dashboard',
            charts: {},
            
            // Selected Items
            selectedLoan: null,
            selectedAgent: null,
            selectedCustomer: null,
            selectedApplication: null,
            
            // Listeners
            realtimeListeners: []
        };

        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db, storage;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            calculateDaysBetween(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle' :
                            type === 'error' ? 'fa-exclamation-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' :
                            'fa-info-circle'
                        }"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('active');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
                
                return toast;
            },
            
            async uploadToCloudinary(file, type) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                    formData.append('folder', `${cloudinaryConfig.folder}/${type}`);
                    
                    fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.secure_url) {
                            resolve(data.secure_url);
                        } else {
                            reject(new Error('Upload failed'));
                        }
                    })
                    .catch(reject);
                });
            }
        };

        // ===== FIREBASE SERVICE =====
        const FirebaseService = {
            async checkAdminAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        
                        if (!user) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        // Check if user is admin
                        const userRef = db.ref('users/' + user.uid);
                        const snapshot = await userRef.once('value');
                        
                        if (!snapshot.exists()) {
                            Utils.showToast('Access Denied', 'User not found in system', 'error');
                            await auth.signOut();
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        const userData = snapshot.val();
                        
                        if (userData.userType !== 'admin' && userData.userType !== 'sudo') {
                            Utils.showToast('Access Denied', 'This panel is for administrators only', 'error');
                            await auth.signOut();
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        AppState.currentUser = user;
                        AppState.adminData = userData;
                        AppState.isSuperAdmin = userData.userType === 'sudo';
                        
                        resolve(userData);
                    }, reject);
                });
            },
            
            async loadAllLoans() {
                try {
                    const loansRef = db.ref('loans');
                    const snapshot = await loansRef.once('value');
                    const loans = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    // Sort by creation date (newest first)
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    
                    return loans;
                } catch (error) {
                    console.error('Error loading loans:', error);
                    return [];
                }
            },
            
            async loadAllAgents() {
                try {
                    const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                    const snapshot = await agentsRef.once('value');
                    const agents = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    return agents;
                } catch (error) {
                    console.error('Error loading agents:', error);
                    return [];
                }
            },
            
            async loadAllCustomers() {
                try {
                    const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                    const snapshot = await customersRef.once('value');
                    const customers = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    return customers;
                } catch (error) {
                    console.error('Error loading customers:', error);
                    return [];
                }
            },
            
            async loadAgentApplications() {
                try {
                    const applicationsRef = db.ref('agentApplications');
                    const snapshot = await applicationsRef.once('value');
                    const applications = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    // Filter pending applications
                    const pendingApps = applications.filter(app => app.status === 'pending');
                    AppState.agentApplications = pendingApps;
                    
                    return pendingApps;
                } catch (error) {
                    console.error('Error loading agent applications:', error);
                    return [];
                }
            },
            
            async approveLoan(loanId, approvedAmount = null, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        throw new Error('Loan not found');
                    }
                    
                    const loan = snapshot.val();
                    const updates = {
                        status: 'approved',
                        approvedAmount: approvedAmount || loan.amount,
                        approvedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByName: AppState.adminData.fullName,
                        approvalNotes: notes,
                        updatedAt: Date.now()
                    };
                    
                    await loanRef.update(updates);
                    
                    // Create commission record for agent
                    if (loan.agentId) {
                        const commissionAmount = (approvedAmount || loan.amount) * 0.025; // 2.5% commission
                        await this.createCommissionRecord({
                            agentId: loan.agentId,
                            agentName: loan.agentName,
                            loanId: loanId,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            loanAmount: approvedAmount || loan.amount,
                            commissionAmount: commissionAmount,
                            type: 'loan_approval',
                            status: 'pending',
                            createdAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('loan_approve', {
                        loanId: loanId,
                        customerId: loan.customerId,
                        customerName: loan.customerName,
                        amount: approvedAmount || loan.amount,
                        notes: notes
                    });
                    
                    // Create notification for customer
                    await this.createNotification(loan.customerId, 'loan_approved', {
                        loanId: loanId,
                        amount: approvedAmount || loan.amount,
                        timestamp: Date.now()
                    });
                    
                    // Create notification for agent
                    if (loan.agentId) {
                        await this.createNotification(loan.agentId, 'loan_approved', {
                            loanId: loanId,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            amount: approvedAmount || loan.amount,
                            commissionAmount: (approvedAmount || loan.amount) * 0.025,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: 'Loan approved successfully' };
                } catch (error) {
                    console.error('Error approving loan:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async rejectLoan(loanId, reason = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    await loanRef.update({
                        status: 'rejected',
                        rejectionReason: reason,
                        rejectedAt: Date.now(),
                        rejectedBy: AppState.currentUser.uid,
                        rejectedByName: AppState.adminData.fullName,
                        updatedAt: Date.now()
                    });
                    
                    // Get loan data for audit log
                    const snapshot = await loanRef.once('value');
                    const loan = snapshot.val();
                    
                    // Create audit log
                    await this.createAuditLog('loan_reject', {
                        loanId: loanId,
                        customerId: loan.customerId,
                        customerName: loan.customerName,
                        reason: reason
                    });
                    
                    // Create notification for customer
                    await this.createNotification(loan.customerId, 'loan_rejected', {
                        loanId: loanId,
                        reason: reason,
                        timestamp: Date.now()
                    });
                    
                    // Create notification for agent
                    if (loan.agentId) {
                        await this.createNotification(loan.agentId, 'loan_rejected', {
                            loanId: loanId,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            reason: reason,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: 'Loan rejected successfully' };
                } catch (error) {
                    console.error('Error rejecting loan:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async createAgentAccount(agentData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        agentId: agentData.agentId,
                        branch: agentData.branch || 'Main Branch',
                        userType: 'agent',
                        status: 'active',
                        isApproved: true,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByName: AppState.adminData.fullName,
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0,
                        pendingCommission: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Also add to agents collection
                    await db.ref('agents/' + agentId).set({
                        agentId: agentData.agentId,
                        email: agentData.email,
                        fullName: agentData.fullName,
                        status: 'active',
                        createdAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_create', {
                        agentId: agentId,
                        agentName: agentData.fullName,
                        email: agentData.email,
                        customAgentId: agentData.agentId
                    });
                    
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent account created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    
                    let errorMessage = 'Failed to create agent account';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateAgentStatus(agentId, status, reason = '') {
                try {
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        statusUpdatedBy: AppState.currentUser.uid,
                        statusUpdatedByName: AppState.adminData.fullName
                    };
                    
                    if (reason) {
                        updates.statusReason = reason;
                    }
                    
                    if (status === 'suspended') {
                        updates.suspendedAt = Date.now();
                    } else if (status === 'banned') {
                        updates.bannedAt = Date.now();
                    }
                    
                    const agentRef = db.ref('users/' + agentId);
                    await agentRef.update(updates);
                    
                    // Get agent data for audit log
                    const snapshot = await agentRef.once('value');
                    const agent = snapshot.val();
                    
                    // Create audit log
                    await this.createAuditLog('agent_status_update', {
                        agentId: agentId,
                        agentName: agent.fullName,
                        status: status,
                        reason: reason
                    });
                    
                    // Create notification for agent
                    await this.createNotification(agentId, 'agent_status_updated', {
                        status: status,
                        reason: reason,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: `Agent status updated to ${status}` };
                } catch (error) {
                    console.error('Error updating agent status:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async updateCustomerStatus(customerId, status, reason = '') {
                try {
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        statusUpdatedBy: AppState.currentUser.uid,
                        statusUpdatedByName: AppState.adminData.fullName
                    };
                    
                    if (reason) {
                        updates.statusReason = reason;
                    }
                    
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update(updates);
                    
                    // Get customer data for audit log
                    const snapshot = await customerRef.once('value');
                    const customer = snapshot.val();
                    
                    // Create audit log
                    await this.createAuditLog('customer_status_update', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        status: status,
                        reason: reason
                    });
                    
                    // Create notification for customer
                    await this.createNotification(customerId, 'customer_status_updated', {
                        status: status,
                        reason: reason,
                        timestamp: Date.now()
                    });
                    
                    // Create notification for agent if assigned
                    if (customer.assignedAgentId) {
                        await this.createNotification(customer.assignedAgentId, 'customer_status_updated', {
                            customerId: customerId,
                            customerName: customer.fullName,
                            status: status,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: `Customer status updated to ${status}` };
                } catch (error) {
                    console.error('Error updating customer status:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    // Get agent data
                    const agentRef = db.ref('users/' + agentId);
                    const agentSnapshot = await agentRef.once('value');
                    
                    if (!agentSnapshot.exists()) {
                        throw new Error('Agent not found');
                    }
                    
                    const agent = agentSnapshot.val();
                    
                    // Update customer
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update({
                        assignedAgentId: agentId,
                        agentName: agent.fullName,
                        agentAssignedAt: Date.now(),
                        updatedAt: Date.now(),
                        assignedBy: AppState.currentUser.uid,
                        assignedByName: AppState.adminData.fullName
                    });
                    
                    // Update agent's customer count
                    await agentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Get customer data for audit log
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    // Create audit log
                    await this.createAuditLog('agent_assign', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        agentId: agentId,
                        agentName: agent.fullName
                    });
                    
                    // Create notifications
                    await this.createNotification(customerId, 'agent_assigned', {
                        agentId: agentId,
                        agentName: agent.fullName,
                        timestamp: Date.now()
                    });
                    
                    await this.createNotification(agentId, 'customer_assigned', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async processCommissionPayment(commissionId, payoutDetails) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    await commissionRef.update({
                        status: 'paid',
                        paidAt: Date.now(),
                        paidBy: AppState.currentUser.uid,
                        paidByName: AppState.adminData.fullName,
                        payoutMethod: payoutDetails.method,
                        payoutReference: payoutDetails.reference,
                        payoutNotes: payoutDetails.notes || '',
                        updatedAt: Date.now()
                    });
                    
                    // Get commission data for audit log
                    const snapshot = await commissionRef.once('value');
                    const commission = snapshot.val();
                    
                    // Update agent's commission totals
                    const agentRef = db.ref('users/' + commission.agentId);
                    await agentRef.update({
                        totalCommission: firebase.database.ServerValue.increment(commission.amount),
                        pendingCommission: firebase.database.ServerValue.increment(-commission.amount),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('commission_pay', {
                        commissionId: commissionId,
                        agentId: commission.agentId,
                        agentName: commission.agentName,
                        amount: commission.amount,
                        payoutMethod: payoutDetails.method
                    });
                    
                    // Create notification for agent
                    await this.createNotification(commission.agentId, 'commission_paid', {
                        commissionId: commissionId,
                        amount: commission.amount,
                        payoutMethod: payoutDetails.method,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Commission paid successfully' };
                } catch (error) {
                    console.error('Error processing commission:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async createCommissionRecord(commissionData) {
                try {
                    const commissionId = Utils.generateId('COM');
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const commission = {
                        id: commissionId,
                        ...commissionData
                    };
                    
                    await commissionRef.set(commission);
                    
                    // Update agent's pending commission
                    const agentRef = db.ref('users/' + commissionData.agentId);
                    await agentRef.update({
                        pendingCommission: firebase.database.ServerValue.increment(commissionData.commissionAmount),
                        updatedAt: Date.now()
                    });
                    
                    return { success: true, commissionId: commissionId };
                } catch (error) {
                    console.error('Error creating commission record:', error);
                    return { success: false, error: 'Failed to create commission record' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName,
                        userRole: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '',
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    AppState.auditLogs.unshift(auditLog);
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createNotification(userId, type, data) {
                try {
                    const notificationId = Utils.generateId('NOT');
                    const notificationRef = db.ref('notifications/' + userId + '/' + notificationId);
                    
                    const notification = {
                        id: notificationId,
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        read: false,
                        priority: 'high'
                    };
                    
                    await notificationRef.set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return null;
                }
            },
            
            async approveAgentApplication(applicationId, credentials) {
                try {
                    const applicationRef = db.ref('agentApplications/' + applicationId);
                    const snapshot = await applicationRef.once('value');
                    
                    if (!snapshot.exists()) {
                        throw new Error('Application not found');
                    }
                    
                    const application = snapshot.val();
                    
                    // Update application status
                    await applicationRef.update({
                        status: 'approved',
                        reviewedAt: Date.now(),
                        reviewedBy: AppState.currentUser.uid,
                        reviewedByName: AppState.adminData.fullName,
                        assignedCredentials: credentials
                    });
                    
                    // Create agent account
                    const agentResult = await this.createAgentAccount({
                        fullName: application.fullName,
                        email: credentials.email,
                        phone: application.phone,
                        password: credentials.password,
                        agentId: credentials.agentId,
                        branch: 'Main Branch'
                    });
                    
                    if (!agentResult.success) {
                        throw new Error(agentResult.error);
                    }
                    
                    // Update application with agent ID
                    await applicationRef.update({
                        agentId: agentResult.agentId
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_application_approve', {
                        applicationId: applicationId,
                        agentId: agentResult.agentId,
                        agentName: application.fullName,
                        email: credentials.email
                    });
                    
                    return {
                        success: true,
                        message: 'Agent application approved and account created'
                    };
                } catch (error) {
                    console.error('Error approving agent application:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async rejectAgentApplication(applicationId, reason = '') {
                try {
                    const applicationRef = db.ref('agentApplications/' + applicationId);
                    await applicationRef.update({
                        status: 'rejected',
                        reviewedAt: Date.now(),
                        reviewedBy: AppState.currentUser.uid,
                        reviewedByName: AppState.adminData.fullName,
                        rejectionReason: reason
                    });
                    
                    // Create audit log
                    const snapshot = await applicationRef.once('value');
                    const application = snapshot.val();
                    
                    await this.createAuditLog('agent_application_reject', {
                        applicationId: applicationId,
                        applicantName: application.fullName,
                        reason: reason
                    });
                    
                    return { success: true, message: 'Agent application rejected' };
                } catch (error) {
                    console.error('Error rejecting agent application:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async signOut() {
                try {
                    // Clear all listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    
                    // Sign out
                    await auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    Utils.showToast('Logout Error', 'Failed to sign out', 'error');
                }
            }
        };

        // ===== UI MANAGER =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupRealtimeListeners();
                this.setupCharts();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.menuToggle = document.getElementById('menuToggle');
                
                // Dashboard elements
                this.totalLoans = document.getElementById('totalLoans');
                this.totalAgents = document.getElementById('totalAgents');
                this.totalCustomers = document.getElementById('totalCustomers');
                this.totalRevenue = document.getElementById('totalRevenue');
                
                // Badges
                this.pendingLoansBadge = document.getElementById('pendingLoansBadge');
                this.pendingAgentsBadge = document.getElementById('pendingAgentsBadge');
                this.applicationsBadge = document.getElementById('applicationsBadge');
                
                // Admin info
                this.adminName = document.getElementById('adminName');
                this.adminAvatar = document.getElementById('adminAvatar');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                this.refreshBtn = document.getElementById('refreshBtn');
                
                // Search
                this.globalSearch = document.getElementById('globalSearch');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                    });
                });
                
                // Menu toggle
                this.menuToggle.addEventListener('click', () => {
                    document.querySelector('.sidebar').classList.toggle('active');
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Refresh
                this.refreshBtn.addEventListener('click', () => this.refreshData());
                
                // Global search
                this.globalSearch.addEventListener('input', Utils.debounce(() => {
                    this.performGlobalSearch();
                }, 300));
                
                // Loan search and filter
                const loanSearch = document.getElementById('loanSearch');
                const loanFilter = document.getElementById('loanFilter');
                
                if (loanSearch) {
                    loanSearch.addEventListener('input', Utils.debounce(() => {
                        this.filterLoans();
                    }, 300));
                }
                
                if (loanFilter) {
                    loanFilter.addEventListener('change', () => {
                        this.filterLoans();
                    });
                }
                
                // Agent search
                const agentSearch = document.getElementById('agentSearch');
                if (agentSearch) {
                    agentSearch.addEventListener('input', Utils.debounce(() => {
                        this.filterAgents();
                    }, 300));
                }
                
                // Customer search
                const customerSearch = document.getElementById('customerSearch');
                if (customerSearch) {
                    customerSearch.addEventListener('input', Utils.debounce(() => {
                        this.filterCustomers();
                    }, 300));
                }
                
                // Create agent form
                const createAgentForm = document.getElementById('createAgentForm');
                if (createAgentForm) {
                    createAgentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        AgentManager.submitCreateAgent();
                    });
                }
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAdminAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Update UI with admin info
                    this.adminName.textContent = adminData.fullName || 'Admin';
                    const initials = (adminData.fullName || 'A').charAt(0).toUpperCase();
                    this.adminAvatar.textContent = initials;
                    
                    // Load initial data
                    await this.loadInitialData();
                    
                    Utils.hideLoading();
                    
                    Utils.showToast('Welcome Admin', `Hello ${adminData.fullName}!`, 'success');
                    
                } catch (error) {
                    console.error('Auth initialization error:', error);
                    Utils.hideLoading();
                    Utils.showToast('Authentication Error', 'Failed to authenticate', 'error');
                }
            },
            
            async loadInitialData() {
                await Promise.all([
                    FirebaseService.loadAllLoans(),
                    FirebaseService.loadAllAgents(),
                    FirebaseService.loadAllCustomers(),
                    FirebaseService.loadAgentApplications()
                ]);
                
                this.updateDashboard();
                this.updateLoansUI();
                this.updateAgentsUI();
                this.updateCustomersUI();
                this.updateAgentApplicationsUI();
            },
            
            setupRealtimeListeners() {
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    
                    this.updateDashboard();
                    this.updateLoansUI();
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Agents listener
                const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    
                    this.updateDashboard();
                    this.updateAgentsUI();
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Customers listener
                const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                const customersListener = customersRef.on('value', (snapshot) => {
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    
                    this.updateDashboard();
                    this.updateCustomersUI();
                });
                
                AppState.realtimeListeners.push(() => customersRef.off('value', customersListener));
                
                // Agent applications listener
                const applicationsRef = db.ref('agentApplications');
                const applicationsListener = applicationsRef.on('value', (snapshot) => {
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    const pendingApps = applications.filter(app => app.status === 'pending');
                    AppState.agentApplications = pendingApps;
                    
                    this.updateDashboard();
                    this.updateAgentApplicationsUI();
                });
                
                AppState.realtimeListeners.push(() => applicationsRef.off('value', applicationsListener));
                
                // Audit logs listener
                const auditRef = db.ref('auditLogs');
                const auditListener = auditRef.on('value', (snapshot) => {
                    const auditLogs = [];
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        log.id = childSnapshot.key;
                        auditLogs.push(log);
                    });
                    
                    auditLogs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = auditLogs.slice(0, 10); // Keep only recent logs
                    
                    this.updateRecentActivities();
                });
                
                AppState.realtimeListeners.push(() => auditRef.off('value', auditListener));
            },
            
            setupCharts() {
                // Loan trend chart
                const loanTrendCtx = document.getElementById('loanTrendChart');
                if (loanTrendCtx) {
                    AppState.charts.loanTrend = new Chart(loanTrendCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Loan Applications',
                                data: [12, 19, 8, 15, 22, 18],
                                borderColor: 'var(--macos-blue)',
                                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                
                // Agent performance chart
                const agentPerfCtx = document.getElementById('agentPerformanceChart');
                if (agentPerfCtx) {
                    AppState.charts.agentPerformance = new Chart(agentPerfCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Agent 1', 'Agent 2', 'Agent 3', 'Agent 4', 'Agent 5'],
                            datasets: [{
                                label: 'Loans Processed',
                                data: [12, 19, 8, 15, 22],
                                backgroundColor: 'var(--macos-green)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                }
                
                // Update page title
                const title = document.getElementById('pageTitle');
                const titles = {
                    dashboard: 'Dashboard',
                    loans: 'Loan Applications',
                    activeLoans: 'Active Loans',
                    agents: 'Agents',
                    customers: 'Customers',
                    agentApplications: 'Agent Applications',
                    repayments: 'Repayments',
                    commissions: 'Commissions',
                    transactions: 'Transactions',
                    audit: 'Audit Log',
                    settings: 'Settings'
                };
                
                title.textContent = titles[sectionId] || 'Dashboard';
                
                // Close sidebar on mobile
                if (window.innerWidth <= 1024) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            },
            
            updateDashboard() {
                // Update loan stats
                const totalLoans = AppState.loans.length;
                const pendingLoans = AppState.loans.filter(loan => loan.status === 'pending').length;
                
                this.totalLoans.textContent = totalLoans;
                document.getElementById('pendingLoansStat').textContent = `${pendingLoans} pending`;
                this.pendingLoansBadge.textContent = pendingLoans;
                this.pendingLoansBadge.style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                
                // Update agent stats
                const activeAgents = AppState.agents.filter(agent => agent.status === 'active').length;
                const pendingAgents = AppState.agents.filter(agent => agent.status === 'pending').length;
                
                this.totalAgents.textContent = activeAgents;
                document.getElementById('pendingAgentsStat').textContent = `${pendingAgents} pending`;
                this.pendingAgentsBadge.textContent = pendingAgents;
                this.pendingAgentsBadge.style.display = pendingAgents > 0 ? 'inline-block' : 'none';
                
                // Update customer stats
                const activeCustomers = AppState.customers.filter(customer => customer.status === 'active').length;
                
                this.totalCustomers.textContent = AppState.customers.length;
                document.getElementById('activeCustomersStat').textContent = `${activeCustomers} active`;
                
                // Update revenue
                const totalRevenue = AppState.loans
                    .filter(loan => loan.status === 'active' || loan.status === 'completed')
                    .reduce((sum, loan) => sum + (loan.amount || 0), 0);
                
                this.totalRevenue.textContent = Utils.formatCurrency(totalRevenue);
                
                // Update applications badge
                const pendingApplications = AppState.agentApplications.length;
                this.applicationsBadge.textContent = pendingApplications;
                this.applicationsBadge.style.display = pendingApplications > 0 ? 'inline-block' : 'none';
            },
            
            updateRecentActivities() {
                const container = document.getElementById('recentActivities');
                if (!container) return;
                
                if (AppState.auditLogs.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                No recent activities
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.auditLogs.forEach(log => {
                    let actionText = '';
                    let details = '';
                    
                    switch(log.action) {
                        case 'loan_approve':
                            actionText = 'Loan Approved';
                            details = `${log.data.customerName} - ${Utils.formatCurrency(log.data.amount)}`;
                            break;
                        case 'loan_reject':
                            actionText = 'Loan Rejected';
                            details = log.data.customerName;
                            break;
                        case 'agent_create':
                            actionText = 'Agent Created';
                            details = log.data.agentName;
                            break;
                        case 'agent_status_update':
                            actionText = 'Agent Status Updated';
                            details = `${log.data.agentName} - ${log.data.status}`;
                            break;
                        default:
                            actionText = log.action.replace('_', ' ');
                            details = JSON.stringify(log.data);
                    }
                    
                    html += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>${actionText}</td>
                            <td>${log.userName}</td>
                            <td>${details}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateLoansUI() {
                const container = document.getElementById('loanApplicationsTable');
                if (!container) return;
                
                if (AppState.loans.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <h3>No Loan Applications</h3>
                                    <p>Loan applications will appear here</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.loans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id || loan.loanId}</strong></td>
                            <td>${loan.customerName}</td>
                            <td>${loan.agentName || 'Not assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${loan.purpose || 'Not specified'}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td><span class="status-badge ${statusClass}">${loan.status}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn btn-success btn-sm" onclick="LoanManager.approveLoanPrompt('${loan.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="LoanManager.rejectLoanPrompt('${loan.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            filterLoans() {
                const searchTerm = document.getElementById('loanSearch').value.toLowerCase();
                const filterStatus = document.getElementById('loanFilter').value;
                
                const rows = document.querySelectorAll('#loanApplicationsTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    const loanId = row.cells[0].textContent.toLowerCase();
                    const customer = row.cells[1].textContent.toLowerCase();
                    const agent = row.cells[2].textContent.toLowerCase();
                    const status = row.cells[6].querySelector('.status-badge').textContent.toLowerCase();
                    
                    let matchesSearch = !searchTerm || 
                        loanId.includes(searchTerm) ||
                        customer.includes(searchTerm) ||
                        agent.includes(searchTerm);
                    
                    let matchesFilter = filterStatus === 'all' || status === filterStatus;
                    
                    row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
                });
            },
            
            updateAgentsUI() {
                const container = document.getElementById('agentsTable');
                if (!container) return;
                
                if (AppState.agents.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-user-tie"></i>
                                    <h3>No Agents</h3>
                                    <p>Agents will appear here</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.agents.forEach(agent => {
                    const statusClass = `status-${agent.status}`;
                    
                    html += `
                        <tr>
                            <td>${agent.agentId || agent.id.substring(0, 8)}</td>
                            <td>${agent.fullName}</td>
                            <td>${agent.email}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>${Utils.formatCurrency(agent.totalCommission || 0)}</td>
                            <td><span class="status-badge ${statusClass}">${agent.status}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="AgentManager.viewAgentDetails('${agent.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${agent.status === 'pending' ? `
                                        <button class="btn btn-success btn-sm" onclick="AgentManager.approveAgent('${agent.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="AgentManager.rejectAgent('${agent.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                    ${agent.status === 'active' ? `
                                        <button class="btn btn-outline btn-sm" onclick="AgentManager.suspendAgent('${agent.id}')">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : ''}
                                    ${agent.status === 'suspended' ? `
                                        <button class="btn btn-success btn-sm" onclick="AgentManager.activateAgent('${agent.id}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="AgentManager.banAgent('${agent.id}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            filterAgents() {
                const searchTerm = document.getElementById('agentSearch').value.toLowerCase();
                
                const rows = document.querySelectorAll('#agentsTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    const agentId = row.cells[0].textContent.toLowerCase();
                    const name = row.cells[1].textContent.toLowerCase();
                    const email = row.cells[2].textContent.toLowerCase();
                    
                    let matchesSearch = !searchTerm || 
                        agentId.includes(searchTerm) ||
                        name.includes(searchTerm) ||
                        email.includes(searchTerm);
                    
                    row.style.display = matchesSearch ? '' : 'none';
                });
            },
            
            updateCustomersUI() {
                const container = document.getElementById('customersTable');
                if (!container) return;
                
                if (AppState.customers.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>No Customers</h3>
                                    <p>Customers will appear here</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.customers.forEach(customer => {
                    const statusClass = `status-${customer.status}`;
                    const activeLoans = customer.activeLoans || 0;
                    const totalBalance = customer.accountBalance || 0;
                    
                    html += `
                        <tr>
                            <td>${customer.id.substring(0, 8)}</td>
                            <td>${customer.fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone || 'N/A'}</td>
                            <td>${customer.agentName || 'Not assigned'}</td>
                            <td>${activeLoans}</td>
                            <td>${Utils.formatCurrency(totalBalance)}</td>
                            <td><span class="status-badge ${statusClass}">${customer.status}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="CustomerManager.viewCustomerDetails('${customer.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline btn-sm" onclick="CustomerManager.assignAgent('${customer.id}')">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                    ${customer.status === 'active' ? `
                                        <button class="btn btn-outline btn-sm" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : ''}
                                    ${customer.status === 'suspended' ? `
                                        <button class="btn btn-success btn-sm" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="CustomerManager.banCustomer('${customer.id}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            filterCustomers() {
                const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
                
                const rows = document.querySelectorAll('#customersTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 9) return;
                    
                    const customerId = row.cells[0].textContent.toLowerCase();
                    const name = row.cells[1].textContent.toLowerCase();
                    const email = row.cells[2].textContent.toLowerCase();
                    
                    let matchesSearch = !searchTerm || 
                        customerId.includes(searchTerm) ||
                        name.includes(searchTerm) ||
                        email.includes(searchTerm);
                    
                    row.style.display = matchesSearch ? '' : 'none';
                });
            },
            
            updateAgentApplicationsUI() {
                const container = document.getElementById('agentApplicationsTable');
                if (!container) return;
                
                if (AppState.agentApplications.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-user-clock"></i>
                                    <h3>No Pending Applications</h3>
                                    <p>Agent applications will appear here</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.agentApplications.forEach(app => {
                    html += `
                        <tr>
                            <td>${app.id}</td>
                            <td>${app.fullName}</td>
                            <td>${app.phone}</td>
                            <td>${app.nrc || 'N/A'}</td>
                            <td>${Utils.formatDateOnly(app.submittedAt)}</td>
                            <td><span class="status-badge status-pending">Pending</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="AgentManager.viewApplicationDetails('${app.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="AgentManager.approveApplication('${app.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="AgentManager.rejectApplication('${app.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            async loadAgentApplications() {
                Utils.showLoading('Loading applications...');
                await FirebaseService.loadAgentApplications();
                this.updateAgentApplicationsUI();
                Utils.hideLoading();
            },
            
            async loadAuditLogs() {
                try {
                    const auditRef = db.ref('auditLogs');
                    const snapshot = await auditRef.once('value');
                    
                    const auditLogs = [];
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        log.id = childSnapshot.key;
                        auditLogs.push(log);
                    });
                    
                    auditLogs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = auditLogs.slice(0, 10);
                    
                    this.updateRecentActivities();
                    Utils.showToast('Success', 'Audit logs refreshed', 'success');
                } catch (error) {
                    console.error('Error loading audit logs:', error);
                    Utils.showToast('Error', 'Failed to load audit logs', 'error');
                }
            },
            
            async refreshData() {
                Utils.showLoading('Refreshing data...');
                await this.loadInitialData();
                Utils.hideLoading();
                Utils.showToast('Success', 'Data refreshed successfully', 'success');
            },
            
            performGlobalSearch() {
                const term = this.globalSearch.value.toLowerCase().trim();
                
                if (!term) {
                    // Reset all filters
                    this.filterLoans();
                    this.filterAgents();
                    this.filterCustomers();
                    return;
                }
                
                // Search in loans
                const loanRows = document.querySelectorAll('#loanApplicationsTable tr');
                loanRows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    let found = false;
                    for (let i = 0; i < 7; i++) {
                        if (row.cells[i].textContent.toLowerCase().includes(term)) {
                            found = true;
                            break;
                        }
                    }
                    
                    row.style.display = found ? '' : 'none';
                });
                
                // Search in agents
                const agentRows = document.querySelectorAll('#agentsTable tr');
                agentRows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    let found = false;
                    for (let i = 0; i < 7; i++) {
                        if (row.cells[i].textContent.toLowerCase().includes(term)) {
                            found = true;
                            break;
                        }
                    }
                    
                    row.style.display = found ? '' : 'none';
                });
                
                // Search in customers
                const customerRows = document.querySelectorAll('#customersTable tr');
                customerRows.forEach(row => {
                    if (row.cells.length < 9) return;
                    
                    let found = false;
                    for (let i = 0; i < 8; i++) {
                        if (row.cells[i].textContent.toLowerCase().includes(term)) {
                            found = true;
                            break;
                        }
                    }
                    
                    row.style.display = found ? '' : 'none';
                });
            }
        };

        // ===== LOAN MANAGER =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    // Load customer details
                    const customerRef = db.ref('users/' + loan.customerId);
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    // Load agent details if assigned
                    let agent = null;
                    if (loan.agentId) {
                        const agentRef = db.ref('users/' + loan.agentId);
                        const agentSnapshot = await agentRef.once('value');
                        agent = agentSnapshot.val();
                    }
                    
                    this.displayLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loan details', 'error');
                }
            },
            
            displayLoanModal(loan, customer, agent) {
                const modal = document.getElementById('loanDetailModal');
                const content = document.getElementById('loanDetailContent');
                
                const statusClass = `status-${loan.status}`;
                const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                
                // Create document viewer HTML
                let documentsHTML = '';
                if (loan.documents) {
                    documentsHTML = `
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 16px;">Loan Documents</h4>
                            <div class="document-grid">
                                ${loan.documents.collateralImages ? loan.documents.collateralImages.map((img, index) => `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${img}', 'Collateral Image ${index + 1}')">
                                        <img src="${img}" alt="Collateral" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Image+Not+Available'">
                                        <div class="document-info">
                                            <div class="document-type">Collateral ${index + 1}</div>
                                        </div>
                                    </div>
                                `).join('') : ''}
                                
                                ${loan.additionalDocs ? loan.additionalDocs.map((doc, index) => `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${doc.url || doc}', 'Additional Document ${index + 1}')">
                                        <img src="${doc.url || doc}" alt="Document" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Document'">
                                        <div class="document-info">
                                            <div class="document-type">Document ${index + 1}</div>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Create customer documents HTML
                let customerDocumentsHTML = '';
                if (customer) {
                    customerDocumentsHTML = `
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 16px;">Customer Documents</h4>
                            <div class="document-grid">
                                ${customer.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.nrcFront}', 'NRC Front')">
                                        <img src="${customer.nrcFront}" alt="NRC Front" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=NRC+Front'">
                                        <div class="document-info">
                                            <div class="document-type">NRC Front</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.nrcBack}', 'NRC Back')">
                                        <img src="${customer.nrcBack}" alt="NRC Back" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=NRC+Back'">
                                        <div class="document-info">
                                            <div class="document-type">NRC Back</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.profilePhoto}', 'Profile Photo')">
                                        <img src="${customer.profilePhoto}" alt="Profile" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Profile+Photo'">
                                        <div class="document-info">
                                            <div class="document-type">Profile Photo</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.proofOfIncome ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.proofOfIncome}', 'Proof of Income')">
                                        <img src="${customer.proofOfIncome}" alt="Income Proof" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Income+Proof'">
                                        <div class="document-info">
                                            <div class="document-type">Income Proof</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="loan-detail-view">
                        <div class="section-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin-bottom: 4px;">Loan ${loan.id}</h3>
                                <p style="color: var(--macos-text-secondary);">
                                    Customer: ${customer?.fullName || loan.customerName}
                                    ${agent ? ` | Agent: ${agent.fullName}` : ''}
                                </p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">${Utils.formatCurrency(loan.amount)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Approved Amount</div>
                                <div class="detail-value">${Utils.formatCurrency(loan.approvedAmount || loan.amount)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Interest Rate</div>
                                <div class="detail-value">${loan.interestRate || 15}%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Duration</div>
                                <div class="detail-value">${loan.duration} months</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Purpose</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${loan.purpose || 'Not specified'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Applied Date</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${Utils.formatDate(loan.createdAt)}</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Purpose Description</label>
                                <textarea class="form-textarea" style="background: var(--macos-bg-secondary);" readonly>${loan.purposeDescription || 'No description provided'}</textarea>
                            </div>
                            
                            ${loan.approvalNotes ? `
                                <div class="form-group">
                                    <label class="form-label">Approval Notes</label>
                                    <textarea class="form-textarea" style="background: var(--macos-bg-secondary);" readonly>${loan.approvalNotes}</textarea>
                                </div>
                            ` : ''}
                            
                            ${loan.rejectionReason ? `
                                <div class="form-group">
                                    <label class="form-label">Rejection Reason</label>
                                    <textarea class="form-textarea" style="background: var(--macos-bg-secondary); color: var(--macos-red);" readonly>${loan.rejectionReason}</textarea>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${documentsHTML}
                        ${customerDocumentsHTML}
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="ModalManager.closeLoanModal()">Close</button>
                            ${loan.status === 'pending' ? `
                                <button class="btn btn-success" onclick="LoanManager.approveLoanPrompt('${loan.id}')">
                                    <i class="fas fa-check"></i>
                                    Approve Loan
                                </button>
                                <button class="btn btn-danger" onclick="LoanManager.rejectLoanPrompt('${loan.id}')">
                                    <i class="fas fa-times"></i>
                                    Reject Loan
                                </button>
                            ` : ''}
                            ${loan.status === 'active' ? `
                                <button class="btn btn-primary" onclick="LoanManager.disburseLoan('${loan.id}')">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Mark as Disbursed
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            approveLoanPrompt(loanId) {
                const loan = AppState.loans.find(l => l.id === loanId);
                if (!loan) return;
                
                const approvedAmount = prompt(`Approve loan amount (current: ${Utils.formatCurrency(loan.amount)}):`, loan.amount);
                if (approvedAmount === null) return;
                
                const notes = prompt('Approval notes (optional):', '');
                
                Utils.showLoading('Approving loan...');
                
                FirebaseService.approveLoan(loanId, parseFloat(approvedAmount), notes)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeLoanModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            rejectLoanPrompt(loanId) {
                const reason = prompt('Reason for rejection:', '');
                if (reason === null) return;
                
                Utils.showLoading('Rejecting loan...');
                
                FirebaseService.rejectLoan(loanId, reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeLoanModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            async disburseLoan(loanId) {
                try {
                    Utils.showLoading('Marking as disbursed...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    await loanRef.update({
                        status: 'disbursed',
                        disbursedAt: Date.now(),
                        disbursedBy: AppState.currentUser.uid,
                        disbursedByName: AppState.adminData.fullName,
                        updatedAt: Date.now()
                    });
                    
                    Utils.hideLoading();
                    Utils.showToast('Success', 'Loan marked as disbursed', 'success');
                    ModalManager.closeLoanModal();
                } catch (error) {
                    console.error('Error disbursing loan:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to mark loan as disbursed', 'error');
                }
            }
        };

        // ===== AGENT MANAGER =====
        const AgentManager = {
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    agent.id = agentId;
                    
                    // Load agent's customers
                    const customersRef = db.ref('users').orderByChild('assignedAgentId').equalTo(agentId);
                    const customersSnapshot = await customersRef.once('value');
                    const customers = [];
                    
                    customersSnapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        if (customer.userType === 'customer') {
                            customers.push(customer);
                        }
                    });
                    
                    // Load agent's commissions
                    const commissionsRef = db.ref('commissions').orderByChild('agentId').equalTo(agentId);
                    const commissionsSnapshot = await commissionsRef.once('value');
                    const commissions = [];
                    
                    commissionsSnapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    this.displayAgentModal(agent, customers, commissions);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load agent details', 'error');
                }
            },
            
            displayAgentModal(agent, customers, commissions) {
                const modal = document.getElementById('agentDetailModal');
                const content = document.getElementById('agentDetailContent');
                
                const statusClass = `status-${agent.status}`;
                const statusText = agent.status.charAt(0).toUpperCase() + agent.status.slice(1);
                
                // Calculate commission totals
                const totalCommission = commissions.reduce((sum, com) => sum + (com.amount || 0), 0);
                const pendingCommission = commissions
                    .filter(com => com.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                const paidCommission = commissions
                    .filter(com => com.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                content.innerHTML = `
                    <div class="agent-detail-view">
                        <div class="section-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin-bottom: 4px;">${agent.fullName}</h3>
                                <p style="color: var(--macos-text-secondary);">
                                    ${agent.email} | ${agent.agentId || agent.id.substring(0, 8)}
                                </p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Total Customers</div>
                                <div class="detail-value">${customers.length}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Commission</div>
                                <div class="detail-value">${Utils.formatCurrency(totalCommission)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Pending Commission</div>
                                <div class="detail-value">${Utils.formatCurrency(pendingCommission)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Paid Commission</div>
                                <div class="detail-value">${Utils.formatCurrency(paidCommission)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Agent Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${agent.phone || 'N/A'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Branch/Region</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${agent.branch || 'Not specified'}</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Created</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${Utils.formatDate(agent.createdAt)}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Login</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${agent.lastLogin ? Utils.formatDate(agent.lastLogin) : 'Never'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Assigned Customers (${customers.length})</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customers.length > 0 ? customers.map(customer => `
                                            <tr>
                                                <td>${customer.fullName}</td>
                                                <td>${customer.phone || 'N/A'}</td>
                                                <td>${customer.email}</td>
                                                <td><span class="status-badge status-${customer.status || 'active'}">${customer.status || 'active'}</span></td>
                                                <td>
                                                    <button class="btn btn-outline btn-sm" onclick="CustomerManager.viewCustomerDetails('${customer.id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="5" style="text-align: center; padding: 20px; color: var(--macos-text-tertiary);">
                                                    No customers assigned
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        ${agent.profilePhoto ? `
                            <div style="margin: 24px 0;">
                                <h4 style="margin-bottom: 16px;">Profile Photo</h4>
                                <div style="text-align: center;">
                                    <img src="${agent.profilePhoto}" alt="Profile" style="max-width: 200px; border-radius: var(--macos-radius-md); border: 1px solid var(--macos-gray-2);" onerror="this.style.display='none'">
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="ModalManager.closeAgentModal()">Close</button>
                            <button class="btn btn-primary" onclick="AgentManager.payCommission('${agent.id}')">
                                <i class="fas fa-coins"></i>
                                Pay Commission
                            </button>
                            ${agent.status === 'active' ? `
                                <button class="btn btn-outline" onclick="AgentManager.suspendAgentPrompt('${agent.id}')">
                                    <i class="fas fa-pause"></i>
                                    Suspend
                                </button>
                            ` : agent.status === 'suspended' ? `
                                <button class="btn btn-success" onclick="AgentManager.activateAgent('${agent.id}')">
                                    <i class="fas fa-play"></i>
                                    Activate
                                </button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="AgentManager.banAgentPrompt('${agent.id}')">
                                <i class="fas fa-ban"></i>
                                Ban
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            createNewAgent() {
                const modal = document.getElementById('createAgentModal');
                modal.classList.add('active');
            },
            
            async submitCreateAgent() {
                const formData = {
                    fullName: document.getElementById('agentFullName').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    agentId: document.getElementById('agentId').value.trim(),
                    password: document.getElementById('agentPassword').value,
                    branch: document.getElementById('agentBranch').value.trim(),
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!formData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(formData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(formData.phone)) errors.push('Valid phone number is required');
                if (!formData.agentId) errors.push('Agent ID is required');
                if (formData.password.length < 6) errors.push('Password must be at least 6 characters');
                if (formData.password !== document.getElementById('agentConfirmPassword').value) {
                    errors.push('Passwords do not match');
                }
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                Utils.showLoading('Creating agent account...');
                
                const result = await FirebaseService.createAgentAccount(formData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', result.message, 'success');
                    ModalManager.closeCreateAgentModal();
                    document.getElementById('createAgentForm').reset();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            suspendAgentPrompt(agentId) {
                const reason = prompt('Reason for suspension:', '');
                if (reason === null) return;
                
                Utils.showLoading('Suspending agent...');
                
                FirebaseService.updateAgentStatus(agentId, 'suspended', reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeAgentModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            activateAgent(agentId) {
                Utils.showLoading('Activating agent...');
                
                FirebaseService.updateAgentStatus(agentId, 'active', 'Account reactivated')
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeAgentModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            banAgentPrompt(agentId) {
                if (!confirm('Are you sure you want to ban this agent? This action cannot be undone.')) {
                    return;
                }
                
                const reason = prompt('Reason for ban:', '');
                if (reason === null) return;
                
                Utils.showLoading('Banning agent...');
                
                FirebaseService.updateAgentStatus(agentId, 'banned', reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeAgentModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            async approveAgent(agentId) {
                Utils.showLoading('Approving agent...');
                
                FirebaseService.updateAgentStatus(agentId, 'active', 'Account approved')
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            rejectAgent(agentId) {
                const reason = prompt('Reason for rejection:', '');
                if (reason === null) return;
                
                Utils.showLoading('Rejecting agent...');
                
                FirebaseService.updateAgentStatus(agentId, 'rejected', reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            async viewApplicationDetails(applicationId) {
                try {
                    Utils.showLoading('Loading application...');
                    
                    const applicationRef = db.ref('agentApplications/' + applicationId);
                    const snapshot = await applicationRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Application not found', 'error');
                        return;
                    }
                    
                    const application = snapshot.val();
                    
                    // Display application in modal
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Agent Application Details</h2>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Full Name</label>
                                        <div class="form-input" style="background: var(--macos-bg-secondary);">${application.fullName}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone</label>
                                        <div class="form-input" style="background: var(--macos-bg-secondary);">${application.phone}</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">NRC</label>
                                        <div class="form-input" style="background: var(--macos-bg-secondary);">${application.nrc || 'N/A'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Residence</label>
                                        <div class="form-input" style="background: var(--macos-bg-secondary);">${application.residence}</div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Submitted</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${Utils.formatDate(application.submittedAt)}</div>
                                </div>
                                
                                ${application.nrcFront || application.nrcBack || application.profilePhoto ? `
                                    <div style="margin-top: 24px;">
                                        <h4 style="margin-bottom: 16px;">Documents</h4>
                                        <div class="document-grid">
                                            ${application.nrcFront ? `
                                                <div class="document-card" onclick="DocumentManager.viewDocument('${application.nrcFront}', 'NRC Front')">
                                                    <img src="${application.nrcFront}" alt="NRC Front" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=NRC+Front'">
                                                    <div class="document-info">
                                                        <div class="document-type">NRC Front</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${application.nrcBack ? `
                                                <div class="document-card" onclick="DocumentManager.viewDocument('${application.nrcBack}', 'NRC Back')">
                                                    <img src="${application.nrcBack}" alt="NRC Back" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=NRC+Back'">
                                                    <div class="document-info">
                                                        <div class="document-type">NRC Back</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${application.profilePhoto ? `
                                                <div class="document-card" onclick="DocumentManager.viewDocument('${application.profilePhoto}', 'Profile Photo')">
                                                    <img src="${application.profilePhoto}" alt="Profile" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Profile+Photo'">
                                                    <div class="document-info">
                                                        <div class="document-type">Profile Photo</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                                <button class="btn btn-success" onclick="AgentManager.approveApplication('${applicationId}'); this.closest('.modal').remove();">
                                    <i class="fas fa-check"></i>
                                    Approve
                                </button>
                                <button class="btn btn-danger" onclick="AgentManager.rejectApplication('${applicationId}'); this.closest('.modal').remove();">
                                    <i class="fas fa-times"></i>
                                    Reject
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing application:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load application', 'error');
                }
            },
            
            approveApplication(applicationId) {
                // Generate credentials
                const agentId = 'AG' + Date.now().toString().slice(-6);
                const email = `agent${Date.now().toString().slice(-4)}@trucash.com`;
                const password = Math.random().toString(36).slice(-8);
                
                const credentials = {
                    email: email,
                    password: password,
                    agentId: agentId
                };
                
                Utils.showLoading('Approving application...');
                
                FirebaseService.approveAgentApplication(applicationId, credentials)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            
                            // Show credentials to admin
                            alert(`Agent Account Created Successfully!\n\nEmail: ${email}\nPassword: ${password}\nAgent ID: ${agentId}\n\nPlease save these credentials securely.`);
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            rejectApplication(applicationId) {
                const reason = prompt('Reason for rejection:', '');
                if (reason === null) return;
                
                Utils.showLoading('Rejecting application...');
                
                FirebaseService.rejectAgentApplication(applicationId, reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            async payCommission(agentId) {
                const amount = prompt('Commission amount to pay:');
                if (!amount || isNaN(amount)) return;
                
                const method = prompt('Payment method (Cash/Bank Transfer/Mobile Money):', 'Bank Transfer');
                if (!method) return;
                
                const reference = prompt('Transaction reference:', '');
                
                // Create commission record
                const commissionData = {
                    agentId: agentId,
                    agentName: AppState.agents.find(a => a.id === agentId)?.fullName || 'Unknown',
                    amount: parseFloat(amount),
                    type: 'manual_payment',
                    status: 'paid',
                    paidAt: Date.now(),
                    paidBy: AppState.currentUser.uid,
                    paidByName: AppState.adminData.fullName,
                    payoutMethod: method,
                    payoutReference: reference,
                    createdAt: Date.now()
                };
                
                Utils.showLoading('Processing payment...');
                
                try {
                    const commissionId = Utils.generateId('COM');
                    const commissionRef = db.ref('commissions/' + commissionId);
                    await commissionRef.set(commissionData);
                    
                    // Update agent's commission totals
                    const agentRef = db.ref('users/' + agentId);
                    await agentRef.update({
                        totalCommission: firebase.database.ServerValue.increment(parseFloat(amount)),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('commission_manual_pay', {
                        agentId: agentId,
                        amount: amount,
                        payoutMethod: method
                    });
                    
                    Utils.hideLoading();
                    Utils.showToast('Success', 'Commission paid successfully', 'success');
                    ModalManager.closeAgentModal();
                } catch (error) {
                    console.error('Error paying commission:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to process commission payment', 'error');
                }
            }
        };

        // ===== CUSTOMER MANAGER =====
        const CustomerManager = {
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    customer.id = customerId;
                    
                    // Load customer's loans
                    const loansRef = db.ref('loans').orderByChild('customerId').equalTo(customerId);
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    // Load assigned agent if any
                    let agent = null;
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        const agentSnapshot = await agentRef.once('value');
                        agent = agentSnapshot.val();
                    }
                    
                    this.displayCustomerModal(customer, loans, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load customer details', 'error');
                }
            },
            
            displayCustomerModal(customer, loans, agent) {
                const modal = document.getElementById('customerDetailModal');
                const content = document.getElementById('customerDetailContent');
                
                const statusClass = `status-${customer.status}`;
                const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                
                // Calculate loan totals
                const totalLoans = loans.length;
                const activeLoans = loans.filter(loan => loan.status === 'active').length;
                const totalBorrowed = loans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                const totalBalance = customer.accountBalance || 0;
                
                content.innerHTML = `
                    <div class="customer-detail-view">
                        <div class="section-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin-bottom: 4px;">${customer.fullName}</h3>
                                <p style="color: var(--macos-text-secondary);">
                                    ${customer.email} | ${customer.phone || 'No phone'}
                                </p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 6px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="loan-detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Total Loans</div>
                                <div class="detail-value">${totalLoans}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Active Loans</div>
                                <div class="detail-value">${activeLoans}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Borrowed</div>
                                <div class="detail-value">${Utils.formatCurrency(totalBorrowed)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Account Balance</div>
                                <div class="detail-value">${Utils.formatCurrency(totalBalance)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Customer Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">NRC Number</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${customer.nrc || 'N/A'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Residence</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${customer.residence || 'Not specified'}</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Occupation</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${customer.occupation || 'Not specified'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Monthly Income</label>
                                    <div class="form-input" style="background: var(--macos-bg-secondary);">${Utils.formatCurrency(customer.monthlyIncome || 0)}</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Assigned Agent</label>
                                <div class="form-input" style="background: var(--macos-bg-secondary);">
                                    ${agent ? `${agent.fullName} (${agent.agentId || agent.id.substring(0, 8)})` : 'Not assigned'}
                                </div>
                            </div>
                        </div>
                        
                        ${customer.nrcFront || customer.nrcBack || customer.profilePhoto ? `
                            <div style="margin: 24px 0;">
                                <h4 style="margin-bottom: 16px;">Customer Documents</h4>
                                <div class="document-grid">
                                    ${customer.nrcFront ? `
                                        <div class="document-card" onclick="DocumentManager.viewDocument('${customer.nrcFront}', 'NRC Front')">
                                            <img src="${customer.nrcFront}" alt="NRC Front" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=NRC+Front'">
                                            <div class="document-info">
                                                <div class="document-type">NRC Front</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.nrcBack ? `
                                        <div class="document-card" onclick="DocumentManager.viewDocument('${customer.nrcBack}', 'NRC Back')">
                                            <img src="${customer.nrcBack}" alt="NRC Back" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=NRC+Back'">
                                            <div class="document-info">
                                                <div class="document-type">NRC Back</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.profilePhoto ? `
                                        <div class="document-card" onclick="DocumentManager.viewDocument('${customer.profilePhoto}', 'Profile Photo')">
                                            <img src="${customer.profilePhoto}" alt="Profile" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Profile+Photo'">
                                            <div class="document-info">
                                                <div class="document-type">Profile Photo</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.proofOfIncome ? `
                                        <div class="document-card" onclick="DocumentManager.viewDocument('${customer.proofOfIncome}', 'Proof of Income')">
                                            <img src="${customer.proofOfIncome}" alt="Income Proof" class="document-image" onerror="this.src='https://via.placeholder.com/300x150?text=Income+Proof'">
                                            <div class="document-info">
                                                <div class="document-type">Income Proof</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Loan History (${loans.length})</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Loan ID</th>
                                            <th>Amount</th>
                                            <th>Purpose</th>
                                            <th>Status</th>
                                            <th>Applied</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${loans.length > 0 ? loans.map(loan => `
                                            <tr>
                                                <td>${loan.id}</td>
                                                <td>${Utils.formatCurrency(loan.amount)}</td>
                                                <td>${loan.purpose || 'Not specified'}</td>
                                                <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                                                <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                                                <td>
                                                    <button class="btn btn-outline btn-sm" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="6" style="text-align: center; padding: 20px; color: var(--macos-text-tertiary);">
                                                    No loan history
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="ModalManager.closeCustomerModal()">Close</button>
                            <button class="btn btn-primary" onclick="CustomerManager.assignAgent('${customer.id}')">
                                <i class="fas fa-user-plus"></i>
                                ${agent ? 'Change Agent' : 'Assign Agent'}
                            </button>
                            ${customer.status === 'active' ? `
                                <button class="btn btn-outline" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                    <i class="fas fa-pause"></i>
                                    Suspend
                                </button>
                            ` : customer.status === 'suspended' ? `
                                <button class="btn btn-success" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                    <i class="fas fa-play"></i>
                                    Activate
                                </button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="CustomerManager.banCustomer('${customer.id}')">
                                <i class="fas fa-ban"></i>
                                Ban
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            createNewCustomer() {
                // For now, show a message
                Utils.showToast('Info', 'Customer creation through admin panel coming soon', 'info');
            },
            
            assignAgent(customerId) {
                const customer = AppState.customers.find(c => c.id === customerId);
                if (!customer) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                
                // Filter active agents
                const activeAgents = AppState.agents.filter(agent => agent.status === 'active');
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Assign Agent to ${customer.fullName}</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="agent-assignment">
                                <h4 style="margin-bottom: 16px;">Select an Agent</h4>
                                <div class="agent-list">
                                    ${activeAgents.map(agent => `
                                        <div class="agent-card" onclick="this.classList.toggle('selected')" data-agent-id="${agent.id}">
                                            <div class="agent-name">${agent.fullName}</div>
                                            <div class="agent-id">${agent.agentId || agent.id.substring(0, 8)}</div>
                                            <div style="font-size: 12px; color: var(--macos-text-tertiary); margin-top: 4px;">
                                                ${agent.email}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="CustomerManager.completeAgentAssignment('${customerId}')">
                                <i class="fas fa-check"></i>
                                Assign Selected Agent
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            completeAgentAssignment(customerId) {
                const selectedCard = document.querySelector('.agent-card.selected');
                if (!selectedCard) {
                    Utils.showToast('Error', 'Please select an agent', 'error');
                    return;
                }
                
                const agentId = selectedCard.dataset.agentId;
                
                Utils.showLoading('Assigning agent...');
                
                FirebaseService.assignAgentToCustomer(customerId, agentId)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            document.querySelector('.modal.active').remove();
                            ModalManager.closeCustomerModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            suspendCustomer(customerId) {
                const reason = prompt('Reason for suspension:', '');
                if (reason === null) return;
                
                Utils.showLoading('Suspending customer...');
                
                FirebaseService.updateCustomerStatus(customerId, 'suspended', reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeCustomerModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            activateCustomer(customerId) {
                Utils.showLoading('Activating customer...');
                
                FirebaseService.updateCustomerStatus(customerId, 'active', 'Account reactivated')
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeCustomerModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            },
            
            banCustomer(customerId) {
                if (!confirm('Are you sure you want to ban this customer? This action cannot be undone.')) {
                    return;
                }
                
                const reason = prompt('Reason for ban:', '');
                if (reason === null) return;
                
                Utils.showLoading('Banning customer...');
                
                FirebaseService.updateCustomerStatus(customerId, 'banned', reason)
                    .then(result => {
                        Utils.hideLoading();
                        if (result.success) {
                            Utils.showToast('Success', result.message, 'success');
                            ModalManager.closeCustomerModal();
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    })
                    .catch(error => {
                        Utils.hideLoading();
                        Utils.showToast('Error', error.message, 'error');
                    });
            }
        };

        // ===== DOCUMENT MANAGER =====
        const DocumentManager = {
            viewDocument(url, title = 'Document') {
                const modal = document.getElementById('documentViewerModal');
                const content = document.getElementById('documentViewerContent');
                
                content.innerHTML = `
                    <div style="text-align: center;">
                        <h3 style="margin-bottom: 16px;">${title}</h3>
                        <img src="${url}" alt="${title}" style="max-width: 100%; max-height: 70vh; border-radius: var(--macos-radius-md);" onerror="this.src='https://via.placeholder.com/800x600?text=Document+Not+Available'">
                        <div style="margin-top: 16px;">
                            <a href="${url}" target="_blank" class="btn btn-outline">
                                <i class="fas fa-external-link-alt"></i>
                                Open in New Tab
                            </a>
                            <button class="btn btn-primary" onclick="DocumentManager.downloadDocument('${url}', '${title}')">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            downloadDocument(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || 'document';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // ===== MODAL MANAGER =====
        const ModalManager = {
            closeLoanModal() {
                document.getElementById('loanDetailModal').classList.remove('active');
            },
            
            closeAgentModal() {
                document.getElementById('agentDetailModal').classList.remove('active');
            },
            
            closeCustomerModal() {
                document.getElementById('customerDetailModal').classList.remove('active');
            },
            
            closeCreateAgentModal() {
                document.getElementById('createAgentModal').classList.remove('active');
                document.getElementById('createAgentForm').reset();
            },
            
            closeDocumentViewer() {
                document.getElementById('documentViewerModal').classList.remove('active');
            }
        };

        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Close modals on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        });

        // ===== GLOBAL ACCESS =====
        window.UIManager = UIManager;
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.DocumentManager = DocumentManager;
        window.ModalManager = ModalManager;
        window.FirebaseService = FirebaseService;
        window.Utils = Utils;
    </script>
</body>
</html>
