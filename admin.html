<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruCash - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/cloudinary-core@2.11.4/cloudinary-core-shrinkwrap.min.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== MAC OS THEME ===== */
        :root {
            --macos-white: #ffffff;
            --macos-gray-1: #f5f5f7;
            --macos-gray-2: #e5e5e7;
            --macos-gray-3: #d2d2d7;
            --macos-gray-4: #86868b;
            --macos-gray-5: #515154;
            --macos-gray-6: #1d1d1f;
            
            --macos-blue: #007aff;
            --macos-green: #34c759;
            --macos-orange: #ff9500;
            --macos-red: #ff3b30;
            --macos-purple: #af52de;
            --macos-yellow: #ffcc00;
            
            --macos-radius: 12px;
            --macos-radius-sm: 8px;
            --macos-radius-lg: 20px;
            
            --macos-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --macos-shadow-lg: 0 12px 48px rgba(0, 0, 0, 0.12);
            
            --macos-sidebar-width: 280px;
            --macos-header-height: 60px;
            --macos-sidebar-collapsed: 72px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        body {
            background: var(--macos-white);
            color: var(--macos-gray-6);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== LOADING OVERLAY ===== */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        #loadingOverlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--macos-gray-6);
            margin-bottom: 8px;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: var(--macos-gray-4);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--macos-sidebar-width);
            background: var(--macos-white);
            border-right: 1px solid var(--macos-gray-2);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            margin-bottom: 24px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-gray-4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 24px;
            margin-bottom: 12px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: var(--macos-gray-6);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: var(--macos-gray-1);
        }
        
        .nav-item.active {
            background: var(--macos-gray-1);
            color: var(--macos-blue);
            border-left-color: var(--macos-blue);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: auto;
            min-width: 22px;
            text-align: center;
            font-weight: 600;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--macos-sidebar-width);
            min-height: 100vh;
        }
        
        /* ===== HEADER ===== */
        .header {
            height: var(--macos-header-height);
            background: var(--macos-white);
            border-bottom: 1px solid var(--macos-gray-2);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
            backdrop-filter: blur(10px);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--macos-gray-4);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-input {
            width: 240px;
            padding: 10px 40px 10px 16px;
            background: var(--macos-gray-1);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            border-color: var(--macos-blue);
            background: var(--macos-white);
            width: 300px;
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-gray-4);
        }
        
        .profile-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .profile-menu:hover {
            background: var(--macos-gray-2);
        }
        
        .profile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-purple), var(--macos-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        
        .profile-name {
            font-size: 14px;
            font-weight: 600;
        }
        
        .profile-role {
            font-size: 12px;
            color: var(--macos-gray-4);
        }
        
        /* ===== CONTENT SECTIONS ===== */
        .content-container {
            padding: 32px;
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DASHBOARD ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            padding: 24px;
            box-shadow: var(--macos-shadow);
            border: 1px solid var(--macos-gray-2);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .stat-title {
            font-size: 14px;
            color: var(--macos-gray-4);
            font-weight: 600;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }
        .stat-icon.green { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .stat-icon.orange { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .stat-icon.purple { background: rgba(175, 82, 222, 0.1); color: var(--macos-purple); }
        .stat-icon.red { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }
        .stat-icon.yellow { background: rgba(255, 204, 0, 0.1); color: var(--macos-yellow); }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stat-change.positive { color: var(--macos-green); }
        .stat-change.negative { color: var(--macos-red); }
        
        .chart-container {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            padding: 24px;
            box-shadow: var(--macos-shadow);
            border: 1px solid var(--macos-gray-2);
            margin-bottom: 24px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .chart-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0066cc;
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--macos-gray-3);
            color: var(--macos-gray-6);
        }
        
        .btn-outline:hover {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }
        
        .btn-success {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-danger {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-warning {
            background: var(--macos-orange);
            color: white;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        /* ===== DATA TABLES ===== */
        .data-table-container {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            border: 1px solid var(--macos-gray-2);
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .table-controls {
            display: flex;
            gap: 12px;
        }
        
        .table-filter {
            padding: 8px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            background: var(--macos-white);
            font-size: 14px;
            outline: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--macos-gray-1);
            padding: 16px 24px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-5);
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: var(--macos-gray-1);
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge i {
            font-size: 10px;
        }
        
        .status-pending { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .status-active { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .status-approved { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }
        .status-rejected { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }
        .status-suspended { background: rgba(142, 142, 147, 0.1); color: var(--macos-gray-5); }
        .status-banned { background: rgba(142, 142, 147, 0.1); color: var(--macos-gray-6); }
        .status-completed { background: rgba(175, 82, 222, 0.1); color: var(--macos-purple); }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .modal.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--macos-gray-4);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: var(--macos-gray-1);
            color: var(--macos-gray-6);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* ===== FORM STYLES ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--macos-gray-6);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            transition: all 0.2s;
            background: var(--macos-white);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* ===== DOCUMENT VIEWER ===== */
        .document-viewer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .document-card {
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }
        
        .document-preview {
            height: 120px;
            background: var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-gray-4);
        }
        
        .document-info {
            padding: 12px;
            border-top: 1px solid var(--macos-gray-2);
        }
        
        .document-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .document-type {
            font-size: 11px;
            color: var(--macos-gray-4);
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .toast {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            padding: 16px 20px;
            box-shadow: var(--macos-shadow-lg);
            border-left: 4px solid var(--macos-blue);
            min-width: 300px;
            max-width: 400px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .toast.active {
            transform: translateX(0);
        }
        
        .toast-icon {
            font-size: 20px;
            margin-top: 2px;
        }
        
        .toast.success .toast-icon { color: var(--macos-green); }
        .toast.error .toast-icon { color: var(--macos-red); }
        .toast.warning .toast-icon { color: var(--macos-orange); }
        .toast.info .toast-icon { color: var(--macos-blue); }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--macos-gray-5);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                border-radius: var(--macos-radius-sm);
                background: var(--macos-gray-1);
                border: none;
                cursor: pointer;
                font-size: 20px;
                color: var(--macos-gray-6);
            }
            
            .mobile-menu-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                z-index: 99;
                display: none;
            }
            
            .mobile-menu-overlay.active {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }
            
            .content-container {
                padding: 16px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .table-controls {
                flex-direction: column;
            }
            
            .search-input {
                width: 200px;
            }
            
            .search-input:focus {
                width: 240px;
            }
        }
        
        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--macos-gray-1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-4);
        }
        
        /* ===== DETAIL VIEW ===== */
        .detail-view {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            border: 1px solid var(--macos-gray-2);
            padding: 24px;
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .detail-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .detail-info h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .detail-subtitle {
            color: var(--macos-gray-4);
            font-size: 14px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .detail-card {
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius-sm);
            padding: 16px;
        }
        
        .detail-label {
            font-size: 12px;
            color: var(--macos-gray-4);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ===== COMMISSION DISPLAY ===== */
        .commission-card {
            background: linear-gradient(135deg, var(--macos-purple), var(--macos-blue));
            color: white;
            border-radius: var(--macos-radius);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .commission-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .commission-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ===== LOAN SCHEDULE ===== */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .schedule-table th {
            background: var(--macos-gray-1);
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-gray-5);
        }
        
        .schedule-table td {
            padding: 12px;
            border-bottom: 1px solid var(--macos-gray-2);
            font-size: 13px;
        }
        
        .schedule-table tr:hover {
            background: var(--macos-gray-1);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Loading Admin Panel</div>
            <div class="loading-subtext">Please wait...</div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="logo-text">TruCash Admin</div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Dashboard</div>
                <a href="#" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </a>
                <a href="#" class="nav-item" data-section="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Loan Management</div>
                <a href="#" class="nav-item" data-section="loans">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>All Loans</span>
                    <span id="pendingLoansBadge" class="nav-badge">0</span>
                </a>
                <a href="#" class="nav-item" data-section="approvals">
                    <i class="fas fa-check-circle"></i>
                    <span>Approve Loans</span>
                    <span id="approvalBadge" class="nav-badge">0</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Agent Management</div>
                <a href="#" class="nav-item" data-section="agents">
                    <i class="fas fa-user-tie"></i>
                    <span>All Agents</span>
                    <span id="pendingAgentsBadge" class="nav-badge">0</span>
                </a>
                <a href="#" class="nav-item" data-section="createAgent">
                    <i class="fas fa-user-plus"></i>
                    <span>Create Agent</span>
                </a>
                <a href="#" class="nav-item" data-section="agentApplications">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Applications</span>
                    <span id="applicationsBadge" class="nav-badge">0</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Customer Management</div>
                <a href="#" class="nav-item" data-section="customers">
                    <i class="fas fa-users"></i>
                    <span>All Customers</span>
                </a>
                <a href="#" class="nav-item" data-section="createCustomer">
                    <i class="fas fa-user-plus"></i>
                    <span>Create Customer</span>
                </a>
                <a href="#" class="nav-item" data-section="assignAgents">
                    <i class="fas fa-handshake"></i>
                    <span>Assign Agents</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Financials</div>
                <a href="#" class="nav-item" data-section="commissions">
                    <i class="fas fa-money-check-alt"></i>
                    <span>Commissions</span>
                </a>
                <a href="#" class="nav-item" data-section="transactions">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transactions</span>
                </a>
                <a href="#" class="nav-item" data-section="repayments">
                    <i class="fas fa-calendar-check"></i>
                    <span>Repayments</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="section-title">System</div>
                <a href="#" class="nav-item" data-section="documents">
                    <i class="fas fa-file-alt"></i>
                    <span>Documents</span>
                </a>
                <a href="#" class="nav-item" data-section="audit">
                    <i class="fas fa-history"></i>
                    <span>Audit Log</span>
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="page-title" id="pageTitle">Admin Dashboard</h1>
                        <div class="breadcrumb">
                            <span>Admin</span>
                            <i class="fas fa-chevron-right"></i>
                            <span id="breadcrumbText">Dashboard</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="search-box">
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search everything...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-avatar" id="profileAvatar">A</div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName">Admin</div>
                            <div class="profile-role">Administrator</div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>
            
            <!-- Content Container -->
            <div class="content-container">
                <!-- Dashboard Section -->
                <section id="dashboardSection" class="content-section active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Loans</div>
                                <div class="stat-icon blue">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalLoans">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>12% from last month</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Active Agents</div>
                                <div class="stat-icon green">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="activeAgents">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>8% from last month</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Customers</div>
                                <div class="stat-icon purple">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalCustomers">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>15% from last month</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Pending Approvals</div>
                                <div class="stat-icon orange">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="pendingApprovals">0</div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-down"></i>
                                <span>3 waiting</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Commission Due</div>
                                <div class="stat-icon yellow">
                                    <i class="fas fa-money-check-alt"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="commissionDue">K0.00</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>K5,230.50 pending</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Loan Portfolio</div>
                                <div class="stat-icon red">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="loanPortfolio">K0.00</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>8% growth</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Loan Performance</div>
                            <div class="chart-actions">
                                <select class="table-filter" id="performanceFilter">
                                    <option value="7d">Last 7 Days</option>
                                    <option value="30d" selected>Last 30 Days</option>
                                    <option value="90d">Last 90 Days</option>
                                </select>
                            </div>
                        </div>
                        <canvas id="performanceChart" height="120"></canvas>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Recent Activities</div>
                            <button class="btn btn-outline btn-small" id="refreshActivities">
                                <i class="fas fa-sync"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Action</th>
                                        <th>User</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="activitiesTable">
                                    <!-- Activities will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Loans Section -->
                <section id="loansSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Loans</div>
                            <div class="table-controls">
                                <input type="text" class="search-input" id="loanSearch" placeholder="Search loans...">
                                <select class="table-filter" id="loanStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="active">Active</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="completed">Completed</option>
                                    <option value="defaulted">Defaulted</option>
                                </select>
                                <button class="btn btn-outline btn-small" id="exportLoans">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Purpose</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="loansTable">
                                    <!-- Loans will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Approve Loans Section -->
                <section id="approvalsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Pending Loan Approvals</div>
                            <div class="table-controls">
                                <button class="btn btn-primary btn-small" id="bulkApprove">
                                    <i class="fas fa-check-double"></i>
                                    Bulk Approve
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllLoans"></th>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Purpose</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="approvalsTable">
                                    <!-- Pending loans will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Agents Section -->
                <section id="agentsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Agents</div>
                            <div class="table-controls">
                                <input type="text" class="search-input" id="agentSearch" placeholder="Search agents...">
                                <select class="table-filter" id="agentStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Agent ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Customers</th>
                                        <th>Commission</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTable">
                                    <!-- Agents will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Create Agent Section -->
                <section id="createAgentSection" class="content-section">
                    <div class="detail-view">
                        <h2 style="margin-bottom: 24px;">Create New Agent</h2>
                        <form id="createAgentForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-input" id="agentFullName" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Address *</label>
                                    <input type="email" class="form-input" id="agentEmail" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-input" id="agentPhone" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">NRC Number *</label>
                                    <input type="text" class="form-input" id="agentNRC" placeholder="123456/78/9" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Password *</label>
                                    <input type="text" class="form-input" id="agentPassword" required>
                                    <div style="margin-top: 8px;">
                                        <button type="button" class="btn btn-outline btn-small" id="generatePassword">
                                            <i class="fas fa-key"></i>
                                            Generate Password
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agent ID *</label>
                                    <input type="text" class="form-input" id="agentCustomId" required>
                                    <div style="margin-top: 8px;">
                                        <button type="button" class="btn btn-outline btn-small" id="generateAgentId">
                                            <i class="fas fa-id-card"></i>
                                            Generate ID
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-input" id="agentAddress">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Branch Assignment</label>
                                <select class="form-input form-select" id="agentBranch">
                                    <option value="main">Main Branch</option>
                                    <option value="lusaka">Lusaka Central</option>
                                    <option value="ndola">Ndola</option>
                                    <option value="kitwe">Kitwe</option>
                                    <option value="livingstone">Livingstone</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Commission Rate (%)</label>
                                <input type="number" class="form-input" id="agentCommissionRate" value="2.5" min="1" max="10" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea class="form-input form-textarea" id="agentNotes" rows="3"></textarea>
                            </div>
                            
                            <div class="modal-footer" style="padding: 0; margin-top: 32px; border: none;">
                                <button type="button" class="btn btn-outline" onclick="window.location.reload()">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-user-plus"></i>
                                    Create Agent Account
                                </button>
                            </div>
                        </form>
                    </div>
                </section>
                
                <!-- Agent Applications Section -->
                <section id="agentApplicationsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Agent Applications</div>
                            <button class="btn btn-outline btn-small" id="refreshApplications">
                                <i class="fas fa-sync"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Application ID</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>NRC</th>
                                        <th>Submitted</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsTable">
                                    <!-- Applications will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Customers Section -->
                <section id="customersSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Customers</div>
                            <div class="table-controls">
                                <input type="text" class="search-input" id="customerSearch" placeholder="Search customers...">
                                <select class="table-filter" id="customerStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Agent</th>
                                        <th>Loans</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTable">
                                    <!-- Customers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Create Customer Section -->
                <section id="createCustomerSection" class="content-section">
                    <div class="detail-view">
                        <h2 style="margin-bottom: 24px;">Create New Customer</h2>
                        <form id="createCustomerForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-input" id="customerFullName" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Address *</label>
                                    <input type="email" class="form-input" id="customerEmail" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-input" id="customerPhone" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">NRC Number *</label>
                                    <input type="text" class="form-input" id="customerNRC" placeholder="123456/78/9" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Password *</label>
                                    <input type="text" class="form-input" id="customerPassword" required>
                                    <div style="margin-top: 8px;">
                                        <button type="button" class="btn btn-outline btn-small" id="generateCustomerPassword">
                                            <i class="fas fa-key"></i>
                                            Generate Password
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Address *</label>
                                    <input type="text" class="form-input" id="customerAddress" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">House Number</label>
                                    <input type="text" class="form-input" id="customerHouseNumber">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Occupation</label>
                                    <input type="text" class="form-input" id="customerOccupation">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Monthly Income (ZMW)</label>
                                    <input type="number" class="form-input" id="customerMonthlyIncome">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Assign Agent</label>
                                <select class="form-input form-select" id="customerAgent" required>
                                    <option value="">Select an agent</option>
                                    <!-- Agents will be populated here -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Service Level</label>
                                <select class="form-input form-select" id="customerServiceLevel">
                                    <option value="standard">Standard</option>
                                    <option value="premium">Premium</option>
                                    <option value="vip">VIP</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea class="form-input form-textarea" id="customerNotes" rows="3"></textarea>
                            </div>
                            
                            <div class="modal-footer" style="padding: 0; margin-top: 32px; border: none;">
                                <button type="button" class="btn btn-outline" onclick="window.location.reload()">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-user-plus"></i>
                                    Create Customer Account
                                </button>
                            </div>
                        </form>
                    </div>
                </section>
                
                <!-- Assign Agents Section -->
                <section id="assignAgentsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Assign Agents to Customers</div>
                            <div class="table-controls">
                                <button class="btn btn-primary btn-small" id="bulkAssign">
                                    <i class="fas fa-users"></i>
                                    Bulk Assign
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllCustomers"></th>
                                        <th>Customer</th>
                                        <th>Current Agent</th>
                                        <th>Loans</th>
                                        <th>Status</th>
                                        <th>Assign Agent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assignTable">
                                    <!-- Customers for assignment will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Commissions Section -->
                <section id="commissionsSection" class="content-section">
                    <div class="commission-card">
                        <div class="commission-value" id="totalCommissionValue">K0.00</div>
                        <div class="commission-label">Total Commission Due</div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Commission Payments</div>
                            <div class="table-controls">
                                <select class="table-filter" id="commissionStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <button class="btn btn-primary btn-small" id="processCommissions">
                                    <i class="fas fa-money-check-alt"></i>
                                    Process Payments
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllCommissions"></th>
                                        <th>Commission ID</th>
                                        <th>Agent</th>
                                        <th>Customer</th>
                                        <th>Loan</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="commissionsTable">
                                    <!-- Commissions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Transactions Section -->
                <section id="transactionsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Transactions</div>
                            <div class="table-controls">
                                <input type="text" class="search-input" id="transactionSearch" placeholder="Search transactions...">
                                <select class="table-filter" id="transactionTypeFilter">
                                    <option value="all">All Types</option>
                                    <option value="loan_disbursement">Loan Disbursement</option>
                                    <option value="repayment">Repayment</option>
                                    <option value="commission">Commission</option>
                                    <option value="fee">Fee</option>
                                </select>
                                <button class="btn btn-outline btn-small" id="exportTransactions">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Reference</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTable">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Repayments Section -->
                <section id="repaymentsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Loan Repayments</div>
                            <div class="table-controls">
                                <input type="text" class="search-input" id="repaymentSearch" placeholder="Search repayments...">
                                <select class="table-filter" id="repaymentStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="verified">Verified</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Repayment ID</th>
                                        <th>Loan</th>
                                        <th>Customer</th>
                                        <th>Due Date</th>
                                        <th>Amount Due</th>
                                        <th>Amount Paid</th>
                                        <th>Payment Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="repaymentsTable">
                                    <!-- Repayments will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Documents Section -->
                <section id="documentsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Document Management</div>
                            <div class="table-controls">
                                <select class="table-filter" id="documentTypeFilter">
                                    <option value="all">All Documents</option>
                                    <option value="nrc">NRC Documents</option>
                                    <option value="loan">Loan Documents</option>
                                    <option value="profile">Profile Photos</option>
                                    <option value="income">Proof of Income</option>
                                </select>
                                <input type="text" class="search-input" id="documentSearch" placeholder="Search documents...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="document-viewer" id="documentViewer">
                        <!-- Documents will be loaded here -->
                    </div>
                </section>
                
                <!-- Audit Log Section -->
                <section id="auditSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">System Audit Log</div>
                            <div class="table-controls">
                                <input type="date" class="table-filter" id="auditDateFilter">
                                <select class="table-filter" id="auditUserFilter">
                                    <option value="all">All Users</option>
                                    <option value="admin">Admins Only</option>
                                    <option value="agent">Agents Only</option>
                                    <option value="customer">Customers Only</option>
                                </select>
                                <button class="btn btn-outline btn-small" id="exportAudit">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Action</th>
                                        <th>IP Address</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTable">
                                    <!-- Audit logs will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Analytics Section -->
                <section id="analyticsSection" class="content-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Loan Performance by Month</div>
                            <select class="table-filter" id="analyticsYearFilter">
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <canvas id="loanAnalyticsChart" height="120"></canvas>
                    </div>
                    
                    <div class="dashboard-grid" style="margin-top: 24px;">
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">Agent Performance</div>
                            </div>
                            <canvas id="agentPerformanceChart" height="200"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">Loan Distribution</div>
                            </div>
                            <canvas id="loanDistributionChart" height="200"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- Settings Section -->
                <section id="settingsSection" class="content-section">
                    <div class="detail-view">
                        <h2 style="margin-bottom: 24px;">System Settings</h2>
                        
                        <div class="form-group">
                            <label class="form-label">Default Commission Rate (%)</label>
                            <input type="number" class="form-input" id="defaultCommission" value="2.5" min="0" max="20" step="0.1">
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Minimum Loan Amount (ZMW)</label>
                                <input type="number" class="form-input" id="minLoanAmount" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Amount (ZMW)</label>
                                <input type="number" class="form-input" id="maxLoanAmount" value="50000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Interest Rate (%)</label>
                                <input type="number" class="form-input" id="defaultInterest" value="15">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Loan Term (Months)</label>
                                <input type="number" class="form-input" id="maxLoanTerm" value="24">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Late Payment Penalty (%)</label>
                            <input type="number" class="form-input" id="latePenalty" value="5" min="0" max="50" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">System Notification Email</label>
                            <input type="email" class="form-input" id="systemEmail" value="admin@trucash.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Support Phone Number</label>
                            <input type="text" class="form-input" id="supportPhone" value="+260 123 456 789">
                        </div>
                        
                        <div class="modal-footer" style="padding: 0; margin-top: 32px; border: none;">
                            <button type="button" class="btn btn-outline" id="resetSettings">
                                Reset to Default
                            </button>
                            <button type="button" class="btn btn-primary" id="saveSettings">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    
    <!-- Loan Details Modal -->
    <div class="modal" id="loanDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Loan Details</div>
                <button class="modal-close" id="closeLoanModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="loanDetailContent">
                <!-- Loan details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Customer Details Modal -->
    <div class="modal" id="customerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Customer Details</div>
                <button class="modal-close" id="closeCustomerModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="customerDetailContent">
                <!-- Customer details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Agent Details Modal -->
    <div class="modal" id="agentDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Agent Details</div>
                <button class="modal-close" id="closeAgentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="agentDetailContent">
                <!-- Agent details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Document View Modal -->
    <div class="modal" id="documentModal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header">
                <div class="modal-title">Document Viewer</div>
                <button class="modal-close" id="closeDocumentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 0;">
                <img id="documentImage" src="" alt="Document" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                <div style="padding: 20px;">
                    <a id="documentDownload" href="#" class="btn btn-primary" download>
                        <i class="fas fa-download"></i>
                        Download Document
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Actions Modal -->
    <div class="modal" id="bulkActionModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="bulkActionTitle">Bulk Action</div>
                <button class="modal-close" id="closeBulkModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="bulkActionContent">
                    <!-- Bulk action content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBulkAction">Cancel</button>
                <button class="btn btn-primary" id="confirmBulkAction">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Dropdown -->
    <div class="modal" id="profileDropdown" style="position: fixed; top: 70px; right: 20px; width: 280px; background: var(--macos-white); border-radius: var(--macos-radius); box-shadow: var(--macos-shadow-lg); border: 1px solid var(--macos-gray-2); display: none;">
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div class="profile-avatar" id="dropdownAvatar">A</div>
                <div>
                    <div class="profile-name" id="dropdownName">Admin</div>
                    <div class="profile-role">Administrator</div>
                </div>
            </div>
            
            <div style="border-top: 1px solid var(--macos-gray-2); padding-top: 12px;">
                <div class="nav-item" onclick="AdminManager.showSection('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="nav-item" id="changePasswordBtn">
                    <i class="fas fa-key"></i>
                    <span>Change Password</span>
                </div>
                <div class="nav-item" id="logoutDropdownBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">Change Password</div>
                <button class="modal-close" id="closePasswordModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="passwordChangeForm">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="confirmNewPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelPasswordChange">Cancel</button>
                <button class="btn btn-primary" id="submitPasswordChange">Change Password</button>
            </div>
        </div>
    </div>
    
    <!-- Application Review Modal -->
    <div class="modal" id="reviewApplicationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">Review Agent Application</div>
                <button class="modal-close" id="closeReviewModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="reviewApplicationContent">
                <!-- Application review content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Script -->
    <script>
        // ===== Firebase Configuration =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== Cloudinary Configuration =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'],
            multiple: false
        };

        // ===== Application State =====
        const AppState = {
            currentUser: null,
            adminData: null,
            adminId: null,
            loans: [],
            agents: [],
            customers: [],
            commissions: [],
            transactions: [],
            repayments: [],
            applications: [],
            documents: [],
            auditLogs: [],
            systemSettings: {},
            realtimeListeners: [],
            cloudinaryWidget: null,
            currentSection: 'dashboard',
            charts: {},
            selectedLoans: new Set(),
            selectedCustomers: new Set(),
            selectedCommissions: new Set(),
            filteredData: {
                loans: [],
                agents: [],
                customers: [],
                commissions: []
            }
        };

        // ===== Initialize Firebase =====
        let firebaseApp, auth, db;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }

        // ===== Enhanced Utility Functions =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                container.appendChild(toast);
                toast.classList.add('active');
                
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            calculateDaysBetween(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            generateAgentId() {
                return 'AG' + Math.random().toString(36).substr(2, 6).toUpperCase();
            },
            
            generatePassword(length = 12) {
                const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
                let password = '';
                for (let i = 0; i < length; i++) {
                    const randomIndex = Math.floor(Math.random() * charset.length);
                    password += charset[randomIndex];
                }
                return password;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            truncateText(text, maxLength = 50) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            getStatusColor(status) {
                switch(status) {
                    case 'active':
                    case 'approved':
                    case 'completed':
                    case 'verified':
                    case 'paid':
                        return 'green';
                    case 'pending':
                        return 'orange';
                    case 'suspended':
                    case 'overdue':
                        return 'gray';
                    case 'banned':
                    case 'rejected':
                    case 'defaulted':
                    case 'cancelled':
                        return 'red';
                    default:
                        return 'blue';
                }
            }
        };

        // ===== Firebase Service =====
        const FirebaseService = {
            async checkAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        unsubscribe();
                        
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const userRef = db.ref('users/' + currentUser.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                Utils.showToast('Access Denied', 'Admin account not found', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            if (userData.userType !== 'admin' && userData.userType !== 'sudo') {
                                Utils.showToast('Access Denied', 'This panel is for administrators only', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = currentUser;
                            AppState.adminData = userData;
                            AppState.adminId = currentUser.uid;
                            
                            resolve(userData);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            reject(error);
                        }
                    }, (error) => {
                        console.error('Auth state listener error:', error);
                        window.location.href = 'login.html';
                        resolve(null);
                    });
                });
            },
            
            async loadAllData() {
                try {
                    await Promise.all([
                        this.loadLoans(),
                        this.loadAgents(),
                        this.loadCustomers(),
                        this.loadCommissions(),
                        this.loadTransactions(),
                        this.loadRepayments(),
                        this.loadApplications(),
                        this.loadSystemSettings()
                    ]);
                    
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return false;
                }
            },
            
            async loadLoans() {
                try {
                    const loansRef = db.ref('loans');
                    const snapshot = await loansRef.once('value');
                    
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    AppState.loans = loans;
                    AppState.filteredData.loans = loans;
                    return loans;
                } catch (error) {
                    console.error('Error loading loans:', error);
                    return [];
                }
            },
            
            async loadAgents() {
                try {
                    const agentsRef = db.ref('users');
                    const snapshot = await agentsRef.once('value');
                    
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        if (user.userType === 'agent') {
                            agents.push(user);
                        }
                    });
                    
                    AppState.agents = agents;
                    AppState.filteredData.agents = agents;
                    return agents;
                } catch (error) {
                    console.error('Error loading agents:', error);
                    return [];
                }
            },
            
            async loadCustomers() {
                try {
                    const customersRef = db.ref('users');
                    const snapshot = await customersRef.once('value');
                    
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        if (user.userType === 'customer') {
                            customers.push(user);
                        }
                    });
                    
                    AppState.customers = customers;
                    AppState.filteredData.customers = customers;
                    return customers;
                } catch (error) {
                    console.error('Error loading customers:', error);
                    return [];
                }
            },
            
            async loadCommissions() {
                try {
                    const commissionsRef = db.ref('commissions');
                    const snapshot = await commissionsRef.once('value');
                    
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    AppState.filteredData.commissions = commissions;
                    return commissions;
                } catch (error) {
                    console.error('Error loading commissions:', error);
                    return [];
                }
            },
            
            async loadTransactions() {
                try {
                    const transactionsRef = db.ref('transactions');
                    const snapshot = await transactionsRef.once('value');
                    
                    const transactions = [];
                    snapshot.forEach((childSnapshot) => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        transactions.push(transaction);
                    });
                    
                    AppState.transactions = transactions;
                    return transactions;
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    return [];
                }
            },
            
            async loadRepayments() {
                try {
                    const repaymentsRef = db.ref('repayments');
                    const snapshot = await repaymentsRef.once('value');
                    
                    const repayments = [];
                    snapshot.forEach((childSnapshot) => {
                        const repayment = childSnapshot.val();
                        repayment.id = childSnapshot.key;
                        repayments.push(repayment);
                    });
                    
                    AppState.repayments = repayments;
                    return repayments;
                } catch (error) {
                    console.error('Error loading repayments:', error);
                    return [];
                }
            },
            
            async loadApplications() {
                try {
                    const applicationsRef = db.ref('agentApplications');
                    const snapshot = await applicationsRef.once('value');
                    
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    AppState.applications = applications;
                    return applications;
                } catch (error) {
                    console.error('Error loading applications:', error);
                    return [];
                }
            },
            
            async loadSystemSettings() {
                try {
                    const settingsRef = db.ref('systemSettings');
                    const snapshot = await settingsRef.once('value');
                    
                    if (snapshot.exists()) {
                        AppState.systemSettings = snapshot.val();
                    } else {
                        // Default settings
                        AppState.systemSettings = {
                            defaultCommission: 2.5,
                            minLoanAmount: 100,
                            maxLoanAmount: 50000,
                            defaultInterest: 15,
                            maxLoanTerm: 24,
                            latePenalty: 5,
                            systemEmail: 'admin@trucash.com',
                            supportPhone: '+260 123 456 789'
                        };
                    }
                    
                    return AppState.systemSettings;
                } catch (error) {
                    console.error('Error loading settings:', error);
                    return {};
                }
            },
            
            async updateLoanStatus(loanId, status, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.adminId,
                        updatedByName: AppState.adminData.fullName,
                        statusNotes: notes
                    };
                    
                    if (status === 'approved') {
                        updates.approvedAt = Date.now();
                        updates.approvedBy = AppState.adminId;
                        updates.approvedByName = AppState.adminData.fullName;
                    }
                    
                    await loanRef.update(updates);
                    
                    // Create commission record if loan is approved
                    if (status === 'approved') {
                        const loanSnapshot = await loanRef.once('value');
                        const loan = loanSnapshot.val();
                        
                        const commissionId = Utils.generateId('COM');
                        const commissionRef = db.ref('commissions/' + commissionId);
                        
                        const commissionRate = AppState.systemSettings.defaultCommission || 2.5;
                        const commissionAmount = (loan.amount * commissionRate) / 100;
                        
                        await commissionRef.set({
                            id: commissionId,
                            agentId: loan.agentId,
                            agentName: loan.agentName,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            loanId: loanId,
                            loanAmount: loan.amount,
                            type: 'loan_approval',
                            commissionRate: commissionRate,
                            amount: commissionAmount,
                            status: 'pending',
                            createdAt: Date.now(),
                            dueDate: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days from now
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('loan_status_update', {
                        loanId: loanId,
                        oldStatus: 'pending',
                        newStatus: status,
                        notes: notes,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    // Create notification for agent
                    if (status === 'approved' || status === 'rejected') {
                        await this.createNotification(loan.agentId, 'loan_status_changed', {
                            loanId: loanId,
                            status: status,
                            notes: notes,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: 'Loan status updated successfully' };
                } catch (error) {
                    console.error('Error updating loan status:', error);
                    return { success: false, error: 'Failed to update loan status' };
                }
            },
            
            async createAgent(agentData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.address || '',
                        userType: 'agent',
                        agentId: agentData.customId,
                        branch: agentData.branch || 'main',
                        commissionRate: agentData.commissionRate || 2.5,
                        status: 'active',
                        isApproved: true,
                        approvedBy: AppState.adminId,
                        approvedByName: AppState.adminData.fullName,
                        approvedAt: Date.now(),
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        profilePhoto: '',
                        nrcFront: '',
                        nrcBack: '',
                        additionalDoc: '',
                        totalCustomers: 0,
                        totalLoans: 0,
                        commissionEarned: 0,
                        commissionPending: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Also save to agents collection for easy querying
                    await db.ref('agents/' + agentId).set({
                        agentId: agentData.customId,
                        email: agentData.email,
                        fullName: agentData.fullName,
                        status: 'active'
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_create', {
                        agentId: agentId,
                        agentCustomId: agentData.customId,
                        agentName: agentData.fullName,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    
                    let errorMessage = 'Failed to create agent';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async createCustomer(customerData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        customerData.password
                    );
                    
                    const customerId = userCredential.user.uid;
                    
                    // Prepare customer document
                    const customerDoc = {
                        uid: customerId,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        nrc: customerData.nrc,
                        residence: customerData.address,
                        houseNumber: customerData.houseNumber || '',
                        occupation: customerData.occupation || '',
                        monthlyIncome: customerData.monthlyIncome || 0,
                        userType: 'customer',
                        assignedAgentId: customerData.agentId,
                        serviceLevel: customerData.serviceLevel || 'standard',
                        status: 'active',
                        createdBy: AppState.adminId,
                        createdByName: AppState.adminData.fullName,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        profilePhoto: '',
                        nrcFront: '',
                        nrcBack: '',
                        proofOfIncome: '',
                        accountBalance: 0,
                        totalLoans: 0,
                        activeLoans: 0,
                        totalBorrowed: 0,
                        totalRepaid: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + customerId).set(customerDoc);
                    
                    // Update agent's customer count
                    if (customerData.agentId) {
                        const agentRef = db.ref('users/' + customerData.agentId);
                        await agentRef.update({
                            totalCustomers: firebase.database.ServerValue.increment(1),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('customer_create', {
                        customerId: customerId,
                        customerName: customerData.fullName,
                        agentId: customerData.agentId,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return {
                        success: true,
                        customerId: customerId,
                        message: 'Customer created successfully'
                    };
                } catch (error) {
                    console.error('Error creating customer:', error);
                    
                    let errorMessage = 'Failed to create customer';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateUserStatus(userId, status, userType, notes = '') {
                try {
                    const userRef = db.ref('users/' + userId);
                    
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.adminId,
                        updatedByName: AppState.adminData.fullName,
                        statusNotes: notes
                    };
                    
                    if (status === 'suspended' || status === 'banned') {
                        updates.suspendedAt = Date.now();
                        updates.suspendedBy = AppState.adminId;
                        updates.suspendedByName = AppState.adminData.fullName;
                        updates.suspensionReason = notes;
                    }
                    
                    await userRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('user_status_update', {
                        userId: userId,
                        userType: userType,
                        oldStatus: 'active',
                        newStatus: status,
                        notes: notes,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    // Create notification for user
                    await this.createNotification(userId, 'account_status_changed', {
                        status: status,
                        reason: notes,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'User status updated successfully' };
                } catch (error) {
                    console.error('Error updating user status:', error);
                    return { success: false, error: 'Failed to update user status' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const agentRef = db.ref('users/' + agentId);
                    
                    // Get current data
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    const oldAgentId = customer.assignedAgentId;
                    
                    // Update customer
                    await customerRef.update({
                        assignedAgentId: agentId,
                        updatedAt: Date.now(),
                        updatedBy: AppState.adminId,
                        updatedByName: AppState.adminData.fullName
                    });
                    
                    // Update new agent's customer count
                    await agentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Update old agent's customer count if exists
                    if (oldAgentId) {
                        const oldAgentRef = db.ref('users/' + oldAgentId);
                        await oldAgentRef.update({
                            totalCustomers: firebase.database.ServerValue.increment(-1),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('agent_assignment', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        oldAgentId: oldAgentId,
                        newAgentId: agentId,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    // Create notifications
                    await this.createNotification(customerId, 'agent_assigned', {
                        agentId: agentId,
                        timestamp: Date.now()
                    });
                    
                    await this.createNotification(agentId, 'customer_assigned', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async processCommission(commissionId, action) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const updates = {
                        status: action === 'approve' ? 'paid' : 'cancelled',
                        processedAt: Date.now(),
                        processedBy: AppState.adminId,
                        processedByName: AppState.adminData.fullName
                    };
                    
                    await commissionRef.update(updates);
                    
                    // If approved, update agent's commission earned
                    if (action === 'approve') {
                        const commissionSnapshot = await commissionRef.once('value');
                        const commission = commissionSnapshot.val();
                        
                        const agentRef = db.ref('users/' + commission.agentId);
                        await agentRef.update({
                            commissionEarned: firebase.database.ServerValue.increment(commission.amount),
                            commissionPending: firebase.database.ServerValue.increment(-commission.amount),
                            updatedAt: Date.now()
                        });
                        
                        // Create transaction record
                        const transactionId = Utils.generateId('TXN');
                        const transactionRef = db.ref('transactions/' + transactionId);
                        
                        await transactionRef.set({
                            id: transactionId,
                            type: 'commission_payout',
                            agentId: commission.agentId,
                            agentName: commission.agentName,
                            amount: commission.amount,
                            commissionId: commissionId,
                            status: 'completed',
                            processedBy: AppState.adminId,
                            processedByName: AppState.adminData.fullName,
                            timestamp: Date.now()
                        });
                        
                        // Create notification for agent
                        await this.createNotification(commission.agentId, 'commission_paid', {
                            commissionId: commissionId,
                            amount: commission.amount,
                            timestamp: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('commission_process', {
                        commissionId: commissionId,
                        action: action,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: `Commission ${action}d successfully` };
                } catch (error) {
                    console.error('Error processing commission:', error);
                    return { success: false, error: 'Failed to process commission' };
                }
            },
            
            async updateApplicationStatus(applicationId, status, credentials = null) {
                try {
                    const applicationRef = db.ref('agentApplications/' + applicationId);
                    
                    const updates = {
                        status: status,
                        reviewedAt: Date.now(),
                        reviewedBy: AppState.adminId,
                        reviewedByName: AppState.adminData.fullName
                    };
                    
                    if (credentials) {
                        updates.assignedCredentials = credentials;
                    }
                    
                    await applicationRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('application_review', {
                        applicationId: applicationId,
                        status: status,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: 'Application updated successfully' };
                } catch (error) {
                    console.error('Error updating application:', error);
                    return { success: false, error: 'Failed to update application' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.adminId,
                        userName: AppState.adminData.fullName,
                        userRole: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 1000) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 1000);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createNotification(userId, type, data) {
                try {
                    const notificationId = Utils.generateId('NOT');
                    const notificationRef = db.ref('notifications/' + userId + '/' + notificationId);
                    
                    const notification = {
                        id: notificationId,
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    await notificationRef.set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return null;
                }
            },
            
            async updateSystemSettings(settings) {
                try {
                    const settingsRef = db.ref('systemSettings');
                    await settingsRef.set(settings);
                    
                    AppState.systemSettings = settings;
                    
                    // Create audit log
                    await this.createAuditLog('settings_update', {
                        settings: settings,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: 'Settings updated successfully' };
                } catch (error) {
                    console.error('Error updating settings:', error);
                    return { success: false, error: 'Failed to update settings' };
                }
            },
            
            async changePassword(currentPassword, newPassword) {
                try {
                    // Reauthenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        AppState.currentUser.email,
                        currentPassword
                    );
                    
                    await AppState.currentUser.reauthenticateWithCredential(credential);
                    
                    // Update password
                    await AppState.currentUser.updatePassword(newPassword);
                    
                    // Create audit log
                    await this.createAuditLog('password_change', {
                        adminId: AppState.adminId,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Password changed successfully' };
                } catch (error) {
                    console.error('Error changing password:', error);
                    
                    let errorMessage = 'Failed to change password';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Current password is incorrect';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'New password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.adminId = null;
                    AppState.loans = [];
                    AppState.agents = [];
                    AppState.customers = [];
                    AppState.commissions = [];
                    AppState.transactions = [];
                    AppState.repayments = [];
                    AppState.applications = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    Utils.showToast('Logout Error', 'Failed to sign out properly', 'error');
                }
            }
        };

        // ===== UI Manager =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupResponsive();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.menuToggle = document.getElementById('menuToggle');
                this.mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
                
                // Header elements
                this.profileMenu = document.getElementById('profileMenu');
                this.profileDropdown = document.getElementById('profileDropdown');
                this.profileName = document.getElementById('profileName');
                this.profileAvatar = document.getElementById('profileAvatar');
                this.dropdownName = document.getElementById('dropdownName');
                this.dropdownAvatar = document.getElementById('dropdownAvatar');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                this.logoutDropdownBtn = document.getElementById('logoutDropdownBtn');
                this.changePasswordBtn = document.getElementById('changePasswordBtn');
                
                // Dashboard elements
                this.totalLoans = document.getElementById('totalLoans');
                this.activeAgents = document.getElementById('activeAgents');
                this.totalCustomers = document.getElementById('totalCustomers');
                this.pendingApprovals = document.getElementById('pendingApprovals');
                this.commissionDue = document.getElementById('commissionDue');
                this.loanPortfolio = document.getElementById('loanPortfolio');
                
                // Modals
                this.changePasswordModal = document.getElementById('changePasswordModal');
                this.closePasswordModal = document.getElementById('closePasswordModal');
                this.cancelPasswordChange = document.getElementById('cancelPasswordChange');
                this.submitPasswordChange = document.getElementById('submitPasswordChange');
                
                // Form elements
                this.generatePassword = document.getElementById('generatePassword');
                this.generateAgentId = document.getElementById('generateAgentId');
                this.generateCustomerPassword = document.getElementById('generateCustomerPassword');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Update breadcrumb
                        this.updateBreadcrumb(section);
                        
                        // Close mobile menu
                        if (window.innerWidth <= 1024) {
                            document.getElementById('sidebar').classList.remove('active');
                            this.mobileMenuOverlay.classList.remove('active');
                        }
                    });
                });
                
                // Menu toggle for mobile
                this.menuToggle.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.toggle('active');
                    this.mobileMenuOverlay.classList.toggle('active');
                });
                
                // Mobile menu overlay
                this.mobileMenuOverlay.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('active');
                    this.mobileMenuOverlay.classList.remove('active');
                });
                
                // Profile menu
                this.profileMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.profileDropdown.style.display = this.profileDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Close profile dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.profileMenu.contains(e.target) && !this.profileDropdown.contains(e.target)) {
                        this.profileDropdown.style.display = 'none';
                    }
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                this.logoutDropdownBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Change password
                this.changePasswordBtn.addEventListener('click', () => {
                    this.profileDropdown.style.display = 'none';
                    this.changePasswordModal.classList.add('active');
                });
                
                this.closePasswordModal.addEventListener('click', () => {
                    this.changePasswordModal.classList.remove('active');
                });
                
                this.cancelPasswordChange.addEventListener('click', () => {
                    this.changePasswordModal.classList.remove('active');
                });
                
                this.submitPasswordChange.addEventListener('click', () => {
                    this.changePassword();
                });
                
                // Password change form submit
                document.getElementById('passwordChangeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.changePassword();
                });
                
                // Generate password buttons
                if (this.generatePassword) {
                    this.generatePassword.addEventListener('click', () => {
                        document.getElementById('agentPassword').value = Utils.generatePassword();
                    });
                }
                
                if (this.generateAgentId) {
                    this.generateAgentId.addEventListener('click', () => {
                        document.getElementById('agentCustomId').value = Utils.generateAgentId();
                    });
                }
                
                if (this.generateCustomerPassword) {
                    this.generateCustomerPassword.addEventListener('click', () => {
                        document.getElementById('customerPassword').value = Utils.generatePassword();
                    });
                }
                
                // Agent creation form
                const createAgentForm = document.getElementById('createAgentForm');
                if (createAgentForm) {
                    createAgentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.createAgent();
                    });
                }
                
                // Customer creation form
                const createCustomerForm = document.getElementById('createCustomerForm');
                if (createCustomerForm) {
                    createCustomerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.createCustomer();
                    });
                }
                
                // Settings form
                const saveSettings = document.getElementById('saveSettings');
                if (saveSettings) {
                    saveSettings.addEventListener('click', () => {
                        this.saveSettings();
                    });
                }
                
                const resetSettings = document.getElementById('resetSettings');
                if (resetSettings) {
                    resetSettings.addEventListener('click', () => {
                        this.resetSettings();
                    });
                }
                
                // Search functionality
                const globalSearch = document.getElementById('globalSearch');
                if (globalSearch) {
                    globalSearch.addEventListener('input', Utils.debounce(() => {
                        this.handleGlobalSearch();
                    }, 300));
                }
                
                // Setup real-time listeners for data updates
                this.setupRealtimeListeners();
            },
            
            setupResponsive() {
                const handleResize = () => {
                    if (window.innerWidth > 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                        this.mobileMenuOverlay.classList.remove('active');
                    }
                };
                
                window.addEventListener('resize', handleResize);
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Update profile UI
                    this.updateProfileUI();
                    
                    // Load initial data
                    await FirebaseService.loadAllData();
                    
                    // Setup real-time listeners
                    this.setupRealtimeListeners();
                    
                    // Update dashboard UI
                    this.updateDashboardUI();
                    
                    // Initialize charts
                    this.initCharts();
                    
                    // Load initial section data
                    this.showSection('dashboard');
                    
                    Utils.hideLoading();
                    
                    // Show welcome
                    Utils.showToast('Welcome Admin', 
                        `Hello ${adminData.fullName || 'Admin'}!`, 
                        'success');
                    
                } catch (error) {
                    console.error('Authentication initialization error:', error);
                    Utils.hideLoading();
                    Utils.showToast('Authentication Error', 'Failed to authenticate. Please try again.', 'error');
                }
            },
            
            updateProfileUI() {
                if (!AppState.adminData) return;
                
                const name = AppState.adminData.fullName || 'Admin';
                const initial = name.charAt(0).toUpperCase();
                
                this.profileName.textContent = name;
                this.dropdownName.textContent = name;
                this.profileAvatar.textContent = initial;
                this.dropdownAvatar.textContent = initial;
            },
            
            setupRealtimeListeners() {
                if (!AppState.adminId) return;
                
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    AppState.loans = loans;
                    AppState.filteredData.loans = loans;
                    
                    this.updateDashboardUI();
                    this.updateNavBadges();
                    
                    if (AppState.currentSection === 'loans') {
                        this.updateLoansUI();
                    }
                    
                    if (AppState.currentSection === 'approvals') {
                        this.updateApprovalsUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Agents listener
                const agentsRef = db.ref('users');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        if (user.userType === 'agent') {
                            agents.push(user);
                        }
                    });
                    
                    AppState.agents = agents;
                    AppState.filteredData.agents = agents;
                    
                    this.updateDashboardUI();
                    
                    if (AppState.currentSection === 'agents') {
                        this.updateAgentsUI();
                    }
                    
                    if (AppState.currentSection === 'assignAgents') {
                        this.updateAssignAgentsUI();
                    }
                    
                    // Update agent dropdown in create customer form
                    this.updateAgentDropdown();
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Customers listener
                const customersRef = db.ref('users');
                const customersListener = customersRef.on('value', (snapshot) => {
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        if (user.userType === 'customer') {
                            customers.push(user);
                        }
                    });
                    
                    AppState.customers = customers;
                    AppState.filteredData.customers = customers;
                    
                    this.updateDashboardUI();
                    
                    if (AppState.currentSection === 'customers') {
                        this.updateCustomersUI();
                    }
                    
                    if (AppState.currentSection === 'assignAgents') {
                        this.updateAssignAgentsUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => customersRef.off('value', customersListener));
                
                // Commissions listener
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    AppState.filteredData.commissions = commissions;
                    
                    this.updateDashboardUI();
                    
                    if (AppState.currentSection === 'commissions') {
                        this.updateCommissionsUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Applications listener
                const applicationsRef = db.ref('agentApplications');
                const applicationsListener = applicationsRef.on('value', (snapshot) => {
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    AppState.applications = applications;
                    
                    this.updateDashboardUI();
                    this.updateNavBadges();
                    
                    if (AppState.currentSection === 'agentApplications') {
                        this.updateApplicationsUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => applicationsRef.off('value', applicationsListener));
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                }
                
                // Update page title
                const title = document.getElementById('pageTitle');
                const titles = {
                    dashboard: 'Dashboard',
                    analytics: 'Analytics',
                    loans: 'Loan Management',
                    approvals: 'Approve Loans',
                    agents: 'Agent Management',
                    createAgent: 'Create Agent',
                    agentApplications: 'Agent Applications',
                    customers: 'Customer Management',
                    createCustomer: 'Create Customer',
                    assignAgents: 'Assign Agents',
                    commissions: 'Commission Management',
                    transactions: 'Transactions',
                    repayments: 'Repayments',
                    documents: 'Document Management',
                    audit: 'Audit Log',
                    settings: 'System Settings'
                };
                
                title.textContent = titles[sectionId] || 'Admin Dashboard';
                
                // Load section-specific data
                switch(sectionId) {
                    case 'loans':
                        this.updateLoansUI();
                        break;
                    case 'approvals':
                        this.updateApprovalsUI();
                        break;
                    case 'agents':
                        this.updateAgentsUI();
                        break;
                    case 'agentApplications':
                        this.updateApplicationsUI();
                        break;
                    case 'customers':
                        this.updateCustomersUI();
                        break;
                    case 'assignAgents':
                        this.updateAssignAgentsUI();
                        break;
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                    case 'transactions':
                        this.updateTransactionsUI();
                        break;
                    case 'repayments':
                        this.updateRepaymentsUI();
                        break;
                    case 'documents':
                        this.updateDocumentsUI();
                        break;
                    case 'audit':
                        this.updateAuditUI();
                        break;
                    case 'analytics':
                        this.updateAnalyticsUI();
                        break;
                    case 'settings':
                        this.updateSettingsUI();
                        break;
                }
            },
            
            updateBreadcrumb(sectionId) {
                const breadcrumbText = document.getElementById('breadcrumbText');
                const breadcrumbs = {
                    dashboard: 'Dashboard',
                    analytics: 'Analytics',
                    loans: 'Loans',
                    approvals: 'Approve Loans',
                    agents: 'Agents',
                    createAgent: 'Create Agent',
                    agentApplications: 'Applications',
                    customers: 'Customers',
                    createCustomer: 'Create Customer',
                    assignAgents: 'Assign Agents',
                    commissions: 'Commissions',
                    transactions: 'Transactions',
                    repayments: 'Repayments',
                    documents: 'Documents',
                    audit: 'Audit Log',
                    settings: 'Settings'
                };
                
                breadcrumbText.textContent = breadcrumbs[sectionId] || 'Dashboard';
            },
            
            updateDashboardUI() {
                // Calculate dashboard metrics
                const totalLoans = AppState.loans.length;
                const activeAgents = AppState.agents.filter(a => a.status === 'active').length;
                const totalCustomers = AppState.customers.length;
                
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const pendingApplications = AppState.applications.filter(a => a.status === 'pending').length;
                const pendingApprovals = pendingLoans + pendingApplications;
                
                const commissionDue = AppState.commissions
                    .filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                const loanPortfolio = AppState.loans
                    .filter(l => l.status === 'active')
                    .reduce((sum, loan) => sum + (loan.amount || 0), 0);
                
                // Update UI
                this.totalLoans.textContent = totalLoans;
                this.activeAgents.textContent = activeAgents;
                this.totalCustomers.textContent = totalCustomers;
                this.pendingApprovals.textContent = pendingApprovals;
                this.commissionDue.textContent = Utils.formatCurrency(commissionDue);
                this.loanPortfolio.textContent = Utils.formatCurrency(loanPortfolio);
                
                // Update activities table
                this.updateActivitiesUI();
            },
            
            updateNavBadges() {
                // Pending loans badge
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const pendingLoansBadge = document.getElementById('pendingLoansBadge');
                if (pendingLoansBadge) {
                    pendingLoansBadge.textContent = pendingLoans;
                    pendingLoansBadge.style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                }
                
                // Pending applications badge
                const pendingApplications = AppState.applications.filter(a => a.status === 'pending').length;
                const applicationsBadge = document.getElementById('applicationsBadge');
                if (applicationsBadge) {
                    applicationsBadge.textContent = pendingApplications;
                    applicationsBadge.style.display = pendingApplications > 0 ? 'inline-block' : 'none';
                }
                
                // Approval badge (total pending)
                const totalPending = pendingLoans + pendingApplications;
                const approvalBadge = document.getElementById('approvalBadge');
                if (approvalBadge) {
                    approvalBadge.textContent = totalPending;
                    approvalBadge.style.display = totalPending > 0 ? 'inline-block' : 'none';
                }
                
                // Pending agents badge
                const pendingAgents = AppState.agents.filter(a => a.status === 'pending').length;
                const pendingAgentsBadge = document.getElementById('pendingAgentsBadge');
                if (pendingAgentsBadge) {
                    pendingAgentsBadge.textContent = pendingAgents;
                    pendingAgentsBadge.style.display = pendingAgents > 0 ? 'inline-block' : 'none';
                }
            },
            
            updateActivitiesUI() {
                const activitiesTable = document.getElementById('activitiesTable');
                if (!activitiesTable) return;
                
                // Get recent audit logs (last 10)
                const recentLogs = AppState.auditLogs.slice(0, 10);
                
                if (recentLogs.length === 0) {
                    activitiesTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-history" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No recent activities</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let activitiesHTML = '';
                
                recentLogs.forEach(log => {
                    let actionText = '';
                    let details = '';
                    
                    switch(log.action) {
                        case 'loan_status_update':
                            actionText = 'Loan Status Updated';
                            details = `Loan ${log.data.loanId}: ${log.data.oldStatus}  ${log.data.newStatus}`;
                            break;
                        case 'agent_create':
                            actionText = 'Agent Created';
                            details = `Agent ${log.data.agentName} (${log.data.agentCustomId})`;
                            break;
                        case 'customer_create':
                            actionText = 'Customer Created';
                            details = `Customer ${log.data.customerName}`;
                            break;
                        case 'user_status_update':
                            actionText = 'User Status Updated';
                            details = `${log.data.userType} status changed to ${log.data.newStatus}`;
                            break;
                        case 'agent_assignment':
                            actionText = 'Agent Assigned';
                            details = `Customer ${log.data.customerName} assigned to new agent`;
                            break;
                        case 'commission_process':
                            actionText = 'Commission Processed';
                            details = `Commission ${log.data.commissionId} ${log.data.action}d`;
                            break;
                        default:
                            actionText = log.action.replace(/_/g, ' ');
                            details = JSON.stringify(log.data);
                    }
                    
                    const statusColor = Utils.getStatusColor(log.data.newStatus || '');
                    
                    activitiesHTML += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>${actionText}</td>
                            <td>${log.userName}</td>
                            <td>${Utils.truncateText(details, 60)}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${log.data.newStatus || 'completed'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                activitiesTable.innerHTML = activitiesHTML;
            },
            
            updateLoansUI() {
                const loansTable = document.getElementById('loansTable');
                if (!loansTable) return;
                
                const loans = AppState.filteredData.loans;
                
                if (loans.length === 0) {
                    loansTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-file-invoice-dollar" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No loans found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let loansHTML = '';
                
                loans.forEach(loan => {
                    const statusColor = Utils.getStatusColor(loan.status);
                    
                    loansHTML += `
                        <tr onclick="LoanManager.viewLoanDetails('${loan.id}')" style="cursor: pointer;">
                            <td><strong>${loan.id}</strong></td>
                            <td>${loan.customerName}</td>
                            <td>${loan.agentName || 'Not assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${loan.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="event.stopPropagation(); LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline btn-small" onclick="event.stopPropagation(); LoanManager.editLoan('${loan.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                loansTable.innerHTML = loansHTML;
            },
            
            updateApprovalsUI() {
                const approvalsTable = document.getElementById('approvalsTable');
                if (!approvalsTable) return;
                
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending');
                
                if (pendingLoans.length === 0) {
                    approvalsTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No pending loan approvals</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let approvalsHTML = '';
                
                pendingLoans.forEach(loan => {
                    const isSelected = AppState.selectedLoans.has(loan.id);
                    
                    approvalsHTML += `
                        <tr>
                            <td>
                                <input type="checkbox" class="loan-checkbox" value="${loan.id}" ${isSelected ? 'checked' : ''}>
                            </td>
                            <td><strong>${loan.id}</strong></td>
                            <td>${loan.customerName}</td>
                            <td>${loan.agentName || 'Not assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-success btn-small" onclick="LoanManager.approveLoan('${loan.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="LoanManager.rejectLoan('${loan.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn btn-outline btn-small" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                approvalsTable.innerHTML = approvalsHTML;
                
                // Add checkbox listeners
                const checkboxes = document.querySelectorAll('.loan-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const loanId = e.target.value;
                        if (e.target.checked) {
                            AppState.selectedLoans.add(loanId);
                        } else {
                            AppState.selectedLoans.delete(loanId);
                        }
                        
                        // Update select all checkbox
                        const selectAll = document.getElementById('selectAllLoans');
                        if (selectAll) {
                            selectAll.checked = AppState.selectedLoans.size === pendingLoans.length;
                        }
                    });
                });
                
                // Select all checkbox
                const selectAll = document.getElementById('selectAllLoans');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        const checkboxes = document.querySelectorAll('.loan-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                            if (e.target.checked) {
                                AppState.selectedLoans.add(checkbox.value);
                            } else {
                                AppState.selectedLoans.delete(checkbox.value);
                            }
                        });
                    });
                }
            },
            
            updateAgentsUI() {
                const agentsTable = document.getElementById('agentsTable');
                if (!agentsTable) return;
                
                const agents = AppState.filteredData.agents;
                
                if (agents.length === 0) {
                    agentsTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-user-tie" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No agents found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let agentsHTML = '';
                
                agents.forEach(agent => {
                    const statusColor = Utils.getStatusColor(agent.status);
                    const commissionEarned = agent.commissionEarned || 0;
                    const commissionPending = agent.commissionPending || 0;
                    
                    agentsHTML += `
                        <tr onclick="AgentManager.viewAgentDetails('${agent.id}')" style="cursor: pointer;">
                            <td>${agent.agentId || agent.id.substring(0, 8)}</td>
                            <td>${agent.fullName}</td>
                            <td>${agent.email}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>${Utils.formatCurrency(commissionEarned)}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${agent.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="event.stopPropagation(); AgentManager.viewAgentDetails('${agent.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${agent.status === 'active' ? `
                                        <button class="btn btn-warning btn-small" onclick="event.stopPropagation(); AgentManager.suspendAgent('${agent.id}')">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-success btn-small" onclick="event.stopPropagation(); AgentManager.activateAgent('${agent.id}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); AgentManager.banAgent('${agent.id}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                agentsTable.innerHTML = agentsHTML;
            },
            
            updateApplicationsUI() {
                const applicationsTable = document.getElementById('applicationsTable');
                if (!applicationsTable) return;
                
                const applications = AppState.applications.filter(a => a.status === 'pending');
                
                if (applications.length === 0) {
                    applicationsTable.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-clipboard-check" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No pending applications</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let applicationsHTML = '';
                
                applications.forEach(application => {
                    applicationsHTML += `
                        <tr>
                            <td>${application.id}</td>
                            <td>${application.fullName}</td>
                            <td>${application.phone}</td>
                            <td>${application.nrc}</td>
                            <td>${Utils.formatDateOnly(application.submittedAt)}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-orange), 0.1); color: var(--macos-orange);">
                                    ${application.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="ApplicationManager.reviewApplication('${application.id}')">
                                        <i class="fas fa-eye"></i>
                                        Review
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                applicationsTable.innerHTML = applicationsHTML;
            },
            
            updateCustomersUI() {
                const customersTable = document.getElementById('customersTable');
                if (!customersTable) return;
                
                const customers = AppState.filteredData.customers;
                
                if (customers.length === 0) {
                    customersTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-users" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No customers found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let customersHTML = '';
                
                customers.forEach(customer => {
                    const statusColor = Utils.getStatusColor(customer.status);
                    const agent = AppState.agents.find(a => a.id === customer.assignedAgentId);
                    
                    customersHTML += `
                        <tr onclick="CustomerManager.viewCustomerDetails('${customer.id}')" style="cursor: pointer;">
                            <td>${customer.id.substring(0, 8)}</td>
                            <td>${customer.fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone || 'N/A'}</td>
                            <td>${agent ? agent.fullName : 'Not assigned'}</td>
                            <td>${customer.activeLoans || 0}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${customer.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="event.stopPropagation(); CustomerManager.viewCustomerDetails('${customer.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${customer.status === 'active' ? `
                                        <button class="btn btn-warning btn-small" onclick="event.stopPropagation(); CustomerManager.suspendCustomer('${customer.id}')">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-success btn-small" onclick="event.stopPropagation(); CustomerManager.activateCustomer('${customer.id}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); CustomerManager.banCustomer('${customer.id}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                customersTable.innerHTML = customersHTML;
            },
            
            updateAssignAgentsUI() {
                const assignTable = document.getElementById('assignTable');
                if (!assignTable) return;
                
                const customers = AppState.customers.filter(c => c.status === 'active');
                
                if (customers.length === 0) {
                    assignTable.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-users" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No active customers found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let assignHTML = '';
                
                customers.forEach(customer => {
                    const isSelected = AppState.selectedCustomers.has(customer.id);
                    const currentAgent = AppState.agents.find(a => a.id === customer.assignedAgentId);
                    const activeAgents = AppState.agents.filter(a => a.status === 'active');
                    
                    let agentsOptions = '<option value="">Select Agent</option>';
                    activeAgents.forEach(agent => {
                        const selected = agent.id === customer.assignedAgentId ? 'selected' : '';
                        agentsOptions += `<option value="${agent.id}" ${selected}>${agent.fullName} (${agent.agentId || agent.id.substring(0, 8)})</option>`;
                    });
                    
                    assignHTML += `
                        <tr>
                            <td>
                                <input type="checkbox" class="customer-checkbox" value="${customer.id}" ${isSelected ? 'checked' : ''}>
                            </td>
                            <td>${customer.fullName}</td>
                            <td>${currentAgent ? currentAgent.fullName : 'Not assigned'}</td>
                            <td>${customer.activeLoans || 0}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-green), 0.1); color: var(--macos-green);">
                                    ${customer.status}
                                </span>
                            </td>
                            <td>
                                <select class="form-input form-select agent-select" data-customer-id="${customer.id}" style="width: 100%;">
                                    ${agentsOptions}
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-small" onclick="AgentManager.assignToCustomer('${customer.id}', this)">
                                    <i class="fas fa-save"></i>
                                    Save
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                assignTable.innerHTML = assignHTML;
                
                // Add checkbox listeners
                const checkboxes = document.querySelectorAll('.customer-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const customerId = e.target.value;
                        if (e.target.checked) {
                            AppState.selectedCustomers.add(customerId);
                        } else {
                            AppState.selectedCustomers.delete(customerId);
                        }
                        
                        // Update select all checkbox
                        const selectAll = document.getElementById('selectAllCustomers');
                        if (selectAll) {
                            selectAll.checked = AppState.selectedCustomers.size === customers.length;
                        }
                    });
                });
                
                // Select all checkbox
                const selectAll = document.getElementById('selectAllCustomers');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        const checkboxes = document.querySelectorAll('.customer-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                            if (e.target.checked) {
                                AppState.selectedCustomers.add(checkbox.value);
                            } else {
                                AppState.selectedCustomers.delete(checkbox.value);
                            }
                        });
                    });
                }
            },
            
            updateCommissionsUI() {
                const commissionsTable = document.getElementById('commissionsTable');
                const totalCommissionValue = document.getElementById('totalCommissionValue');
                
                if (!commissionsTable) return;
                
                const commissions = AppState.filteredData.commissions;
                
                // Calculate total commission due
                const totalDue = commissions
                    .filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                if (totalCommissionValue) {
                    totalCommissionValue.textContent = Utils.formatCurrency(totalDue);
                }
                
                if (commissions.length === 0) {
                    commissionsTable.innerHTML = `
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-money-check-alt" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No commissions found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let commissionsHTML = '';
                
                commissions.forEach(commission => {
                    const isSelected = AppState.selectedCommissions.has(commission.id);
                    const statusColor = Utils.getStatusColor(commission.status);
                    
                    commissionsHTML += `
                        <tr>
                            <td>
                                <input type="checkbox" class="commission-checkbox" value="${commission.id}" ${isSelected ? 'checked' : ''}>
                            </td>
                            <td>${commission.id}</td>
                            <td>${commission.agentName}</td>
                            <td>${commission.customerName}</td>
                            <td>${commission.loanId}</td>
                            <td>${Utils.formatCurrency(commission.amount)}</td>
                            <td>${commission.type}</td>
                            <td>${Utils.formatDateOnly(commission.dueDate)}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${commission.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${commission.status === 'pending' ? `
                                        <button class="btn btn-success btn-small" onclick="CommissionManager.approveCommission('${commission.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="CommissionManager.cancelCommission('${commission.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-outline btn-small" onclick="CommissionManager.viewDetails('${commission.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                commissionsTable.innerHTML = commissionsHTML;
                
                // Add checkbox listeners
                const checkboxes = document.querySelectorAll('.commission-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const commissionId = e.target.value;
                        if (e.target.checked) {
                            AppState.selectedCommissions.add(commissionId);
                        } else {
                            AppState.selectedCommissions.delete(commissionId);
                        }
                        
                        // Update select all checkbox
                        const selectAll = document.getElementById('selectAllCommissions');
                        if (selectAll) {
                            selectAll.checked = AppState.selectedCommissions.size === commissions.length;
                        }
                    });
                });
                
                // Select all checkbox
                const selectAll = document.getElementById('selectAllCommissions');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        const checkboxes = document.querySelectorAll('.commission-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                            if (e.target.checked) {
                                AppState.selectedCommissions.add(checkbox.value);
                            } else {
                                AppState.selectedCommissions.delete(checkbox.value);
                            }
                        });
                    });
                }
            },
            
            updateTransactionsUI() {
                const transactionsTable = document.getElementById('transactionsTable');
                if (!transactionsTable) return;
                
                const transactions = AppState.transactions;
                
                if (transactions.length === 0) {
                    transactionsTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-exchange-alt" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No transactions found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let transactionsHTML = '';
                
                transactions.forEach(transaction => {
                    const statusColor = Utils.getStatusColor(transaction.status);
                    
                    transactionsHTML += `
                        <tr>
                            <td>${transaction.id}</td>
                            <td>${Utils.formatDate(transaction.timestamp)}</td>
                            <td>${transaction.type}</td>
                            <td>${transaction.customerName || 'N/A'}</td>
                            <td>${transaction.agentName || 'N/A'}</td>
                            <td>${Utils.formatCurrency(transaction.amount)}</td>
                            <td>${transaction.reference || 'N/A'}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${transaction.status}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                transactionsTable.innerHTML = transactionsHTML;
            },
            
            updateRepaymentsUI() {
                const repaymentsTable = document.getElementById('repaymentsTable');
                if (!repaymentsTable) return;
                
                const repayments = AppState.repayments;
                
                if (repayments.length === 0) {
                    repaymentsTable.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-calendar-check" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No repayments found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let repaymentsHTML = '';
                
                repayments.forEach(repayment => {
                    const statusColor = Utils.getStatusColor(repayment.status);
                    
                    repaymentsHTML += `
                        <tr>
                            <td>${repayment.id}</td>
                            <td>${repayment.loanId}</td>
                            <td>${repayment.customerName}</td>
                            <td>${Utils.formatDateOnly(repayment.dueDate)}</td>
                            <td>${Utils.formatCurrency(repayment.amountDue)}</td>
                            <td>${Utils.formatCurrency(repayment.amountPaid)}</td>
                            <td>${Utils.formatDateOnly(repayment.paymentDate)}</td>
                            <td>
                                <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                    ${repayment.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-small" onclick="RepaymentManager.viewDetails('${repayment.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                repaymentsTable.innerHTML = repaymentsHTML;
            },
            
            updateDocumentsUI() {
                const documentViewer = document.getElementById('documentViewer');
                if (!documentViewer) return;
                
                // Collect all documents from users and loans
                let allDocuments = [];
                
                // Customer documents
                AppState.customers.forEach(customer => {
                    if (customer.profilePhoto) {
                        allDocuments.push({
                            type: 'profile',
                            name: 'Profile Photo',
                            url: customer.profilePhoto,
                            user: customer.fullName,
                            userId: customer.id
                        });
                    }
                    if (customer.nrcFront) {
                        allDocuments.push({
                            type: 'nrc',
                            name: 'NRC Front',
                            url: customer.nrcFront,
                            user: customer.fullName,
                            userId: customer.id
                        });
                    }
                    if (customer.nrcBack) {
                        allDocuments.push({
                            type: 'nrc',
                            name: 'NRC Back',
                            url: customer.nrcBack,
                            user: customer.fullName,
                            userId: customer.id
                        });
                    }
                });
                
                // Agent documents
                AppState.agents.forEach(agent => {
                    if (agent.profilePhoto) {
                        allDocuments.push({
                            type: 'profile',
                            name: 'Profile Photo',
                            url: agent.profilePhoto,
                            user: agent.fullName,
                            userId: agent.id
                        });
                    }
                    if (agent.nrcFront) {
                        allDocuments.push({
                            type: 'nrc',
                            name: 'NRC Front',
                            url: agent.nrcFront,
                            user: agent.fullName,
                            userId: agent.id
                        });
                    }
                    if (agent.nrcBack) {
                        allDocuments.push({
                            type: 'nrc',
                            name: 'NRC Back',
                            url: agent.nrcBack,
                            user: agent.fullName,
                            userId: agent.id
                        });
                    }
                });
                
                if (allDocuments.length === 0) {
                    documentViewer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--macos-gray-4); width: 100%;">
                            <i class="fas fa-file-alt" style="font-size: 32px; margin-bottom: 16px;"></i>
                            <p>No documents found</p>
                        </div>
                    `;
                    return;
                }
                
                let documentsHTML = '';
                
                allDocuments.forEach((doc, index) => {
                    documentsHTML += `
                        <div class="document-card" onclick="DocumentManager.viewDocument('${doc.url}', '${doc.name}')">
                            <div class="document-preview">
                                ${doc.type === 'profile' || doc.type.includes('photo') ? 
                                    `<img src="${doc.url}" alt="${doc.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                    `<i class="fas fa-file-pdf" style="font-size: 32px;"></i>`
                                }
                            </div>
                            <div class="document-info">
                                <div class="document-name">${doc.name}</div>
                                <div class="document-type">${doc.user}</div>
                            </div>
                        </div>
                    `;
                });
                
                documentViewer.innerHTML = documentsHTML;
            },
            
            updateAuditUI() {
                const auditTable = document.getElementById('auditTable');
                if (!auditTable) return;
                
                const auditLogs = AppState.auditLogs;
                
                if (auditLogs.length === 0) {
                    auditTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-gray-4);">
                                    <i class="fas fa-history" style="font-size: 32px; margin-bottom: 16px;"></i>
                                    <p>No audit logs found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let auditHTML = '';
                
                auditLogs.forEach(log => {
                    auditHTML += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>${log.userName}</td>
                            <td>${log.userRole}</td>
                            <td>${log.action.replace(/_/g, ' ')}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                            <td>${Utils.truncateText(JSON.stringify(log.data), 80)}</td>
                        </tr>
                    `;
                });
                
                auditTable.innerHTML = auditHTML;
            },
            
            updateAnalyticsUI() {
                this.initCharts();
            },
            
            updateSettingsUI() {
                const settings = AppState.systemSettings;
                
                document.getElementById('defaultCommission').value = settings.defaultCommission || 2.5;
                document.getElementById('minLoanAmount').value = settings.minLoanAmount || 100;
                document.getElementById('maxLoanAmount').value = settings.maxLoanAmount || 50000;
                document.getElementById('defaultInterest').value = settings.defaultInterest || 15;
                document.getElementById('maxLoanTerm').value = settings.maxLoanTerm || 24;
                document.getElementById('latePenalty').value = settings.latePenalty || 5;
                document.getElementById('systemEmail').value = settings.systemEmail || 'admin@trucash.com';
                document.getElementById('supportPhone').value = settings.supportPhone || '+260 123 456 789';
            },
            
            updateAgentDropdown() {
                const agentDropdown = document.getElementById('customerAgent');
                if (!agentDropdown) return;
                
                const activeAgents = AppState.agents.filter(a => a.status === 'active');
                
                let options = '<option value="">Select an agent</option>';
                activeAgents.forEach(agent => {
                    options += `<option value="${agent.id}">${agent.fullName} (${agent.agentId || agent.id.substring(0, 8)})</option>`;
                });
                
                agentDropdown.innerHTML = options;
            },
            
            async createAgent() {
                const agentData = {
                    fullName: document.getElementById('agentFullName').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    nrc: document.getElementById('agentNRC').value.trim(),
                    address: document.getElementById('agentAddress').value.trim(),
                    customId: document.getElementById('agentCustomId').value.trim(),
                    branch: document.getElementById('agentBranch').value,
                    commissionRate: parseFloat(document.getElementById('agentCommissionRate').value) || 2.5,
                    password: document.getElementById('agentPassword').value,
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!agentData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(agentData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(agentData.phone)) errors.push('Valid phone number is required');
                if (!Utils.validateNRC(agentData.nrc)) errors.push('Valid NRC is required');
                if (!agentData.customId) errors.push('Agent ID is required');
                if (agentData.password.length < 6) errors.push('Password must be at least 6 characters');
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                Utils.showLoading('Creating Agent Account...');
                
                const result = await FirebaseService.createAgent(agentData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent created successfully!', 'success');
                    document.getElementById('createAgentForm').reset();
                } else {
                    Utils.showToast('Creation Failed', result.error, 'error');
                }
            },
            
            async createCustomer() {
                const customerData = {
                    fullName: document.getElementById('customerFullName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    nrc: document.getElementById('customerNRC').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    houseNumber: document.getElementById('customerHouseNumber').value.trim(),
                    occupation: document.getElementById('customerOccupation').value.trim(),
                    monthlyIncome: parseFloat(document.getElementById('customerMonthlyIncome').value) || 0,
                    agentId: document.getElementById('customerAgent').value,
                    serviceLevel: document.getElementById('customerServiceLevel').value,
                    password: document.getElementById('customerPassword').value,
                    notes: document.getElementById('customerNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!customerData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(customerData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(customerData.phone)) errors.push('Valid phone number is required');
                if (!Utils.validateNRC(customerData.nrc)) errors.push('Valid NRC is required');
                if (!customerData.address) errors.push('Address is required');
                if (!customerData.agentId) errors.push('Please assign an agent');
                if (customerData.password.length < 6) errors.push('Password must be at least 6 characters');
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                Utils.showLoading('Creating Customer Account...');
                
                const result = await FirebaseService.createCustomer(customerData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer created successfully!', 'success');
                    document.getElementById('createCustomerForm').reset();
                } else {
                    Utils.showToast('Creation Failed', result.error, 'error');
                }
            },
            
            async saveSettings() {
                const settings = {
                    defaultCommission: parseFloat(document.getElementById('defaultCommission').value) || 2.5,
                    minLoanAmount: parseFloat(document.getElementById('minLoanAmount').value) || 100,
                    maxLoanAmount: parseFloat(document.getElementById('maxLoanAmount').value) || 50000,
                    defaultInterest: parseFloat(document.getElementById('defaultInterest').value) || 15,
                    maxLoanTerm: parseInt(document.getElementById('maxLoanTerm').value) || 24,
                    latePenalty: parseFloat(document.getElementById('latePenalty').value) || 5,
                    systemEmail: document.getElementById('systemEmail').value.trim(),
                    supportPhone: document.getElementById('supportPhone').value.trim()
                };
                
                Utils.showLoading('Saving Settings...');
                
                const result = await FirebaseService.updateSystemSettings(settings);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Settings saved successfully!', 'success');
                } else {
                    Utils.showToast('Save Failed', result.error, 'error');
                }
            },
            
            resetSettings() {
                const defaults = {
                    defaultCommission: 2.5,
                    minLoanAmount: 100,
                    maxLoanAmount: 50000,
                    defaultInterest: 15,
                    maxLoanTerm: 24,
                    latePenalty: 5,
                    systemEmail: 'admin@trucash.com',
                    supportPhone: '+260 123 456 789'
                };
                
                document.getElementById('defaultCommission').value = defaults.defaultCommission;
                document.getElementById('minLoanAmount').value = defaults.minLoanAmount;
                document.getElementById('maxLoanAmount').value = defaults.maxLoanAmount;
                document.getElementById('defaultInterest').value = defaults.defaultInterest;
                document.getElementById('maxLoanTerm').value = defaults.maxLoanTerm;
                document.getElementById('latePenalty').value = defaults.latePenalty;
                document.getElementById('systemEmail').value = defaults.systemEmail;
                document.getElementById('supportPhone').value = defaults.supportPhone;
                
                Utils.showToast('Settings Reset', 'Settings reset to default values', 'info');
            },
            
            async changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    Utils.showToast('Validation Error', 'Please fill all fields', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    Utils.showToast('Validation Error', 'New password must be at least 6 characters', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    Utils.showToast('Validation Error', 'Passwords do not match', 'error');
                    return;
                }
                
                Utils.showLoading('Changing Password...');
                
                const result = await FirebaseService.changePassword(currentPassword, newPassword);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Password changed successfully!', 'success');
                    this.changePasswordModal.classList.remove('active');
                    document.getElementById('passwordChangeForm').reset();
                } else {
                    Utils.showToast('Change Failed', result.error, 'error');
                }
            },
            
            handleGlobalSearch() {
                const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
                
                if (!searchTerm) {
                    // Reset filtered data
                    AppState.filteredData.loans = AppState.loans;
                    AppState.filteredData.agents = AppState.agents;
                    AppState.filteredData.customers = AppState.customers;
                    AppState.filteredData.commissions = AppState.commissions;
                } else {
                    // Filter loans
                    AppState.filteredData.loans = AppState.loans.filter(loan => 
                        loan.id.toLowerCase().includes(searchTerm) ||
                        loan.customerName.toLowerCase().includes(searchTerm) ||
                        loan.agentName.toLowerCase().includes(searchTerm) ||
                        loan.purpose.toLowerCase().includes(searchTerm)
                    );
                    
                    // Filter agents
                    AppState.filteredData.agents = AppState.agents.filter(agent => 
                        agent.fullName.toLowerCase().includes(searchTerm) ||
                        agent.email.toLowerCase().includes(searchTerm) ||
                        agent.phone.toLowerCase().includes(searchTerm) ||
                        (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm))
                    );
                    
                    // Filter customers
                    AppState.filteredData.customers = AppState.customers.filter(customer => 
                        customer.fullName.toLowerCase().includes(searchTerm) ||
                        customer.email.toLowerCase().includes(searchTerm) ||
                        customer.phone.toLowerCase().includes(searchTerm) ||
                        customer.nrc.toLowerCase().includes(searchTerm)
                    );
                    
                    // Filter commissions
                    AppState.filteredData.commissions = AppState.commissions.filter(commission => 
                        commission.agentName.toLowerCase().includes(searchTerm) ||
                        commission.customerName.toLowerCase().includes(searchTerm) ||
                        commission.loanId.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Update current section UI
                switch(AppState.currentSection) {
                    case 'loans':
                        this.updateLoansUI();
                        break;
                    case 'agents':
                        this.updateAgentsUI();
                        break;
                    case 'customers':
                        this.updateCustomersUI();
                        break;
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                }
            },
            
            initCharts() {
                // Performance Chart
                const performanceCtx = document.getElementById('performanceChart');
                if (performanceCtx && !AppState.charts.performance) {
                    AppState.charts.performance = new Chart(performanceCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Loan Volume',
                                data: [50000, 75000, 60000, 90000, 85000, 95000],
                                borderColor: 'var(--macos-blue)',
                                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return 'K' + value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Loan Analytics Chart
                const loanAnalyticsCtx = document.getElementById('loanAnalyticsChart');
                if (loanAnalyticsCtx && !AppState.charts.loanAnalytics) {
                    AppState.charts.loanAnalytics = new Chart(loanAnalyticsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            datasets: [{
                                label: 'Loans Approved',
                                data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45],
                                backgroundColor: 'var(--macos-blue)',
                                borderRadius: 6
                            }, {
                                label: 'Loans Disbursed',
                                data: [10, 15, 12, 20, 18, 25, 22, 30, 28, 35, 32, 40],
                                backgroundColor: 'var(--macos-green)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Agent Performance Chart
                const agentPerformanceCtx = document.getElementById('agentPerformanceChart');
                if (agentPerformanceCtx && !AppState.charts.agentPerformance) {
                    AppState.charts.agentPerformance = new Chart(agentPerformanceCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Agent 1', 'Agent 2', 'Agent 3', 'Agent 4', 'Agent 5'],
                            datasets: [{
                                data: [30, 25, 20, 15, 10],
                                backgroundColor: [
                                    'var(--macos-blue)',
                                    'var(--macos-green)',
                                    'var(--macos-orange)',
                                    'var(--macos-purple)',
                                    'var(--macos-red)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
                
                // Loan Distribution Chart
                const loanDistributionCtx = document.getElementById('loanDistributionChart');
                if (loanDistributionCtx && !AppState.charts.loanDistribution) {
                    AppState.charts.loanDistribution = new Chart(loanDistributionCtx, {
                        type: 'pie',
                        data: {
                            labels: ['Personal', 'Business', 'Education', 'Emergency', 'Other'],
                            datasets: [{
                                data: [40, 25, 15, 10, 10],
                                backgroundColor: [
                                    'var(--macos-blue)',
                                    'var(--macos-green)',
                                    'var(--macos-orange)',
                                    'var(--macos-purple)',
                                    'var(--macos-red)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }
        };

        // ===== Loan Manager =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    // Get customer details
                    let customer = { fullName: 'Unknown' };
                    if (loan.customerId) {
                        const customerRef = db.ref('users/' + loan.customerId);
                        const customerSnapshot = await customerRef.once('value');
                        if (customerSnapshot.exists()) {
                            customer = customerSnapshot.val();
                        }
                    }
                    
                    // Get agent details
                    let agent = { fullName: 'Not assigned' };
                    if (loan.agentId) {
                        const agentRef = db.ref('users/' + loan.agentId);
                        const agentSnapshot = await agentRef.once('value');
                        if (agentSnapshot.exists()) {
                            agent = agentSnapshot.val();
                        }
                    }
                    
                    this.displayLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loan details', 'error');
                }
            },
            
            displayLoanModal(loan, customer, agent) {
                const modal = document.getElementById('loanDetailModal');
                const content = document.getElementById('loanDetailContent');
                
                const statusColor = Utils.getStatusColor(loan.status);
                
                let repaymentScheduleHTML = '';
                if (loan.repaymentSchedule && loan.repaymentSchedule.length > 0) {
                    loan.repaymentSchedule.forEach((installment, index) => {
                        const isOverdue = Utils.calculateDaysBetween(new Date(), new Date(installment.dueDate)) < 0;
                        const status = isOverdue ? 'overdue' : (installment.paid ? 'paid' : 'pending');
                        const statusColor = status === 'paid' ? 'green' : status === 'overdue' ? 'red' : 'orange';
                        
                        repaymentScheduleHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${Utils.formatDateOnly(installment.dueDate)}</td>
                                <td>${Utils.formatCurrency(installment.amount)}</td>
                                <td>
                                    <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor});">
                                        ${status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div>
                                <h3>Loan ${loan.id}</h3>
                                <div class="detail-subtitle">
                                    ${Utils.formatCurrency(loan.amount)}  ${loan.duration} months
                                </div>
                            </div>
                            <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor}); padding: 8px 16px;">
                                ${loan.status}
                            </span>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Customer</div>
                                <div class="detail-value">${customer.fullName}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Agent</div>
                                <div class="detail-value">${agent.fullName}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Interest Rate</div>
                                <div class="detail-value">${loan.interestRate || 15}%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Monthly Payment</div>
                                <div class="detail-value">${Utils.formatCurrency(loan.monthlyPayment)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Loan Purpose</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-sm);">
                                ${loan.purpose || 'No purpose specified'}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Documents</h4>
                            <div class="document-viewer">
                                ${loan.documents && Object.keys(loan.documents).length > 0 ? 
                                    Object.entries(loan.documents).map(([key, url]) => `
                                        <div class="document-card" onclick="DocumentManager.viewDocument('${url}', '${key}')">
                                            <div class="document-preview">
                                                <i class="fas fa-file-pdf"></i>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">${key}</div>
                                                <div class="document-type">Loan Document</div>
                                            </div>
                                        </div>
                                    `).join('') :
                                    '<p style="color: var(--macos-gray-4);">No documents uploaded</p>'
                                }
                            </div>
                        </div>
                        
                        ${repaymentScheduleHTML ? `
                            <div style="margin: 24px 0;">
                                <h4 style="margin-bottom: 16px;">Repayment Schedule</h4>
                                <div class="table-responsive">
                                    <table class="schedule-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Due Date</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${repaymentScheduleHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="modal-footer">
                            ${loan.status === 'pending' ? `
                                <button class="btn btn-success" onclick="LoanManager.approveLoan('${loan.id}')">
                                    <i class="fas fa-check"></i>
                                    Approve Loan
                                </button>
                                <button class="btn btn-danger" onclick="LoanManager.rejectLoan('${loan.id}')">
                                    <i class="fas fa-times"></i>
                                    Reject Loan
                                </button>
                            ` : ''}
                            <button class="btn btn-outline" onclick="modal.classList.remove('active')">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async approveLoan(loanId, notes = '') {
                if (!notes) {
                    notes = prompt('Enter approval notes (optional):', 'Loan approved by admin');
                    if (notes === null) return; // User cancelled
                }
                
                Utils.showLoading('Approving loan...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'approved', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Loan Approved', 'Loan has been approved successfully', 'success');
                    document.getElementById('loanDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Approval Failed', result.error, 'error');
                }
            },
            
            async rejectLoan(loanId, notes = '') {
                if (!notes) {
                    notes = prompt('Enter rejection reason (required):', '');
                    if (!notes) {
                        Utils.showToast('Error', 'Rejection reason is required', 'error');
                        return;
                    }
                }
                
                Utils.showLoading('Rejecting loan...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'rejected', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Loan Rejected', 'Loan has been rejected', 'info');
                    document.getElementById('loanDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Rejection Failed', result.error, 'error');
                }
            },
            
            editLoan(loanId) {
                Utils.showToast('Info', 'Edit loan feature coming soon', 'info');
            }
        };

        // ===== Agent Manager =====
        const AgentManager = {
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    agent.id = agentId;
                    
                    // Get agent's customers
                    const customersRef = db.ref('users');
                    const customersSnapshot = await customersRef.once('value');
                    const customers = [];
                    
                    customersSnapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        if (customer.userType === 'customer' && customer.assignedAgentId === agentId) {
                            customers.push(customer);
                        }
                    });
                    
                    // Get agent's loans
                    const loansRef = db.ref('loans');
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        if (loan.agentId === agentId) {
                            loans.push(loan);
                        }
                    });
                    
                    this.displayAgentModal(agent, customers, loans);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load agent details', 'error');
                }
            },
            
            displayAgentModal(agent, customers, loans) {
                const modal = document.getElementById('agentDetailModal');
                const content = document.getElementById('agentDetailContent');
                
                const statusColor = Utils.getStatusColor(agent.status);
                const commissionEarned = agent.commissionEarned || 0;
                const commissionPending = agent.commissionPending || 0;
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div>
                                <h3>${agent.fullName}</h3>
                                <div class="detail-subtitle">
                                    ${agent.agentId || agent.id.substring(0, 8)}  ${agent.email}
                                </div>
                            </div>
                            <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor}); padding: 8px 16px;">
                                ${agent.status}
                            </span>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">${agent.phone || 'N/A'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Branch</div>
                                <div class="detail-value">${agent.branch || 'Main'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Commission Rate</div>
                                <div class="detail-value">${agent.commissionRate || 2.5}%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Customers</div>
                                <div class="detail-value">${agent.totalCustomers || 0}</div>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Commission Earned</div>
                                <div class="detail-value">${Utils.formatCurrency(commissionEarned)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Commission Pending</div>
                                <div class="detail-value">${Utils.formatCurrency(commissionPending)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Loans</div>
                                <div class="detail-value">${agent.totalLoans || 0}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Active Since</div>
                                <div class="detail-value">${Utils.formatDateOnly(agent.createdAt)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Documents</h4>
                            <div class="document-viewer">
                                ${agent.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${agent.profilePhoto}', 'Profile Photo')">
                                        <div class="document-preview">
                                            <img src="${agent.profilePhoto}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Agent</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${agent.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${agent.nrcFront}', 'NRC Front')">
                                        <div class="document-preview">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Agent</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${agent.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${agent.nrcBack}', 'NRC Back')">
                                        <div class="document-preview">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Agent</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${!agent.profilePhoto && !agent.nrcFront && !agent.nrcBack ? 
                                    '<p style="color: var(--macos-gray-4);">No documents uploaded</p>' : ''
                                }
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Agent Actions</h4>
                            <div class="action-buttons" style="flex-wrap: wrap; gap: 8px;">
                                ${agent.status === 'active' ? `
                                    <button class="btn btn-warning" onclick="AgentManager.suspendAgent('${agent.id}')">
                                        <i class="fas fa-pause"></i>
                                        Suspend Agent
                                    </button>
                                ` : `
                                    <button class="btn btn-success" onclick="AgentManager.activateAgent('${agent.id}')">
                                        <i class="fas fa-play"></i>
                                        Activate Agent
                                    </button>
                                `}
                                <button class="btn btn-danger" onclick="AgentManager.banAgent('${agent.id}')">
                                    <i class="fas fa-ban"></i>
                                    Ban Agent
                                </button>
                                <button class="btn btn-primary" onclick="AgentManager.resetPassword('${agent.id}')">
                                    <i class="fas fa-key"></i>
                                    Reset Password
                                </button>
                                <button class="btn btn-outline" onclick="AgentManager.viewPerformance('${agent.id}')">
                                    <i class="fas fa-chart-line"></i>
                                    Performance
                                </button>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="modal.classList.remove('active')">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async suspendAgent(agentId, notes = '') {
                if (!notes) {
                    notes = prompt('Enter suspension reason (required):', '');
                    if (!notes) {
                        Utils.showToast('Error', 'Suspension reason is required', 'error');
                        return;
                    }
                }
                
                if (!confirm('Are you sure you want to suspend this agent?')) return;
                
                Utils.showLoading('Suspending agent...');
                
                const result = await FirebaseService.updateUserStatus(agentId, 'suspended', 'agent', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Agent Suspended', 'Agent has been suspended', 'warning');
                    document.getElementById('agentDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Suspension Failed', result.error, 'error');
                }
            },
            
            async activateAgent(agentId) {
                if (!confirm('Are you sure you want to activate this agent?')) return;
                
                Utils.showLoading('Activating agent...');
                
                const result = await FirebaseService.updateUserStatus(agentId, 'active', 'agent', 'Agent reactivated by admin');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Agent Activated', 'Agent has been activated', 'success');
                    document.getElementById('agentDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Activation Failed', result.error, 'error');
                }
            },
            
            async banAgent(agentId, notes = '') {
                if (!notes) {
                    notes = prompt('Enter ban reason (required):', '');
                    if (!notes) {
                        Utils.showToast('Error', 'Ban reason is required', 'error');
                        return;
                    }
                }
                
                if (!confirm('Are you sure you want to ban this agent? This action cannot be undone.')) return;
                
                Utils.showLoading('Banning agent...');
                
                const result = await FirebaseService.updateUserStatus(agentId, 'banned', 'agent', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Agent Banned', 'Agent has been banned', 'error');
                    document.getElementById('agentDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Ban Failed', result.error, 'error');
                }
            },
            
            async assignToCustomer(customerId, buttonElement) {
                const row = buttonElement.closest('tr');
                const selectElement = row.querySelector('.agent-select');
                const agentId = selectElement.value;
                
                if (!agentId) {
                    Utils.showToast('Error', 'Please select an agent', 'error');
                    return;
                }
                
                Utils.showLoading('Assigning agent...');
                
                const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent assigned successfully', 'success');
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> Assigned';
                    buttonElement.classList.remove('btn-primary');
                    buttonElement.classList.add('btn-success');
                    buttonElement.disabled = true;
                } else {
                    Utils.showToast('Assignment Failed', result.error, 'error');
                }
            },
            
            resetPassword(agentId) {
                Utils.showToast('Info', 'Password reset feature coming soon', 'info');
            },
            
            viewPerformance(agentId) {
                Utils.showToast('Info', 'Performance view feature coming soon', 'info');
            }
        };

        // ===== Customer Manager =====
        const CustomerManager = {
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    customer.id = customerId;
                    
                    // Get assigned agent details
                    let agent = { fullName: 'Not assigned' };
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        const agentSnapshot = await agentRef.once('value');
                        if (agentSnapshot.exists()) {
                            agent = agentSnapshot.val();
                        }
                    }
                    
                    // Get customer's loans
                    const loansRef = db.ref('loans');
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        if (loan.customerId === customerId) {
                            loans.push(loan);
                        }
                    });
                    
                    this.displayCustomerModal(customer, agent, loans);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load customer details', 'error');
                }
            },
            
            displayCustomerModal(customer, agent, loans) {
                const modal = document.getElementById('customerDetailModal');
                const content = document.getElementById('customerDetailContent');
                
                const statusColor = Utils.getStatusColor(customer.status);
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div>
                                <h3>${customer.fullName}</h3>
                                <div class="detail-subtitle">
                                    ${customer.email}  ${customer.phone || 'No phone'}
                                </div>
                            </div>
                            <span class="status-badge" style="background: rgba(var(--macos-${statusColor}), 0.1); color: var(--macos-${statusColor}); padding: 8px 16px;">
                                ${customer.status}
                            </span>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">NRC Number</div>
                                <div class="detail-value">${customer.nrc || 'N/A'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">${customer.residence || 'N/A'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Occupation</div>
                                <div class="detail-value">${customer.occupation || 'N/A'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Monthly Income</div>
                                <div class="detail-value">${Utils.formatCurrency(customer.monthlyIncome || 0)}</div>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Assigned Agent</div>
                                <div class="detail-value">${agent.fullName}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Loans</div>
                                <div class="detail-value">${customer.totalLoans || 0}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Active Loans</div>
                                <div class="detail-value">${customer.activeLoans || 0}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Account Balance</div>
                                <div class="detail-value">${Utils.formatCurrency(customer.accountBalance || 0)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Documents</h4>
                            <div class="document-viewer">
                                ${customer.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.profilePhoto}', 'Profile Photo')">
                                        <div class="document-preview">
                                            <img src="${customer.profilePhoto}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.nrcFront}', 'NRC Front')">
                                        <div class="document-preview">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.nrcBack}', 'NRC Back')">
                                        <div class="document-preview">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.proofOfIncome ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${customer.proofOfIncome}', 'Proof of Income')">
                                        <div class="document-preview">
                                            <i class="fas fa-file-invoice-dollar"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Proof of Income</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${!customer.profilePhoto && !customer.nrcFront && !customer.nrcBack && !customer.proofOfIncome ? 
                                    '<p style="color: var(--macos-gray-4);">No documents uploaded</p>' : ''
                                }
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Customer Actions</h4>
                            <div class="action-buttons" style="flex-wrap: wrap; gap: 8px;">
                                ${customer.status === 'active' ? `
                                    <button class="btn btn-warning" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                        <i class="fas fa-pause"></i>
                                        Suspend Customer
                                    </button>
                                ` : `
                                    <button class="btn btn-success" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                        <i class="fas fa-play"></i>
                                        Activate Customer
                                    </button>
                                `}
                                <button class="btn btn-danger" onclick="CustomerManager.banCustomer('${customer.id}')">
                                    <i class="fas fa-ban"></i>
                                    Ban Customer
                                </button>
                                <button class="btn btn-primary" onclick="CustomerManager.createLoan('${customer.id}')">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    Create Loan
                                </button>
                                <button class="btn btn-outline" onclick="CustomerManager.viewTransactions('${customer.id}')">
                                    <i class="fas fa-history"></i>
                                    Transaction History
                                </button>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="modal.classList.remove('active')">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async suspendCustomer(customerId, notes = '') {
                if (!notes) {
                    notes = prompt('Enter suspension reason (required):', '');
                    if (!notes) {
                        Utils.showToast('Error', 'Suspension reason is required', 'error');
                        return;
                    }
                }
                
                if (!confirm('Are you sure you want to suspend this customer?')) return;
                
                Utils.showLoading('Suspending customer...');
                
                const result = await FirebaseService.updateUserStatus(customerId, 'suspended', 'customer', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Customer Suspended', 'Customer has been suspended', 'warning');
                    document.getElementById('customerDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Suspension Failed', result.error, 'error');
                }
            },
            
            async activateCustomer(customerId) {
                if (!confirm('Are you sure you want to activate this customer?')) return;
                
                Utils.showLoading('Activating customer...');
                
                const result = await FirebaseService.updateUserStatus(customerId, 'active', 'customer', 'Customer reactivated by admin');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Customer Activated', 'Customer has been activated', 'success');
                    document.getElementById('customerDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Activation Failed', result.error, 'error');
                }
            },
            
            async banCustomer(customerId, notes = '') {
                if (!notes) {
                    notes = prompt('Enter ban reason (required):', '');
                    if (!notes) {
                        Utils.showToast('Error', 'Ban reason is required', 'error');
                        return;
                    }
                }
                
                if (!confirm('Are you sure you want to ban this customer? This action cannot be undone.')) return;
                
                Utils.showLoading('Banning customer...');
                
                const result = await FirebaseService.updateUserStatus(customerId, 'banned', 'customer', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Customer Banned', 'Customer has been banned', 'error');
                    document.getElementById('customerDetailModal').classList.remove('active');
                } else {
                    Utils.showToast('Ban Failed', result.error, 'error');
                }
            },
            
            createLoan(customerId) {
                Utils.showToast('Info', 'Create loan feature coming soon', 'info');
            },
            
            viewTransactions(customerId) {
                Utils.showToast('Info', 'Transaction history feature coming soon', 'info');
            }
        };

        // ===== Commission Manager =====
        const CommissionManager = {
            async approveCommission(commissionId) {
                if (!confirm('Are you sure you want to approve this commission payment?')) return;
                
                Utils.showLoading('Approving commission...');
                
                const result = await FirebaseService.processCommission(commissionId, 'approve');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Commission Approved', 'Commission has been approved and paid', 'success');
                } else {
                    Utils.showToast('Approval Failed', result.error, 'error');
                }
            },
            
            async cancelCommission(commissionId) {
                if (!confirm('Are you sure you want to cancel this commission?')) return;
                
                Utils.showLoading('Cancelling commission...');
                
                const result = await FirebaseService.processCommission(commissionId, 'cancel');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Commission Cancelled', 'Commission has been cancelled', 'info');
                } else {
                    Utils.showToast('Cancellation Failed', result.error, 'error');
                }
            },
            
            viewDetails(commissionId) {
                Utils.showToast('Info', 'Commission details feature coming soon', 'info');
            }
        };

        // ===== Repayment Manager =====
        const RepaymentManager = {
            viewDetails(repaymentId) {
                Utils.showToast('Info', 'Repayment details feature coming soon', 'info');
            }
        };

        // ===== Application Manager =====
        const ApplicationManager = {
            async reviewApplication(applicationId) {
                try {
                    Utils.showLoading('Loading application...');
                    
                    const application = AppState.applications.find(a => a.id === applicationId);
                    
                    if (!application) {
                        Utils.showToast('Error', 'Application not found', 'error');
                        return;
                    }
                    
                    this.displayApplicationModal(application);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error reviewing application:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load application', 'error');
                }
            },
            
            displayApplicationModal(application) {
                const modal = document.getElementById('reviewApplicationModal');
                const content = document.getElementById('reviewApplicationContent');
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div>
                                <h3>Agent Application</h3>
                                <div class="detail-subtitle">
                                    ${application.fullName}  ${application.id}
                                </div>
                            </div>
                            <span class="status-badge" style="background: rgba(var(--macos-orange), 0.1); color: var(--macos-orange); padding: 8px 16px;">
                                ${application.status}
                            </span>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value">${application.fullName}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">${application.phone}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">NRC</div>
                                <div class="detail-value">${application.nrc}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Submitted</div>
                                <div class="detail-value">${Utils.formatDate(application.submittedAt)}</div>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">${application.residence || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Documents</h4>
                            <div class="document-viewer">
                                ${application.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${application.profilePhoto}', 'Profile Photo')">
                                        <div class="document-preview">
                                            <img src="${application.profilePhoto}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Application</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${application.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${application.nrcFront}', 'NRC Front')">
                                        <div class="document-preview">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Application</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${application.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${application.nrcBack}', 'NRC Back')">
                                        <div class="document-preview">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Application</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${application.additionalDoc ? `
                                    <div class="document-card" onclick="DocumentManager.viewDocument('${application.additionalDoc}', 'Additional Document')">
                                        <div class="document-preview">
                                            <i class="fas fa-file"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Additional Document</div>
                                            <div class="document-type">Application</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${!application.profilePhoto && !application.nrcFront && !application.nrcBack && !application.additionalDoc ? 
                                    '<p style="color: var(--macos-gray-4);">No documents uploaded</p>' : ''
                                }
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 16px;">Application Actions</h4>
                            <div class="action-buttons" style="flex-wrap: wrap; gap: 8px;">
                                <button class="btn btn-success" onclick="ApplicationManager.approveApplication('${application.id}')">
                                    <i class="fas fa-check"></i>
                                    Approve Application
                                </button>
                                <button class="btn btn-danger" onclick="ApplicationManager.rejectApplication('${application.id}')">
                                    <i class="fas fa-times"></i>
                                    Reject Application
                                </button>
                                <button class="btn btn-outline" onclick="ApplicationManager.requestMoreInfo('${application.id}')">
                                    <i class="fas fa-question-circle"></i>
                                    Request More Info
                                </button>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="modal.classList.remove('active')">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async approveApplication(applicationId) {
                // Generate credentials
                const application = AppState.applications.find(a => a.id === applicationId);
                const agentId = Utils.generateAgentId();
                const password = Utils.generatePassword();
                
                const credentials = {
                    email: `${application.fullName.toLowerCase().replace(/\s+/g, '.')}.${agentId.toLowerCase()}@trucash.com`,
                    password: password,
                    agentId: agentId
                };
                
                // Show credentials to admin
                const confirmApprove = confirm(`Generated credentials:\n\nEmail: ${credentials.email}\nPassword: ${password}\nAgent ID: ${agentId}\n\nCopy these credentials before approving.`);
                
                if (!confirmApprove) return;
                
                Utils.showLoading('Approving application...');
                
                const result = await FirebaseService.updateApplicationStatus(applicationId, 'approved', credentials);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Application Approved', 'Application has been approved', 'success');
                    document.getElementById('reviewApplicationModal').classList.remove('active');
                } else {
                    Utils.showToast('Approval Failed', result.error, 'error');
                }
            },
            
            async rejectApplication(applicationId) {
                const reason = prompt('Enter rejection reason (required):', '');
                if (!reason) {
                    Utils.showToast('Error', 'Rejection reason is required', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to reject this application?')) return;
                
                Utils.showLoading('Rejecting application...');
                
                const result = await FirebaseService.updateApplicationStatus(applicationId, 'rejected');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Application Rejected', 'Application has been rejected', 'info');
                    document.getElementById('reviewApplicationModal').classList.remove('active');
                } else {
                    Utils.showToast('Rejection Failed', result.error, 'error');
                }
            },
            
            requestMoreInfo(applicationId) {
                const infoRequest = prompt('What additional information do you need?', '');
                if (!infoRequest) return;
                
                Utils.showToast('Info Request Sent', 'Request for more information has been sent', 'info');
            }
        };

        // ===== Document Manager =====
        const DocumentManager = {
            viewDocument(url, name) {
                const modal = document.getElementById('documentModal');
                const image = document.getElementById('documentImage');
                const downloadLink = document.getElementById('documentDownload');
                
                image.src = url;
                downloadLink.href = url;
                downloadLink.download = name;
                
                modal.classList.add('active');
            }
        };

        // ===== Bulk Action Manager =====
        const BulkActionManager = {
            async processBulkLoans() {
                if (AppState.selectedLoans.size === 0) {
                    Utils.showToast('Error', 'No loans selected', 'error');
                    return;
                }
                
                const action = confirm(`Approve ${AppState.selectedLoans.size} selected loans?`);
                if (!action) return;
                
                Utils.showLoading(`Processing ${AppState.selectedLoans.size} loans...`);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const loanId of AppState.selectedLoans) {
                    const result = await FirebaseService.updateLoanStatus(loanId, 'approved', 'Bulk approved by admin');
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                Utils.hideLoading();
                
                if (errorCount === 0) {
                    Utils.showToast('Bulk Approval Complete', `${successCount} loans approved successfully`, 'success');
                } else {
                    Utils.showToast('Bulk Approval Partial', `${successCount} loans approved, ${errorCount} failed`, 'warning');
                }
                
                AppState.selectedLoans.clear();
            },
            
            async processBulkAssignments() {
                if (AppState.selectedCustomers.size === 0) {
                    Utils.showToast('Error', 'No customers selected', 'error');
                    return;
                }
                
                const agentId = prompt('Enter Agent ID to assign all selected customers:', '');
                if (!agentId) return;
                
                // Verify agent exists
                const agent = AppState.agents.find(a => a.id === agentId || a.agentId === agentId);
                if (!agent) {
                    Utils.showToast('Error', 'Agent not found', 'error');
                    return;
                }
                
                if (!confirm(`Assign ${AppState.selectedCustomers.size} customers to ${agent.fullName}?`)) return;
                
                Utils.showLoading(`Assigning ${AppState.selectedCustomers.size} customers...`);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const customerId of AppState.selectedCustomers) {
                    const result = await FirebaseService.assignAgentToCustomer(customerId, agent.id);
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                Utils.hideLoading();
                
                if (errorCount === 0) {
                    Utils.showToast('Bulk Assignment Complete', `${successCount} customers assigned successfully`, 'success');
                } else {
                    Utils.showToast('Bulk Assignment Partial', `${successCount} customers assigned, ${errorCount} failed`, 'warning');
                }
                
                AppState.selectedCustomers.clear();
            },
            
            async processBulkCommissions() {
                if (AppState.selectedCommissions.size === 0) {
                    Utils.showToast('Error', 'No commissions selected', 'error');
                    return;
                }
                
                if (!confirm(`Approve ${AppState.selectedCommissions.size} selected commissions?`)) return;
                
                Utils.showLoading(`Processing ${AppState.selectedCommissions.size} commissions...`);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const commissionId of AppState.selectedCommissions) {
                    const result = await FirebaseService.processCommission(commissionId, 'approve');
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                Utils.hideLoading();
                
                if (errorCount === 0) {
                    Utils.showToast('Bulk Payment Complete', `${successCount} commissions approved successfully`, 'success');
                } else {
                    Utils.showToast('Bulk Payment Partial', `${successCount} commissions approved, ${errorCount} failed`, 'warning');
                }
                
                AppState.selectedCommissions.clear();
            }
        };

        // ===== Initialize Application =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Close modals with escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // Bulk action buttons
            document.getElementById('bulkApprove')?.addEventListener('click', () => {
                BulkActionManager.processBulkLoans();
            });
            
            document.getElementById('bulkAssign')?.addEventListener('click', () => {
                BulkActionManager.processBulkAssignments();
            });
            
            document.getElementById('processCommissions')?.addEventListener('click', () => {
                BulkActionManager.processBulkCommissions();
            });
            
            // Search and filter handlers
            document.getElementById('loanSearch')?.addEventListener('input', Utils.debounce(() => {
                UIManager.handleGlobalSearch();
            }, 300));
            
            document.getElementById('loanStatusFilter')?.addEventListener('change', (e) => {
                const status = e.target.value;
                if (status === 'all') {
                    AppState.filteredData.loans = AppState.loans;
                } else {
                    AppState.filteredData.loans = AppState.loans.filter(l => l.status === status);
                }
                UIManager.updateLoansUI();
            });
            
            document.getElementById('agentSearch')?.addEventListener('input', Utils.debounce(() => {
                UIManager.handleGlobalSearch();
            }, 300));
            
            document.getElementById('agentStatusFilter')?.addEventListener('change', (e) => {
                const status = e.target.value;
                if (status === 'all') {
                    AppState.filteredData.agents = AppState.agents;
                } else {
                    AppState.filteredData.agents = AppState.agents.filter(a => a.status === status);
                }
                UIManager.updateAgentsUI();
            });
            
            document.getElementById('customerSearch')?.addEventListener('input', Utils.debounce(() => {
                UIManager.handleGlobalSearch();
            }, 300));
            
            document.getElementById('customerStatusFilter')?.addEventListener('change', (e) => {
                const status = e.target.value;
                if (status === 'all') {
                    AppState.filteredData.customers = AppState.customers;
                } else {
                    AppState.filteredData.customers = AppState.customers.filter(c => c.status === status);
                }
                UIManager.updateCustomersUI();
            });
            
            document.getElementById('commissionStatusFilter')?.addEventListener('change', (e) => {
                const status = e.target.value;
                if (status === 'all') {
                    AppState.filteredData.commissions = AppState.commissions;
                } else {
                    AppState.filteredData.commissions = AppState.commissions.filter(c => c.status === status);
                }
                UIManager.updateCommissionsUI();
            });
        });

        // ===== Export Global Functions =====
        window.UIManager = UIManager;
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.CommissionManager = CommissionManager;
        window.RepaymentManager = RepaymentManager;
        window.ApplicationManager = ApplicationManager;
        window.DocumentManager = DocumentManager;
        window.BulkActionManager = BulkActionManager;
        window.Utils = Utils;
        window.FirebaseService = FirebaseService;
        window.AdminManager = UIManager; // Alias for convenience
    </script>
</body>
</html>
