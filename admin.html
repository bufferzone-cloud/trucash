<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@cloudinary/url-gen@1.0.0"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* macOS Color Palette */
            --macos-white: #ffffff;
            --macos-gray-1: #f5f5f7;
            --macos-gray-2: #e8e8ed;
            --macos-gray-3: #d2d2d7;
            --macos-gray-4: #86868b;
            --macos-gray-5: #515154;
            --macos-gray-6: #1d1d1f;
            
            --macos-blue: #007aff;
            --macos-green: #34c759;
            --macos-red: #ff3b30;
            --macos-orange: #ff9500;
            --macos-purple: #af52de;
            --macos-yellow: #ffcc00;
            
            --macos-blue-light: rgba(0, 122, 255, 0.1);
            --macos-green-light: rgba(52, 199, 89, 0.1);
            --macos-red-light: rgba(255, 59, 48, 0.1);
            
            --macos-radius: 10px;
            --macos-radius-sm: 8px;
            --macos-radius-lg: 12px;
            
            --macos-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --macos-shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);
            --macos-shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.04);
            
            --sidebar-width: 260px;
            --header-height: 60px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--macos-white);
            color: var(--macos-gray-6);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--macos-white);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #loadingOverlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            font-size: 15px;
            color: var(--macos-gray-5);
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--macos-white);
            border-right: 1px solid var(--macos-gray-2);
            z-index: 100;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 1024px) {
            #sidebar {
                transform: translateX(-100%);
            }
            #sidebar.active {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 24px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--macos-gray-2);
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .app-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }

        .nav-section {
            flex: 1;
            overflow-y: auto;
        }

        .nav-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--macos-gray-4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 12px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--macos-radius-sm);
            color: var(--macos-gray-5);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--macos-gray-1);
            color: var(--macos-gray-6);
        }

        .nav-item.active {
            background: var(--macos-blue-light);
            color: var(--macos-blue);
        }

        .nav-item i {
            width: 20px;
            font-size: 16px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .sidebar-footer {
            padding-top: 20px;
            border-top: 1px solid var(--macos-gray-2);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--macos-radius-sm);
            background: var(--macos-gray-1);
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .admin-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .admin-info p {
            font-size: 12px;
            color: var(--macos-gray-4);
        }

        /* Main Content */
        #mainContent {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: var(--macos-white);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 1024px) {
            #mainContent {
                margin-left: 0;
            }
        }

        /* Header */
        .header {
            height: var(--header-height);
            background: var(--macos-white);
            border-bottom: 1px solid var(--macos-gray-2);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--macos-gray-5);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
        }

        @media (max-width: 1024px) {
            .menu-toggle {
                display: block;
            }
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            position: relative;
            width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius);
            font-size: 14px;
            color: var(--macos-gray-6);
            background: var(--macos-gray-1);
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: var(--macos-white);
            width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-gray-4);
        }

        .header-badge {
            position: relative;
            padding: 8px 12px;
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius);
            font-size: 13px;
            font-weight: 500;
            color: var(--macos-gray-6);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-badge i {
            color: var(--macos-green);
        }

        /* Content Area */
        .content-area {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            padding: 24px;
            border: 1px solid var(--macos-gray-2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .stat-card h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--macos-gray-6);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-card .change {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-card .change.positive {
            color: var(--macos-green);
        }

        .stat-card .change.negative {
            color: var(--macos-red);
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }

        .section-actions {
            display: flex;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--macos-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }

        .btn i {
            font-size: 16px;
        }

        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0066cc;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }

        .btn-outline:hover {
            background: var(--macos-blue-light);
        }

        .btn-success {
            background: var(--macos-green);
            color: white;
        }

        .btn-success:hover {
            background: #2db24a;
        }

        .btn-danger {
            background: var(--macos-red);
            color: white;
        }

        .btn-danger:hover {
            background: #e0352a;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            border: 1px solid var(--macos-gray-2);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-6);
        }

        .card-body {
            padding: 20px;
        }

        /* Data Tables */
        .data-table-container {
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            border: 1px solid var(--macos-gray-2);
            overflow: hidden;
        }

        .data-table-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .table-search {
            position: relative;
            width: 200px;
        }

        .table-search input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            background: var(--macos-gray-1);
        }

        .table-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-gray-4);
        }

        .table-filter {
            padding: 8px 12px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            background: var(--macos-white);
            color: var(--macos-gray-6);
            cursor: pointer;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--macos-gray-1);
        }

        .data-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-5);
            border-bottom: 1px solid var(--macos-gray-2);
            white-space: nowrap;
        }

        .data-table td {
            padding: 16px;
            font-size: 14px;
            color: var(--macos-gray-6);
            border-bottom: 1px solid var(--macos-gray-2);
        }

        .data-table tbody tr:hover {
            background: var(--macos-gray-1);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }

        .status-approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }

        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }

        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }

        .status-suspended {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }

        .status-banned {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }

        .status-pending-approval {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }

        .status-paid {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--macos-gray-6);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            color: var(--macos-gray-6);
            background: var(--macos-white);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--macos-blue);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--macos-white);
            border-radius: var(--macos-radius-lg);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-lg);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--macos-gray-4);
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--macos-white);
            border-radius: var(--macos-radius);
            border-left: 4px solid var(--macos-blue);
            box-shadow: var(--macos-shadow);
            padding: 16px;
            max-width: 400px;
            display: none;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .toast.active {
            display: block;
        }

        .toast-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--macos-gray-6);
        }

        .toast-message {
            font-size: 13px;
            color: var(--macos-gray-5);
            line-height: 1.5;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Overlay */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .mobile-menu-overlay.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }
            
            .content-area {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            .table-controls {
                flex-wrap: wrap;
            }
            
            .search-box input:focus {
                width: 200px;
            }
        }

        /* Image Viewer */
        .image-viewer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .image-container {
            border-radius: var(--macos-radius-sm);
            overflow: hidden;
            border: 1px solid var(--macos-gray-2);
        }

        .image-container img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-label {
            padding: 8px;
            background: var(--macos-gray-1);
            text-align: center;
            font-size: 12px;
            color: var(--macos-gray-5);
        }

        /* Details View */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .detail-card {
            padding: 20px;
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius-sm);
        }

        .detail-label {
            font-size: 12px;
            color: var(--macos-gray-4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-6);
        }

        /* Commission Cards */
        .commission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .commission-card {
            padding: 20px;
            border-radius: var(--macos-radius);
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            text-align: center;
        }

        .commission-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--macos-green);
            margin-bottom: 4px;
        }

        .commission-label {
            font-size: 13px;
            color: var(--macos-gray-4);
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 24px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--macos-gray-2);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--macos-blue);
        }

        .timeline-date {
            font-size: 12px;
            color: var(--macos-gray-4);
            margin-bottom: 4px;
        }

        .timeline-content {
            font-size: 14px;
            color: var(--macos-gray-6);
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--macos-gray-2);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--macos-green);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--macos-gray-3);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--macos-green);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--macos-gray-3);
            border-radius: var(--macos-radius-sm);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-area:hover {
            border-color: var(--macos-blue);
            background: var(--macos-blue-light);
        }

        .upload-area i {
            font-size: 32px;
            color: var(--macos-gray-4);
            margin-bottom: 12px;
        }

        .upload-area span {
            display: block;
            color: var(--macos-gray-5);
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--macos-gray-4);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--macos-gray-5);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background: var(--macos-blue-light);
            color: var(--macos-blue);
        }

        .badge-success {
            background: var(--macos-green-light);
            color: var(--macos-green);
        }

        .badge-warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }

        .badge-danger {
            background: var(--macos-red-light);
            color: var(--macos-red);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--macos-gray-2);
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--macos-gray-5);
            cursor: pointer;
            position: relative;
        }

        .tab:hover {
            color: var(--macos-gray-6);
        }

        .tab.active {
            color: var(--macos-blue);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--macos-blue);
        }

        /* Action Dropdown */
        .action-dropdown {
            position: relative;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--macos-gray-5);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .action-btn:hover {
            background: var(--macos-gray-1);
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            box-shadow: var(--macos-shadow);
            min-width: 160px;
            z-index: 10;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            font-size: 14px;
            color: var(--macos-gray-6);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--macos-gray-1);
        }

        .dropdown-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--macos-gray-2);
            margin: 4px 0;
        }

        /* Avatar */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-small {
            width: 32px;
            height: 32px;
        }

        .avatar-large {
            width: 60px;
            height: 60px;
        }

        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: var(--macos-radius-sm);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: var(--macos-green-light);
            color: var(--macos-green);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .alert-warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .alert-danger {
            background: var(--macos-red-light);
            color: var(--macos-red);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Spacing Utilities */
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mt-5 { margin-top: 20px; }

        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }

        .text-center { text-align: center; }
        .text-muted { color: var(--macos-gray-4); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-orange); }
        .text-primary { color: var(--macos-blue); }

        /* Utility Classes */
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .flex-grow-1 { flex-grow: 1; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }

        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        .pointer { cursor: pointer; }
        .no-select { user-select: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--macos-gray-1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-4);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Admin Panel...</div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="logo">TC</div>
            <div class="app-name">TruCash Admin</div>
        </div>

        <div class="nav-section">
            <div class="nav-title">Main</div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-section="loans">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Loan Approvals</span>
                <span class="badge" id="pendingLoansBadge">0</span>
            </div>
            <div class="nav-item" data-section="agents">
                <i class="fas fa-user-tie"></i>
                <span>Agent Management</span>
                <span class="badge" id="pendingAgentsBadge">0</span>
            </div>
            <div class="nav-item" data-section="customers">
                <i class="fas fa-users"></i>
                <span>Customer Management</span>
            </div>

            <div class="nav-title">Operations</div>
            <div class="nav-item" data-section="assignments">
                <i class="fas fa-handshake"></i>
                <span>Agent Assignments</span>
            </div>
            <div class="nav-item" data-section="commissions">
                <i class="fas fa-money-check-alt"></i>
                <span>Commission Management</span>
                <span class="badge" id="pendingCommissionsBadge">0</span>
            </div>
            <div class="nav-item" data-section="transactions">
                <i class="fas fa-exchange-alt"></i>
                <span>All Transactions</span>
            </div>
            <div class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Reports & Analytics</span>
            </div>

            <div class="nav-title">System</div>
            <div class="nav-item" data-section="audit">
                <i class="fas fa-history"></i>
                <span>Audit Log</span>
            </div>
            <div class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="admin-profile">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div class="admin-info">
                    <h4 id="adminName">Loading...</h4>
                    <p id="adminRole">Administrator</p>
                </div>
                <button class="btn-icon btn-outline" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Main Content -->
    <div id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="pageTitle">Admin Dashboard</h1>
            </div>
            <div class="header-actions">
                <div class="header-badge">
                    <i class="fas fa-circle"></i>
                    <span id="connectionStatus">Online</span>
                </div>
                <div class="header-badge" id="systemTime">
                    <i class="far fa-clock"></i>
                    <span id="currentTime">00:00</span>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content-area">
            
            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboardSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Loans</h3>
                        <div class="value" id="totalLoans">0</div>
                        <div class="change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>12% this month</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Approvals</h3>
                        <div class="value" id="pendingApprovals">0</div>
                        <div class="change warning">
                            <i class="fas fa-clock"></i>
                            <span>Requires attention</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Agents</h3>
                        <div class="value" id="activeAgents">0</div>
                        <div class="change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>5% increase</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Commission</h3>
                        <div class="value" id="totalCommission">K0</div>
                        <div class="change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>18% this month</span>
                        </div>
                    </div>
                </div>

                <div class="section-header">
                    <h2 class="section-title">Recent Activity</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline btn-small" onclick="loadRecentActivity()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pending Loan Approvals</div>
                        </div>
                        <div class="card-body">
                            <div id="pendingLoansList">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <h3>No Pending Loans</h3>
                                    <p>All loans are processed</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Applications</div>
                        </div>
                        <div class="card-body">
                            <div id="agentApplicationsList">
                                <div class="empty-state">
                                    <i class="fas fa-user-plus"></i>
                                    <h3>No Applications</h3>
                                    <p>No new agent applications</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Recent Transactions</div>
                        </div>
                        <div class="card-body">
                            <div id="recentTransactions">
                                <div class="empty-state">
                                    <i class="fas fa-exchange-alt"></i>
                                    <h3>No Transactions</h3>
                                    <p>No recent transactions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loan Approvals Section -->
            <section class="content-section" id="loansSection">
                <div class="section-header">
                    <h2 class="section-title">Loan Approval Management</h2>
                    <div class="section-actions">
                        <div class="table-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="loanSearch" placeholder="Search loans...">
                        </div>
                        <select class="table-filter" id="loanFilter">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="data-table-header">
                        <div class="table-controls">
                            <button class="btn btn-outline btn-small" onclick="exportLoans()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Purpose</th>
                                <th>Applied Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <!-- Loans will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Agent Management Section -->
            <section class="content-section" id="agentsSection">
                <div class="tabs" id="agentTabs">
                    <button class="tab active" data-tab="active-agents">Active Agents</button>
                    <button class="tab" data-tab="pending-agents">Pending Approval</button>
                    <button class="tab" data-tab="create-agent">Create New Agent</button>
                </div>

                <!-- Active Agents Tab -->
                <div class="tab-content active" id="activeAgentsTab">
                    <div class="section-header">
                        <h2 class="section-title">Active Agents</h2>
                        <div class="section-actions">
                            <div class="table-search">
                                <i class="fas fa-search"></i>
                                <input type="text" id="agentSearch" placeholder="Search agents...">
                            </div>
                            <select class="table-filter" id="agentFilter">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                                <option value="banned">Banned</option>
                            </select>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Agent ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Customers</th>
                                    <th>Loans</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activeAgentsTable">
                                <!-- Active agents will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pending Agents Tab -->
                <div class="tab-content" id="pendingAgentsTab">
                    <div class="section-header">
                        <h2 class="section-title">Pending Agent Applications</h2>
                    </div>

                    <div class="cards-grid" id="pendingAgentsGrid">
                        <!-- Pending agent cards will be populated here -->
                    </div>
                </div>

                <!-- Create Agent Tab -->
                <div class="tab-content" id="createAgentTab">
                    <div class="section-header">
                        <h2 class="section-title">Create New Agent Account</h2>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <form id="createAgentForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Full Name *</label>
                                        <input type="text" class="form-input" id="agentFullName" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-input" id="agentPhone" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Email Address *</label>
                                        <input type="email" class="form-input" id="agentEmail" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Agent ID *</label>
                                        <input type="text" class="form-input" id="agentCustomId" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Password *</label>
                                        <input type="password" class="form-input" id="agentPassword" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Confirm Password *</label>
                                        <input type="password" class="form-input" id="agentConfirmPassword" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Branch/Location</label>
                                        <input type="text" class="form-input" id="agentBranch">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Commission Rate (%)</label>
                                        <input type="number" class="form-input" id="agentCommissionRate" value="2.5" step="0.1" min="0" max="50">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Profile Photo</label>
                                    <div class="upload-area" onclick="openAgentPhotoUpload()">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Click to upload profile photo</span>
                                    </div>
                                    <input type="hidden" id="agentProfilePhoto">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Additional Notes</label>
                                    <textarea class="form-input form-textarea" id="agentNotes" placeholder="Any additional information about this agent..."></textarea>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-user-plus"></i>
                                        Create Agent Account
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section class="content-section" id="customersSection">
                <div class="section-header">
                    <h2 class="section-title">Customer Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showCreateCustomerModal()">
                            <i class="fas fa-user-plus"></i>
                            Create Customer
                        </button>
                        <div class="table-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="customerSearch" placeholder="Search customers...">
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="data-table-header">
                        <div class="table-controls">
                            <select class="table-filter" id="customerFilter">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                                <option value="banned">Banned</option>
                                <option value="with_loans">With Loans</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Agent</th>
                                <th>Active Loans</th>
                                <th>Total Borrowed</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Agent Assignments Section -->
            <section class="content-section" id="assignmentsSection">
                <div class="section-header">
                    <h2 class="section-title">Agent-Customer Assignments</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showBulkAssignmentModal()">
                            <i class="fas fa-users"></i>
                            Bulk Assign
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Select Agent</label>
                                <select class="form-input" id="assignmentAgent" onchange="loadAgentCustomers()">
                                    <option value="">Select an agent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Select Customer</label>
                                <select class="form-input" id="assignmentCustomer">
                                    <option value="">Select a customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-success w-100" onclick="assignAgentToCustomer()">
                                    <i class="fas fa-link"></i>
                                    Assign Agent
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="section-title mb-3">Current Assignments</h3>
                    <div id="assignmentsGrid" class="cards-grid">
                        <!-- Assignment cards will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Commission Management Section -->
            <section class="content-section" id="commissionsSection">
                <div class="commission-grid">
                    <div class="commission-card">
                        <div class="commission-value" id="totalPendingCommission">K0</div>
                        <div class="commission-label">Pending Commission</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value" id="totalApprovedCommission">K0</div>
                        <div class="commission-label">Approved Commission</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value" id="totalPaidCommission">K0</div>
                        <div class="commission-label">Paid Commission</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value" id="thisMonthCommission">K0</div>
                        <div class="commission-label">This Month</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2 class="section-title">Commission Approval</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="processCommissionPayout()">
                            <i class="fas fa-money-check-alt"></i>
                            Process Payouts
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Customer</th>
                                <th>Loan ID</th>
                                <th>Loan Amount</th>
                                <th>Commission Rate</th>
                                <th>Commission Amount</th>
                                <th>Status</th>
                                <th>Earned Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commissionsTableBody">
                            <!-- Commissions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Transactions Section -->
            <section class="content-section" id="transactionsSection">
                <div class="section-header">
                    <h2 class="section-title">All Transactions</h2>
                    <div class="section-actions">
                        <div class="table-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="transactionSearch" placeholder="Search transactions...">
                        </div>
                        <select class="table-filter" id="transactionFilter">
                            <option value="all">All Types</option>
                            <option value="loan">Loan Disbursement</option>
                            <option value="repayment">Repayment</option>
                            <option value="commission">Commission</option>
                            <option value="fee">Fee</option>
                        </select>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="data-table-header">
                        <div class="table-controls">
                            <button class="btn btn-outline btn-small" onclick="exportTransactions()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                            <button class="btn btn-outline btn-small" onclick="filterByDate()">
                                <i class="far fa-calendar"></i>
                                Date Range
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Loan ID</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Reference</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Section -->
            <section class="content-section" id="reportsSection">
                <div class="section-header">
                    <h2 class="section-title">Reports & Analytics</h2>
                    <div class="section-actions">
                        <select class="table-filter" id="reportPeriod">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-file-export"></i>
                            Generate Report
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Loan Performance</div>
                        </div>
                        <div class="card-body">
                            <canvas id="loanPerformanceChart" height="200"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Agent Performance</div>
                        </div>
                        <div class="card-body">
                            <canvas id="agentPerformanceChart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Detailed Statistics</div>
                    </div>
                    <div class="card-body">
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Total Loan Portfolio</div>
                                <div class="detail-value" id="totalPortfolio">K0</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Active Loans</div>
                                <div class="detail-value" id="activeLoansCount">0</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Default Rate</div>
                                <div class="detail-value" id="defaultRate">0%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Avg Loan Size</div>
                                <div class="detail-value" id="avgLoanSize">K0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Audit Log Section -->
            <section class="content-section" id="auditSection">
                <div class="section-header">
                    <h2 class="section-title">System Audit Log</h2>
                    <div class="section-actions">
                        <div class="table-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="auditSearch" placeholder="Search audit log...">
                        </div>
                        <select class="table-filter" id="auditFilter">
                            <option value="all">All Actions</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="approve">Approve</option>
                            <option value="reject">Reject</option>
                        </select>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>User Agent</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody">
                            <!-- Audit logs will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="content-section" id="settingsSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">System Settings</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Maximum Loan Amount (ZMW)</label>
                            <input type="number" class="form-input" id="maxLoanAmount" value="50000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Minimum Loan Amount (ZMW)</label>
                            <input type="number" class="form-input" id="minLoanAmount" value="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Interest Rate (%)</label>
                            <input type="number" class="form-input" id="defaultInterestRate" value="15" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Commission Rate (%)</label>
                            <input type="number" class="form-input" id="defaultCommissionRate" value="2.5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loan Terms (Months)</label>
                            <input type="text" class="form-input" id="loanTerms" value="3,6,12,18,24" placeholder="Comma separated months">
                        </div>

                        <div class="mt-4">
                            <h4 class="section-title mb-3">Email Notifications</h4>
                            <div class="form-group">
                                <label class="form-label d-flex align-items-center">
                                    <span class="flex-grow-1">Send email for loan approvals</span>
                                    <label class="switch">
                                        <input type="checkbox" id="emailLoanApprovals" checked>
                                        <span class="slider"></span>
                                    </label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label d-flex align-items-center">
                                    <span class="flex-grow-1">Send email for agent assignments</span>
                                    <label class="switch">
                                        <input type="checkbox" id="emailAgentAssignments" checked>
                                        <span class="slider"></span>
                                    </label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label d-flex align-items-center">
                                    <span class="flex-grow-1">Send email for commission payouts</span>
                                    <label class="switch">
                                        <input type="checkbox" id="emailCommissionPayouts" checked>
                                        <span class="slider"></span>
                                    </label>
                                </label>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->

    <!-- Loan Details Modal -->
    <div class="modal" id="loanDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Loan Details</h3>
                <button class="modal-close" onclick="closeModal('loanDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="loanDetailContent">
                <!-- Loan details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div class="modal" id="agentDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agent Details</h3>
                <button class="modal-close" onclick="closeModal('agentDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="agentDetailContent">
                <!-- Agent details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal" id="customerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('customerDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="customerDetailContent">
                <!-- Customer details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Commission Details Modal -->
    <div class="modal" id="commissionDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Commission Details</h3>
                <button class="modal-close" onclick="closeModal('commissionDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="commissionDetailContent">
                <!-- Commission details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create Customer Modal -->
    <div class="modal" id="createCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Customer</h3>
                <button class="modal-close" onclick="closeModal('createCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createCustomerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-input" id="customerFullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-input" id="customerEmail" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-input" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">NRC Number *</label>
                            <input type="text" class="form-input" id="customerNRC" placeholder="123456/78/9" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Residence Address *</label>
                            <input type="text" class="form-input" id="customerAddress" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">House Number</label>
                            <input type="text" class="form-input" id="customerHouseNumber">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <input type="text" class="form-input" id="customerOccupation">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monthly Income (ZMW)</label>
                            <input type="number" class="form-input" id="customerMonthlyIncome" min="0" step="100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-input" id="customerPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" class="form-input" id="customerConfirmPassword" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Assign to Agent</label>
                        <select class="form-input" id="customerAssignedAgent">
                            <option value="">No agent assigned</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-input form-textarea" id="customerNotes" placeholder="Any additional information about this customer..."></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal('createCustomerModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i>
                            Create Customer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Assignment Modal -->
    <div class="modal" id="bulkAssignmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Agent Assignment</h3>
                <button class="modal-close" onclick="closeModal('bulkAssignmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Agent</label>
                    <select class="form-input" id="bulkAssignmentAgent">
                        <option value="">Select an agent</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Select Customers</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--macos-gray-2); border-radius: var(--macos-radius-sm); padding: 12px;">
                        <div id="bulkCustomersList">
                            <!-- Customers checkboxes will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('bulkAssignmentModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkAssignment()">
                        <i class="fas fa-users"></i>
                        Assign Selected Customers
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="notificationToast">
        <div class="toast-header">
            <i class="fas fa-info-circle"></i>
            <span class="toast-title" id="toastTitle">Notification</span>
        </div>
        <div class="toast-message" id="toastMessage">This is a notification message.</div>
    </div>

    <!-- Firebase and Cloudinary Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ===== Firebase Configuration =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== Cloudinary Configuration =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'],
            multiple: false
        };

        // ===== Application State =====
        const AppState = {
            currentUser: null,
            adminData: null,
            users: [],
            agents: [],
            customers: [],
            loans: [],
            transactions: [],
            commissions: [],
            repayments: [],
            auditLogs: [],
            pendingActions: {
                loans: 0,
                agents: 0,
                commissions: 0
            },
            systemSettings: {
                maxLoanAmount: 50000,
                minLoanAmount: 100,
                interestRate: 15,
                commissionRate: 2.5,
                loanTerms: [3, 6, 12, 18, 24]
            },
            cloudinaryWidget: null,
            realtimeListeners: [],
            currentSection: 'dashboard',
            charts: {}
        };

        // ===== Initialize Firebase =====
        let firebaseApp, auth, db;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }

        // ===== Utility Functions =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const toast = document.getElementById('notificationToast');
                const toastTitle = document.getElementById('toastTitle');
                const toastMessage = document.getElementById('toastMessage');
                const toastIcon = toast.querySelector('.toast-header i');
                
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                
                let iconClass = 'fa-info-circle';
                let borderColor = 'var(--macos-blue)';
                
                switch(type) {
                    case 'success':
                        iconClass = 'fa-check-circle';
                        borderColor = 'var(--macos-green)';
                        break;
                    case 'error':
                        iconClass = 'fa-exclamation-circle';
                        borderColor = 'var(--macos-red)';
                        break;
                    case 'warning':
                        iconClass = 'fa-exclamation-triangle';
                        borderColor = 'var(--macos-orange)';
                        break;
                }
                
                toastIcon.className = 'fas ' + iconClass;
                toast.style.borderLeftColor = borderColor;
                toast.classList.add('active');
                
                setTimeout(() => {
                    toast.classList.remove('active');
                }, duration);
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            calculateCommission(loanAmount, commissionRate = 2.5) {
                return (loanAmount * commissionRate) / 100;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            truncateText(text, maxLength = 50) {
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            }
        };

        // ===== Firebase Service =====
        const FirebaseService = {
            async checkAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        unsubscribe();
                        
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            const userRef = db.ref('users/' + currentUser.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            if (userData.userType !== 'admin' && userData.userType !== 'sudo') {
                                Utils.showToast('Access Denied', 'This panel is for administrators only', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = currentUser;
                            AppState.adminData = userData;
                            
                            // Update admin info in UI
                            document.getElementById('adminName').textContent = userData.fullName || 'Administrator';
                            document.getElementById('adminAvatar').textContent = userData.fullName ? userData.fullName.charAt(0).toUpperCase() : 'A';
                            
                            if (userData.profilePhoto) {
                                document.getElementById('adminAvatar').style.backgroundImage = `url(${userData.profilePhoto})`;
                                document.getElementById('adminAvatar').style.backgroundSize = 'cover';
                            }
                            
                            resolve(userData);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            window.location.href = 'login.html';
                            resolve(null);
                        }
                    });
                });
            },
            
            async loadAllData() {
                try {
                    // Load users
                    const usersSnapshot = await db.ref('users').once('value');
                    AppState.users = [];
                    AppState.agents = [];
                    AppState.customers = [];
                    
                    usersSnapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        
                        if (user.userType === 'agent') {
                            AppState.agents.push(user);
                        } else if (user.userType === 'customer') {
                            AppState.customers.push(user);
                        }
                        AppState.users.push(user);
                    });
                    
                    // Load loans
                    const loansSnapshot = await db.ref('loans').once('value');
                    AppState.loans = [];
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        AppState.loans.push(loan);
                    });
                    
                    // Load transactions
                    const transactionsSnapshot = await db.ref('transactions').once('value');
                    AppState.transactions = [];
                    transactionsSnapshot.forEach((childSnapshot) => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        AppState.transactions.push(transaction);
                    });
                    
                    // Load commissions
                    const commissionsSnapshot = await db.ref('commissions').once('value');
                    AppState.commissions = [];
                    commissionsSnapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        AppState.commissions.push(commission);
                    });
                    
                    // Load system settings
                    const settingsSnapshot = await db.ref('systemSettings').once('value');
                    if (settingsSnapshot.exists()) {
                        AppState.systemSettings = settingsSnapshot.val();
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return false;
                }
            },
            
            async approveLoan(loanId, action, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    const updates = {
                        status: action === 'approve' ? 'approved' : 'rejected',
                        updatedAt: Date.now(),
                        reviewedBy: AppState.currentUser.uid,
                        reviewedByName: AppState.adminData.fullName,
                        reviewNotes: notes
                    };
                    
                    if (action === 'approve') {
                        updates.approvedDate = Date.now();
                        updates.disbursementDate = Date.now();
                    }
                    
                    await loanRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('loan_' + action, {
                        loanId: loanId,
                        action: action,
                        notes: notes,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    // Create notification for agent
                    const loanSnapshot = await loanRef.once('value');
                    const loan = loanSnapshot.val();
                    
                    if (loan.agentId) {
                        await this.createNotification(loan.agentId, 'loan_' + action, {
                            loanId: loanId,
                            customerName: loan.customerName,
                            amount: loan.amount,
                            action: action,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: `Loan ${action}d successfully` };
                } catch (error) {
                    console.error('Error approving loan:', error);
                    return { success: false, error: `Failed to ${action} loan` };
                }
            },
            
            async createAgent(agentData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        agentId: agentData.agentId,
                        branch: agentData.branch || '',
                        commissionRate: agentData.commissionRate || 2.5,
                        profilePhoto: agentData.profilePhoto || '',
                        userType: 'agent',
                        status: 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName,
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Also save to agents collection
                    await db.ref('agents/' + agentId).set({
                        agentId: agentData.agentId,
                        email: agentData.email,
                        fullName: agentData.fullName,
                        status: 'active',
                        createdAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_create', {
                        agentId: agentId,
                        agentCustomId: agentData.agentId,
                        agentName: agentData.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        details: 'Agent created manually by admin'
                    });
                    
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    
                    let errorMessage = 'Failed to create agent';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateUserStatus(userId, status, reason = '') {
                try {
                    const userRef = db.ref('users/' + userId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        statusReason: reason,
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName
                    };
                    
                    await userRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('user_status_update', {
                        userId: userId,
                        status: status,
                        reason: reason,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: `User status updated to ${status}` };
                } catch (error) {
                    console.error('Error updating user status:', error);
                    return { success: false, error: 'Failed to update user status' };
                }
            },
            
            async deleteUser(userId, userType) {
                try {
                    // First, check if user has active loans
                    if (userType === 'customer') {
                        const loansRef = db.ref('loans').orderByChild('customerId').equalTo(userId);
                        const loansSnapshot = await loansRef.once('value');
                        
                        if (loansSnapshot.exists()) {
                            let hasActiveLoans = false;
                            loansSnapshot.forEach((childSnapshot) => {
                                const loan = childSnapshot.val();
                                if (loan.status === 'active' || loan.status === 'pending') {
                                    hasActiveLoans = true;
                                }
                            });
                            
                            if (hasActiveLoans) {
                                return { success: false, error: 'Cannot delete customer with active or pending loans' };
                            }
                        }
                    }
                    
                    // Delete from Firebase Auth
                    const user = await auth.getUser(userId);
                    await auth.deleteUser(userId);
                    
                    // Delete from Realtime Database
                    await db.ref('users/' + userId).remove();
                    
                    if (userType === 'agent') {
                        await db.ref('agents/' + userId).remove();
                    }
                    
                    // Create audit log
                    await this.createAuditLog('user_delete', {
                        userId: userId,
                        userType: userType,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        details: 'User deleted by admin'
                    });
                    
                    return { success: true, message: 'User deleted successfully' };
                } catch (error) {
                    console.error('Error deleting user:', error);
                    return { success: false, error: 'Failed to delete user' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const agentRef = db.ref('users/' + agentId);
                    
                    // Get agent details
                    const agentSnapshot = await agentRef.once('value');
                    const agent = agentSnapshot.val();
                    
                    // Update customer
                    await customerRef.update({
                        assignedAgentId: agentId,
                        agentName: agent.fullName,
                        agentCustomId: agent.agentId,
                        updatedAt: Date.now(),
                        assignedBy: AppState.currentUser.uid,
                        assignedByName: AppState.adminData.fullName
                    });
                    
                    // Update agent's customer count
                    await agentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_assignment', {
                        customerId: customerId,
                        agentId: agentId,
                        agentName: agent.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        details: 'Agent assigned to customer'
                    });
                    
                    // Create notifications
                    await this.createNotification(customerId, 'agent_assigned', {
                        agentId: agentId,
                        agentName: agent.fullName,
                        timestamp: Date.now()
                    });
                    
                    await this.createNotification(agentId, 'customer_assigned', {
                        customerId: customerId,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async processCommissionPayout(commissionIds) {
                try {
                    const batchUpdates = {};
                    const now = Date.now();
                    
                    commissionIds.forEach(commissionId => {
                        batchUpdates[`commissions/${commissionId}/status`] = 'paid';
                        batchUpdates[`commissions/${commissionId}/paidAt`] = now;
                        batchUpdates[`commissions/${commissionId}/paidBy`] = AppState.currentUser.uid;
                        batchUpdates[`commissions/${commissionId}/paidByName`] = AppState.adminData.fullName;
                    });
                    
                    await db.ref().update(batchUpdates);
                    
                    // Create audit log
                    await this.createAuditLog('commission_payout', {
                        commissionIds: commissionIds,
                        count: commissionIds.length,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        details: 'Commission payout processed'
                    });
                    
                    return { success: true, message: 'Commission payouts processed successfully' };
                } catch (error) {
                    console.error('Error processing commission payout:', error);
                    return { success: false, error: 'Failed to process commission payouts' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName,
                        userRole: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 1000) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 1000);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createNotification(userId, type, data) {
                try {
                    const notificationId = Utils.generateId('NOT');
                    const notificationRef = db.ref('notifications/' + userId + '/' + notificationId);
                    
                    const notification = {
                        id: notificationId,
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        read: false,
                        priority: 'medium'
                    };
                    
                    await notificationRef.set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return null;
                }
            },
            
            async createCustomer(customerData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        customerData.password
                    );
                    
                    const customerId = userCredential.user.uid;
                    
                    // Prepare customer document
                    const customerDoc = {
                        uid: customerId,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        nrc: customerData.nrc,
                        residence: customerData.address,
                        houseNumber: customerData.houseNumber,
                        occupation: customerData.occupation || '',
                        monthlyIncome: customerData.monthlyIncome || 0,
                        userType: 'customer',
                        assignedAgentId: customerData.assignedAgentId || '',
                        status: 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName,
                        accountBalance: 0,
                        totalLoans: 0,
                        activeLoans: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + customerId).set(customerDoc);
                    
                    // Create audit log
                    await this.createAuditLog('customer_create', {
                        customerId: customerId,
                        customerName: customerData.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        details: 'Customer created manually by admin'
                    });
                    
                    return {
                        success: true,
                        customerId: customerId,
                        message: 'Customer created successfully'
                    };
                } catch (error) {
                    console.error('Error creating customer:', error);
                    
                    let errorMessage = 'Failed to create customer';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async saveSystemSettings(settings) {
                try {
                    await db.ref('systemSettings').set(settings);
                    AppState.systemSettings = settings;
                    
                    await this.createAuditLog('settings_update', {
                        settings: settings,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        details: 'System settings updated'
                    });
                    
                    return { success: true, message: 'Settings saved successfully' };
                } catch (error) {
                    console.error('Error saving settings:', error);
                    return { success: false, error: 'Failed to save settings' };
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.users = [];
                    AppState.agents = [];
                    AppState.customers = [];
                    AppState.loans = [];
                    AppState.transactions = [];
                    AppState.commissions = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    Utils.showToast('Logout Error', 'Failed to sign out properly', 'error');
                }
            }
        };

        // ===== UI Manager =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupTimeUpdate();
                this.setupResponsive();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.menuToggle = document.getElementById('menuToggle');
                this.mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
                
                // Tabs
                this.tabs = document.querySelectorAll('.tab');
                this.tabContents = document.querySelectorAll('.tab-content');
                
                // Search and filter inputs
                this.searchInputs = document.querySelectorAll('input[type="search"], .table-search input');
                this.filterSelects = document.querySelectorAll('.table-filter');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Close mobile menu
                        if (window.innerWidth <= 1024) {
                            document.getElementById('sidebar').classList.remove('active');
                            this.mobileMenuOverlay.classList.remove('active');
                        }
                    });
                });
                
                // Tabs
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.showTab(tabId);
                    });
                });
                
                // Menu toggle
                this.menuToggle.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.toggle('active');
                    this.mobileMenuOverlay.classList.toggle('active');
                });
                
                // Mobile menu overlay
                this.mobileMenuOverlay.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('active');
                    this.mobileMenuOverlay.classList.remove('active');
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Search inputs
                this.searchInputs.forEach(input => {
                    input.addEventListener('input', Utils.debounce(() => {
                        this.filterTable(input);
                    }, 300));
                });
                
                // Filter selects
                this.filterSelects.forEach(select => {
                    select.addEventListener('change', () => {
                        this.filterTable(select);
                    });
                });
                
                // Create agent form
                const createAgentForm = document.getElementById('createAgentForm');
                if (createAgentForm) {
                    createAgentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCreateAgent();
                    });
                }
                
                // Create customer form
                const createCustomerForm = document.getElementById('createCustomerForm');
                if (createCustomerForm) {
                    createCustomerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCreateCustomer();
                    });
                }
            },
            
            setupResponsive() {
                const handleResize = () => {
                    if (window.innerWidth > 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                        this.mobileMenuOverlay.classList.remove('active');
                    }
                };
                
                window.addEventListener('resize', handleResize);
            },
            
            setupTimeUpdate() {
                const updateTime = () => {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    }).replace('24', '00');
                    
                    document.getElementById('currentTime').textContent = timeString;
                };
                
                updateTime();
                setInterval(updateTime, 60000); // Update every minute
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Load initial data
                    await FirebaseService.loadAllData();
                    
                    // Setup real-time listeners
                    this.setupRealtimeListeners();
                    
                    // Update UI
                    this.updateDashboardUI();
                    this.updateLoansUI();
                    this.updateAgentsUI();
                    this.updateCustomersUI();
                    this.updateCommissionsUI();
                    
                    Utils.hideLoading();
                    
                    // Show welcome message
                    Utils.showToast('Welcome Admin', 
                        `Hello ${adminData.fullName || 'Administrator'}!`, 
                        'success');
                    
                } catch (error) {
                    console.error('Authentication initialization error:', error);
                    Utils.hideLoading();
                    Utils.showToast('Authentication Error', 'Failed to authenticate. Please try again.', 'error');
                }
            },
            
            setupRealtimeListeners() {
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    AppState.loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        AppState.loans.push(loan);
                    });
                    
                    this.updateDashboardUI();
                    this.updateLoansUI();
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Agents listener
                const agentsRef = db.ref('agents');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    AppState.agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.uid = childSnapshot.key;
                        AppState.agents.push(agent);
                    });
                    
                    this.updateDashboardUI();
                    this.updateAgentsUI();
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Users listener (for customers)
                const usersRef = db.ref('users');
                const usersListener = usersRef.on('value', (snapshot) => {
                    AppState.users = [];
                    AppState.customers = [];
                    AppState.agents = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        AppState.users.push(user);
                        
                        if (user.userType === 'customer') {
                            AppState.customers.push(user);
                        } else if (user.userType === 'agent') {
                            AppState.agents.push(user);
                        }
                    });
                    
                    this.updateDashboardUI();
                    this.updateCustomersUI();
                });
                
                AppState.realtimeListeners.push(() => usersRef.off('value', usersListener));
                
                // Commissions listener
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    AppState.commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        AppState.commissions.push(commission);
                    });
                    
                    this.updateDashboardUI();
                    this.updateCommissionsUI();
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Transactions listener
                const transactionsRef = db.ref('transactions');
                const transactionsListener = transactionsRef.on('value', (snapshot) => {
                    AppState.transactions = [];
                    snapshot.forEach((childSnapshot) => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        AppState.transactions.push(transaction);
                    });
                    
                    this.updateTransactionsUI();
                });
                
                AppState.realtimeListeners.push(() => transactionsRef.off('value', transactionsListener));
                
                // Audit logs listener
                const auditRef = db.ref('auditLogs');
                const auditListener = auditRef.on('value', (snapshot) => {
                    AppState.auditLogs = [];
                    snapshot.forEach((childSnapshot) => {
                        const auditLog = childSnapshot.val();
                        auditLog.id = childSnapshot.key;
                        AppState.auditLogs.push(auditLog);
                    });
                    
                    AppState.auditLogs.sort((a, b) => b.timestamp - a.timestamp);
                    this.updateAuditUI();
                });
                
                AppState.realtimeListeners.push(() => auditRef.off('value', auditListener));
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    loans: 'Loan Approvals',
                    agents: 'Agent Management',
                    customers: 'Customer Management',
                    assignments: 'Agent Assignments',
                    commissions: 'Commission Management',
                    transactions: 'All Transactions',
                    reports: 'Reports & Analytics',
                    audit: 'Audit Log',
                    settings: 'Settings'
                };
                
                document.getElementById('pageTitle').textContent = titles[sectionId] || 'Admin Panel';
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.style.display = 'block';
                    
                    // Load section-specific data
                    switch(sectionId) {
                        case 'loans':
                            this.updateLoansUI();
                            break;
                        case 'agents':
                            this.updateAgentsUI();
                            break;
                        case 'customers':
                            this.updateCustomersUI();
                            break;
                        case 'assignments':
                            this.updateAssignmentsUI();
                            break;
                        case 'commissions':
                            this.updateCommissionsUI();
                            break;
                        case 'transactions':
                            this.updateTransactionsUI();
                            break;
                        case 'reports':
                            this.updateReportsUI();
                            break;
                        case 'audit':
                            this.updateAuditUI();
                            break;
                        case 'settings':
                            this.updateSettingsUI();
                            break;
                    }
                }
            },
            
            showTab(tabId) {
                // Update active tab
                this.tabs.forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.tab === tabId) {
                        tab.classList.add('active');
                    }
                });
                
                // Show active tab content
                this.tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId + 'Tab') {
                        content.classList.add('active');
                    }
                });
                
                // Load tab-specific data
                switch(tabId) {
                    case 'active-agents':
                        this.updateActiveAgentsTable();
                        break;
                    case 'pending-agents':
                        this.updatePendingAgentsGrid();
                        break;
                }
            },
            
            filterTable(element) {
                const tableId = element.closest('.data-table-container')?.querySelector('tbody')?.id;
                if (!tableId) return;
                
                const searchTerm = element.type === 'search' ? element.value.toLowerCase() : '';
                const filterValue = element.tagName === 'SELECT' ? element.value : '';
                
                const rows = document.querySelectorAll(`#${tableId} tr`);
                
                rows.forEach(row => {
                    const rowText = row.textContent.toLowerCase();
                    const statusCell = row.querySelector('.status-badge');
                    const status = statusCell ? statusCell.textContent.toLowerCase() : '';
                    
                    let matchesSearch = !searchTerm || rowText.includes(searchTerm);
                    let matchesFilter = !filterValue || filterValue === 'all' || status.includes(filterValue);
                    
                    row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
                });
            },
            
            updateDashboardUI() {
                // Calculate statistics
                const totalLoans = AppState.loans.length;
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const activeAgents = AppState.agents.filter(a => a.status === 'active').length;
                
                const totalCommission = AppState.commissions
                    .filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                // Update dashboard stats
                document.getElementById('totalLoans').textContent = totalLoans;
                document.getElementById('pendingApprovals').textContent = pendingLoans;
                document.getElementById('activeAgents').textContent = activeAgents;
                document.getElementById('totalCommission').textContent = Utils.formatCurrency(totalCommission);
                
                // Update badges
                document.getElementById('pendingLoansBadge').textContent = pendingLoans;
                document.getElementById('pendingLoansBadge').style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending').length;
                document.getElementById('pendingCommissionsBadge').textContent = pendingCommissions;
                document.getElementById('pendingCommissionsBadge').style.display = pendingCommissions > 0 ? 'inline-block' : 'none';
                
                // Update recent activity
                this.updateRecentActivity();
            },
            
            updateRecentActivity() {
                // Recent loans (pending)
                const pendingLoans = AppState.loans
                    .filter(l => l.status === 'pending')
                    .slice(0, 5);
                
                const pendingLoansList = document.getElementById('pendingLoansList');
                if (pendingLoans.length > 0) {
                    let html = '';
                    pendingLoans.forEach(loan => {
                        html += `
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <div class="font-weight-600">${loan.customerName || 'Customer'}</div>
                                    <div class="text-muted" style="font-size: 12px;">${Utils.formatCurrency(loan.amount)}  ${Utils.formatDateOnly(loan.createdAt)}</div>
                                </div>
                                <button class="btn btn-outline btn-small" onclick="showLoanDetails('${loan.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                    });
                    pendingLoansList.innerHTML = html;
                }
                
                // Recent agent applications (from pendingApplications collection)
                // This would be populated from a separate collection
                
                // Recent transactions
                const recentTransactions = AppState.transactions
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 5);
                
                const recentTransactionsList = document.getElementById('recentTransactions');
                if (recentTransactions.length > 0) {
                    let html = '';
                    recentTransactions.forEach(transaction => {
                        const typeClass = transaction.type === 'repayment' ? 'text-success' : 
                                        transaction.type === 'loan' ? 'text-primary' : 'text-warning';
                        
                        html += `
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <div class="font-weight-600 ${typeClass}">${transaction.type.toUpperCase()}</div>
                                    <div class="text-muted" style="font-size: 12px;">${Utils.formatCurrency(transaction.amount)}  ${Utils.formatDateOnly(transaction.timestamp)}</div>
                                </div>
                                <div class="text-muted" style="font-size: 12px;">${transaction.customerName?.split(' ')[0] || 'Customer'}</div>
                            </div>
                        `;
                    });
                    recentTransactionsList.innerHTML = html;
                }
            },
            
            updateLoansUI() {
                const tableBody = document.getElementById('loansTableBody');
                if (!tableBody) return;
                
                if (AppState.loans.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <h3>No Loans Found</h3>
                                    <p>No loan applications in the system</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort by creation date (newest first)
                const sortedLoans = [...AppState.loans].sort((a, b) => b.createdAt - a.createdAt);
                
                let html = '';
                sortedLoans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id}</strong></td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div>${loan.customerName || 'Unknown'}</div>
                                </div>
                            </td>
                            <td>${loan.agentName || 'Not assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td title="${loan.purpose || ''}">${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td><span class="status-badge ${statusClass}">${loan.status}</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small btn-icon" onclick="showLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn btn-success btn-small btn-icon" onclick="approveLoan('${loan.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small btn-icon" onclick="rejectLoan('${loan.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            },
            
            updateAgentsUI() {
                this.updateActiveAgentsTable();
                this.updatePendingAgentsGrid();
                this.populateAgentDropdowns();
            },
            
            updateActiveAgentsTable() {
                const tableBody = document.getElementById('activeAgentsTable');
                if (!tableBody) return;
                
                const activeAgents = AppState.agents.filter(a => a.status === 'active');
                
                if (activeAgents.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-user-tie"></i>
                                    <h3>No Active Agents</h3>
                                    <p>No active agents in the system</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                activeAgents.forEach(agent => {
                    const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agent.uid);
                    const agentLoans = AppState.loans.filter(l => l.agentId === agent.uid);
                    const agentCommission = AppState.commissions
                        .filter(c => c.agentId === agent.uid && c.status === 'paid')
                        .reduce((sum, com) => sum + (com.amount || 0), 0);
                    
                    html += `
                        <tr>
                            <td><strong>${agent.agentId || agent.uid.substring(0, 8)}</strong></td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    ${agent.profilePhoto ? 
                                        `<img src="${agent.profilePhoto}" class="avatar avatar-small" alt="${agent.fullName}">` : 
                                        `<div class="avatar avatar-small">${agent.fullName?.charAt(0) || 'A'}</div>`
                                    }
                                    <div>${agent.fullName || 'Unknown Agent'}</div>
                                </div>
                            </td>
                            <td>${agent.email || 'No email'}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agentCustomers.length}</td>
                            <td>${agentLoans.length}</td>
                            <td>${Utils.formatCurrency(agentCommission)}</td>
                            <td><span class="status-badge status-active">Active</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small btn-icon" onclick="showAgentDetails('${agent.uid}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <div class="action-dropdown">
                                        <button class="btn btn-outline btn-small btn-icon action-btn">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            <button class="dropdown-item" onclick="suspendAgent('${agent.uid}')">
                                                <i class="fas fa-pause"></i> Suspend
                                            </button>
                                            <button class="dropdown-item" onclick="banAgent('${agent.uid}')">
                                                <i class="fas fa-ban"></i> Ban
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <button class="dropdown-item text-danger" onclick="deleteAgent('${agent.uid}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // Initialize dropdown menus
                this.initActionDropdowns();
            },
            
            updatePendingAgentsGrid() {
                const grid = document.getElementById('pendingAgentsGrid');
                if (!grid) return;
                
                // For now, we'll show agents with status 'pending'
                // In a real system, you might have a separate collection for applications
                const pendingAgents = AppState.agents.filter(a => a.status === 'pending');
                
                if (pendingAgents.length === 0) {
                    grid.innerHTML = `
                        <div class="col-12">
                            <div class="empty-state">
                                <i class="fas fa-user-clock"></i>
                                <h3>No Pending Applications</h3>
                                <p>No agent applications pending approval</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                pendingAgents.forEach(agent => {
                    html += `
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    ${agent.profilePhoto ? 
                                        `<img src="${agent.profilePhoto}" class="avatar" alt="${agent.fullName}">` : 
                                        `<div class="avatar">${agent.fullName?.charAt(0) || 'A'}</div>`
                                    }
                                    <div>
                                        <h4 class="mb-1">${agent.fullName || 'Unknown'}</h4>
                                        <p class="text-muted mb-0">${agent.email || 'No email'}</p>
                                    </div>
                                </div>
                                
                                <div class="detail-grid mb-3">
                                    <div class="detail-card">
                                        <div class="detail-label">Phone</div>
                                        <div class="detail-value">${agent.phone || 'N/A'}</div>
                                    </div>
                                    <div class="detail-card">
                                        <div class="detail-label">Agent ID</div>
                                        <div class="detail-value">${agent.agentId || 'Not assigned'}</div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success flex-grow-1" onclick="approveAgentApplication('${agent.uid}')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger flex-grow-1" onclick="rejectAgentApplication('${agent.uid}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
            },
            
            updateCustomersUI() {
                const tableBody = document.getElementById('customersTableBody');
                if (!tableBody) return;
                
                if (AppState.customers.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>No Customers Found</h3>
                                    <p>No customers in the system</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.customers.forEach(customer => {
                    const customerLoans = AppState.loans.filter(l => l.customerId === customer.id);
                    const activeLoans = customerLoans.filter(l => l.status === 'active');
                    const totalBorrowed = customerLoans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                    const totalRepaid = customerLoans.reduce((sum, loan) => sum + (loan.totalPaid || 0), 0);
                    const balance = totalBorrowed - totalRepaid;
                    
                    const statusClass = `status-${customer.status || 'active'}`;
                    
                    html += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    ${customer.profilePhoto ? 
                                        `<img src="${customer.profilePhoto}" class="avatar avatar-small" alt="${customer.fullName}">` : 
                                        `<div class="avatar avatar-small">${customer.fullName?.charAt(0) || 'C'}</div>`
                                    }
                                    <div>
                                        <div class="font-weight-600">${customer.fullName || 'Unknown Customer'}</div>
                                        <div class="text-muted" style="font-size: 12px;">${customer.nrc || 'No NRC'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>${customer.email || 'No email'}</div>
                                <div class="text-muted" style="font-size: 12px;">${customer.phone || 'No phone'}</div>
                            </td>
                            <td>${customer.agentName || 'Not assigned'}</td>
                            <td>${activeLoans.length}</td>
                            <td>${Utils.formatCurrency(totalBorrowed)}</td>
                            <td>${Utils.formatCurrency(balance)}</td>
                            <td><span class="status-badge ${statusClass}">${customer.status || 'active'}</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small btn-icon" onclick="showCustomerDetails('${customer.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <div class="action-dropdown">
                                        <button class="btn btn-outline btn-small btn-icon action-btn">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            <button class="dropdown-item" onclick="showAssignAgentModal('${customer.id}')">
                                                <i class="fas fa-user-plus"></i> Assign Agent
                                            </button>
                                            ${customer.status === 'active' ? `
                                                <button class="dropdown-item" onclick="suspendCustomer('${customer.id}')">
                                                    <i class="fas fa-pause"></i> Suspend
                                                </button>
                                                <button class="dropdown-item" onclick="banCustomer('${customer.id}')">
                                                    <i class="fas fa-ban"></i> Ban
                                                </button>
                                            ` : `
                                                <button class="dropdown-item" onclick="activateCustomer('${customer.id}')">
                                                    <i class="fas fa-play"></i> Activate
                                                </button>
                                            `}
                                            <div class="dropdown-divider"></div>
                                            <button class="dropdown-item text-danger" onclick="deleteCustomer('${customer.id}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // Initialize dropdown menus
                this.initActionDropdowns();
            },
            
            updateAssignmentsUI() {
                this.populateAgentDropdowns();
                this.updateAssignmentsGrid();
            },
            
            updateAssignmentsGrid() {
                const grid = document.getElementById('assignmentsGrid');
                if (!grid) return;
                
                // Get customers with assigned agents
                const assignedCustomers = AppState.customers.filter(c => c.assignedAgentId);
                
                if (assignedCustomers.length === 0) {
                    grid.innerHTML = `
                        <div class="col-12">
                            <div class="empty-state">
                                <i class="fas fa-handshake"></i>
                                <h3>No Assignments</h3>
                                <p>No agent-customer assignments yet</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                assignedCustomers.forEach(customer => {
                    const agent = AppState.agents.find(a => a.uid === customer.assignedAgentId);
                    
                    html += `
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div class="d-flex align-items-center gap-2">
                                        ${customer.profilePhoto ? 
                                            `<img src="${customer.profilePhoto}" class="avatar avatar-small" alt="${customer.fullName}">` : 
                                            `<div class="avatar avatar-small">${customer.fullName?.charAt(0) || 'C'}</div>`
                                        }
                                        <div>
                                            <div class="font-weight-600">${customer.fullName}</div>
                                            <div class="text-muted" style="font-size: 12px;">Customer</div>
                                        </div>
                                    </div>
                                    <i class="fas fa-arrow-right text-muted"></i>
                                    <div class="d-flex align-items-center gap-2">
                                        ${agent?.profilePhoto ? 
                                            `<img src="${agent.profilePhoto}" class="avatar avatar-small" alt="${agent.fullName}">` : 
                                            `<div class="avatar avatar-small">${agent?.fullName?.charAt(0) || 'A'}</div>`
                                        }
                                        <div>
                                            <div class="font-weight-600">${agent?.fullName || 'Unknown Agent'}</div>
                                            <div class="text-muted" style="font-size: 12px;">Agent</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted" style="font-size: 12px;">
                                        Assigned: ${customer.assignedAt ? Utils.formatDateOnly(customer.assignedAt) : 'Unknown'}
                                    </div>
                                    <button class="btn btn-outline btn-small" onclick="removeAssignment('${customer.id}')">
                                        <i class="fas fa-unlink"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
            },
            
            updateCommissionsUI() {
                // Update commission totals
                const pendingCommission = AppState.commissions
                    .filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                const approvedCommission = AppState.commissions
                    .filter(c => c.status === 'approved')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                const paidCommission = AppState.commissions
                    .filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                // This month's commission
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                const thisMonthCommission = AppState.commissions
                    .filter(c => {
                        const date = new Date(c.createdAt);
                        return date.getMonth() === thisMonth && date.getFullYear() === thisYear && c.status === 'paid';
                    })
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                document.getElementById('totalPendingCommission').textContent = Utils.formatCurrency(pendingCommission);
                document.getElementById('totalApprovedCommission').textContent = Utils.formatCurrency(approvedCommission);
                document.getElementById('totalPaidCommission').textContent = Utils.formatCurrency(paidCommission);
                document.getElementById('thisMonthCommission').textContent = Utils.formatCurrency(thisMonthCommission);
                
                // Update commissions table
                const tableBody = document.getElementById('commissionsTableBody');
                if (!tableBody) return;
                
                if (AppState.commissions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-money-check-alt"></i>
                                    <h3>No Commissions</h3>
                                    <p>No commission records found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort by creation date (newest first)
                const sortedCommissions = [...AppState.commissions].sort((a, b) => b.createdAt - a.createdAt);
                
                let html = '';
                sortedCommissions.forEach(commission => {
                    const statusClass = `status-${commission.status}`;
                    
                    html += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="avatar avatar-small">${commission.agentName?.charAt(0) || 'A'}</div>
                                    <div>
                                        <div class="font-weight-600">${commission.agentName || 'Unknown Agent'}</div>
                                        <div class="text-muted" style="font-size: 12px;">${commission.agentId || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${commission.customerName || 'Unknown Customer'}</td>
                            <td><strong>${commission.loanId || 'N/A'}</strong></td>
                            <td>${Utils.formatCurrency(commission.loanAmount || 0)}</td>
                            <td>${commission.commissionRate || 2.5}%</td>
                            <td>${Utils.formatCurrency(commission.amount)}</td>
                            <td><span class="status-badge ${statusClass}">${commission.status}</span></td>
                            <td>${Utils.formatDateOnly(commission.createdAt)}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small btn-icon" onclick="showCommissionDetails('${commission.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${commission.status === 'pending' ? `
                                        <button class="btn btn-success btn-small btn-icon" onclick="approveCommission('${commission.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : commission.status === 'approved' ? `
                                        <button class="btn btn-primary btn-small btn-icon" onclick="payCommission('${commission.id}')">
                                            <i class="fas fa-money-check"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            },
            
            updateTransactionsUI() {
                const tableBody = document.getElementById('transactionsTableBody');
                if (!tableBody) return;
                
                if (AppState.transactions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-exchange-alt"></i>
                                    <h3>No Transactions</h3>
                                    <p>No transactions found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort by timestamp (newest first)
                const sortedTransactions = [...AppState.transactions].sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '';
                sortedTransactions.forEach(transaction => {
                    const typeClass = transaction.type === 'repayment' ? 'text-success' : 
                                    transaction.type === 'loan' ? 'text-primary' : 'text-warning';
                    
                    html += `
                        <tr>
                            <td><strong>${transaction.id}</strong></td>
                            <td><span class="${typeClass}">${transaction.type}</span></td>
                            <td>${Utils.formatCurrency(transaction.amount)}</td>
                            <td>${transaction.customerName || 'Unknown Customer'}</td>
                            <td>${transaction.agentName || 'Not assigned'}</td>
                            <td>${transaction.loanId || 'N/A'}</td>
                            <td>${Utils.formatDate(transaction.timestamp)}</td>
                            <td><span class="status-badge status-${transaction.status || 'completed'}">${transaction.status || 'completed'}</span></td>
                            <td>${transaction.reference || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            },
            
            updateReportsUI() {
                // Initialize charts if not already initialized
                this.initializeCharts();
                
                // Update statistics
                const totalPortfolio = AppState.loans
                    .filter(l => l.status === 'active')
                    .reduce((sum, loan) => sum + (loan.amount || 0), 0);
                
                const activeLoans = AppState.loans.filter(l => l.status === 'active').length;
                
                const defaultedLoans = AppState.loans.filter(l => l.status === 'defaulted').length;
                const defaultRate = AppState.loans.length > 0 ? 
                    ((defaultedLoans / AppState.loans.length) * 100).toFixed(1) : 0;
                
                const avgLoanSize = AppState.loans.length > 0 ? 
                    (AppState.loans.reduce((sum, loan) => sum + (loan.amount || 0), 0) / AppState.loans.length) : 0;
                
                document.getElementById('totalPortfolio').textContent = Utils.formatCurrency(totalPortfolio);
                document.getElementById('activeLoansCount').textContent = activeLoans;
                document.getElementById('defaultRate').textContent = `${defaultRate}%`;
                document.getElementById('avgLoanSize').textContent = Utils.formatCurrency(avgLoanSize);
            },
            
            updateAuditUI() {
                const tableBody = document.getElementById('auditTableBody');
                if (!tableBody) return;
                
                if (AppState.auditLogs.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <h3>No Audit Logs</h3>
                                    <p>No audit logs found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                AppState.auditLogs.forEach(log => {
                    let actionText = '';
                    let details = '';
                    
                    switch(log.action) {
                        case 'loan_approve':
                            actionText = 'Loan Approved';
                            details = `Loan ${log.data.loanId} approved`;
                            break;
                        case 'loan_reject':
                            actionText = 'Loan Rejected';
                            details = `Loan ${log.data.loanId} rejected`;
                            break;
                        case 'agent_create':
                            actionText = 'Agent Created';
                            details = `Agent ${log.data.agentName} created`;
                            break;
                        case 'customer_create':
                            actionText = 'Customer Created';
                            details = `Customer ${log.data.customerName} created`;
                            break;
                        case 'agent_assignment':
                            actionText = 'Agent Assigned';
                            details = `Agent ${log.data.agentName} assigned to customer`;
                            break;
                        default:
                            actionText = log.action.replace('_', ' ');
                            details = JSON.stringify(log.data);
                    }
                    
                    html += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>${log.userName} (${log.userRole})</td>
                            <td>${actionText}</td>
                            <td>${details}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                            <td title="${log.userAgent}">${Utils.truncateText(log.userAgent, 50)}</td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            },
            
            updateSettingsUI() {
                // Load current settings
                document.getElementById('maxLoanAmount').value = AppState.systemSettings.maxLoanAmount || 50000;
                document.getElementById('minLoanAmount').value = AppState.systemSettings.minLoanAmount || 100;
                document.getElementById('defaultInterestRate').value = AppState.systemSettings.interestRate || 15;
                document.getElementById('defaultCommissionRate').value = AppState.systemSettings.commissionRate || 2.5;
                document.getElementById('loanTerms').value = AppState.systemSettings.loanTerms?.join(',') || '3,6,12,18,24';
            },
            
            initializeCharts() {
                // Loan Performance Chart
                const loanCtx = document.getElementById('loanPerformanceChart');
                if (loanCtx && !AppState.charts.loanPerformance) {
                    const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
                    const data = {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Loans Approved',
                                data: [12, 19, 15, 25, 22, 30, 28],
                                borderColor: 'var(--macos-green)',
                                backgroundColor: 'rgba(52, 199, 89, 0.1)',
                                fill: true
                            },
                            {
                                label: 'Loans Rejected',
                                data: [2, 3, 1, 4, 3, 2, 1],
                                borderColor: 'var(--macos-red)',
                                backgroundColor: 'rgba(255, 59, 48, 0.1)',
                                fill: true
                            }
                        ]
                    };
                    
                    AppState.charts.loanPerformance = new Chart(loanCtx, {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    });
                }
                
                // Agent Performance Chart
                const agentCtx = document.getElementById('agentPerformanceChart');
                if (agentCtx && !AppState.charts.agentPerformance) {
                    const topAgents = AppState.agents.slice(0, 5);
                    const labels = topAgents.map(a => a.fullName?.split(' ')[0] || 'Agent');
                    const data = topAgents.map(a => {
                        const agentLoans = AppState.loans.filter(l => l.agentId === a.uid);
                        return agentLoans.length;
                    });
                    
                    AppState.charts.agentPerformance = new Chart(agentCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Loans Processed',
                                data: data,
                                backgroundColor: 'var(--macos-blue)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            },
            
            populateAgentDropdowns() {
                const dropdowns = [
                    document.getElementById('assignmentAgent'),
                    document.getElementById('bulkAssignmentAgent'),
                    document.getElementById('customerAssignedAgent')
                ];
                
                dropdowns.forEach(dropdown => {
                    if (!dropdown) return;
                    
                    // Clear existing options (except first)
                    while (dropdown.options.length > 1) {
                        dropdown.remove(1);
                    }
                    
                    // Add agent options
                    AppState.agents.forEach(agent => {
                        if (agent.status === 'active') {
                            const option = document.createElement('option');
                            option.value = agent.uid;
                            option.textContent = `${agent.fullName} (${agent.agentId || agent.uid.substring(0, 8)})`;
                            dropdown.appendChild(option);
                        }
                    });
                });
                
                // Populate customer dropdown for assignments
                const customerDropdown = document.getElementById('assignmentCustomer');
                if (customerDropdown) {
                    while (customerDropdown.options.length > 1) {
                        customerDropdown.remove(1);
                    }
                    
                    AppState.customers.forEach(customer => {
                        if (customer.status === 'active') {
                            const option = document.createElement('option');
                            option.value = customer.id;
                            option.textContent = `${customer.fullName} (${customer.nrc || 'No NRC'})`;
                            customerDropdown.appendChild(option);
                        }
                    });
                }
            },
            
            initActionDropdowns() {
                document.querySelectorAll('.action-dropdown').forEach(dropdown => {
                    const button = dropdown.querySelector('.action-btn');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        menu.classList.toggle('show');
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', () => {
                        menu.classList.remove('show');
                    });
                });
            },
            
            async handleCreateAgent() {
                const form = document.getElementById('createAgentForm');
                const formData = {
                    fullName: document.getElementById('agentFullName').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    agentId: document.getElementById('agentCustomId').value.trim(),
                    password: document.getElementById('agentPassword').value,
                    branch: document.getElementById('agentBranch').value.trim(),
                    commissionRate: parseFloat(document.getElementById('agentCommissionRate').value) || 2.5,
                    profilePhoto: document.getElementById('agentProfilePhoto').value,
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!formData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(formData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(formData.phone)) errors.push('Valid phone number is required');
                if (!formData.agentId) errors.push('Agent ID is required');
                if (!formData.password) errors.push('Password is required');
                if (formData.password.length < 6) errors.push('Password must be at least 6 characters');
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                Utils.showLoading('Creating Agent Account...');
                
                const result = await FirebaseService.createAgent(formData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent created successfully!', 'success');
                    form.reset();
                    this.showTab('active-agents');
                } else {
                    Utils.showToast('Creation Failed', result.error, 'error');
                }
            },
            
            async handleCreateCustomer() {
                const form = document.getElementById('createCustomerForm');
                const formData = {
                    fullName: document.getElementById('customerFullName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    nrc: document.getElementById('customerNRC').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    houseNumber: document.getElementById('customerHouseNumber').value.trim(),
                    occupation: document.getElementById('customerOccupation').value.trim(),
                    monthlyIncome: parseFloat(document.getElementById('customerMonthlyIncome').value) || 0,
                    password: document.getElementById('customerPassword').value,
                    assignedAgentId: document.getElementById('customerAssignedAgent').value,
                    notes: document.getElementById('customerNotes').value.trim()
                };
                
                // Validation
                const errors = [];
                if (!formData.fullName) errors.push('Full name is required');
                if (!Utils.validateEmail(formData.email)) errors.push('Valid email is required');
                if (!Utils.validatePhone(formData.phone)) errors.push('Valid phone number is required');
                if (!Utils.validateNRC(formData.nrc)) errors.push('Valid NRC (123456/78/9) is required');
                if (!formData.address) errors.push('Address is required');
                if (!formData.password) errors.push('Password is required');
                if (formData.password.length < 6) errors.push('Password must be at least 6 characters');
                
                if (errors.length > 0) {
                    errors.forEach(error => Utils.showToast('Validation Error', error, 'error'));
                    return;
                }
                
                Utils.showLoading('Creating Customer Account...');
                
                const result = await FirebaseService.createCustomer(formData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer created successfully!', 'success');
                    closeModal('createCustomerModal');
                    form.reset();
                    this.updateCustomersUI();
                } else {
                    Utils.showToast('Creation Failed', result.error, 'error');
                }
            }
        };

        // ===== Modal Functions =====
        function showLoanDetails(loanId) {
            const loan = AppState.loans.find(l => l.id === loanId);
            if (!loan) {
                Utils.showToast('Error', 'Loan not found', 'error');
                return;
            }
            
            const modalContent = document.getElementById('loanDetailContent');
            const statusClass = `status-${loan.status}`;
            
            let html = `
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Loan ID</div>
                        <div class="detail-value">${loan.id}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Amount</div>
                        <div class="detail-value">${Utils.formatCurrency(loan.amount)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Status</div>
                        <div class="detail-value"><span class="status-badge ${statusClass}">${loan.status}</span></div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Interest Rate</div>
                        <div class="detail-value">${loan.interestRate || 15}%</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Customer Information</h4>
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="avatar avatar-large">${loan.customerName?.charAt(0) || 'C'}</div>
                        <div>
                            <h4 class="mb-1">${loan.customerName || 'Unknown Customer'}</h4>
                            <p class="text-muted mb-0">${loan.customerEmail || 'No email'}</p>
                            <p class="text-muted mb-0">${loan.customerPhone || 'No phone'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Agent Information</h4>
                    ${loan.agentName ? `
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar">${loan.agentName?.charAt(0) || 'A'}</div>
                            <div>
                                <h5 class="mb-1">${loan.agentName}</h5>
                                <p class="text-muted mb-0">Agent ID: ${loan.agentId || 'N/A'}</p>
                            </div>
                        </div>
                    ` : '<p class="text-muted">No agent assigned</p>'}
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Loan Details</h4>
                    <div class="form-group">
                        <label class="form-label">Purpose</label>
                        <div class="form-input disabled">${loan.purpose || 'Not specified'}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <div class="form-input disabled">${loan.duration || 0} months</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Payment</label>
                        <div class="form-input disabled">${Utils.formatCurrency(loan.monthlyPayment || 0)}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Applied Date</label>
                        <div class="form-input disabled">${Utils.formatDate(loan.createdAt)}</div>
                    </div>
                    ${loan.reviewedBy ? `
                        <div class="form-group">
                            <label class="form-label">Reviewed By</label>
                            <div class="form-input disabled">${loan.reviewedByName || 'Admin'}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Review Notes</label>
                            <div class="form-input disabled">${loan.reviewNotes || 'No notes'}</div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('loanDetailModal')">Close</button>
                    ${loan.status === 'pending' ? `
                        <button class="btn btn-success" onclick="approveLoan('${loan.id}', true)">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger" onclick="rejectLoan('${loan.id}', true)">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    ` : ''}
                </div>
            `;
            
            modalContent.innerHTML = html;
            document.getElementById('loanDetailModal').classList.add('active');
        }
        
        function showAgentDetails(agentId) {
            const agent = AppState.agents.find(a => a.uid === agentId);
            if (!agent) {
                Utils.showToast('Error', 'Agent not found', 'error');
                return;
            }
            
            const modalContent = document.getElementById('agentDetailContent');
            const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agentId);
            const agentLoans = AppState.loans.filter(l => l.agentId === agentId);
            const agentCommission = AppState.commissions
                .filter(c => c.agentId === agentId && c.status === 'paid')
                .reduce((sum, com) => sum + (com.amount || 0), 0);
            
            let html = `
                <div class="text-center mb-4">
                    ${agent.profilePhoto ? 
                        `<img src="${agent.profilePhoto}" class="avatar avatar-large mb-3" alt="${agent.fullName}">` : 
                        `<div class="avatar avatar-large mb-3">${agent.fullName?.charAt(0) || 'A'}</div>`
                    }
                    <h3 class="mb-1">${agent.fullName}</h3>
                    <p class="text-muted mb-3">${agent.email}</p>
                    <span class="status-badge status-${agent.status || 'active'}">${agent.status || 'active'}</span>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Agent ID</div>
                        <div class="detail-value">${agent.agentId || agent.uid.substring(0, 8)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value">${agent.phone || 'N/A'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Branch</div>
                        <div class="detail-value">${agent.branch || 'Not specified'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Commission Rate</div>
                        <div class="detail-value">${agent.commissionRate || 2.5}%</div>
                    </div>
                </div>
                
                <div class="commission-grid mt-4">
                    <div class="commission-card">
                        <div class="commission-value">${agentCustomers.length}</div>
                        <div class="commission-label">Customers</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value">${agentLoans.length}</div>
                        <div class="commission-label">Loans</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value">${Utils.formatCurrency(agentCommission)}</div>
                        <div class="commission-label">Total Commission</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Recent Activity</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${agentLoans.slice(0, 5).map(loan => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                                <div>
                                    <div class="font-weight-600">${loan.customerName || 'Customer'}</div>
                                    <div class="text-muted" style="font-size: 12px;">${Utils.formatCurrency(loan.amount)}  ${Utils.formatDateOnly(loan.createdAt)}</div>
                                </div>
                                <span class="status-badge status-${loan.status}">${loan.status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('agentDetailModal')">Close</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline" onclick="suspendAgent('${agentId}')">
                            <i class="fas fa-pause"></i> Suspend
                        </button>
                        <button class="btn btn-danger" onclick="deleteAgent('${agentId}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = html;
            document.getElementById('agentDetailModal').classList.add('active');
        }
        
        function showCustomerDetails(customerId) {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) {
                Utils.showToast('Error', 'Customer not found', 'error');
                return;
            }
            
            const modalContent = document.getElementById('customerDetailContent');
            const customerLoans = AppState.loans.filter(l => l.customerId === customerId);
            const activeLoans = customerLoans.filter(l => l.status === 'active');
            const totalBorrowed = customerLoans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
            const totalRepaid = customerLoans.reduce((sum, loan) => sum + (loan.totalPaid || 0), 0);
            const balance = totalBorrowed - totalRepaid;
            
            let html = `
                <div class="d-flex align-items-center gap-4 mb-4">
                    ${customer.profilePhoto ? 
                        `<img src="${customer.profilePhoto}" class="avatar avatar-large" alt="${customer.fullName}">` : 
                        `<div class="avatar avatar-large">${customer.fullName?.charAt(0) || 'C'}</div>`
                    }
                    <div>
                        <h3 class="mb-1">${customer.fullName}</h3>
                        <p class="text-muted mb-2">${customer.email}</p>
                        <span class="status-badge status-${customer.status || 'active'}">${customer.status || 'active'}</span>
                    </div>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value">${customer.phone || 'N/A'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">NRC</div>
                        <div class="detail-value">${customer.nrc || 'N/A'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Residence</div>
                        <div class="detail-value">${customer.residence || 'N/A'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Occupation</div>
                        <div class="detail-value">${customer.occupation || 'N/A'}</div>
                    </div>
                </div>
                
                ${customer.assignedAgentId ? `
                    <div class="mt-4">
                        <h4 class="section-title mb-3">Assigned Agent</h4>
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar">${customer.agentName?.charAt(0) || 'A'}</div>
                            <div>
                                <h5 class="mb-1">${customer.agentName}</h5>
                                <p class="text-muted mb-0">Agent ID: ${customer.assignedAgentId.substring(0, 8)}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="commission-grid mt-4">
                    <div class="commission-card">
                        <div class="commission-value">${customerLoans.length}</div>
                        <div class="commission-label">Total Loans</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value">${activeLoans.length}</div>
                        <div class="commission-label">Active Loans</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value">${Utils.formatCurrency(totalBorrowed)}</div>
                        <div class="commission-label">Total Borrowed</div>
                    </div>
                    <div class="commission-card">
                        <div class="commission-value">${Utils.formatCurrency(balance)}</div>
                        <div class="commission-label">Current Balance</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Loan History</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${customerLoans.map(loan => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                                <div>
                                    <div class="font-weight-600">${Utils.formatCurrency(loan.amount)}</div>
                                    <div class="text-muted" style="font-size: 12px;">${loan.purpose || 'No purpose'}  ${Utils.formatDateOnly(loan.createdAt)}</div>
                                </div>
                                <span class="status-badge status-${loan.status}">${loan.status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('customerDetailModal')">Close</button>
                    <div class="d-flex gap-2">
                        ${customer.status === 'active' ? `
                            <button class="btn btn-outline" onclick="suspendCustomer('${customerId}')">
                                <i class="fas fa-pause"></i> Suspend
                            </button>
                            <button class="btn btn-danger" onclick="banCustomer('${customerId}')">
                                <i class="fas fa-ban"></i> Ban
                            </button>
                        ` : `
                            <button class="btn btn-success" onclick="activateCustomer('${customerId}')">
                                <i class="fas fa-play"></i> Activate
                            </button>
                        `}
                        <button class="btn btn-primary" onclick="showAssignAgentModal('${customerId}')">
                            <i class="fas fa-user-plus"></i> Assign Agent
                        </button>
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = html;
            document.getElementById('customerDetailModal').classList.add('active');
        }
        
        function showCommissionDetails(commissionId) {
            const commission = AppState.commissions.find(c => c.id === commissionId);
            if (!commission) {
                Utils.showToast('Error', 'Commission not found', 'error');
                return;
            }
            
            const modalContent = document.getElementById('commissionDetailContent');
            const statusClass = `status-${commission.status}`;
            
            let html = `
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Commission ID</div>
                        <div class="detail-value">${commission.id}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Amount</div>
                        <div class="detail-value">${Utils.formatCurrency(commission.amount)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Status</div>
                        <div class="detail-value"><span class="status-badge ${statusClass}">${commission.status}</span></div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Earned Date</div>
                        <div class="detail-value">${Utils.formatDate(commission.createdAt)}</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Agent Information</h4>
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar">${commission.agentName?.charAt(0) || 'A'}</div>
                        <div>
                            <h5 class="mb-1">${commission.agentName}</h5>
                            <p class="text-muted mb-0">Agent ID: ${commission.agentId || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="section-title mb-3">Loan Information</h4>
                    <div class="form-group">
                        <label class="form-label">Loan ID</label>
                        <div class="form-input disabled">${commission.loanId || 'N/A'}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Loan Amount</label>
                        <div class="form-input disabled">${Utils.formatCurrency(commission.loanAmount || 0)}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Commission Rate</label>
                        <div class="form-input disabled">${commission.commissionRate || 2.5}%</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <div class="form-input disabled">${commission.customerName || 'Unknown Customer'}</div>
                    </div>
                </div>
                
                ${commission.paidAt ? `
                    <div class="mt-4">
                        <h4 class="section-title mb-3">Payout Information</h4>
                        <div class="form-group">
                            <label class="form-label">Paid Date</label>
                            <div class="form-input disabled">${Utils.formatDate(commission.paidAt)}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Paid By</label>
                            <div class="form-input disabled">${commission.paidByName || 'Admin'}</div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('commissionDetailModal')">Close</button>
                    ${commission.status === 'pending' ? `
                        <button class="btn btn-success" onclick="approveCommission('${commissionId}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                    ` : commission.status === 'approved' ? `
                        <button class="btn btn-primary" onclick="payCommission('${commissionId}')">
                            <i class="fas fa-money-check"></i> Pay Now
                        </button>
                    ` : ''}
                </div>
            `;
            
            modalContent.innerHTML = html;
            document.getElementById('commissionDetailModal').classList.add('active');
        }
        
        function showCreateCustomerModal() {
            document.getElementById('createCustomerModal').classList.add('active');
        }
        
        function showBulkAssignmentModal() {
            const modal = document.getElementById('bulkAssignmentModal');
            const customersList = document.getElementById('bulkCustomersList');
            
            // Populate customers list with checkboxes
            let html = '';
            AppState.customers.forEach(customer => {
                if (customer.status === 'active') {
                    html += `
                        <div class="form-group">
                            <label class="d-flex align-items-center gap-2">
                                <input type="checkbox" value="${customer.id}" class="customer-checkbox">
                                <div>
                                    <div class="font-weight-600">${customer.fullName}</div>
                                    <div class="text-muted" style="font-size: 12px;">${customer.email}  ${customer.phone || 'No phone'}</div>
                                </div>
                            </label>
                        </div>
                    `;
                }
            });
            
            customersList.innerHTML = html;
            modal.classList.add('active');
        }
        
        function showAssignAgentModal(customerId) {
            // This would be a simpler modal for single assignment
            // For now, we'll use the existing assignment form
            document.getElementById('assignmentCustomer').value = customerId;
            UIManager.showSection('assignments');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // ===== Action Functions =====
        async function approveLoan(loanId, showModal = false) {
            if (!showModal) {
                if (!confirm('Are you sure you want to approve this loan?')) return;
            }
            
            const notes = showModal ? prompt('Enter approval notes (optional):') : '';
            
            Utils.showLoading('Approving Loan...');
            const result = await FirebaseService.approveLoan(loanId, 'approve', notes);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('loanDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function rejectLoan(loanId, showModal = false) {
            if (!showModal) {
                if (!confirm('Are you sure you want to reject this loan?')) return;
            }
            
            const notes = showModal ? prompt('Enter rejection reason (optional):') : '';
            
            Utils.showLoading('Rejecting Loan...');
            const result = await FirebaseService.approveLoan(loanId, 'reject', notes);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('loanDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function approveAgentApplication(agentId) {
            if (!confirm('Are you sure you want to approve this agent application?')) return;
            
            Utils.showLoading('Approving Agent...');
            const result = await FirebaseService.updateUserStatus(agentId, 'active', 'Application approved');
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function rejectAgentApplication(agentId) {
            if (!confirm('Are you sure you want to reject this agent application?')) return;
            
            Utils.showLoading('Rejecting Agent...');
            const result = await FirebaseService.updateUserStatus(agentId, 'rejected', 'Application rejected');
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function suspendAgent(agentId) {
            if (!confirm('Are you sure you want to suspend this agent?')) return;
            
            const reason = prompt('Enter suspension reason:');
            if (!reason) return;
            
            Utils.showLoading('Suspending Agent...');
            const result = await FirebaseService.updateUserStatus(agentId, 'suspended', reason);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('agentDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function banAgent(agentId) {
            if (!confirm('Are you sure you want to ban this agent?')) return;
            
            const reason = prompt('Enter ban reason:');
            if (!reason) return;
            
            Utils.showLoading('Banning Agent...');
            const result = await FirebaseService.updateUserStatus(agentId, 'banned', reason);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('agentDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) return;
            
            Utils.showLoading('Deleting Agent...');
            const result = await FirebaseService.deleteUser(agentId, 'agent');
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('agentDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function suspendCustomer(customerId) {
            if (!confirm('Are you sure you want to suspend this customer?')) return;
            
            const reason = prompt('Enter suspension reason:');
            if (!reason) return;
            
            Utils.showLoading('Suspending Customer...');
            const result = await FirebaseService.updateUserStatus(customerId, 'suspended', reason);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('customerDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function banCustomer(customerId) {
            if (!confirm('Are you sure you want to ban this customer?')) return;
            
            const reason = prompt('Enter ban reason:');
            if (!reason) return;
            
            Utils.showLoading('Banning Customer...');
            const result = await FirebaseService.updateUserStatus(customerId, 'banned', reason);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('customerDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function activateCustomer(customerId) {
            if (!confirm('Are you sure you want to activate this customer?')) return;
            
            Utils.showLoading('Activating Customer...');
            const result = await FirebaseService.updateUserStatus(customerId, 'active', 'Customer activated');
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('customerDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) return;
            
            Utils.showLoading('Deleting Customer...');
            const result = await FirebaseService.deleteUser(customerId, 'customer');
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                closeModal('customerDetailModal');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function assignAgentToCustomer() {
            const agentId = document.getElementById('assignmentAgent').value;
            const customerId = document.getElementById('assignmentCustomer').value;
            
            if (!agentId || !customerId) {
                Utils.showToast('Error', 'Please select both agent and customer', 'error');
                return;
            }
            
            Utils.showLoading('Assigning Agent...');
            const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
                document.getElementById('assignmentCustomer').value = '';
                UIManager.updateAssignmentsUI();
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function processBulkAssignment() {
            const agentId = document.getElementById('bulkAssignmentAgent').value;
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            
            if (!agentId || checkboxes.length === 0) {
                Utils.showToast('Error', 'Please select an agent and at least one customer', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to assign ${checkboxes.length} customers to this agent?`)) return;
            
            Utils.showLoading('Processing Assignments...');
            
            const results = [];
            for (const checkbox of checkboxes) {
                const result = await FirebaseService.assignAgentToCustomer(checkbox.value, agentId);
                results.push(result);
            }
            
            Utils.hideLoading();
            
            const successful = results.filter(r => r.success).length;
            Utils.showToast('Success', `${successful} customers assigned successfully`, 'success');
            
            closeModal('bulkAssignmentModal');
            UIManager.updateAssignmentsUI();
        }
        
        async function removeAssignment(customerId) {
            if (!confirm('Are you sure you want to remove this assignment?')) return;
            
            Utils.showLoading('Removing Assignment...');
            
            try {
                const customerRef = db.ref('users/' + customerId);
                await customerRef.update({
                    assignedAgentId: '',
                    agentName: '',
                    updatedAt: Date.now()
                });
                
                Utils.showToast('Success', 'Assignment removed successfully', 'success');
                UIManager.updateAssignmentsUI();
            } catch (error) {
                console.error('Error removing assignment:', error);
                Utils.showToast('Error', 'Failed to remove assignment', 'error');
            }
        }
        
        async function approveCommission(commissionId) {
            if (!confirm('Are you sure you want to approve this commission?')) return;
            
            Utils.showLoading('Approving Commission...');
            
            try {
                const commissionRef = db.ref('commissions/' + commissionId);
                await commissionRef.update({
                    status: 'approved',
                    approvedAt: Date.now(),
                    approvedBy: AppState.currentUser.uid,
                    approvedByName: AppState.adminData.fullName
                });
                
                Utils.showToast('Success', 'Commission approved successfully', 'success');
                closeModal('commissionDetailModal');
            } catch (error) {
                console.error('Error approving commission:', error);
                Utils.showToast('Error', 'Failed to approve commission', 'error');
            }
        }
        
        async function payCommission(commissionId) {
            if (!confirm('Are you sure you want to mark this commission as paid?')) return;
            
            Utils.showLoading('Processing Payment...');
            
            try {
                const commissionRef = db.ref('commissions/' + commissionId);
                await commissionRef.update({
                    status: 'paid',
                    paidAt: Date.now(),
                    paidBy: AppState.currentUser.uid,
                    paidByName: AppState.adminData.fullName
                });
                
                Utils.showToast('Success', 'Commission marked as paid', 'success');
                closeModal('commissionDetailModal');
            } catch (error) {
                console.error('Error paying commission:', error);
                Utils.showToast('Error', 'Failed to process payment', 'error');
            }
        }
        
        async function processCommissionPayout() {
            const pendingCommissions = AppState.commissions.filter(c => c.status === 'approved');
            
            if (pendingCommissions.length === 0) {
                Utils.showToast('Info', 'No approved commissions pending payout', 'info');
                return;
            }
            
            if (!confirm(`Are you sure you want to process payouts for ${pendingCommissions.length} commissions?`)) return;
            
            const commissionIds = pendingCommissions.map(c => c.id);
            
            Utils.showLoading('Processing Payouts...');
            const result = await FirebaseService.processCommissionPayout(commissionIds);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        async function saveSettings() {
            const settings = {
                maxLoanAmount: parseFloat(document.getElementById('maxLoanAmount').value) || 50000,
                minLoanAmount: parseFloat(document.getElementById('minLoanAmount').value) || 100,
                interestRate: parseFloat(document.getElementById('defaultInterestRate').value) || 15,
                commissionRate: parseFloat(document.getElementById('defaultCommissionRate').value) || 2.5,
                loanTerms: document.getElementById('loanTerms').value.split(',').map(t => parseInt(t.trim())).filter(t => !isNaN(t)),
                emailNotifications: {
                    loanApprovals: document.getElementById('emailLoanApprovals').checked,
                    agentAssignments: document.getElementById('emailAgentAssignments').checked,
                    commissionPayouts: document.getElementById('emailCommissionPayouts').checked
                }
            };
            
            Utils.showLoading('Saving Settings...');
            const result = await FirebaseService.saveSystemSettings(settings);
            Utils.hideLoading();
            
            if (result.success) {
                Utils.showToast('Success', result.message, 'success');
            } else {
                Utils.showToast('Error', result.error, 'error');
            }
        }
        
        // ===== Cloudinary Functions =====
        function openAgentPhotoUpload() {
            // This would initialize and open Cloudinary widget
            // Implementation depends on your Cloudinary setup
            Utils.showToast('Info', 'Photo upload feature would open here', 'info');
        }
        
        // ===== Export Functions =====
        function exportLoans() {
            const data = AppState.loans.map(loan => ({
                'Loan ID': loan.id,
                'Customer': loan.customerName,
                'Agent': loan.agentName,
                'Amount': loan.amount,
                'Purpose': loan.purpose,
                'Status': loan.status,
                'Applied Date': Utils.formatDate(loan.createdAt),
                'Interest Rate': loan.interestRate,
                'Duration': loan.duration
            }));
            
            exportToCSV(data, 'loans_export.csv');
            Utils.showToast('Export', 'Loans data exported successfully', 'success');
        }
        
        function exportTransactions() {
            const data = AppState.transactions.map(transaction => ({
                'Transaction ID': transaction.id,
                'Type': transaction.type,
                'Amount': transaction.amount,
                'Customer': transaction.customerName,
                'Agent': transaction.agentName,
                'Date': Utils.formatDate(transaction.timestamp),
                'Status': transaction.status,
                'Reference': transaction.reference
            }));
            
            exportToCSV(data, 'transactions_export.csv');
            Utils.showToast('Export', 'Transactions data exported successfully', 'success');
        }
        
        function exportToCSV(data, filename) {
            const csvContent = "data:text/csv;charset=utf-8," 
                + [Object.keys(data[0]), ...data.map(row => Object.values(row))]
                    .map(row => row.join(","))
                    .join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ===== Other Functions =====
        function loadRecentActivity() {
            UIManager.updateRecentActivity();
            Utils.showToast('Refreshed', 'Recent activity updated', 'success');
        }
        
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            Utils.showToast('Report', `Generating report for ${period}...`, 'info');
            // In a real implementation, this would generate and download a report
        }
        
        function filterByDate() {
            // This would open a date picker modal
            Utils.showToast('Filter', 'Date range filter would open here', 'info');
        }
        
        // ===== Initialize Application =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Set up online/offline detection
            window.addEventListener('online', () => {
                document.getElementById('connectionStatus').textContent = 'Online';
                document.getElementById('connectionStatus').style.color = 'var(--macos-green)';
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('connectionStatus').textContent = 'Offline';
                document.getElementById('connectionStatus').style.color = 'var(--macos-red)';
                Utils.showToast('Connection Lost', 'You are offline. Some features may not work.', 'warning');
            });
            
            // Initialize action dropdowns
            setTimeout(() => {
                UIManager.initActionDropdowns();
            }, 1000);
        });
    </script>
</body>
</html>
