<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TruCash - Admin Panel</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://ui-avatars.com/api/?name=T&background=007AFF&color=fff">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Cloudinary -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ===== MAC OS THEME VARIABLES ===== */
        :root {
            --macos-white: #ffffff;
            --macos-gray-0: #f5f5f7;
            --macos-gray-1: #e5e5ea;
            --macos-gray-2: #d1d1d6;
            --macos-gray-3: #c7c7cc;
            --macos-gray-4: #aeaeb2;
            --macos-gray-5: #8e8e93;
            --macos-gray-6: #636366;
            --macos-text-primary: #000000;
            --macos-text-secondary: #3c3c43;
            --macos-blue: #007AFF;
            --macos-green: #34C759;
            --macos-orange: #FF9500;
            --macos-red: #FF3B30;
            --macos-purple: #AF52DE;
            --macos-yellow: #FFCC00;
            
            --macos-radius-sm: 8px;
            --macos-radius-md: 12px;
            --macos-radius-lg: 18px;
            
            --macos-shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --macos-shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --macos-shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            
            --macos-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            
            --sidebar-width: 260px;
            --header-height: 60px;
            --bottom-nav-height: 70px;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--macos-white);
            color: var(--macos-text-primary);
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
        }
        
        input, select, textarea {
            font-family: inherit;
            border: none;
            outline: none;
        }
        
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-2);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-3);
        }
        
        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            padding-top: var(--header-height);
            padding-bottom: var(--bottom-nav-height);
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--macos-white);
            border-right: 1px solid var(--macos-gray-1);
            padding: 20px 0;
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: var(--bottom-nav-height);
            overflow-y: auto;
            z-index: 100;
            transition: var(--macos-transition);
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--macos-gray-1);
            margin-bottom: 20px;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .admin-details {
            flex: 1;
        }
        
        .admin-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        
        .admin-role {
            font-size: 12px;
            color: var(--macos-gray-5);
            background: var(--macos-gray-0);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .nav-section {
            padding: 0 20px;
            margin-bottom: 24px;
        }
        
        .nav-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--macos-gray-5);
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .nav-items {
            list-style: none;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--macos-radius-sm);
            margin-bottom: 4px;
            color: var(--macos-text-secondary);
            transition: var(--macos-transition);
            cursor: pointer;
            position: relative;
        }
        
        .nav-item:hover {
            background: var(--macos-gray-0);
        }
        
        .nav-item.active {
            background: var(--macos-blue);
            color: white;
        }
        
        .nav-item.active .nav-icon {
            color: white;
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
            color: var(--macos-gray-5);
        }
        
        .nav-label {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }
        
        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }
        
        /* ===== HEADER ===== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--macos-white);
            border-bottom: 1px solid var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            color: var(--macos-blue);
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .stats-badge {
            background: var(--macos-gray-0);
            padding: 6px 12px;
            border-radius: var(--macos-radius-sm);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stats-badge i {
            color: var(--macos-blue);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            overflow-y: auto;
            background: var(--macos-gray-0);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ===== BOTTOM NAV (MOBILE) ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--macos-white);
            border-top: 1px solid var(--macos-gray-1);
            display: none;
            z-index: 1000;
        }
        
        .bottom-nav-items {
            display: flex;
            height: 100%;
        }
        
        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--macos-gray-5);
            transition: var(--macos-transition);
        }
        
        .bottom-nav-item.active {
            color: var(--macos-blue);
        }
        
        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .bottom-nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        
        /* ===== CARDS & COMPONENTS ===== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
        }
        
        .section-subtitle {
            font-size: 14px;
            color: var(--macos-gray-5);
            margin-top: 4px;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--macos-white);
            border-radius: var(--macos-radius-md);
            padding: 20px;
            box-shadow: var(--macos-shadow-sm);
            transition: var(--macos-transition);
        }
        
        .card:hover {
            box-shadow: var(--macos-shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-text-secondary);
        }
        
        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .card-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .card-trend.positive {
            color: var(--macos-green);
        }
        
        .card-trend.negative {
            color: var(--macos-red);
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .card-icon.loans {
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
        }
        
        .card-icon.agents {
            background: linear-gradient(135deg, var(--macos-green), var(--macos-blue));
        }
        
        .card-icon.customers {
            background: linear-gradient(135deg, var(--macos-orange), var(--macos-red));
        }
        
        .card-icon.commissions {
            background: linear-gradient(135deg, var(--macos-purple), var(--macos-pink));
        }
        
        /* ===== TABLES ===== */
        .table-container {
            background: var(--macos-white);
            border-radius: var(--macos-radius-md);
            overflow: hidden;
            box-shadow: var(--macos-shadow-sm);
            margin-bottom: 30px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: var(--macos-gray-0);
            border-bottom: 1px solid var(--macos-gray-1);
        }
        
        .data-table th {
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--macos-gray-1);
            transition: var(--macos-transition);
        }
        
        .data-table tbody tr:hover {
            background: var(--macos-gray-0);
        }
        
        .data-table td {
            padding: 16px 20px;
            font-size: 14px;
            color: var(--macos-text-secondary);
        }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .status-badge.active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .status-badge.approved {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        .status-badge.rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .status-badge.suspended {
            background: rgba(142, 142, 147, 0.1);
            color: var(--macos-gray-6);
        }
        
        .status-badge.banned {
            background: rgba(255, 59, 48, 0.2);
            color: var(--macos-red);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            font-weight: 600;
            transition: var(--macos-transition);
            cursor: pointer;
        }
        
        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0066cc;
        }
        
        .btn-success {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #2db84b;
        }
        
        .btn-danger {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #e02e24;
        }
        
        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }
        
        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
        }
        
        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--macos-text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--macos-gray-0);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-sm);
            font-size: 14px;
            transition: var(--macos-transition);
        }
        
        .form-input:focus {
            border-color: var(--macos-blue);
            background: white;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--macos-white);
            border-radius: var(--macos-radius-lg);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--macos-shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-gray-1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--macos-gray-0);
            color: var(--macos-gray-5);
            transition: var(--macos-transition);
        }
        
        .modal-close:hover {
            background: var(--macos-gray-1);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        
        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--macos-gray-1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* ===== DOCUMENT VIEWER ===== */
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .document-card {
            background: var(--macos-gray-0);
            border-radius: var(--macos-radius-sm);
            overflow: hidden;
            transition: var(--macos-transition);
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-sm);
        }
        
        .document-preview {
            height: 150px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .document-info {
            padding: 12px;
        }
        
        .document-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--macos-text-primary);
        }
        
        .document-type {
            font-size: 11px;
            color: var(--macos-gray-5);
            text-transform: uppercase;
        }
        
        /* ===== LOADING & TOAST ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--macos-gray-1);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 16px;
            font-size: 16px;
            color: var(--macos-text-secondary);
            font-weight: 500;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--macos-white);
            border-radius: var(--macos-radius-md);
            padding: 16px;
            box-shadow: var(--macos-shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 400px;
            z-index: 4000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--macos-transition);
        }
        
        .toast.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-icon.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .toast-icon.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .toast-icon.warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1001;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .bottom-nav {
                display: block;
            }
            
            .app-container {
                padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
            }
            
            .header-right .stats-badge {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 800px;
            }
            
            .modal {
                margin: 0;
                border-radius: var(--macos-radius-md) var(--macos-radius-md) 0 0;
                max-height: 85vh;
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 0 16px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .section-title {
                font-size: 20px;
            }
            
            .card-value {
                font-size: 28px;
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .d-none {
            display: none !important;
        }
        
        .d-flex {
            display: flex !important;
        }
        
        .flex-column {
            flex-direction: column;
        }
        
        .align-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }
        .mb-6 { margin-bottom: 24px; }
        
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .text-primary { color: var(--macos-blue); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-orange); }
        .text-muted { color: var(--macos-gray-5); }
        
        .bg-success { background: var(--macos-green); }
        .bg-danger { background: var(--macos-red); }
        .bg-warning { background: var(--macos-orange); }
        .bg-muted { background: var(--macos-gray-1); }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon success">
            <i class="fas fa-check"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">Success</div>
            <div class="toast-message" id="toastMessage">Operation completed successfully</div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-cash-register logo-icon"></i>
                <span>TruCash Admin</span>
            </div>
            <div class="page-title" id="pageTitle">Dashboard</div>
        </div>
        <div class="header-right">
            <div class="stats-badge">
                <i class="fas fa-signal"></i>
                <span id="connectionStatus">Online</span>
            </div>
            <button class="btn btn-outline btn-small" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span class="d-none d-md-inline">Logout</span>
            </button>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="admin-info">
                    <div class="admin-avatar" id="adminAvatar">A</div>
                    <div class="admin-details">
                        <div class="admin-name" id="adminName">Admin User</div>
                        <div class="admin-role">Administrator</div>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <ul class="nav-items">
                    <li class="nav-item active" data-section="dashboard">
                        <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="nav-label">Dashboard</div>
                    </li>
                    <li class="nav-item" data-section="loans">
                        <div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        <div class="nav-label">Loan Management</div>
                        <div class="nav-badge" id="pendingLoansBadge">0</div>
                    </li>
                    <li class="nav-item" data-section="agents">
                        <div class="nav-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="nav-label">Agent Management</div>
                        <div class="nav-badge" id="pendingAgentsBadge">0</div>
                    </li>
                    <li class="nav-item" data-section="customers">
                        <div class="nav-icon"><i class="fas fa-users"></i></div>
                        <div class="nav-label">Customer Management</div>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Actions</div>
                <ul class="nav-items">
                    <li class="nav-item" data-section="approvals">
                        <div class="nav-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="nav-label">Approve Requests</div>
                        <div class="nav-badge" id="pendingApprovalsBadge">0</div>
                    </li>
                    <li class="nav-item" data-section="assignments">
                        <div class="nav-icon"><i class="fas fa-handshake"></i></div>
                        <div class="nav-label">Assignments</div>
                    </li>
                    <li class="nav-item" data-section="commissions">
                        <div class="nav-icon"><i class="fas fa-money-check-alt"></i></div>
                        <div class="nav-label">Commissions</div>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <ul class="nav-items">
                    <li class="nav-item" data-section="documents">
                        <div class="nav-icon"><i class="fas fa-file-contract"></i></div>
                        <div class="nav-label">Document Viewer</div>
                    </li>
                    <li class="nav-item" data-section="audit">
                        <div class="nav-icon"><i class="fas fa-history"></i></div>
                        <div class="nav-label">Audit Log</div>
                    </li>
                    <li class="nav-item" data-section="settings">
                        <div class="nav-icon"><i class="fas fa-cog"></i></div>
                        <div class="nav-label">Settings</div>
                    </li>
                </ul>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboardSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Admin Dashboard</div>
                        <div class="section-subtitle">Overview of system activities and statistics</div>
                    </div>
                    <button class="btn btn-primary" id="refreshDashboard">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Loans</div>
                            <div class="card-icon loans">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalLoans">0</div>
                        <div class="card-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="loansTrend">0% this month</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Active Agents</div>
                            <div class="card-icon agents">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        </div>
                        <div class="card-value" id="activeAgents">0</div>
                        <div class="card-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="agentsTrend">0% this month</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Customers</div>
                            <div class="card-icon customers">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalCustomers">0</div>
                        <div class="card-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="customersTrend">0% this month</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Commission</div>
                            <div class="card-icon commissions">
                                <i class="fas fa-money-check-alt"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalCommission">K0.00</div>
                        <div class="card-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="commissionTrend">0% this month</span>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Pending Approvals</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" id="viewAllPending">
                                View All
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Details</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="pendingApprovalsTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                                    No pending approvals
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Recent Activities</div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivitiesTable">
                            <tr>
                                <td colspan="4" class="text-center text-muted" style="padding: 40px;">
                                    No recent activities
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Loan Management Section -->
            <section class="content-section" id="loansSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Loan Management</div>
                        <div class="section-subtitle">View, approve, and manage all loan applications</div>
                    </div>
                    <div class="table-actions">
                        <input type="text" class="form-input" placeholder="Search loans..." id="loanSearch" style="width: 200px;">
                        <select class="form-input" id="loanStatusFilter" style="width: 150px;">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="active">Active</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Customer</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Purpose</th>
                                <th>Status</th>
                                <th>Applied</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                    Loading loan data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Agent Management Section -->
            <section class="content-section" id="agentsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Agent Management</div>
                        <div class="section-subtitle">Manage agent accounts and applications</div>
                    </div>
                    <button class="btn btn-primary" id="createAgentBtn">
                        <i class="fas fa-user-plus"></i> Create Agent
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">All Agents</div>
                        <div class="table-actions">
                            <input type="text" class="form-input" placeholder="Search agents..." id="agentSearch" style="width: 200px;">
                            <select class="form-input" id="agentStatusFilter" style="width: 150px;">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="suspended">Suspended</option>
                                <option value="banned">Banned</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Customers</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                    Loading agent data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Pending Agent Applications</div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Application ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>NRC</th>
                                <th>Applied</th>
                                <th>Documents</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentApplicationsTable">
                            <tr>
                                <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                                    No pending applications
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Customer Management Section -->
            <section class="content-section" id="customersSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Customer Management</div>
                        <div class="section-subtitle">Manage customer accounts and assignments</div>
                    </div>
                    <button class="btn btn-primary" id="createCustomerBtn">
                        <i class="fas fa-user-plus"></i> Create Customer
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">All Customers</div>
                        <div class="table-actions">
                            <input type="text" class="form-input" placeholder="Search customers..." id="customerSearch" style="width: 200px;">
                            <select class="form-input" id="customerStatusFilter" style="width: 150px;">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                                <option value="banned">Banned</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Agent</th>
                                <th>Loans</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                    Loading customer data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Approve Requests Section -->
            <section class="content-section" id="approvalsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Approve Requests</div>
                        <div class="section-subtitle">Review and approve pending requests</div>
                    </div>
                </div>
                
                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pending Loans</div>
                            <div class="card-icon loans">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pendingLoansCount">0</div>
                        <button class="btn btn-outline w-100 mt-3" onclick="AdminUI.showSection('loans')">
                            <i class="fas fa-eye"></i> View All
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pending Agents</div>
                            <div class="card-icon agents">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pendingAgentsCount">0</div>
                        <button class="btn btn-outline w-100 mt-3" onclick="AdminUI.showSection('agents')">
                            <i class="fas fa-eye"></i> View All
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Commission Payouts</div>
                            <div class="card-icon commissions">
                                <i class="fas fa-money-check-alt"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pendingCommissionsCount">0</div>
                        <button class="btn btn-outline w-100 mt-3" onclick="AdminUI.showSection('commissions')">
                            <i class="fas fa-eye"></i> View All
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Assignments Section -->
            <section class="content-section" id="assignmentsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Manual Assignments</div>
                        <div class="section-subtitle">Assign agents to customers manually</div>
                    </div>
                </div>
                
                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Assign Agent to Customer</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Customer</label>
                            <select class="form-input" id="assignCustomerSelect">
                                <option value="">Choose customer...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Agent</label>
                            <select class="form-input" id="assignAgentSelect">
                                <option value="">Choose agent...</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" id="assignAgentBtn">
                            <i class="fas fa-handshake"></i> Assign Agent
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Recent Assignments</div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Agent</th>
                                    <th>Assigned By</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentAssignmentsTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No assignments yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Commissions Section -->
            <section class="content-section" id="commissionsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Commission Management</div>
                        <div class="section-subtitle">Manage agent commissions and payouts</div>
                    </div>
                    <button class="btn btn-success" id="processPayoutsBtn">
                        <i class="fas fa-money-bill-wave"></i> Process Payouts
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Pending Commissions</div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Commission ID</th>
                                <th>Agent</th>
                                <th>Customer</th>
                                <th>Loan ID</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Earned Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingCommissionsTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                    No pending commissions
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Commission History</div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date Paid</th>
                                <th>Agent</th>
                                <th>Amount</th>
                                <th>Loan ID</th>
                                <th>Payment Method</th>
                                <th>Reference</th>
                            </tr>
                        </thead>
                        <tbody id="commissionHistoryTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted" style="padding: 40px;">
                                    No commission history
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Document Viewer Section -->
            <section class="content-section" id="documentsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Document Viewer</div>
                        <div class="section-subtitle">View all uploaded documents and images</div>
                    </div>
                    <div class="table-actions">
                        <select class="form-input" id="documentTypeFilter" style="width: 150px;">
                            <option value="all">All Documents</option>
                            <option value="nrc">NRC Documents</option>
                            <option value="profile">Profile Photos</option>
                            <option value="loan">Loan Documents</option>
                            <option value="collateral">Collateral</option>
                        </select>
                        <select class="form-input" id="documentUserFilter" style="width: 150px;">
                            <option value="all">All Users</option>
                            <option value="customer">Customers</option>
                            <option value="agent">Agents</option>
                        </select>
                    </div>
                </div>
                
                <div id="documentsContainer">
                    <div class="text-center text-muted" style="padding: 60px;">
                        <i class="fas fa-file-alt fa-3x mb-4"></i>
                        <h4>No documents found</h4>
                        <p>Select filters to view documents</p>
                    </div>
                </div>
            </section>
            
            <!-- Audit Log Section -->
            <section class="content-section" id="auditSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Audit Log</div>
                        <div class="section-subtitle">System activity and change history</div>
                    </div>
                    <button class="btn btn-outline" id="exportAuditLogBtn">
                        <i class="fas fa-download"></i> Export Log
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                                    Loading audit log...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section class="content-section" id="settingsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title">Settings</div>
                        <div class="section-subtitle">System configuration and preferences</div>
                    </div>
                </div>
                
                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Settings</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Maximum Loan Amount</label>
                            <input type="number" class="form-input" id="maxLoanAmount" placeholder="50000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Interest Rate (%)</label>
                            <input type="number" step="0.1" class="form-input" id="interestRate" placeholder="15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" step="0.1" class="form-input" id="commissionRate" placeholder="2.5">
                        </div>
                        <button class="btn btn-primary w-100" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Admin Profile</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="adminFullName" placeholder="Admin Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="adminEmail" readonly>
                        </div>
                        <button class="btn btn-outline w-100 mb-3" id="changePasswordBtn">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                        <button class="btn btn-danger w-100" id="clearCacheBtn">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="bottomNav">
        <div class="bottom-nav-items">
            <div class="bottom-nav-item active" data-section="dashboard">
                <div class="bottom-nav-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="bottom-nav-label">Dashboard</div>
            </div>
            <div class="bottom-nav-item" data-section="loans">
                <div class="bottom-nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                <div class="bottom-nav-label">Loans</div>
            </div>
            <div class="bottom-nav-item" data-section="agents">
                <div class="bottom-nav-icon"><i class="fas fa-user-tie"></i></div>
                <div class="bottom-nav-label">Agents</div>
            </div>
            <div class="bottom-nav-item" data-section="customers">
                <div class="bottom-nav-icon"><i class="fas fa-users"></i></div>
                <div class="bottom-nav-label">Customers</div>
            </div>
            <div class="bottom-nav-item" data-section="settings">
                <div class="bottom-nav-icon"><i class="fas fa-cog"></i></div>
                <div class="bottom-nav-label">Settings</div>
            </div>
        </div>
    </nav>
    
    <!-- Modals -->
    
    <!-- Create Agent Modal -->
    <div class="modal-overlay" id="createAgentModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Agent</div>
                <button class="modal-close" onclick="AdminUI.closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="agentFullName" placeholder="Enter agent full name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-input" id="agentPhone" placeholder="+260..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">NRC Number *</label>
                        <input type="text" class="form-input" id="agentNRC" placeholder="123456/78/9" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Residential Address *</label>
                    <input type="text" class="form-input" id="agentAddress" placeholder="Enter full address" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent Email * (MANUALLY ASSIGN)</label>
                    <input type="email" class="form-input" id="agentEmail" placeholder="agent@trucash.com" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Agent ID * (MANUALLY ASSIGN)</label>
                        <input type="text" class="form-input" id="agentCustomId" placeholder="AGENT123" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password * (MANUALLY ASSIGN)</label>
                        <input type="password" class="form-input" id="agentPassword" placeholder="Create password" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Branch/Region</label>
                    <input type="text" class="form-input" id="agentBranch" placeholder="Enter branch name">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-input form-textarea" id="agentNotes" placeholder="Any additional notes..."></textarea>
                </div>
                <div style="background: rgba(255, 204, 0, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: var(--macos-orange);">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Important:</strong> You are manually assigning the Agent ID, Email, and Password. These credentials will be sent to the agent.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="AdminUI.closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" id="submitAgentBtn">Create Agent</button>
            </div>
        </div>
    </div>
    
    <!-- Create Customer Modal -->
    <div class="modal-overlay" id="createCustomerModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Customer</div>
                <button class="modal-close" onclick="AdminUI.closeModal('createCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="customerFullName" placeholder="Enter customer full name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-input" id="customerEmail" placeholder="customer@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-input" id="customerPhone" placeholder="+260..." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">NRC Number *</label>
                        <input type="text" class="form-input" id="customerNRC" placeholder="123456/78/9" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" id="customerPassword" placeholder="Create password" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Residential Address *</label>
                    <input type="text" class="form-input" id="customerAddress" placeholder="Enter full address" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">House Number</label>
                        <input type="text" class="form-input" id="customerHouseNumber" placeholder="House/Unit number">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Income (ZMW)</label>
                        <input type="number" class="form-input" id="customerIncome" placeholder="5000">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Occupation</label>
                    <input type="text" class="form-input" id="customerOccupation" placeholder="Occupation">
                </div>
                <div class="form-group">
                    <label class="form-label">Assign Agent (Optional)</label>
                    <select class="form-input" id="customerAgentSelect">
                        <option value="">Select agent...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Status</label>
                    <select class="form-input" id="customerStatus">
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="AdminUI.closeModal('createCustomerModal')">Cancel</button>
                <button class="btn btn-primary" id="submitCustomerBtn">Create Customer</button>
            </div>
        </div>
    </div>
    
    <!-- Loan Details Modal -->
    <div class="modal-overlay" id="loanDetailsModal">
        <div class="modal" style="max-width: 1000px;">
            <div class="modal-header">
                <div class="modal-title">Loan Details</div>
                <button class="modal-close" onclick="AdminUI.closeModal('loanDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="loanDetailsContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Agent Details Modal -->
    <div class="modal-overlay" id="agentDetailsModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Agent Details</div>
                <button class="modal-close" onclick="AdminUI.closeModal('agentDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="agentDetailsContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Customer Details Modal -->
    <div class="modal-overlay" id="customerDetailsModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Customer Details</div>
                <button class="modal-close" onclick="AdminUI.closeModal('customerDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Document Viewer Modal -->
    <div class="modal-overlay" id="documentViewerModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Document Viewer</div>
                <button class="modal-close" onclick="AdminUI.closeModal('documentViewerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="documentViewerContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePasswordModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Change Password</div>
                <button class="modal-close" onclick="AdminUI.closeModal('changePasswordModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Current Password *</label>
                    <input type="password" class="form-input" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password *</label>
                    <input type="password" class="form-input" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password *</label>
                    <input type="password" class="form-input" id="confirmNewPassword" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="AdminUI.closeModal('changePasswordModal')">Cancel</button>
                <button class="btn btn-primary" id="savePasswordBtn">Change Password</button>
            </div>
        </div>
    </div>
    
    <!-- Approve Agent Application Modal -->
    <div class="modal-overlay" id="approveAgentAppModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Approve Agent Application</div>
                <button class="modal-close" onclick="AdminUI.closeModal('approveAgentAppModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="agentAppContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="AdminUI.closeModal('approveAgentAppModal')">Cancel</button>
                <button class="btn btn-danger" id="rejectAgentAppBtn">Reject</button>
                <button class="btn btn-primary" id="approveAgentAppBtn">Approve</button>
            </div>
        </div>
    </div>
    
    <!-- Approve Loan Modal -->
    <div class="modal-overlay" id="approveLoanModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Approve Loan Application</div>
                <button class="modal-close" onclick="AdminUI.closeModal('approveLoanModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="approveLoanContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
                <div class="form-group">
                    <label class="form-label">Approval Notes (Optional)</label>
                    <textarea class="form-input form-textarea" id="loanApprovalNotes" placeholder="Add notes about this approval..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Approved Amount (ZMW)</label>
                    <input type="number" class="form-input" id="approvedAmount" placeholder="Enter approved amount">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="AdminUI.closeModal('approveLoanModal')">Cancel</button>
                <button class="btn btn-danger" id="rejectLoanBtn">Reject</button>
                <button class="btn btn-primary" id="approveLoanBtn">Approve</button>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'],
            multiple: false
        };

        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            realtimeListeners: [],
            currentSection: 'dashboard',
            
            // Data stores
            loans: [],
            agents: [],
            customers: [],
            agentApplications: [],
            commissions: [],
            auditLogs: [],
            systemSettings: null,
            
            // Current selections
            selectedLoan: null,
            selectedAgent: null,
            selectedCustomer: null,
            selectedApplication: null,
            
            // UI state
            isLoading: false,
            cloudinaryWidget: null
        };

        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
                AppState.isLoading = true;
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
                AppState.isLoading = false;
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            truncateText(text, maxLength = 30) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            getInitials(name) {
                if (!name) return 'A';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            },
            
            async sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };

        // ===== TOAST NOTIFICATION MANAGER =====
        const ToastManager = {
            show(title, message, type = 'success', duration = 5000) {
                const toast = document.getElementById('toast');
                const toastTitle = document.getElementById('toastTitle');
                const toastMessage = document.getElementById('toastMessage');
                const toastIcon = toast.querySelector('.toast-icon');
                
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                
                // Set icon based on type
                let iconClass = 'fa-check';
                toastIcon.className = 'toast-icon';
                
                switch(type) {
                    case 'success':
                        iconClass = 'fa-check';
                        toastIcon.classList.add('success');
                        break;
                    case 'error':
                        iconClass = 'fa-exclamation-circle';
                        toastIcon.classList.add('error');
                        break;
                    case 'warning':
                        iconClass = 'fa-exclamation-triangle';
                        toastIcon.classList.add('warning');
                        break;
                }
                
                toastIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                toast.classList.add('active');
                
                setTimeout(() => {
                    toast.classList.remove('active');
                }, duration);
                
                return toast;
            },
            
            hide() {
                const toast = document.getElementById('toast');
                toast.classList.remove('active');
            }
        };

        // ===== FIREBASE SERVICE =====
        const FirebaseService = {
            async checkAdminAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        unsubscribe();
                        
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const userRef = db.ref('users/' + currentUser.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                ToastManager.show('Access Denied', 'Admin account not found.', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            if (userData.userType !== 'admin' && userData.email !== 'sudo@gmail.com') {
                                ToastManager.show('Access Denied', 'This panel is for administrators only.', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = currentUser;
                            AppState.adminData = userData;
                            
                            resolve(userData);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            ToastManager.show('Authentication Error', 'Failed to verify admin status.', 'error');
                            resolve(null);
                        }
                    }, (error) => {
                        console.error('Auth state listener error:', error);
                        window.location.href = 'login.html';
                        resolve(null);
                    });
                });
            },
            
            async loadAllData() {
                try {
                    // Load loans
                    const loansRef = db.ref('loans');
                    const loansSnapshot = await loansRef.once('value');
                    AppState.loans = [];
                    
                    if (loansSnapshot.exists()) {
                        loansSnapshot.forEach((childSnapshot) => {
                            const loan = childSnapshot.val();
                            loan.id = childSnapshot.key;
                            AppState.loans.push(loan);
                        });
                        
                        AppState.loans.sort((a, b) => b.createdAt - a.createdAt);
                    }
                    
                    // Load agents
                    const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                    const agentsSnapshot = await agentsRef.once('value');
                    AppState.agents = [];
                    
                    if (agentsSnapshot.exists()) {
                        agentsSnapshot.forEach((childSnapshot) => {
                            const agent = childSnapshot.val();
                            agent.id = childSnapshot.key;
                            AppState.agents.push(agent);
                        });
                    }
                    
                    // Load customers
                    const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                    const customersSnapshot = await customersRef.once('value');
                    AppState.customers = [];
                    
                    if (customersSnapshot.exists()) {
                        customersSnapshot.forEach((childSnapshot) => {
                            const customer = childSnapshot.val();
                            customer.id = childSnapshot.key;
                            AppState.customers.push(customer);
                        });
                    }
                    
                    // Load agent applications
                    const appsRef = db.ref('agentApplications');
                    const appsSnapshot = await appsRef.once('value');
                    AppState.agentApplications = [];
                    
                    if (appsSnapshot.exists()) {
                        appsSnapshot.forEach((childSnapshot) => {
                            const app = childSnapshot.val();
                            app.id = childSnapshot.key;
                            if (app.status === 'pending') {
                                AppState.agentApplications.push(app);
                            }
                        });
                    }
                    
                    // Load commissions
                    const commissionsRef = db.ref('commissions');
                    const commissionsSnapshot = await commissionsRef.once('value');
                    AppState.commissions = [];
                    
                    if (commissionsSnapshot.exists()) {
                        commissionsSnapshot.forEach((childSnapshot) => {
                            const commission = childSnapshot.val();
                            commission.id = childSnapshot.key;
                            AppState.commissions.push(commission);
                        });
                    }
                    
                    // Load system settings
                    const settingsRef = db.ref('systemSettings');
                    const settingsSnapshot = await settingsRef.once('value');
                    
                    if (settingsSnapshot.exists()) {
                        AppState.systemSettings = settingsSnapshot.val();
                    } else {
                        // Default settings
                        AppState.systemSettings = {
                            maxLoanAmount: 50000,
                            interestRate: 15,
                            commissionRate: 2.5
                        };
                    }
                    
                    // Load audit logs (last 100)
                    const auditRef = db.ref('auditLogs').limitToLast(100);
                    const auditSnapshot = await auditRef.once('value');
                    AppState.auditLogs = [];
                    
                    if (auditSnapshot.exists()) {
                        auditSnapshot.forEach((childSnapshot) => {
                            const log = childSnapshot.val();
                            AppState.auditLogs.unshift(log); // Add to beginning for reverse chronological order
                        });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    ToastManager.show('Data Error', 'Failed to load system data.', 'error');
                    return false;
                }
            },
            
            async createAgent(agentData) {
                try {
                    Utils.showLoading('Creating agent account...');
                    
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.address,
                        profilePhoto: agentData.profilePhoto || '',
                        nrcFront: agentData.nrcFront || '',
                        nrcBack: agentData.nrcBack || '',
                        userType: 'agent',
                        agentId: agentData.agentId,
                        branch: agentData.branch || '',
                        status: 'active',
                        isApproved: true,
                        approvedBy: AppState.currentUser.email,
                        approvedAt: Date.now(),
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0,
                        notes: agentData.notes || ''
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Create audit log
                    await this.createAuditLog('agent_create', {
                        agentId: agentId,
                        agentName: agentData.fullName,
                        agentEmail: agentData.email,
                        agentCustomId: agentData.agentId,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: 'Agent created manually by admin'
                    });
                    
                    Utils.hideLoading();
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    Utils.hideLoading();
                    
                    let errorMessage = 'Failed to create agent account';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async createCustomer(customerData) {
                try {
                    Utils.showLoading('Creating customer account...');
                    
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        customerData.password
                    );
                    
                    const customerId = userCredential.user.uid;
                    
                    // Prepare customer document
                    const customerDoc = {
                        uid: customerId,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        nrc: customerData.nrc,
                        residence: customerData.address,
                        houseNumber: customerData.houseNumber || '',
                        occupation: customerData.occupation || '',
                        monthlyIncome: customerData.income || 0,
                        userType: 'customer',
                        assignedAgentId: customerData.agentId || '',
                        status: customerData.status || 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        verified: true,
                        createdByAdmin: AppState.currentUser.uid,
                        accountBalance: 0,
                        totalLoans: 0,
                        activeLoans: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + customerId).set(customerDoc);
                    
                    // If agent is assigned, update agent's customer count
                    if (customerData.agentId) {
                        await db.ref('users/' + customerData.agentId + '/totalCustomers').set(
                            firebase.database.ServerValue.increment(1)
                        );
                    }
                    
                    // Create audit log
                    await this.createAuditLog('customer_create', {
                        customerId: customerId,
                        customerName: customerData.fullName,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: 'Customer created manually by admin'
                    });
                    
                    Utils.hideLoading();
                    return {
                        success: true,
                        customerId: customerId,
                        message: 'Customer created successfully'
                    };
                } catch (error) {
                    console.error('Error creating customer:', error);
                    Utils.hideLoading();
                    
                    let errorMessage = 'Failed to create customer account';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateLoanStatus(loanId, status, approvedAmount = null, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedByAdmin: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName,
                        statusNotes: notes
                    };
                    
                    if (status === 'approved' && approvedAmount) {
                        updates.approvedAmount = approvedAmount;
                        updates.approvedAt = Date.now();
                        updates.approvedBy = AppState.currentUser.uid;
                    }
                    
                    if (status === 'rejected') {
                        updates.rejectedAt = Date.now();
                        updates.rejectedBy = AppState.currentUser.uid;
                    }
                    
                    await loanRef.update(updates);
                    
                    // If approved, create commission record for agent
                    if (status === 'approved') {
                        const loanSnap = await loanRef.once('value');
                        const loan = loanSnap.val();
                        
                        if (loan.agentId) {
                            const commissionAmount = (approvedAmount || loan.amount) * (AppState.systemSettings.commissionRate || 2.5) / 100;
                            
                            await this.createCommissionRecord({
                                agentId: loan.agentId,
                                agentName: loan.agentName,
                                customerId: loan.customerId,
                                customerName: loan.customerName,
                                loanId: loanId,
                                loanAmount: approvedAmount || loan.amount,
                                type: 'loan_approval',
                                amount: commissionAmount,
                                status: 'pending',
                                createdAt: Date.now(),
                                approvedBy: AppState.currentUser.uid
                            });
                        }
                    }
                    
                    // Create audit log
                    await this.createAuditLog('loan_status_update', {
                        loanId: loanId,
                        oldStatus: AppState.selectedLoan?.status,
                        newStatus: status,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: notes || `Loan ${status} by admin`
                    });
                    
                    return { success: true, message: `Loan ${status} successfully` };
                } catch (error) {
                    console.error('Error updating loan status:', error);
                    return { success: false, error: 'Failed to update loan status' };
                }
            },
            
            async updateUserStatus(userId, status, userType) {
                try {
                    const userRef = db.ref('users/' + userId);
                    await userRef.update({
                        status: status,
                        updatedAt: Date.now(),
                        updatedByAdmin: AppState.currentUser.uid
                    });
                    
                    // Create audit log
                    await this.createAuditLog('user_status_update', {
                        userId: userId,
                        userType: userType,
                        newStatus: status,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: `${userType} status changed to ${status}`
                    });
                    
                    return { success: true, message: `${userType} status updated to ${status}` };
                } catch (error) {
                    console.error('Error updating user status:', error);
                    return { success: false, error: 'Failed to update user status' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const agentRef = db.ref('users/' + agentId);
                    
                    // Get current data
                    const customerSnap = await customerRef.once('value');
                    const agentSnap = await agentRef.once('value');
                    
                    const customer = customerSnap.val();
                    const agent = agentSnap.val();
                    
                    // Update customer
                    await customerRef.update({
                        assignedAgentId: agentId,
                        agentName: agent.fullName,
                        updatedAt: Date.now(),
                        updatedByAdmin: AppState.currentUser.uid
                    });
                    
                    // Update agent's customer count
                    await agentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_assignment', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        agentId: agentId,
                        agentName: agent.fullName,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: 'Agent manually assigned to customer by admin'
                    });
                    
                    return {
                        success: true,
                        message: `Agent ${agent.fullName} assigned to customer ${customer.fullName}`
                    };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async processCommissionPayout(commissionId, paymentMethod, reference) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    await commissionRef.update({
                        status: 'paid',
                        paidAt: Date.now(),
                        paidBy: AppState.currentUser.uid,
                        paymentMethod: paymentMethod,
                        paymentReference: reference,
                        updatedAt: Date.now()
                    });
                    
                    // Update agent's total commission
                    const commissionSnap = await commissionRef.once('value');
                    const commission = commissionSnap.val();
                    
                    if (commission.agentId) {
                        const agentRef = db.ref('users/' + commission.agentId);
                        await agentRef.update({
                            totalCommission: firebase.database.ServerValue.increment(commission.amount),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('commission_payout', {
                        commissionId: commissionId,
                        agentId: commission.agentId,
                        agentName: commission.agentName,
                        amount: commission.amount,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: `Commission paid via ${paymentMethod}`
                    });
                    
                    return { success: true, message: 'Commission paid successfully' };
                } catch (error) {
                    console.error('Error processing commission:', error);
                    return { success: false, error: 'Failed to process commission' };
                }
            },
            
            async createCommissionRecord(commissionData) {
                try {
                    const commissionId = Utils.generateId('COM');
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const commission = {
                        id: commissionId,
                        ...commissionData
                    };
                    
                    await commissionRef.set(commission);
                    return { success: true, commissionId: commissionId };
                } catch (error) {
                    console.error('Error creating commission record:', error);
                    return { success: false, error: 'Failed to create commission record' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName,
                        userRole: 'admin',
                        userEmail: AppState.currentUser.email,
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    // Add to local state
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 100) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 100);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async updateSystemSettings(settings) {
                try {
                    const settingsRef = db.ref('systemSettings');
                    await settingsRef.update({
                        ...settings,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid
                    });
                    
                    AppState.systemSettings = { ...AppState.systemSettings, ...settings };
                    
                    // Create audit log
                    await this.createAuditLog('settings_update', {
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        settings: settings
                    });
                    
                    return { success: true, message: 'Settings updated successfully' };
                } catch (error) {
                    console.error('Error updating settings:', error);
                    return { success: false, error: 'Failed to update settings' };
                }
            },
            
            async approveAgentApplication(applicationId, credentials) {
                try {
                    Utils.showLoading('Approving agent application...');
                    
                    const appRef = db.ref('agentApplications/' + applicationId);
                    const appSnap = await appRef.once('value');
                    const application = appSnap.val();
                    
                    if (!application) {
                        throw new Error('Application not found');
                    }
                    
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        credentials.email,
                        credentials.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: application.fullName,
                        email: credentials.email,
                        phone: application.phone,
                        nrc: application.nrc,
                        residence: application.residence,
                        profilePhoto: application.profilePhoto || '',
                        nrcFront: application.nrcFront || '',
                        nrcBack: application.nrcBack || '',
                        additionalDoc: application.additionalDoc || '',
                        userType: 'agent',
                        agentId: credentials.agentId,
                        status: 'active',
                        isApproved: true,
                        applicationId: applicationId,
                        approvedBy: AppState.currentUser.email,
                        approvedAt: Date.now(),
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0,
                        notes: 'Approved from application'
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Update application status
                    await appRef.update({
                        status: 'approved',
                        approvedAt: Date.now(),
                        approvedBy: AppState.currentUser.email,
                        assignedCredentials: credentials
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_application_approve', {
                        applicationId: applicationId,
                        agentId: agentId,
                        agentName: application.fullName,
                        agentEmail: credentials.email,
                        agentCustomId: credentials.agentId,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: 'Agent application approved by admin'
                    });
                    
                    Utils.hideLoading();
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent application approved successfully'
                    };
                } catch (error) {
                    console.error('Error approving agent application:', error);
                    Utils.hideLoading();
                    
                    let errorMessage = 'Failed to approve agent application';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async rejectAgentApplication(applicationId, reason = '') {
                try {
                    const appRef = db.ref('agentApplications/' + applicationId);
                    await appRef.update({
                        status: 'rejected',
                        rejectedAt: Date.now(),
                        rejectedBy: AppState.currentUser.email,
                        rejectionReason: reason
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_application_reject', {
                        applicationId: applicationId,
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        reason: reason,
                        details: 'Agent application rejected by admin'
                    });
                    
                    return { success: true, message: 'Agent application rejected' };
                } catch (error) {
                    console.error('Error rejecting agent application:', error);
                    return { success: false, error: 'Failed to reject application' };
                }
            },
            
            async changeAdminPassword(currentPassword, newPassword) {
                try {
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        AppState.currentUser.email,
                        currentPassword
                    );
                    
                    await AppState.currentUser.reauthenticateWithCredential(credential);
                    
                    // Update password
                    await AppState.currentUser.updatePassword(newPassword);
                    
                    // Create audit log
                    await this.createAuditLog('password_change', {
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        details: 'Admin password changed'
                    });
                    
                    return { success: true, message: 'Password changed successfully' };
                } catch (error) {
                    console.error('Error changing password:', error);
                    let errorMessage = 'Failed to change password';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Current password is incorrect';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'New password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.loans = [];
                    AppState.agents = [];
                    AppState.customers = [];
                    AppState.agentApplications = [];
                    AppState.commissions = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    ToastManager.show('Logout Error', 'Failed to sign out properly', 'error');
                }
            },
            
            setupRealtimeListeners() {
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    
                    // Update UI if on loans section
                    if (AppState.currentSection === 'loans' || AppState.currentSection === 'dashboard') {
                        AdminUI.updateLoansUI();
                        AdminUI.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Agents listener
                const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    
                    if (AppState.currentSection === 'agents' || AppState.currentSection === 'dashboard') {
                        AdminUI.updateAgentsUI();
                        AdminUI.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Customers listener
                const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                const customersListener = customersRef.on('value', (snapshot) => {
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    
                    if (AppState.currentSection === 'customers' || AppState.currentSection === 'dashboard') {
                        AdminUI.updateCustomersUI();
                        AdminUI.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => customersRef.off('value', customersListener));
                
                // Agent applications listener
                const appsRef = db.ref('agentApplications');
                const appsListener = appsRef.on('value', (snapshot) => {
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const app = childSnapshot.val();
                        app.id = childSnapshot.key;
                        if (app.status === 'pending') {
                            applications.push(app);
                        }
                    });
                    
                    AppState.agentApplications = applications;
                    
                    if (AppState.currentSection === 'agents' || AppState.currentSection === 'approvals') {
                        AdminUI.updateAgentApplicationsUI();
                        AdminUI.updateApprovalsUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => appsRef.off('value', appsListener));
                
                // Commissions listener
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    
                    if (AppState.currentSection === 'commissions' || AppState.currentSection === 'dashboard') {
                        AdminUI.updateCommissionsUI();
                        AdminUI.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Audit logs listener
                const auditRef = db.ref('auditLogs').limitToLast(100);
                const auditListener = auditRef.on('value', (snapshot) => {
                    const logs = [];
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        logs.unshift(log); // Add to beginning
                    });
                    
                    AppState.auditLogs = logs;
                    
                    if (AppState.currentSection === 'audit') {
                        AdminUI.updateAuditLogUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => auditRef.off('value', auditListener));
            }
        };

        // ===== UI MANAGER =====
        const AdminUI = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupResponsive();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.bottomNavItems = document.querySelectorAll('.bottom-nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                this.refreshDashboard = document.getElementById('refreshDashboard');
                this.createAgentBtn = document.getElementById('createAgentBtn');
                this.createCustomerBtn = document.getElementById('createCustomerBtn');
                this.assignAgentBtn = document.getElementById('assignAgentBtn');
                this.processPayoutsBtn = document.getElementById('processPayoutsBtn');
                this.saveSettingsBtn = document.getElementById('saveSettingsBtn');
                this.changePasswordBtn = document.getElementById('changePasswordBtn');
                this.clearCacheBtn = document.getElementById('clearCacheBtn');
                
                // Form elements
                this.submitAgentBtn = document.getElementById('submitAgentBtn');
                this.submitCustomerBtn = document.getElementById('submitCustomerBtn');
                this.savePasswordBtn = document.getElementById('savePasswordBtn');
                
                // Admin info
                this.adminAvatar = document.getElementById('adminAvatar');
                this.adminName = document.getElementById('adminName');
                this.adminEmail = document.getElementById('adminEmail');
                
                // Page title
                this.pageTitle = document.getElementById('pageTitle');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Update bottom nav
                        this.bottomNavItems.forEach(nav => nav.classList.remove('active'));
                        document.querySelector(`.bottom-nav-item[data-section="${section}"]`)?.classList.add('active');
                    });
                });
                
                this.bottomNavItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.bottomNavItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Update sidebar nav
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        document.querySelector(`.nav-item[data-section="${section}"]`)?.classList.add('active');
                    });
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Refresh dashboard
                this.refreshDashboard.addEventListener('click', () => {
                    this.updateDashboardUI();
                    ToastManager.show('Refreshed', 'Dashboard data updated', 'success');
                });
                
                // Create agent
                this.createAgentBtn.addEventListener('click', () => {
                    this.showModal('createAgentModal');
                    this.populateAgentForm();
                });
                
                // Create customer
                this.createCustomerBtn.addEventListener('click', () => {
                    this.showModal('createCustomerModal');
                    this.populateCustomerForm();
                });
                
                // Assign agent to customer
                this.assignAgentBtn.addEventListener('click', () => {
                    this.assignAgentToCustomer();
                });
                
                // Process commission payouts
                this.processPayoutsBtn.addEventListener('click', () => {
                    this.processCommissionPayouts();
                });
                
                // Save settings
                this.saveSettingsBtn.addEventListener('click', () => {
                    this.saveSystemSettings();
                });
                
                // Change password
                this.changePasswordBtn.addEventListener('click', () => {
                    this.showModal('changePasswordModal');
                });
                
                // Clear cache
                this.clearCacheBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear the cache? This will not delete any data.')) {
                        localStorage.clear();
                        ToastManager.show('Cache Cleared', 'Local cache has been cleared', 'success');
                    }
                });
                
                // Form submissions
                this.submitAgentBtn.addEventListener('click', () => {
                    this.submitAgentForm();
                });
                
                this.submitCustomerBtn.addEventListener('click', () => {
                    this.submitCustomerForm();
                });
                
                this.savePasswordBtn.addEventListener('click', () => {
                    this.changeAdminPassword();
                });
                
                // Search and filter events
                document.getElementById('loanSearch')?.addEventListener('input', Utils.debounce(() => {
                    this.filterLoans();
                }, 300));
                
                document.getElementById('loanStatusFilter')?.addEventListener('change', () => {
                    this.filterLoans();
                });
                
                document.getElementById('agentSearch')?.addEventListener('input', Utils.debounce(() => {
                    this.filterAgents();
                }, 300));
                
                document.getElementById('agentStatusFilter')?.addEventListener('change', () => {
                    this.filterAgents();
                });
                
                document.getElementById('customerSearch')?.addEventListener('input', Utils.debounce(() => {
                    this.filterCustomers();
                }, 300));
                
                document.getElementById('customerStatusFilter')?.addEventListener('change', () => {
                    this.filterCustomers();
                });
                
                // Online/offline detection
                window.addEventListener('online', this.updateConnectionStatus);
                window.addEventListener('offline', this.updateConnectionStatus);
            },
            
            setupResponsive() {
                const handleResize = () => {
                    if (window.innerWidth > 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                };
                
                window.addEventListener('resize', handleResize);
            },
            
            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                if (navigator.onLine) {
                    statusElement.textContent = 'Online';
                    statusElement.style.color = 'var(--macos-green)';
                } else {
                    statusElement.textContent = 'Offline';
                    statusElement.style.color = 'var(--macos-red)';
                    ToastManager.show('Connection Lost', 'You are offline. Some features may not work.', 'warning');
                }
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAdminAuth();
                    
                    if (!adminData) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Load initial data
                    await FirebaseService.loadAllData();
                    
                    // Setup real-time listeners
                    FirebaseService.setupRealtimeListeners();
                    
                    // Update UI
                    this.updateAdminInfo();
                    this.updateDashboardUI();
                    this.updateLoansUI();
                    this.updateAgentsUI();
                    this.updateCustomersUI();
                    this.updateCommissionsUI();
                    this.updateSettingsUI();
                    
                    Utils.hideLoading();
                    
                    // Show welcome
                    ToastManager.show('Welcome Admin', `Hello ${adminData.fullName || 'Admin'}!`, 'success');
                    
                } catch (error) {
                    console.error('Authentication initialization error:', error);
                    Utils.hideLoading();
                    ToastManager.show('Authentication Error', 'Failed to authenticate. Please try again.', 'error');
                }
            },
            
            updateAdminInfo() {
                if (!AppState.adminData) return;
                
                const admin = AppState.adminData;
                this.adminName.textContent = admin.fullName || 'Admin User';
                this.adminAvatar.textContent = Utils.getInitials(admin.fullName);
                
                if (admin.profilePhoto) {
                    this.adminAvatar.style.backgroundImage = `url(${admin.profilePhoto})`;
                    this.adminAvatar.style.backgroundSize = 'cover';
                    this.adminAvatar.textContent = '';
                }
                
                if (document.getElementById('adminEmail')) {
                    document.getElementById('adminEmail').value = AppState.currentUser.email;
                }
                
                if (document.getElementById('adminFullName')) {
                    document.getElementById('adminFullName').value = admin.fullName || '';
                }
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                }
                
                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    loans: 'Loan Management',
                    agents: 'Agent Management',
                    customers: 'Customer Management',
                    approvals: 'Approve Requests',
                    assignments: 'Manual Assignments',
                    commissions: 'Commission Management',
                    documents: 'Document Viewer',
                    audit: 'Audit Log',
                    settings: 'Settings'
                };
                
                this.pageTitle.textContent = titles[sectionId] || 'Admin Panel';
                
                // Load section-specific data
                switch(sectionId) {
                    case 'loans':
                        this.updateLoansUI();
                        break;
                    case 'agents':
                        this.updateAgentsUI();
                        this.updateAgentApplicationsUI();
                        break;
                    case 'customers':
                        this.updateCustomersUI();
                        break;
                    case 'approvals':
                        this.updateApprovalsUI();
                        break;
                    case 'assignments':
                        this.updateAssignmentsUI();
                        break;
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                    case 'documents':
                        this.updateDocumentsUI();
                        break;
                    case 'audit':
                        this.updateAuditLogUI();
                        break;
                    case 'settings':
                        this.updateSettingsUI();
                        break;
                }
                
                // Scroll to top
                document.getElementById('mainContent').scrollTop = 0;
            },
            
            updateDashboardUI() {
                // Calculate totals
                const totalLoans = AppState.loans.length;
                const activeAgents = AppState.agents.filter(a => a.status === 'active').length;
                const totalCustomers = AppState.customers.length;
                
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const pendingAgents = AppState.agentApplications.length;
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending').length;
                
                const totalCommission = AppState.commissions
                    .filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                // Update cards
                document.getElementById('totalLoans').textContent = totalLoans;
                document.getElementById('activeAgents').textContent = activeAgents;
                document.getElementById('totalCustomers').textContent = totalCustomers;
                document.getElementById('totalCommission').textContent = Utils.formatCurrency(totalCommission);
                
                // Update badges
                document.getElementById('pendingLoansBadge').textContent = pendingLoans;
                document.getElementById('pendingAgentsBadge').textContent = pendingAgents;
                document.getElementById('pendingApprovalsBadge').textContent = pendingLoans + pendingAgents + pendingCommissions;
                
                // Update pending approvals table
                this.updatePendingApprovalsTable();
                
                // Update recent activities
                this.updateRecentActivitiesTable();
            },
            
            updatePendingApprovalsTable() {
                const table = document.getElementById('pendingApprovalsTable');
                if (!table) return;
                
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').slice(0, 5);
                const pendingAgents = AppState.agentApplications.slice(0, 5);
                
                if (pendingLoans.length === 0 && pendingAgents.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                                No pending approvals
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                // Add pending loans
                pendingLoans.forEach(loan => {
                    html += `
                        <tr>
                            <td><i class="fas fa-file-invoice-dollar text-primary"></i> Loan</td>
                            <td>
                                <div>${loan.customerName || 'Unknown'}</div>
                                <div class="text-muted" style="font-size: 12px;">${Utils.formatCurrency(loan.amount)}</div>
                            </td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td><span class="status-badge pending">Pending</span></td>
                            <td>
                                <button class="btn btn-outline btn-small" onclick="AdminUI.viewLoanDetails('${loan.id}')">
                                    Review
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Add pending agents
                pendingAgents.forEach(app => {
                    html += `
                        <tr>
                            <td><i class="fas fa-user-tie text-success"></i> Agent</td>
                            <td>
                                <div>${app.fullName || 'Unknown'}</div>
                                <div class="text-muted" style="font-size: 12px;">${app.phone || 'No phone'}</div>
                            </td>
                            <td>${Utils.formatDateOnly(app.submittedAt)}</td>
                            <td><span class="status-badge pending">Pending</span></td>
                            <td>
                                <button class="btn btn-outline btn-small" onclick="AdminUI.reviewAgentApplication('${app.id}')">
                                    Review
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateRecentActivitiesTable() {
                const table = document.getElementById('recentActivitiesTable');
                if (!table) return;
                
                const recentLogs = AppState.auditLogs.slice(0, 10);
                
                if (recentLogs.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted" style="padding: 40px;">
                                No recent activities
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                recentLogs.forEach(log => {
                    let actionText = '';
                    let details = '';
                    
                    switch(log.action) {
                        case 'loan_status_update':
                            actionText = 'Loan Status Updated';
                            details = `Loan ${log.data.loanId}: ${log.data.oldStatus}  ${log.data.newStatus}`;
                            break;
                        case 'agent_create':
                            actionText = 'Agent Created';
                            details = `${log.data.agentName} (${log.data.agentEmail})`;
                            break;
                        case 'customer_create':
                            actionText = 'Customer Created';
                            details = log.data.customerName;
                            break;
                        case 'agent_assignment':
                            actionText = 'Agent Assigned';
                            details = `${log.data.agentName}  ${log.data.customerName}`;
                            break;
                        case 'commission_payout':
                            actionText = 'Commission Paid';
                            details = `${log.data.agentName}: ${Utils.formatCurrency(log.data.amount)}`;
                            break;
                        default:
                            actionText = log.action.replace(/_/g, ' ');
                            details = JSON.stringify(log.data).substring(0, 50) + '...';
                    }
                    
                    html += `
                        <tr>
                            <td>
                                <div>${log.userName || 'System'}</div>
                                <div class="text-muted" style="font-size: 12px;">${log.userRole}</div>
                            </td>
                            <td>${actionText}</td>
                            <td>${Utils.truncateText(details, 40)}</td>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateLoansUI() {
                const table = document.getElementById('loansTable');
                if (!table) return;
                
                if (AppState.loans.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                No loans found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                AppState.loans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id}</strong></td>
                            <td>${loan.customerName || 'Unknown'}</td>
                            <td>${loan.agentName || 'Unassigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 20)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small" onclick="AdminUI.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn btn-success btn-small" onclick="AdminUI.approveLoan('${loan.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            filterLoans() {
                const searchTerm = document.getElementById('loanSearch')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('loanStatusFilter')?.value || 'all';
                
                const rows = document.querySelectorAll('#loansTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    const customerName = row.cells[1].textContent.toLowerCase();
                    const agentName = row.cells[2].textContent.toLowerCase();
                    const purpose = row.cells[4].textContent.toLowerCase();
                    const status = row.cells[5].querySelector('.status-badge')?.textContent.toLowerCase() || '';
                    
                    let matchesSearch = !searchTerm || 
                        customerName.includes(searchTerm) || 
                        agentName.includes(searchTerm) ||
                        purpose.includes(searchTerm);
                    
                    let matchesFilter = statusFilter === 'all' || status === statusFilter;
                    
                    row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
                });
            },
            
            updateAgentsUI() {
                const table = document.getElementById('agentsTable');
                if (!table) return;
                
                if (AppState.agents.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                No agents found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                AppState.agents.forEach(agent => {
                    const statusClass = `status-${agent.status}`;
                    const statusText = agent.status.charAt(0).toUpperCase() + agent.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${agent.agentId || agent.id.substring(0, 8)}</strong></td>
                            <td>${agent.fullName || 'Unknown'}</td>
                            <td>${agent.email || 'No email'}</td>
                            <td>${agent.phone || 'No phone'}</td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${Utils.formatDateOnly(agent.createdAt)}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small" onclick="AdminUI.viewAgentDetails('${agent.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="AdminUI.toggleAgentStatus('${agent.id}', '${agent.status === 'active' ? 'suspended' : 'active'}')">
                                        <i class="fas fa-${agent.status === 'active' ? 'ban' : 'check'}"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            filterAgents() {
                const searchTerm = document.getElementById('agentSearch')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('agentStatusFilter')?.value || 'all';
                
                const rows = document.querySelectorAll('#agentsTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    const agentName = row.cells[1].textContent.toLowerCase();
                    const agentEmail = row.cells[2].textContent.toLowerCase();
                    const status = row.cells[5].querySelector('.status-badge')?.textContent.toLowerCase() || '';
                    
                    let matchesSearch = !searchTerm || 
                        agentName.includes(searchTerm) || 
                        agentEmail.includes(searchTerm);
                    
                    let matchesFilter = statusFilter === 'all' || status === statusFilter;
                    
                    row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
                });
            },
            
            updateAgentApplicationsUI() {
                const table = document.getElementById('agentApplicationsTable');
                if (!table) return;
                
                if (AppState.agentApplications.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                                No pending applications
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                AppState.agentApplications.forEach(app => {
                    html += `
                        <tr>
                            <td><strong>${app.id}</strong></td>
                            <td>${app.fullName || 'Unknown'}</td>
                            <td>${app.phone || 'No phone'}</td>
                            <td>${app.nrc || 'No NRC'}</td>
                            <td>${Utils.formatDateOnly(app.submittedAt)}</td>
                            <td>
                                <button class="btn btn-outline btn-small" onclick="AdminUI.viewApplicationDocuments('${app.id}')">
                                    <i class="fas fa-file-alt"></i> View
                                </button>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-small" onclick="AdminUI.reviewAgentApplication('${app.id}')">
                                        <i class="fas fa-check"></i> Review
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
                
                // Update counts
                document.getElementById('pendingAgentsCount').textContent = AppState.agentApplications.length;
            },
            
            updateCustomersUI() {
                const table = document.getElementById('customersTable');
                if (!table) return;
                
                if (AppState.customers.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                No customers found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                AppState.customers.forEach(customer => {
                    const statusClass = `status-${customer.status}`;
                    const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${customer.id.substring(0, 8)}</strong></td>
                            <td>${customer.fullName || 'Unknown'}</td>
                            <td>${customer.email || 'No email'}</td>
                            <td>${customer.phone || 'No phone'}</td>
                            <td>${customer.agentName || 'Unassigned'}</td>
                            <td>${customer.totalLoans || 0}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-small" onclick="AdminUI.viewCustomerDetails('${customer.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="AdminUI.toggleCustomerStatus('${customer.id}', '${customer.status === 'active' ? 'suspended' : 'active'}')">
                                        <i class="fas fa-${customer.status === 'active' ? 'ban' : 'check'}"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            filterCustomers() {
                const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('customerStatusFilter')?.value || 'all';
                
                const rows = document.querySelectorAll('#customersTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    
                    const customerName = row.cells[1].textContent.toLowerCase();
                    const customerEmail = row.cells[2].textContent.toLowerCase();
                    const agentName = row.cells[4].textContent.toLowerCase();
                    const status = row.cells[6].querySelector('.status-badge')?.textContent.toLowerCase() || '';
                    
                    let matchesSearch = !searchTerm || 
                        customerName.includes(searchTerm) || 
                        customerEmail.includes(searchTerm) ||
                        agentName.includes(searchTerm);
                    
                    let matchesFilter = statusFilter === 'all' || status === statusFilter;
                    
                    row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
                });
            },
            
            updateApprovalsUI() {
                // Update counts in cards
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const pendingAgents = AppState.agentApplications.length;
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending').length;
                
                document.getElementById('pendingLoansCount').textContent = pendingLoans;
                document.getElementById('pendingAgentsCount').textContent = pendingAgents;
                document.getElementById('pendingCommissionsCount').textContent = pendingCommissions;
            },
            
            updateAssignmentsUI() {
                // Populate customer and agent dropdowns
                const customerSelect = document.getElementById('assignCustomerSelect');
                const agentSelect = document.getElementById('assignAgentSelect');
                
                if (customerSelect) {
                    customerSelect.innerHTML = '<option value="">Choose customer...</option>';
                    AppState.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.fullName} (${customer.email})`;
                        customerSelect.appendChild(option);
                    });
                }
                
                if (agentSelect) {
                    agentSelect.innerHTML = '<option value="">Choose agent...</option>';
                    AppState.agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.fullName} (${agent.agentId || agent.id.substring(0, 8)})`;
                        agentSelect.appendChild(option);
                    });
                }
                
                // Update recent assignments table
                this.updateRecentAssignmentsTable();
            },
            
            updateRecentAssignmentsTable() {
                const table = document.getElementById('recentAssignmentsTable');
                if (!table) return;
                
                // Get recent assignments from audit logs
                const assignments = AppState.auditLogs
                    .filter(log => log.action === 'agent_assignment')
                    .slice(0, 10);
                
                if (assignments.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">No assignments yet</td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                assignments.forEach(log => {
                    html += `
                        <tr>
                            <td>${log.data.customerName}</td>
                            <td>${log.data.agentName}</td>
                            <td>${log.userName}</td>
                            <td>${Utils.formatDateOnly(log.timestamp)}</td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            async assignAgentToCustomer() {
                const customerId = document.getElementById('assignCustomerSelect').value;
                const agentId = document.getElementById('assignAgentSelect').value;
                
                if (!customerId || !agentId) {
                    ToastManager.show('Error', 'Please select both customer and agent', 'error');
                    return;
                }
                
                const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    document.getElementById('assignCustomerSelect').value = '';
                    document.getElementById('assignAgentSelect').value = '';
                    this.updateRecentAssignmentsTable();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            updateCommissionsUI() {
                // Pending commissions table
                const pendingTable = document.getElementById('pendingCommissionsTable');
                const historyTable = document.getElementById('commissionHistoryTable');
                
                if (pendingTable) {
                    const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                    
                    if (pendingCommissions.length === 0) {
                        pendingTable.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                    No pending commissions
                                </td>
                            </tr>
                        `;
                    } else {
                        let html = '';
                        
                        pendingCommissions.forEach(commission => {
                            html += `
                                <tr>
                                    <td><strong>${commission.id}</strong></td>
                                    <td>${commission.agentName || 'Unknown'}</td>
                                    <td>${commission.customerName || 'Unknown'}</td>
                                    <td>${commission.loanId || 'N/A'}</td>
                                    <td>${Utils.formatCurrency(commission.amount)}</td>
                                    <td>${commission.type || 'loan_approval'}</td>
                                    <td>${Utils.formatDateOnly(commission.createdAt)}</td>
                                    <td>
                                        <button class="btn btn-success btn-small" onclick="AdminUI.payCommission('${commission.id}')">
                                            <i class="fas fa-money-bill-wave"></i> Pay
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        pendingTable.innerHTML = html;
                    }
                }
                
                if (historyTable) {
                    const paidCommissions = AppState.commissions
                        .filter(c => c.status === 'paid')
                        .slice(0, 20);
                    
                    if (paidCommissions.length === 0) {
                        historyTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted" style="padding: 40px;">
                                    No commission history
                                </td>
                            </tr>
                        `;
                    } else {
                        let html = '';
                        
                        paidCommissions.forEach(commission => {
                            html += `
                                <tr>
                                    <td>${Utils.formatDateOnly(commission.paidAt)}</td>
                                    <td>${commission.agentName || 'Unknown'}</td>
                                    <td>${Utils.formatCurrency(commission.amount)}</td>
                                    <td>${commission.loanId || 'N/A'}</td>
                                    <td>${commission.paymentMethod || 'Bank Transfer'}</td>
                                    <td>${commission.paymentReference || 'N/A'}</td>
                                </tr>
                            `;
                        });
                        
                        historyTable.innerHTML = html;
                    }
                }
            },
            
            async payCommission(commissionId) {
                const commission = AppState.commissions.find(c => c.id === commissionId);
                if (!commission) return;
                
                const paymentMethod = prompt('Enter payment method (e.g., Bank Transfer, Mobile Money):', 'Bank Transfer');
                if (!paymentMethod) return;
                
                const reference = prompt('Enter payment reference/transaction ID:');
                if (!reference) {
                    ToastManager.show('Error', 'Payment reference is required', 'error');
                    return;
                }
                
                const result = await FirebaseService.processCommissionPayout(commissionId, paymentMethod, reference);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.updateCommissionsUI();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async processCommissionPayouts() {
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                
                if (pendingCommissions.length === 0) {
                    ToastManager.show('Info', 'No pending commissions to process', 'info');
                    return;
                }
                
                if (!confirm(`Process ${pendingCommissions.length} commission payouts?`)) {
                    return;
                }
                
                Utils.showLoading('Processing commission payouts...');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const commission of pendingCommissions) {
                    try {
                        await FirebaseService.processCommissionPayout(
                            commission.id,
                            'Bank Transfer',
                            `BATCH-${Date.now()}`
                        );
                        successCount++;
                        await Utils.sleep(100); // Small delay to avoid overwhelming Firebase
                    } catch (error) {
                        console.error('Error processing commission:', error);
                        errorCount++;
                    }
                }
                
                Utils.hideLoading();
                
                ToastManager.show(
                    'Payouts Processed',
                    `Successfully processed ${successCount} commissions. ${errorCount} failed.`,
                    successCount > 0 ? 'success' : 'error'
                );
                
                this.updateCommissionsUI();
            },
            
            updateDocumentsUI() {
                // This would be implemented to show all documents
                // For now, show a message
                const container = document.getElementById('documentsContainer');
                container.innerHTML = `
                    <div class="text-center text-muted" style="padding: 60px;">
                        <i class="fas fa-file-alt fa-3x mb-4"></i>
                        <h4>Document Viewer</h4>
                        <p class="mb-4">Use the View buttons in loan, agent, and customer details to see uploaded documents</p>
                        <div class="d-flex justify-center gap-3">
                            <button class="btn btn-outline" onclick="AdminUI.showSection('loans')">
                                <i class="fas fa-file-invoice-dollar"></i> View Loan Documents
                            </button>
                            <button class="btn btn-outline" onclick="AdminUI.showSection('agents')">
                                <i class="fas fa-user-tie"></i> View Agent Documents
                            </button>
                        </div>
                    </div>
                `;
            },
            
            updateAuditLogUI() {
                const table = document.getElementById('auditLogTable');
                if (!table) return;
                
                if (AppState.auditLogs.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                                No audit logs found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                AppState.auditLogs.forEach(log => {
                    let actionText = '';
                    
                    switch(log.action) {
                        case 'loan_status_update':
                            actionText = 'Loan Status Update';
                            break;
                        case 'agent_create':
                            actionText = 'Agent Created';
                            break;
                        case 'customer_create':
                            actionText = 'Customer Created';
                            break;
                        case 'agent_assignment':
                            actionText = 'Agent Assignment';
                            break;
                        case 'commission_payout':
                            actionText = 'Commission Payout';
                            break;
                        case 'password_change':
                            actionText = 'Password Change';
                            break;
                        case 'settings_update':
                            actionText = 'Settings Update';
                            break;
                        default:
                            actionText = log.action.replace(/_/g, ' ');
                    }
                    
                    html += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>
                                <div>${log.userName || 'System'}</div>
                                <div class="text-muted" style="font-size: 12px;">${log.userEmail || ''}</div>
                            </td>
                            <td>${actionText}</td>
                            <td>${Utils.truncateText(JSON.stringify(log.data), 60)}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateSettingsUI() {
                if (!AppState.systemSettings) return;
                
                const settings = AppState.systemSettings;
                
                if (document.getElementById('maxLoanAmount')) {
                    document.getElementById('maxLoanAmount').value = settings.maxLoanAmount || 50000;
                }
                
                if (document.getElementById('interestRate')) {
                    document.getElementById('interestRate').value = settings.interestRate || 15;
                }
                
                if (document.getElementById('commissionRate')) {
                    document.getElementById('commissionRate').value = settings.commissionRate || 2.5;
                }
            },
            
            async saveSystemSettings() {
                const maxLoanAmount = parseFloat(document.getElementById('maxLoanAmount').value) || 50000;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 15;
                const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 2.5;
                
                const settings = {
                    maxLoanAmount: maxLoanAmount,
                    interestRate: interestRate,
                    commissionRate: commissionRate,
                    updatedAt: Date.now(),
                    updatedBy: AppState.currentUser.uid
                };
                
                const result = await FirebaseService.updateSystemSettings(settings);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async changeAdminPassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    ToastManager.show('Error', 'Please fill all fields', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    ToastManager.show('Error', 'New password must be at least 6 characters', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    ToastManager.show('Error', 'Passwords do not match', 'error');
                    return;
                }
                
                const result = await FirebaseService.changeAdminPassword(currentPassword, newPassword);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('changePasswordModal');
                    
                    // Clear fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            // ===== MODAL MANAGEMENT =====
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            },
            
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            },
            
            populateAgentForm() {
                // Clear form
                document.getElementById('agentFullName').value = '';
                document.getElementById('agentPhone').value = '';
                document.getElementById('agentNRC').value = '';
                document.getElementById('agentAddress').value = '';
                document.getElementById('agentEmail').value = '';
                document.getElementById('agentCustomId').value = '';
                document.getElementById('agentPassword').value = '';
                document.getElementById('agentBranch').value = '';
                document.getElementById('agentNotes').value = '';
            },
            
            populateCustomerForm() {
                const agentSelect = document.getElementById('customerAgentSelect');
                if (agentSelect) {
                    agentSelect.innerHTML = '<option value="">Select agent...</option>';
                    AppState.agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.fullName} (${agent.agentId || agent.id.substring(0, 8)})`;
                        agentSelect.appendChild(option);
                    });
                }
            },
            
            async submitAgentForm() {
                const agentData = {
                    fullName: document.getElementById('agentFullName').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    nrc: document.getElementById('agentNRC').value.trim(),
                    address: document.getElementById('agentAddress').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    agentId: document.getElementById('agentCustomId').value.trim(),
                    password: document.getElementById('agentPassword').value,
                    branch: document.getElementById('agentBranch').value.trim(),
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validation
                if (!agentData.fullName || !agentData.phone || !agentData.nrc || !agentData.address || 
                    !agentData.email || !agentData.agentId || !agentData.password) {
                    ToastManager.show('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(agentData.email)) {
                    ToastManager.show('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                if (!Utils.validateNRC(agentData.nrc)) {
                    ToastManager.show('Error', 'Please enter a valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                if (agentData.password.length < 6) {
                    ToastManager.show('Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                const result = await FirebaseService.createAgent(agentData);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('createAgentModal');
                    
                    // Send credentials (in real app, this would be sent via email)
                    const credentials = `
                        Agent ID: ${agentData.agentId}
                        Email: ${agentData.email}
                        Password: ${agentData.password}
                        
                        Please change your password after first login.
                    `;
                    
                    console.log('Agent credentials:', credentials);
                    
                    // Show credentials to admin
                    alert(`Agent created successfully!\n\nCredentials:\n\n${credentials}\n\nPlease provide these credentials to the agent.`);
                    
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async submitCustomerForm() {
                const customerData = {
                    fullName: document.getElementById('customerFullName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    nrc: document.getElementById('customerNRC').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    houseNumber: document.getElementById('customerHouseNumber').value.trim(),
                    occupation: document.getElementById('customerOccupation').value.trim(),
                    income: parseFloat(document.getElementById('customerIncome').value) || 0,
                    password: document.getElementById('customerPassword').value,
                    agentId: document.getElementById('customerAgentSelect').value || '',
                    status: document.getElementById('customerStatus').value
                };
                
                // Validation
                if (!customerData.fullName || !customerData.email || !customerData.phone || 
                    !customerData.nrc || !customerData.address || !customerData.password) {
                    ToastManager.show('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(customerData.email)) {
                    ToastManager.show('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                if (!Utils.validateNRC(customerData.nrc)) {
                    ToastManager.show('Error', 'Please enter a valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                if (customerData.password.length < 6) {
                    ToastManager.show('Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                const result = await FirebaseService.createCustomer(customerData);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('createCustomerModal');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            // ===== DETAIL VIEWERS =====
            async viewLoanDetails(loanId) {
                const loan = AppState.loans.find(l => l.id === loanId);
                if (!loan) {
                    ToastManager.show('Error', 'Loan not found', 'error');
                    return;
                }
                
                AppState.selectedLoan = loan;
                
                // Get customer details
                const customer = AppState.customers.find(c => c.id === loan.customerId) || {};
                const agent = AppState.agents.find(a => a.id === loan.agentId) || {};
                
                let documentsHTML = '';
                if (loan.documents) {
                    documentsHTML = `
                        <div class="mb-6">
                            <h4 style="margin-bottom: 16px;">Loan Documents</h4>
                            <div class="document-grid">
                                ${loan.documents.collateralImages ? loan.documents.collateralImages.map((img, index) => `
                                    <div class="document-card">
                                        <div class="document-preview">
                                            <img src="${img}" alt="Collateral ${index + 1}" onclick="AdminUI.viewDocument('${img}', 'Collateral Image ${index + 1}')" style="cursor: pointer;">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">Collateral Image ${index + 1}</div>
                                            <div class="document-type">Image</div>
                                        </div>
                                    </div>
                                `).join('') : ''}
                                
                                ${loan.documents.otherDocuments ? loan.documents.otherDocuments.map((doc, index) => `
                                    <div class="document-card">
                                        <div class="document-preview" style="background: var(--macos-gray-0);">
                                            <i class="fas fa-file-pdf fa-3x" style="color: var(--macos-red);"></i>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">Document ${index + 1}</div>
                                            <div class="document-type">PDF</div>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    `;
                }
                
                const content = document.getElementById('loanDetailsContent');
                content.innerHTML = `
                    <div class="mb-6">
                        <div class="d-flex justify-between align-center mb-4">
                            <h3>Loan ${loan.id}</h3>
                            <span class="status-badge status-${loan.status}">${loan.status}</span>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${customer.fullName || loan.customerName} (${customer.phone || 'N/A'})
                                    <button class="btn btn-outline btn-small ml-2" onclick="AdminUI.viewCustomerDetails('${loan.customerId}')">
                                        View Profile
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${agent.fullName || loan.agentName || 'Unassigned'}
                                    ${agent.id ? `<button class="btn btn-outline btn-small ml-2" onclick="AdminUI.viewAgentDetails('${agent.id}')">
                                        View Profile
                                    </button>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Loan Amount</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${Utils.formatCurrency(loan.amount)}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Approved Amount</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${Utils.formatCurrency(loan.approvedAmount || loan.amount)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Duration</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${loan.duration} months
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Interest Rate</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${loan.interestRate || 15}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label class="form-label">Purpose</label>
                            <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2); min-height: 80px;">
                                ${loan.purpose || 'Not specified'}
                            </div>
                        </div>
                        
                        <div class="form-group mb-6">
                            <label class="form-label">Description</label>
                            <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2); min-height: 100px;">
                                ${loan.purposeDescription || 'No description provided'}
                            </div>
                        </div>
                        
                        ${documentsHTML}
                        
                        <div class="mb-4">
                            <h4 style="margin-bottom: 16px;">Timeline</h4>
                            <div style="border-left: 2px solid var(--macos-gray-2); padding-left: 20px; margin-left: 10px;">
                                <div style="margin-bottom: 16px; position: relative;">
                                    <div style="position: absolute; left: -26px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: var(--macos-blue);"></div>
                                    <div style="font-weight: 600;">Application Submitted</div>
                                    <div style="font-size: 13px; color: var(--macos-gray-5);">${Utils.formatDate(loan.createdAt)}</div>
                                </div>
                                
                                ${loan.approvedAt ? `
                                    <div style="margin-bottom: 16px; position: relative;">
                                        <div style="position: absolute; left: -26px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: var(--macos-green);"></div>
                                        <div style="font-weight: 600;">Approved</div>
                                        <div style="font-size: 13px; color: var(--macos-gray-5);">${Utils.formatDate(loan.approvedAt)} by ${loan.approvedBy || 'Admin'}</div>
                                    </div>
                                ` : ''}
                                
                                ${loan.rejectedAt ? `
                                    <div style="margin-bottom: 16px; position: relative;">
                                        <div style="position: absolute; left: -26px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: var(--macos-red);"></div>
                                        <div style="font-weight: 600;">Rejected</div>
                                        <div style="font-size: 13px; color: var(--macos-gray-5);">${Utils.formatDate(loan.rejectedAt)} by ${loan.rejectedBy || 'Admin'}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="AdminUI.closeModal('loanDetailsModal')">Close</button>
                        ${loan.status === 'pending' ? `
                            <button class="btn btn-danger" onclick="AdminUI.rejectLoan('${loan.id}')">Reject</button>
                            <button class="btn btn-success" onclick="AdminUI.showApproveLoanModal('${loan.id}')">Approve</button>
                        ` : ''}
                    </div>
                `;
                
                this.showModal('loanDetailsModal');
            },
            
            async viewAgentDetails(agentId) {
                const agent = AppState.agents.find(a => a.id === agentId);
                if (!agent) {
                    ToastManager.show('Error', 'Agent not found', 'error');
                    return;
                }
                
                AppState.selectedAgent = agent;
                
                // Get agent's customers
                const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agentId);
                const agentLoans = AppState.loans.filter(l => l.agentId === agentId);
                
                const content = document.getElementById('agentDetailsContent');
                content.innerHTML = `
                    <div class="mb-6">
                        <div class="d-flex align-center gap-4 mb-6">
                            <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));">
                                ${agent.profilePhoto ? `
                                    <img src="${agent.profilePhoto}" alt="${agent.fullName}" style="width: 100%; height: 100%; object-fit: cover;">
                                ` : `
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 600;">
                                        ${Utils.getInitials(agent.fullName)}
                                    </div>
                                `}
                            </div>
                            <div>
                                <h3>${agent.fullName}</h3>
                                <div class="d-flex gap-3 mt-2">
                                    <span class="status-badge status-${agent.status}">${agent.status}</span>
                                    <span style="background: var(--macos-gray-0); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                                        ID: ${agent.agentId || agent.id.substring(0, 8)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-grid mb-6">
                            <div class="card">
                                <div class="card-title">Total Customers</div>
                                <div class="card-value">${agent.totalCustomers || agentCustomers.length}</div>
                            </div>
                            <div class="card">
                                <div class="card-title">Total Loans</div>
                                <div class="card-value">${agent.totalLoans || agentLoans.length}</div>
                            </div>
                            <div class="card">
                                <div class="card-title">Total Commission</div>
                                <div class="card-value">${Utils.formatCurrency(agent.totalCommission || 0)}</div>
                            </div>
                            <div class="card">
                                <div class="card-title">Active Since</div>
                                <div class="card-value" style="font-size: 18px;">${Utils.formatDateOnly(agent.createdAt)}</div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${agent.email || 'N/A'}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${agent.phone || 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">NRC Number</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${agent.nrc || 'N/A'}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Branch/Region</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${agent.branch || 'Not specified'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-6">
                            <label class="form-label">Residential Address</label>
                            <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                ${agent.residence || 'N/A'}
                            </div>
                        </div>
                        
                        ${agent.nrcFront || agent.nrcBack || agent.profilePhoto ? `
                            <div class="mb-6">
                                <h4 style="margin-bottom: 16px;">Agent Documents</h4>
                                <div class="document-grid">
                                    ${agent.profilePhoto ? `
                                        <div class="document-card">
                                            <div class="document-preview">
                                                <img src="${agent.profilePhoto}" alt="Profile Photo" onclick="AdminUI.viewDocument('${agent.profilePhoto}', 'Profile Photo')" style="cursor: pointer;">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">Profile Photo</div>
                                                <div class="document-type">Image</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${agent.nrcFront ? `
                                        <div class="document-card">
                                            <div class="document-preview">
                                                <img src="${agent.nrcFront}" alt="NRC Front" onclick="AdminUI.viewDocument('${agent.nrcFront}', 'NRC Front')" style="cursor: pointer;">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">NRC Front</div>
                                                <div class="document-type">Image</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${agent.nrcBack ? `
                                        <div class="document-card">
                                            <div class="document-preview">
                                                <img src="${agent.nrcBack}" alt="NRC Back" onclick="AdminUI.viewDocument('${agent.nrcBack}', 'NRC Back')" style="cursor: pointer;">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">NRC Back</div>
                                                <div class="document-type">Image</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${agent.notes ? `
                            <div class="form-group mb-6">
                                <label class="form-label">Notes</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2); min-height: 80px;">
                                    ${agent.notes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="AdminUI.closeModal('agentDetailsModal')">Close</button>
                        <button class="btn btn-danger" onclick="AdminUI.toggleAgentStatus('${agent.id}', '${agent.status === 'active' ? 'suspended' : 'active'}')">
                            ${agent.status === 'active' ? 'Suspend Agent' : 'Activate Agent'}
                        </button>
                    </div>
                `;
                
                this.showModal('agentDetailsModal');
            },
            
            async viewCustomerDetails(customerId) {
                const customer = AppState.customers.find(c => c.id === customerId);
                if (!customer) {
                    ToastManager.show('Error', 'Customer not found', 'error');
                    return;
                }
                
                AppState.selectedCustomer = customer;
                
                // Get customer's loans
                const customerLoans = AppState.loans.filter(l => l.customerId === customerId);
                const assignedAgent = customer.assignedAgentId ? AppState.agents.find(a => a.id === customer.assignedAgentId) : null;
                
                const content = document.getElementById('customerDetailsContent');
                content.innerHTML = `
                    <div class="mb-6">
                        <div class="d-flex align-center gap-4 mb-6">
                            <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));">
                                ${customer.profilePhoto ? `
                                    <img src="${customer.profilePhoto}" alt="${customer.fullName}" style="width: 100%; height: 100%; object-fit: cover;">
                                ` : `
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 600;">
                                        ${Utils.getInitials(customer.fullName)}
                                    </div>
                                `}
                            </div>
                            <div>
                                <h3>${customer.fullName}</h3>
                                <div class="d-flex gap-3 mt-2">
                                    <span class="status-badge status-${customer.status}">${customer.status}</span>
                                    <span style="background: var(--macos-gray-0); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                                        ID: ${customer.id.substring(0, 8)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-grid mb-6">
                            <div class="card">
                                <div class="card-title">Total Loans</div>
                                <div class="card-value">${customer.totalLoans || customerLoans.length}</div>
                            </div>
                            <div class="card">
                                <div class="card-title">Active Loans</div>
                                <div class="card-value">${customer.activeLoans || customerLoans.filter(l => l.status === 'active').length}</div>
                            </div>
                            <div class="card">
                                <div class="card-title">Account Balance</div>
                                <div class="card-value">${Utils.formatCurrency(customer.accountBalance || 0)}</div>
                            </div>
                            <div class="card">
                                <div class="card-title">Member Since</div>
                                <div class="card-value" style="font-size: 18px;">${Utils.formatDateOnly(customer.createdAt)}</div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${customer.email || 'N/A'}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${customer.phone || 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">NRC Number</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${customer.nrc || 'N/A'}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Monthly Income</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${Utils.formatCurrency(customer.monthlyIncome || 0)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Occupation</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${customer.occupation || 'Not specified'}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">House Number</label>
                                <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                    ${customer.houseNumber || 'Not specified'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-6">
                            <label class="form-label">Residential Address</label>
                            <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                ${customer.residence || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="form-group mb-6">
                            <label class="form-label">Assigned Agent</label>
                            <div class="form-input" style="background: white; border: 1px solid var(--macos-gray-2);">
                                ${assignedAgent ? `
                                    ${assignedAgent.fullName} (${assignedAgent.agentId || assignedAgent.id.substring(0, 8)})
                                    <button class="btn btn-outline btn-small ml-2" onclick="AdminUI.viewAgentDetails('${assignedAgent.id}')">
                                        View Agent
                                    </button>
                                ` : 'No agent assigned'}
                            </div>
                        </div>
                        
                        ${customer.nrcFront || customer.nrcBack ? `
                            <div class="mb-6">
                                <h4 style="margin-bottom: 16px;">Customer Documents</h4>
                                <div class="document-grid">
                                    ${customer.nrcFront ? `
                                        <div class="document-card">
                                            <div class="document-preview">
                                                <img src="${customer.nrcFront}" alt="NRC Front" onclick="AdminUI.viewDocument('${customer.nrcFront}', 'NRC Front')" style="cursor: pointer;">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">NRC Front</div>
                                                <div class="document-type">Image</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.nrcBack ? `
                                        <div class="document-card">
                                            <div class="document-preview">
                                                <img src="${customer.nrcBack}" alt="NRC Back" onclick="AdminUI.viewDocument('${customer.nrcBack}', 'NRC Back')" style="cursor: pointer;">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">NRC Back</div>
                                                <div class="document-type">Image</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.profilePhoto ? `
                                        <div class="document-card">
                                            <div class="document-preview">
                                                <img src="${customer.profilePhoto}" alt="Profile Photo" onclick="AdminUI.viewDocument('${customer.profilePhoto}', 'Profile Photo')" style="cursor: pointer;">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">Profile Photo</div>
                                                <div class="document-type">Image</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${customerLoans.length > 0 ? `
                            <div class="mb-6">
                                <h4 style="margin-bottom: 16px;">Customer Loans (${customerLoans.length})</h4>
                                <div style="background: var(--macos-gray-0); padding: 16px; border-radius: var(--macos-radius-sm);">
                                    <table style="width: 100%;">
                                        <thead>
                                            <tr>
                                                <th style="text-align: left; padding: 8px; font-size: 13px;">Loan ID</th>
                                                <th style="text-align: left; padding: 8px; font-size: 13px;">Amount</th>
                                                <th style="text-align: left; padding: 8px; font-size: 13px;">Status</th>
                                                <th style="text-align: left; padding: 8px; font-size: 13px;">Applied</th>
                                                <th style="text-align: left; padding: 8px; font-size: 13px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${customerLoans.slice(0, 5).map(loan => `
                                                <tr>
                                                    <td style="padding: 8px; font-size: 13px;">${loan.id}</td>
                                                    <td style="padding: 8px; font-size: 13px;">${Utils.formatCurrency(loan.amount)}</td>
                                                    <td style="padding: 8px; font-size: 13px;"><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                                                    <td style="padding: 8px; font-size: 13px;">${Utils.formatDateOnly(loan.createdAt)}</td>
                                                    <td style="padding: 8px; font-size: 13px;">
                                                        <button class="btn btn-outline btn-small" onclick="AdminUI.viewLoanDetails('${loan.id}')">
                                                            View
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="AdminUI.closeModal('customerDetailsModal')">Close</button>
                        <button class="btn btn-danger" onclick="AdminUI.toggleCustomerStatus('${customer.id}', '${customer.status === 'active' ? 'suspended' : 'active'}')">
                            ${customer.status === 'active' ? 'Suspend Customer' : 'Activate Customer'}
                        </button>
                        ${!customer.assignedAgentId ? `
                            <button class="btn btn-primary" onclick="AdminUI.assignAgentToCustomerFromDetails('${customer.id}')">
                                Assign Agent
                            </button>
                        ` : ''}
                    </div>
                `;
                
                this.showModal('customerDetailsModal');
            },
            
            viewDocument(url, title = 'Document') {
                const content = document.getElementById('documentViewerContent');
                content.innerHTML = `
                    <div class="text-center">
                        <h4 style="margin-bottom: 20px;">${title}</h4>
                        <div style="background: var(--macos-gray-0); padding: 20px; border-radius: var(--macos-radius-sm);">
                            <img src="${url}" alt="${title}" style="max-width: 100%; max-height: 500px; border-radius: var(--macos-radius-sm);">
                        </div>
                        <div class="mt-4">
                            <a href="${url}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> Open in New Tab
                            </a>
                            <button class="btn btn-outline" onclick="AdminUI.closeModal('documentViewerModal')">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                this.showModal('documentViewerModal');
            },
            
            async viewApplicationDocuments(applicationId) {
                const application = AppState.agentApplications.find(a => a.id === applicationId);
                if (!application) {
                    ToastManager.show('Error', 'Application not found', 'error');
                    return;
                }
                
                const content = document.getElementById('documentViewerContent');
                content.innerHTML = `
                    <div>
                        <h4 style="margin-bottom: 20px;">Application Documents - ${application.fullName}</h4>
                        
                        <div class="document-grid">
                            ${application.profilePhoto ? `
                                <div class="document-card">
                                    <div class="document-preview">
                                        <img src="${application.profilePhoto}" alt="Profile Photo" onclick="AdminUI.viewDocument('${application.profilePhoto}', 'Profile Photo')" style="cursor: pointer;">
                                    </div>
                                    <div class="document-info">
                                        <div class="document-title">Profile Photo</div>
                                        <div class="document-type">Image</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${application.nrcFront ? `
                                <div class="document-card">
                                    <div class="document-preview">
                                        <img src="${application.nrcFront}" alt="NRC Front" onclick="AdminUI.viewDocument('${application.nrcFront}', 'NRC Front')" style="cursor: pointer;">
                                    </div>
                                    <div class="document-info">
                                        <div class="document-title">NRC Front</div>
                                        <div class="document-type">Image</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${application.nrcBack ? `
                                <div class="document-card">
                                    <div class="document-preview">
                                        <img src="${application.nrcBack}" alt="NRC Back" onclick="AdminUI.viewDocument('${application.nrcBack}', 'NRC Back')" style="cursor: pointer;">
                                    </div>
                                    <div class="document-info">
                                        <div class="document-title">NRC Back</div>
                                        <div class="document-type">Image</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${application.additionalDoc ? `
                                <div class="document-card">
                                    <div class="document-preview" style="background: var(--macos-gray-0);">
                                        <i class="fas fa-file-pdf fa-3x" style="color: var(--macos-red);"></i>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-title">Additional Document</div>
                                        <div class="document-type">PDF</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-6">
                            <h5 style="margin-bottom: 12px;">Application Details</h5>
                            <div style="background: var(--macos-gray-0); padding: 16px; border-radius: var(--macos-radius-sm);">
                                <div><strong>Name:</strong> ${application.fullName}</div>
                                <div><strong>Phone:</strong> ${application.phone}</div>
                                <div><strong>NRC:</strong> ${application.nrc}</div>
                                <div><strong>Address:</strong> ${application.residence}</div>
                                <div><strong>Applied:</strong> ${Utils.formatDate(application.submittedAt)}</div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="AdminUI.closeModal('documentViewerModal')">Close</button>
                            <button class="btn btn-primary" onclick="AdminUI.reviewAgentApplication('${applicationId}')">
                                Review Application
                            </button>
                        </div>
                    </div>
                `;
                
                this.showModal('documentViewerModal');
            },
            
            // ===== ACTION FUNCTIONS =====
            async approveLoan(loanId) {
                const loan = AppState.loans.find(l => l.id === loanId);
                if (!loan) return;
                
                AppState.selectedLoan = loan;
                
                const content = document.getElementById('approveLoanContent');
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Approve Loan Application</h4>
                        <div style="background: var(--macos-gray-0); padding: 16px; border-radius: var(--macos-radius-sm); margin-top: 12px;">
                            <div><strong>Loan ID:</strong> ${loan.id}</div>
                            <div><strong>Customer:</strong> ${loan.customerName}</div>
                            <div><strong>Amount Requested:</strong> ${Utils.formatCurrency(loan.amount)}</div>
                            <div><strong>Purpose:</strong> ${loan.purpose || 'Not specified'}</div>
                        </div>
                    </div>
                `;
                
                if (document.getElementById('approvedAmount')) {
                    document.getElementById('approvedAmount').value = loan.amount;
                }
                
                this.showModal('approveLoanModal');
            },
            
            showApproveLoanModal(loanId) {
                this.approveLoan(loanId);
            },
            
            async submitLoanApproval() {
                const loanId = AppState.selectedLoan?.id;
                if (!loanId) return;
                
                const notes = document.getElementById('loanApprovalNotes')?.value || '';
                const approvedAmount = parseFloat(document.getElementById('approvedAmount')?.value) || AppState.selectedLoan.amount;
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'approved', approvedAmount, notes);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('approveLoanModal');
                    this.closeModal('loanDetailsModal');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async rejectLoan(loanId) {
                const loan = AppState.loans.find(l => l.id === loanId);
                if (!loan) return;
                
                const reason = prompt('Enter rejection reason:', 'Application does not meet requirements');
                if (!reason) return;
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'rejected', null, reason);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('loanDetailsModal');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async toggleAgentStatus(agentId, newStatus) {
                const agent = AppState.agents.find(a => a.id === agentId);
                if (!agent) return;
                
                const action = newStatus === 'suspended' ? 'suspend' : 'activate';
                const confirmMessage = `Are you sure you want to ${action} this agent?`;
                
                if (!confirm(confirmMessage)) return;
                
                const result = await FirebaseService.updateUserStatus(agentId, newStatus, 'agent');
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('agentDetailsModal');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async toggleCustomerStatus(customerId, newStatus) {
                const customer = AppState.customers.find(c => c.id === customerId);
                if (!customer) return;
                
                const action = newStatus === 'suspended' ? 'suspend' : 'activate';
                const confirmMessage = `Are you sure you want to ${action} this customer?`;
                
                if (!confirm(confirmMessage)) return;
                
                const result = await FirebaseService.updateUserStatus(customerId, newStatus, 'customer');
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('customerDetailsModal');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async assignAgentToCustomerFromDetails(customerId) {
                this.closeModal('customerDetailsModal');
                
                // Populate the assignment dropdowns
                const customerSelect = document.getElementById('assignCustomerSelect');
                const agentSelect = document.getElementById('assignAgentSelect');
                
                if (customerSelect) {
                    customerSelect.value = customerId;
                }
                
                // Show assignments section
                this.showSection('assignments');
                
                ToastManager.show('Info', 'Please select an agent to assign', 'info');
            },
            
            async reviewAgentApplication(applicationId) {
                const application = AppState.agentApplications.find(a => a.id === applicationId);
                if (!application) {
                    ToastManager.show('Error', 'Application not found', 'error');
                    return;
                }
                
                AppState.selectedApplication = application;
                
                const content = document.getElementById('agentAppContent');
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Review Agent Application</h4>
                        <div style="background: var(--macos-gray-0); padding: 16px; border-radius: var(--macos-radius-sm); margin-top: 12px;">
                            <div><strong>Application ID:</strong> ${application.id}</div>
                            <div><strong>Name:</strong> ${application.fullName}</div>
                            <div><strong>Phone:</strong> ${application.phone}</div>
                            <div><strong>NRC:</strong> ${application.nrc}</div>
                            <div><strong>Address:</strong> ${application.residence}</div>
                            <div><strong>Applied:</strong> ${Utils.formatDate(application.submittedAt)}</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Agent Email (MANUALLY ASSIGN) *</label>
                        <input type="email" class="form-input" id="appAgentEmail" placeholder="agent@trucash.com" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Agent ID (MANUALLY ASSIGN) *</label>
                            <input type="text" class="form-input" id="appAgentId" placeholder="AGENT123" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password (MANUALLY ASSIGN) *</label>
                            <input type="password" class="form-input" id="appAgentPassword" placeholder="Create password" required>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 204, 0, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
                        <div style="font-size: 13px; color: var(--macos-orange);">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>Important:</strong> You must manually assign the Agent ID, Email, and Password. These will be sent to the applicant.
                        </div>
                    </div>
                `;
                
                this.showModal('approveAgentAppModal');
            },
            
            async submitAgentApplicationApproval() {
                const applicationId = AppState.selectedApplication?.id;
                if (!applicationId) return;
                
                const email = document.getElementById('appAgentEmail')?.value.trim();
                const agentId = document.getElementById('appAgentId')?.value.trim();
                const password = document.getElementById('appAgentPassword')?.value;
                
                if (!email || !agentId || !password) {
                    ToastManager.show('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(email)) {
                    ToastManager.show('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    ToastManager.show('Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                const credentials = {
                    email: email,
                    agentId: agentId,
                    password: password
                };
                
                const result = await FirebaseService.approveAgentApplication(applicationId, credentials);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('approveAgentAppModal');
                    
                    // Show credentials to admin
                    const credentialsDisplay = `
                        Agent ID: ${agentId}
                        Email: ${email}
                        Password: ${password}
                        
                        Please provide these credentials to the agent.
                    `;
                    
                    alert(`Agent application approved!\n\nCredentials:\n\n${credentialsDisplay}`);
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async rejectAgentApplication() {
                const applicationId = AppState.selectedApplication?.id;
                if (!applicationId) return;
                
                const reason = prompt('Enter rejection reason:', 'Application does not meet requirements');
                if (!reason) return;
                
                const result = await FirebaseService.rejectAgentApplication(applicationId, reason);
                
                if (result.success) {
                    ToastManager.show('Success', result.message, 'success');
                    this.closeModal('approveAgentAppModal');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            }
        };

        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            AdminUI.init();
            
            // Set up online/offline detection
            AdminUI.updateConnectionStatus();
        });

        // ===== GLOBAL FUNCTIONS FOR EVENT HANDLERS =====
        window.AdminUI = AdminUI;
        window.FirebaseService = FirebaseService;
        window.Utils = Utils;
        window.ToastManager = ToastManager;

        // Bind approve/reject buttons
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const approveLoanBtn = document.getElementById('approveLoanBtn');
                const rejectLoanBtn = document.getElementById('rejectLoanBtn');
                const approveAgentAppBtn = document.getElementById('approveAgentAppBtn');
                const rejectAgentAppBtn = document.getElementById('rejectAgentAppBtn');
                
                if (approveLoanBtn) {
                    approveLoanBtn.addEventListener('click', () => AdminUI.submitLoanApproval());
                }
                
                if (rejectLoanBtn) {
                    rejectLoanBtn.addEventListener('click', () => {
                        if (AppState.selectedLoan) {
                            AdminUI.rejectLoan(AppState.selectedLoan.id);
                        }
                    });
                }
                
                if (approveAgentAppBtn) {
                    approveAgentAppBtn.addEventListener('click', () => AdminUI.submitAgentApplicationApproval());
                }
                
                if (rejectAgentAppBtn) {
                    rejectAgentAppBtn.addEventListener('click', () => AdminUI.rejectAgentApplication());
                }
            }, 1000);
        });
    </script>
</body>
</html>
