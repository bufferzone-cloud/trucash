<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TruCash</title>
    
    <!-- Firebase & Cloudinary -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== MAC OS THEME & RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Mac OS Color Palette */
            --macos-blue: #007AFF;
            --macos-green: #34C759;
            --macos-orange: #FF9500;
            --macos-red: #FF3B30;
            --macos-purple: #AF52DE;
            --macos-gray-1: #F2F2F7;
            --macos-gray-2: #E5E5EA;
            --macos-gray-3: #D1D1D6;
            --macos-gray-4: #C7C7CC;
            --macos-gray-5: #8E8E93;
            --macos-gray-6: #3A3A3C;
            
            /* Text Colors */
            --macos-text-primary: #000000;
            --macos-text-secondary: #3C3C43;
            --macos-text-tertiary: #8E8E93;
            
            /* Shadows */
            --macos-shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --macos-shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --macos-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
            
            /* Border Radius */
            --macos-radius-sm: 10px;
            --macos-radius-md: 14px;
            --macos-radius-lg: 18px;
            --macos-radius-full: 9999px;
            
            /* Transitions */
            --macos-transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
            background: white;
            color: var(--macos-text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== APP LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: white;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--macos-gray-2);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .sidebar-title {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-section {
            padding: 24px 0;
            border-bottom: 1px solid var(--macos-gray-2);
        }

        .nav-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-gray-5);
            padding: 0 24px 12px;
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: var(--macos-text-secondary);
            text-decoration: none;
            transition: var(--macos-transition);
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover {
            background: var(--macos-gray-1);
            color: var(--macos-blue);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.1), transparent);
            color: var(--macos-blue);
            border-right: 3px solid var(--macos-blue);
        }

        .nav-item i {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-badge {
            position: absolute;
            right: 24px;
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--macos-radius-full);
            font-weight: 600;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 24px;
            border-top: 1px solid var(--macos-gray-2);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--macos-radius-full);
            background: linear-gradient(135deg, var(--macos-purple), var(--macos-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .admin-info h4 {
            font-size: 15px;
            font-weight: 600;
        }

        .admin-info p {
            font-size: 13px;
            color: var(--macos-gray-5);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            background: white;
        }

        .content-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 90;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-text-primary);
        }

        .header-title p {
            color: var(--macos-gray-5);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-full);
            background: var(--macos-gray-1);
            font-size: 14px;
            transition: var(--macos-transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-gray-5);
        }

        .header-btn {
            padding: 10px 20px;
            background: var(--macos-gray-1);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            font-weight: 500;
            color: var(--macos-text-secondary);
            cursor: pointer;
            transition: var(--macos-transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn:hover {
            background: var(--macos-gray-2);
            color: var(--macos-text-primary);
        }

        .header-btn.primary {
            background: var(--macos-blue);
            border-color: var(--macos-blue);
            color: white;
        }

        .header-btn.primary:hover {
            background: #0066CC;
        }

        .content-wrapper {
            padding: 32px;
        }

        /* ===== APP ICONS (MOBILE) ===== */
        .mobile-app-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--macos-gray-2);
            z-index: 200;
            padding: 12px 16px;
        }

        .app-icons {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--macos-text-secondary);
            text-decoration: none;
            font-size: 11px;
            transition: var(--macos-transition);
            padding: 8px 12px;
            border-radius: var(--macos-radius-md);
        }

        .app-icon i {
            font-size: 22px;
        }

        .app-icon.active {
            color: var(--macos-blue);
            background: rgba(0, 122, 255, 0.1);
        }

        /* ===== DASHBOARD CARDS ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .dashboard-card {
            background: white;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-lg);
            padding: 24px;
            transition: var(--macos-transition);
        }

        .dashboard-card:hover {
            box-shadow: var(--macos-shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--macos-text-secondary);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .card-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }
        .card-icon.green { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .card-icon.orange { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .card-icon.purple { background: rgba(175, 82, 222, 0.1); color: var(--macos-purple); }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--macos-text-primary);
        }

        .card-change {
            font-size: 13px;
            color: var(--macos-green);
            font-weight: 500;
        }

        .card-change.negative {
            color: var(--macos-red);
        }

        /* ===== DATA TABLES ===== */
        .data-table-container {
            background: white;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-lg);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 700;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .table-filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            background: white;
            font-size: 14px;
            color: var(--macos-text-secondary);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--macos-gray-1);
        }

        .data-table th {
            padding: 16px 24px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--macos-gray-6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--macos-gray-2);
        }

        .data-table td {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            font-size: 14px;
            vertical-align: middle;
        }

        .data-table tbody tr {
            transition: var(--macos-transition);
        }

        .data-table tbody tr:hover {
            background: var(--macos-gray-1);
        }

        .table-pagination {
            padding: 20px 24px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-info {
            color: var(--macos-gray-5);
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .pagination-btn:hover {
            background: var(--macos-gray-1);
            border-color: var(--macos-gray-3);
        }

        .pagination-btn.active {
            background: var(--macos-blue);
            border-color: var(--macos-blue);
            color: white;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: var(--macos-radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-pending { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .status-approved { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .status-rejected { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }
        .status-active { background: rgba(0, 122, 255, 0.1); color: var(--macos-blue); }
        .status-suspended { background: rgba(142, 142, 147, 0.1); color: var(--macos-gray-6); }
        .status-banned { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }
        .status-paid { background: rgba(52, 199, 89, 0.1); color: var(--macos-green); }
        .status-due { background: rgba(255, 149, 0, 0.1); color: var(--macos-orange); }
        .status-overdue { background: rgba(255, 59, 48, 0.1); color: var(--macos-red); }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--macos-radius-md);
            border: 1px solid var(--macos-gray-2);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--macos-transition);
            font-size: 14px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--macos-shadow-sm);
        }

        .action-btn.view { color: var(--macos-blue); border-color: rgba(0, 122, 255, 0.3); }
        .action-btn.edit { color: var(--macos-green); border-color: rgba(52, 199, 89, 0.3); }
        .action-btn.delete { color: var(--macos-red); border-color: rgba(255, 59, 48, 0.3); }
        .action-btn.approve { color: var(--macos-green); border-color: rgba(52, 199, 89, 0.3); }
        .action-btn.suspend { color: var(--macos-orange); border-color: rgba(255, 149, 0, 0.3); }
        .action-btn.assign { color: var(--macos-purple); border-color: rgba(175, 82, 222, 0.3); }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--macos-transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--macos-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-lg);
            transform: translateY(20px);
            transition: var(--macos-transition);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--macos-radius-md);
            background: var(--macos-gray-1);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--macos-transition);
        }

        .modal-close:hover {
            background: var(--macos-gray-2);
        }

        .modal-body {
            padding: 32px;
        }

        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== FORMS ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--macos-text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            font-size: 15px;
            transition: var(--macos-transition);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 44px;
        }

        /* ===== DOCUMENT VIEWER ===== */
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .document-card {
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            overflow: hidden;
            transition: var(--macos-transition);
        }

        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-sm);
        }

        .document-preview {
            height: 150px;
            overflow: hidden;
            background: var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--macos-transition);
        }

        .document-preview img:hover {
            transform: scale(1.05);
        }

        .document-info {
            padding: 16px;
        }

        .document-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .document-type {
            font-size: 12px;
            color: var(--macos-gray-5);
        }

        /* ===== LOAN DETAILS ===== */
        .loan-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .detail-card {
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius-md);
            padding: 20px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--macos-gray-5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--macos-text-primary);
        }

        /* ===== CHARTS ===== */
        .chart-container {
            background: white;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-lg);
            padding: 24px;
            margin-bottom: 32px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* ===== LOADING & TOAST ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--macos-transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: var(--macos-text-secondary);
            font-weight: 500;
        }

        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            border-left: 4px solid var(--macos-blue);
            border-radius: var(--macos-radius-md);
            padding: 16px 20px;
            box-shadow: var(--macos-shadow-lg);
            min-width: 300px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--macos-transition);
        }

        .toast.active {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--macos-green); }
        .toast.error { border-color: var(--macos-red); }
        .toast.warning { border-color: var(--macos-orange); }

        .toast-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .toast-icon.success { background: var(--macos-green); }
        .toast-icon.error { background: var(--macos-red); }
        .toast-icon.warning { background: var(--macos-orange); }
        .toast-icon.info { background: var(--macos-blue); }

        .toast-title {
            font-weight: 600;
            font-size: 15px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-app-bar {
                display: block;
            }
            .content-header {
                padding: 20px;
            }
            .search-box {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .table-actions {
                width: 100%;
                justify-content: space-between;
            }
            .modal {
                max-width: 95%;
            }
            .document-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .content-wrapper {
                padding: 20px;
            }
            .header-actions {
                flex-wrap: wrap;
            }
            .search-box {
                width: 100%;
                order: 3;
                margin-top: 12px;
            }
            .data-table {
                display: block;
                overflow-x: auto;
            }
            .document-grid {
                grid-template-columns: 1fr;
            }
            .modal-body {
                padding: 20px;
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 8px; }
        .gap-2 { gap: 16px; }
        .gap-3 { gap: 24px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--macos-gray-5); }
        .text-success { color: var(--macos-green); }
        .text-error { color: var(--macos-red); }
        .text-warning { color: var(--macos-orange); }
        .text-info { color: var(--macos-blue); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">TC</div>
                <div class="sidebar-title">TruCash Admin</div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Overview</div>
                <div class="nav-items">
                    <div class="nav-item active" data-section="dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="analytics">
                        <i class="fas fa-chart-pie"></i>
                        <span>Analytics</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Loan Management</div>
                <div class="nav-items">
                    <div class="nav-item" data-section="loans">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>All Loans</span>
                        <span class="nav-badge" id="pendingLoansBadge">0</span>
                    </div>
                    <div class="nav-item" data-section="pendingLoans">
                        <i class="fas fa-clock"></i>
                        <span>Pending Approval</span>
                        <span class="nav-badge" id="pendingApprovalBadge">0</span>
                    </div>
                    <div class="nav-item" data-section="repayments">
                        <i class="fas fa-money-check-alt"></i>
                        <span>Repayments</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Agent Management</div>
                <div class="nav-items">
                    <div class="nav-item" data-section="agents">
                        <i class="fas fa-user-tie"></i>
                        <span>All Agents</span>
                    </div>
                    <div class="nav-item" data-section="pendingAgents">
                        <i class="fas fa-user-clock"></i>
                        <span>Pending Agents</span>
                        <span class="nav-badge" id="pendingAgentsBadge">0</span>
                    </div>
                    <div class="nav-item" data-section="createAgent">
                        <i class="fas fa-user-plus"></i>
                        <span>Create Agent</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Customer Management</div>
                <div class="nav-items">
                    <div class="nav-item" data-section="customers">
                        <i class="fas fa-users"></i>
                        <span>All Customers</span>
                    </div>
                    <div class="nav-item" data-section="createCustomer">
                        <i class="fas fa-user-plus"></i>
                        <span>Create Customer</span>
                    </div>
                    <div class="nav-item" data-section="assignAgent">
                        <i class="fas fa-handshake"></i>
                        <span>Assign Agents</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Commission & Payments</div>
                <div class="nav-items">
                    <div class="nav-item" data-section="commissions">
                        <i class="fas fa-coins"></i>
                        <span>Commissions</span>
                    </div>
                    <div class="nav-item" data-section="transactions">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transactions</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>
                <div class="nav-items">
                    <div class="nav-item" data-section="audit">
                        <i class="fas fa-history"></i>
                        <span>Audit Log</span>
                    </div>
                    <div class="nav-item" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar" id="adminAvatar">A</div>
                    <div class="admin-info">
                        <h4 id="adminName">Loading...</h4>
                        <p id="adminEmail">admin@trucash.com</p>
                    </div>
                </div>
                <button class="header-btn mt-2 w-100" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="header-title">
                    <h1 id="pageTitle">Admin Dashboard</h1>
                    <p id="pageSubtitle">Welcome back, Admin</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="Search everything...">
                    </div>
                    <button class="header-btn" id="menuToggle">
                        <i class="fas fa-bars"></i>
                        Menu
                    </button>
                </div>
            </div>

            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboardSection">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Total Loans</div>
                                <div class="card-icon blue">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalLoans">0</div>
                            <div class="card-change" id="loanChange">0% from last month</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Active Agents</div>
                                <div class="card-icon green">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                            </div>
                            <div class="card-value" id="activeAgents">0</div>
                            <div class="card-change" id="agentChange">0% from last month</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Total Customers</div>
                                <div class="card-icon orange">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalCustomers">0</div>
                            <div class="card-change" id="customerChange">0% from last month</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Pending Actions</div>
                                <div class="card-icon purple">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="card-value" id="pendingActions">0</div>
                            <div class="card-change">Requires attention</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Loan Performance</div>
                            <select class="filter-select" id="chartPeriod">
                                <option value="7d">Last 7 days</option>
                                <option value="30d">Last 30 days</option>
                                <option value="90d">Last 90 days</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="loanChart"></canvas>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Recent Loan Applications</div>
                            <button class="header-btn" onclick="UIManager.showSection('loans')">
                                View All
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Loan ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentLoansTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Other sections will be added here dynamically -->
                <div id="dynamicContent"></div>
            </div>
        </div>

        <!-- Mobile App Bar -->
        <div class="mobile-app-bar">
            <div class="app-icons">
                <a href="#" class="app-icon active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="app-icon" data-section="loans">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Loans</span>
                </a>
                <a href="#" class="app-icon" data-section="agents">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="#" class="app-icon" data-section="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </a>
                <a href="#" class="app-icon" data-section="commissions">
                    <i class="fas fa-coins"></i>
                    <span>Commissions</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading Admin Panel...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toasts will be inserted here -->
    </div>

    <!-- All Modals will be generated dynamically -->

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760,
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx']
        };

        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            allLoans: [],
            allAgents: [],
            allCustomers: [],
            pendingLoans: [],
            pendingAgents: [],
            commissions: [],
            transactions: [],
            auditLogs: [],
            systemSettings: {},
            selectedItem: null,
            currentSection: 'dashboard',
            charts: {},
            filters: {
                loanStatus: 'all',
                agentStatus: 'all',
                customerStatus: 'all',
                dateRange: '30d'
            },
            pagination: {
                loans: { page: 1, limit: 10, total: 0 },
                agents: { page: 1, limit: 10, total: 0 },
                customers: { page: 1, limit: 10, total: 0 }
            },
            realtimeListeners: []
        };

        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db, storage;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            console.log("✅ Firebase initialized for Admin Panel");
        } catch (error) {
            console.error("❌ Firebase initialization error:", error);
            showToast('System Error', 'Failed to initialize Firebase', 'error');
        }

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-header">
                        <div class="toast-icon ${type}">
                            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : type === 'warning' ? 'exclamation-triangle' : 'info'}"></i>
                        </div>
                        <div class="toast-title">${title}</div>
                    </div>
                    <div class="toast-message">${message}</div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('active');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 300);
                }, duration);
                
                return toastId;
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(Number(timestamp));
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(Number(timestamp));
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            truncateText(text, maxLength = 50) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            calculateCommission(loanAmount, rate = 2.5) {
                return (loanAmount * rate) / 100;
            },
            
            openImageModal(imageUrl) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 90vw; max-height: 90vh;">
                        <div class="modal-header">
                            <div class="modal-title">Document Preview</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="padding: 0; display: flex; align-items: center; justify-content: center;">
                            <img src="${imageUrl}" alt="Document" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },
            
            async downloadDocument(url, filename) {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Download error:', error);
                    this.showToast('Download Error', 'Failed to download document', 'error');
                }
            }
        };

        // ===== FIREBASE SERVICE =====
        const FirebaseService = {
            async checkAdminAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        
                        if (!user) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const userRef = db.ref('users/' + user.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                Utils.showToast('Access Denied', 'Admin account not found', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            if (userData.userType !== 'admin' && userData.userType !== 'sudo') {
                                Utils.showToast('Access Denied', 'This panel is for admins only', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = user;
                            AppState.adminData = userData;
                            resolve(userData);
                            
                        } catch (error) {
                            console.error('Auth check error:', error);
                            Utils.showToast('Authentication Error', 'Failed to verify admin status', 'error');
                            resolve(null);
                        }
                    });
                });
            },
            
            async loadAllData() {
                try {
                    // Load loans
                    const loansSnapshot = await db.ref('loans').once('value');
                    AppState.allLoans = [];
                    AppState.pendingLoans = [];
                    
                    if (loansSnapshot.exists()) {
                        loansSnapshot.forEach((childSnapshot) => {
                            const loan = childSnapshot.val();
                            loan.id = childSnapshot.key;
                            AppState.allLoans.push(loan);
                            if (loan.status === 'pending') {
                                AppState.pendingLoans.push(loan);
                            }
                        });
                    }
                    
                    // Load agents
                    const agentsSnapshot = await db.ref('users').orderByChild('userType').equalTo('agent').once('value');
                    AppState.allAgents = [];
                    AppState.pendingAgents = [];
                    
                    if (agentsSnapshot.exists()) {
                        agentsSnapshot.forEach((childSnapshot) => {
                            const agent = childSnapshot.val();
                            agent.id = childSnapshot.key;
                            AppState.allAgents.push(agent);
                            if (agent.status === 'pending') {
                                AppState.pendingAgents.push(agent);
                            }
                        });
                    }
                    
                    // Load customers
                    const customersSnapshot = await db.ref('users').orderByChild('userType').equalTo('customer').once('value');
                    AppState.allCustomers = [];
                    
                    if (customersSnapshot.exists()) {
                        customersSnapshot.forEach((childSnapshot) => {
                            const customer = childSnapshot.val();
                            customer.id = childSnapshot.key;
                            AppState.allCustomers.push(customer);
                        });
                    }
                    
                    // Load commissions
                    const commissionsSnapshot = await db.ref('commissions').once('value');
                    AppState.commissions = [];
                    
                    if (commissionsSnapshot.exists()) {
                        commissionsSnapshot.forEach((childSnapshot) => {
                            const commission = childSnapshot.val();
                            commission.id = childSnapshot.key;
                            AppState.commissions.push(commission);
                        });
                    }
                    
                    // Load transactions
                    const transactionsSnapshot = await db.ref('transactions').once('value');
                    AppState.transactions = [];
                    
                    if (transactionsSnapshot.exists()) {
                        transactionsSnapshot.forEach((childSnapshot) => {
                            const transaction = childSnapshot.val();
                            transaction.id = childSnapshot.key;
                            AppState.transactions.push(transaction);
                        });
                    }
                    
                    // Load system settings
                    const settingsSnapshot = await db.ref('systemSettings').once('value');
                    if (settingsSnapshot.exists()) {
                        AppState.systemSettings = settingsSnapshot.val();
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return false;
                }
            },
            
            async updateLoanStatus(loanId, status, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    const updateData = {
                        status: status,
                        updatedAt: Date.now(),
                        statusNotes: notes,
                        reviewedBy: AppState.currentUser.uid,
                        reviewedByName: AppState.adminData.fullName || 'Admin'
                    };
                    
                    await loanRef.update(updateData);
                    
                    // If approved, create commission record for agent
                    if (status === 'approved') {
                        const loanSnap = await loanRef.once('value');
                        const loan = loanSnap.val();
                        
                        if (loan.agentId) {
                            const commissionId = Utils.generateId('COM');
                            const commissionRef = db.ref('commissions/' + commissionId);
                            
                            const commission = {
                                id: commissionId,
                                loanId: loanId,
                                agentId: loan.agentId,
                                agentName: loan.agentName,
                                customerId: loan.customerId,
                                customerName: loan.customerName,
                                loanAmount: loan.amount,
                                commissionRate: 2.5,
                                commissionAmount: Utils.calculateCommission(loan.amount),
                                status: 'pending',
                                createdAt: Date.now(),
                                notes: 'Commission for approved loan'
                            };
                            
                            await commissionRef.set(commission);
                        }
                    }
                    
                    // Create audit log
                    await this.createAuditLog('loan_status_update', {
                        loanId: loanId,
                        oldStatus: 'pending',
                        newStatus: status,
                        notes: notes,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    return { success: true, message: 'Loan status updated successfully' };
                } catch (error) {
                    console.error('Error updating loan status:', error);
                    return { success: false, error: 'Failed to update loan status' };
                }
            },
            
            async approveAgentApplication(agentId, credentials) {
                try {
                    const agentRef = db.ref('users/' + agentId);
                    const updateData = {
                        status: 'active',
                        isApproved: true,
                        approvedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByName: AppState.adminData.fullName || 'Admin',
                        agentId: credentials.agentId,
                        email: credentials.email,
                        password: credentials.password // Note: In production, this should be handled differently
                    };
                    
                    await agentRef.update(updateData);
                    
                    // Create audit log
                    await this.createAuditLog('agent_approved', {
                        agentId: agentId,
                        customAgentId: credentials.agentId,
                        email: credentials.email,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    return { success: true, message: 'Agent approved successfully' };
                } catch (error) {
                    console.error('Error approving agent:', error);
                    return { success: false, error: 'Failed to approve agent' };
                }
            },
            
            async createAgent(agentData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentUid = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentUid,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.residence,
                        profilePhoto: agentData.profilePhoto || '',
                        nrcFront: agentData.nrcFront || '',
                        nrcBack: agentData.nrcBack || '',
                        agentId: agentData.agentId,
                        userType: 'agent',
                        status: 'active',
                        isApproved: true,
                        approvedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByName: AppState.adminData.fullName || 'Admin',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        branch: agentData.branch || 'Main',
                        commissionRate: 2.5,
                        totalCommission: 0,
                        totalCustomers: 0,
                        totalLoans: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentUid).set(agentDoc);
                    
                    // Create audit log
                    await this.createAuditLog('agent_created', {
                        agentId: agentData.agentId,
                        agentUid: agentUid,
                        agentName: agentData.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    return {
                        success: true,
                        agentUid: agentUid,
                        message: 'Agent created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    let errorMessage = 'Failed to create agent';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateCustomerStatus(customerId, updates) {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update({
                        ...updates,
                        updatedAt: Date.now(),
                        updatedByAdmin: AppState.currentUser.uid,
                        updatedByAdminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    // Create audit log
                    await this.createAuditLog('customer_status_update', {
                        customerId: customerId,
                        updates: updates,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    return { success: true, message: 'Customer updated successfully' };
                } catch (error) {
                    console.error('Error updating customer:', error);
                    return { success: false, error: 'Failed to update customer' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    // Get agent details
                    const agentRef = db.ref('users/' + agentId);
                    const agentSnap = await agentRef.once('value');
                    
                    if (!agentSnap.exists()) {
                        return { success: false, error: 'Agent not found' };
                    }
                    
                    const agent = agentSnap.val();
                    
                    // Update customer
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update({
                        assignedAgentId: agentId,
                        assignedAgentName: agent.fullName,
                        assignedAt: Date.now(),
                        updatedAt: Date.now(),
                        assignedByAdmin: AppState.currentUser.uid,
                        assignedByAdminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    // Update agent's customer count
                    await agentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_assigned', {
                        customerId: customerId,
                        agentId: agentId,
                        agentName: agent.fullName,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async updateCommissionStatus(commissionId, status, payoutDate = null) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    const updateData = {
                        status: status,
                        updatedAt: Date.now(),
                        processedBy: AppState.currentUser.uid,
                        processedByName: AppState.adminData.fullName || 'Admin'
                    };
                    
                    if (payoutDate) {
                        updateData.payoutDate = payoutDate;
                    }
                    
                    await commissionRef.update(updateData);
                    
                    // If paid, update agent's total commission
                    if (status === 'paid') {
                        const commissionSnap = await commissionRef.once('value');
                        const commission = commissionSnap.val();
                        
                        const agentRef = db.ref('users/' + commission.agentId);
                        await agentRef.update({
                            totalCommission: firebase.database.ServerValue.increment(commission.commissionAmount),
                            updatedAt: Date.now()
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('commission_status_update', {
                        commissionId: commissionId,
                        newStatus: status,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    return { success: true, message: 'Commission status updated' };
                } catch (error) {
                    console.error('Error updating commission:', error);
                    return { success: false, error: 'Failed to update commission' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName || 'Admin',
                        userRole: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 1000) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 1000);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.allLoans = [];
                    AppState.allAgents = [];
                    AppState.allCustomers = [];
                    AppState.pendingLoans = [];
                    AppState.pendingAgents = [];
                    AppState.commissions = [];
                    AppState.transactions = [];
                    AppState.auditLogs = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    Utils.showToast('Logout Error', 'Failed to sign out properly', 'error');
                }
            },
            
            setupRealtimeListeners() {
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    AppState.allLoans = [];
                    AppState.pendingLoans = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const loan = childSnapshot.val();
                            loan.id = childSnapshot.key;
                            AppState.allLoans.push(loan);
                            if (loan.status === 'pending') {
                                AppState.pendingLoans.push(loan);
                            }
                        });
                    }
                    
                    AppState.allLoans.sort((a, b) => b.createdAt - a.createdAt);
                    UIManager.updateDashboardMetrics();
                    
                    if (AppState.currentSection === 'loans' || AppState.currentSection === 'pendingLoans') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Agents listener
                const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    AppState.allAgents = [];
                    AppState.pendingAgents = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const agent = childSnapshot.val();
                            agent.id = childSnapshot.key;
                            AppState.allAgents.push(agent);
                            if (agent.status === 'pending') {
                                AppState.pendingAgents.push(agent);
                            }
                        });
                    }
                    
                    UIManager.updateDashboardMetrics();
                    
                    if (AppState.currentSection === 'agents' || AppState.currentSection === 'pendingAgents') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Customers listener
                const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                const customersListener = customersRef.on('value', (snapshot) => {
                    AppState.allCustomers = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const customer = childSnapshot.val();
                            customer.id = childSnapshot.key;
                            AppState.allCustomers.push(customer);
                        });
                    }
                    
                    UIManager.updateDashboardMetrics();
                    
                    if (AppState.currentSection === 'customers') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                });
                
                AppState.realtimeListeners.push(() => customersRef.off('value', customersListener));
                
                // Commissions listener
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    AppState.commissions = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const commission = childSnapshot.val();
                            commission.id = childSnapshot.key;
                            AppState.commissions.push(commission);
                        });
                    }
                    
                    AppState.commissions.sort((a, b) => b.createdAt - a.createdAt);
                    
                    if (AppState.currentSection === 'commissions') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Transactions listener
                const transactionsRef = db.ref('transactions');
                const transactionsListener = transactionsRef.on('value', (snapshot) => {
                    AppState.transactions = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const transaction = childSnapshot.val();
                            transaction.id = childSnapshot.key;
                            AppState.transactions.push(transaction);
                        });
                    }
                    
                    AppState.transactions.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (AppState.currentSection === 'transactions') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                });
                
                AppState.realtimeListeners.push(() => transactionsRef.off('value', transactionsListener));
                
                // Audit logs listener
                const auditRef = db.ref('auditLogs');
                const auditListener = auditRef.on('value', (snapshot) => {
                    AppState.auditLogs = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const audit = childSnapshot.val();
                            audit.id = childSnapshot.key;
                            AppState.auditLogs.push(audit);
                        });
                    }
                    
                    AppState.auditLogs.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (AppState.currentSection === 'audit') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                });
                
                AppState.realtimeListeners.push(() => auditRef.off('value', auditListener));
            }
        };

        // ===== UI MANAGER =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupResponsive();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.appIcons = document.querySelectorAll('.app-icon');
                this.menuToggle = document.getElementById('menuToggle');
                this.sidebar = document.getElementById('sidebar');
                
                // Content
                this.dynamicContent = document.getElementById('dynamicContent');
                this.pageTitle = document.getElementById('pageTitle');
                this.pageSubtitle = document.getElementById('pageSubtitle');
                
                // Dashboard elements
                this.totalLoans = document.getElementById('totalLoans');
                this.activeAgents = document.getElementById('activeAgents');
                this.totalCustomers = document.getElementById('totalCustomers');
                this.pendingActions = document.getElementById('pendingActions');
                this.recentLoansTable = document.getElementById('recentLoansTable');
                
                // Badges
                this.pendingLoansBadge = document.getElementById('pendingLoansBadge');
                this.pendingApprovalBadge = document.getElementById('pendingApprovalBadge');
                this.pendingAgentsBadge = document.getElementById('pendingAgentsBadge');
                
                // Admin info
                this.adminName = document.getElementById('adminName');
                this.adminEmail = document.getElementById('adminEmail');
                this.adminAvatar = document.getElementById('adminAvatar');
                
                // Search
                this.globalSearch = document.getElementById('globalSearch');
                
                // Logout
                this.logoutBtn = document.getElementById('logoutBtn');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        // Update active states
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Close sidebar on mobile
                        if (window.innerWidth <= 992) {
                            this.sidebar.classList.remove('active');
                        }
                    });
                });
                
                // Mobile app icons
                this.appIcons.forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = icon.dataset.section;
                        this.showSection(section);
                        
                        // Update active states
                        this.appIcons.forEach(appIcon => appIcon.classList.remove('active'));
                        icon.classList.add('active');
                        
                        // Update desktop nav
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        const desktopNav = document.querySelector(`.nav-item[data-section="${section}"]`);
                        if (desktopNav) desktopNav.classList.add('active');
                    });
                });
                
                // Menu toggle
                this.menuToggle.addEventListener('click', () => {
                    this.sidebar.classList.toggle('active');
                });
                
                // Global search
                this.globalSearch.addEventListener('input', Utils.debounce(() => {
                    this.handleGlobalSearch();
                }, 500));
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Window resize
                window.addEventListener('resize', () => this.setupResponsive());
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        this.globalSearch.focus();
                    }
                });
            },
            
            setupResponsive() {
                if (window.innerWidth <= 992) {
                    this.sidebar.classList.remove('active');
                }
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAdminAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Update admin info
                    this.updateAdminInfo(adminData);
                    
                    // Load initial data
                    await FirebaseService.loadAllData();
                    
                    // Setup real-time listeners
                    FirebaseService.setupRealtimeListeners();
                    
                    // Initialize dashboard
                    this.updateDashboardMetrics();
                    this.updateRecentLoansTable();
                    this.initCharts();
                    
                    Utils.hideLoading();
                    
                    Utils.showToast('Welcome Admin', `Hello ${adminData.fullName || 'Admin'}!`, 'success');
                    
                } catch (error) {
                    console.error('Auth initialization error:', error);
                    Utils.hideLoading();
                    Utils.showToast('Authentication Error', 'Failed to authenticate admin', 'error');
                }
            },
            
            updateAdminInfo(adminData) {
                this.adminName.textContent = adminData.fullName || 'Admin';
                this.adminEmail.textContent = adminData.email || 'admin@trucash.com';
                
                // Update avatar with initials
                if (adminData.fullName) {
                    const initials = adminData.fullName
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .toUpperCase()
                        .substring(0, 2);
                    this.adminAvatar.textContent = initials;
                }
                
                // Update page subtitle
                this.pageSubtitle.textContent = `Welcome back, ${adminData.fullName || 'Admin'}`;
            },
            
            updateDashboardMetrics() {
                // Update counts
                this.totalLoans.textContent = AppState.allLoans.length;
                this.activeAgents.textContent = AppState.allAgents.filter(a => a.status === 'active').length;
                this.totalCustomers.textContent = AppState.allCustomers.length;
                this.pendingActions.textContent = AppState.pendingLoans.length + AppState.pendingAgents.length;
                
                // Update badges
                this.pendingLoansBadge.textContent = AppState.pendingLoans.length;
                this.pendingApprovalBadge.textContent = AppState.pendingLoans.length;
                this.pendingAgentsBadge.textContent = AppState.pendingAgents.length;
                
                // Show/hide badges
                this.pendingLoansBadge.style.display = AppState.pendingLoans.length > 0 ? 'inline-block' : 'none';
                this.pendingApprovalBadge.style.display = AppState.pendingLoans.length > 0 ? 'inline-block' : 'none';
                this.pendingAgentsBadge.style.display = AppState.pendingAgents.length > 0 ? 'inline-block' : 'none';
            },
            
            updateRecentLoansTable() {
                const recentLoans = AppState.allLoans.slice(0, 5);
                
                if (recentLoans.length === 0) {
                    this.recentLoansTable.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <div style="padding: 40px; color: var(--macos-gray-5);">
                                    <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <p>No recent loan applications</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                recentLoans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id || 'N/A'}</strong></td>
                            <td>${loan.customerName || 'Unknown'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="action-btn approve" onclick="LoanManager.approveLoan('${loan.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="action-btn delete" onclick="LoanManager.rejectLoan('${loan.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                this.recentLoansTable.innerHTML = html;
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide current section
                document.querySelector('.content-section.active')?.classList.remove('active');
                
                // Update page title
                const sectionTitles = {
                    dashboard: 'Admin Dashboard',
                    analytics: 'Analytics',
                    loans: 'All Loans',
                    pendingLoans: 'Pending Loan Approval',
                    repayments: 'Repayment Management',
                    agents: 'All Agents',
                    pendingAgents: 'Pending Agent Approval',
                    createAgent: 'Create New Agent',
                    customers: 'All Customers',
                    createCustomer: 'Create New Customer',
                    assignAgent: 'Assign Agents to Customers',
                    commissions: 'Commission Management',
                    transactions: 'Transaction History',
                    audit: 'Audit Log',
                    settings: 'System Settings'
                };
                
                this.pageTitle.textContent = sectionTitles[sectionId] || 'Admin Dashboard';
                
                // Load section content
                this.loadSectionContent(sectionId);
            },
            
            async loadSectionContent(sectionId) {
                let content = '';
                
                switch(sectionId) {
                    case 'dashboard':
                        content = this.getDashboardContent();
                        break;
                    case 'analytics':
                        content = this.getAnalyticsContent();
                        break;
                    case 'loans':
                        content = this.getLoansContent();
                        break;
                    case 'pendingLoans':
                        content = this.getPendingLoansContent();
                        break;
                    case 'repayments':
                        content = this.getRepaymentsContent();
                        break;
                    case 'agents':
                        content = this.getAgentsContent();
                        break;
                    case 'pendingAgents':
                        content = this.getPendingAgentsContent();
                        break;
                    case 'createAgent':
                        content = this.getCreateAgentContent();
                        break;
                    case 'customers':
                        content = this.getCustomersContent();
                        break;
                    case 'createCustomer':
                        content = this.getCreateCustomerContent();
                        break;
                    case 'assignAgent':
                        content = this.getAssignAgentContent();
                        break;
                    case 'commissions':
                        content = this.getCommissionsContent();
                        break;
                    case 'transactions':
                        content = this.getTransactionsContent();
                        break;
                    case 'audit':
                        content = this.getAuditContent();
                        break;
                    case 'settings':
                        content = this.getSettingsContent();
                        break;
                }
                
                // If it's not dashboard, replace dynamic content
                if (sectionId !== 'dashboard') {
                    this.dynamicContent.innerHTML = content;
                    this.dynamicContent.classList.add('active');
                } else {
                    this.dynamicContent.innerHTML = '';
                    this.dynamicContent.classList.remove('active');
                }
                
                // Initialize section-specific features
                this.initSectionFeatures(sectionId);
            },
            
            getDashboardContent() {
                return ''; // Dashboard is already loaded
            },
            
            getAnalyticsContent() {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Revenue Overview</div>
                            <select class="filter-select" id="revenuePeriod">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid mb-3">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Total Revenue</div>
                                <div class="card-icon green">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalRevenue">K0.00</div>
                            <div class="card-change" id="revenueChange">0% from last period</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Average Loan Size</div>
                                <div class="card-icon blue">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                            <div class="card-value" id="avgLoanSize">K0.00</div>
                            <div class="card-change" id="loanSizeChange">0% from last period</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Repayment Rate</div>
                                <div class="card-icon orange">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="card-value" id="repaymentRate">0%</div>
                            <div class="card-change" id="repaymentChange">0% from last period</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Agent Performance</div>
                                <div class="card-icon purple">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            </div>
                            <div class="card-value" id="topAgent">N/A</div>
                            <div class="card-change">Top performing agent</div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Performance Metrics</div>
                            <button class="header-btn" onclick="UIManager.exportAnalytics()">
                                <i class="fas fa-download"></i>
                                Export Data
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Current Period</th>
                                    <th>Previous Period</th>
                                    <th>Change</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            getLoansContent() {
                return `
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Loans</div>
                            <div class="table-actions">
                                <div class="table-filters">
                                    <select class="filter-select" id="loanStatusFilter" onchange="UIManager.filterLoans()">
                                        <option value="all">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                        <option value="active">Active</option>
                                        <option value="completed">Completed</option>
                                        <option value="defaulted">Defaulted</option>
                                    </select>
                                    <select class="filter-select" id="loanDateFilter" onchange="UIManager.filterLoans()">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                    </select>
                                </div>
                                <button class="header-btn primary" onclick="UIManager.exportLoans()">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Loan ID</th>
                                    <th>Customer</th>
                                    <th>Agent</th>
                                    <th>Amount</th>
                                    <th>Purpose</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allLoansTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                        <div class="table-pagination">
                            <div class="pagination-info">Showing 1-10 of ${AppState.allLoans.length} loans</div>
                            <div class="pagination-controls">
                                <button class="pagination-btn"><i class="fas fa-chevron-left"></i></button>
                                <button class="pagination-btn active">1</button>
                                <button class="pagination-btn"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            getPendingLoansContent() {
                return `
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Pending Loan Approval (${AppState.pendingLoans.length})</div>
                            <button class="header-btn primary" onclick="UIManager.approveAllLoans()">
                                <i class="fas fa-check-double"></i>
                                Approve All
                            </button>
                        </div>
                        ${AppState.pendingLoans.length === 0 ? `
                            <div style="padding: 60px; text-align: center; color: var(--macos-gray-5);">
                                <i class="fas fa-check-circle" style="font-size: 64px; margin-bottom: 20px;"></i>
                                <h3>No Pending Loans</h3>
                                <p>All loans have been processed</p>
                            </div>
                        ` : `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Purpose</th>
                                        <th>Applied Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingLoansTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        `}
                    </div>
                `;
            },
            
            getAgentsContent() {
                return `
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Agents (${AppState.allAgents.length})</div>
                            <div class="table-actions">
                                <select class="filter-select" id="agentStatusFilter" onchange="UIManager.filterAgents()">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                </select>
                                <button class="header-btn primary" onclick="UIManager.showSection('createAgent')">
                                    <i class="fas fa-user-plus"></i>
                                    New Agent
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Agent ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Customers</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allAgentsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            getPendingAgentsContent() {
                return `
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Pending Agent Applications (${AppState.pendingAgents.length})</div>
                            <button class="header-btn" onclick="UIManager.refreshData()">
                                <i class="fas fa-sync"></i>
                                Refresh
                            </button>
                        </div>
                        ${AppState.pendingAgents.length === 0 ? `
                            <div style="padding: 60px; text-align: center; color: var(--macos-gray-5);">
                                <i class="fas fa-user-check" style="font-size: 64px; margin-bottom: 20px;"></i>
                                <h3>No Pending Applications</h3>
                                <p>All agent applications have been processed</p>
                            </div>
                        ` : `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Application ID</th>
                                        <th>Full Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Applied Date</th>
                                        <th>Documents</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingAgentsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        `}
                    </div>
                `;
            },
            
            getCreateAgentContent() {
                return `
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Create New Agent</div>
                            <button class="header-btn" onclick="UIManager.showSection('agents')">
                                <i class="fas fa-arrow-left"></i>
                                Back to Agents
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="createAgentForm">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Full Name *</label>
                                        <input type="text" class="form-input" id="agentFullName" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-input" id="agentPhone" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">NRC Number *</label>
                                        <input type="text" class="form-input" id="agentNRC" placeholder="123456/78/9" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Residence Address *</label>
                                        <input type="text" class="form-input" id="agentResidence" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Custom Agent ID *</label>
                                        <input type="text" class="form-input" id="agentCustomId" placeholder="AG123456" required>
                                        <small class="text-muted">Manually assign a unique agent ID</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Branch</label>
                                        <input type="text" class="form-input" id="agentBranch" value="Main">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Agent Email *</label>
                                        <input type="email" class="form-input" id="agentEmail" required>
                                        <small class="text-muted">Manually assign email for login</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Agent Password *</label>
                                        <input type="text" class="form-input" id="agentPassword" required>
                                        <small class="text-muted">Manually assign password for login</small>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Profile Photo</label>
                                    <div class="document-grid" id="agentDocuments">
                                        <div class="document-card" onclick="DocumentManager.uploadAgentPhoto()">
                                            <div class="document-preview">
                                                <i class="fas fa-user-circle" style="font-size: 48px; color: var(--macos-gray-3);"></i>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">Profile Photo</div>
                                                <div class="document-type">Click to upload</div>
                                            </div>
                                        </div>
                                        <div class="document-card" onclick="DocumentManager.uploadAgentNrcFront()">
                                            <div class="document-preview">
                                                <i class="fas fa-id-card" style="font-size: 48px; color: var(--macos-gray-3);"></i>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">NRC Front</div>
                                                <div class="document-type">Required</div>
                                            </div>
                                        </div>
                                        <div class="document-card" onclick="DocumentManager.uploadAgentNrcBack()">
                                            <div class="document-preview">
                                                <i class="fas fa-id-card" style="font-size: 48px; color: var(--macos-gray-3);"></i>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">NRC Back</div>
                                                <div class="document-type">Required</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Commission Rate (%)</label>
                                    <input type="number" class="form-input" id="agentCommissionRate" value="2.5" min="0" max="50" step="0.1">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notes (Optional)</label>
                                    <textarea class="form-input form-textarea" id="agentNotes" placeholder="Any additional notes about this agent..."></textarea>
                                </div>
                                
                                <div class="modal-footer" style="border: none; padding: 0;">
                                    <button type="button" class="header-btn" onclick="UIManager.showSection('agents')">Cancel</button>
                                    <button type="submit" class="header-btn primary">Create Agent</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },
            
            getCustomersContent() {
                return `
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">All Customers (${AppState.allCustomers.length})</div>
                            <div class="table-actions">
                                <select class="filter-select" id="customerStatusFilter" onchange="UIManager.filterCustomers()">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                </select>
                                <button class="header-btn primary" onclick="UIManager.showSection('createCustomer')">
                                    <i class="fas fa-user-plus"></i>
                                    New Customer
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Agent</th>
                                    <th>Loans</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allCustomersTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            // Other section content methods would follow similar pattern...
            // For brevity, I'll show a few more key sections
            
            getCommissionsContent() {
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                const totalPending = pendingCommissions.reduce((sum, c) => sum + (c.commissionAmount || 0), 0);
                
                return `
                    <div class="dashboard-grid mb-3">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Total Commissions</div>
                                <div class="card-icon green">
                                    <i class="fas fa-coins"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalCommissions">${Utils.formatCurrency(AppState.commissions.reduce((sum, c) => sum + (c.commissionAmount || 0), 0))}</div>
                            <div class="card-change">All time</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Pending Payout</div>
                                <div class="card-icon orange">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="card-value" id="pendingCommissions">${Utils.formatCurrency(totalPending)}</div>
                            <div class="card-change">${pendingCommissions.length} payments</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Paid This Month</div>
                                <div class="card-icon blue">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="card-value" id="paidCommissions">K0.00</div>
                            <div class="card-change">Month to date</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Top Earner</div>
                                <div class="card-icon purple">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            </div>
                            <div class="card-value" id="topEarner">N/A</div>
                            <div class="card-change">Highest commission</div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <div class="table-title">Commission Management</div>
                            <div class="table-actions">
                                <select class="filter-select" id="commissionStatusFilter" onchange="UIManager.filterCommissions()">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <button class="header-btn primary" onclick="CommissionManager.payAllPending()" ${pendingCommissions.length === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-money-check-alt"></i>
                                    Pay All Pending
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Commission ID</th>
                                    <th>Agent</th>
                                    <th>Customer</th>
                                    <th>Loan Amount</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commissionsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            initSectionFeatures(sectionId) {
                switch(sectionId) {
                    case 'loans':
                        this.updateLoansTable();
                        break;
                    case 'pendingLoans':
                        this.updatePendingLoansTable();
                        break;
                    case 'agents':
                        this.updateAgentsTable();
                        break;
                    case 'pendingAgents':
                        this.updatePendingAgentsTable();
                        break;
                    case 'customers':
                        this.updateCustomersTable();
                        break;
                    case 'commissions':
                        this.updateCommissionsTable();
                        break;
                    case 'analytics':
                        this.initAnalyticsCharts();
                        break;
                }
            },
            
            updateLoansTable() {
                const table = document.getElementById('allLoansTable');
                if (!table) return;
                
                const filteredLoans = this.filterLoansByStatus(AppState.allLoans);
                
                if (filteredLoans.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px;">
                                <i class="fas fa-search" style="font-size: 48px; color: var(--macos-gray-3); margin-bottom: 16px;"></i>
                                <p class="text-muted">No loans found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                filteredLoans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id || 'N/A'}</strong></td>
                            <td>${loan.customerName || 'Unknown'}</td>
                            <td>${loan.agentName || 'Not Assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="action-btn approve" onclick="LoanManager.approveLoan('${loan.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="action-btn delete" onclick="LoanManager.rejectLoan('${loan.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                    ${loan.status === 'active' ? `
                                        <button class="action-btn edit" onclick="LoanManager.manageRepayment('${loan.id}')">
                                            <i class="fas fa-money-check-alt"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updatePendingLoansTable() {
                const table = document.getElementById('pendingLoansTable');
                if (!table) return;
                
                if (AppState.pendingLoans.length === 0) return;
                
                let html = '';
                AppState.pendingLoans.forEach(loan => {
                    html += `
                        <tr>
                            <td><strong>${loan.id || 'N/A'}</strong></td>
                            <td>${loan.customerName || 'Unknown'}</td>
                            <td>${loan.agentName || 'Not Assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td>${Utils.formatDate(loan.createdAt)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn approve" onclick="LoanManager.approveLoan('${loan.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="LoanManager.rejectLoan('${loan.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateAgentsTable() {
                const table = document.getElementById('allAgentsTable');
                if (!table) return;
                
                const filteredAgents = this.filterAgentsByStatus(AppState.allAgents);
                
                if (filteredAgents.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px;">
                                <i class="fas fa-user-tie" style="font-size: 48px; color: var(--macos-gray-3); margin-bottom: 16px;"></i>
                                <p class="text-muted">No agents found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                filteredAgents.forEach(agent => {
                    const statusClass = `status-${agent.status}`;
                    const statusText = agent.status.charAt(0).toUpperCase() + agent.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${agent.agentId || 'N/A'}</strong></td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${agent.profilePhoto ? `
                                        <img src="${agent.profilePhoto}" alt="Profile" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                                    ` : `
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--macos-gray-2); display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-user" style="color: var(--macos-gray-5);"></i>
                                        </div>
                                    `}
                                    <div>${agent.fullName || 'Unknown'}</div>
                                </div>
                            </td>
                            <td>${agent.email || 'N/A'}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>${Utils.formatCurrency(agent.totalCommission || 0)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="AgentManager.viewAgentDetails('${agent.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn edit" onclick="AgentManager.editAgent('${agent.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${agent.status === 'active' ? `
                                        <button class="action-btn suspend" onclick="AgentManager.suspendAgent('${agent.id}')">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : agent.status === 'suspended' ? `
                                        <button class="action-btn approve" onclick="AgentManager.activateAgent('${agent.id}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                    <button class="action-btn delete" onclick="AgentManager.deleteAgent('${agent.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updatePendingAgentsTable() {
                const table = document.getElementById('pendingAgentsTable');
                if (!table) return;
                
                if (AppState.pendingAgents.length === 0) return;
                
                let html = '';
                AppState.pendingAgents.forEach(agent => {
                    html += `
                        <tr>
                            <td><strong>${agent.id?.substring(0, 8) || 'N/A'}</strong></td>
                            <td>${agent.fullName || 'Unknown'}</td>
                            <td>${agent.email || 'N/A'}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${Utils.formatDate(agent.createdAt)}</td>
                            <td>
                                <button class="action-btn view" onclick="AgentManager.viewAgentDocuments('${agent.id}')">
                                    <i class="fas fa-file-alt"></i>
                                    View
                                </button>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn approve" onclick="AgentManager.approveAgentApplication('${agent.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="AgentManager.rejectAgentApplication('${agent.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateCustomersTable() {
                const table = document.getElementById('allCustomersTable');
                if (!table) return;
                
                const filteredCustomers = this.filterCustomersByStatus(AppState.allCustomers);
                
                if (filteredCustomers.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px;">
                                <i class="fas fa-users" style="font-size: 48px; color: var(--macos-gray-3); margin-bottom: 16px;"></i>
                                <p class="text-muted">No customers found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                filteredCustomers.forEach(customer => {
                    const statusClass = `status-${customer.status || 'active'}`;
                    const statusText = (customer.status || 'active').charAt(0).toUpperCase() + (customer.status || 'active').slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${customer.id?.substring(0, 8) || 'N/A'}</strong></td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${customer.profilePhoto ? `
                                        <img src="${customer.profilePhoto}" alt="Profile" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                                    ` : `
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--macos-gray-2); display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-user" style="color: var(--macos-gray-5);"></i>
                                        </div>
                                    `}
                                    <div>${customer.fullName || 'Unknown'}</div>
                                </div>
                            </td>
                            <td>${customer.email || 'N/A'}</td>
                            <td>${customer.phone || 'N/A'}</td>
                            <td>${customer.assignedAgentName || 'Not Assigned'}</td>
                            <td>${customer.activeLoans || 0} active</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="CustomerManager.viewCustomerDetails('${customer.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn edit" onclick="CustomerManager.editCustomer('${customer.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn assign" onclick="CustomerManager.assignAgent('${customer.id}')">
                                        <i class="fas fa-handshake"></i>
                                    </button>
                                    ${customer.status === 'active' ? `
                                        <button class="action-btn suspend" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : customer.status === 'suspended' ? `
                                        <button class="action-btn approve" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                    <button class="action-btn delete" onclick="CustomerManager.deleteCustomer('${customer.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateCommissionsTable() {
                const table = document.getElementById('commissionsTable');
                if (!table) return;
                
                const filteredCommissions = this.filterCommissionsByStatus(AppState.commissions);
                
                if (filteredCommissions.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px;">
                                <i class="fas fa-coins" style="font-size: 48px; color: var(--macos-gray-3); margin-bottom: 16px;"></i>
                                <p class="text-muted">No commissions found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                filteredCommissions.forEach(commission => {
                    const statusClass = `status-${commission.status}`;
                    const statusText = commission.status.charAt(0).toUpperCase() + commission.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${commission.id || 'N/A'}</strong></td>
                            <td>${commission.agentName || 'Unknown'}</td>
                            <td>${commission.customerName || 'Unknown'}</td>
                            <td>${Utils.formatCurrency(commission.loanAmount)}</td>
                            <td>${Utils.formatCurrency(commission.commissionAmount)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${Utils.formatDateOnly(commission.createdAt)}</td>
                            <td>
                                <div class="action-buttons">
                                    ${commission.status === 'pending' ? `
                                        <button class="action-btn approve" onclick="CommissionManager.markAsPaid('${commission.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="action-btn delete" onclick="CommissionManager.cancelCommission('${commission.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                    <button class="action-btn view" onclick="CommissionManager.viewDetails('${commission.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            filterLoansByStatus(loans) {
                const status = document.getElementById('loanStatusFilter')?.value || 'all';
                if (status === 'all') return loans;
                return loans.filter(loan => loan.status === status);
            },
            
            filterAgentsByStatus(agents) {
                const status = document.getElementById('agentStatusFilter')?.value || 'all';
                if (status === 'all') return agents;
                return agents.filter(agent => agent.status === status);
            },
            
            filterCustomersByStatus(customers) {
                const status = document.getElementById('customerStatusFilter')?.value || 'all';
                if (status === 'all') return customers;
                return customers.filter(customer => customer.status === status);
            },
            
            filterCommissionsByStatus(commissions) {
                const status = document.getElementById('commissionStatusFilter')?.value || 'all';
                if (status === 'all') return commissions;
                return commissions.filter(commission => commission.status === status);
            },
            
            initCharts() {
                // Initialize loan performance chart
                const loanChartCtx = document.getElementById('loanChart');
                if (loanChartCtx) {
                    AppState.charts.loanChart = new Chart(loanChartCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                            datasets: [{
                                label: 'Loan Applications',
                                data: [12, 19, 15, 25, 22, 30, 28],
                                borderColor: 'var(--macos-blue)',
                                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }, {
                                label: 'Loan Approvals',
                                data: [8, 12, 10, 18, 16, 22, 20],
                                borderColor: 'var(--macos-green)',
                                backgroundColor: 'rgba(52, 199, 89, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                }
                            }
                        }
                    });
                }
            },
            
            initAnalyticsCharts() {
                // Revenue chart
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx) {
                    AppState.charts.revenueChart = new Chart(revenueCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Revenue (K)',
                                data: [12000, 19000, 15000, 25000, 22000, 30000],
                                backgroundColor: 'var(--macos-blue)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return 'K' + value;
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Update metrics
                this.updateAnalyticsMetrics();
            },
            
            updateAnalyticsMetrics() {
                // Calculate total revenue (sum of all loan amounts)
                const totalRevenue = AppState.allLoans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                document.getElementById('totalRevenue').textContent = Utils.formatCurrency(totalRevenue);
                
                // Calculate average loan size
                const avgLoanSize = AppState.allLoans.length > 0 ? 
                    totalRevenue / AppState.allLoans.length : 0;
                document.getElementById('avgLoanSize').textContent = Utils.formatCurrency(avgLoanSize);
                
                // Calculate repayment rate (placeholder)
                const repaymentRate = '92%';
                document.getElementById('repaymentRate').textContent = repaymentRate;
                
                // Find top earner agent
                const agentEarnings = {};
                AppState.commissions.forEach(commission => {
                    if (commission.agentId) {
                        if (!agentEarnings[commission.agentId]) {
                            agentEarnings[commission.agentId] = {
                                name: commission.agentName,
                                total: 0
                            };
                        }
                        agentEarnings[commission.agentId].total += commission.commissionAmount || 0;
                    }
                });
                
                let topEarner = 'N/A';
                let maxEarnings = 0;
                Object.values(agentEarnings).forEach(agent => {
                    if (agent.total > maxEarnings) {
                        maxEarnings = agent.total;
                        topEarner = agent.name;
                    }
                });
                
                document.getElementById('topEarner').textContent = topEarner;
                document.getElementById('topAgent').textContent = topEarner;
            },
            
            handleGlobalSearch() {
                const searchTerm = this.globalSearch.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    // If search is empty, reload current section
                    this.loadSectionContent(AppState.currentSection);
                    return;
                }
                
                // Search across all data based on current section
                switch(AppState.currentSection) {
                    case 'loans':
                    case 'pendingLoans':
                        this.searchLoans(searchTerm);
                        break;
                    case 'agents':
                    case 'pendingAgents':
                        this.searchAgents(searchTerm);
                        break;
                    case 'customers':
                        this.searchCustomers(searchTerm);
                        break;
                    case 'commissions':
                        this.searchCommissions(searchTerm);
                        break;
                    default:
                        // For other sections, show search results modal
                        this.showGlobalSearchResults(searchTerm);
                }
            },
            
            searchLoans(searchTerm) {
                const results = AppState.allLoans.filter(loan => {
                    return (
                        (loan.id && loan.id.toLowerCase().includes(searchTerm)) ||
                        (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                        (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm)) ||
                        (loan.purpose && loan.purpose.toLowerCase().includes(searchTerm))
                    );
                });
                
                this.displaySearchResults('loans', results);
            },
            
            searchAgents(searchTerm) {
                const results = AppState.allAgents.filter(agent => {
                    return (
                        (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm)) ||
                        (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm)) ||
                        (agent.email && agent.email.toLowerCase().includes(searchTerm)) ||
                        (agent.phone && agent.phone.includes(searchTerm))
                    );
                });
                
                this.displaySearchResults('agents', results);
            },
            
            displaySearchResults(type, results) {
                // This would update the current table with search results
                // For now, just show a toast with count
                Utils.showToast('Search Results', `Found ${results.length} ${type} matching your search`, 'info');
            },
            
            closeAllModals() {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        };

        // ===== LOAN MANAGER =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    // Get customer details
                    const customerRef = db.ref('users/' + loan.customerId);
                    const customerSnap = await customerRef.once('value');
                    const customer = customerSnap.exists() ? customerSnap.val() : null;
                    
                    // Get agent details
                    const agentRef = db.ref('users/' + loan.agentId);
                    const agentSnap = await agentRef.once('value');
                    const agent = agentSnap.exists() ? agentSnap.val() : null;
                    
                    this.showLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loan details', 'error');
                }
            },
            
            showLoanModal(loan, customer, agent) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                // Prepare documents section
                let documentsHTML = '';
                if (loan.documents) {
                    documentsHTML = `
                        <div class="form-group">
                            <label class="form-label">Loan Documents</label>
                            <div class="document-grid">
                                ${loan.documents.nrcFront ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${loan.documents.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${loan.documents.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${loan.documents.nrcBack ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${loan.documents.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${loan.documents.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${loan.documents.profilePhoto ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${loan.documents.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${loan.documents.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${loan.documents.collateralImages ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${loan.documents.collateralImages[0]}')">
                                        <div class="document-preview">
                                            <img src="${loan.documents.collateralImages[0]}" alt="Collateral">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Collateral</div>
                                            <div class="document-type">Loan Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Prepare customer documents section
                let customerDocumentsHTML = '';
                if (customer) {
                    customerDocumentsHTML = `
                        <div class="form-group">
                            <label class="form-label">Customer Documents</label>
                            <div class="document-grid">
                                ${customer.nrcFront ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${customer.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${customer.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.nrcBack ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${customer.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${customer.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.profilePhoto ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${customer.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${customer.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 900px;">
                        <div class="modal-header">
                            <div class="modal-title">Loan Details - ${loan.id}</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="loan-detail-grid">
                                <div class="detail-card">
                                    <div class="detail-label">Loan Amount</div>
                                    <div class="detail-value">${Utils.formatCurrency(loan.amount)}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">
                                        <span class="status-badge status-${loan.status}">${loan.status}</span>
                                    </div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Duration</div>
                                    <div class="detail-value">${loan.duration} months</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Interest Rate</div>
                                    <div class="detail-value">${loan.interestRate || 15}%</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Loan Purpose</label>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                    ${loan.purpose || 'Not specified'}
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Customer Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Name:</strong> ${customer?.fullName || 'N/A'}</div>
                                        <div><strong>Phone:</strong> ${customer?.phone || 'N/A'}</div>
                                        <div><strong>NRC:</strong> ${customer?.nrc || 'N/A'}</div>
                                        <div><strong>Address:</strong> ${customer?.residence || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agent Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Name:</strong> ${agent?.fullName || 'N/A'}</div>
                                        <div><strong>Agent ID:</strong> ${agent?.agentId || 'N/A'}</div>
                                        <div><strong>Phone:</strong> ${agent?.phone || 'N/A'}</div>
                                        <div><strong>Email:</strong> ${agent?.email || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${documentsHTML}
                            ${customerDocumentsHTML}
                            
                            ${loan.status === 'pending' ? `
                                <div class="form-group">
                                    <label class="form-label">Approval Notes</label>
                                    <textarea class="form-input form-textarea" id="loanApprovalNotes" placeholder="Enter approval or rejection notes..."></textarea>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            ${loan.status === 'pending' ? `
                                <button class="header-btn primary" onclick="LoanManager.approveLoan('${loan.id}', true)">Approve Loan</button>
                                <button class="header-btn" style="background: var(--macos-red); color: white;" onclick="LoanManager.rejectLoan('${loan.id}', true)">Reject Loan</button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async approveLoan(loanId, fromModal = false) {
                try {
                    let notes = '';
                    if (fromModal) {
                        const modal = document.querySelector('.modal-overlay.active');
                        if (modal) {
                            const notesInput = modal.querySelector('#loanApprovalNotes');
                            notes = notesInput ? notesInput.value : '';
                        }
                    }
                    
                    Utils.showLoading('Approving loan...');
                    
                    const result = await FirebaseService.updateLoanStatus(loanId, 'approved', notes);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Loan Approved', 'The loan has been approved successfully', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'loans' || AppState.currentSection === 'pendingLoans') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error approving loan:', error);
                    Utils.hideLoading();
                    Utils.showToast('Approval Failed', error.message || 'Failed to approve loan', 'error');
                }
            },
            
            async rejectLoan(loanId, fromModal = false) {
                try {
                    let notes = '';
                    if (fromModal) {
                        const modal = document.querySelector('.modal-overlay.active');
                        if (modal) {
                            const notesInput = modal.querySelector('#loanApprovalNotes');
                            notes = notesInput ? notesInput.value : '';
                        }
                    }
                    
                    if (!fromModal && !confirm('Are you sure you want to reject this loan?')) {
                        return;
                    }
                    
                    Utils.showLoading('Rejecting loan...');
                    
                    const result = await FirebaseService.updateLoanStatus(loanId, 'rejected', notes);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Loan Rejected', 'The loan has been rejected', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'loans' || AppState.currentSection === 'pendingLoans') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error rejecting loan:', error);
                    Utils.hideLoading();
                    Utils.showToast('Rejection Failed', error.message || 'Failed to reject loan', 'error');
                }
            },
            
            async manageRepayment(loanId) {
                Utils.showToast('Info', 'Repayment management feature coming soon', 'info');
            }
        };

        // ===== AGENT MANAGER =====
        const AgentManager = {
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    agent.id = agentId;
                    
                    // Get agent's customers
                    const customersSnapshot = await db.ref('users').orderByChild('assignedAgentId').equalTo(agentId).once('value');
                    const customers = [];
                    if (customersSnapshot.exists()) {
                        customersSnapshot.forEach((childSnapshot) => {
                            const customer = childSnapshot.val();
                            customer.id = childSnapshot.key;
                            if (customer.userType === 'customer') {
                                customers.push(customer);
                            }
                        });
                    }
                    
                    // Get agent's loans
                    const loansSnapshot = await db.ref('loans').orderByChild('agentId').equalTo(agentId).once('value');
                    const loans = [];
                    if (loansSnapshot.exists()) {
                        loansSnapshot.forEach((childSnapshot) => {
                            const loan = childSnapshot.val();
                            loan.id = childSnapshot.key;
                            loans.push(loan);
                        });
                    }
                    
                    this.showAgentModal(agent, customers, loans);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load agent details', 'error');
                }
            },
            
            showAgentModal(agent, customers, loans) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                // Prepare documents section
                let documentsHTML = '';
                if (agent.nrcFront || agent.nrcBack || agent.profilePhoto) {
                    documentsHTML = `
                        <div class="form-group">
                            <label class="form-label">Agent Documents</label>
                            <div class="document-grid">
                                ${agent.nrcFront ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${agent.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${agent.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Agent Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${agent.nrcBack ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${agent.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${agent.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Agent Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${agent.profilePhoto ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${agent.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${agent.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Agent Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 900px;">
                        <div class="modal-header">
                            <div class="modal-title">Agent Details - ${agent.fullName}</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="loan-detail-grid">
                                <div class="detail-card">
                                    <div class="detail-label">Agent ID</div>
                                    <div class="detail-value">${agent.agentId || 'N/A'}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">
                                        <span class="status-badge status-${agent.status}">${agent.status}</span>
                                    </div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Total Customers</div>
                                    <div class="detail-value">${customers.length}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Total Commission</div>
                                    <div class="detail-value">${Utils.formatCurrency(agent.totalCommission || 0)}</div>
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Contact Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Email:</strong> ${agent.email || 'N/A'}</div>
                                        <div><strong>Phone:</strong> ${agent.phone || 'N/A'}</div>
                                        <div><strong>NRC:</strong> ${agent.nrc || 'N/A'}</div>
                                        <div><strong>Address:</strong> ${agent.residence || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Performance Metrics</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Total Loans:</strong> ${loans.length}</div>
                                        <div><strong>Active Loans:</strong> ${loans.filter(l => l.status === 'active').length}</div>
                                        <div><strong>Commission Rate:</strong> ${agent.commissionRate || 2.5}%</div>
                                        <div><strong>Approved:</strong> ${agent.approvedAt ? Utils.formatDate(agent.approvedAt) : 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${documentsHTML}
                            
                            <div class="form-group">
                                <label class="form-label">Recent Customers (${customers.length})</label>
                                ${customers.length > 0 ? `
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md); max-height: 200px; overflow-y: auto;">
                                        ${customers.slice(0, 10).map(customer => `
                                            <div style="padding: 8px 0; border-bottom: 1px solid var(--macos-gray-2);">
                                                <strong>${customer.fullName}</strong> - ${customer.phone || 'No phone'}
                                            </div>
                                        `).join('')}
                                        ${customers.length > 10 ? `<div style="padding: 8px 0; color: var(--macos-gray-5);">... and ${customers.length - 10} more</div>` : ''}
                                    </div>
                                ` : '<p class="text-muted">No customers assigned yet</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            ${agent.status === 'active' ? `
                                <button class="header-btn" style="background: var(--macos-orange); color: white;" onclick="AgentManager.suspendAgent('${agent.id}', true)">Suspend Agent</button>
                            ` : agent.status === 'suspended' ? `
                                <button class="header-btn primary" onclick="AgentManager.activateAgent('${agent.id}', true)">Activate Agent</button>
                            ` : ''}
                            <button class="header-btn" style="background: var(--macos-red); color: white;" onclick="AgentManager.deleteAgent('${agent.id}', true)">Delete Agent</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async approveAgentApplication(agentId) {
                try {
                    // Show credential input modal
                    this.showAgentApprovalModal(agentId);
                } catch (error) {
                    console.error('Error approving agent:', error);
                    Utils.showToast('Error', 'Failed to approve agent', 'error');
                }
            },
            
            showAgentApprovalModal(agentId) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <div class="modal-title">Approve Agent Application</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Custom Agent ID *</label>
                                <input type="text" class="form-input" id="approvalAgentId" placeholder="AG123456" required>
                                <small class="text-muted">Manually assign a unique agent ID</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Agent Email *</label>
                                <input type="email" class="form-input" id="approvalAgentEmail" required>
                                <small class="text-muted">Manually assign email for login</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Agent Password *</label>
                                <input type="text" class="form-input" id="approvalAgentPassword" required>
                                <small class="text-muted">Manually assign password for login</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Branch Assignment</label>
                                <input type="text" class="form-input" id="approvalAgentBranch" value="Main">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Commission Rate (%)</label>
                                <input type="number" class="form-input" id="approvalCommissionRate" value="2.5" min="0" max="50" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea class="form-input form-textarea" id="approvalNotes" placeholder="Any notes for the agent..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            <button class="header-btn primary" onclick="AgentManager.completeAgentApproval('${agentId}')">Approve Agent</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async completeAgentApproval(agentId) {
                try {
                    const agentIdInput = document.getElementById('approvalAgentId');
                    const emailInput = document.getElementById('approvalAgentEmail');
                    const passwordInput = document.getElementById('approvalAgentPassword');
                    const branchInput = document.getElementById('approvalAgentBranch');
                    const rateInput = document.getElementById('approvalCommissionRate');
                    
                    if (!agentIdInput.value || !emailInput.value || !passwordInput.value) {
                        Utils.showToast('Validation Error', 'Please fill all required fields', 'error');
                        return;
                    }
                    
                    if (!Utils.validateEmail(emailInput.value)) {
                        Utils.showToast('Validation Error', 'Please enter a valid email', 'error');
                        return;
                    }
                    
                    Utils.showLoading('Approving agent...');
                    
                    const credentials = {
                        agentId: agentIdInput.value,
                        email: emailInput.value,
                        password: passwordInput.value,
                        branch: branchInput.value,
                        commissionRate: parseFloat(rateInput.value) || 2.5
                    };
                    
                    const result = await FirebaseService.approveAgentApplication(agentId, credentials);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Agent Approved', 'Agent has been approved successfully', 'success');
                        
                        // Close modal
                        const modal = document.querySelector('.modal-overlay.active');
                        if (modal) modal.remove();
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'agents' || AppState.currentSection === 'pendingAgents') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error approving agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Approval Failed', error.message || 'Failed to approve agent', 'error');
                }
            },
            
            async rejectAgentApplication(agentId) {
                if (!confirm('Are you sure you want to reject this agent application?')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Rejecting agent application...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    await agentRef.update({
                        status: 'rejected',
                        rejectedAt: Date.now(),
                        rejectedBy: AppState.currentUser.uid,
                        rejectedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('agent_rejected', {
                        agentId: agentId,
                        adminId: AppState.currentUser.uid,
                        adminName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    Utils.showToast('Application Rejected', 'Agent application has been rejected', 'success');
                    
                    // Refresh data
                    UIManager.updateDashboardMetrics();
                    if (AppState.currentSection === 'agents' || AppState.currentSection === 'pendingAgents') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                } catch (error) {
                    console.error('Error rejecting agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Rejection Failed', 'Failed to reject agent application', 'error');
                }
            },
            
            async suspendAgent(agentId, fromModal = false) {
                if (!fromModal && !confirm('Are you sure you want to suspend this agent?')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Suspending agent...');
                    
                    const result = await FirebaseService.updateCustomerStatus(agentId, {
                        status: 'suspended',
                        suspendedAt: Date.now(),
                        suspendedBy: AppState.currentUser.uid,
                        suspendedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Agent Suspended', 'Agent has been suspended', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'agents') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error suspending agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Suspension Failed', error.message || 'Failed to suspend agent', 'error');
                }
            },
            
            async activateAgent(agentId, fromModal = false) {
                try {
                    Utils.showLoading('Activating agent...');
                    
                    const result = await FirebaseService.updateCustomerStatus(agentId, {
                        status: 'active',
                        activatedAt: Date.now(),
                        activatedBy: AppState.currentUser.uid,
                        activatedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Agent Activated', 'Agent has been activated', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'agents') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error activating agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Activation Failed', error.message || 'Failed to activate agent', 'error');
                }
            },
            
            async deleteAgent(agentId, fromModal = false) {
                if (!fromModal && !confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Deleting agent...');
                    
                    // Update status to banned
                    const result = await FirebaseService.updateCustomerStatus(agentId, {
                        status: 'banned',
                        bannedAt: Date.now(),
                        bannedBy: AppState.currentUser.uid,
                        bannedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Agent Banned', 'Agent has been banned', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'agents') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error deleting agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Deletion Failed', error.message || 'Failed to delete agent', 'error');
                }
            },
            
            async viewAgentDocuments(agentId) {
                try {
                    Utils.showLoading('Loading documents...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay active';
                    
                    modal.innerHTML = `
                        <div class="modal" style="max-width: 800px;">
                            <div class="modal-header">
                                <div class="modal-title">Agent Documents - ${agent.fullName}</div>
                                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="document-grid">
                                    ${agent.nrcFront ? `
                                        <div class="document-card" onclick="Utils.openImageModal('${agent.nrcFront}')">
                                            <div class="document-preview">
                                                <img src="${agent.nrcFront}" alt="NRC Front">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">NRC Front</div>
                                                <div class="document-type">Click to view full size</div>
                                            </div>
                                        </div>
                                    ` : '<p class="text-muted">No NRC Front uploaded</p>'}
                                    
                                    ${agent.nrcBack ? `
                                        <div class="document-card" onclick="Utils.openImageModal('${agent.nrcBack}')">
                                            <div class="document-preview">
                                                <img src="${agent.nrcBack}" alt="NRC Back">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">NRC Back</div>
                                                <div class="document-type">Click to view full size</div>
                                            </div>
                                        </div>
                                    ` : '<p class="text-muted">No NRC Back uploaded</p>'}
                                    
                                    ${agent.profilePhoto ? `
                                        <div class="document-card" onclick="Utils.openImageModal('${agent.profilePhoto}')">
                                            <div class="document-preview">
                                                <img src="${agent.profilePhoto}" alt="Profile Photo">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">Profile Photo</div>
                                                <div class="document-type">Click to view full size</div>
                                            </div>
                                        </div>
                                    ` : '<p class="text-muted">No Profile Photo uploaded</p>'}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing documents:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load documents', 'error');
                }
            },
            
            async editAgent(agentId) {
                Utils.showToast('Info', 'Edit agent feature coming soon', 'info');
            }
        };

        // ===== CUSTOMER MANAGER =====
        const CustomerManager = {
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    customer.id = customerId;
                    
                    // Get customer's loans
                    const loansSnapshot = await db.ref('loans').orderByChild('customerId').equalTo(customerId).once('value');
                    const loans = [];
                    if (loansSnapshot.exists()) {
                        loansSnapshot.forEach((childSnapshot) => {
                            const loan = childSnapshot.val();
                            loan.id = childSnapshot.key;
                            loans.push(loan);
                        });
                    }
                    
                    // Get assigned agent
                    let agent = null;
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        const agentSnap = await agentRef.once('value');
                        if (agentSnap.exists()) {
                            agent = agentSnap.val();
                        }
                    }
                    
                    this.showCustomerModal(customer, loans, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load customer details', 'error');
                }
            },
            
            showCustomerModal(customer, loans, agent) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                // Prepare documents section
                let documentsHTML = '';
                if (customer.nrcFront || customer.nrcBack || customer.profilePhoto) {
                    documentsHTML = `
                        <div class="form-group">
                            <label class="form-label">Customer Documents</label>
                            <div class="document-grid">
                                ${customer.nrcFront ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${customer.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${customer.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.nrcBack ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${customer.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${customer.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${customer.profilePhoto ? `
                                    <div class="document-card" onclick="Utils.openImageModal('${customer.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${customer.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Customer Document</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 900px;">
                        <div class="modal-header">
                            <div class="modal-title">Customer Details - ${customer.fullName}</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="loan-detail-grid">
                                <div class="detail-card">
                                    <div class="detail-label">Customer ID</div>
                                    <div class="detail-value">${customer.id?.substring(0, 8) || 'N/A'}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">
                                        <span class="status-badge status-${customer.status || 'active'}">${customer.status || 'active'}</span>
                                    </div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Total Loans</div>
                                    <div class="detail-value">${loans.length}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Active Loans</div>
                                    <div class="detail-value">${loans.filter(l => l.status === 'active').length}</div>
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Personal Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Email:</strong> ${customer.email || 'N/A'}</div>
                                        <div><strong>Phone:</strong> ${customer.phone || 'N/A'}</div>
                                        <div><strong>NRC:</strong> ${customer.nrc || 'N/A'}</div>
                                        <div><strong>Address:</strong> ${customer.residence || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agent Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Agent Name:</strong> ${agent?.fullName || 'Not Assigned'}</div>
                                        <div><strong>Agent ID:</strong> ${agent?.agentId || 'N/A'}</div>
                                        <div><strong>Agent Phone:</strong> ${agent?.phone || 'N/A'}</div>
                                        <div><strong>Assigned:</strong> ${customer.assignedAt ? Utils.formatDate(customer.assignedAt) : 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${documentsHTML}
                            
                            <div class="form-group">
                                <label class="form-label">Loan History (${loans.length})</label>
                                ${loans.length > 0 ? `
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md); max-height: 200px; overflow-y: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid var(--macos-gray-3);">
                                                    <th style="padding: 8px; text-align: left;">Loan ID</th>
                                                    <th style="padding: 8px; text-align: left;">Amount</th>
                                                    <th style="padding: 8px; text-align: left;">Status</th>
                                                    <th style="padding: 8px; text-align: left;">Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${loans.slice(0, 10).map(loan => `
                                                    <tr style="border-bottom: 1px solid var(--macos-gray-2);">
                                                        <td style="padding: 8px;">${loan.id || 'N/A'}</td>
                                                        <td style="padding: 8px;">${Utils.formatCurrency(loan.amount)}</td>
                                                        <td style="padding: 8px;"><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                                                        <td style="padding: 8px;">${Utils.formatDateOnly(loan.createdAt)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        ${loans.length > 10 ? `<div style="padding: 8px 0; color: var(--macos-gray-5); text-align: center;">... and ${loans.length - 10} more loans</div>` : ''}
                                    </div>
                                ` : '<p class="text-muted">No loans yet</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            ${customer.status === 'active' ? `
                                <button class="header-btn" style="background: var(--macos-orange); color: white;" onclick="CustomerManager.suspendCustomer('${customer.id}', true)">Suspend Customer</button>
                            ` : customer.status === 'suspended' ? `
                                <button class="header-btn primary" onclick="CustomerManager.activateCustomer('${customer.id}', true)">Activate Customer</button>
                            ` : ''}
                            <button class="header-btn" style="background: var(--macos-red); color: white;" onclick="CustomerManager.deleteCustomer('${customer.id}', true)">Delete Customer</button>
                            <button class="header-btn primary" onclick="CustomerManager.assignAgent('${customer.id}', true)">Assign Agent</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async assignAgent(customerId, fromModal = false) {
                try {
                    // Show agent selection modal
                    this.showAgentAssignmentModal(customerId);
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    Utils.showToast('Error', 'Failed to assign agent', 'error');
                }
            },
            
            showAgentAssignmentModal(customerId) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                // Get active agents for dropdown
                const activeAgents = AppState.allAgents.filter(agent => agent.status === 'active');
                let agentsOptions = '<option value="">Select an agent</option>';
                activeAgents.forEach(agent => {
                    agentsOptions += `<option value="${agent.id}">${agent.fullName} (${agent.agentId})</option>`;
                });
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <div class="modal-title">Assign Agent to Customer</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Select Agent *</label>
                                <select class="form-input form-select" id="agentAssignmentSelect">
                                    ${agentsOptions}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Assignment Notes (Optional)</label>
                                <textarea class="form-input form-textarea" id="assignmentNotes" placeholder="Reason for assignment..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            <button class="header-btn primary" onclick="CustomerManager.completeAgentAssignment('${customerId}')">Assign Agent</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async completeAgentAssignment(customerId) {
                try {
                    const agentSelect = document.getElementById('agentAssignmentSelect');
                    const agentId = agentSelect.value;
                    
                    if (!agentId) {
                        Utils.showToast('Validation Error', 'Please select an agent', 'error');
                        return;
                    }
                    
                    Utils.showLoading('Assigning agent...');
                    
                    const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Agent Assigned', 'Agent has been assigned successfully', 'success');
                        
                        // Close modal
                        const modal = document.querySelector('.modal-overlay.active');
                        if (modal) modal.remove();
                        
                        // Refresh customer modal if open
                        const customerModal = document.querySelector('.modal-overlay.active');
                        if (customerModal) {
                            customerModal.remove();
                            this.viewCustomerDetails(customerId);
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'customers') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    Utils.hideLoading();
                    Utils.showToast('Assignment Failed', error.message || 'Failed to assign agent', 'error');
                }
            },
            
            async suspendCustomer(customerId, fromModal = false) {
                if (!fromModal && !confirm('Are you sure you want to suspend this customer?')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Suspending customer...');
                    
                    const result = await FirebaseService.updateCustomerStatus(customerId, {
                        status: 'suspended',
                        suspendedAt: Date.now(),
                        suspendedBy: AppState.currentUser.uid,
                        suspendedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Customer Suspended', 'Customer has been suspended', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'customers') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error suspending customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Suspension Failed', error.message || 'Failed to suspend customer', 'error');
                }
            },
            
            async activateCustomer(customerId, fromModal = false) {
                try {
                    Utils.showLoading('Activating customer...');
                    
                    const result = await FirebaseService.updateCustomerStatus(customerId, {
                        status: 'active',
                        activatedAt: Date.now(),
                        activatedBy: AppState.currentUser.uid,
                        activatedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Customer Activated', 'Customer has been activated', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'customers') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error activating customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Activation Failed', error.message || 'Failed to activate customer', 'error');
                }
            },
            
            async deleteCustomer(customerId, fromModal = false) {
                if (!fromModal && !confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    Utils.showLoading('Deleting customer...');
                    
                    const result = await FirebaseService.updateCustomerStatus(customerId, {
                        status: 'banned',
                        bannedAt: Date.now(),
                        bannedBy: AppState.currentUser.uid,
                        bannedByName: AppState.adminData.fullName || 'Admin'
                    });
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Customer Banned', 'Customer has been banned', 'success');
                        
                        if (fromModal) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) modal.remove();
                        }
                        
                        // Refresh data
                        UIManager.updateDashboardMetrics();
                        if (AppState.currentSection === 'customers') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    Utils.hideLoading();
                    Utils.showToast('Deletion Failed', error.message || 'Failed to delete customer', 'error');
                }
            },
            
            async editCustomer(customerId) {
                Utils.showToast('Info', 'Edit customer feature coming soon', 'info');
            }
        };

        // ===== COMMISSION MANAGER =====
        const CommissionManager = {
            async markAsPaid(commissionId) {
                try {
                    if (!confirm('Mark this commission as paid?')) {
                        return;
                    }
                    
                    Utils.showLoading('Updating commission status...');
                    
                    const result = await FirebaseService.updateCommissionStatus(commissionId, 'paid', Date.now());
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Commission Paid', 'Commission marked as paid', 'success');
                        
                        // Refresh data
                        if (AppState.currentSection === 'commissions') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error updating commission:', error);
                    Utils.hideLoading();
                    Utils.showToast('Update Failed', error.message || 'Failed to update commission', 'error');
                }
            },
            
            async cancelCommission(commissionId) {
                try {
                    if (!confirm('Cancel this commission?')) {
                        return;
                    }
                    
                    Utils.showLoading('Cancelling commission...');
                    
                    const result = await FirebaseService.updateCommissionStatus(commissionId, 'cancelled');
                    
                    Utils.hideLoading();
                    
                    if (result.success) {
                        Utils.showToast('Commission Cancelled', 'Commission has been cancelled', 'success');
                        
                        // Refresh data
                        if (AppState.currentSection === 'commissions') {
                            UIManager.loadSectionContent(AppState.currentSection);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error cancelling commission:', error);
                    Utils.hideLoading();
                    Utils.showToast('Cancellation Failed', error.message || 'Failed to cancel commission', 'error');
                }
            },
            
            async viewDetails(commissionId) {
                try {
                    Utils.showLoading('Loading commission details...');
                    
                    const commissionRef = db.ref('commissions/' + commissionId);
                    const snapshot = await commissionRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Commission not found', 'error');
                        return;
                    }
                    
                    const commission = snapshot.val();
                    commission.id = commissionId;
                    
                    this.showCommissionModal(commission);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing commission:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load commission details', 'error');
                }
            },
            
            showCommissionModal(commission) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <div class="modal-title">Commission Details - ${commission.id}</div>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="loan-detail-grid">
                                <div class="detail-card">
                                    <div class="detail-label">Commission Amount</div>
                                    <div class="detail-value">${Utils.formatCurrency(commission.commissionAmount)}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">
                                        <span class="status-badge status-${commission.status}">${commission.status}</span>
                                    </div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Commission Rate</div>
                                    <div class="detail-value">${commission.commissionRate || 2.5}%</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Loan Amount</div>
                                    <div class="detail-value">${Utils.formatCurrency(commission.loanAmount)}</div>
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Agent Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Name:</strong> ${commission.agentName || 'N/A'}</div>
                                        <div><strong>Agent ID:</strong> ${commission.agentId || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Customer Information</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        <div><strong>Name:</strong> ${commission.customerName || 'N/A'}</div>
                                        <div><strong>Loan ID:</strong> ${commission.loanId || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Timeline</label>
                                <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                    <div><strong>Created:</strong> ${Utils.formatDate(commission.createdAt)}</div>
                                    ${commission.payoutDate ? `<div><strong>Paid:</strong> ${Utils.formatDate(commission.payoutDate)}</div>` : ''}
                                    ${commission.processedByName ? `<div><strong>Processed By:</strong> ${commission.processedByName}</div>` : ''}
                                </div>
                            </div>
                            
                            ${commission.notes ? `
                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                        ${commission.notes}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="header-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            ${commission.status === 'pending' ? `
                                <button class="header-btn primary" onclick="CommissionManager.markAsPaid('${commission.id}')">Mark as Paid</button>
                                <button class="header-btn" style="background: var(--macos-red); color: white;" onclick="CommissionManager.cancelCommission('${commission.id}')">Cancel Commission</button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async payAllPending() {
                try {
                    const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                    
                    if (pendingCommissions.length === 0) {
                        Utils.showToast('Info', 'No pending commissions to pay', 'info');
                        return;
                    }
                    
                    if (!confirm(`Pay all ${pendingCommissions.length} pending commissions?`)) {
                        return;
                    }
                    
                    Utils.showLoading(`Processing ${pendingCommissions.length} commissions...`);
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const commission of pendingCommissions) {
                        try {
                            await FirebaseService.updateCommissionStatus(commission.id, 'paid', Date.now());
                            successCount++;
                        } catch (error) {
                            console.error(`Error paying commission ${commission.id}:`, error);
                            errorCount++;
                        }
                    }
                    
                    Utils.hideLoading();
                    
                    if (errorCount === 0) {
                        Utils.showToast('Success', `All ${successCount} commissions marked as paid`, 'success');
                    } else {
                        Utils.showToast('Partial Success', `${successCount} paid, ${errorCount} failed`, 'warning');
                    }
                    
                    // Refresh data
                    if (AppState.currentSection === 'commissions') {
                        UIManager.loadSectionContent(AppState.currentSection);
                    }
                } catch (error) {
                    console.error('Error paying all commissions:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to process commissions', 'error');
                }
            }
        };

        // ===== DOCUMENT MANAGER =====
        const DocumentManager = {
            widget: null,
            
            initUploadWidget() {
                this.widget = cloudinary.createUploadWidget({
                    cloudName: cloudinaryConfig.cloudName,
                    uploadPreset: cloudinaryConfig.uploadPreset,
                    sources: ['local', 'camera'],
                    multiple: false,
                    maxFiles: 1,
                    maxFileSize: cloudinaryConfig.maxFileSize,
                    clientAllowedFormats: cloudinaryConfig.allowedFormats,
                    showAdvancedOptions: false,
                    cropping: false,
                    theme: 'minimal',
                    folder: cloudinaryConfig.folder,
                    showPoweredBy: false
                }, (error, result) => {
                    this.handleUploadCallback(error, result);
                });
            },
            
            handleUploadCallback(error, result) {
                if (error) {
                    console.error('Cloudinary upload error:', error);
                    Utils.showToast('Upload Error', error.message || 'Failed to upload file', 'error');
                    return;
                }
                
                if (result && result.event === "success") {
                    const fileData = {
                        url: result.info.secure_url,
                        publicId: result.info.public_id,
                        format: result.info.format,
                        bytes: result.info.bytes,
                        originalFilename: result.info.original_filename,
                        uploadedAt: Date.now()
                    };
                    
                    // Handle the uploaded file based on context
                    this.handleUploadComplete(fileData);
                }
            },
            
            handleUploadComplete(fileData) {
                // This would be extended to handle different upload contexts
                Utils.showToast('Upload Successful', 'Document uploaded successfully', 'success');
            },
            
            uploadAgentPhoto() {
                if (!this.widget) {
                    this.initUploadWidget();
                }
                this.widget.open();
            },
            
            uploadAgentNrcFront() {
                if (!this.widget) {
                    this.initUploadWidget();
                }
                this.widget.open();
            },
            
            uploadAgentNrcBack() {
                if (!this.widget) {
                    this.initUploadWidget();
                }
                this.widget.open();
            }
        };

        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Initialize document manager
            DocumentManager.initUploadWidget();
            
            // Set up online/offline detection
            window.addEventListener('online', () => {
                Utils.showToast('Connection Restored', 'You are back online', 'success');
            });
            
            window.addEventListener('offline', () => {
                Utils.showToast('Connection Lost', 'Please check your internet connection', 'warning');
            });
        });

        // ===== GLOBAL EXPORTS =====
        window.UIManager = UIManager;
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.CommissionManager = CommissionManager;
        window.DocumentManager = DocumentManager;
        window.Utils = Utils;
        window.FirebaseService = FirebaseService;
    </script>
</body>
</html>
