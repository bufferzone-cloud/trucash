<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TruCash</title>
    <!-- Firebase & Cloudinary -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== MAC OS THEME - WHITE BACKGROUND ===== */
        :root {
            --macos-white: #ffffff;
            --macos-gray-1: #f5f5f7;
            --macos-gray-2: #e8e8ed;
            --macos-gray-3: #d2d2d7;
            --macos-gray-4: #8e8e93;
            --macos-gray-5: #424245;
            --macos-gray-6: #1d1d1f;
            
            --macos-blue: #007aff;
            --macos-green: #34c759;
            --macos-orange: #ff9500;
            --macos-red: #ff3b30;
            --macos-purple: #af52de;
            --macos-yellow: #ffcc00;
            
            --macos-text-primary: #1d1d1f;
            --macos-text-secondary: #424245;
            --macos-text-tertiary: #8e8e93;
            
            --macos-radius-sm: 8px;
            --macos-radius-md: 12px;
            --macos-radius-lg: 18px;
            
            --macos-shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --macos-shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --macos-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            --sidebar-width: 280px;
            --header-height: 60px;
            --mobile-breakpoint: 768px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: var(--macos-white);
            color: var(--macos-text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: var(--macos-white);
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--macos-white);
            border-right: 1px solid var(--macos-gray-2);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        
        .brand {
            font-size: 20px;
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .nav-section {
            padding: 20px 0;
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .nav-title {
            padding: 0 20px 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-text-tertiary);
        }
        
        .nav-list {
            list-style: none;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--macos-text-secondary);
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: var(--macos-gray-1);
            color: var(--macos-text-primary);
        }
        
        .nav-item.active {
            background: var(--macos-gray-1);
            color: var(--macos-blue);
            font-weight: 500;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--macos-blue);
            border-radius: 0 3px 3px 0;
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        .nav-badge {
            margin-left: auto;
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
            min-width: 20px;
            text-align: center;
            display: none;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--macos-gray-2);
        }
        
        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-text-secondary);
            font-size: 18px;
            overflow: hidden;
        }
        
        .admin-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .admin-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .admin-info p {
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }
        
        .header {
            height: var(--header-height);
            background: var(--macos-white);
            border-bottom: 1px solid var(--macos-gray-2);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .search-bar {
            position: relative;
            width: 240px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 16px 8px 40px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            background: var(--macos-gray-1);
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: var(--macos-white);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-text-tertiary);
            font-size: 14px;
        }
        
        .notification-bell {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .notification-bell:hover {
            background: var(--macos-gray-2);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--macos-red);
            color: white;
            font-size: 10px;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: var(--macos-radius-sm);
            background: var(--macos-gray-1);
            border: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--macos-text-secondary);
        }
        
        /* ===== CONTENT SECTIONS ===== */
        .content-section {
            padding: 24px;
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* ===== DASHBOARD ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            padding: 20px;
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            border-color: var(--macos-gray-3);
            box-shadow: var(--macos-shadow-sm);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        
        .stat-icon.loans { background: linear-gradient(135deg, var(--macos-blue), #5856d6); }
        .stat-icon.agents { background: linear-gradient(135deg, var(--macos-green), #2cd964); }
        .stat-icon.customers { background: linear-gradient(135deg, var(--macos-orange), #ff9500); }
        .stat-icon.commission { background: linear-gradient(135deg, var(--macos-purple), #bf5af2); }
        
        .stat-trend {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            background: var(--macos-gray-1);
        }
        
        .stat-trend.positive {
            color: var(--macos-green);
            background: rgba(52, 199, 89, 0.1);
        }
        
        .stat-trend.negative {
            color: var(--macos-red);
            background: rgba(255, 59, 48, 0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .chart-card {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .chart-container {
            height: 240px;
            position: relative;
        }
        
        .recent-activity {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            padding: 20px;
        }
        
        .activity-list {
            margin-top: 16px;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--macos-gray-1);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--macos-text-secondary);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .activity-time {
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }
        
        /* ===== DATA TABLES ===== */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .section-actions {
            display: flex;
            gap: 8px;
        }
        
        .data-table-container {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            overflow: hidden;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: var(--macos-gray-1);
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .data-table th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-text-tertiary);
            white-space: nowrap;
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--macos-gray-1);
            transition: background 0.2s ease;
        }
        
        .data-table tbody tr:hover {
            background: var(--macos-gray-1);
        }
        
        .data-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .data-table td {
            padding: 16px;
            font-size: 14px;
            vertical-align: middle;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .status-approved {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .status-suspended {
            background: rgba(142, 142, 147, 0.1);
            color: var(--macos-gray-4);
        }
        
        .status-banned {
            background: rgba(255, 59, 48, 0.2);
            color: var(--macos-red);
        }
        
        .status-completed {
            background: rgba(52, 199, 89, 0.2);
            color: var(--macos-green);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0066cc;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }
        
        .btn-success {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #2db84b;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.2);
        }
        
        .btn-danger {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d70015;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }
        
        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 8px;
            background: var(--macos-gray-1);
            color: var(--macos-text-secondary);
        }
        
        .btn-icon:hover {
            background: var(--macos-gray-2);
        }
        
        .action-buttons {
            display: flex;
            gap: 4px;
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--macos-text-secondary);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            font-size: 14px;
            background: var(--macos-white);
            transition: all 0.2s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-helper {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }
        
        .form-error {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--macos-red);
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--macos-white);
            border-radius: var(--macos-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--macos-shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--macos-gray-1);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: var(--macos-text-secondary);
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--macos-gray-2);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* ===== DETAIL VIEWS ===== */
        .detail-view {
            padding: 24px;
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .detail-avatar {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            overflow: hidden;
            background: var(--macos-gray-1);
        }
        
        .detail-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .detail-info {
            flex: 1;
        }
        
        .detail-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .detail-subtitle {
            font-size: 14px;
            color: var(--macos-text-secondary);
            margin-bottom: 8px;
        }
        
        .detail-status {
            display: inline-block;
            margin-top: 8px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .detail-card {
            background: var(--macos-gray-1);
            border-radius: var(--macos-radius-md);
            padding: 16px;
        }
        
        .detail-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-text-tertiary);
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 500;
        }
        
        /* ===== DOCUMENT VIEWER ===== */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .document-card {
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .document-card:hover {
            border-color: var(--macos-gray-3);
            box-shadow: var(--macos-shadow-sm);
        }
        
        .document-preview {
            height: 150px;
            background: var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
        }
        
        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .document-info {
            padding: 12px;
            border-top: 1px solid var(--macos-gray-2);
        }
        
        .document-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .document-type {
            font-size: 12px;
            color: var(--macos-text-tertiary);
        }
        
        /* ===== LOADING & TOAST ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: var(--macos-text-secondary);
            font-weight: 500;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-radius-md);
            padding: 16px;
            box-shadow: var(--macos-shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            max-width: 400px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.active {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .toast-icon.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .toast-icon.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .toast-icon.warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .toast-icon.info {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--macos-text-secondary);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                max-width: 95%;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }
            
            .content-section {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .section-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .section-actions .btn {
                width: 100%;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .data-table {
                font-size: 13px;
            }
            
            .data-table th, .data-table td {
                padding: 12px 8px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===== UTILITIES ===== */
        .text-muted {
            color: var(--macos-text-tertiary);
        }
        
        .text-success {
            color: var(--macos-green);
        }
        
        .text-danger {
            color: var(--macos-red);
        }
        
        .text-warning {
            color: var(--macos-orange);
        }
        
        .mb-3 {
            margin-bottom: 16px;
        }
        
        .mt-3 {
            margin-top: 16px;
        }
        
        .p-3 {
            padding: 16px;
        }
        
        .d-none {
            display: none;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .align-center {
            align-items: center;
        }
        
        .w-100 {
            width: 100%;
        }
        
        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--macos-gray-1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-4);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Admin Panel...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo">TC</div>
                <div class="brand">Admin Panel</div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Main</div>
                <ul class="nav-list">
                    <li class="nav-item active" data-section="dashboard">
                        <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
                        <span>Dashboard</span>
                    </li>
                    <li class="nav-item" data-section="loans">
                        <div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        <span>Loan Approvals</span>
                        <span id="pendingLoansBadge" class="nav-badge">0</span>
                    </li>
                    <li class="nav-item" data-section="agents">
                        <div class="nav-icon"><i class="fas fa-user-tie"></i></div>
                        <span>Agent Management</span>
                        <span id="pendingAgentsBadge" class="nav-badge">0</span>
                    </li>
                    <li class="nav-item" data-section="customers">
                        <div class="nav-icon"><i class="fas fa-users"></i></div>
                        <span>Customer Management</span>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <div class="nav-title">Advanced</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="assignments">
                        <div class="nav-icon"><i class="fas fa-handshake"></i></div>
                        <span>Agent Assignments</span>
                    </li>
                    <li class="nav-item" data-section="commissions">
                        <div class="nav-icon"><i class="fas fa-money-check-alt"></i></div>
                        <span>Commission Management</span>
                    </li>
                    <li class="nav-item" data-section="transactions">
                        <div class="nav-icon"><i class="fas fa-exchange-alt"></i></div>
                        <span>All Transactions</span>
                    </li>
                    <li class="nav-item" data-section="reports">
                        <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
                        <span>Reports & Analytics</span>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="audit">
                        <div class="nav-icon"><i class="fas fa-history"></i></div>
                        <span>Audit Log</span>
                    </li>
                    <li class="nav-item" data-section="settings">
                        <div class="nav-icon"><i class="fas fa-cog"></i></div>
                        <span>Settings</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-info">
                        <h4 id="adminName">Loading...</h4>
                        <p id="adminRole">Administrator</p>
                        <button id="logoutBtn" class="btn btn-outline btn-small mt-3">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <button id="mobileMenuToggle" class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="pageTitle" class="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="search-bar">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="globalSearch" class="search-input" placeholder="Search...">
                    </div>
                    <div class="notification-bell" onclick="NotificationManager.showNotifications()">
                        <i class="far fa-bell"></i>
                        <span id="notificationBadge" class="notification-badge">0</span>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->
            <!-- Dashboard Section -->
            <section id="dashboardSection" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon loans">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <span class="stat-trend positive" id="loansTrend">+12%</span>
                        </div>
                        <div class="stat-value" id="totalLoans">0</div>
                        <div class="stat-label">Total Loans</div>
                        <div class="text-muted mt-3">
                            <small><i class="fas fa-circle text-warning"></i> <span id="pendingLoans">0</span> pending</small>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon agents">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <span class="stat-trend positive" id="agentsTrend">+5%</span>
                        </div>
                        <div class="stat-value" id="totalAgents">0</div>
                        <div class="stat-label">Active Agents</div>
                        <div class="text-muted mt-3">
                            <small><i class="fas fa-circle text-warning"></i> <span id="pendingAgents">0</span> pending</small>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon customers">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="stat-trend positive" id="customersTrend">+8%</span>
                        </div>
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Total Customers</div>
                        <div class="text-muted mt-3">
                            <small><i class="fas fa-circle text-success"></i> <span id="activeCustomers">0</span> active</small>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon commission">
                                <i class="fas fa-money-check-alt"></i>
                            </div>
                            <span class="stat-trend positive" id="commissionTrend">+15%</span>
                        </div>
                        <div class="stat-value" id="totalCommission">K0</div>
                        <div class="stat-label">Total Commission</div>
                        <div class="text-muted mt-3">
                            <small><i class="fas fa-circle text-warning"></i> <span id="pendingCommission">K0</span> pending</small>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Loan Applications Trend</div>
                            <select id="loanChartPeriod" class="form-select" style="width: auto;">
                                <option value="7d">Last 7 days</option>
                                <option value="30d">Last 30 days</option>
                                <option value="90d">Last 90 days</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="loansChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Loan Status Distribution</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="loanStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Recent Activity</div>
                        <button class="btn btn-outline btn-small" onclick="AuditManager.viewFullAudit()">
                            <i class="fas fa-history"></i> View All
                        </button>
                    </div>
                    <div class="activity-list" id="recentActivity">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">Loading recent activity...</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loan Approvals Section -->
            <section id="loansSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Loan Applications</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="loanSearch" class="search-input" placeholder="Search loans...">
                        </div>
                        <select id="loanStatusFilter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Loan ID</th>
                                    <th>Customer</th>
                                    <th>Agent</th>
                                    <th>Amount</th>
                                    <th>Purpose</th>
                                    <th>Applied Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loansTable">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading loans...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Agent Management Section -->
            <section id="agentsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Agent Management</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="agentSearch" class="search-input" placeholder="Search agents...">
                        </div>
                        <button class="btn btn-primary" onclick="AgentManager.showPendingApplications()">
                            <i class="fas fa-user-plus"></i> Approve Agents
                        </button>
                        <button class="btn btn-success" onclick="AgentManager.createNewAgent()">
                            <i class="fas fa-plus"></i> Create Agent
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Agent ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Customers</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTable">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading agents...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section id="customersSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Customer Management</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="customerSearch" class="search-input" placeholder="Search customers...">
                        </div>
                        <select id="customerStatusFilter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="banned">Banned</option>
                        </select>
                        <button class="btn btn-success" onclick="CustomerManager.createNewCustomer()">
                            <i class="fas fa-user-plus"></i> Create Customer
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>NRC</th>
                                    <th>Agent</th>
                                    <th>Loans</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading customers...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Agent Assignments Section -->
            <section id="assignmentsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Agent Assignments</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="assignmentSearch" class="search-input" placeholder="Search...">
                        </div>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Current Agent</th>
                                    <th>Assigned Date</th>
                                    <th>Active Loans</th>
                                    <th>Performance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading assignments...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Commission Management Section -->
            <section id="commissionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Commission Management</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="commissionSearch" class="search-input" placeholder="Search commissions...">
                        </div>
                        <select id="commissionStatusFilter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                
                <div class="stats-grid mb-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPendingCommission">K0</div>
                        <div class="stat-label">Pending Commission</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPaidCommission">K0</div>
                        <div class="stat-label">Paid Commission</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="commissionThisMonth">K0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Commission ID</th>
                                    <th>Agent</th>
                                    <th>Customer</th>
                                    <th>Loan Amount</th>
                                    <th>Commission %</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commissionsTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading commissions...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">All Transactions</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="transactionSearch" class="search-input" placeholder="Search transactions...">
                        </div>
                        <select id="transactionTypeFilter" class="form-select">
                            <option value="all">All Types</option>
                            <option value="loan">Loan Disbursement</option>
                            <option value="repayment">Repayment</option>
                            <option value="commission">Commission</option>
                            <option value="refund">Refund</option>
                        </select>
                        <button class="btn btn-outline" onclick="TransactionManager.exportTransactions()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Type</th>
                                    <th>Customer</th>
                                    <th>Agent</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Reference</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading transactions...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reports & Analytics Section -->
            <section id="reportsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">Reports & Analytics</div>
                    <div class="section-actions">
                        <select id="reportPeriod" class="form-select">
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <button class="btn btn-primary" onclick="ReportManager.generateReport()">
                            <i class="fas fa-file-export"></i> Generate Report
                        </button>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Performance by Agent</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="agentPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Loan Default Rate</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="defaultRateChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card mt-3">
                    <div class="chart-header">
                        <div class="chart-title">Revenue Overview</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Audit Log Section -->
            <section id="auditSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">System Audit Log</div>
                    <div class="section-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="auditSearch" class="search-input" placeholder="Search audit log...">
                        </div>
                        <select id="auditActionFilter" class="form-select">
                            <option value="all">All Actions</option>
                            <option value="login">Login</option>
                            <option value="loan_approval">Loan Approval</option>
                            <option value="agent_approval">Agent Approval</option>
                            <option value="customer_update">Customer Update</option>
                        </select>
                        <button class="btn btn-outline" onclick="AuditManager.exportAuditLog()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody id="auditTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px;">
                                        <div class="loading-text">Loading audit log...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settingsSection" class="content-section">
                <div class="section-header">
                    <div class="section-title">System Settings</div>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">System Status</div>
                        <div class="detail-value">
                            <span class="status-badge status-active">Operational</span>
                        </div>
                        <div class="form-helper">All systems are running normally</div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-label">Total Users</div>
                        <div class="detail-value" id="totalSystemUsers">0</div>
                        <div class="form-helper">Active users in the system</div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-label">Database Size</div>
                        <div class="detail-value" id="databaseSize">0 MB</div>
                        <div class="form-helper">Firebase database usage</div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-label">Last Backup</div>
                        <div class="detail-value" id="lastBackup">Never</div>
                        <div class="form-helper">System backup timestamp</div>
                    </div>
                </div>
                
                <div class="chart-card mt-3">
                    <div class="chart-header">
                        <div class="chart-title">Loan Settings</div>
                    </div>
                    <div class="p-3">
                        <form id="loanSettingsForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Maximum Loan Amount (ZMW)</label>
                                    <input type="number" id="maxLoanAmount" class="form-input" value="50000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minimum Loan Amount (ZMW)</label>
                                    <input type="number" id="minLoanAmount" class="form-input" value="100">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Default Interest Rate (%)</label>
                                    <input type="number" id="defaultInterestRate" class="form-input" value="15" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agent Commission (%)</label>
                                    <input type="number" id="agentCommissionRate" class="form-input" value="2.5" step="0.1">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Maximum Loan Duration (Months)</label>
                                    <input type="number" id="maxLoanDuration" class="form-input" value="24">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minimum Loan Duration (Months)</label>
                                    <input type="number" id="minLoanDuration" class="form-input" value="3">
                                </div>
                            </div>
                            
                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Loan Detail Modal -->
    <div id="loanDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Loan Application Details</h2>
                <button class="modal-close" onclick="ModalManager.closeLoanModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="loanDetailContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Detail Modal -->
    <div id="agentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agent Details</h2>
                <button class="modal-close" onclick="ModalManager.closeAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="agentDetailContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Customer Details</h2>
                <button class="modal-close" onclick="ModalManager.closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Agent Modal -->
    <div id="approveAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Approve Agent Application</h2>
                <button class="modal-close" onclick="ModalManager.closeApproveAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="approveAgentForm">
                    <div class="form-group">
                        <label class="form-label">Applicant Name</label>
                        <div class="form-input" id="applicantName" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">Loading...</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Applicant NRC</label>
                        <div class="form-input" id="applicantNRC" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">Loading...</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Agent ID *</label>
                        <input type="text" id="agentCustomId" class="form-input" placeholder="Enter custom Agent ID (e.g., AG001)" required>
                        <div class="form-helper">Manually assign a unique Agent ID</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Agent Email *</label>
                        <input type="email" id="agentEmail" class="form-input" placeholder="Enter agent email" required>
                        <div class="form-helper">This will be used for login</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" id="agentPassword" class="form-input" placeholder="Enter password" required>
                        <div class="form-helper">Minimum 6 characters</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" id="agentConfirmPassword" class="form-input" placeholder="Confirm password" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Branch Assignment</label>
                        <select id="agentBranch" class="form-select">
                            <option value="main">Main Branch</option>
                            <option value="east">East Branch</option>
                            <option value="west">West Branch</option>
                            <option value="north">North Branch</option>
                            <option value="south">South Branch</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="agentNotes" class="form-textarea" placeholder="Any additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeApproveAgentModal()">Cancel</button>
                <button class="btn btn-success" onclick="AgentManager.approveAgent()">
                    <i class="fas fa-check"></i> Approve Agent
                </button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div id="createAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Agent</h2>
                <button class="modal-close" onclick="ModalManager.closeCreateAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createAgentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="newAgentName" class="form-input" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" id="newAgentPhone" class="form-input" placeholder="+260..." required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" id="newAgentEmail" class="form-input" placeholder="agent@trucash.com" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" id="newAgentPassword" class="form-input" placeholder="Enter password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" id="newAgentConfirmPassword" class="form-input" placeholder="Confirm password" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Agent ID *</label>
                            <input type="text" id="newAgentId" class="form-input" placeholder="AG001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">NRC Number *</label>
                            <input type="text" id="newAgentNRC" class="form-input" placeholder="123456/78/9" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="newAgentAddress" class="form-textarea" placeholder="Enter residential address"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Branch</label>
                            <select id="newAgentBranch" class="form-select">
                                <option value="main">Main Branch</option>
                                <option value="east">East Branch</option>
                                <option value="west">West Branch</option>
                                <option value="north">North Branch</option>
                                <option value="south">South Branch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" id="newAgentCommission" class="form-input" value="2.5" step="0.1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCreateAgentModal()">Cancel</button>
                <button class="btn btn-success" onclick="AgentManager.createAgent()">
                    <i class="fas fa-user-plus"></i> Create Agent
                </button>
            </div>
        </div>
    </div>

    <!-- Create Customer Modal -->
    <div id="createCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Customer</h2>
                <button class="modal-close" onclick="ModalManager.closeCreateCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createCustomerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="newCustomerName" class="form-input" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" id="newCustomerPhone" class="form-input" placeholder="+260..." required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" id="newCustomerEmail" class="form-input" placeholder="customer@example.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" id="newCustomerPassword" class="form-input" placeholder="Enter password" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">NRC Number *</label>
                            <input type="text" id="newCustomerNRC" class="form-input" placeholder="123456/78/9" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" id="newCustomerDOB" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address *</label>
                        <textarea id="newCustomerAddress" class="form-textarea" placeholder="Enter residential address" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <input type="text" id="newCustomerOccupation" class="form-input" placeholder="Occupation">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monthly Income (ZMW)</label>
                            <input type="number" id="newCustomerIncome" class="form-input" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Assign Agent</label>
                        <select id="newCustomerAgent" class="form-select">
                            <option value="">Select Agent</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="newCustomerNotes" class="form-textarea" placeholder="Any additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCreateCustomerModal()">Cancel</button>
                <button class="btn btn-success" onclick="CustomerManager.createCustomer()">
                    <i class="fas fa-user-plus"></i> Create Customer
                </button>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentViewerModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2 class="modal-title" id="documentTitle">Document</h2>
                <button class="modal-close" onclick="ModalManager.closeDocumentViewer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; justify-content: center; align-items: center; background: #000;">
                <img id="documentImage" src="" alt="Document" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
            </div>
            <div class="modal-footer">
                <a id="documentDownload" href="#" class="btn btn-outline" download>
                    <i class="fas fa-download"></i> Download
                </a>
                <button class="btn btn-primary" onclick="window.open(document.getElementById('documentImage').src, '_blank')">
                    <i class="fas fa-expand"></i> Open in New Tab
                </button>
            </div>
        </div>
    </div>

    <!-- Commission Payment Modal -->
    <div id="commissionPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Pay Commission</h2>
                <button class="modal-close" onclick="ModalManager.closeCommissionPaymentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="commissionPaymentForm">
                    <div class="form-group">
                        <label class="form-label">Agent</label>
                        <div class="form-input" id="commissionAgentName" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">Loading...</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Commission Amount</label>
                            <div class="form-input" id="commissionAmount" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">K0.00</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loan Reference</label>
                            <div class="form-input" id="commissionLoanId" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">N/A</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Payment Method *</label>
                        <select id="commissionPaymentMethod" class="form-select" required>
                            <option value="">Select Method</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Transaction/Reference Number *</label>
                        <input type="text" id="commissionReference" class="form-input" placeholder="Enter reference number" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Payment Date</label>
                        <input type="date" id="commissionPaymentDate" class="form-input" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="commissionNotes" class="form-textarea" placeholder="Any additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCommissionPaymentModal()">Cancel</button>
                <button class="btn btn-success" onclick="CommissionManager.processPayment()">
                    <i class="fas fa-check"></i> Mark as Paid
                </button>
            </div>
        </div>
    </div>

    <!-- Assign Agent Modal -->
    <div id="assignAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Agent to Customer</h2>
                <button class="modal-close" onclick="ModalManager.closeAssignAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="assignAgentForm">
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <div class="form-input" id="assignCustomerName" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">Loading...</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Current Agent</label>
                        <div class="form-input" id="currentAgentName" style="background: var(--macos-gray-1); padding: 10px 12px; border-radius: var(--macos-radius-md);">Not assigned</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Select New Agent *</label>
                        <select id="newAgentSelect" class="form-select" required>
                            <option value="">Select Agent</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Assignment Reason</label>
                        <textarea id="assignmentReason" class="form-textarea" placeholder="Why are you assigning this agent?"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeAssignAgentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="AssignmentManager.assignAgent()">
                    <i class="fas fa-handshake"></i> Assign Agent
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Notifications</h2>
                <button class="modal-close" onclick="ModalManager.closeNotificationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="notificationsList">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="NotificationManager.markAllAsRead()">
                    <i class="fas fa-check-double"></i> Mark All as Read
                </button>
            </div>
        </div>
    </div>

    <!-- Pending Applications Modal -->
    <div id="pendingApplicationsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Pending Agent Applications</h2>
                <button class="modal-close" onclick="ModalManager.closePendingApplicationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="pendingApplicationsList">
                    <!-- Applications will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760,
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx']
        };

        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            isAuthenticated: false,
            
            // Data Collections
            loans: [],
            agents: [],
            customers: [],
            commissions: [],
            transactions: [],
            notifications: [],
            auditLogs: [],
            pendingApplications: [],
            
            // Filter States
            currentFilters: {
                loans: { status: 'all', search: '' },
                agents: { status: 'all', search: '' },
                customers: { status: 'all', search: '' },
                commissions: { status: 'all', search: '' }
            },
            
            // Current Selections
            selectedLoan: null,
            selectedAgent: null,
            selectedCustomer: null,
            selectedCommission: null,
            
            // UI State
            currentSection: 'dashboard',
            charts: {},
            realtimeListeners: [],
            
            // Cloudinary
            cloudinaryWidget: null
        };

        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db, storage;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            console.log(" Firebase initialized for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase", "error");
        }

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                document.getElementById('loadingOverlay').classList.add('active');
                document.querySelector('.loading-text').textContent = message;
            },
            
            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('active');
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast`;
                
                let iconClass = 'fa-info-circle';
                let iconColor = 'info';
                
                switch(type) {
                    case 'success':
                        iconClass = 'fa-check-circle';
                        iconColor = 'success';
                        break;
                    case 'error':
                        iconClass = 'fa-exclamation-circle';
                        iconColor = 'error';
                        break;
                    case 'warning':
                        iconClass = 'fa-exclamation-triangle';
                        iconColor = 'warning';
                        break;
                }
                
                toast.innerHTML = `
                    <div class="toast-icon ${iconColor}">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                // Animate in
                setTimeout(() => toast.classList.add('active'), 10);
                
                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
                
                return toast;
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            calculateCommission(loanAmount, rate = 2.5) {
                return (loanAmount * rate) / 100;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            truncateText(text, maxLength = 50) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // ===== AUTHENTICATION SERVICE =====
        const AuthService = {
            async checkAuth() {
                return new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        
                        if (!user) {
                            window.location.href = 'login.html';
                            resolve(false);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const userRef = db.ref('users/' + user.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                Utils.showToast('Access Denied', 'User not found in database', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(false);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            // Only allow admin users
                            if (userData.userType !== 'admin' && userData.userType !== 'sudo') {
                                Utils.showToast('Access Denied', 'Admin access required', 'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(false);
                                return;
                            }
                            
                            AppState.currentUser = user;
                            AppState.adminData = userData;
                            AppState.isAuthenticated = true;
                            
                            // Update UI
                            document.getElementById('adminName').textContent = userData.fullName || 'Admin';
                            document.getElementById('adminRole').textContent = userData.userType === 'sudo' ? 'Super Admin' : 'Administrator';
                            
                            resolve(true);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            Utils.showToast('Authentication Error', 'Failed to verify admin status', 'error');
                            resolve(false);
                        }
                    });
                });
            },
            
            async signOut() {
                try {
                    // Clear all listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.isAuthenticated = false;
                    
                    // Sign out
                    await auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                    Utils.showToast('Logout Error', 'Failed to logout', 'error');
                }
            }
        };

        // ===== FIREBASE DATA SERVICE =====
        const FirebaseService = {
            async loadAllData() {
                try {
                    await Promise.all([
                        this.loadLoans(),
                        this.loadAgents(),
                        this.loadCustomers(),
                        this.loadCommissions(),
                        this.loadTransactions(),
                        this.loadNotifications(),
                        this.loadAuditLogs(),
                        this.loadPendingApplications()
                    ]);
                    
                    // Setup realtime listeners
                    this.setupRealtimeListeners();
                    
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return false;
                }
            },
            
            async loadLoans() {
                try {
                    const snapshot = await db.ref('loans').once('value');
                    const loans = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    // Sort by creation date (newest first)
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    
                    return loans;
                } catch (error) {
                    console.error('Error loading loans:', error);
                    return [];
                }
            },
            
            async loadAgents() {
                try {
                    const snapshot = await db.ref('users').orderByChild('userType').equalTo('agent').once('value');
                    const agents = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        if (agent.userType === 'agent') {
                            agents.push(agent);
                        }
                    });
                    
                    AppState.agents = agents;
                    return agents;
                } catch (error) {
                    console.error('Error loading agents:', error);
                    return [];
                }
            },
            
            async loadCustomers() {
                try {
                    const snapshot = await db.ref('users').orderByChild('userType').equalTo('customer').once('value');
                    const customers = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        if (customer.userType === 'customer') {
                            customers.push(customer);
                        }
                    });
                    
                    AppState.customers = customers;
                    return customers;
                } catch (error) {
                    console.error('Error loading customers:', error);
                    return [];
                }
            },
            
            async loadCommissions() {
                try {
                    const snapshot = await db.ref('commissions').once('value');
                    const commissions = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    return commissions;
                } catch (error) {
                    console.error('Error loading commissions:', error);
                    return [];
                }
            },
            
            async loadTransactions() {
                try {
                    const snapshot = await db.ref('transactions').once('value');
                    const transactions = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        transactions.push(transaction);
                    });
                    
                    transactions.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.transactions = transactions;
                    
                    return transactions;
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    return [];
                }
            },
            
            async loadNotifications() {
                try {
                    const snapshot = await db.ref('notifications/admin').once('value');
                    const notifications = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const notification = childSnapshot.val();
                        notification.id = childSnapshot.key;
                        notifications.push(notification);
                    });
                    
                    notifications.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.notifications = notifications;
                    
                    // Update badge
                    const unreadCount = notifications.filter(n => !n.read).length;
                    document.getElementById('notificationBadge').textContent = unreadCount;
                    document.getElementById('notificationBadge').style.display = unreadCount > 0 ? 'flex' : 'none';
                    
                    return notifications;
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    return [];
                }
            },
            
            async loadAuditLogs() {
                try {
                    const snapshot = await db.ref('auditLogs').orderByChild('timestamp').limitToLast(100).once('value');
                    const logs = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        log.id = childSnapshot.key;
                        logs.push(log);
                    });
                    
                    logs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = logs;
                    
                    return logs;
                } catch (error) {
                    console.error('Error loading audit logs:', error);
                    return [];
                }
            },
            
            async loadPendingApplications() {
                try {
                    const snapshot = await db.ref('agentApplications').orderByChild('status').equalTo('pending').once('value');
                    const applications = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    AppState.pendingApplications = applications;
                    
                    // Update badge
                    const pendingCount = applications.length;
                    document.getElementById('pendingAgentsBadge').textContent = pendingCount;
                    document.getElementById('pendingAgentsBadge').style.display = pendingCount > 0 ? 'inline-block' : 'none';
                    
                    return applications;
                } catch (error) {
                    console.error('Error loading pending applications:', error);
                    return [];
                }
            },
            
            setupRealtimeListeners() {
                // Loans listener
                const loansListener = db.ref('loans').on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    
                    // Update UI if on loans section
                    if (AppState.currentSection === 'loans') {
                        UIManager.updateLoansTable();
                    }
                    if (AppState.currentSection === 'dashboard') {
                        UIManager.updateDashboard();
                    }
                });
                
                AppState.realtimeListeners.push(() => db.ref('loans').off('value', loansListener));
                
                // Agents listener
                const agentsListener = db.ref('users').orderByChild('userType').equalTo('agent').on('value', (snapshot) => {
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        if (agent.userType === 'agent') {
                            agents.push(agent);
                        }
                    });
                    
                    AppState.agents = agents;
                    
                    if (AppState.currentSection === 'agents') {
                        UIManager.updateAgentsTable();
                    }
                    if (AppState.currentSection === 'dashboard') {
                        UIManager.updateDashboard();
                    }
                });
                
                AppState.realtimeListeners.push(() => db.ref('users').off('value', agentsListener));
                
                // Notifications listener
                const notificationsListener = db.ref('notifications/admin').on('value', (snapshot) => {
                    const notifications = [];
                    snapshot.forEach((childSnapshot) => {
                        const notification = childSnapshot.val();
                        notification.id = childSnapshot.key;
                        notifications.push(notification);
                    });
                    
                    notifications.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.notifications = notifications;
                    
                    // Update badge
                    const unreadCount = notifications.filter(n => !n.read).length;
                    document.getElementById('notificationBadge').textContent = unreadCount;
                    document.getElementById('notificationBadge').style.display = unreadCount > 0 ? 'flex' : 'none';
                });
                
                AppState.realtimeListeners.push(() => db.ref('notifications/admin').off('value', notificationsListener));
                
                // Pending applications listener
                const applicationsListener = db.ref('agentApplications').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                    const applications = [];
                    snapshot.forEach((childSnapshot) => {
                        const application = childSnapshot.val();
                        application.id = childSnapshot.key;
                        applications.push(application);
                    });
                    
                    AppState.pendingApplications = applications;
                    
                    // Update badge
                    const pendingCount = applications.length;
                    document.getElementById('pendingAgentsBadge').textContent = pendingCount;
                    document.getElementById('pendingAgentsBadge').style.display = pendingCount > 0 ? 'inline-block' : 'none';
                });
                
                AppState.realtimeListeners.push(() => db.ref('agentApplications').off('value', applicationsListener));
            },
            
            async updateLoanStatus(loanId, status, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    await loanRef.update({
                        status: status,
                        updatedAt: Date.now(),
                        approvedBy: AppState.currentUser.uid,
                        approvedByName: AppState.adminData.fullName,
                        approvalNotes: notes,
                        approvalDate: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('loan_status_update', {
                        loanId: loanId,
                        status: status,
                        notes: notes
                    });
                    
                    // Create notification for agent
                    const loanSnap = await loanRef.once('value');
                    const loan = loanSnap.val();
                    
                    if (loan.agentId) {
                        await this.createNotification(loan.agentId, 'loan_status_changed', {
                            loanId: loanId,
                            status: status,
                            timestamp: Date.now()
                        });
                    }
                    
                    // Create notification for customer
                    await this.createNotification(loan.customerId, 'loan_status_changed', {
                        loanId: loanId,
                        status: status,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Loan status updated successfully' };
                } catch (error) {
                    console.error('Error updating loan status:', error);
                    return { success: false, error: 'Failed to update loan status' };
                }
            },
            
            async updateAgentStatus(agentId, status, notes = '') {
                try {
                    const agentRef = db.ref('users/' + agentId);
                    await agentRef.update({
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid,
                        statusNotes: notes
                    });
                    
                    await this.createAuditLog('agent_status_update', {
                        agentId: agentId,
                        status: status,
                        notes: notes
                    });
                    
                    await this.createNotification(agentId, 'agent_status_changed', {
                        status: status,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent status updated successfully' };
                } catch (error) {
                    console.error('Error updating agent status:', error);
                    return { success: false, error: 'Failed to update agent status' };
                }
            },
            
            async updateCustomerStatus(customerId, status, notes = '') {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update({
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid,
                        statusNotes: notes
                    });
                    
                    await this.createAuditLog('customer_status_update', {
                        customerId: customerId,
                        status: status,
                        notes: notes
                    });
                    
                    await this.createNotification(customerId, 'customer_status_changed', {
                        status: status,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Customer status updated successfully' };
                } catch (error) {
                    console.error('Error updating customer status:', error);
                    return { success: false, error: 'Failed to update customer status' };
                }
            },
            
            async createAgentAccount(agentData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentUid = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentUid,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.address,
                        profilePhoto: agentData.profilePhoto || '',
                        nrcFront: agentData.nrcFront || '',
                        nrcBack: agentData.nrcBack || '',
                        userType: 'agent',
                        agentId: agentData.agentId,
                        branch: agentData.branch || 'main',
                        commissionRate: agentData.commissionRate || 2.5,
                        status: 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName,
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentUid).set(agentDoc);
                    
                    // Update agentApplications if it's from an application
                    if (agentData.applicationId) {
                        await db.ref('agentApplications/' + agentData.applicationId).update({
                            status: 'approved',
                            approvedAt: Date.now(),
                            approvedBy: AppState.currentUser.uid,
                            approvedByName: AppState.adminData.fullName,
                            assignedCredentials: {
                                email: agentData.email,
                                agentId: agentData.agentId
                            }
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('agent_created', {
                        agentId: agentUid,
                        agentName: agentData.fullName,
                        agentCustomId: agentData.agentId
                    });
                    
                    // Create notification for agent
                    await this.createNotification(agentUid, 'agent_account_created', {
                        email: agentData.email,
                        agentId: agentData.agentId,
                        timestamp: Date.now()
                    });
                    
                    return {
                        success: true,
                        agentId: agentUid,
                        message: 'Agent account created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    let errorMessage = 'Failed to create agent account';
                    
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async createCustomerAccount(customerData) {
                try {
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        customerData.password
                    );
                    
                    const customerUid = userCredential.user.uid;
                    
                    // Prepare customer document
                    const customerDoc = {
                        uid: customerUid,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        nrc: customerData.nrc,
                        residence: customerData.address,
                        occupation: customerData.occupation || '',
                        monthlyIncome: customerData.monthlyIncome || 0,
                        dateOfBirth: customerData.dateOfBirth || '',
                        userType: 'customer',
                        status: 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName,
                        assignedAgentId: customerData.assignedAgentId || '',
                        accountBalance: 0,
                        totalLoans: 0,
                        activeLoans: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + customerUid).set(customerDoc);
                    
                    // Update agent's customer count if assigned
                    if (customerData.assignedAgentId) {
                        const agentRef = db.ref('users/' + customerData.assignedAgentId + '/totalCustomers');
                        const snapshot = await agentRef.once('value');
                        const currentCount = snapshot.val() || 0;
                        await agentRef.set(currentCount + 1);
                    }
                    
                    // Create audit log
                    await this.createAuditLog('customer_created', {
                        customerId: customerUid,
                        customerName: customerData.fullName
                    });
                    
                    return {
                        success: true,
                        customerId: customerUid,
                        message: 'Customer account created successfully'
                    };
                } catch (error) {
                    console.error('Error creating customer:', error);
                    let errorMessage = 'Failed to create customer account';
                    
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId, reason = '') {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const agentRef = db.ref('users/' + agentId);
                    
                    // Get current data
                    const customerSnap = await customerRef.once('value');
                    const agentSnap = await agentRef.once('value');
                    
                    const customer = customerSnap.val();
                    const agent = agentSnap.val();
                    
                    const previousAgentId = customer.assignedAgentId;
                    
                    // Update customer
                    await customerRef.update({
                        assignedAgentId: agentId,
                        assignedAgentName: agent.fullName,
                        assignedAt: Date.now(),
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid
                    });
                    
                    // Update previous agent's customer count
                    if (previousAgentId && previousAgentId !== agentId) {
                        const prevAgentRef = db.ref('users/' + previousAgentId + '/totalCustomers');
                        const prevSnap = await prevAgentRef.once('value');
                        const prevCount = prevSnap.val() || 0;
                        if (prevCount > 0) {
                            await prevAgentRef.set(prevCount - 1);
                        }
                    }
                    
                    // Update new agent's customer count
                    const newAgentCustomerRef = db.ref('users/' + agentId + '/totalCustomers');
                    const newSnap = await newAgentCustomerRef.once('value');
                    const newCount = newSnap.val() || 0;
                    await newAgentCustomerRef.set(newCount + 1);
                    
                    // Create audit log
                    await this.createAuditLog('agent_assigned', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        agentId: agentId,
                        agentName: agent.fullName,
                        previousAgentId: previousAgentId,
                        reason: reason
                    });
                    
                    // Create notifications
                    await this.createNotification(customerId, 'agent_assigned', {
                        agentId: agentId,
                        agentName: agent.fullName,
                        timestamp: Date.now()
                    });
                    
                    await this.createNotification(agentId, 'customer_assigned', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async updateCommissionStatus(commissionId, status, paymentData = {}) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid
                    };
                    
                    if (status === 'paid') {
                        updates.paidAt = Date.now();
                        updates.paymentMethod = paymentData.method;
                        updates.paymentReference = paymentData.reference;
                        updates.paymentNotes = paymentData.notes;
                        updates.paidBy = AppState.currentUser.uid;
                        updates.paidByName = AppState.adminData.fullName;
                    }
                    
                    await commissionRef.update(updates);
                    
                    // Update agent's total commission if paid
                    if (status === 'paid') {
                        const commissionSnap = await commissionRef.once('value');
                        const commission = commissionSnap.val();
                        
                        const agentRef = db.ref('users/' + commission.agentId + '/totalCommission');
                        const snapshot = await agentRef.once('value');
                        const currentCommission = snapshot.val() || 0;
                        await agentRef.set(currentCommission + commission.amount);
                    }
                    
                    await this.createAuditLog('commission_status_update', {
                        commissionId: commissionId,
                        status: status,
                        ...paymentData
                    });
                    
                    return { success: true, message: 'Commission status updated' };
                } catch (error) {
                    console.error('Error updating commission:', error);
                    return { success: false, error: 'Failed to update commission' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName,
                        userRole: AppState.adminData.userType,
                        userType: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    // Add to local state
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 100) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 100);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createNotification(userId, type, data) {
                try {
                    const notificationId = Utils.generateId('NOT');
                    const notificationRef = db.ref('notifications/' + userId + '/' + notificationId);
                    
                    const notification = {
                        id: notificationId,
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        read: false,
                        priority: 'medium'
                    };
                    
                    await notificationRef.set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return null;
                }
            },
            
            async markNotificationAsRead(notificationId) {
                try {
                    await db.ref('notifications/admin/' + notificationId + '/read').set(true);
                    return true;
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                    return false;
                }
            },
            
            async markAllNotificationsAsRead() {
                try {
                    const notificationsRef = db.ref('notifications/admin');
                    const snapshot = await notificationsRef.once('value');
                    
                    const updates = {};
                    snapshot.forEach((childSnapshot) => {
                        updates[childSnapshot.key + '/read'] = true;
                    });
                    
                    await notificationsRef.update(updates);
                    return true;
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    return false;
                }
            }
        };

        // ===== UI MANAGER =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.initCharts();
                this.setupResponsive();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.mobileMenuToggle = document.getElementById('mobileMenuToggle');
                this.sidebar = document.getElementById('sidebar');
                
                // Search inputs
                this.globalSearch = document.getElementById('globalSearch');
                this.loanSearch = document.getElementById('loanSearch');
                this.agentSearch = document.getElementById('agentSearch');
                this.customerSearch = document.getElementById('customerSearch');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                
                // Tables
                this.loansTable = document.getElementById('loansTable');
                this.agentsTable = document.getElementById('agentsTable');
                this.customersTable = document.getElementById('customersTable');
                this.commissionsTable = document.getElementById('commissionsTable');
                this.transactionsTable = document.getElementById('transactionsTable');
                this.auditTable = document.getElementById('auditTable');
                
                // Dashboard elements
                this.totalLoansElement = document.getElementById('totalLoans');
                this.totalAgentsElement = document.getElementById('totalAgents');
                this.totalCustomersElement = document.getElementById('totalCustomers');
                this.totalCommissionElement = document.getElementById('totalCommission');
                this.pendingLoansElement = document.getElementById('pendingLoans');
                this.pendingAgentsElement = document.getElementById('pendingAgents');
                this.activeCustomersElement = document.getElementById('activeCustomers');
                this.pendingCommissionElement = document.getElementById('pendingCommission');
                this.recentActivity = document.getElementById('recentActivity');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        // Update active nav item
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Close mobile menu
                        if (window.innerWidth <= 1024) {
                            this.sidebar.classList.remove('active');
                        }
                    });
                });
                
                // Mobile menu toggle
                this.mobileMenuToggle.addEventListener('click', () => {
                    this.sidebar.classList.toggle('active');
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => AuthService.signOut());
                
                // Search functionality
                if (this.globalSearch) {
                    this.globalSearch.addEventListener('input', Utils.debounce(() => {
                        this.performGlobalSearch();
                    }, 300));
                }
                
                if (this.loanSearch) {
                    this.loanSearch.addEventListener('input', Utils.debounce(() => {
                        this.updateLoansTable();
                    }, 300));
                }
                
                if (this.agentSearch) {
                    this.agentSearch.addEventListener('input', Utils.debounce(() => {
                        this.updateAgentsTable();
                    }, 300));
                }
                
                if (this.customerSearch) {
                    this.customerSearch.addEventListener('input', Utils.debounce(() => {
                        this.updateCustomersTable();
                    }, 300));
                }
                
                // Filter changes
                document.getElementById('loanStatusFilter')?.addEventListener('change', () => {
                    this.updateLoansTable();
                });
                
                document.getElementById('customerStatusFilter')?.addEventListener('change', () => {
                    this.updateCustomersTable();
                });
                
                document.getElementById('commissionStatusFilter')?.addEventListener('change', () => {
                    this.updateCommissionsTable();
                });
                
                // Settings form
                document.getElementById('loanSettingsForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSettings();
                });
                
                // Window resize
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            },
            
            setupResponsive() {
                this.handleResize();
            },
            
            handleResize() {
                if (window.innerWidth > 1024) {
                    this.sidebar.classList.remove('active');
                }
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                const isAuthenticated = await AuthService.checkAuth();
                
                if (!isAuthenticated) {
                    Utils.hideLoading();
                    return;
                }
                
                // Load all data
                await FirebaseService.loadAllData();
                
                // Update UI
                this.updateDashboard();
                this.updateLoansTable();
                this.updateAgentsTable();
                this.updateCustomersTable();
                this.updateCommissionsTable();
                this.updateTransactionsTable();
                this.updateAuditTable();
                
                Utils.hideLoading();
                
                // Show welcome
                Utils.showToast('Welcome Admin', `Hello ${AppState.adminData.fullName}!`, 'success');
            },
            
            initCharts() {
                // Initialize charts
                this.initLoansChart();
                this.initLoanStatusChart();
            },
            
            initLoansChart() {
                const ctx = document.getElementById('loansChart');
                if (!ctx) return;
                
                AppState.charts.loans = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{
                            label: 'Loan Applications',
                            data: [12, 19, 15, 25, 22, 30, 28],
                            borderColor: 'var(--macos-blue)',
                            backgroundColor: 'rgba(0, 122, 255, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            },
            
            initLoanStatusChart() {
                const ctx = document.getElementById('loanStatusChart');
                if (!ctx) return;
                
                AppState.charts.loanStatus = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'Approved', 'Active', 'Completed', 'Rejected'],
                        datasets: [{
                            data: [5, 12, 8, 15, 3],
                            backgroundColor: [
                                'var(--macos-orange)',
                                'var(--macos-blue)',
                                'var(--macos-green)',
                                'var(--macos-purple)',
                                'var(--macos-red)'
                            ],
                            borderWidth: 2,
                            borderColor: 'var(--macos-white)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        cutout: '70%'
                    }
                });
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                }
                
                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    loans: 'Loan Approvals',
                    agents: 'Agent Management',
                    customers: 'Customer Management',
                    assignments: 'Agent Assignments',
                    commissions: 'Commission Management',
                    transactions: 'All Transactions',
                    reports: 'Reports & Analytics',
                    audit: 'Audit Log',
                    settings: 'Settings'
                };
                
                document.getElementById('pageTitle').textContent = titles[sectionId] || 'Admin Panel';
                
                // Load section-specific data
                switch(sectionId) {
                    case 'dashboard':
                        this.updateDashboard();
                        break;
                    case 'loans':
                        this.updateLoansTable();
                        break;
                    case 'agents':
                        this.updateAgentsTable();
                        break;
                    case 'customers':
                        this.updateCustomersTable();
                        break;
                    case 'commissions':
                        this.updateCommissionsTable();
                        break;
                    case 'transactions':
                        this.updateTransactionsTable();
                        break;
                    case 'audit':
                        this.updateAuditTable();
                        break;
                }
            },
            
            updateDashboard() {
                // Update stats
                const totalLoans = AppState.loans.length;
                const totalAgents = AppState.agents.filter(a => a.status === 'active').length;
                const totalCustomers = AppState.customers.length;
                const activeCustomers = AppState.customers.filter(c => c.status === 'active').length;
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                const pendingAgents = AppState.pendingApplications.length;
                
                // Calculate total commission
                const totalCommission = AppState.commissions
                    .filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                const pendingCommission = AppState.commissions
                    .filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                // Update UI
                this.totalLoansElement.textContent = totalLoans;
                this.totalAgentsElement.textContent = totalAgents;
                this.totalCustomersElement.textContent = totalCustomers;
                this.totalCommissionElement.textContent = Utils.formatCurrency(totalCommission);
                this.pendingLoansElement.textContent = pendingLoans;
                this.pendingAgentsElement.textContent = pendingAgents;
                this.activeCustomersElement.textContent = activeCustomers;
                this.pendingCommissionElement.textContent = Utils.formatCurrency(pendingCommission);
                
                // Update badges
                document.getElementById('pendingLoansBadge').textContent = pendingLoans;
                document.getElementById('pendingLoansBadge').style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                
                // Update recent activity
                this.updateRecentActivity();
                
                // Update charts if they exist
                if (AppState.charts.loanStatus && AppState.loans.length > 0) {
                    const statusCounts = {
                        pending: AppState.loans.filter(l => l.status === 'pending').length,
                        approved: AppState.loans.filter(l => l.status === 'approved').length,
                        active: AppState.loans.filter(l => l.status === 'active').length,
                        completed: AppState.loans.filter(l => l.status === 'completed').length,
                        rejected: AppState.loans.filter(l => l.status === 'rejected').length
                    };
                    
                    AppState.charts.loanStatus.data.datasets[0].data = [
                        statusCounts.pending,
                        statusCounts.approved,
                        statusCounts.active,
                        statusCounts.completed,
                        statusCounts.rejected
                    ];
                    AppState.charts.loanStatus.update();
                }
            },
            
            updateRecentActivity() {
                const recentLogs = AppState.auditLogs.slice(0, 5);
                const container = this.recentActivity;
                
                if (!container) return;
                
                if (recentLogs.length === 0) {
                    container.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">No recent activity</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                recentLogs.forEach(log => {
                    let icon = 'fa-info-circle';
                    let text = '';
                    
                    switch(log.action) {
                        case 'loan_status_update':
                            icon = 'fa-file-invoice-dollar';
                            text = `Loan ${log.data.loanId} status changed to ${log.data.status}`;
                            break;
                        case 'agent_created':
                            icon = 'fa-user-tie';
                            text = `Agent ${log.data.agentName} created`;
                            break;
                        case 'customer_created':
                            icon = 'fa-user-plus';
                            text = `Customer ${log.data.customerName} created`;
                            break;
                        case 'agent_assigned':
                            icon = 'fa-handshake';
                            text = `Agent ${log.data.agentName} assigned to ${log.data.customerName}`;
                            break;
                        default:
                            text = `${log.action.replace(/_/g, ' ')}`;
                    }
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${text}</div>
                                <div class="activity-time">${Utils.formatDate(log.timestamp)}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateLoansTable() {
                const container = this.loansTable;
                if (!container) return;
                
                let loans = [...AppState.loans];
                
                // Apply search filter
                const searchTerm = document.getElementById('loanSearch')?.value.toLowerCase() || '';
                if (searchTerm) {
                    loans = loans.filter(loan => 
                        (loan.id && loan.id.toLowerCase().includes(searchTerm)) ||
                        (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                        (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm)) ||
                        (loan.purpose && loan.purpose.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Apply status filter
                const statusFilter = document.getElementById('loanStatusFilter')?.value || 'all';
                if (statusFilter !== 'all') {
                    loans = loans.filter(loan => loan.status === statusFilter);
                }
                
                if (loans.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-text-tertiary);">
                                    <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                                    <p>No loans found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                loans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${loan.id || 'N/A'}</strong></td>
                            <td>${loan.customerName || 'N/A'}</td>
                            <td>${loan.agentName || 'Not assigned'}</td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-icon btn-small" onclick="LoanManager.viewLoanDetails('${loan.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn btn-icon btn-small" onclick="LoanManager.approveLoan('${loan.id}')" title="Approve" style="color: var(--macos-green);">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-icon btn-small" onclick="LoanManager.rejectLoan('${loan.id}')" title="Reject" style="color: var(--macos-red);">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateAgentsTable() {
                const container = this.agentsTable;
                if (!container) return;
                
                let agents = [...AppState.agents];
                
                // Apply search filter
                const searchTerm = document.getElementById('agentSearch')?.value.toLowerCase() || '';
                if (searchTerm) {
                    agents = agents.filter(agent => 
                        (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm)) ||
                        (agent.email && agent.email.toLowerCase().includes(searchTerm)) ||
                        (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm)) ||
                        (agent.phone && agent.phone.toLowerCase().includes(searchTerm))
                    );
                }
                
                if (agents.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-text-tertiary);">
                                    <i class="fas fa-user-tie" style="font-size: 32px; margin-bottom: 12px;"></i>
                                    <p>No agents found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                agents.forEach(agent => {
                    const statusClass = `status-${agent.status || 'active'}`;
                    const statusText = (agent.status || 'active').charAt(0).toUpperCase() + (agent.status || 'active').slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${agent.agentId || 'N/A'}</strong></td>
                            <td>${agent.fullName || 'N/A'}</td>
                            <td>${agent.email || 'N/A'}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>${Utils.formatCurrency(agent.totalCommission || 0)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-icon btn-small" onclick="AgentManager.viewAgentDetails('${agent.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${agent.status !== 'suspended' ? `
                                        <button class="btn btn-icon btn-small" onclick="AgentManager.suspendAgent('${agent.id}')" title="Suspend" style="color: var(--macos-orange);">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-icon btn-small" onclick="AgentManager.activateAgent('${agent.id}')" title="Activate" style="color: var(--macos-green);">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-icon btn-small" onclick="AgentManager.deleteAgent('${agent.id}')" title="Delete" style="color: var(--macos-red);">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateCustomersTable() {
                const container = this.customersTable;
                if (!container) return;
                
                let customers = [...AppState.customers];
                
                // Apply search filter
                const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';
                if (searchTerm) {
                    customers = customers.filter(customer => 
                        (customer.fullName && customer.fullName.toLowerCase().includes(searchTerm)) ||
                        (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                        (customer.nrc && customer.nrc.toLowerCase().includes(searchTerm)) ||
                        (customer.phone && customer.phone.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Apply status filter
                const statusFilter = document.getElementById('customerStatusFilter')?.value || 'all';
                if (statusFilter !== 'all') {
                    customers = customers.filter(customer => customer.status === statusFilter);
                }
                
                if (customers.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-text-tertiary);">
                                    <i class="fas fa-users" style="font-size: 32px; margin-bottom: 12px;"></i>
                                    <p>No customers found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                customers.forEach(customer => {
                    const statusClass = `status-${customer.status || 'active'}`;
                    const statusText = (customer.status || 'active').charAt(0).toUpperCase() + (customer.status || 'active').slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${customer.id ? customer.id.substring(0, 8) : 'N/A'}</strong></td>
                            <td>${customer.fullName || 'N/A'}</td>
                            <td>${customer.email || 'N/A'}</td>
                            <td>${customer.phone || 'N/A'}</td>
                            <td>${customer.nrc || 'N/A'}</td>
                            <td>${customer.assignedAgentName || 'Not assigned'}</td>
                            <td>${customer.activeLoans || 0} / ${customer.totalLoans || 0}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-icon btn-small" onclick="CustomerManager.viewCustomerDetails('${customer.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-icon btn-small" onclick="CustomerManager.assignAgent('${customer.id}')" title="Assign Agent">
                                        <i class="fas fa-handshake"></i>
                                    </button>
                                    ${customer.status !== 'suspended' ? `
                                        <button class="btn btn-icon btn-small" onclick="CustomerManager.suspendCustomer('${customer.id}')" title="Suspend" style="color: var(--macos-orange);">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-icon btn-small" onclick="CustomerManager.activateCustomer('${customer.id}')" title="Activate" style="color: var(--macos-green);">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    ${customer.status !== 'banned' ? `
                                        <button class="btn btn-icon btn-small" onclick="CustomerManager.banCustomer('${customer.id}')" title="Ban" style="color: var(--macos-red);">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-icon btn-small" onclick="CustomerManager.unbanCustomer('${customer.id}')" title="Unban" style="color: var(--macos-green);">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateCommissionsTable() {
                const container = this.commissionsTable;
                if (!container) return;
                
                let commissions = [...AppState.commissions];
                
                // Apply search filter
                const searchTerm = document.getElementById('commissionSearch')?.value.toLowerCase() || '';
                if (searchTerm) {
                    commissions = commissions.filter(commission => 
                        (commission.agentName && commission.agentName.toLowerCase().includes(searchTerm)) ||
                        (commission.customerName && commission.customerName.toLowerCase().includes(searchTerm)) ||
                        (commission.id && commission.id.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Apply status filter
                const statusFilter = document.getElementById('commissionStatusFilter')?.value || 'all';
                if (statusFilter !== 'all') {
                    commissions = commissions.filter(commission => commission.status === statusFilter);
                }
                
                // Update commission stats
                const totalPending = commissions.filter(c => c.status === 'pending')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                const totalPaid = commissions.filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                
                document.getElementById('totalPendingCommission').textContent = Utils.formatCurrency(totalPending);
                document.getElementById('totalPaidCommission').textContent = Utils.formatCurrency(totalPaid);
                document.getElementById('commissionThisMonth').textContent = Utils.formatCurrency(totalPaid * 0.3); // Example calculation
                
                if (commissions.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-text-tertiary);">
                                    <i class="fas fa-money-check-alt" style="font-size: 32px; margin-bottom: 12px;"></i>
                                    <p>No commissions found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                commissions.forEach(commission => {
                    const statusClass = `status-${commission.status}`;
                    const statusText = commission.status.charAt(0).toUpperCase() + commission.status.slice(1);
                    
                    html += `
                        <tr>
                            <td><strong>${commission.id || 'N/A'}</strong></td>
                            <td>${commission.agentName || 'N/A'}</td>
                            <td>${commission.customerName || 'N/A'}</td>
                            <td>${Utils.formatCurrency(commission.loanAmount || 0)}</td>
                            <td>${commission.commissionRate || 2.5}%</td>
                            <td>${Utils.formatCurrency(commission.amount)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${commission.dueDate ? Utils.formatDateOnly(commission.dueDate) : 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    ${commission.status === 'pending' ? `
                                        <button class="btn btn-icon btn-small" onclick="CommissionManager.payCommission('${commission.id}')" title="Pay Commission" style="color: var(--macos-green);">
                                            <i class="fas fa-money-check"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-icon btn-small" onclick="CommissionManager.viewDetails('${commission.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateTransactionsTable() {
                const container = this.transactionsTable;
                if (!container) return;
                
                let transactions = [...AppState.transactions];
                
                if (transactions.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-text-tertiary);">
                                    <i class="fas fa-exchange-alt" style="font-size: 32px; margin-bottom: 12px;"></i>
                                    <p>No transactions found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                transactions.slice(0, 50).forEach(transaction => {
                    const typeClass = `status-${transaction.type === 'repayment' ? 'active' : transaction.type === 'commission' ? 'approved' : 'pending'}`;
                    
                    html += `
                        <tr>
                            <td><strong>${transaction.id || 'N/A'}</strong></td>
                            <td><span class="status-badge ${typeClass}">${transaction.type || 'N/A'}</span></td>
                            <td>${transaction.customerName || 'N/A'}</td>
                            <td>${transaction.agentName || 'N/A'}</td>
                            <td>${Utils.formatCurrency(transaction.amount)}</td>
                            <td>${Utils.formatDate(transaction.timestamp)}</td>
                            <td><span class="status-badge status-active">Completed</span></td>
                            <td>${transaction.reference || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            updateAuditTable() {
                const container = this.auditTable;
                if (!container) return;
                
                let logs = [...AppState.auditLogs];
                
                // Apply search filter
                const searchTerm = document.getElementById('auditSearch')?.value.toLowerCase() || '';
                if (searchTerm) {
                    logs = logs.filter(log => 
                        (log.userName && log.userName.toLowerCase().includes(searchTerm)) ||
                        (log.action && log.action.toLowerCase().includes(searchTerm)) ||
                        (log.data && JSON.stringify(log.data).toLowerCase().includes(searchTerm))
                    );
                }
                
                // Apply action filter
                const actionFilter = document.getElementById('auditActionFilter')?.value || 'all';
                if (actionFilter !== 'all') {
                    logs = logs.filter(log => log.action === actionFilter);
                }
                
                if (logs.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                <div style="color: var(--macos-text-tertiary);">
                                    <i class="fas fa-history" style="font-size: 32px; margin-bottom: 12px;"></i>
                                    <p>No audit logs found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                logs.slice(0, 50).forEach(log => {
                    let details = '';
                    if (log.data) {
                        if (typeof log.data === 'string') {
                            details = log.data;
                        } else {
                            details = JSON.stringify(log.data);
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>${log.userName || 'System'}</td>
                            <td>${log.action.replace(/_/g, ' ')}</td>
                            <td>${Utils.truncateText(details, 60)}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            performGlobalSearch() {
                const searchTerm = this.globalSearch.value.toLowerCase().trim();
                if (!searchTerm) return;
                
                // Search across all data
                const results = [];
                
                // Search loans
                AppState.loans.forEach(loan => {
                    if (
                        (loan.id && loan.id.toLowerCase().includes(searchTerm)) ||
                        (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                        (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm))
                    ) {
                        results.push({
                            type: 'loan',
                            id: loan.id,
                            name: loan.customerName,
                            description: `Loan ${Utils.formatCurrency(loan.amount)} - ${loan.status}`,
                            action: () => {
                                UIManager.showSection('loans');
                                LoanManager.viewLoanDetails(loan.id);
                            }
                        });
                    }
                });
                
                // Search agents
                AppState.agents.forEach(agent => {
                    if (
                        (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm)) ||
                        (agent.email && agent.email.toLowerCase().includes(searchTerm)) ||
                        (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm))
                    ) {
                        results.push({
                            type: 'agent',
                            id: agent.id,
                            name: agent.fullName,
                            description: `Agent ${agent.agentId} - ${agent.status}`,
                            action: () => {
                                UIManager.showSection('agents');
                                AgentManager.viewAgentDetails(agent.id);
                            }
                        });
                    }
                });
                
                // Search customers
                AppState.customers.forEach(customer => {
                    if (
                        (customer.fullName && customer.fullName.toLowerCase().includes(searchTerm)) ||
                        (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                        (customer.nrc && customer.nrc.toLowerCase().includes(searchTerm))
                    ) {
                        results.push({
                            type: 'customer',
                            id: customer.id,
                            name: customer.fullName,
                            description: `Customer - ${customer.status}`,
                            action: () => {
                                UIManager.showSection('customers');
                                CustomerManager.viewCustomerDetails(customer.id);
                            }
                        });
                    }
                });
                
                if (results.length > 0) {
                    // Show search results
                    Utils.showToast('Search Results', `Found ${results.length} matches`, 'info');
                    
                    // For now, just navigate to the first result
                    if (results[0]) {
                        results[0].action();
                    }
                } else {
                    Utils.showToast('No Results', 'No matches found for your search', 'warning');
                }
            },
            
            async saveSettings() {
                try {
                    const settings = {
                        maxLoanAmount: parseFloat(document.getElementById('maxLoanAmount').value),
                        minLoanAmount: parseFloat(document.getElementById('minLoanAmount').value),
                        defaultInterestRate: parseFloat(document.getElementById('defaultInterestRate').value),
                        agentCommissionRate: parseFloat(document.getElementById('agentCommissionRate').value),
                        maxLoanDuration: parseInt(document.getElementById('maxLoanDuration').value),
                        minLoanDuration: parseInt(document.getElementById('minLoanDuration').value),
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid
                    };
                    
                    await db.ref('systemSettings').set(settings);
                    await FirebaseService.createAuditLog('settings_updated', settings);
                    
                    Utils.showToast('Success', 'Settings saved successfully', 'success');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    Utils.showToast('Error', 'Failed to save settings', 'error');
                }
            }
        };

        // ===== LOAN MANAGER =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    // Load customer details
                    let customer = null;
                    if (loan.customerId) {
                        const customerRef = db.ref('users/' + loan.customerId);
                        const customerSnap = await customerRef.once('value');
                        if (customerSnap.exists()) {
                            customer = customerSnap.val();
                        }
                    }
                    
                    // Load agent details
                    let agent = null;
                    if (loan.agentId) {
                        const agentRef = db.ref('users/' + loan.agentId);
                        const agentSnap = await agentRef.once('value');
                        if (agentSnap.exists()) {
                            agent = agentSnap.val();
                        }
                    }
                    
                    this.displayLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loan details', 'error');
                }
            },
            
            displayLoanModal(loan, customer, agent) {
                const modal = document.getElementById('loanDetailModal');
                const content = document.getElementById('loanDetailContent');
                
                const statusClass = `status-${loan.status}`;
                const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                
                // Build repayment schedule HTML
                let repaymentScheduleHTML = '';
                if (loan.repaymentSchedule && loan.repaymentSchedule.length > 0) {
                    loan.repaymentSchedule.forEach((installment, index) => {
                        const isOverdue = new Date(installment.dueDate) < new Date() && !installment.paid;
                        const status = isOverdue ? 'overdue' : (installment.paid ? 'paid' : 'pending');
                        const statusClass = `status-${status}`;
                        
                        repaymentScheduleHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${Utils.formatDateOnly(installment.dueDate)}</td>
                                <td>${Utils.formatCurrency(installment.amount)}</td>
                                <td><span class="status-badge ${statusClass}">${status}</span></td>
                                <td>${installment.paidDate ? Utils.formatDateOnly(installment.paidDate) : '-'}</td>
                            </tr>
                        `;
                    });
                }
                
                // Build documents HTML
                let documentsHTML = '';
                if (loan.documents) {
                    const documentTypes = [
                        { key: 'nrcFront', label: 'NRC Front' },
                        { key: 'nrcBack', label: 'NRC Back' },
                        { key: 'profilePhoto', label: 'Profile Photo' },
                        { key: 'proofOfIncome', label: 'Proof of Income' },
                        { key: 'collateral', label: 'Collateral Photos' },
                        { key: 'other', label: 'Other Documents' }
                    ];
                    
                    documentTypes.forEach(docType => {
                        if (loan.documents[docType.key]) {
                            const urls = Array.isArray(loan.documents[docType.key]) 
                                ? loan.documents[docType.key] 
                                : [loan.documents[docType.key]];
                            
                            urls.forEach((url, index) => {
                                documentsHTML += `
                                    <div class="document-card">
                                        <div class="document-preview" onclick="DocumentManager.viewDocument('${url}', '${docType.label} ${index + 1}')">
                                            <img src="${url}" alt="${docType.label}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-file\\' style=\\'font-size: 32px; color: var(--macos-gray-4);\\'></i>';">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">${docType.label} ${urls.length > 1 ? index + 1 : ''}</div>
                                            <div class="document-type">Document</div>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                }
                
                // Build customer documents HTML
                let customerDocumentsHTML = '';
                if (customer) {
                    const customerDocs = [
                        { key: 'nrcFront', label: 'NRC Front', url: customer.nrcFront },
                        { key: 'nrcBack', label: 'NRC Back', url: customer.nrcBack },
                        { key: 'profilePhoto', label: 'Profile Photo', url: customer.profilePhoto }
                    ];
                    
                    customerDocs.forEach(doc => {
                        if (doc.url) {
                            customerDocumentsHTML += `
                                <div class="document-card">
                                    <div class="document-preview" onclick="DocumentManager.viewDocument('${doc.url}', 'Customer ${doc.label}')">
                                        <img src="${doc.url}" alt="${doc.label}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-file\\' style=\\'font-size: 32px; color: var(--macos-gray-4);\\'></i>';">
                                    </div>
                                    <div class="document-info">
                                        <div class="document-title">Customer ${doc.label}</div>
                                        <div class="document-type">Document</div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div class="detail-avatar">
                                <i class="fas fa-file-invoice-dollar" style="font-size: 32px; color: var(--macos-gray-4);"></i>
                            </div>
                            <div class="detail-info">
                                <div class="detail-name">Loan ${loan.id}</div>
                                <div class="detail-subtitle">
                                    ${customer ? customer.fullName : 'Unknown Customer'} | 
                                    ${agent ? agent.fullName : 'No Agent'} |
                                    Applied: ${Utils.formatDate(loan.createdAt)}
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">${Utils.formatCurrency(loan.amount)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Interest Rate</div>
                                <div class="detail-value">${loan.interestRate || 15}%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Duration</div>
                                <div class="detail-value">${loan.duration} months</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Monthly Payment</div>
                                <div class="detail-value">${Utils.formatCurrency(loan.monthlyPayment)}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Loan Purpose</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                ${loan.purpose || 'No purpose specified'}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Repayment Schedule</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Due Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Paid Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${repaymentScheduleHTML || `
                                            <tr>
                                                <td colspan="5" style="text-align: center; padding: 20px;">
                                                    No repayment schedule available
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Loan Documents</h4>
                            <div class="documents-grid">
                                ${documentsHTML || '<p class="text-muted">No documents uploaded</p>'}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Customer Documents</h4>
                            <div class="documents-grid">
                                ${customerDocumentsHTML || '<p class="text-muted">No customer documents available</p>'}
                            </div>
                        </div>
                        
                        ${loan.status === 'pending' ? `
                            <div class="modal-footer">
                                <button class="btn btn-outline" onclick="ModalManager.closeLoanModal()">Close</button>
                                <button class="btn btn-success" onclick="LoanManager.approveLoan('${loan.id}')">
                                    <i class="fas fa-check"></i> Approve Loan
                                </button>
                                <button class="btn btn-danger" onclick="LoanManager.rejectLoan('${loan.id}')">
                                    <i class="fas fa-times"></i> Reject Loan
                                </button>
                            </div>
                        ` : `
                            <div class="modal-footer">
                                <button class="btn btn-outline" onclick="ModalManager.closeLoanModal()">Close</button>
                            </div>
                        `}
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async approveLoan(loanId) {
                const reason = prompt('Enter approval notes (optional):');
                if (reason === null) return; // User cancelled
                
                Utils.showLoading('Approving loan...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'approved', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Loan approved successfully', 'success');
                    ModalManager.closeLoanModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async rejectLoan(loanId) {
                const reason = prompt('Enter rejection reason (required):');
                if (!reason) {
                    Utils.showToast('Error', 'Rejection reason is required', 'error');
                    return;
                }
                
                Utils.showLoading('Rejecting loan...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'rejected', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Loan rejected successfully', 'success');
                    ModalManager.closeLoanModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            }
        };

        // ===== AGENT MANAGER =====
        const AgentManager = {
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    agent.id = agentId;
                    
                    // Load agent's customers
                    const customersSnapshot = await db.ref('users')
                        .orderByChild('assignedAgentId')
                        .equalTo(agentId)
                        .once('value');
                    
                    const customers = [];
                    customersSnapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        if (customer.userType === 'customer') {
                            customers.push(customer);
                        }
                    });
                    
                    // Load agent's loans
                    const loansSnapshot = await db.ref('loans')
                        .orderByChild('agentId')
                        .equalTo(agentId)
                        .once('value');
                    
                    const loans = [];
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loans.push(loan);
                    });
                    
                    this.displayAgentModal(agent, customers, loans);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load agent details', 'error');
                }
            },
            
            displayAgentModal(agent, customers, loans) {
                const modal = document.getElementById('agentDetailModal');
                const content = document.getElementById('agentDetailContent');
                
                const statusClass = `status-${agent.status || 'active'}`;
                const statusText = (agent.status || 'active').charAt(0).toUpperCase() + (agent.status || 'active').slice(1);
                
                // Build documents HTML
                let documentsHTML = '';
                const agentDocs = [
                    { key: 'nrcFront', label: 'NRC Front', url: agent.nrcFront },
                    { key: 'nrcBack', label: 'NRC Back', url: agent.nrcBack },
                    { key: 'profilePhoto', label: 'Profile Photo', url: agent.profilePhoto }
                ];
                
                agentDocs.forEach(doc => {
                    if (doc.url) {
                        documentsHTML += `
                            <div class="document-card">
                                <div class="document-preview" onclick="DocumentManager.viewDocument('${doc.url}', 'Agent ${doc.label}')">
                                    <img src="${doc.url}" alt="${doc.label}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-file\\' style=\\'font-size: 32px; color: var(--macos-gray-4);\\'></i>';">
                                </div>
                                <div class="document-info">
                                    <div class="document-title">${doc.label}</div>
                                    <div class="document-type">Document</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div class="detail-avatar">
                                ${agent.profilePhoto ? 
                                    `<img src="${agent.profilePhoto}" alt="${agent.fullName}">` : 
                                    `<i class="fas fa-user-tie" style="font-size: 32px; color: var(--macos-gray-4);"></i>`
                                }
                            </div>
                            <div class="detail-info">
                                <div class="detail-name">${agent.fullName || 'Unknown Agent'}</div>
                                <div class="detail-subtitle">
                                    ${agent.email || 'No email'} | 
                                    ${agent.phone || 'No phone'} |
                                    Agent ID: ${agent.agentId || 'N/A'}
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Total Customers</div>
                                <div class="detail-value">${agent.totalCustomers || 0}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Loans</div>
                                <div class="detail-value">${agent.totalLoans || 0}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Total Commission</div>
                                <div class="detail-value">${Utils.formatCurrency(agent.totalCommission || 0)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Commission Rate</div>
                                <div class="detail-value">${agent.commissionRate || 2.5}%</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Agent Documents</h4>
                            <div class="documents-grid">
                                ${documentsHTML || '<p class="text-muted">No documents available</p>'}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Assigned Customers (${customers.length})</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Active Loans</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customers.slice(0, 5).map(customer => `
                                            <tr onclick="CustomerManager.viewCustomerDetails('${customer.uid}')" style="cursor: pointer;">
                                                <td>${customer.fullName}</td>
                                                <td>${customer.email}</td>
                                                <td>${customer.phone}</td>
                                                <td>${customer.activeLoans || 0}</td>
                                                <td><span class="status-badge status-${customer.status || 'active'}">${customer.status || 'active'}</span></td>
                                            </tr>
                                        `).join('')}
                                        ${customers.length === 0 ? `
                                            <tr>
                                                <td colspan="5" style="text-align: center; padding: 20px;">
                                                    No customers assigned
                                                </td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="ModalManager.closeAgentModal()">Close</button>
                            ${agent.status !== 'suspended' ? `
                                <button class="btn btn-warning" onclick="AgentManager.suspendAgent('${agent.id}')">
                                    <i class="fas fa-pause"></i> Suspend Agent
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="AgentManager.activateAgent('${agent.id}')">
                                    <i class="fas fa-play"></i> Activate Agent
                                </button>
                            `}
                            <button class="btn btn-danger" onclick="AgentManager.deleteAgent('${agent.id}')">
                                <i class="fas fa-trash"></i> Delete Agent
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            showPendingApplications() {
                const modal = document.getElementById('pendingApplicationsModal');
                const container = document.getElementById('pendingApplicationsList');
                
                if (AppState.pendingApplications.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3 style="font-weight: 500; margin-bottom: 8px;">No Pending Applications</h3>
                            <p>There are no agent applications pending review.</p>
                        </div>
                    `;
                    modal.classList.add('active');
                    return;
                }
                
                let html = '';
                AppState.pendingApplications.forEach(app => {
                    html += `
                        <div class="application-card" style="margin-bottom: 16px; border: 1px solid var(--macos-gray-2); border-radius: var(--macos-radius-md); padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <h4 style="font-weight: 600; margin-bottom: 4px;">${app.fullName}</h4>
                                    <p style="font-size: 14px; color: var(--macos-text-tertiary);">${app.phone} | ${app.nrc}</p>
                                </div>
                                <span class="status-badge status-pending">Pending</span>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <p style="font-size: 14px; color: var(--macos-text-secondary);">${app.residence}</p>
                            </div>
                            
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                ${app.nrcFront ? `
                                    <button class="btn btn-outline btn-small" onclick="DocumentManager.viewDocument('${app.nrcFront}', 'NRC Front - ${app.fullName}')">
                                        <i class="fas fa-id-card"></i> NRC Front
                                    </button>
                                ` : ''}
                                ${app.nrcBack ? `
                                    <button class="btn btn-outline btn-small" onclick="DocumentManager.viewDocument('${app.nrcBack}', 'NRC Back - ${app.fullName}')">
                                        <i class="fas fa-id-card"></i> NRC Back
                                    </button>
                                ` : ''}
                                ${app.profilePhoto ? `
                                    <button class="btn btn-outline btn-small" onclick="DocumentManager.viewDocument('${app.profilePhoto}', 'Profile - ${app.fullName}')">
                                        <i class="fas fa-user"></i> Profile
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success btn-small" onclick="AgentManager.approveApplication('${app.id}')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-danger btn-small" onclick="AgentManager.rejectApplication('${app.id}')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                modal.classList.add('active');
            },
            
            approveApplication(applicationId) {
                const application = AppState.pendingApplications.find(app => app.id === applicationId);
                if (!application) return;
                
                // Store the application for later use
                AppState.selectedApplication = application;
                
                // Populate the approve agent form
                document.getElementById('applicantName').textContent = application.fullName;
                document.getElementById('applicantNRC').textContent = application.nrc;
                
                const modal = document.getElementById('approveAgentModal');
                modal.classList.add('active');
                
                // Close the pending applications modal
                ModalManager.closePendingApplicationsModal();
            },
            
            async approveAgent() {
                const agentId = document.getElementById('agentCustomId').value.trim();
                const email = document.getElementById('agentEmail').value.trim();
                const password = document.getElementById('agentPassword').value;
                const confirmPassword = document.getElementById('agentConfirmPassword').value;
                const branch = document.getElementById('agentBranch').value;
                const notes = document.getElementById('agentNotes').value.trim();
                
                // Validation
                if (!agentId || !email || !password || !confirmPassword) {
                    Utils.showToast('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    Utils.showToast('Error', 'Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    Utils.showToast('Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(email)) {
                    Utils.showToast('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                Utils.showLoading('Creating agent account...');
                
                const agentData = {
                    ...AppState.selectedApplication,
                    agentId: agentId,
                    email: email,
                    password: password,
                    branch: branch,
                    applicationId: AppState.selectedApplication.id
                };
                
                const result = await FirebaseService.createAgentAccount(agentData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent approved and account created', 'success');
                    ModalManager.closeApproveAgentModal();
                    
                    // Refresh agents list
                    await FirebaseService.loadAgents();
                    UIManager.updateAgentsTable();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async rejectApplication(applicationId) {
                const reason = prompt('Enter rejection reason (required):');
                if (!reason) {
                    Utils.showToast('Error', 'Rejection reason is required', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to reject this application?')) return;
                
                Utils.showLoading('Rejecting application...');
                
                try {
                    await db.ref('agentApplications/' + applicationId).update({
                        status: 'rejected',
                        rejectedAt: Date.now(),
                        rejectedBy: AppState.currentUser.uid,
                        rejectedByName: AppState.adminData.fullName,
                        rejectionReason: reason
                    });
                    
                    Utils.showToast('Success', 'Application rejected', 'success');
                    
                    // Refresh pending applications
                    await FirebaseService.loadPendingApplications();
                    
                    // Update UI
                    if (document.getElementById('pendingApplicationsModal').classList.contains('active')) {
                        AgentManager.showPendingApplications();
                    }
                } catch (error) {
                    console.error('Error rejecting application:', error);
                    Utils.showToast('Error', 'Failed to reject application', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            createNewAgent() {
                // Clear form
                document.getElementById('createAgentForm').reset();
                
                const modal = document.getElementById('createAgentModal');
                modal.classList.add('active');
            },
            
            async createAgent() {
                const name = document.getElementById('newAgentName').value.trim();
                const phone = document.getElementById('newAgentPhone').value.trim();
                const email = document.getElementById('newAgentEmail').value.trim();
                const password = document.getElementById('newAgentPassword').value;
                const confirmPassword = document.getElementById('newAgentConfirmPassword').value;
                const agentId = document.getElementById('newAgentId').value.trim();
                const nrc = document.getElementById('newAgentNRC').value.trim();
                const address = document.getElementById('newAgentAddress').value.trim();
                const branch = document.getElementById('newAgentBranch').value;
                const commissionRate = parseFloat(document.getElementById('newAgentCommission').value);
                
                // Validation
                if (!name || !phone || !email || !password || !confirmPassword || !agentId || !nrc) {
                    Utils.showToast('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    Utils.showToast('Error', 'Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    Utils.showToast('Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(email)) {
                    Utils.showToast('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                if (!Utils.validateNRC(nrc)) {
                    Utils.showToast('Error', 'Please enter valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                Utils.showLoading('Creating agent...');
                
                const agentData = {
                    fullName: name,
                    phone: phone,
                    email: email,
                    password: password,
                    agentId: agentId,
                    nrc: nrc,
                    address: address,
                    branch: branch,
                    commissionRate: commissionRate
                };
                
                const result = await FirebaseService.createAgentAccount(agentData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent created successfully', 'success');
                    ModalManager.closeCreateAgentModal();
                    
                    // Refresh agents list
                    await FirebaseService.loadAgents();
                    UIManager.updateAgentsTable();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async suspendAgent(agentId) {
                const reason = prompt('Enter suspension reason (optional):');
                
                Utils.showLoading('Suspending agent...');
                
                const result = await FirebaseService.updateAgentStatus(agentId, 'suspended', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent suspended', 'success');
                    ModalManager.closeAgentModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async activateAgent(agentId) {
                Utils.showLoading('Activating agent...');
                
                const result = await FirebaseService.updateAgentStatus(agentId, 'active', '');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent activated', 'success');
                    ModalManager.closeAgentModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async deleteAgent(agentId) {
                if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                    return;
                }
                
                Utils.showLoading('Deleting agent...');
                
                try {
                    // First, check if agent has assigned customers
                    const customersSnapshot = await db.ref('users')
                        .orderByChild('assignedAgentId')
                        .equalTo(agentId)
                        .once('value');
                    
                    if (customersSnapshot.exists()) {
                        Utils.showToast('Warning', 'Agent has assigned customers. Please reassign them first.', 'warning');
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Delete agent from users
                    await db.ref('users/' + agentId).remove();
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('agent_deleted', {
                        agentId: agentId
                    });
                    
                    Utils.showToast('Success', 'Agent deleted successfully', 'success');
                    ModalManager.closeAgentModal();
                    
                    // Refresh agents list
                    await FirebaseService.loadAgents();
                    UIManager.updateAgentsTable();
                } catch (error) {
                    console.error('Error deleting agent:', error);
                    Utils.showToast('Error', 'Failed to delete agent', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== CUSTOMER MANAGER =====
        const CustomerManager = {
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    customer.id = customerId;
                    
                    // Load assigned agent
                    let agent = null;
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        const agentSnap = await agentRef.once('value');
                        if (agentSnap.exists()) {
                            agent = agentSnap.val();
                        }
                    }
                    
                    // Load customer's loans
                    const loansSnapshot = await db.ref('loans')
                        .orderByChild('customerId')
                        .equalTo(customerId)
                        .once('value');
                    
                    const loans = [];
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loans.push(loan);
                    });
                    
                    this.displayCustomerModal(customer, agent, loans);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load customer details', 'error');
                }
            },
            
            displayCustomerModal(customer, agent, loans) {
                const modal = document.getElementById('customerDetailModal');
                const content = document.getElementById('customerDetailContent');
                
                const statusClass = `status-${customer.status || 'active'}`;
                const statusText = (customer.status || 'active').charAt(0).toUpperCase() + (customer.status || 'active').slice(1);
                
                // Build documents HTML
                let documentsHTML = '';
                const customerDocs = [
                    { key: 'nrcFront', label: 'NRC Front', url: customer.nrcFront },
                    { key: 'nrcBack', label: 'NRC Back', url: customer.nrcBack },
                    { key: 'profilePhoto', label: 'Profile Photo', url: customer.profilePhoto },
                    { key: 'proofOfIncome', label: 'Proof of Income', url: customer.proofOfIncome }
                ];
                
                customerDocs.forEach(doc => {
                    if (doc.url) {
                        documentsHTML += `
                            <div class="document-card">
                                <div class="document-preview" onclick="DocumentManager.viewDocument('${doc.url}', '${doc.label}')">
                                    <img src="${doc.url}" alt="${doc.label}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-file\\' style=\\'font-size: 32px; color: var(--macos-gray-4);\\'></i>';">
                                </div>
                                <div class="document-info">
                                    <div class="document-title">${doc.label}</div>
                                    <div class="document-type">Document</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div class="detail-avatar">
                                ${customer.profilePhoto ? 
                                    `<img src="${customer.profilePhoto}" alt="${customer.fullName}">` : 
                                    `<i class="fas fa-user" style="font-size: 32px; color: var(--macos-gray-4);"></i>`
                                }
                            </div>
                            <div class="detail-info">
                                <div class="detail-name">${customer.fullName || 'Unknown Customer'}</div>
                                <div class="detail-subtitle">
                                    ${customer.email || 'No email'} | 
                                    ${customer.phone || 'No phone'} |
                                    NRC: ${customer.nrc || 'N/A'}
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Assigned Agent</div>
                                <div class="detail-value">${agent ? agent.fullName : 'Not assigned'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Occupation</div>
                                <div class="detail-value">${customer.occupation || 'N/A'}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Monthly Income</div>
                                <div class="detail-value">${Utils.formatCurrency(customer.monthlyIncome || 0)}</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Active Loans</div>
                                <div class="detail-value">${customer.activeLoans || 0}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Address</h4>
                            <div style="background: var(--macos-gray-1); padding: 16px; border-radius: var(--macos-radius-md);">
                                ${customer.residence || 'No address provided'}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Customer Documents</h4>
                            <div class="documents-grid">
                                ${documentsHTML || '<p class="text-muted">No documents available</p>'}
                            </div>
                        </div>
                        
                        <div style="margin: 24px 0;">
                            <h4 style="margin-bottom: 12px;">Loan History (${loans.length})</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Loan ID</th>
                                            <th>Amount</th>
                                            <th>Purpose</th>
                                            <th>Status</th>
                                            <th>Applied Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${loans.slice(0, 5).map(loan => `
                                            <tr onclick="LoanManager.viewLoanDetails('${loan.id}')" style="cursor: pointer;">
                                                <td>${loan.id}</td>
                                                <td>${Utils.formatCurrency(loan.amount)}</td>
                                                <td>${Utils.truncateText(loan.purpose, 30)}</td>
                                                <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                                                <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                                            </tr>
                                        `).join('')}
                                        ${loans.length === 0 ? `
                                            <tr>
                                                <td colspan="5" style="text-align: center; padding: 20px;">
                                                    No loan history
                                                </td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="ModalManager.closeCustomerModal()">Close</button>
                            <button class="btn btn-primary" onclick="CustomerManager.assignAgent('${customer.id}')">
                                <i class="fas fa-handshake"></i> Assign Agent
                            </button>
                            ${customer.status !== 'suspended' ? `
                                <button class="btn btn-warning" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                    <i class="fas fa-pause"></i> Suspend
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                    <i class="fas fa-play"></i> Activate
                                </button>
                            `}
                            ${customer.status !== 'banned' ? `
                                <button class="btn btn-danger" onclick="CustomerManager.banCustomer('${customer.id}')">
                                    <i class="fas fa-ban"></i> Ban
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="CustomerManager.unbanCustomer('${customer.id}')">
                                    <i class="fas fa-check"></i> Unban
                                </button>
                            `}
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            createNewCustomer() {
                // Clear form
                document.getElementById('createCustomerForm').reset();
                
                // Populate agent dropdown
                const agentSelect = document.getElementById('newCustomerAgent');
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                
                AppState.agents
                    .filter(agent => agent.status === 'active')
                    .forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.fullName} (${agent.agentId})`;
                        agentSelect.appendChild(option);
                    });
                
                const modal = document.getElementById('createCustomerModal');
                modal.classList.add('active');
            },
            
            async createCustomer() {
                const name = document.getElementById('newCustomerName').value.trim();
                const phone = document.getElementById('newCustomerPhone').value.trim();
                const email = document.getElementById('newCustomerEmail').value.trim();
                const password = document.getElementById('newCustomerPassword').value;
                const nrc = document.getElementById('newCustomerNRC').value.trim();
                const dob = document.getElementById('newCustomerDOB').value;
                const address = document.getElementById('newCustomerAddress').value.trim();
                const occupation = document.getElementById('newCustomerOccupation').value.trim();
                const income = parseFloat(document.getElementById('newCustomerIncome').value) || 0;
                const agentId = document.getElementById('newCustomerAgent').value;
                const notes = document.getElementById('newCustomerNotes').value.trim();
                
                // Validation
                if (!name || !phone || !email || !password || !nrc || !address) {
                    Utils.showToast('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(email)) {
                    Utils.showToast('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                if (!Utils.validateNRC(nrc)) {
                    Utils.showToast('Error', 'Please enter valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                Utils.showLoading('Creating customer...');
                
                const customerData = {
                    fullName: name,
                    phone: phone,
                    email: email,
                    password: password,
                    nrc: nrc,
                    dateOfBirth: dob,
                    address: address,
                    occupation: occupation,
                    monthlyIncome: income,
                    assignedAgentId: agentId
                };
                
                const result = await FirebaseService.createCustomerAccount(customerData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer created successfully', 'success');
                    ModalManager.closeCreateCustomerModal();
                    
                    // Refresh customers list
                    await FirebaseService.loadCustomers();
                    UIManager.updateCustomersTable();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            assignAgent(customerId) {
                AppState.selectedCustomer = customerId;
                
                // Get customer name
                const customer = AppState.customers.find(c => c.id === customerId);
                if (!customer) return;
                
                // Populate form
                document.getElementById('assignCustomerName').textContent = customer.fullName;
                document.getElementById('currentAgentName').textContent = customer.assignedAgentName || 'Not assigned';
                
                // Populate agent dropdown
                const agentSelect = document.getElementById('newAgentSelect');
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                
                AppState.agents
                    .filter(agent => agent.status === 'active')
                    .forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.fullName} (${agent.agentId})`;
                        agentSelect.appendChild(option);
                    });
                
                // Preselect current agent if exists
                if (customer.assignedAgentId) {
                    agentSelect.value = customer.assignedAgentId;
                }
                
                const modal = document.getElementById('assignAgentModal');
                modal.classList.add('active');
            },
            
            async suspendCustomer(customerId) {
                const reason = prompt('Enter suspension reason (optional):');
                
                Utils.showLoading('Suspending customer...');
                
                const result = await FirebaseService.updateCustomerStatus(customerId, 'suspended', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer suspended', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async activateCustomer(customerId) {
                Utils.showLoading('Activating customer...');
                
                const result = await FirebaseService.updateCustomerStatus(customerId, 'active', '');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer activated', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async banCustomer(customerId) {
                const reason = prompt('Enter ban reason (required):');
                if (!reason) {
                    Utils.showToast('Error', 'Ban reason is required', 'error');
                    return;
                }
                
                Utils.showLoading('Banning customer...');
                
                const result = await FirebaseService.updateCustomerStatus(customerId, 'banned', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer banned', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async unbanCustomer(customerId) {
                Utils.showLoading('Unbanning customer...');
                
                const result = await FirebaseService.updateCustomerStatus(customerId, 'active', '');
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer unbanned', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            }
        };

        // ===== COMMISSION MANAGER =====
        const CommissionManager = {
            async payCommission(commissionId) {
                const commission = AppState.commissions.find(c => c.id === commissionId);
                if (!commission) return;
                
                AppState.selectedCommission = commission;
                
                // Populate form
                document.getElementById('commissionAgentName').textContent = commission.agentName;
                document.getElementById('commissionAmount').textContent = Utils.formatCurrency(commission.amount);
                document.getElementById('commissionLoanId').textContent = commission.loanId || 'N/A';
                document.getElementById('commissionPaymentDate').value = new Date().toISOString().split('T')[0];
                
                const modal = document.getElementById('commissionPaymentModal');
                modal.classList.add('active');
            },
            
            async processPayment() {
                const method = document.getElementById('commissionPaymentMethod').value;
                const reference = document.getElementById('commissionReference').value.trim();
                const date = document.getElementById('commissionPaymentDate').value;
                const notes = document.getElementById('commissionNotes').value.trim();
                
                if (!method || !reference) {
                    Utils.showToast('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                Utils.showLoading('Processing payment...');
                
                const paymentData = {
                    method: method,
                    reference: reference,
                    date: date,
                    notes: notes
                };
                
                const result = await FirebaseService.updateCommissionStatus(
                    AppState.selectedCommission.id,
                    'paid',
                    paymentData
                );
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Commission marked as paid', 'success');
                    ModalManager.closeCommissionPaymentModal();
                    
                    // Refresh commissions
                    await FirebaseService.loadCommissions();
                    UIManager.updateCommissionsTable();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            },
            
            async viewDetails(commissionId) {
                const commission = AppState.commissions.find(c => c.id === commissionId);
                if (!commission) return;
                
                let details = `Commission: ${Utils.formatCurrency(commission.amount)}\n`;
                details += `Status: ${commission.status}\n`;
                details += `Agent: ${commission.agentName}\n`;
                details += `Customer: ${commission.customerName}\n`;
                
                if (commission.paidAt) {
                    details += `Paid: ${Utils.formatDate(commission.paidAt)}\n`;
                    details += `Method: ${commission.paymentMethod}\n`;
                    details += `Reference: ${commission.paymentReference}\n`;
                }
                
                alert(details);
            }
        };

        // ===== ASSIGNMENT MANAGER =====
        const AssignmentManager = {
            async assignAgent() {
                const customerId = AppState.selectedCustomer;
                const agentId = document.getElementById('newAgentSelect').value;
                const reason = document.getElementById('assignmentReason').value.trim();
                
                if (!agentId) {
                    Utils.showToast('Error', 'Please select an agent', 'error');
                    return;
                }
                
                Utils.showLoading('Assigning agent...');
                
                const result = await FirebaseService.assignAgentToCustomer(customerId, agentId, reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent assigned successfully', 'success');
                    ModalManager.closeAssignAgentModal();
                    ModalManager.closeCustomerModal();
                    
                    // Refresh data
                    await FirebaseService.loadCustomers();
                    await FirebaseService.loadAgents();
                    UIManager.updateCustomersTable();
                    UIManager.updateAgentsTable();
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            }
        };

        // ===== DOCUMENT MANAGER =====
        const DocumentManager = {
            viewDocument(url, title) {
                document.getElementById('documentTitle').textContent = title || 'Document';
                document.getElementById('documentImage').src = url;
                document.getElementById('documentDownload').href = url;
                
                const modal = document.getElementById('documentViewerModal');
                modal.classList.add('active');
            }
        };

        // ===== NOTIFICATION MANAGER =====
        const NotificationManager = {
            showNotifications() {
                const modal = document.getElementById('notificationsModal');
                const container = document.getElementById('notificationsList');
                
                if (AppState.notifications.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--macos-text-tertiary);">
                            <i class="fas fa-bell" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3 style="font-weight: 500; margin-bottom: 8px;">No Notifications</h3>
                            <p>You're all caught up!</p>
                        </div>
                    `;
                    modal.classList.add('active');
                    return;
                }
                
                let html = '';
                AppState.notifications.slice(0, 20).forEach(notification => {
                    let icon = 'fa-info-circle';
                    let title = 'Notification';
                    let message = '';
                    
                    switch(notification.type) {
                        case 'loan_submitted':
                            icon = 'fa-file-invoice-dollar';
                            title = 'New Loan Application';
                            message = `Loan ${notification.data.loanId} submitted`;
                            break;
                        case 'agent_application':
                            icon = 'fa-user-tie';
                            title = 'New Agent Application';
                            message = `Application from ${notification.data.applicantName}`;
                            break;
                        default:
                            message = notification.data ? JSON.stringify(notification.data) : 'New notification';
                    }
                    
                    const isUnread = !notification.read;
                    
                    html += `
                        <div class="activity-item ${isUnread ? 'unread' : ''}" onclick="NotificationManager.markAsRead('${notification.id}')" style="cursor: pointer;">
                            <div class="activity-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${title}: ${message}</div>
                                <div class="activity-time">${Utils.formatDate(notification.timestamp)}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                modal.classList.add('active');
            },
            
            async markAsRead(notificationId) {
                await FirebaseService.markNotificationAsRead(notificationId);
                
                // Update local state
                const notification = AppState.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.showNotifications(); // Refresh view
                }
            },
            
            async markAllAsRead() {
                await FirebaseService.markAllNotificationsAsRead();
                
                // Update local state
                AppState.notifications.forEach(n => n.read = true);
                this.showNotifications(); // Refresh view
                
                Utils.showToast('Success', 'All notifications marked as read', 'success');
            }
        };

        // ===== AUDIT MANAGER =====
        const AuditManager = {
            viewFullAudit() {
                UIManager.showSection('audit');
            },
            
            async exportAuditLog() {
                try {
                    const data = AppState.auditLogs.map(log => ({
                        timestamp: Utils.formatDate(log.timestamp),
                        user: log.userName,
                        action: log.action,
                        details: JSON.stringify(log.data),
                        ip: log.ipAddress
                    }));
                    
                    const csv = this.convertToCSV(data);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.showToast('Success', 'Audit log exported', 'success');
                } catch (error) {
                    console.error('Error exporting audit log:', error);
                    Utils.showToast('Error', 'Failed to export audit log', 'error');
                }
            },
            
            convertToCSV(data) {
                const headers = ['Timestamp', 'User', 'Action', 'Details', 'IP Address'];
                const rows = data.map(row => [
                    `"${row.timestamp}"`,
                    `"${row.user}"`,
                    `"${row.action}"`,
                    `"${row.details}"`,
                    `"${row.ip}"`
                ]);
                
                return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            }
        };

        // ===== REPORT MANAGER =====
        const ReportManager = {
            async generateReport() {
                const period = document.getElementById('reportPeriod').value;
                
                Utils.showLoading('Generating report...');
                
                try {
                    // Simulate report generation
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const reportData = {
                        period: period,
                        totalLoans: AppState.loans.length,
                        totalAgents: AppState.agents.filter(a => a.status === 'active').length,
                        totalCustomers: AppState.customers.length,
                        totalCommission: AppState.commissions
                            .filter(c => c.status === 'paid')
                            .reduce((sum, com) => sum + (com.amount || 0), 0),
                        generatedAt: new Date().toISOString(),
                        generatedBy: AppState.adminData.fullName
                    };
                    
                    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `report-${period}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.showToast('Success', 'Report generated and downloaded', 'success');
                } catch (error) {
                    console.error('Error generating report:', error);
                    Utils.showToast('Error', 'Failed to generate report', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== TRANSACTION MANAGER =====
        const TransactionManager = {
            async exportTransactions() {
                try {
                    const data = AppState.transactions.map(tx => ({
                        id: tx.id,
                        type: tx.type,
                        customer: tx.customerName,
                        agent: tx.agentName,
                        amount: tx.amount,
                        date: Utils.formatDate(tx.timestamp),
                        status: tx.status,
                        reference: tx.reference
                    }));
                    
                    const csv = this.convertToCSV(data);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `transactions-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.showToast('Success', 'Transactions exported', 'success');
                } catch (error) {
                    console.error('Error exporting transactions:', error);
                    Utils.showToast('Error', 'Failed to export transactions', 'error');
                }
            },
            
            convertToCSV(data) {
                const headers = ['ID', 'Type', 'Customer', 'Agent', 'Amount', 'Date', 'Status', 'Reference'];
                const rows = data.map(row => [
                    `"${row.id}"`,
                    `"${row.type}"`,
                    `"${row.customer}"`,
                    `"${row.agent}"`,
                    `"${row.amount}"`,
                    `"${row.date}"`,
                    `"${row.status}"`,
                    `"${row.reference}"`
                ]);
                
                return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            }
        };

        // ===== MODAL MANAGER =====
        const ModalManager = {
            closeLoanModal() {
                document.getElementById('loanDetailModal').classList.remove('active');
            },
            
            closeAgentModal() {
                document.getElementById('agentDetailModal').classList.remove('active');
            },
            
            closeCustomerModal() {
                document.getElementById('customerDetailModal').classList.remove('active');
            },
            
            closeApproveAgentModal() {
                document.getElementById('approveAgentModal').classList.remove('active');
                document.getElementById('approveAgentForm').reset();
                AppState.selectedApplication = null;
            },
            
            closeCreateAgentModal() {
                document.getElementById('createAgentModal').classList.remove('active');
                document.getElementById('createAgentForm').reset();
            },
            
            closeCreateCustomerModal() {
                document.getElementById('createCustomerModal').classList.remove('active');
                document.getElementById('createCustomerForm').reset();
            },
            
            closeDocumentViewer() {
                document.getElementById('documentViewerModal').classList.remove('active');
            },
            
            closeCommissionPaymentModal() {
                document.getElementById('commissionPaymentModal').classList.remove('active');
                document.getElementById('commissionPaymentForm').reset();
                AppState.selectedCommission = null;
            },
            
            closeAssignAgentModal() {
                document.getElementById('assignAgentModal').classList.remove('active');
                document.getElementById('assignAgentForm').reset();
                AppState.selectedCustomer = null;
            },
            
            closeNotificationsModal() {
                document.getElementById('notificationsModal').classList.remove('active');
            },
            
            closePendingApplicationsModal() {
                document.getElementById('pendingApplicationsModal').classList.remove('active');
            }
        };

        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Close modals on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        activeModal.classList.remove('active');
                    }
                }
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024) {
                    const sidebar = document.getElementById('sidebar');
                    const toggle = document.getElementById('mobileMenuToggle');
                    
                    if (sidebar.classList.contains('active') && 
                        !sidebar.contains(e.target) && 
                        !toggle.contains(e.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });
        });

        // ===== GLOBAL ACCESS =====
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.CommissionManager = CommissionManager;
        window.AssignmentManager = AssignmentManager;
        window.DocumentManager = DocumentManager;
        window.NotificationManager = NotificationManager;
        window.AuditManager = AuditManager;
        window.ReportManager = ReportManager;
        window.TransactionManager = TransactionManager;
        window.ModalManager = ModalManager;
        window.Utils = Utils;
    </script>
</body>
</html>
