<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== MAC OS THEME VARIABLES ===== */
        :root {
            /* Mac OS Colors */
            --macos-gray-1: #f5f5f7;
            --macos-gray-2: #e8e8ed;
            --macos-gray-3: #d2d2d7;
            --macos-gray-4: #8e8e93;
            --macos-gray-5: #48484a;
            --macos-gray-6: #1d1d1f;
            
            /* System Colors */
            --macos-blue: #007AFF;
            --macos-green: #34C759;
            --macos-red: #FF3B30;
            --macos-orange: #FF9500;
            --macos-yellow: #FFCC00;
            --macos-purple: #AF52DE;
            --macos-pink: #FF2D55;
            
            /* Background */
            --macos-bg-primary: #ffffff;
            --macos-bg-secondary: #f2f2f7;
            --macos-bg-tertiary: #e5e5ea;
            
            /* Text */
            --macos-text-primary: #1d1d1f;
            --macos-text-secondary: #8e8e93;
            --macos-text-tertiary: #c7c7cc;
            
            /* Borders */
            --macos-border-light: #e5e5ea;
            --macos-border-medium: #d1d1d6;
            --macos-border-heavy: #c7c7cc;
            
            /* Shadows */
            --macos-shadow-light: 0 2px 10px rgba(0, 0, 0, 0.05);
            --macos-shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.08);
            --macos-shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.12);
            
            /* Radius */
            --macos-radius-sm: 8px;
            --macos-radius-md: 12px;
            --macos-radius-lg: 18px;
            --macos-radius-xl: 24px;
            
            /* Spacing */
            --macos-spacing-xs: 4px;
            --macos-spacing-sm: 8px;
            --macos-spacing-md: 16px;
            --macos-spacing-lg: 24px;
            --macos-spacing-xl: 32px;
            --macos-spacing-xxl: 48px;
            
            /* Typography */
            --macos-font-title: 28px;
            --macos-font-heading: 22px;
            --macos-font-subheading: 17px;
            --macos-font-body: 15px;
            --macos-font-caption: 13px;
            --macos-font-small: 11px;
            
            /* Animation */
            --macos-transition-fast: 0.15s ease;
            --macos-transition-medium: 0.3s ease;
            --macos-transition-slow: 0.5s ease;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--macos-bg-primary);
            color: var(--macos-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
        }
        
        input, select, textarea {
            font-family: inherit;
            font-size: inherit;
        }
        
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-4);
        }
        
        /* ===== LAYOUT CONTAINERS ===== */
        #adminContainer {
            display: flex;
            min-height: 100vh;
            background: var(--macos-bg-primary);
        }
        
        /* ===== SIDEBAR ===== */
        #sidebar {
            width: 260px;
            background: var(--macos-bg-primary);
            border-right: 1px solid var(--macos-border-light);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform var(--macos-transition-medium);
        }
        
        .sidebar-header {
            padding: var(--macos-spacing-xl);
            border-bottom: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-md);
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        
        .app-title {
            font-size: var(--macos-font-subheading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .app-subtitle {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
        }
        
        .nav-section {
            padding: var(--macos-spacing-lg) var(--macos-spacing-xl);
        }
        
        .nav-section-title {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--macos-spacing-sm);
            font-weight: 500;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-md);
            padding: var(--macos-spacing-sm) var(--macos-spacing-md);
            border-radius: var(--macos-radius-sm);
            margin-bottom: var(--macos-spacing-xs);
            color: var(--macos-text-primary);
            transition: all var(--macos-transition-fast);
            position: relative;
        }
        
        .nav-item:hover {
            background: var(--macos-bg-secondary);
        }
        
        .nav-item.active {
            background: var(--macos-bg-secondary);
            color: var(--macos-blue);
            font-weight: 500;
        }
        
        .nav-item.active .nav-icon {
            color: var(--macos-blue);
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-text-secondary);
        }
        
        .nav-label {
            flex: 1;
            font-size: var(--macos-font-body);
        }
        
        .nav-badge {
            background: var(--macos-red);
            color: white;
            font-size: var(--macos-font-small);
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding: var(--macos-spacing-xl);
            border-top: 1px solid var(--macos-border-light);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-md);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--macos-border-light);
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: var(--macos-font-body);
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .user-role {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
        }
        
        /* ===== MAIN CONTENT ===== */
        #mainContent {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
            background: var(--macos-bg-primary);
        }
        
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 90;
            background: var(--macos-bg-primary);
            border-bottom: 1px solid var(--macos-border-light);
            padding: var(--macos-spacing-lg) var(--macos-spacing-xl);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(20px);
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .page-title {
            font-size: var(--macos-font-heading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-md);
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: var(--macos-spacing-sm) var(--macos-spacing-lg);
            padding-left: 40px;
            background: var(--macos-bg-secondary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-md);
            font-size: var(--macos-font-body);
            color: var(--macos-text-primary);
            transition: all var(--macos-transition-fast);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            background: var(--macos-bg-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: var(--macos-spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-text-secondary);
        }
        
        .action-button {
            padding: var(--macos-spacing-sm) var(--macos-spacing-lg);
            background: var(--macos-blue);
            color: white;
            border-radius: var(--macos-radius-md);
            font-size: var(--macos-font-body);
            font-weight: 500;
            transition: all var(--macos-transition-fast);
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-sm);
        }
        
        .action-button:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .content-wrapper {
            padding: var(--macos-spacing-xl);
        }
        
        .content-section {
            display: none;
            animation: fadeIn var(--macos-transition-medium);
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DASHBOARD ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--macos-spacing-lg);
            margin-bottom: var(--macos-spacing-xl);
        }
        
        .stat-card {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            padding: var(--macos-spacing-lg);
            transition: all var(--macos-transition-fast);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-medium);
            border-color: var(--macos-blue);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--macos-spacing-md);
        }
        
        .stat-title {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--macos-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--macos-spacing-xs);
            color: var(--macos-text-primary);
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-xs);
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
        }
        
        .trend-up {
            color: var(--macos-green);
        }
        
        .trend-down {
            color: var(--macos-red);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--macos-spacing-lg);
            margin-bottom: var(--macos-spacing-xl);
        }
        
        .chart-card {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            padding: var(--macos-spacing-lg);
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--macos-spacing-lg);
        }
        
        .chart-title {
            font-size: var(--macos-font-subheading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .recent-activity {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            padding: var(--macos-spacing-lg);
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: var(--macos-spacing-md);
            border-bottom: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-md);
            transition: background var(--macos-transition-fast);
        }
        
        .activity-item:hover {
            background: var(--macos-bg-secondary);
        }
        
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            margin-bottom: 2px;
            color: var(--macos-text-primary);
        }
        
        .activity-description {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
            margin-bottom: 4px;
        }
        
        .activity-time {
            font-size: var(--macos-font-small);
            color: var(--macos-text-tertiary);
        }
        
        /* ===== DATA TABLES ===== */
        .data-table-container {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            overflow: hidden;
        }
        
        .table-header {
            padding: var(--macos-spacing-lg);
            border-bottom: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .table-title {
            font-size: var(--macos-font-subheading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .table-actions {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-sm);
        }
        
        .table-filter {
            padding: var(--macos-spacing-sm) var(--macos-spacing-md);
            background: var(--macos-bg-secondary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-sm);
            font-size: var(--macos-font-body);
            color: var(--macos-text-primary);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            padding: var(--macos-spacing-md) var(--macos-spacing-lg);
            text-align: left;
            font-weight: 600;
            color: var(--macos-text-secondary);
            border-bottom: 1px solid var(--macos-border-light);
            background: var(--macos-bg-secondary);
            font-size: var(--macos-font-caption);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: var(--macos-spacing-md) var(--macos-spacing-lg);
            border-bottom: 1px solid var(--macos-border-light);
            font-size: var(--macos-font-body);
            color: var(--macos-text-primary);
        }
        
        .data-table tr:hover {
            background: var(--macos-bg-secondary);
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: var(--macos-font-caption);
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .status-suspended {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .status-banned {
            background: rgba(142, 142, 147, 0.1);
            color: var(--macos-gray-5);
        }
        
        .status-approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .status-processing {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: var(--macos-spacing-xs);
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--macos-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--macos-bg-secondary);
            color: var(--macos-text-secondary);
            transition: all var(--macos-transition-fast);
        }
        
        .btn-icon:hover {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-view {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        .btn-view:hover {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-edit {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .btn-edit:hover {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-delete {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .btn-delete:hover {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-suspend {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .btn-suspend:hover {
            background: var(--macos-orange);
            color: white;
        }
        
        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn var(--macos-transition-medium);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--macos-bg-primary);
            border-radius: var(--macos-radius-lg);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--macos-shadow-heavy);
            animation: slideUp var(--macos-transition-medium);
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: var(--macos-spacing-lg) var(--macos-spacing-xl);
            border-bottom: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: var(--macos-font-heading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--macos-text-secondary);
            transition: all var(--macos-transition-fast);
        }
        
        .modal-close:hover {
            background: var(--macos-bg-secondary);
            color: var(--macos-text-primary);
        }
        
        .modal-body {
            padding: var(--macos-spacing-xl);
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: var(--macos-spacing-lg) var(--macos-spacing-xl);
            border-top: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--macos-spacing-md);
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: var(--macos-spacing-lg);
        }
        
        .form-row {
            display: flex;
            gap: var(--macos-spacing-lg);
            margin-bottom: var(--macos-spacing-lg);
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--macos-spacing-sm);
            font-weight: 500;
            color: var(--macos-text-primary);
            font-size: var(--macos-font-body);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: var(--macos-spacing-md);
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-md);
            font-size: var(--macos-font-body);
            color: var(--macos-text-primary);
            transition: all var(--macos-transition-fast);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-hint {
            display: block;
            margin-top: var(--macos-spacing-xs);
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
        }
        
        .form-required::after {
            content: " *";
            color: var(--macos-red);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: var(--macos-spacing-md) var(--macos-spacing-xl);
            border-radius: var(--macos-radius-md);
            font-size: var(--macos-font-body);
            font-weight: 500;
            transition: all var(--macos-transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--macos-spacing-sm);
            border: none;
            cursor: pointer;
        }
        
        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--macos-bg-secondary);
            color: var(--macos-text-primary);
            border: 1px solid var(--macos-border-light);
        }
        
        .btn-secondary:hover {
            background: var(--macos-bg-tertiary);
        }
        
        .btn-success {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #2A9E46;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #CC2E25;
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }
        
        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .btn-small {
            padding: var(--macos-spacing-sm) var(--macos-spacing-md);
            font-size: var(--macos-font-caption);
        }
        
        /* ===== DOCUMENT VIEWER ===== */
        .document-viewer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--macos-spacing-lg);
            margin-bottom: var(--macos-spacing-xl);
        }
        
        .document-card {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            overflow: hidden;
            transition: all var(--macos-transition-fast);
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-medium);
            border-color: var(--macos-blue);
        }
        
        .document-preview {
            height: 200px;
            overflow: hidden;
            position: relative;
            background: var(--macos-bg-secondary);
        }
        
        .document-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--macos-transition-medium);
        }
        
        .document-card:hover .document-image {
            transform: scale(1.05);
        }
        
        .document-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--macos-transition-fast);
        }
        
        .document-card:hover .document-overlay {
            opacity: 1;
        }
        
        .document-info {
            padding: var(--macos-spacing-lg);
        }
        
        .document-title {
            font-weight: 600;
            margin-bottom: var(--macos-spacing-xs);
            color: var(--macos-text-primary);
        }
        
        .document-type {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
            margin-bottom: var(--macos-spacing-sm);
        }
        
        .document-date {
            font-size: var(--macos-font-small);
            color: var(--macos-text-tertiary);
        }
        
        /* ===== DETAIL VIEWS ===== */
        .detail-view {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            overflow: hidden;
        }
        
        .detail-header {
            padding: var(--macos-spacing-xl);
            border-bottom: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-lg);
        }
        
        .detail-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--macos-radius-lg);
            object-fit: cover;
            border: 3px solid var(--macos-bg-primary);
            box-shadow: var(--macos-shadow-light);
        }
        
        .detail-info {
            flex: 1;
        }
        
        .detail-name {
            font-size: var(--macos-font-heading);
            font-weight: 600;
            margin-bottom: var(--macos-spacing-xs);
            color: var(--macos-text-primary);
        }
        
        .detail-id {
            font-size: var(--macos-font-body);
            color: var(--macos-text-secondary);
            margin-bottom: var(--macos-spacing-sm);
        }
        
        .detail-grid {
            padding: var(--macos-spacing-xl);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--macos-spacing-lg);
        }
        
        .detail-card {
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-md);
            padding: var(--macos-spacing-lg);
        }
        
        .detail-label {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
            margin-bottom: var(--macos-spacing-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: var(--macos-font-subheading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .detail-value-secondary {
            font-size: var(--macos-font-body);
            color: var(--macos-text-secondary);
        }
        
        /* ===== LOADING STATES ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--macos-bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--macos-transition-medium);
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--macos-bg-secondary);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: var(--macos-spacing-lg);
            font-size: var(--macos-font-body);
            color: var(--macos-text-secondary);
            text-align: center;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }
        
        .toast {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-md);
            padding: var(--macos-spacing-lg);
            margin-bottom: var(--macos-spacing-md);
            box-shadow: var(--macos-shadow-medium);
            display: flex;
            align-items: flex-start;
            gap: var(--macos-spacing-md);
            max-width: 400px;
            transform: translateX(100%);
            opacity: 0;
            transition: all var(--macos-transition-medium);
        }
        
        .toast.active {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .toast-success .toast-icon {
            background: var(--macos-green);
        }
        
        .toast-error .toast-icon {
            background: var(--macos-red);
        }
        
        .toast-warning .toast-icon {
            background: var(--macos-orange);
        }
        
        .toast-info .toast-icon {
            background: var(--macos-blue);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: var(--macos-spacing-xs);
            color: var(--macos-text-primary);
        }
        
        .toast-message {
            font-size: var(--macos-font-body);
            color: var(--macos-text-secondary);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            #sidebar {
                transform: translateX(-100%);
            }
            
            #sidebar.active {
                transform: translateX(0);
            }
            
            #mainContent {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .top-bar {
                padding: var(--macos-spacing-md);
            }
            
            .content-wrapper {
                padding: var(--macos-spacing-md);
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: var(--macos-spacing-md);
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                gap: var(--macos-spacing-md);
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        /* ===== MOBILE MENU TOGGLE ===== */
        .menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: var(--macos-radius-md);
            background: var(--macos-bg-secondary);
            align-items: center;
            justify-content: center;
            color: var(--macos-text-primary);
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        @media (max-width: 1024px) {
            .menu-toggle {
                display: flex;
            }
        }
        
        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: var(--macos-spacing-xxl) var(--macos-spacing-xl);
            color: var(--macos-text-secondary);
        }
        
        .empty-icon {
            font-size: 64px;
            color: var(--macos-gray-3);
            margin-bottom: var(--macos-spacing-lg);
        }
        
        .empty-title {
            font-size: var(--macos-font-subheading);
            font-weight: 500;
            margin-bottom: var(--macos-spacing-sm);
            color: var(--macos-text-primary);
        }
        
        .empty-description {
            font-size: var(--macos-font-body);
            margin-bottom: var(--macos-spacing-lg);
        }
        
        /* ===== FILTER BAR ===== */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-md);
            padding: var(--macos-spacing-lg);
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-md);
            margin-bottom: var(--macos-spacing-lg);
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--macos-spacing-sm);
        }
        
        .filter-label {
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
            font-weight: 500;
        }
        
        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--macos-spacing-xs);
            padding: var(--macos-spacing-lg);
        }
        
        .pagination-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--macos-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--macos-bg-secondary);
            color: var(--macos-text-primary);
            transition: all var(--macos-transition-fast);
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--macos-blue);
            color: white;
        }
        
        .pagination-btn.active {
            background: var(--macos-blue);
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            margin: 0 var(--macos-spacing-md);
            font-size: var(--macos-font-caption);
            color: var(--macos-text-secondary);
        }
        
        /* ===== TABS ===== */
        .tab-container {
            margin-bottom: var(--macos-spacing-xl);
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--macos-border-light);
            margin-bottom: var(--macos-spacing-lg);
        }
        
        .tab-btn {
            padding: var(--macos-spacing-md) var(--macos-spacing-xl);
            font-size: var(--macos-font-body);
            color: var(--macos-text-secondary);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all var(--macos-transition-fast);
        }
        
        .tab-btn:hover {
            color: var(--macos-text-primary);
        }
        
        .tab-btn.active {
            color: var(--macos-blue);
            border-bottom-color: var(--macos-blue);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ===== TOOLTIPS ===== */
        .tooltip {
            position: relative;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--macos-gray-6);
            color: white;
            padding: var(--macos-spacing-sm) var(--macos-spacing-md);
            border-radius: var(--macos-radius-sm);
            font-size: var(--macos-font-caption);
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }
        
        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--macos-gray-6);
            margin-bottom: -5px;
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: var(--macos-font-small);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .badge-success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .badge-warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .badge-danger {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .badge-info {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        /* ===== CARD GRID ===== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--macos-spacing-lg);
        }
        
        .card {
            background: var(--macos-bg-primary);
            border: 1px solid var(--macos-border-light);
            border-radius: var(--macos-radius-lg);
            overflow: hidden;
            transition: all var(--macos-transition-fast);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-medium);
            border-color: var(--macos-blue);
        }
        
        .card-header {
            padding: var(--macos-spacing-lg);
            border-bottom: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: var(--macos-font-subheading);
            font-weight: 600;
            color: var(--macos-text-primary);
        }
        
        .card-body {
            padding: var(--macos-spacing-lg);
        }
        
        .card-footer {
            padding: var(--macos-spacing-lg);
            border-top: 1px solid var(--macos-border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* ===== UTILITY CLASSES ===== */
        .d-flex { display: flex; }
        .d-none { display: none; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--macos-spacing-sm); }
        .gap-md { gap: var(--macos-spacing-md); }
        .gap-lg { gap: var(--macos-spacing-lg); }
        .mt-sm { margin-top: var(--macos-spacing-sm); }
        .mt-md { margin-top: var(--macos-spacing-md); }
        .mt-lg { margin-top: var(--macos-spacing-lg); }
        .mb-sm { margin-bottom: var(--macos-spacing-sm); }
        .mb-md { margin-bottom: var(--macos-spacing-md); }
        .mb-lg { margin-bottom: var(--macos-spacing-lg); }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--macos-text-secondary); }
        .text-success { color: var(--macos-green); }
        .text-danger { color: var(--macos-red); }
        .text-warning { color: var(--macos-orange); }
        .text-info { color: var(--macos-blue); }
        .font-bold { font-weight: 600; }
        .font-semibold { font-weight: 500; }
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        .flex-1 { flex: 1; }
        .flex-shrink-0 { flex-shrink: 0; }
        .cursor-pointer { cursor: pointer; }
        .position-relative { position: relative; }
        .position-absolute { position: absolute; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
    </style>
</head>
<body>
    <div id="adminContainer">
        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="logo">TC</div>
                <div>
                    <div class="app-title">TruCash</div>
                    <div class="app-subtitle">Admin Panel</div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a href="#" class="nav-item active" data-section="dashboard">
                    <div class="nav-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="nav-label">Dashboard</div>
                </a>
                
                <div class="nav-section-title mt-lg">Management</div>
                <a href="#" class="nav-item" data-section="loans">
                    <div class="nav-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="nav-label">Loan Approvals</div>
                    <div class="nav-badge" id="pendingLoansBadge">0</div>
                </a>
                
                <a href="#" class="nav-item" data-section="agents">
                    <div class="nav-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="nav-label">Agent Management</div>
                    <div class="nav-badge" id="pendingAgentsBadge">0</div>
                </a>
                
                <a href="#" class="nav-item" data-section="customers">
                    <div class="nav-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="nav-label">Customer Management</div>
                    <div class="nav-badge" id="totalCustomersBadge">0</div>
                </a>
                
                <a href="#" class="nav-item" data-section="assignments">
                    <div class="nav-icon">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="nav-label">Assignments</div>
                </a>
                
                <div class="nav-section-title mt-lg">Financial</div>
                <a href="#" class="nav-item" data-section="commissions">
                    <div class="nav-icon">
                        <i class="fas fa-money-check-alt"></i>
                    </div>
                    <div class="nav-label">Commissions</div>
                </a>
                
                <a href="#" class="nav-item" data-section="transactions">
                    <div class="nav-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="nav-label">Transactions</div>
                </a>
                
                <div class="nav-section-title mt-lg">System</div>
                <a href="#" class="nav-item" data-section="audit">
                    <div class="nav-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="nav-label">Audit Log</div>
                </a>
                
                <a href="#" class="nav-item" data-section="reports">
                    <div class="nav-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="nav-label">Reports</div>
                </a>
            </div>
            
            <!-- User Profile -->
            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=007AFF&color=fff" 
                         alt="Admin" class="user-avatar" id="adminAvatar">
                    <div class="user-info">
                        <div class="user-name" id="adminName">Loading...</div>
                        <div class="user-role">Administrator</div>
                    </div>
                    <button class="btn-icon" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main id="mainContent">
            <!-- Top Bar -->
            <div class="top-bar">
                <h1 class="page-title" id="pageTitle">Admin Dashboard</h1>
                <div class="top-bar-actions">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search across all data...">
                    </div>
                    <button class="action-button" id="quickActionBtn">
                        <i class="fas fa-plus"></i>
                        Quick Action
                    </button>
                </div>
            </div>
            
            <!-- Content Sections -->
            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <section id="dashboardSection" class="content-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Loans</div>
                                <div class="stat-icon" style="background: var(--macos-blue);">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalLoans">0</div>
                            <div class="stat-trend">
                                <span class="trend-up">+12%</span> from last month
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Active Customers</div>
                                <div class="stat-icon" style="background: var(--macos-green);">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="activeCustomers">0</div>
                            <div class="stat-trend">
                                <span class="trend-up">+8%</span> from last month
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Active Agents</div>
                                <div class="stat-icon" style="background: var(--macos-purple);">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="activeAgents">0</div>
                            <div class="stat-trend">
                                <span class="trend-up">+5%</span> from last month
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Commission</div>
                                <div class="stat-icon" style="background: var(--macos-orange);">
                                    <i class="fas fa-money-check-alt"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalCommission">K0.00</div>
                            <div class="stat-trend">
                                <span class="trend-up">+15%</span> from last month
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Loan Volume</h3>
                                <select class="form-select" style="width: auto;">
                                    <option>Last 7 days</option>
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="loanVolumeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Loan Status Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="loanStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recent-activity">
                        <h3 class="chart-title">Recent Activity</h3>
                        <div class="activity-list" id="recentActivityList">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                </section>
                
                <!-- Loan Approvals Section -->
                <section id="loansSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Loan Applications</h3>
                            <div class="table-actions">
                                <select class="table-filter" id="loanStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                </select>
                                <button class="btn btn-outline btn-small" id="exportLoansBtn">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Purpose</th>
                                        <th>Applied Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="loansTableBody">
                                    <!-- Loans will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <button class="pagination-btn" id="prevPageBtn" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                            <button class="pagination-btn" id="nextPageBtn" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- Agent Management Section -->
                <section id="agentsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Agent Management</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" id="createAgentBtn">
                                    <i class="fas fa-plus"></i> Create Agent
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Agent ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Customers</th>
                                        <th>Commission</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTableBody">
                                    <!-- Agents will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Customer Management Section -->
                <section id="customersSection" class="content-section">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <span class="filter-label">Status:</span>
                            <select class="form-select" id="customerStatusFilter">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                                <option value="banned">Banned</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Agent:</span>
                            <select class="form-select" id="customerAgentFilter">
                                <option value="all">All Agents</option>
                                <!-- Agent options will be loaded here -->
                            </select>
                        </div>
                        <button class="btn btn-outline btn-small" id="clearFiltersBtn">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    
                    <div class="card-grid" id="customersGrid">
                        <!-- Customer cards will be loaded here -->
                    </div>
                </section>
                
                <!-- Assignment Section -->
                <section id="assignmentsSection" class="content-section">
                    <div class="detail-view">
                        <div class="detail-header">
                            <div class="flex-1">
                                <h3 class="detail-name">Agent-Customer Assignments</h3>
                                <p class="detail-id">Manually assign agents to customers</p>
                            </div>
                            <button class="btn btn-primary" id="bulkAssignBtn">
                                <i class="fas fa-users"></i> Bulk Assignment
                            </button>
                        </div>
                        
                        <div class="form-row" style="padding: var(--macos-spacing-xl);">
                            <div class="form-group">
                                <label class="form-label">Select Agent</label>
                                <select class="form-select" id="assignAgentSelect">
                                    <option value="">Choose an agent</option>
                                    <!-- Agent options will be loaded here -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Select Customer(s)</label>
                                <select class="form-select" id="assignCustomerSelect" multiple style="height: 200px;">
                                    <!-- Customer options will be loaded here -->
                                </select>
                                <div class="form-hint">Hold Ctrl/Cmd to select multiple customers</div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="clearAssignmentBtn">Clear Selection</button>
                            <button class="btn btn-primary" id="saveAssignmentBtn">
                                <i class="fas fa-save"></i> Save Assignment
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- Commissions Section -->
                <section id="commissionsSection" class="content-section">
                    <div class="tab-container">
                        <div class="tab-header">
                            <button class="tab-btn active" data-tab="pending">Pending Commissions</button>
                            <button class="tab-btn" data-tab="paid">Paid Commissions</button>
                            <button class="tab-btn" data-tab="all">All Commissions</button>
                        </div>
                        
                        <div class="tab-content active" id="pendingTab">
                            <div class="data-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Commission ID</th>
                                            <th>Agent</th>
                                            <th>Customer</th>
                                            <th>Loan ID</th>
                                            <th>Amount</th>
                                            <th>Earned Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingCommissionsBody">
                                        <!-- Pending commissions will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="paidTab">
                            <div class="data-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Commission ID</th>
                                            <th>Agent</th>
                                            <th>Amount</th>
                                            <th>Paid Date</th>
                                            <th>Payment Method</th>
                                            <th>Reference</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paidCommissionsBody">
                                        <!-- Paid commissions will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Transactions Section -->
                <section id="transactionsSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Transaction History</h3>
                            <div class="table-actions">
                                <input type="date" class="form-input" id="transactionDateFrom">
                                <span>to</span>
                                <input type="date" class="form-input" id="transactionDateTo">
                                <button class="btn btn-outline btn-small" id="filterTransactionsBtn">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Audit Log Section -->
                <section id="auditSection" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Audit Log</h3>
                            <div class="table-actions">
                                <select class="table-filter" id="auditActionFilter">
                                    <option value="all">All Actions</option>
                                    <option value="login">Logins</option>
                                    <option value="create">Creations</option>
                                    <option value="update">Updates</option>
                                    <option value="delete">Deletions</option>
                                    <option value="approve">Approvals</option>
                                </select>
                                <button class="btn btn-outline btn-small" id="exportAuditBtn">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Details</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTableBody">
                                    <!-- Audit logs will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Reports Section -->
                <section id="reportsSection" class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Monthly Report</div>
                                <div class="stat-icon" style="background: var(--macos-blue);">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                            </div>
                            <div class="stat-value">Generate</div>
                            <button class="btn btn-outline w-100 mt-md">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Agent Performance</div>
                                <div class="stat-icon" style="background: var(--macos-green);">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="stat-value">View</div>
                            <button class="btn btn-outline w-100 mt-md">
                                <i class="fas fa-chart-bar"></i> View Report
                            </button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Loan Portfolio</div>
                                <div class="stat-icon" style="background: var(--macos-purple);">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                            </div>
                            <div class="stat-value">Analyze</div>
                            <button class="btn btn-outline w-100 mt-md">
                                <i class="fas fa-chart-pie"></i> Analyze
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-card mt-lg">
                        <div class="chart-header">
                            <h3 class="chart-title">Yearly Performance Overview</h3>
                            <select class="form-select" style="width: auto;">
                                <option>2024</option>
                                <option>2023</option>
                                <option>2022</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="yearlyPerformanceChart"></canvas>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Loading Admin Panel...</div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toasts will be injected here -->
    </div>
    
    <!-- ===== MODALS ===== -->
    
    <!-- Loan Details Modal -->
    <div class="modal" id="loanDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Loan Application Details</h3>
                <button class="modal-close" onclick="ModalManager.closeLoanModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="loanDetailContent">
                    <!-- Loan details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeLoanModal()">Close</button>
                <button class="btn btn-primary" id="approveLoanBtn" style="display: none;">
                    <i class="fas fa-check"></i> Approve Loan
                </button>
                <button class="btn btn-danger" id="rejectLoanBtn" style="display: none;">
                    <i class="fas fa-times"></i> Reject Loan
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent</h3>
                <button class="modal-close" onclick="ModalManager.closeCreateAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createAgentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-required">Full Name</label>
                            <input type="text" class="form-input" id="agentFullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-required">Phone Number</label>
                            <input type="tel" class="form-input" id="agentPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-required">Email Address</label>
                            <input type="email" class="form-input" id="agentEmail" required>
                            <div class="form-hint">Manual email assignment required</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-required">Password</label>
                            <input type="password" class="form-input" id="agentPassword" required>
                            <div class="form-hint">Manual password assignment required</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-required">Agent ID</label>
                            <input type="text" class="form-input" id="agentId" required>
                            <div class="form-hint">Manually assign unique agent ID</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Branch/Location</label>
                            <input type="text" class="form-input" id="agentBranch">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label form-required">NRC Number</label>
                        <input type="text" class="form-input" id="agentNRC" placeholder="123456/78/9" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Residential Address</label>
                        <textarea class="form-textarea" id="agentAddress" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Commission Rate (%)</label>
                        <input type="number" class="form-input" id="agentCommissionRate" value="2.5" min="0" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="agentNotes" rows="3" placeholder="Any additional notes about this agent..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCreateAgentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="AgentManager.createAgent()">
                    <i class="fas fa-user-plus"></i> Create Agent
                </button>
            </div>
        </div>
    </div>
    
    <!-- Customer Details Modal -->
    <div class="modal" id="customerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <button class="modal-close" onclick="ModalManager.closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailContent">
                    <!-- Customer details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCustomerModal()">Close</button>
                <button class="btn btn-warning" id="suspendCustomerBtn">
                    <i class="fas fa-pause"></i> Suspend
                </button>
                <button class="btn btn-danger" id="banCustomerBtn">
                    <i class="fas fa-ban"></i> Ban
                </button>
                <button class="btn btn-success" id="activateCustomerBtn" style="display: none;">
                    <i class="fas fa-check"></i> Activate
                </button>
            </div>
        </div>
    </div>
    
    <!-- Document Viewer Modal -->
    <div class="modal" id="documentViewerModal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="documentViewerTitle">Document Viewer</h3>
                <button class="modal-close" onclick="ModalManager.closeDocumentViewer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="documentViewerContent" style="height: 70vh; overflow: auto;">
                    <!-- Document will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeDocumentViewer()">Close</button>
                <a class="btn btn-primary" id="downloadDocumentBtn" target="_blank">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>
    
    <!-- Commission Payment Modal -->
    <div class="modal" id="commissionPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Process Commission Payment</h3>
                <button class="modal-close" onclick="ModalManager.closeCommissionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="commissionPaymentForm">
                    <div class="form-group">
                        <label class="form-label">Agent Information</label>
                        <div style="background: var(--macos-bg-secondary); padding: var(--macos-spacing-md); border-radius: var(--macos-radius-md);">
                            <div><strong>Name:</strong> <span id="commissionAgentName"></span></div>
                            <div><strong>Agent ID:</strong> <span id="commissionAgentId"></span></div>
                            <div><strong>Commission Due:</strong> <span id="commissionAmount"></span></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label form-required">Payment Amount</label>
                            <input type="number" class="form-input" id="paymentAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-required">Payment Method</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="">Select method</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="cash">Cash</option>
                                <option value="check">Check</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Transaction Reference</label>
                            <input type="text" class="form-input" id="paymentReference" placeholder="e.g., BANK123456">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Date</label>
                            <input type="date" class="form-input" id="paymentDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="paymentNotes" rows="3" placeholder="Any additional notes about this payment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCommissionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="CommissionManager.processPayment()">
                    <i class="fas fa-money-check"></i> Process Payment
                </button>
            </div>
        </div>
    </div>
    
    <!-- Quick Action Modal -->
    <div class="modal" id="quickActionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quick Actions</h3>
                <button class="modal-close" onclick="ModalManager.closeQuickActionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-grid">
                    <div class="card" onclick="QuickActionManager.approvePendingLoans()">
                        <div class="card-body text-center">
                            <div class="stat-icon" style="width: 60px; height: 60px; margin: 0 auto var(--macos-spacing-md); background: var(--macos-green);">
                                <i class="fas fa-check-double"></i>
                            </div>
                            <h4 class="card-title">Approve Pending Loans</h4>
                            <p class="text-muted">Approve all pending loan applications</p>
                        </div>
                    </div>
                    
                    <div class="card" onclick="QuickActionManager.generateMonthlyReport()">
                        <div class="card-body text-center">
                            <div class="stat-icon" style="width: 60px; height: 60px; margin: 0 auto var(--macos-spacing-md); background: var(--macos-blue);">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <h4 class="card-title">Generate Report</h4>
                            <p class="text-muted">Create monthly performance report</p>
                        </div>
                    </div>
                    
                    <div class="card" onclick="QuickActionManager.auditSystem()">
                        <div class="card-body text-center">
                            <div class="stat-icon" style="width: 60px; height: 60px; margin: 0 auto var(--macos-spacing-md); background: var(--macos-orange);">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h4 class="card-title">System Audit</h4>
                            <p class="text-muted">Run comprehensive system audit</p>
                        </div>
                    </div>
                    
                    <div class="card" onclick="QuickActionManager.backupData()">
                        <div class="card-body text-center">
                            <div class="stat-icon" style="width: 60px; height: 60px; margin: 0 auto var(--macos-spacing-md); background: var(--macos-purple);">
                                <i class="fas fa-database"></i>
                            </div>
                            <h4 class="card-title">Backup Data</h4>
                            <p class="text-muted">Create system data backup</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/documents',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'],
            multiple: false
        };

        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            adminId: null,
            users: [],
            agents: [],
            customers: [],
            loans: [],
            transactions: [],
            commissions: [],
            repayments: [],
            auditLogs: [],
            notifications: [],
            systemSettings: null,
            realtimeListeners: [],
            currentSection: 'dashboard',
            pagination: {
                loans: { page: 1, limit: 10, total: 0 },
                agents: { page: 1, limit: 10, total: 0 },
                customers: { page: 1, limit: 10, total: 0 },
                transactions: { page: 1, limit: 10, total: 0 }
            },
            charts: {},
            filters: {
                loanStatus: 'all',
                customerStatus: 'all',
                agentStatus: 'all',
                dateRange: 'all'
            },
            selectedItems: {
                loan: null,
                agent: null,
                customer: null,
                commission: null
            }
        };

        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db, storage;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showToast(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="modal-close" onclick="document.getElementById('${toastId}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('active');
                }, 10);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.remove('active');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
                
                return toastId;
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            truncateText(text, maxLength = 50) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            calculateCommission(loanAmount, commissionRate = 2.5) {
                return (loanAmount * commissionRate) / 100;
            },
            
            calculateAge(dob) {
                if (!dob) return 'N/A';
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            },
            
            isImageUrl(url) {
                if (!url) return false;
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
                return imageExtensions.some(ext => url.toLowerCase().includes(ext));
            },
            
            openInNewTab(url) {
                window.open(url, '_blank');
            }
        };

        // ===== FIREBASE SERVICE =====
        const FirebaseService = {
            async checkAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        unsubscribe();
                        
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const adminRef = db.ref('admins/' + currentUser.uid);
                            const snapshot = await adminRef.once('value');
                            
                            if (!snapshot.exists()) {
                                Utils.showToast('Access Denied', 
                                    'Admin access required. Only sudo admin can create admin accounts.', 
                                    'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const adminData = snapshot.val();
                            
                            // Verify admin status
                            if (adminData.status !== 'active') {
                                Utils.showToast('Account Suspended', 
                                    'Your admin account has been suspended.', 
                                    'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = currentUser;
                            AppState.adminData = adminData;
                            AppState.adminId = currentUser.uid;
                            
                            resolve(adminData);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            Utils.showToast('Authentication Error', 
                                'Failed to verify admin status.', 
                                'error');
                            resolve(null);
                        }
                    }, (error) => {
                        console.error('Auth state listener error:', error);
                        window.location.href = 'login.html';
                        resolve(null);
                    });
                });
            },
            
            async loadAllData() {
                try {
                    // Load users
                    const usersRef = db.ref('users');
                    const usersSnapshot = await usersRef.once('value');
                    const users = [];
                    
                    usersSnapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        users.push(user);
                    });
                    
                    AppState.users = users;
                    AppState.customers = users.filter(u => u.userType === 'customer');
                    AppState.agents = users.filter(u => u.userType === 'agent');
                    
                    // Load loans
                    const loansRef = db.ref('loans');
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    AppState.loans = loans;
                    
                    // Load transactions
                    const transactionsRef = db.ref('transactions');
                    const transactionsSnapshot = await transactionsRef.once('value');
                    const transactions = [];
                    
                    transactionsSnapshot.forEach((childSnapshot) => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        transactions.push(transaction);
                    });
                    
                    AppState.transactions = transactions;
                    
                    // Load commissions
                    const commissionsRef = db.ref('commissions');
                    const commissionsSnapshot = await commissionsRef.once('value');
                    const commissions = [];
                    
                    commissionsSnapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    
                    // Load audit logs
                    const auditRef = db.ref('auditLogs');
                    const auditSnapshot = await auditRef.once('value');
                    const auditLogs = [];
                    
                    auditSnapshot.forEach((childSnapshot) => {
                        const auditLog = childSnapshot.val();
                        auditLog.id = childSnapshot.key;
                        auditLogs.push(auditLog);
                    });
                    
                    auditLogs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = auditLogs;
                    
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return false;
                }
            },
            
            async createAgent(agentData) {
                try {
                    Utils.showLoading('Creating agent account...');
                    
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentId = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.address || '',
                        agentId: agentData.customAgentId,
                        userType: 'agent',
                        status: 'active',
                        isApproved: true,
                        commissionRate: agentData.commissionRate || 2.5,
                        branch: agentData.branch || '',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.adminId,
                        createdByName: AppState.adminData.fullName,
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0,
                        activeLoans: 0,
                        profilePhoto: agentData.profilePhoto || '',
                        nrcFront: agentData.nrcFront || '',
                        nrcBack: agentData.nrcBack || '',
                        notes: agentData.notes || ''
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentId).set(agentDoc);
                    
                    // Also save to agents collection
                    await db.ref('agents/' + agentId).set({
                        agentId: agentData.customAgentId,
                        email: agentData.email,
                        fullName: agentData.fullName,
                        phone: agentData.phone,
                        status: 'active',
                        createdAt: Date.now(),
                        createdBy: AppState.adminId
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_create', {
                        agentId: agentId,
                        agentName: agentData.fullName,
                        customAgentId: agentData.customAgentId,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName,
                        details: 'Agent account created manually by admin'
                    });
                    
                    // Send welcome email (simulated)
                    await this.sendWelcomeEmail(agentData.email, agentData.password, agentData.customAgentId);
                    
                    Utils.hideLoading();
                    return {
                        success: true,
                        agentId: agentId,
                        message: 'Agent account created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    Utils.hideLoading();
                    
                    let errorMessage = 'Failed to create agent account';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateLoanStatus(loanId, status, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.adminId,
                        updatedByName: AppState.adminData.fullName,
                        statusNotes: notes
                    };
                    
                    if (status === 'approved') {
                        updates.approvedAt = Date.now();
                        updates.approvedBy = AppState.adminId;
                        updates.approvedByName = AppState.adminData.fullName;
                    } else if (status === 'rejected') {
                        updates.rejectedAt = Date.now();
                        updates.rejectedBy = AppState.adminId;
                        updates.rejectedByName = AppState.adminData.fullName;
                    }
                    
                    await loanRef.update(updates);
                    
                    // Create commission record if loan is approved
                    if (status === 'approved') {
                        const loanSnap = await loanRef.once('value');
                        const loan = loanSnap.val();
                        
                        await this.createCommissionRecord({
                            agentId: loan.agentId,
                            agentName: loan.agentName,
                            customerId: loan.customerId,
                            customerName: loan.customerName,
                            loanId: loanId,
                            loanAmount: loan.amount,
                            type: 'loan_approval',
                            amount: Utils.calculateCommission(loan.amount, loan.commissionRate || 2.5),
                            status: 'pending',
                            createdAt: Date.now(),
                            approvedAt: Date.now(),
                            approvedBy: AppState.adminId
                        });
                    }
                    
                    // Create audit log
                    await this.createAuditLog('loan_status_update', {
                        loanId: loanId,
                        oldStatus: 'pending',
                        newStatus: status,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName,
                        notes: notes
                    });
                    
                    return { success: true, message: `Loan ${status} successfully` };
                } catch (error) {
                    console.error('Error updating loan status:', error);
                    return { success: false, error: 'Failed to update loan status' };
                }
            },
            
            async updateUserStatus(userId, status, reason = '') {
                try {
                    const userRef = db.ref('users/' + userId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.adminId,
                        updatedByName: AppState.adminData.fullName,
                        statusReason: reason
                    };
                    
                    if (status === 'suspended') {
                        updates.suspendedAt = Date.now();
                        updates.suspendedBy = AppState.adminId;
                    } else if (status === 'banned') {
                        updates.bannedAt = Date.now();
                        updates.bannedBy = AppState.adminId;
                    } else if (status === 'active') {
                        updates.activatedAt = Date.now();
                        updates.activatedBy = AppState.adminId;
                    }
                    
                    await userRef.update(updates);
                    
                    // Create audit log
                    const userSnap = await userRef.once('value');
                    const user = userSnap.val();
                    
                    await this.createAuditLog('user_status_update', {
                        userId: userId,
                        userName: user.fullName,
                        userType: user.userType,
                        oldStatus: user.status,
                        newStatus: status,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName,
                        reason: reason
                    });
                    
                    return { success: true, message: `User ${status} successfully` };
                } catch (error) {
                    console.error('Error updating user status:', error);
                    return { success: false, error: 'Failed to update user status' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const agentRef = db.ref('users/' + agentId);
                    
                    // Get agent details
                    const agentSnap = await agentRef.once('value');
                    const agent = agentSnap.val();
                    
                    // Update customer
                    await customerRef.update({
                        assignedAgentId: agentId,
                        agentName: agent.fullName,
                        agentAssignedAt: Date.now(),
                        assignedBy: AppState.adminId,
                        assignedByName: AppState.adminData.fullName,
                        updatedAt: Date.now()
                    });
                    
                    // Update agent customer count
                    await agentRef.update({
                        totalCustomers: firebase.database.ServerValue.increment(1),
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    const customerSnap = await customerRef.once('value');
                    const customer = customerSnap.val();
                    
                    await this.createAuditLog('agent_assignment', {
                        customerId: customerId,
                        customerName: customer.fullName,
                        agentId: agentId,
                        agentName: agent.fullName,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName,
                        details: 'Manual assignment by admin'
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async processCommissionPayment(commissionId, paymentData) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const updates = {
                        status: 'paid',
                        paidAt: Date.now(),
                        paidBy: AppState.adminId,
                        paidByName: AppState.adminData.fullName,
                        paymentMethod: paymentData.paymentMethod,
                        paymentReference: paymentData.paymentReference,
                        paymentNotes: paymentData.notes || '',
                        paymentAmount: paymentData.amount
                    };
                    
                    await commissionRef.update(updates);
                    
                    // Update agent's total commission
                    const commissionSnap = await commissionRef.once('value');
                    const commission = commissionSnap.val();
                    
                    const agentRef = db.ref('users/' + commission.agentId);
                    await agentRef.update({
                        totalCommission: firebase.database.ServerValue.increment(paymentData.amount),
                        updatedAt: Date.now()
                    });
                    
                    // Create transaction record
                    await this.createTransaction({
                        type: 'commission_payment',
                        amount: paymentData.amount,
                        agentId: commission.agentId,
                        agentName: commission.agentName,
                        reference: paymentData.paymentReference,
                        description: `Commission payment - ${commission.loanId || 'N/A'}`,
                        status: 'completed'
                    });
                    
                    // Create audit log
                    await this.createAuditLog('commission_payment', {
                        commissionId: commissionId,
                        agentId: commission.agentId,
                        agentName: commission.agentName,
                        amount: paymentData.amount,
                        paymentMethod: paymentData.paymentMethod,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName
                    });
                    
                    return { success: true, message: 'Commission payment processed successfully' };
                } catch (error) {
                    console.error('Error processing commission:', error);
                    return { success: false, error: 'Failed to process commission payment' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.adminId,
                        userName: AppState.adminData.fullName,
                        userRole: 'admin',
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    // Update local state
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 1000) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 1000);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createTransaction(transactionData) {
                try {
                    const transactionId = Utils.generateId('TXN');
                    const transactionRef = db.ref('transactions/' + transactionId);
                    
                    const transaction = {
                        id: transactionId,
                        ...transactionData,
                        timestamp: Date.now(),
                        processedBy: AppState.adminId,
                        processedByName: AppState.adminData.fullName,
                        status: transactionData.status || 'completed'
                    };
                    
                    await transactionRef.set(transaction);
                    return transactionId;
                } catch (error) {
                    console.error('Error creating transaction:', error);
                    return null;
                }
            },
            
            async createCommissionRecord(commissionData) {
                try {
                    const commissionId = Utils.generateId('COM');
                    const commissionRef = db.ref('commissions/' + commissionId);
                    
                    const commission = {
                        id: commissionId,
                        ...commissionData
                    };
                    
                    await commissionRef.set(commission);
                    return commissionId;
                } catch (error) {
                    console.error('Error creating commission record:', error);
                    return null;
                }
            },
            
            async sendWelcomeEmail(email, password, agentId) {
                // In a real application, this would send an actual email
                console.log('Welcome email would be sent to:', email);
                console.log('Credentials:', { email, password, agentId });
                
                // For demo purposes, just log it
                await this.createAuditLog('welcome_email_sent', {
                    email: email,
                    agentId: agentId,
                    timestamp: Date.now()
                });
                
                return true;
            },
            
            async deleteUser(userId) {
                try {
                    const userRef = db.ref('users/' + userId);
                    const userSnap = await userRef.once('value');
                    const user = userSnap.val();
                    
                    // Create backup before deletion
                    await db.ref('deletedUsers/' + userId).set({
                        ...user,
                        deletedAt: Date.now(),
                        deletedBy: AppState.adminId,
                        deletedByName: AppState.adminData.fullName
                    });
                    
                    // Delete the user
                    await userRef.remove();
                    
                    // Also delete from auth (if needed, though typically you'd disable not delete)
                    
                    // Create audit log
                    await this.createAuditLog('user_delete', {
                        userId: userId,
                        userName: user.fullName,
                        userType: user.userType,
                        adminId: AppState.adminId,
                        adminName: AppState.adminData.fullName,
                        details: 'Permanent deletion by admin'
                    });
                    
                    return { success: true, message: 'User deleted successfully' };
                } catch (error) {
                    console.error('Error deleting user:', error);
                    return { success: false, error: 'Failed to delete user' };
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.adminId = null;
                    AppState.users = [];
                    AppState.agents = [];
                    AppState.customers = [];
                    AppState.loans = [];
                    AppState.transactions = [];
                    AppState.commissions = [];
                    AppState.auditLogs = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    Utils.showToast('Logout Error', 'Failed to sign out properly', 'error');
                }
            },
            
            setupRealtimeListeners() {
                // Users listener
                const usersRef = db.ref('users');
                const usersListener = usersRef.on('value', (snapshot) => {
                    const users = [];
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        users.push(user);
                    });
                    
                    AppState.users = users;
                    AppState.customers = users.filter(u => u.userType === 'customer');
                    AppState.agents = users.filter(u => u.userType === 'agent');
                    
                    UIManager.updateDashboardUI();
                    UIManager.updateAgentsUI();
                    UIManager.updateCustomersUI();
                });
                
                AppState.realtimeListeners.push(() => usersRef.off('value', usersListener));
                
                // Loans listener
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    
                    UIManager.updateDashboardUI();
                    UIManager.updateLoansUI();
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Commissions listener
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    UIManager.updateCommissionsUI();
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Audit logs listener
                const auditRef = db.ref('auditLogs');
                const auditListener = auditRef.on('value', (snapshot) => {
                    const auditLogs = [];
                    snapshot.forEach((childSnapshot) => {
                        const auditLog = childSnapshot.val();
                        auditLog.id = childSnapshot.key;
                        auditLogs.push(auditLog);
                    });
                    
                    auditLogs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = auditLogs;
                    
                    if (AppState.currentSection === 'audit') {
                        UIManager.updateAuditUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => auditRef.off('value', auditListener));
            }
        };

        // ===== UI MANAGER =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupResponsive();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.menuToggle = document.getElementById('menuToggle');
                this.mobileMenuOverlay = document.createElement('div');
                this.mobileMenuOverlay.className = 'mobile-menu-overlay';
                this.mobileMenuOverlay.id = 'mobileMenuOverlay';
                document.body.appendChild(this.mobileMenuOverlay);
                
                // User info
                this.adminName = document.getElementById('adminName');
                this.adminAvatar = document.getElementById('adminAvatar');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                this.quickActionBtn = document.getElementById('quickActionBtn');
                this.createAgentBtn = document.getElementById('createAgentBtn');
                
                // Search and filters
                this.globalSearch = document.getElementById('globalSearch');
                this.loanStatusFilter = document.getElementById('loanStatusFilter');
                this.customerStatusFilter = document.getElementById('customerStatusFilter');
                
                // Badges
                this.pendingLoansBadge = document.getElementById('pendingLoansBadge');
                this.pendingAgentsBadge = document.getElementById('pendingAgentsBadge');
                this.totalCustomersBadge = document.getElementById('totalCustomersBadge');
                
                // Dashboard elements
                this.totalLoans = document.getElementById('totalLoans');
                this.activeCustomers = document.getElementById('activeCustomers');
                this.activeAgents = document.getElementById('activeAgents');
                this.totalCommission = document.getElementById('totalCommission');
                this.recentActivityList = document.getElementById('recentActivityList');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Close mobile menu
                        if (window.innerWidth <= 1024) {
                            document.getElementById('sidebar').classList.remove('active');
                            this.mobileMenuOverlay.classList.remove('active');
                        }
                    });
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Menu toggle for mobile
                this.menuToggle.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.toggle('active');
                    this.mobileMenuOverlay.classList.toggle('active');
                });
                
                // Mobile menu overlay
                this.mobileMenuOverlay.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('active');
                    this.mobileMenuOverlay.classList.remove('active');
                });
                
                // Quick action
                this.quickActionBtn.addEventListener('click', () => {
                    document.getElementById('quickActionModal').classList.add('active');
                });
                
                // Create agent
                this.createAgentBtn.addEventListener('click', () => {
                    document.getElementById('createAgentModal').classList.add('active');
                });
                
                // Global search
                this.globalSearch.addEventListener('input', Utils.debounce(() => {
                    this.handleGlobalSearch();
                }, 300));
                
                // Filters
                this.loanStatusFilter.addEventListener('change', () => {
                    AppState.filters.loanStatus = this.loanStatusFilter.value;
                    this.updateLoansUI();
                });
                
                this.customerStatusFilter.addEventListener('change', () => {
                    AppState.filters.customerStatus = this.customerStatusFilter.value;
                    this.updateCustomersUI();
                });
                
                // Assignment form
                document.getElementById('saveAssignmentBtn')?.addEventListener('click', () => {
                    AssignmentManager.saveAssignment();
                });
                
                // Close modals on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal.active').forEach(modal => {
                            modal.classList.remove('active');
                        });
                    }
                    
                    // Ctrl/Cmd + K for search
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        this.globalSearch.focus();
                    }
                });
            },
            
            setupResponsive() {
                const handleResize = () => {
                    if (window.innerWidth > 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                        this.mobileMenuOverlay.classList.remove('active');
                    }
                };
                
                window.addEventListener('resize', handleResize);
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Load initial data
                    await FirebaseService.loadAllData();
                    
                    // Setup real-time listeners
                    FirebaseService.setupRealtimeListeners();
                    
                    // Update UI
                    this.updateAdminProfile();
                    this.updateDashboardUI();
                    this.updateLoansUI();
                    this.updateAgentsUI();
                    this.updateCustomersUI();
                    this.updateCommissionsUI();
                    this.initCharts();
                    
                    Utils.hideLoading();
                    
                    // Show welcome
                    Utils.showToast('Welcome Admin', 
                        `Hello ${adminData.fullName || 'Administrator'}!`, 
                        'success');
                    
                } catch (error) {
                    console.error('Authentication initialization error:', error);
                    Utils.hideLoading();
                    Utils.showToast('Authentication Error', 'Failed to authenticate. Please try again.', 'error');
                }
            },
            
            updateAdminProfile() {
                if (!AppState.adminData) return;
                
                this.adminName.textContent = AppState.adminData.fullName || 'Administrator';
                
                if (AppState.adminData.profilePhoto) {
                    this.adminAvatar.src = AppState.adminData.profilePhoto;
                }
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.style.display = 'block';
                    
                    // Update page title
                    const titles = {
                        dashboard: 'Admin Dashboard',
                        loans: 'Loan Approvals',
                        agents: 'Agent Management',
                        customers: 'Customer Management',
                        assignments: 'Agent-Customer Assignments',
                        commissions: 'Commission Management',
                        transactions: 'Transaction History',
                        audit: 'Audit Log',
                        reports: 'Reports & Analytics'
                    };
                    
                    document.getElementById('pageTitle').textContent = titles[sectionId] || 'Admin Panel';
                    
                    // Load section-specific data
                    switch(sectionId) {
                        case 'loans':
                            this.updateLoansUI();
                            break;
                        case 'agents':
                            this.updateAgentsUI();
                            break;
                        case 'customers':
                            this.updateCustomersUI();
                            break;
                        case 'assignments':
                            this.updateAssignmentUI();
                            break;
                        case 'commissions':
                            this.updateCommissionsUI();
                            break;
                        case 'transactions':
                            this.updateTransactionsUI();
                            break;
                        case 'audit':
                            this.updateAuditUI();
                            break;
                        case 'reports':
                            this.updateReportsUI();
                            break;
                    }
                }
            },
            
            updateDashboardUI() {
                // Update stats
                this.totalLoans.textContent = AppState.loans.length;
                this.activeCustomers.textContent = AppState.customers.filter(c => c.status === 'active').length;
                this.activeAgents.textContent = AppState.agents.filter(a => a.status === 'active').length;
                
                const totalCommission = AppState.commissions
                    .filter(c => c.status === 'paid')
                    .reduce((sum, com) => sum + (com.amount || 0), 0);
                this.totalCommission.textContent = Utils.formatCurrency(totalCommission);
                
                // Update badges
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                this.pendingLoansBadge.textContent = pendingLoans;
                this.pendingLoansBadge.style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                
                const pendingAgents = AppState.agents.filter(a => a.status === 'pending').length;
                this.pendingAgentsBadge.textContent = pendingAgents;
                this.pendingAgentsBadge.style.display = pendingAgents > 0 ? 'inline-block' : 'none';
                
                this.totalCustomersBadge.textContent = AppState.customers.length;
                this.totalCustomersBadge.style.display = AppState.customers.length > 0 ? 'inline-block' : 'none';
                
                // Update recent activity
                this.updateRecentActivity();
            },
            
            updateRecentActivity() {
                const container = this.recentActivityList;
                if (!container) return;
                
                // Get recent audit logs (last 10)
                const recentLogs = AppState.auditLogs.slice(0, 10);
                
                if (recentLogs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-title">No Recent Activity</div>
                            <div class="empty-description">Activity will appear here as you use the system</div>
                        </div>
                    `;
                    return;
                }
                
                let activityHTML = '';
                
                recentLogs.forEach(log => {
                    let icon = 'fa-history';
                    let iconColor = 'var(--macos-blue)';
                    let title = '';
                    let description = '';
                    
                    switch(log.action) {
                        case 'loan_status_update':
                            icon = 'fa-file-invoice-dollar';
                            iconColor = log.data.newStatus === 'approved' ? 'var(--macos-green)' : 
                                       log.data.newStatus === 'rejected' ? 'var(--macos-red)' : 'var(--macos-blue)';
                            title = `Loan ${log.data.newStatus}`;
                            description = `Loan ${log.data.loanId} ${log.data.newStatus} by ${log.userName}`;
                            break;
                        case 'agent_create':
                            icon = 'fa-user-plus';
                            iconColor = 'var(--macos-green)';
                            title = 'Agent Created';
                            description = `${log.data.agentName} created by ${log.userName}`;
                            break;
                        case 'user_status_update':
                            icon = 'fa-user-cog';
                            iconColor = log.data.newStatus === 'active' ? 'var(--macos-green)' : 
                                       log.data.newStatus === 'suspended' ? 'var(--macos-orange)' : 
                                       'var(--macos-red)';
                            title = `User ${log.data.newStatus}`;
                            description = `${log.data.userName} ${log.data.newStatus} by ${log.userName}`;
                            break;
                        case 'commission_payment':
                            icon = 'fa-money-check';
                            iconColor = 'var(--macos-green)';
                            title = 'Commission Paid';
                            description = `${Utils.formatCurrency(log.data.amount)} paid to ${log.data.agentName}`;
                            break;
                        default:
                            title = log.action.replace(/_/g, ' ');
                            description = JSON.stringify(log.data);
                    }
                    
                    activityHTML += `
                        <div class="activity-item">
                            <div class="activity-icon" style="background: ${iconColor};">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${title}</div>
                                <div class="activity-description">${description}</div>
                                <div class="activity-time">${Utils.formatDate(log.timestamp)}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = activityHTML;
            },
            
            updateLoansUI() {
                const container = document.getElementById('loansTableBody');
                if (!container) return;
                
                // Filter loans
                let filteredLoans = [...AppState.loans];
                
                if (AppState.filters.loanStatus !== 'all') {
                    filteredLoans = filteredLoans.filter(loan => loan.status === AppState.filters.loanStatus);
                }
                
                // Apply search filter
                const searchTerm = this.globalSearch.value.toLowerCase();
                if (searchTerm) {
                    filteredLoans = filteredLoans.filter(loan => 
                        loan.id.toLowerCase().includes(searchTerm) ||
                        (loan.customerName && loan.customerName.toLowerCase().includes(searchTerm)) ||
                        (loan.agentName && loan.agentName.toLowerCase().includes(searchTerm)) ||
                        (loan.purpose && loan.purpose.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Pagination
                const total = filteredLoans.length;
                const startIndex = (AppState.pagination.loans.page - 1) * AppState.pagination.loans.limit;
                const endIndex = startIndex + AppState.pagination.loans.limit;
                const paginatedLoans = filteredLoans.slice(startIndex, endIndex);
                
                AppState.pagination.loans.total = total;
                
                // Update pagination controls
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                
                if (pageInfo) {
                    pageInfo.textContent = `Page ${AppState.pagination.loans.page} of ${Math.ceil(total / AppState.pagination.loans.limit)}`;
                }
                
                if (prevBtn) {
                    prevBtn.disabled = AppState.pagination.loans.page <= 1;
                }
                
                if (nextBtn) {
                    nextBtn.disabled = endIndex >= total;
                }
                
                if (paginatedLoans.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar empty-icon"></i>
                                    <div class="empty-title">No Loans Found</div>
                                    <div class="empty-description">${searchTerm ? 'Try a different search term' : 'No loan applications available'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let loansHTML = '';
                
                paginatedLoans.forEach(loan => {
                    const statusClass = `status-${loan.status}`;
                    const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                    
                    loansHTML += `
                        <tr>
                            <td><strong>${loan.id}</strong></td>
                            <td>
                                <div class="d-flex align-center gap-sm">
                                    <img src="${loan.customerPhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(loan.customerName) + '&background=007AFF&color=fff'}" 
                                         alt="${loan.customerName}" 
                                         style="width: 32px; height: 32px; border-radius: 50%;">
                                    <div>
                                        <div>${loan.customerName}</div>
                                        <div class="text-muted" style="font-size: 12px;">${loan.customerId?.substring(0, 8) || 'N/A'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${loan.agentName ? `
                                    <div class="d-flex align-center gap-sm">
                                        <img src="${loan.agentPhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(loan.agentName) + '&background=34C759&color=fff'}" 
                                             alt="${loan.agentName}" 
                                             style="width: 32px; height: 32px; border-radius: 50%;">
                                        <div>
                                            <div>${loan.agentName}</div>
                                            <div class="text-muted" style="font-size: 12px;">${loan.agentId?.substring(0, 8) || 'N/A'}</div>
                                        </div>
                                    </div>
                                ` : 'Not Assigned'}
                            </td>
                            <td>${Utils.formatCurrency(loan.amount)}</td>
                            <td>${Utils.truncateText(loan.purpose || 'Not specified', 30)}</td>
                            <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-view" onclick="LoanManager.viewLoanDetails('${loan.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${loan.status === 'pending' ? `
                                        <button class="btn-icon btn-edit" onclick="LoanManager.approveLoan('${loan.id}')" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-icon btn-delete" onclick="LoanManager.rejectLoan('${loan.id}')" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = loansHTML;
            },
            
            updateAgentsUI() {
                const container = document.getElementById('agentsTableBody');
                if (!container) return;
                
                // Filter agents
                let filteredAgents = [...AppState.agents];
                
                if (AppState.filters.agentStatus !== 'all') {
                    filteredAgents = filteredAgents.filter(agent => agent.status === AppState.filters.agentStatus);
                }
                
                // Apply search filter
                const searchTerm = this.globalSearch.value.toLowerCase();
                if (searchTerm) {
                    filteredAgents = filteredAgents.filter(agent => 
                        (agent.fullName && agent.fullName.toLowerCase().includes(searchTerm)) ||
                        (agent.email && agent.email.toLowerCase().includes(searchTerm)) ||
                        (agent.agentId && agent.agentId.toLowerCase().includes(searchTerm)) ||
                        (agent.phone && agent.phone.includes(searchTerm))
                    );
                }
                
                if (filteredAgents.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-user-tie empty-icon"></i>
                                    <div class="empty-title">No Agents Found</div>
                                    <div class="empty-description">${searchTerm ? 'Try a different search term' : 'No agents registered yet'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let agentsHTML = '';
                
                filteredAgents.forEach(agent => {
                    const statusClass = `status-${agent.status}`;
                    const statusText = agent.status.charAt(0).toUpperCase() + agent.status.slice(1);
                    
                    const totalCommission = AppState.commissions
                        .filter(c => c.agentId === agent.uid && c.status === 'paid')
                        .reduce((sum, com) => sum + (com.amount || 0), 0);
                    
                    agentsHTML += `
                        <tr>
                            <td><strong>${agent.agentId || agent.uid.substring(0, 8)}</strong></td>
                            <td>
                                <div class="d-flex align-center gap-sm">
                                    <img src="${agent.profilePhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(agent.fullName) + '&background=34C759&color=fff'}" 
                                         alt="${agent.fullName}" 
                                         style="width: 32px; height: 32px; border-radius: 50%;">
                                    <div>${agent.fullName}</div>
                                </div>
                            </td>
                            <td>${agent.email}</td>
                            <td>${agent.phone || 'N/A'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${agent.totalCustomers || 0}</td>
                            <td>${Utils.formatCurrency(totalCommission)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-view" onclick="AgentManager.viewAgentDetails('${agent.uid}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-icon btn-edit" onclick="AgentManager.editAgent('${agent.uid}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${agent.status === 'active' ? `
                                        <button class="btn-icon btn-suspend" onclick="AgentManager.suspendAgent('${agent.uid}')" title="Suspend">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    ` : `
                                        <button class="btn-icon btn-edit" onclick="AgentManager.activateAgent('${agent.uid}')" title="Activate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                    <button class="btn-icon btn-delete" onclick="AgentManager.deleteAgent('${agent.uid}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = agentsHTML;
            },
            
            updateCustomersUI() {
                const container = document.getElementById('customersGrid');
                if (!container) return;
                
                // Filter customers
                let filteredCustomers = [...AppState.customers];
                
                if (AppState.filters.customerStatus !== 'all') {
                    filteredCustomers = filteredCustomers.filter(customer => customer.status === AppState.filters.customerStatus);
                }
                
                // Apply agent filter
                const agentFilter = document.getElementById('customerAgentFilter')?.value;
                if (agentFilter && agentFilter !== 'all') {
                    filteredCustomers = filteredCustomers.filter(customer => customer.assignedAgentId === agentFilter);
                }
                
                // Apply search filter
                const searchTerm = this.globalSearch.value.toLowerCase();
                if (searchTerm) {
                    filteredCustomers = filteredCustomers.filter(customer => 
                        (customer.fullName && customer.fullName.toLowerCase().includes(searchTerm)) ||
                        (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                        (customer.nrc && customer.nrc.toLowerCase().includes(searchTerm)) ||
                        (customer.phone && customer.phone.includes(searchTerm))
                    );
                }
                
                if (filteredCustomers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state w-100">
                            <i class="fas fa-users empty-icon"></i>
                            <div class="empty-title">No Customers Found</div>
                            <div class="empty-description">${searchTerm ? 'Try a different search term' : 'No customers registered yet'}</div>
                        </div>
                    `;
                    return;
                }
                
                // Update agent filter options
                this.updateAgentFilterOptions();
                
                let customersHTML = '';
                
                filteredCustomers.forEach(customer => {
                    const statusClass = `status-${customer.status}`;
                    const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                    
                    customersHTML += `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">${customer.fullName}</div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: var(--macos-spacing-md);">
                                    <img src="${customer.profilePhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(customer.fullName) + '&background=007AFF&color=fff'}" 
                                         alt="${customer.fullName}" 
                                         style="width: 80px; height: 80px; border-radius: var(--macos-radius-md); margin: 0 auto var(--macos-spacing-md); display: block;">
                                </div>
                                <div style="margin-bottom: var(--macos-spacing-sm);">
                                    <strong>Email:</strong> ${customer.email}
                                </div>
                                <div style="margin-bottom: var(--macos-spacing-sm);">
                                    <strong>Phone:</strong> ${customer.phone || 'N/A'}
                                </div>
                                <div style="margin-bottom: var(--macos-spacing-sm);">
                                    <strong>NRC:</strong> ${customer.nrc || 'N/A'}
                                </div>
                                <div style="margin-bottom: var(--macos-spacing-sm);">
                                    <strong>Agent:</strong> ${customer.agentName || 'Not Assigned'}
                                </div>
                                <div>
                                    <strong>Loans:</strong> ${customer.activeLoans || 0} active
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="action-buttons">
                                    <button class="btn-icon btn-view" onclick="CustomerManager.viewCustomerDetails('${customer.uid}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-icon btn-edit" onclick="CustomerManager.editCustomer('${customer.uid}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${customer.status === 'active' ? `
                                        <button class="btn-icon btn-suspend" onclick="CustomerManager.suspendCustomer('${customer.uid}')" title="Suspend">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="btn-icon btn-delete" onclick="CustomerManager.banCustomer('${customer.uid}')" title="Ban">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    ` : `
                                        <button class="btn-icon btn-edit" onclick="CustomerManager.activateCustomer('${customer.uid}')" title="Activate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = customersHTML;
            },
            
            updateAgentFilterOptions() {
                const agentSelect = document.getElementById('customerAgentFilter');
                const assignAgentSelect = document.getElementById('assignAgentSelect');
                const assignCustomerSelect = document.getElementById('assignCustomerSelect');
                
                if (!agentSelect && !assignAgentSelect && !assignCustomerSelect) return;
                
                const activeAgents = AppState.agents.filter(agent => agent.status === 'active');
                let agentOptions = '<option value="all">All Agents</option>';
                let assignAgentOptions = '<option value="">Choose an agent</option>';
                let customerOptions = '';
                
                activeAgents.forEach(agent => {
                    agentOptions += `<option value="${agent.uid}">${agent.fullName} (${agent.agentId || agent.uid.substring(0, 8)})</option>`;
                    assignAgentOptions += `<option value="${agent.uid}">${agent.fullName} - ${agent.agentId || agent.uid.substring(0, 8)}</option>`;
                });
                
                AppState.customers.forEach(customer => {
                    customerOptions += `<option value="${customer.uid}">${customer.fullName} - ${customer.nrc || 'No NRC'}</option>`;
                });
                
                if (agentSelect) agentSelect.innerHTML = agentOptions;
                if (assignAgentSelect) assignAgentSelect.innerHTML = assignAgentOptions;
                if (assignCustomerSelect) assignCustomerSelect.innerHTML = customerOptions;
            },
            
            updateAssignmentUI() {
                this.updateAgentFilterOptions();
            },
            
            updateCommissionsUI() {
                // Update pending commissions
                const pendingContainer = document.getElementById('pendingCommissionsBody');
                const paidContainer = document.getElementById('paidCommissionsBody');
                
                if (pendingContainer) {
                    const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                    
                    if (pendingCommissions.length === 0) {
                        pendingContainer.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-money-check-alt empty-icon"></i>
                                        <div class="empty-title">No Pending Commissions</div>
                                        <div class="empty-description">All commissions have been processed</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        let pendingHTML = '';
                        
                        pendingCommissions.forEach(commission => {
                            pendingHTML += `
                                <tr>
                                    <td><strong>${commission.id}</strong></td>
                                    <td>
                                        <div class="d-flex align-center gap-sm">
                                            <img src="${commission.agentPhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(commission.agentName) + '&background=34C759&color=fff'}" 
                                                 alt="${commission.agentName}" 
                                                 style="width: 32px; height: 32px; border-radius: 50%;">
                                            <div>${commission.agentName}</div>
                                        </div>
                                    </td>
                                    <td>${commission.customerName}</td>
                                    <td>${commission.loanId || 'N/A'}</td>
                                    <td>${Utils.formatCurrency(commission.amount)}</td>
                                    <td>${Utils.formatDateOnly(commission.createdAt)}</td>
                                    <td>
                                        <button class="btn btn-success btn-small" onclick="CommissionManager.processCommission('${commission.id}')">
                                            <i class="fas fa-money-check"></i> Pay
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        pendingContainer.innerHTML = pendingHTML;
                    }
                }
                
                if (paidContainer) {
                    const paidCommissions = AppState.commissions.filter(c => c.status === 'paid');
                    
                    if (paidCommissions.length === 0) {
                        paidContainer.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-history empty-icon"></i>
                                        <div class="empty-title">No Paid Commissions</div>
                                        <div class="empty-description">No commission payments have been made yet</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        let paidHTML = '';
                        
                        paidCommissions.forEach(commission => {
                            paidHTML += `
                                <tr>
                                    <td><strong>${commission.id}</strong></td>
                                    <td>${commission.agentName}</td>
                                    <td>${Utils.formatCurrency(commission.amount)}</td>
                                    <td>${Utils.formatDateOnly(commission.paidAt)}</td>
                                    <td>${commission.paymentMethod || 'N/A'}</td>
                                    <td>${commission.paymentReference || 'N/A'}</td>
                                </tr>
                            `;
                        });
                        
                        paidContainer.innerHTML = paidHTML;
                    }
                }
            },
            
            updateTransactionsUI() {
                const container = document.getElementById('transactionsTableBody');
                if (!container) return;
                
                // Filter transactions by date range
                let filteredTransactions = [...AppState.transactions];
                
                const dateFrom = document.getElementById('transactionDateFrom')?.value;
                const dateTo = document.getElementById('transactionDateTo')?.value;
                
                if (dateFrom) {
                    const fromDate = new Date(dateFrom).getTime();
                    filteredTransactions = filteredTransactions.filter(t => t.timestamp >= fromDate);
                }
                
                if (dateTo) {
                    const toDate = new Date(dateTo).getTime() + 86400000; // Add one day
                    filteredTransactions = filteredTransactions.filter(t => t.timestamp <= toDate);
                }
                
                if (filteredTransactions.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-exchange-alt empty-icon"></i>
                                    <div class="empty-title">No Transactions Found</div>
                                    <div class="empty-description">${dateFrom || dateTo ? 'Try a different date range' : 'No transactions recorded yet'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let transactionsHTML = '';
                
                filteredTransactions.forEach(transaction => {
                    transactionsHTML += `
                        <tr>
                            <td><strong>${transaction.id}</strong></td>
                            <td><span class="badge badge-info">${transaction.type}</span></td>
                            <td>${transaction.customerName || 'N/A'}</td>
                            <td>${transaction.agentName || 'N/A'}</td>
                            <td>${Utils.formatCurrency(transaction.amount)}</td>
                            <td>${Utils.formatDate(transaction.timestamp)}</td>
                            <td><span class="status-badge status-${transaction.status}">${transaction.status}</span></td>
                            <td>${Utils.truncateText(transaction.description || '', 40)}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = transactionsHTML;
            },
            
            updateAuditUI() {
                const container = document.getElementById('auditTableBody');
                if (!container) return;
                
                // Filter audit logs
                let filteredLogs = [...AppState.auditLogs];
                
                const actionFilter = document.getElementById('auditActionFilter')?.value;
                if (actionFilter && actionFilter !== 'all') {
                    filteredLogs = filteredLogs.filter(log => log.action.includes(actionFilter));
                }
                
                if (filteredLogs.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-history empty-icon"></i>
                                    <div class="empty-title">No Audit Logs Found</div>
                                    <div class="empty-description">${actionFilter !== 'all' ? 'Try a different filter' : 'No audit logs recorded yet'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let auditHTML = '';
                
                filteredLogs.forEach(log => {
                    auditHTML += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>
                                <div class="d-flex align-center gap-sm">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${log.userRole === 'admin' ? 'var(--macos-blue)' : log.userRole === 'agent' ? 'var(--macos-green)' : 'var(--macos-purple)'};"></div>
                                    <div>${log.userName}</div>
                                </div>
                            </td>
                            <td>${log.action.replace(/_/g, ' ')}</td>
                            <td>${Utils.truncateText(JSON.stringify(log.data), 60)}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = auditHTML;
            },
            
            updateReportsUI() {
                // Initialize yearly performance chart
                this.initYearlyPerformanceChart();
            },
            
            initCharts() {
                // Loan Volume Chart
                const loanVolumeCtx = document.getElementById('loanVolumeChart');
                if (loanVolumeCtx && !AppState.charts.loanVolume) {
                    const last7Days = Array.from({length: 7}, (_, i) => {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        return date.toLocaleDateString('en-US', { weekday: 'short' });
                    }).reverse();
                    
                    const loanData = last7Days.map(() => Math.floor(Math.random() * 50000) + 10000);
                    
                    AppState.charts.loanVolume = new Chart(loanVolumeCtx, {
                        type: 'line',
                        data: {
                            labels: last7Days,
                            datasets: [{
                                label: 'Loan Volume',
                                data: loanData,
                                borderColor: 'var(--macos-blue)',
                                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return 'K' + (value / 1000).toFixed(0) + 'K';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Loan Status Chart
                const loanStatusCtx = document.getElementById('loanStatusChart');
                if (loanStatusCtx && !AppState.charts.loanStatus) {
                    const statusCounts = {
                        pending: AppState.loans.filter(l => l.status === 'pending').length,
                        approved: AppState.loans.filter(l => l.status === 'approved').length,
                        active: AppState.loans.filter(l => l.status === 'active').length,
                        completed: AppState.loans.filter(l => l.status === 'completed').length,
                        rejected: AppState.loans.filter(l => l.status === 'rejected').length
                    };
                    
                    AppState.charts.loanStatus = new Chart(loanStatusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Pending', 'Approved', 'Active', 'Completed', 'Rejected'],
                            datasets: [{
                                data: [
                                    statusCounts.pending,
                                    statusCounts.approved,
                                    statusCounts.active,
                                    statusCounts.completed,
                                    statusCounts.rejected
                                ],
                                backgroundColor: [
                                    'var(--macos-orange)',
                                    'var(--macos-green)',
                                    'var(--macos-blue)',
                                    'var(--macos-purple)',
                                    'var(--macos-red)'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            },
            
            initYearlyPerformanceChart() {
                const yearlyCtx = document.getElementById('yearlyPerformanceChart');
                if (yearlyCtx && !AppState.charts.yearlyPerformance) {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const loanData = months.map(() => Math.floor(Math.random() * 200000) + 50000);
                    const customerData = months.map(() => Math.floor(Math.random() * 100) + 20);
                    
                    AppState.charts.yearlyPerformance = new Chart(yearlyCtx, {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Loan Volume',
                                    data: loanData,
                                    backgroundColor: 'var(--macos-blue)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'New Customers',
                                    data: customerData,
                                    type: 'line',
                                    borderColor: 'var(--macos-green)',
                                    backgroundColor: 'rgba(52, 199, 89, 0.1)',
                                    fill: true,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Loan Volume (K)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return 'K' + (value / 1000).toFixed(0) + 'K';
                                        }
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'New Customers'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                }
            },
            
            handleGlobalSearch() {
                const searchTerm = this.globalSearch.value.toLowerCase();
                
                // Update current section based on search
                switch(AppState.currentSection) {
                    case 'loans':
                        this.updateLoansUI();
                        break;
                    case 'agents':
                        this.updateAgentsUI();
                        break;
                    case 'customers':
                        this.updateCustomersUI();
                        break;
                    case 'transactions':
                        this.updateTransactionsUI();
                        break;
                    case 'audit':
                        this.updateAuditUI();
                        break;
                    default:
                        // Search across all data
                        break;
                }
            }
        };

        // ===== LOAN MANAGER =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    // Load customer details
                    const customerRef = db.ref('users/' + loan.customerId);
                    const customerSnapshot = await customerRef.once('value');
                    const customer = customerSnapshot.val();
                    
                    // Load agent details if assigned
                    let agent = null;
                    if (loan.agentId) {
                        const agentRef = db.ref('users/' + loan.agentId);
                        const agentSnapshot = await agentRef.once('value');
                        agent = agentSnapshot.val();
                    }
                    
                    this.displayLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load loan details', 'error');
                }
            },
            
            displayLoanModal(loan, customer, agent) {
                const modal = document.getElementById('loanDetailModal');
                const content = document.getElementById('loanDetailContent');
                
                const statusClass = `status-${loan.status}`;
                const statusText = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                
                // Build documents HTML
                let documentsHTML = '<h4 style="margin: var(--macos-spacing-lg) 0 var(--macos-spacing-md);">Uploaded Documents</h4>';
                
                // Customer documents
                if (customer) {
                    documentsHTML += `
                        <div style="margin-bottom: var(--macos-spacing-lg);">
                            <h5 style="margin-bottom: var(--macos-spacing-md); color: var(--macos-text-secondary);">Customer Documents</h5>
                            <div class="document-viewer">
                                ${customer.profilePhoto ? `
                                    <div class="document-card">
                                        <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.profilePhoto}', 'Customer Profile Photo')">
                                            <img src="${customer.profilePhoto}" alt="Profile Photo" class="document-image">
                                            <div class="document-overlay">
                                                <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                            </div>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">Profile Photo</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.nrcFront ? `
                                    <div class="document-card">
                                        <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.nrcFront}', 'Customer NRC Front')">
                                            <img src="${customer.nrcFront}" alt="NRC Front" class="document-image">
                                            <div class="document-overlay">
                                                <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                            </div>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">NRC Front</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.nrcBack ? `
                                    <div class="document-card">
                                        <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.nrcBack}', 'Customer NRC Back')">
                                            <img src="${customer.nrcBack}" alt="NRC Back" class="document-image">
                                            <div class="document-overlay">
                                                <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                            </div>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">NRC Back</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.proofOfIncome ? `
                                    <div class="document-card">
                                        <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.proofOfIncome}', 'Proof of Income')">
                                            <img src="${customer.proofOfIncome}" alt="Proof of Income" class="document-image">
                                            <div class="document-overlay">
                                                <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                            </div>
                                        </div>
                                        <div class="document-info">
                                            <div class="document-title">Proof of Income</div>
                                            <div class="document-type">Customer</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Loan documents
                if (loan.documents && Object.keys(loan.documents).length > 0) {
                    documentsHTML += `
                        <div style="margin-bottom: var(--macos-spacing-lg);">
                            <h5 style="margin-bottom: var(--macos-spacing-md); color: var(--macos-text-secondary);">Loan Documents</h5>
                            <div class="document-viewer">
                    `;
                    
                    for (const [docName, docUrl] of Object.entries(loan.documents)) {
                        if (docUrl) {
                            documentsHTML += `
                                <div class="document-card">
                                    <div class="document-preview" onclick="DocumentManager.viewDocument('${docUrl}', '${docName}')">
                                        <img src="${docUrl}" alt="${docName}" class="document-image">
                                        <div class="document-overlay">
                                            <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                        </div>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-title">${docName}</div>
                                        <div class="document-type">Loan Document</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    documentsHTML += `
                            </div>
                        </div>
                    `;
                }
                
                // Collateral documents
                if (loan.collateral && loan.collateral.images && loan.collateral.images.length > 0) {
                    documentsHTML += `
                        <div style="margin-bottom: var(--macos-spacing-lg);">
                            <h5 style="margin-bottom: var(--macos-spacing-md); color: var(--macos-text-secondary);">Collateral Documents</h5>
                            <div class="document-viewer">
                    `;
                    
                    loan.collateral.images.forEach((imageUrl, index) => {
                        documentsHTML += `
                            <div class="document-card">
                                <div class="document-preview" onclick="DocumentManager.viewDocument('${imageUrl}', 'Collateral Image ${index + 1}')">
                                    <img src="${imageUrl}" alt="Collateral" class="document-image">
                                    <div class="document-overlay">
                                        <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                    </div>
                                </div>
                                <div class="document-info">
                                    <div class="document-title">Collateral ${index + 1}</div>
                                    <div class="document-type">${loan.collateral.category || 'Collateral'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    documentsHTML += `
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <div>
                                <h3 class="detail-name">Loan ${loan.id}</h3>
                                <div class="detail-id">${Utils.formatCurrency(loan.amount)}  ${loan.duration} months</div>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 14px; padding: 8px 16px;">${statusText}</span>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Customer</div>
                                <div class="detail-value">${customer?.fullName || 'N/A'}</div>
                                <div class="detail-value-secondary">${customer?.nrc || 'No NRC'}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Agent</div>
                                <div class="detail-value">${agent?.fullName || 'Not Assigned'}</div>
                                <div class="detail-value-secondary">${agent?.agentId || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">${Utils.formatCurrency(loan.amount)}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Interest Rate</div>
                                <div class="detail-value">${loan.interestRate || 15}%</div>
                            </div>
                        </div>
                        
                        <div style="padding: var(--macos-spacing-xl);">
                            <h4 style="margin-bottom: var(--macos-spacing-md);">Loan Purpose</h4>
                            <div style="background: var(--macos-bg-secondary); padding: var(--macos-spacing-lg); border-radius: var(--macos-radius-md);">
                                ${loan.purpose || 'No purpose specified'}
                            </div>
                            
                            ${loan.purposeDescription ? `
                                <div style="margin-top: var(--macos-spacing-md);">
                                    <p>${loan.purposeDescription}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${documentsHTML}
                        
                        <div style="padding: 0 var(--macos-spacing-xl) var(--macos-spacing-xl);">
                            <h4 style="margin-bottom: var(--macos-spacing-md);">Loan Timeline</h4>
                            <div style="display: flex; gap: var(--macos-spacing-md);">
                                <div style="flex: 1; background: var(--macos-bg-secondary); padding: var(--macos-spacing-md); border-radius: var(--macos-radius-md);">
                                    <div style="font-size: var(--macos-font-caption); color: var(--macos-text-secondary);">Applied</div>
                                    <div>${Utils.formatDate(loan.createdAt)}</div>
                                </div>
                                
                                ${loan.approvedAt ? `
                                    <div style="flex: 1; background: var(--macos-bg-secondary); padding: var(--macos-spacing-md); border-radius: var(--macos-radius-md);">
                                        <div style="font-size: var(--macos-font-caption); color: var(--macos-text-secondary);">Approved</div>
                                        <div>${Utils.formatDate(loan.approvedAt)}</div>
                                    </div>
                                ` : ''}
                                
                                ${loan.disbursedAt ? `
                                    <div style="flex: 1; background: var(--macos-bg-secondary); padding: var(--macos-spacing-md); border-radius: var(--macos-radius-md);">
                                        <div style="font-size: var(--macos-font-caption); color: var(--macos-text-secondary);">Disbursed</div>
                                        <div>${Utils.formatDate(loan.disbursedAt)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Show/hide action buttons based on status
                const approveBtn = document.getElementById('approveLoanBtn');
                const rejectBtn = document.getElementById('rejectLoanBtn');
                
                if (loan.status === 'pending') {
                    approveBtn.style.display = 'inline-flex';
                    rejectBtn.style.display = 'inline-flex';
                    
                    approveBtn.onclick = () => this.approveLoan(loan.id);
                    rejectBtn.onclick = () => this.rejectLoan(loan.id);
                } else {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                }
                
                modal.classList.add('active');
            },
            
            async approveLoan(loanId) {
                if (!confirm('Are you sure you want to approve this loan?')) return;
                
                try {
                    Utils.showLoading('Approving loan...');
                    
                    const result = await FirebaseService.updateLoanStatus(loanId, 'approved');
                    
                    if (result.success) {
                        Utils.showToast('Loan Approved', 'Loan has been approved successfully', 'success');
                        document.getElementById('loanDetailModal').classList.remove('active');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Approval Failed', error.message || 'Failed to approve loan', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            async rejectLoan(loanId) {
                const reason = prompt('Please enter rejection reason:');
                if (!reason) return;
                
                try {
                    Utils.showLoading('Rejecting loan...');
                    
                    const result = await FirebaseService.updateLoanStatus(loanId, 'rejected', reason);
                    
                    if (result.success) {
                        Utils.showToast('Loan Rejected', 'Loan has been rejected', 'success');
                        document.getElementById('loanDetailModal').classList.remove('active');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Rejection Failed', error.message || 'Failed to reject loan', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== AGENT MANAGER =====
        const AgentManager = {
            async createAgent() {
                const form = document.getElementById('createAgentForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const agentData = {
                    fullName: document.getElementById('agentFullName').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    password: document.getElementById('agentPassword').value,
                    customAgentId: document.getElementById('agentId').value.trim(),
                    nrc: document.getElementById('agentNRC').value.trim(),
                    address: document.getElementById('agentAddress').value.trim(),
                    branch: document.getElementById('agentBranch').value.trim(),
                    commissionRate: parseFloat(document.getElementById('agentCommissionRate').value) || 2.5,
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validate email
                if (!Utils.validateEmail(agentData.email)) {
                    Utils.showToast('Validation Error', 'Please enter a valid email address', 'error');
                    return;
                }
                
                // Validate NRC
                if (!Utils.validateNRC(agentData.nrc)) {
                    Utils.showToast('Validation Error', 'Please enter a valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                // Validate password
                if (agentData.password.length < 6) {
                    Utils.showToast('Validation Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                const result = await FirebaseService.createAgent(agentData);
                
                if (result.success) {
                    Utils.showToast('Agent Created', result.message, 'success');
                    document.getElementById('createAgentModal').classList.remove('active');
                    form.reset();
                } else {
                    Utils.showToast('Creation Failed', result.error, 'error');
                }
            },
            
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agentRef = db.ref('users/' + agentId);
                    const snapshot = await agentRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    const agent = snapshot.val();
                    
                    // Load agent's customers
                    const customersRef = db.ref('users').orderByChild('assignedAgentId').equalTo(agentId);
                    const customersSnapshot = await customersRef.once('value');
                    const customers = [];
                    
                    customersSnapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        if (customer.userType === 'customer') {
                            customers.push(customer);
                        }
                    });
                    
                    // Load agent's loans
                    const loansRef = db.ref('loans').orderByChild('agentId').equalTo(agentId);
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loans.push(loan);
                    });
                    
                    // Load agent's commissions
                    const commissionsRef = db.ref('commissions').orderByChild('agentId').equalTo(agentId);
                    const commissionsSnapshot = await commissionsRef.once('value');
                    const commissions = [];
                    
                    commissionsSnapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commissions.push(commission);
                    });
                    
                    this.displayAgentDetails(agent, customers, loans, commissions);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load agent details', 'error');
                }
            },
            
            displayAgentDetails(agent, customers, loans, commissions) {
                // Create a modal for agent details
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Agent Details</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-view">
                                <div class="detail-header">
                                    <img src="${agent.profilePhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(agent.fullName) + '&background=34C759&color=fff'}" 
                                         alt="${agent.fullName}" 
                                         class="detail-avatar">
                                    <div class="detail-info">
                                        <h3 class="detail-name">${agent.fullName}</h3>
                                        <div class="detail-id">${agent.agentId || agent.uid.substring(0, 8)}</div>
                                        <div style="margin-top: var(--macos-spacing-sm);">
                                            <span class="status-badge status-${agent.status}">${agent.status}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="detail-grid">
                                    <div class="detail-card">
                                        <div class="detail-label">Email</div>
                                        <div class="detail-value">${agent.email}</div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">Phone</div>
                                        <div class="detail-value">${agent.phone || 'N/A'}</div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">NRC</div>
                                        <div class="detail-value">${agent.nrc || 'N/A'}</div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">Commission Rate</div>
                                        <div class="detail-value">${agent.commissionRate || 2.5}%</div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">Total Customers</div>
                                        <div class="detail-value">${customers.length}</div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">Total Loans</div>
                                        <div class="detail-value">${loans.length}</div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">Total Commission</div>
                                        <div class="detail-value">
                                            ${Utils.formatCurrency(commissions.filter(c => c.status === 'paid').reduce((sum, c) => sum + (c.amount || 0), 0))}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <div class="detail-label">Pending Commission</div>
                                        <div class="detail-value">
                                            ${Utils.formatCurrency(commissions.filter(c => c.status === 'pending').reduce((sum, c) => sum + (c.amount || 0), 0))}
                                        </div>
                                    </div>
                                </div>
                                
                                ${agent.nrcFront || agent.nrcBack ? `
                                    <div style="padding: var(--macos-spacing-xl);">
                                        <h4 style="margin-bottom: var(--macos-spacing-md);">Agent Documents</h4>
                                        <div class="document-viewer">
                                            ${agent.nrcFront ? `
                                                <div class="document-card">
                                                    <div class="document-preview" onclick="DocumentManager.viewDocument('${agent.nrcFront}', 'Agent NRC Front')">
                                                        <img src="${agent.nrcFront}" alt="NRC Front" class="document-image">
                                                        <div class="document-overlay">
                                                            <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                                        </div>
                                                    </div>
                                                    <div class="document-info">
                                                        <div class="document-title">NRC Front</div>
                                                        <div class="document-type">Agent</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${agent.nrcBack ? `
                                                <div class="document-card">
                                                    <div class="document-preview" onclick="DocumentManager.viewDocument('${agent.nrcBack}', 'Agent NRC Back')">
                                                        <img src="${agent.nrcBack}" alt="NRC Back" class="document-image">
                                                        <div class="document-overlay">
                                                            <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                                        </div>
                                                    </div>
                                                    <div class="document-info">
                                                        <div class="document-title">NRC Back</div>
                                                        <div class="document-type">Agent</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${agent.notes ? `
                                    <div style="padding: 0 var(--macos-spacing-xl) var(--macos-spacing-xl);">
                                        <h4 style="margin-bottom: var(--macos-spacing-md);">Admin Notes</h4>
                                        <div style="background: var(--macos-bg-secondary); padding: var(--macos-spacing-md); border-radius: var(--macos-radius-md);">
                                            ${agent.notes}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Close</button>
                            <button class="btn btn-primary" onclick="AgentManager.editAgent('${agent.uid}')">
                                <i class="fas fa-edit"></i> Edit Agent
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async editAgent(agentId) {
                // Implementation for editing agent
                Utils.showToast('Coming Soon', 'Edit agent feature coming soon', 'info');
            },
            
            async suspendAgent(agentId) {
                if (!confirm('Are you sure you want to suspend this agent?')) return;
                
                try {
                    Utils.showLoading('Suspending agent...');
                    
                    const result = await FirebaseService.updateUserStatus(agentId, 'suspended', 'Suspended by admin');
                    
                    if (result.success) {
                        Utils.showToast('Agent Suspended', result.message, 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Suspension Failed', error.message || 'Failed to suspend agent', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            async activateAgent(agentId) {
                try {
                    Utils.showLoading('Activating agent...');
                    
                    const result = await FirebaseService.updateUserStatus(agentId, 'active', 'Activated by admin');
                    
                    if (result.success) {
                        Utils.showToast('Agent Activated', result.message, 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Activation Failed', error.message || 'Failed to activate agent', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            async deleteAgent(agentId) {
                if (!confirm('WARNING: This will permanently delete the agent account. Are you sure?')) return;
                
                try {
                    Utils.showLoading('Deleting agent...');
                    
                    const result = await FirebaseService.deleteUser(agentId);
                    
                    if (result.success) {
                        Utils.showToast('Agent Deleted', result.message, 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Deletion Failed', error.message || 'Failed to delete agent', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== CUSTOMER MANAGER =====
        const CustomerManager = {
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    const customer = snapshot.val();
                    
                    // Load customer's loans
                    const loansRef = db.ref('loans').orderByChild('customerId').equalTo(customerId);
                    const loansSnapshot = await loansRef.once('value');
                    const loans = [];
                    
                    loansSnapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    // Load assigned agent if any
                    let agent = null;
                    if (customer.assignedAgentId) {
                        const agentRef = db.ref('users/' + customer.assignedAgentId);
                        const agentSnapshot = await agentRef.once('value');
                        agent = agentSnapshot.val();
                    }
                    
                    this.displayCustomerModal(customer, loans, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer details:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error', 'Failed to load customer details', 'error');
                }
            },
            
            displayCustomerModal(customer, loans, agent) {
                const modal = document.getElementById('customerDetailModal');
                const content = document.getElementById('customerDetailContent');
                
                const statusClass = `status-${customer.status}`;
                const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                
                // Calculate loan stats
                const totalLoans = loans.length;
                const activeLoans = loans.filter(l => l.status === 'active').length;
                const totalBorrowed = loans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                const totalRepaid = loans.reduce((sum, loan) => sum + (loan.totalPaid || 0), 0);
                
                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-header">
                            <img src="${customer.profilePhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(customer.fullName) + '&background=007AFF&color=fff'}" 
                                 alt="${customer.fullName}" 
                                 class="detail-avatar">
                            <div class="detail-info">
                                <h3 class="detail-name">${customer.fullName}</h3>
                                <div class="detail-id">${customer.email}</div>
                                <div style="margin-top: var(--macos-spacing-sm);">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">${customer.phone || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">NRC</div>
                                <div class="detail-value">${customer.nrc || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Residence</div>
                                <div class="detail-value">${Utils.truncateText(customer.residence || 'N/A', 30)}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Occupation</div>
                                <div class="detail-value">${customer.occupation || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Assigned Agent</div>
                                <div class="detail-value">${agent?.fullName || 'Not Assigned'}</div>
                                <div class="detail-value-secondary">${agent?.agentId || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Total Loans</div>
                                <div class="detail-value">${totalLoans}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Active Loans</div>
                                <div class="detail-value">${activeLoans}</div>
                            </div>
                            
                            <div class="detail-card">
                                <div class="detail-label">Total Borrowed</div>
                                <div class="detail-value">${Utils.formatCurrency(totalBorrowed)}</div>
                            </div>
                        </div>
                        
                        ${customer.nrcFront || customer.nrcBack ? `
                            <div style="padding: var(--macos-spacing-xl);">
                                <h4 style="margin-bottom: var(--macos-spacing-md);">Customer Documents</h4>
                                <div class="document-viewer">
                                    ${customer.nrcFront ? `
                                        <div class="document-card">
                                            <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.nrcFront}', 'Customer NRC Front')">
                                                <img src="${customer.nrcFront}" alt="NRC Front" class="document-image">
                                                <div class="document-overlay">
                                                    <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                                </div>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">NRC Front</div>
                                                <div class="document-type">Customer</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.nrcBack ? `
                                        <div class="document-card">
                                            <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.nrcBack}', 'Customer NRC Back')">
                                                <img src="${customer.nrcBack}" alt="NRC Back" class="document-image">
                                                <div class="document-overlay">
                                                    <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                                </div>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">NRC Back</div>
                                                <div class="document-type">Customer</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.proofOfIncome ? `
                                        <div class="document-card">
                                            <div class="document-preview" onclick="DocumentManager.viewDocument('${customer.proofOfIncome}', 'Proof of Income')">
                                                <img src="${customer.proofOfIncome}" alt="Proof of Income" class="document-image">
                                                <div class="document-overlay">
                                                    <i class="fas fa-search-plus" style="color: white; font-size: 24px;"></i>
                                                </div>
                                            </div>
                                            <div class="document-info">
                                                <div class="document-title">Proof of Income</div>
                                                <div class="document-type">Customer</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${loans.length > 0 ? `
                            <div style="padding: 0 var(--macos-spacing-xl) var(--macos-spacing-xl);">
                                <h4 style="margin-bottom: var(--macos-spacing-md);">Loan History</h4>
                                <div style="background: var(--macos-bg-secondary); padding: var(--macos-spacing-md); border-radius: var(--macos-radius-md);">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--macos-spacing-md);">
                                        ${loans.slice(0, 3).map(loan => `
                                            <div>
                                                <div style="font-weight: 500;">${loan.id}</div>
                                                <div style="font-size: var(--macos-font-caption); color: var(--macos-text-secondary);">
                                                    ${Utils.formatCurrency(loan.amount)}  ${loan.status}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${loans.length > 3 ? `
                                        <div style="margin-top: var(--macos-spacing-md); text-align: center;">
                                            <button class="btn btn-outline btn-small" onclick="UIManager.showSection('loans')">
                                                View all ${loans.length} loans
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Set up action buttons
                const suspendBtn = document.getElementById('suspendCustomerBtn');
                const banBtn = document.getElementById('banCustomerBtn');
                const activateBtn = document.getElementById('activateCustomerBtn');
                
                if (customer.status === 'active') {
                    suspendBtn.style.display = 'inline-flex';
                    banBtn.style.display = 'inline-flex';
                    activateBtn.style.display = 'none';
                    
                    suspendBtn.onclick = () => this.suspendCustomer(customer.uid);
                    banBtn.onclick = () => this.banCustomer(customer.uid);
                } else {
                    suspendBtn.style.display = 'none';
                    banBtn.style.display = 'none';
                    activateBtn.style.display = 'inline-flex';
                    
                    activateBtn.onclick = () => this.activateCustomer(customer.uid);
                }
                
                modal.classList.add('active');
            },
            
            async suspendCustomer(customerId) {
                if (!confirm('Are you sure you want to suspend this customer?')) return;
                
                try {
                    Utils.showLoading('Suspending customer...');
                    
                    const result = await FirebaseService.updateUserStatus(customerId, 'suspended', 'Suspended by admin');
                    
                    if (result.success) {
                        Utils.showToast('Customer Suspended', result.message, 'success');
                        document.getElementById('customerDetailModal').classList.remove('active');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Suspension Failed', error.message || 'Failed to suspend customer', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            async banCustomer(customerId) {
                if (!confirm('Are you sure you want to ban this customer? This action cannot be undone.')) return;
                
                try {
                    Utils.showLoading('Banning customer...');
                    
                    const result = await FirebaseService.updateUserStatus(customerId, 'banned', 'Banned by admin');
                    
                    if (result.success) {
                        Utils.showToast('Customer Banned', result.message, 'success');
                        document.getElementById('customerDetailModal').classList.remove('active');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Ban Failed', error.message || 'Failed to ban customer', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            async activateCustomer(customerId) {
                try {
                    Utils.showLoading('Activating customer...');
                    
                    const result = await FirebaseService.updateUserStatus(customerId, 'active', 'Activated by admin');
                    
                    if (result.success) {
                        Utils.showToast('Customer Activated', result.message, 'success');
                        document.getElementById('customerDetailModal').classList.remove('active');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Activation Failed', error.message || 'Failed to activate customer', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            async editCustomer(customerId) {
                // Implementation for editing customer
                Utils.showToast('Coming Soon', 'Edit customer feature coming soon', 'info');
            },
            
            async deleteCustomer(customerId) {
                if (!confirm('WARNING: This will permanently delete the customer account. Are you sure?')) return;
                
                try {
                    Utils.showLoading('Deleting customer...');
                    
                    const result = await FirebaseService.deleteUser(customerId);
                    
                    if (result.success) {
                        Utils.showToast('Customer Deleted', result.message, 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Deletion Failed', error.message || 'Failed to delete customer', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== ASSIGNMENT MANAGER =====
        const AssignmentManager = {
            async saveAssignment() {
                const agentId = document.getElementById('assignAgentSelect').value;
                const customerSelect = document.getElementById('assignCustomerSelect');
                const selectedCustomers = Array.from(customerSelect.selectedOptions).map(option => option.value);
                
                if (!agentId) {
                    Utils.showToast('Validation Error', 'Please select an agent', 'error');
                    return;
                }
                
                if (selectedCustomers.length === 0) {
                    Utils.showToast('Validation Error', 'Please select at least one customer', 'error');
                    return;
                }
                
                try {
                    Utils.showLoading('Assigning customers...');
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const customerId of selectedCustomers) {
                        const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    }
                    
                    if (errorCount === 0) {
                        Utils.showToast('Assignment Successful', 
                            `${successCount} customer(s) assigned successfully`, 
                            'success');
                    } else if (successCount > 0) {
                        Utils.showToast('Partial Success', 
                            `${successCount} customer(s) assigned, ${errorCount} failed`, 
                            'warning');
                    } else {
                        Utils.showToast('Assignment Failed', 
                            'Failed to assign customers', 
                            'error');
                    }
                    
                    // Clear selection
                    customerSelect.selectedIndex = -1;
                    document.getElementById('assignAgentSelect').selectedIndex = 0;
                    
                } catch (error) {
                    console.error('Error assigning customers:', error);
                    Utils.showToast('Assignment Failed', 'Failed to assign customers', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== COMMISSION MANAGER =====
        const CommissionManager = {
            async processCommission(commissionId) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    const snapshot = await commissionRef.once('value');
                    
                    if (!snapshot.exists()) {
                        Utils.showToast('Error', 'Commission not found', 'error');
                        return;
                    }
                    
                    const commission = snapshot.val();
                    AppState.selectedItems.commission = commission;
                    
                    // Populate modal
                    document.getElementById('commissionAgentName').textContent = commission.agentName;
                    document.getElementById('commissionAgentId').textContent = commission.agentId || commission.agentId;
                    document.getElementById('commissionAmount').textContent = Utils.formatCurrency(commission.amount);
                    document.getElementById('paymentAmount').value = commission.amount;
                    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                    
                    document.getElementById('commissionPaymentModal').classList.add('active');
                } catch (error) {
                    console.error('Error processing commission:', error);
                    Utils.showToast('Error', 'Failed to load commission details', 'error');
                }
            },
            
            async processPayment() {
                const form = document.getElementById('commissionPaymentForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const paymentData = {
                    amount: parseFloat(document.getElementById('paymentAmount').value),
                    paymentMethod: document.getElementById('paymentMethod').value,
                    paymentReference: document.getElementById('paymentReference').value.trim(),
                    notes: document.getElementById('paymentNotes').value.trim()
                };
                
                if (!AppState.selectedItems.commission) {
                    Utils.showToast('Error', 'No commission selected', 'error');
                    return;
                }
                
                try {
                    Utils.showLoading('Processing payment...');
                    
                    const result = await FirebaseService.processCommissionPayment(
                        AppState.selectedItems.commission.id,
                        paymentData
                    );
                    
                    if (result.success) {
                        Utils.showToast('Payment Processed', result.message, 'success');
                        document.getElementById('commissionPaymentModal').classList.remove('active');
                        form.reset();
                        AppState.selectedItems.commission = null;
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Utils.showToast('Payment Failed', error.message || 'Failed to process payment', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // ===== DOCUMENT MANAGER =====
        const DocumentManager = {
            viewDocument(url, title = 'Document') {
                const modal = document.getElementById('documentViewerModal');
                const content = document.getElementById('documentViewerContent');
                const downloadBtn = document.getElementById('downloadDocumentBtn');
                
                document.getElementById('documentViewerTitle').textContent = title;
                downloadBtn.href = url;
                downloadBtn.download = title.replace(/\s+/g, '_') + '.' + url.split('.').pop();
                
                if (Utils.isImageUrl(url)) {
                    content.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                            <img src="${url}" alt="${title}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="padding: var(--macos-spacing-xl);">
                            <div style="text-align: center; margin-bottom: var(--macos-spacing-xl);">
                                <i class="fas fa-file-alt" style="font-size: 64px; color: var(--macos-gray-3);"></i>
                            </div>
                            <h4 style="text-align: center; margin-bottom: var(--macos-spacing-md);">${title}</h4>
                            <p style="text-align: center; color: var(--macos-text-secondary);">
                                This document cannot be previewed. Please download to view.
                            </p>
                            <div style="text-align: center; margin-top: var(--macos-spacing-xl);">
                                <a href="${url}" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt"></i> Open in New Tab
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                modal.classList.add('active');
            }
        };

        // ===== QUICK ACTION MANAGER =====
        const QuickActionManager = {
            async approvePendingLoans() {
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending');
                
                if (pendingLoans.length === 0) {
                    Utils.showToast('No Action Needed', 'No pending loans to approve', 'info');
                    return;
                }
                
                if (!confirm(`Approve all ${pendingLoans.length} pending loans?`)) return;
                
                try {
                    Utils.showLoading(`Approving ${pendingLoans.length} loans...`);
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const loan of pendingLoans) {
                        const result = await FirebaseService.updateLoanStatus(loan.id, 'approved', 'Bulk approval');
                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    }
                    
                    if (errorCount === 0) {
                        Utils.showToast('Bulk Approval Complete', 
                            `${successCount} loan(s) approved successfully`, 
                            'success');
                    } else if (successCount > 0) {
                        Utils.showToast('Partial Success', 
                            `${successCount} loan(s) approved, ${errorCount} failed`, 
                            'warning');
                    } else {
                        Utils.showToast('Bulk Approval Failed', 
                            'Failed to approve loans', 
                            'error');
                    }
                    
                    document.getElementById('quickActionModal').classList.remove('active');
                    
                } catch (error) {
                    console.error('Error in bulk approval:', error);
                    Utils.showToast('Bulk Approval Failed', 'An error occurred', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },
            
            generateMonthlyReport() {
                Utils.showToast('Report Generation', 'Monthly report generation started', 'info');
                document.getElementById('quickActionModal').classList.remove('active');
                
                // Simulate report generation
                setTimeout(() => {
                    Utils.showToast('Report Ready', 'Monthly report has been generated', 'success');
                }, 3000);
            },
            
            auditSystem() {
                Utils.showToast('System Audit', 'System audit initiated', 'info');
                document.getElementById('quickActionModal').classList.remove('active');
                
                // Simulate audit
                setTimeout(() => {
                    Utils.showToast('Audit Complete', 'System audit completed successfully', 'success');
                }, 2000);
            },
            
            backupData() {
                Utils.showToast('Data Backup', 'System backup initiated', 'info');
                document.getElementById('quickActionModal').classList.remove('active');
                
                // Simulate backup
                setTimeout(() => {
                    Utils.showToast('Backup Complete', 'System backup completed successfully', 'success');
                }, 2500);
            }
        };

        // ===== MODAL MANAGER =====
        const ModalManager = {
            closeLoanModal() {
                document.getElementById('loanDetailModal').classList.remove('active');
            },
            
            closeCreateAgentModal() {
                document.getElementById('createAgentModal').classList.remove('active');
                document.getElementById('createAgentForm').reset();
            },
            
            closeCustomerModal() {
                document.getElementById('customerDetailModal').classList.remove('active');
            },
            
            closeDocumentViewer() {
                document.getElementById('documentViewerModal').classList.remove('active');
            },
            
            closeCommissionModal() {
                document.getElementById('commissionPaymentModal').classList.remove('active');
                document.getElementById('commissionPaymentForm').reset();
                AppState.selectedItems.commission = null;
            },
            
            closeQuickActionModal() {
                document.getElementById('quickActionModal').classList.remove('active');
            }
        };

        // ===== PAGINATION HANDLERS =====
        document.getElementById('prevPageBtn')?.addEventListener('click', () => {
            if (AppState.pagination.loans.page > 1) {
                AppState.pagination.loans.page--;
                UIManager.updateLoansUI();
            }
        });
        
        document.getElementById('nextPageBtn')?.addEventListener('click', () => {
            const totalPages = Math.ceil(AppState.pagination.loans.total / AppState.pagination.loans.limit);
            if (AppState.pagination.loans.page < totalPages) {
                AppState.pagination.loans.page++;
                UIManager.updateLoansUI();
            }
        });

        // ===== TAB HANDLERS =====
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });

        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Set current year for date inputs
            const currentDate = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = currentDate;
                }
                input.max = currentDate;
            });
        });

        // ===== EXPORT GLOBAL FUNCTIONS =====
        window.UIManager = UIManager;
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.AssignmentManager = AssignmentManager;
        window.CommissionManager = CommissionManager;
        window.DocumentManager = DocumentManager;
        window.QuickActionManager = QuickActionManager;
        window.ModalManager = ModalManager;
        window.Utils = Utils;
    </script>
</body>
</html>
