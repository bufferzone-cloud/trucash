<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash Admin Panel</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Cloudinary Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        /* ===== MAC OS THEME ===== */
        :root {
            --macos-white: #ffffff;
            --macos-gray-1: #f5f5f7;
            --macos-gray-2: #e8e8ed;
            --macos-gray-3: #d2d2d7;
            --macos-gray-4: #86868b;
            --macos-gray-5: #515154;
            --macos-gray-6: #1d1d1f;
            
            --macos-blue: #007AFF;
            --macos-green: #34C759;
            --macos-orange: #FF9500;
            --macos-red: #FF3B30;
            --macos-purple: #AF52DE;
            --macos-yellow: #FFCC00;
            
            --macos-sidebar-width: 260px;
            --macos-header-height: 60px;
            --macos-border-radius: 12px;
            --macos-border-radius-sm: 8px;
            --macos-border-radius-lg: 16px;
            
            --macos-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --macos-shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --macos-shadow-inset: inset 0 1px 0 rgba(255, 255, 255, 0.1);
            
            --macos-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--macos-font-family);
            background: var(--macos-white);
            color: var(--macos-gray-6);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: var(--macos-white);
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--macos-sidebar-width);
            background: var(--macos-white);
            border-right: 1px solid var(--macos-gray-2);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--macos-blue), var(--macos-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-section {
            padding: 20px 0;
            border-bottom: 1px solid var(--macos-gray-2);
        }
        
        .section-title {
            padding: 0 20px 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--macos-gray-4);
        }
        
        .nav-list {
            list-style: none;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--macos-gray-5);
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: var(--macos-gray-1);
            color: var(--macos-gray-6);
        }
        
        .nav-item.active {
            background: rgba(0, 122, 255, 0.08);
            color: var(--macos-blue);
            border-left-color: var(--macos-blue);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        .badge {
            background: var(--macos-red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--macos-sidebar-width);
            min-height: 100vh;
            background: var(--macos-white);
        }
        
        .top-bar {
            height: var(--macos-header-height);
            border-bottom: 1px solid var(--macos-gray-2);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--macos-white);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .page-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--macos-gray-5);
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 12px;
            color: var(--macos-gray-4);
        }
        
        /* ===== CONTENT SECTIONS ===== */
        .content-section {
            display: none;
            padding: 24px;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title-large {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }
        
        .section-subtitle {
            font-size: 14px;
            color: var(--macos-gray-4);
            margin-top: 4px;
        }
        
        /* ===== CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius);
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.blue {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        .stat-icon.green {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .stat-icon.orange {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .stat-icon.purple {
            background: rgba(175, 82, 222, 0.1);
            color: var(--macos-purple);
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stat-trend.positive {
            color: var(--macos-green);
        }
        
        .stat-trend.negative {
            color: var(--macos-red);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--macos-gray-6);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--macos-gray-4);
        }
        
        /* ===== TABLES ===== */
        .data-table-container {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius);
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--macos-gray-1);
        }
        
        .table-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .table-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--macos-gray-6);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 13px;
            color: var(--macos-gray-5);
            border-bottom: 1px solid var(--macos-gray-2);
            background: var(--macos-gray-1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 20px 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            font-size: 14px;
            vertical-align: middle;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background: var(--macos-gray-1);
        }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .status-badge.pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .status-badge.active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .status-badge.approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .status-badge.rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .status-badge.suspended {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        .status-badge.banned {
            background: rgba(0, 0, 0, 0.1);
            color: var(--macos-gray-6);
        }
        
        .status-badge.completed {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--macos-gray-6);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            font-size: 14px;
            font-family: var(--macos-font-family);
            transition: all 0.2s ease;
            background: var(--macos-white);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-input.disabled {
            background: var(--macos-gray-1);
            color: var(--macos-gray-4);
            cursor: not-allowed;
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--macos-border-radius-sm);
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--macos-font-family);
        }
        
        .btn i {
            font-size: 14px;
        }
        
        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }
        
        .btn-success {
            background: var(--macos-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #2aa44f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.2);
        }
        
        .btn-danger {
            background: var(--macos-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d70015;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--macos-blue);
            border: 1px solid var(--macos-blue);
        }
        
        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.08);
        }
        
        .btn-outline-danger {
            background: transparent;
            color: var(--macos-red);
            border: 1px solid var(--macos-red);
        }
        
        .btn-outline-danger:hover {
            background: rgba(255, 59, 48, 0.08);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--macos-white);
            border-radius: var(--macos-border-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-lg);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--macos-gray-6);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--macos-gray-4);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
        }
        
        .modal-close:hover {
            background: var(--macos-gray-1);
            color: var(--macos-gray-6);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--macos-gray-2);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* ===== DOCUMENT VIEWER ===== */
        .document-viewer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .document-card {
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow);
        }
        
        .document-preview {
            height: 150px;
            background: var(--macos-gray-1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .document-info {
            padding: 12px;
            border-top: 1px solid var(--macos-gray-2);
        }
        
        .document-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .document-type {
            font-size: 12px;
            color: var(--macos-gray-4);
        }
        
        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--macos-gray-2);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .toast {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-left: 4px solid var(--macos-blue);
            border-radius: var(--macos-border-radius);
            padding: 16px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: var(--macos-shadow);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.active {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left-color: var(--macos-green);
        }
        
        .toast.error {
            border-left-color: var(--macos-red);
        }
        
        .toast.warning {
            border-left-color: var(--macos-orange);
        }
        
        .toast-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--macos-gray-6);
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--macos-gray-5);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .table-actions {
                flex-wrap: wrap;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            .modal-content {
                max-height: 80vh;
            }
        }
        
        @media (max-width: 480px) {
            .top-bar {
                padding: 0 16px;
            }
            
            .content-section {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
        }
        
        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--macos-gray-1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--macos-gray-3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--macos-gray-4);
        }
        
        /* ===== CHART CONTAINERS ===== */
        .chart-container {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--macos-gray-6);
        }
        
        /* ===== DETAIL VIEWS ===== */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .detail-card {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            padding: 20px;
        }
        
        .detail-label {
            font-size: 12px;
            color: var(--macos-gray-4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--macos-gray-6);
        }
        
        /* ===== SEARCH AND FILTER ===== */
        .search-box {
            position: relative;
            max-width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            font-size: 14px;
            background: var(--macos-white);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--macos-gray-4);
            pointer-events: none;
        }
        
        .filter-dropdown {
            padding: 10px 16px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            font-size: 14px;
            background: var(--macos-white);
            cursor: pointer;
            min-width: 150px;
        }
        
        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--macos-gray-4);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--macos-gray-3);
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-state-message {
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        /* ===== AGENT CREATION FORM ===== */
        .agent-creation-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .password-display {
            background: var(--macos-gray-1);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            padding: 12px 16px;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .password-display .copy-btn {
            background: none;
            border: none;
            color: var(--macos-blue);
            cursor: pointer;
            font-size: 14px;
        }
        
        /* ===== ACTION BUTTONS IN TABLE ===== */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* ===== IMAGE MODAL ===== */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .image-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        
        .image-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* ===== COMMISSION CALCULATOR ===== */
        .commission-calculator {
            background: linear-gradient(135deg, var(--macos-purple), var(--macos-blue));
            border-radius: var(--macos-border-radius);
            padding: 24px;
            color: white;
            margin-bottom: 24px;
        }
        
        .commission-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .commission-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .commission-amount {
            font-size: 36px;
            font-weight: 700;
        }
        
        .commission-breakdown {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ===== TABS ===== */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--macos-gray-2);
            margin-bottom: 24px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--macos-gray-4);
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: var(--macos-gray-6);
        }
        
        .tab.active {
            color: var(--macos-blue);
            border-bottom-color: var(--macos-blue);
        }
        
        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid var(--macos-gray-2);
        }
        
        .page-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            background: var(--macos-white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .page-btn:hover {
            border-color: var(--macos-blue);
            color: var(--macos-blue);
        }
        
        .page-btn.active {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ===== MOBILE MENU TOGGLE ===== */
        .mobile-menu-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            background: var(--macos-white);
            cursor: pointer;
            font-size: 20px;
            color: var(--macos-gray-5);
        }
        
        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: flex;
            }
        }
        
        /* ===== AGENT ASSIGNMENT ===== */
        .assignment-section {
            background: var(--macos-gray-1);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .assignment-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }
        
        /* ===== LOAN APPROVAL WORKFLOW ===== */
        .approval-workflow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--macos-gray-1);
            border-radius: var(--macos-border-radius);
        }
        
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
            position: relative;
        }
        
        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--macos-gray-3);
            z-index: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--macos-white);
            border: 2px solid var(--macos-gray-3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--macos-gray-4);
            position: relative;
            z-index: 2;
        }
        
        .workflow-step.active .step-circle {
            background: var(--macos-blue);
            border-color: var(--macos-blue);
            color: white;
        }
        
        .workflow-step.completed .step-circle {
            background: var(--macos-green);
            border-color: var(--macos-green);
            color: white;
        }
        
        .step-label {
            font-size: 12px;
            color: var(--macos-gray-4);
            text-align: center;
        }
        
        .workflow-step.active .step-label {
            color: var(--macos-blue);
            font-weight: 600;
        }
        
        /* ===== DATE RANGE PICKER ===== */
        .date-range-picker {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            font-size: 14px;
            min-width: 150px;
        }
        
        /* ===== EXPORT BUTTON ===== */
        .export-btn {
            background: var(--macos-green);
            color: white;
            border: none;
            border-radius: var(--macos-border-radius-sm);
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .export-btn:hover {
            background: #2aa44f;
            transform: translateY(-1px);
        }
        
        /* ===== INFO TOOLTIP ===== */
        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--macos-gray-6);
            color: white;
            text-align: center;
            border-radius: var(--macos-border-radius-sm);
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* ===== CARD VIEW ===== */
        .card-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .user-card {
            background: var(--macos-white);
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius);
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--macos-shadow-lg);
        }
        
        .user-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--macos-gray-2);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .user-email {
            font-size: 13px;
            color: var(--macos-gray-4);
        }
        
        .user-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .user-detail-item {
            font-size: 13px;
        }
        
        .detail-key {
            color: var(--macos-gray-4);
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--macos-gray-6);
        }
        
        /* ===== CONNECTION STATUS ===== */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: var(--macos-gray-1);
            color: var(--macos-gray-5);
        }
        
        .connection-status.online {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .connection-status.offline {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            height: 6px;
            background: var(--macos-gray-2);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--macos-blue);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* ===== SWITCH TOGGLE ===== */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--macos-gray-2);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: var(--macos-green);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* ===== LOADING SKELETON ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--macos-gray-1) 25%, var(--macos-gray-2) 50%, var(--macos-gray-1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--macos-border-radius-sm);
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-title {
            height: 24px;
            margin-bottom: 16px;
        }
        
        /* ===== BREADCRUMB ===== */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--macos-gray-4);
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .breadcrumb-separator {
            color: var(--macos-gray-3);
        }
        
        .breadcrumb-item.active {
            color: var(--macos-gray-6);
            font-weight: 600;
        }
        
        /* ===== ALERT ===== */
        .alert {
            padding: 16px;
            border-radius: var(--macos-border-radius-sm);
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .alert-info {
            background: rgba(0, 122, 255, 0.1);
            border: 1px solid rgba(0, 122, 255, 0.2);
            color: var(--macos-blue);
        }
        
        .alert-warning {
            background: rgba(255, 149, 0, 0.1);
            border: 1px solid rgba(255, 149, 0, 0.2);
            color: var(--macos-orange);
        }
        
        .alert-success {
            background: rgba(52, 199, 89, 0.1);
            border: 1px solid rgba(52, 199, 89, 0.2);
            color: var(--macos-green);
        }
        
        .alert-danger {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
            color: var(--macos-red);
        }
        
        .alert-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .alert-message {
            font-size: 13px;
        }
        
        /* ===== TAG ===== */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: var(--macos-gray-1);
            color: var(--macos-gray-5);
        }
        
        .tag-primary {
            background: rgba(0, 122, 255, 0.1);
            color: var(--macos-blue);
        }
        
        .tag-success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--macos-green);
        }
        
        .tag-warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--macos-orange);
        }
        
        .tag-danger {
            background: rgba(255, 59, 48, 0.1);
            color: var(--macos-red);
        }
        
        /* ===== DIVIDER ===== */
        .divider {
            height: 1px;
            background: var(--macos-gray-2);
            margin: 24px 0;
            border: none;
        }
        
        /* ===== ACCORDION ===== */
        .accordion {
            border: 1px solid var(--macos-gray-2);
            border-radius: var(--macos-border-radius-sm);
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .accordion-header {
            padding: 16px 20px;
            background: var(--macos-gray-1);
            border-bottom: 1px solid var(--macos-gray-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .accordion-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--macos-gray-6);
        }
        
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        
        .accordion.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            padding: 20px;
            display: none;
        }
        
        .accordion.active .accordion-content {
            display: block;
        }
        
        /* ===== RATING ===== */
        .rating {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .rating-star {
            color: var(--macos-gray-3);
            font-size: 14px;
        }
        
        .rating-star.filled {
            color: var(--macos-yellow);
        }
        
        /* ===== TIMELINE ===== */
        .timeline {
            position: relative;
            padding-left: 20px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--macos-gray-2);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 24px;
        }
        
        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--macos-white);
            border: 2px solid var(--macos-blue);
        }
        
        .timeline-content {
            padding-left: 16px;
        }
        
        .timeline-date {
            font-size: 12px;
            color: var(--macos-gray-4);
            margin-bottom: 4px;
        }
        
        .timeline-text {
            font-size: 14px;
            color: var(--macos-gray-6);
        }
        
        /* ===== GRID LAYOUT ===== */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <img id="modalImage" alt="Preview">
            <button class="image-modal-close" onclick="ModalManager.closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="logo-text">TruCash Admin</div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Main</div>
                <ul class="nav-list">
                    <li class="nav-item active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </li>
                    <li class="nav-item" data-section="loans">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Loan Management</span>
                        <span class="badge" id="pendingLoansBadge">0</span>
                    </li>
                    <li class="nav-item" data-section="agents">
                        <i class="fas fa-users"></i>
                        <span>Agent Management</span>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Users</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="customers">
                        <i class="fas fa-user-friends"></i>
                        <span>Customer Management</span>
                        <span class="badge" id="pendingCustomersBadge">0</span>
                    </li>
                    <li class="nav-item" data-section="assignments">
                        <i class="fas fa-link"></i>
                        <span>Agent Assignment</span>
                    </li>
                    <li class="nav-item" data-section="agent-create">
                        <i class="fas fa-user-plus"></i>
                        <span>Create Agent</span>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Financial</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="commissions">
                        <i class="fas fa-money-check-alt"></i>
                        <span>Commissions</span>
                        <span class="badge" id="pendingCommissionsBadge">0</span>
                    </li>
                    <li class="nav-item" data-section="repayments">
                        <i class="fas fa-calendar-check"></i>
                        <span>Repayments</span>
                    </li>
                    <li class="nav-item" data-section="transactions">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transactions</span>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="section-title">System</div>
                <ul class="nav-list">
                    <li class="nav-item" data-section="audit">
                        <i class="fas fa-history"></i>
                        <span>Audit Log</span>
                    </li>
                    <li class="nav-item" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </li>
                </ul>
            </div>
            
            <div style="flex: 1;"></div>
            
            <div class="nav-section">
                <ul class="nav-list">
                    <li class="nav-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="page-title" id="pageTitle">Admin Dashboard</div>
                </div>
                
                <div class="user-profile">
                    <div class="connection-status" id="connectionStatus">
                        <i class="fas fa-circle"></i>
                        <span>Online</span>
                    </div>
                    <div class="avatar" id="adminAvatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="adminName">Loading...</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboardSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Dashboard Overview</div>
                        <div class="section-subtitle">Welcome back, <span id="greetingName">Admin</span>. Here's what's happening today.</div>
                    </div>
                    <div class="date-range-picker">
                        <div class="date-input-group">
                            <input type="date" class="date-input" id="startDate">
                            <span>to</span>
                            <input type="date" class="date-input" id="endDate" value="">
                        </div>
                        <button class="btn btn-outline" onclick="DashboardManager.applyDateFilter()">
                            <i class="fas fa-filter"></i>
                            Apply Filter
                        </button>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>12%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>8%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="totalAgents">0</div>
                        <div class="stat-label">Active Agents</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon orange">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>24%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="totalLoanValue">K0.00</div>
                        <div class="stat-label">Active Loan Portfolio</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon purple">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-trend negative">
                                <i class="fas fa-arrow-down"></i>
                                <span>3%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="defaultRate">0%</div>
                        <div class="stat-label">Default Rate</div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid-2">
                    <div class="chart-container">
                        <div class="chart-title">Loan Applications Trend</div>
                        <canvas id="loanTrendChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">Agent Performance</div>
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Recent Activity</div>
                        <button class="btn btn-outline btn-small" onclick="UIManager.showSection('audit')">
                            <i class="fas fa-history"></i>
                            View Full Log
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading activity...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Loan Management Section -->
            <div class="content-section" id="loansSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Loan Management</div>
                        <div class="section-subtitle">Review, approve, or reject loan applications</div>
                    </div>
                    <div class="table-actions">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="loanSearch" placeholder="Search loans...">
                        </div>
                        <select class="filter-dropdown" id="loanStatusFilter">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="under_review">Under Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="defaulted">Defaulted</option>
                        </select>
                    </div>
                </div>
                
                <!-- Loan Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="pendingLoansCount">0</div>
                        <div class="stat-label">Pending Review</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="approvedLoansCount">0</div>
                        <div class="stat-label">Approved Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalActiveLoans">0</div>
                        <div class="stat-label">Active Loans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overdueLoansCount">0</div>
                        <div class="stat-label">Overdue Loans</div>
                    </div>
                </div>
                
                <!-- Loans Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Loan Applications</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="LoanManager.exportLoans()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Loan ID</th>
                                    <th>Customer</th>
                                    <th>Agent</th>
                                    <th>Amount</th>
                                    <th>Purpose</th>
                                    <th>Applied Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loansTable">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading loans...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="loansPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Agent Management Section -->
            <div class="content-section" id="agentsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Agent Management</div>
                        <div class="section-subtitle">Manage agent accounts, status, and permissions</div>
                    </div>
                    <div class="table-actions">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="agentSearch" placeholder="Search agents...">
                        </div>
                        <button class="btn btn-primary" onclick="UIManager.showSection('agent-create')">
                            <i class="fas fa-user-plus"></i>
                            Create New Agent
                        </button>
                    </div>
                </div>
                
                <!-- Agent Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="activeAgentsCount">0</div>
                        <div class="stat-label">Active Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingAgentsCount">0</div>
                        <div class="stat-label">Pending Activation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="suspendedAgentsCount">0</div>
                        <div class="stat-label">Suspended</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="topAgentCommission">K0.00</div>
                        <div class="stat-label">Top Earner (Monthly)</div>
                    </div>
                </div>
                
                <!-- Agents Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">All Agents</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="AgentManager.exportAgents()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Agent ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Customers</th>
                                    <th>Loans</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading agents...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="agentsPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Customer Management Section -->
            <div class="content-section" id="customersSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Customer Management</div>
                        <div class="section-subtitle">View and manage all customer accounts</div>
                    </div>
                    <div class="table-actions">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="customerSearch" placeholder="Search customers...">
                        </div>
                        <button class="btn btn-primary" onclick="CustomerManager.createCustomerModal()">
                            <i class="fas fa-user-plus"></i>
                            Create Customer
                        </button>
                    </div>
                </div>
                
                <!-- Customer Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCustomersCount">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeCustomersCount">0</div>
                        <div class="stat-label">Active Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="customersWithLoans">0</div>
                        <div class="stat-label">With Active Loans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="newCustomersToday">0</div>
                        <div class="stat-label">New Today</div>
                    </div>
                </div>
                
                <!-- Customers Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">All Customers</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="CustomerManager.exportCustomers()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Agent</th>
                                    <th>Active Loans</th>
                                    <th>Total Borrowed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading customers...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="customersPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Agent Assignment Section -->
            <div class="content-section" id="assignmentsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Agent Assignment</div>
                        <div class="section-subtitle">Manually assign agents to customers</div>
                    </div>
                </div>
                
                <!-- Assignment Interface -->
                <div class="assignment-section">
                    <h3 style="margin-bottom: 16px; color: var(--macos-gray-6);">Assign Agent to Customer</h3>
                    <form class="assignment-form" id="assignmentForm">
                        <div class="form-group">
                            <label class="form-label">Select Customer</label>
                            <select class="form-input" id="assignmentCustomer" required>
                                <option value="">Select a customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Agent</label>
                            <select class="form-input" id="assignmentAgent" required>
                                <option value="">Select an agent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-link"></i>
                                Assign Agent
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Current Assignments -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Current Assignments</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="AssignmentManager.refreshAssignments()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Customer ID</th>
                                    <th>Agent</th>
                                    <th>Agent ID</th>
                                    <th>Assigned Date</th>
                                    <th>Assigned By</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentsTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading assignments...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Create Agent Section -->
            <div class="content-section" id="agent-createSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Create New Agent</div>
                        <div class="section-subtitle">Manually create agent accounts with custom credentials</div>
                    </div>
                </div>
                
                <!-- Agent Creation Form -->
                <div class="agent-creation-form">
                    <form id="createAgentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Agent ID <span class="info-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Manually assign a unique Agent ID</span>
                                </span></label>
                                <input type="text" class="form-input" id="agentIdInput" placeholder="e.g., AG00123" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" id="agentFullName" placeholder="John Doe" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="agentEmail" placeholder="agent@trucash.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="agentPhone" placeholder="+260 123 456 789" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="text" class="form-input" id="agentPassword" placeholder="Enter custom password" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password</label>
                                <input type="text" class="form-input" id="agentConfirmPassword" placeholder="Confirm password" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Branch/Region</label>
                            <input type="text" class="form-input" id="agentBranch" placeholder="Main Branch" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">NRC Number</label>
                            <input type="text" class="form-input" id="agentNRC" placeholder="123456/78/9" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Residential Address</label>
                            <textarea class="form-input form-textarea" id="agentAddress" placeholder="Full residential address" required></textarea>
                        </div>
                        
                        <!-- Document Uploads -->
                        <div class="form-group">
                            <label class="form-label">Required Documents</label>
                            <div class="document-viewer">
                                <div class="document-card">
                                    <div class="document-preview" onclick="DocumentManager.openUploadWidget('nrcFront')" id="nrcFrontPreview">
                                        <i class="fas fa-id-card fa-3x" style="color: var(--macos-gray-3);"></i>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-name">NRC Front</div>
                                        <div class="document-type">Required</div>
                                    </div>
                                </div>
                                
                                <div class="document-card">
                                    <div class="document-preview" onclick="DocumentManager.openUploadWidget('nrcBack')" id="nrcBackPreview">
                                        <i class="fas fa-id-card fa-3x" style="color: var(--macos-gray-3);"></i>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-name">NRC Back</div>
                                        <div class="document-type">Required</div>
                                    </div>
                                </div>
                                
                                <div class="document-card">
                                    <div class="document-preview" onclick="DocumentManager.openUploadWidget('profilePhoto')" id="profilePhotoPreview">
                                        <i class="fas fa-user fa-3x" style="color: var(--macos-gray-3);"></i>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-name">Profile Photo</div>
                                        <div class="document-type">Required</div>
                                    </div>
                                </div>
                                
                                <div class="document-card">
                                    <div class="document-preview" onclick="DocumentManager.openUploadWidget('additionalDoc')" id="additionalDocPreview">
                                        <i class="fas fa-file fa-3x" style="color: var(--macos-gray-3);"></i>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-name">Additional Docs</div>
                                        <div class="document-type">Optional</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-input form-textarea" id="agentNotes" placeholder="Any additional notes about this agent..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle alert-icon"></i>
                            <div class="alert-content">
                                <div class="alert-title">Important Information</div>
                                <div class="alert-message">
                                    Agent credentials will be created immediately upon submission. Make sure to provide the credentials to the agent securely.
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer" style="border-top: none; padding: 0;">
                            <button type="button" class="btn btn-outline" onclick="UIManager.showSection('agents')">
                                <i class="fas fa-arrow-left"></i>
                                Back to Agents
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus"></i>
                                Create Agent Account
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Commission Management Section -->
            <div class="content-section" id="commissionsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Commission Management</div>
                        <div class="section-subtitle">Process and manage agent commissions</div>
                    </div>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="CommissionManager.processBulkCommissions()">
                            <i class="fas fa-bolt"></i>
                            Process Pending
                        </button>
                    </div>
                </div>
                
                <!-- Commission Calculator -->
                <div class="commission-calculator">
                    <div class="commission-header">
                        <div class="commission-title">Total Pending Commissions</div>
                        <div class="commission-amount" id="totalPendingCommissions">K0.00</div>
                    </div>
                    <div class="commission-breakdown">
                        <div>Ready for payout: <strong id="readyPayout">K0.00</strong></div>
                        <div>Pending verification: <strong id="pendingVerification">K0.00</strong></div>
                    </div>
                </div>
                
                <!-- Commission Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="pending">Pending Commissions</button>
                    <button class="tab" data-tab="processed">Processed Commissions</button>
                    <button class="tab" data-tab="all">All Commissions</button>
                </div>
                
                <!-- Commissions Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title" id="commissionTableTitle">Pending Commissions</div>
                        <div class="table-actions">
                            <div class="date-range-picker">
                                <input type="month" class="date-input" id="commissionMonth" value="">
                            </div>
                            <button class="btn btn-outline btn-small" onclick="CommissionManager.exportCommissions()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Commission ID</th>
                                    <th>Agent</th>
                                    <th>Customer</th>
                                    <th>Loan ID</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Earned Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commissionsTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading commissions...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="commissionsPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Repayment Management Section -->
            <div class="content-section" id="repaymentsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Repayment Management</div>
                        <div class="section-subtitle">Track and verify loan repayments</div>
                    </div>
                    <div class="table-actions">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="repaymentSearch" placeholder="Search repayments...">
                        </div>
                        <select class="filter-dropdown" id="repaymentStatusFilter">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="verified">Verified</option>
                            <option value="overdue">Overdue</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>
                
                <!-- Repayment Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRepaymentsToday">K0.00</div>
                        <div class="stat-label">Collected Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingVerifications">0</div>
                        <div class="stat-label">Pending Verification</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overdueRepayments">0</div>
                        <div class="stat-label">Overdue Repayments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="collectionRate">0%</div>
                        <div class="stat-label">Collection Rate</div>
                    </div>
                </div>
                
                <!-- Repayments Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Repayment Records</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="RepaymentManager.exportRepayments()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Repayment ID</th>
                                    <th>Customer</th>
                                    <th>Loan ID</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Paid Date</th>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="repaymentsTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading repayments...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="repaymentsPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Transaction Management Section -->
            <div class="content-section" id="transactionsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Transaction Management</div>
                        <div class="section-subtitle">View all system transactions</div>
                    </div>
                    <div class="table-actions">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="transactionSearch" placeholder="Search transactions...">
                        </div>
                        <select class="filter-dropdown" id="transactionTypeFilter">
                            <option value="all">All Types</option>
                            <option value="loan_disbursement">Loan Disbursement</option>
                            <option value="repayment">Repayment</option>
                            <option value="commission">Commission</option>
                            <option value="fee">Fee</option>
                            <option value="refund">Refund</option>
                        </select>
                    </div>
                </div>
                
                <!-- Transaction Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTransactionsToday">0</div>
                        <div class="stat-label">Transactions Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="transactionVolumeToday">K0.00</div>
                        <div class="stat-label">Volume Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="failedTransactions">0</div>
                        <div class="stat-label">Failed Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgTransactionValue">K0.00</div>
                        <div class="stat-label">Average Value</div>
                    </div>
                </div>
                
                <!-- Transactions Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">All Transactions</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="TransactionManager.exportTransactions()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Customer</th>
                                    <th>Agent</th>
                                    <th>Date & Time</th>
                                    <th>Status</th>
                                    <th>Reference</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading transactions...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="transactionsPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Audit Log Section -->
            <div class="content-section" id="auditSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">Audit Log</div>
                        <div class="section-subtitle">System activity and user actions log</div>
                    </div>
                    <div class="table-actions">
                        <div class="date-range-picker">
                            <input type="date" class="date-input" id="auditStartDate" value="">
                            <span>to</span>
                            <input type="date" class="date-input" id="auditEndDate" value="">
                        </div>
                        <button class="btn btn-outline btn-small" onclick="AuditManager.filterAuditLog()">
                            <i class="fas fa-filter"></i>
                            Filter
                        </button>
                    </div>
                </div>
                
                <!-- Audit Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAuditEntries">0</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayAuditEntries">0</div>
                        <div class="stat-label">Today's Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="adminActions">0</div>
                        <div class="stat-label">Admin Actions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="agentActions">0</div>
                        <div class="stat-label">Agent Actions</div>
                    </div>
                </div>
                
                <!-- Audit Log Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Audit Log Entries</div>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-small" onclick="AuditManager.exportAuditLog()">
                                <i class="fas fa-download"></i>
                                Export Log
                            </button>
                            <button class="btn btn-danger btn-small" onclick="AuditManager.clearOldLogs()">
                                <i class="fas fa-trash"></i>
                                Clear Old Logs
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>User Type</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                    <th>Device</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <div class="empty-state-title">Loading audit log...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="auditPagination">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div class="content-section" id="settingsSection">
                <div class="section-header">
                    <div>
                        <div class="section-title-large">System Settings</div>
                        <div class="section-subtitle">Configure system parameters and preferences</div>
                    </div>
                </div>
                
                <!-- Settings Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="general">General</button>
                    <button class="tab" data-tab="loan">Loan Settings</button>
                    <button class="tab" data-tab="commission">Commission</button>
                    <button class="tab" data-tab="security">Security</button>
                    <button class="tab" data-tab="notifications">Notifications</button>
                </div>
                
                <!-- Settings Content -->
                <div class="grid-2">
                    <!-- General Settings -->
                    <div class="settings-tab active" id="generalTab">
                        <div class="data-table-container">
                            <div class="table-header">
                                <div class="table-title">General Settings</div>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">System Name</label>
                                    <input type="text" class="form-input" id="systemName" value="TruCash Loan System">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Currency</label>
                                    <select class="form-input" id="systemCurrency">
                                        <option value="ZMW" selected>Zambian Kwacha (ZMW)</option>
                                        <option value="USD">US Dollar (USD)</option>
                                        <option value="EUR">Euro (EUR)</option>
                                        <option value="GBP">British Pound (GBP)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Time Zone</label>
                                    <select class="form-input" id="systemTimezone">
                                        <option value="Africa/Lusaka" selected>Africa/Lusaka (CAT)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New_York (EST)</option>
                                        <option value="Europe/London">Europe/London (GMT)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Date Format</label>
                                    <select class="form-input" id="dateFormat">
                                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Items Per Page</label>
                                    <select class="form-input" id="itemsPerPage">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Enable Maintenance Mode
                                        <span class="info-tooltip">
                                            <i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text">When enabled, only admins can access the system</span>
                                        </span>
                                    </label>
                                    <label class="switch">
                                        <input type="checkbox" id="maintenanceMode">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Maintenance Message</label>
                                    <textarea class="form-input form-textarea" id="maintenanceMessage" placeholder="System is under maintenance..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loan Settings -->
                    <div class="settings-tab" id="loanTab" style="display: none;">
                        <div class="data-table-container">
                            <div class="table-header">
                                <div class="table-title">Loan Settings</div>
                            </div>
                            <div class="modal-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Minimum Loan Amount</label>
                                        <input type="number" class="form-input" id="minLoanAmount" value="100">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Maximum Loan Amount</label>
                                        <input type="number" class="form-input" id="maxLoanAmount" value="50000">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Minimum Loan Term (Months)</label>
                                        <input type="number" class="form-input" id="minLoanTerm" value="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Maximum Loan Term (Months)</label>
                                        <input type="number" class="form-input" id="maxLoanTerm" value="24">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Default Interest Rate (%)</label>
                                        <input type="number" class="form-input" id="defaultInterestRate" value="15" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Penalty Interest Rate (%)</label>
                                        <input type="number" class="form-input" id="penaltyInterestRate" value="5" step="0.1">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Grace Period (Days)</label>
                                    <input type="number" class="form-input" id="gracePeriod" value="7">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Processing Fee (%)</label>
                                    <input type="number" class="form-input" id="processingFee" value="2" step="0.1">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Auto-Approval Limit</label>
                                    <input type="number" class="form-input" id="autoApprovalLimit" value="5000">
                                    <div class="form-text">Loans below this amount can be auto-approved by agents</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Commission Settings -->
                    <div class="settings-tab" id="commissionTab" style="display: none;">
                        <div class="data-table-container">
                            <div class="table-header">
                                <div class="table-title">Commission Settings</div>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Default Commission Rate (%)</label>
                                    <input type="number" class="form-input" id="defaultCommissionRate" value="2.5" step="0.1">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Onboarding Commission</label>
                                    <input type="number" class="form-input" id="onboardingCommission" value="50">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Minimum Payout Amount</label>
                                    <input type="number" class="form-input" id="minPayoutAmount" value="100">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Payout Schedule</label>
                                    <select class="form-input" id="payoutSchedule">
                                        <option value="weekly">Weekly</option>
                                        <option value="biweekly">Bi-weekly</option>
                                        <option value="monthly" selected>Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Payout Day of Month</label>
                                    <input type="number" class="form-input" id="payoutDay" value="5" min="1" max="31">
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle alert-icon"></i>
                                    <div class="alert-content">
                                        <div class="alert-title">Commission Calculation</div>
                                        <div class="alert-message">
                                            Commission is calculated as: Loan Amount  Commission Rate + Onboarding Commission for new customers.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="settings-tab" id="securityTab" style="display: none;">
                        <div class="data-table-container">
                            <div class="table-header">
                                <div class="table-title">Security Settings</div>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">
                                        Require Two-Factor Authentication
                                        <span class="info-tooltip">
                                            <i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text">Adds an extra layer of security for admin logins</span>
                                        </span>
                                    </label>
                                    <label class="switch">
                                        <input type="checkbox" id="require2FA">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Session Timeout (Minutes)</label>
                                    <input type="number" class="form-input" id="sessionTimeout" value="30">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Max Login Attempts</label>
                                    <input type="number" class="form-input" id="maxLoginAttempts" value="5">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Account Lockout Duration (Minutes)</label>
                                    <input type="number" class="form-input" id="lockoutDuration" value="15">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Password Expiry (Days)</label>
                                    <input type="number" class="form-input" id="passwordExpiry" value="90">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Minimum Password Length</label>
                                    <input type="number" class="form-input" id="minPasswordLength" value="8">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">IP Whitelist (Optional)</label>
                                    <textarea class="form-input form-textarea" id="ipWhitelist" placeholder="Enter one IP address per line"></textarea>
                                    <div class="form-text">Leave empty to allow access from any IP</div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                                    <div class="alert-content">
                                        <div class="alert-title">Security Warning</div>
                                        <div class="alert-message">
                                            Changing security settings may affect system accessibility. Test changes in a controlled environment first.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div class="settings-tab" id="notificationsTab" style="display: none;">
                        <div class="data-table-container">
                            <div class="table-header">
                                <div class="table-title">Notification Settings</div>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">
                                        Email Notifications
                                        <span class="info-tooltip">
                                            <i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text">Send email notifications for important events</span>
                                        </span>
                                    </label>
                                    <label class="switch">
                                        <input type="checkbox" id="emailNotifications" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Admin Notification Email</label>
                                    <input type="email" class="form-input" id="adminEmail" placeholder="admin@trucash.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        SMS Notifications
                                        <span class="info-tooltip">
                                            <i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text">Send SMS notifications for critical alerts</span>
                                        </span>
                                    </label>
                                    <label class="switch">
                                        <input type="checkbox" id="smsNotifications">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notify on Loan Approval</label>
                                    <label class="switch">
                                        <input type="checkbox" id="notifyLoanApproval" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notify on Repayment</label>
                                    <label class="switch">
                                        <input type="checkbox" id="notifyRepayment" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notify on Overdue Loans</label>
                                    <label class="switch">
                                        <input type="checkbox" id="notifyOverdue" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notify on System Errors</label>
                                    <label class="switch">
                                        <input type="checkbox" id="notifySystemErrors" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Daily Report Time</label>
                                    <input type="time" class="form-input" id="dailyReportTime" value="09:00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="SettingsManager.resetSettings()">
                        <i class="fas fa-undo"></i>
                        Reset to Defaults
                    </button>
                    <button class="btn btn-primary" onclick="SettingsManager.saveSettings()">
                        <i class="fas fa-save"></i>
                        Save All Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loan Detail Modal -->
    <div class="modal" id="loanDetailModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <div class="modal-title">Loan Application Details</div>
                <button class="modal-close" onclick="ModalManager.closeLoanModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="loanDetailContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Agent Detail Modal -->
    <div class="modal" id="agentDetailModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Agent Details</div>
                <button class="modal-close" onclick="ModalManager.closeAgentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="agentDetailContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Customer Detail Modal -->
    <div class="modal" id="customerDetailModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Customer Details</div>
                <button class="modal-close" onclick="ModalManager.closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Customer Modal -->
    <div class="modal" id="createCustomerModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">Create New Customer</div>
                <button class="modal-close" onclick="ModalManager.closeCreateCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createCustomerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="customerFullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="customerEmail" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">NRC Number</label>
                            <input type="text" class="form-input" id="customerNRC" placeholder="123456/78/9" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Residential Address</label>
                        <textarea class="form-input form-textarea" id="customerAddress" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assign Agent</label>
                            <select class="form-input" id="customerAgent">
                                <option value="">Select an agent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" id="customerStatus">
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle alert-icon"></i>
                        <div class="alert-content">
                            <div class="alert-title">Note</div>
                            <div class="alert-message">
                                Customer will receive login credentials via email. Documents can be uploaded later.
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="ModalManager.closeCreateCustomerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="CustomerManager.createCustomer()">Create Customer</button>
            </div>
        </div>
    </div>
    
    <!-- Commission Processing Modal -->
    <div class="modal" id="commissionProcessModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">Process Commission</div>
                <button class="modal-close" onclick="ModalManager.closeCommissionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="commissionProcessContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approval Workflow Modal -->
    <div class="modal" id="approvalWorkflowModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">Loan Approval Workflow</div>
                <button class="modal-close" onclick="ModalManager.closeApprovalModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="approvalWorkflowContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };
        
        // ===== CLOUDINARY CONFIGURATION =====
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            uploadPreset: 'h3eyhc2o',
            folder: 'trucash/admin',
            maxFileSize: 10485760, // 10MB
            allowedFormats: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'],
            multiple: false
        };
        
        // ===== APPLICATION STATE =====
        const AppState = {
            currentUser: null,
            adminData: null,
            agents: [],
            customers: [],
            loans: [],
            commissions: [],
            repayments: [],
            transactions: [],
            auditLogs: [],
            systemSettings: null,
            uploadedDocuments: {},
            realtimeListeners: [],
            cloudinaryWidget: null,
            currentSection: 'dashboard',
            charts: {},
            pagination: {
                agents: { page: 1, limit: 25, total: 0 },
                customers: { page: 1, limit: 25, total: 0 },
                loans: { page: 1, limit: 25, total: 0 },
                commissions: { page: 1, limit: 25, total: 0 },
                repayments: { page: 1, limit: 25, total: 0 },
                transactions: { page: 1, limit: 25, total: 0 },
                audit: { page: 1, limit: 50, total: 0 }
            },
            filters: {
                loans: { status: 'all', search: '' },
                agents: { status: 'all', search: '' },
                customers: { status: 'all', search: '' },
                commissions: { status: 'pending', search: '' },
                repayments: { status: 'all', search: '' },
                transactions: { type: 'all', search: '' }
            },
            selectedLoan: null,
            selectedAgent: null,
            selectedCustomer: null
        };
        
        // ===== INITIALIZE FIREBASE =====
        let firebaseApp, auth, db;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            console.log(" Firebase initialized successfully for Admin Panel");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            showToast("System Error", "Failed to initialize Firebase. Please refresh the page.", "error");
        }
        
        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                overlay.querySelector('.loading-spinner').style.display = 'block';
                overlay.classList.add('active');
            },
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'K0.00';
                return 'K' + parseFloat(amount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            formatDateOnly(timestamp) {
                if (!timestamp) return 'N/A';
                try {
                    const date = new Date(Number(timestamp));
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            },
            
            calculateDaysBetween(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },
            
            isOverdue(dueDate) {
                const today = new Date();
                const due = new Date(dueDate);
                return due < today;
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone(phone) {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            validateNRC(nrc) {
                const re = /^\d{6}\/\d{2}\/\d{1}$/;
                return re.test(nrc);
            },
            
            generateId(prefix = '') {
                return prefix + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            },
            
            calculateCommission(loanAmount, commissionRate = 2.5) {
                return (loanAmount * commissionRate) / 100;
            },
            
            truncateText(text, maxLength = 50) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    console.error('Failed to copy:', err);
                    return false;
                }
            },
            
            getStatusColor(status) {
                switch(status) {
                    case 'active':
                    case 'approved':
                    case 'verified':
                    case 'completed':
                        return 'var(--macos-green)';
                    case 'pending':
                    case 'under_review':
                        return 'var(--macos-orange)';
                    case 'suspended':
                    case 'rejected':
                    case 'failed':
                    case 'overdue':
                        return 'var(--macos-red)';
                    case 'banned':
                        return 'var(--macos-gray-6)';
                    default:
                        return 'var(--macos-gray-4)';
                }
            }
        };
        
        // ===== TOAST MANAGER =====
        const ToastManager = {
            show(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-header">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} toast-icon"></i>
                        <div class="toast-title">${title}</div>
                    </div>
                    <div class="toast-message">${message}</div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('active');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);
                
                return toast;
            }
        };
        
        // ===== FIREBASE SERVICE =====
        const FirebaseService = {
            async checkAuth() {
                return new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        unsubscribe();
                        
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            resolve(null);
                            return;
                        }
                        
                        try {
                            // Check if user is admin
                            const userRef = db.ref('users/' + currentUser.uid);
                            const snapshot = await userRef.once('value');
                            
                            if (!snapshot.exists()) {
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            const userData = snapshot.val();
                            
                            if (userData.userType !== 'admin' && userData.userType !== 'sudo') {
                                ToastManager.show('Access Denied', 
                                    'This dashboard is for administrators only.', 
                                    'error');
                                await auth.signOut();
                                window.location.href = 'login.html';
                                resolve(null);
                                return;
                            }
                            
                            AppState.currentUser = currentUser;
                            AppState.adminData = userData;
                            
                            // Log admin login
                            await this.createAuditLog('admin_login', {
                                adminId: currentUser.uid,
                                adminEmail: currentUser.email,
                                timestamp: Date.now()
                            });
                            
                            resolve(userData);
                        } catch (error) {
                            console.error('Auth check error:', error);
                            ToastManager.show('Authentication Error', 
                                'Failed to verify admin status.', 
                                'error');
                            resolve(null);
                        }
                    }, (error) => {
                        console.error('Auth state listener error:', error);
                        window.location.href = 'login.html';
                        resolve(null);
                    });
                });
            },
            
            async loadAllData() {
                try {
                    await Promise.all([
                        this.loadAgents(),
                        this.loadCustomers(),
                        this.loadLoans(),
                        this.loadCommissions(),
                        this.loadRepayments(),
                        this.loadTransactions(),
                        this.loadAuditLogs(),
                        this.loadSystemSettings()
                    ]);
                    
                    return true;
                } catch (error) {
                    console.error('Error loading all data:', error);
                    return false;
                }
            },
            
            async loadAgents() {
                try {
                    const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                    const snapshot = await agentsRef.once('value');
                    
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    return agents;
                } catch (error) {
                    console.error('Error loading agents:', error);
                    return [];
                }
            },
            
            async loadCustomers() {
                try {
                    const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                    const snapshot = await customersRef.once('value');
                    
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    return customers;
                } catch (error) {
                    console.error('Error loading customers:', error);
                    return [];
                }
            },
            
            async loadLoans() {
                try {
                    const loansRef = db.ref('loans');
                    const snapshot = await loansRef.once('value');
                    
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    return loans;
                } catch (error) {
                    console.error('Error loading loans:', error);
                    return [];
                }
            },
            
            async loadCommissions() {
                try {
                    const commissionsRef = db.ref('commissions');
                    const snapshot = await commissionsRef.once('value');
                    
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    return commissions;
                } catch (error) {
                    console.error('Error loading commissions:', error);
                    return [];
                }
            },
            
            async loadRepayments() {
                try {
                    const repaymentsRef = db.ref('repayments');
                    const snapshot = await repaymentsRef.once('value');
                    
                    const repayments = [];
                    snapshot.forEach((childSnapshot) => {
                        const repayment = childSnapshot.val();
                        repayment.id = childSnapshot.key;
                        repayments.push(repayment);
                    });
                    
                    AppState.repayments = repayments;
                    return repayments;
                } catch (error) {
                    console.error('Error loading repayments:', error);
                    return [];
                }
            },
            
            async loadTransactions() {
                try {
                    const transactionsRef = db.ref('transactions');
                    const snapshot = await transactionsRef.once('value');
                    
                    const transactions = [];
                    snapshot.forEach((childSnapshot) => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        transactions.push(transaction);
                    });
                    
                    AppState.transactions = transactions;
                    return transactions;
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    return [];
                }
            },
            
            async loadAuditLogs() {
                try {
                    const auditRef = db.ref('auditLogs');
                    const snapshot = await auditRef.once('value');
                    
                    const logs = [];
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        log.id = childSnapshot.key;
                        logs.push(log);
                    });
                    
                    logs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = logs;
                    return logs;
                } catch (error) {
                    console.error('Error loading audit logs:', error);
                    return [];
                }
            },
            
            async loadSystemSettings() {
                try {
                    const settingsRef = db.ref('systemSettings');
                    const snapshot = await settingsRef.once('value');
                    
                    if (snapshot.exists()) {
                        AppState.systemSettings = snapshot.val();
                    } else {
                        AppState.systemSettings = {
                            general: {
                                systemName: 'TruCash Loan System',
                                currency: 'ZMW',
                                timezone: 'Africa/Lusaka',
                                dateFormat: 'DD/MM/YYYY',
                                itemsPerPage: 25
                            },
                            loan: {
                                minAmount: 100,
                                maxAmount: 50000,
                                minTerm: 1,
                                maxTerm: 24,
                                defaultInterestRate: 15,
                                penaltyInterestRate: 5,
                                gracePeriod: 7,
                                processingFee: 2
                            },
                            commission: {
                                defaultRate: 2.5,
                                onboardingCommission: 50,
                                minPayoutAmount: 100,
                                payoutSchedule: 'monthly',
                                payoutDay: 5
                            }
                        };
                    }
                    
                    return AppState.systemSettings;
                } catch (error) {
                    console.error('Error loading system settings:', error);
                    return null;
                }
            },
            
            async createAgent(agentData) {
                try {
                    // Validate email doesn't exist
                    const emailCheck = await db.ref('users').orderByChild('email').equalTo(agentData.email).once('value');
                    if (emailCheck.exists()) {
                        return { success: false, error: 'Email already registered' };
                    }
                    
                    // Validate agent ID doesn't exist
                    const idCheck = await db.ref('users').orderByChild('agentId').equalTo(agentData.agentId).once('value');
                    if (idCheck.exists()) {
                        return { success: false, error: 'Agent ID already exists' };
                    }
                    
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    const agentUid = userCredential.user.uid;
                    
                    // Prepare agent document
                    const agentDoc = {
                        uid: agentUid,
                        agentId: agentData.agentId,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        nrc: agentData.nrc,
                        residence: agentData.address,
                        profilePhoto: agentData.profilePhoto || '',
                        nrcFront: agentData.nrcFront || '',
                        nrcBack: agentData.nrcBack || '',
                        additionalDoc: agentData.additionalDoc || '',
                        userType: 'agent',
                        status: 'active',
                        branch: agentData.branch || 'Main Branch',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName || AppState.currentUser.email,
                        totalCustomers: 0,
                        totalLoans: 0,
                        totalCommission: 0,
                        performanceScore: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + agentUid).set(agentDoc);
                    
                    // Create audit log
                    await this.createAuditLog('agent_create', {
                        agentId: agentData.agentId,
                        agentName: agentData.fullName,
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName || AppState.currentUser.email,
                        details: 'Agent account created manually'
                    });
                    
                    // Create notification for admin
                    await this.createNotification(AppState.currentUser.uid, 'agent_created', {
                        agentId: agentData.agentId,
                        agentName: agentData.fullName,
                        timestamp: Date.now()
                    });
                    
                    return {
                        success: true,
                        agentId: agentUid,
                        message: 'Agent created successfully'
                    };
                } catch (error) {
                    console.error('Error creating agent:', error);
                    
                    let errorMessage = 'Failed to create agent account';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async createCustomer(customerData) {
                try {
                    // Validate email doesn't exist
                    const emailCheck = await db.ref('users').orderByChild('email').equalTo(customerData.email).once('value');
                    if (emailCheck.exists()) {
                        return { success: false, error: 'Email already registered' };
                    }
                    
                    // Generate password
                    const password = Math.random().toString(36).slice(-8) + 'A1!';
                    
                    // Create Firebase Auth account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        password
                    );
                    
                    const customerUid = userCredential.user.uid;
                    
                    // Prepare customer document
                    const customerDoc = {
                        uid: customerUid,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        nrc: customerData.nrc,
                        residence: customerData.address,
                        userType: 'customer',
                        status: customerData.status || 'active',
                        assignedAgentId: customerData.assignedAgentId || '',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName || AppState.currentUser.email,
                        accountBalance: 0,
                        totalLoans: 0,
                        activeLoans: 0,
                        totalBorrowed: 0,
                        totalRepaid: 0
                    };
                    
                    // Save to Firebase
                    await db.ref('users/' + customerUid).set(customerDoc);
                    
                    // Create audit log
                    await this.createAuditLog('customer_create', {
                        customerId: customerUid,
                        customerName: customerData.fullName,
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName || AppState.currentUser.email,
                        details: 'Customer account created manually'
                    });
                    
                    return {
                        success: true,
                        customerId: customerUid,
                        password: password,
                        message: 'Customer created successfully'
                    };
                } catch (error) {
                    console.error('Error creating customer:', error);
                    
                    let errorMessage = 'Failed to create customer account';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already registered';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async updateLoanStatus(loanId, status, notes = '') {
                try {
                    const loanRef = db.ref('loans/' + loanId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        statusNotes: notes
                    };
                    
                    // If loan is approved, set approval date
                    if (status === 'approved') {
                        updates.approvedAt = Date.now();
                        updates.approvedBy = AppState.currentUser.uid;
                        updates.approvedByName = AppState.adminData.fullName || AppState.currentUser.email;
                    }
                    
                    // If loan is rejected, set rejection date
                    if (status === 'rejected') {
                        updates.rejectedAt = Date.now();
                        updates.rejectedBy = AppState.currentUser.uid;
                        updates.rejectedByName = AppState.adminData.fullName || AppState.currentUser.email;
                    }
                    
                    await loanRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('loan_status_update', {
                        loanId: loanId,
                        status: status,
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        notes: notes
                    });
                    
                    // Create notification for agent and customer
                    const loanSnap = await loanRef.once('value');
                    const loan = loanSnap.val();
                    
                    if (loan.agentId) {
                        await this.createNotification(loan.agentId, 'loan_status_changed', {
                            loanId: loanId,
                            customerName: loan.customerName,
                            status: status,
                            timestamp: Date.now()
                        });
                    }
                    
                    if (loan.customerId) {
                        await this.createNotification(loan.customerId, 'loan_status_changed', {
                            loanId: loanId,
                            status: status,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { success: true, message: 'Loan status updated successfully' };
                } catch (error) {
                    console.error('Error updating loan status:', error);
                    return { success: false, error: 'Failed to update loan status' };
                }
            },
            
            async updateAgentStatus(agentId, status, reason = '') {
                try {
                    const agentRef = db.ref('users/' + agentId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        statusReason: reason
                    };
                    
                    await agentRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('agent_status_update', {
                        agentId: agentId,
                        status: status,
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        reason: reason
                    });
                    
                    // Create notification for agent
                    await this.createNotification(agentId, 'account_status_changed', {
                        status: status,
                        reason: reason,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent status updated successfully' };
                } catch (error) {
                    console.error('Error updating agent status:', error);
                    return { success: false, error: 'Failed to update agent status' };
                }
            },
            
            async updateCustomerStatus(customerId, status, reason = '') {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const updates = {
                        status: status,
                        updatedAt: Date.now(),
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        statusReason: reason
                    };
                    
                    await customerRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('customer_status_update', {
                        customerId: customerId,
                        status: status,
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        reason: reason
                    });
                    
                    // Create notification for customer
                    await this.createNotification(customerId, 'account_status_changed', {
                        status: status,
                        reason: reason,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Customer status updated successfully' };
                } catch (error) {
                    console.error('Error updating customer status:', error);
                    return { success: false, error: 'Failed to update customer status' };
                }
            },
            
            async assignAgentToCustomer(customerId, agentId) {
                try {
                    // Get agent details
                    const agentRef = db.ref('users/' + agentId);
                    const agentSnap = await agentRef.once('value');
                    
                    if (!agentSnap.exists()) {
                        return { success: false, error: 'Agent not found' };
                    }
                    
                    const agentData = agentSnap.val();
                    
                    // Update customer record
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update({
                        assignedAgentId: agentId,
                        assignedAgentName: agentData.fullName,
                        assignedAt: Date.now(),
                        assignedBy: AppState.currentUser.uid,
                        assignedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        updatedAt: Date.now()
                    });
                    
                    // Update agent's customer count
                    await agentRef.update({
                        totalCustomers: (agentData.totalCustomers || 0) + 1,
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog('agent_assignment', {
                        customerId: customerId,
                        agentId: agentId,
                        agentName: agentData.fullName,
                        assignedBy: AppState.currentUser.uid,
                        assignedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    // Create notifications
                    await this.createNotification(customerId, 'agent_assigned', {
                        agentId: agentId,
                        agentName: agentData.fullName,
                        timestamp: Date.now()
                    });
                    
                    await this.createNotification(agentId, 'customer_assigned', {
                        customerId: customerId,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Agent assigned successfully' };
                } catch (error) {
                    console.error('Error assigning agent:', error);
                    return { success: false, error: 'Failed to assign agent' };
                }
            },
            
            async processCommission(commissionId, action) {
                try {
                    const commissionRef = db.ref('commissions/' + commissionId);
                    const commissionSnap = await commissionRef.once('value');
                    
                    if (!commissionSnap.exists()) {
                        return { success: false, error: 'Commission not found' };
                    }
                    
                    const commission = commissionSnap.val();
                    
                    let updates = {
                        updatedAt: Date.now(),
                        processedBy: AppState.currentUser.uid,
                        processedByName: AppState.adminData.fullName || AppState.currentUser.email
                    };
                    
                    if (action === 'approve') {
                        updates.status = 'paid';
                        updates.paidAt = Date.now();
                        
                        // Update agent's total commission
                        const agentRef = db.ref('users/' + commission.agentId);
                        const agentSnap = await agentRef.once('value');
                        const agentData = agentSnap.val();
                        
                        await agentRef.update({
                            totalCommission: (agentData.totalCommission || 0) + commission.amount,
                            updatedAt: Date.now()
                        });
                        
                        // Create transaction record
                        await this.createTransaction({
                            type: 'commission_payout',
                            amount: commission.amount,
                            agentId: commission.agentId,
                            agentName: commission.agentName,
                            commissionId: commissionId,
                            description: `Commission payout for ${commission.type}`
                        });
                        
                    } else if (action === 'reject') {
                        updates.status = 'rejected';
                        updates.rejectedAt = Date.now();
                        updates.rejectionReason = 'Rejected by admin';
                    }
                    
                    await commissionRef.update(updates);
                    
                    // Create audit log
                    await this.createAuditLog('commission_processed', {
                        commissionId: commissionId,
                        agentId: commission.agentId,
                        agentName: commission.agentName,
                        amount: commission.amount,
                        action: action,
                        processedBy: AppState.currentUser.uid,
                        processedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    // Create notification for agent
                    if (action === 'approve') {
                        await this.createNotification(commission.agentId, 'commission_paid', {
                            commissionId: commissionId,
                            amount: commission.amount,
                            timestamp: Date.now()
                        });
                    }
                    
                    return { 
                        success: true, 
                        message: `Commission ${action === 'approve' ? 'approved and paid' : 'rejected'} successfully` 
                    };
                } catch (error) {
                    console.error('Error processing commission:', error);
                    return { success: false, error: 'Failed to process commission' };
                }
            },
            
            async createTransaction(transactionData) {
                try {
                    const transactionId = Utils.generateId('TXN');
                    const transactionRef = db.ref('transactions/' + transactionId);
                    
                    const transaction = {
                        id: transactionId,
                        ...transactionData,
                        createdAt: Date.now(),
                        createdBy: AppState.currentUser.uid,
                        createdByName: AppState.adminData.fullName || AppState.currentUser.email,
                        status: 'completed'
                    };
                    
                    await transactionRef.set(transaction);
                    return { success: true, transactionId: transactionId };
                } catch (error) {
                    console.error('Error creating transaction:', error);
                    return { success: false, error: 'Failed to create transaction' };
                }
            },
            
            async createAuditLog(action, data) {
                try {
                    const auditId = Utils.generateId('AUD');
                    const auditRef = db.ref('auditLogs/' + auditId);
                    
                    const auditLog = {
                        id: auditId,
                        action: action,
                        userId: AppState.currentUser.uid,
                        userName: AppState.adminData.fullName || AppState.currentUser.email,
                        userType: 'admin',
                        userEmail: AppState.currentUser.email,
                        timestamp: Date.now(),
                        ipAddress: '', // Would be server-side in production
                        userAgent: navigator.userAgent,
                        data: data
                    };
                    
                    await auditRef.set(auditLog);
                    
                    // Add to local state
                    AppState.auditLogs.unshift(auditLog);
                    if (AppState.auditLogs.length > 1000) {
                        AppState.auditLogs = AppState.auditLogs.slice(0, 1000);
                    }
                    
                    return auditId;
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return null;
                }
            },
            
            async createNotification(userId, type, data) {
                try {
                    const notificationId = Utils.generateId('NOT');
                    const notificationRef = db.ref('notifications/' + userId + '/' + notificationId);
                    
                    const notification = {
                        id: notificationId,
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        read: false,
                        priority: 'high'
                    };
                    
                    await notificationRef.set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return null;
                }
            },
            
            async saveSystemSettings(settings) {
                try {
                    const settingsRef = db.ref('systemSettings');
                    await settingsRef.set(settings);
                    
                    AppState.systemSettings = settings;
                    
                    // Create audit log
                    await this.createAuditLog('settings_updated', {
                        updatedBy: AppState.currentUser.uid,
                        updatedByName: AppState.adminData.fullName || AppState.currentUser.email,
                        timestamp: Date.now()
                    });
                    
                    return { success: true, message: 'Settings saved successfully' };
                } catch (error) {
                    console.error('Error saving settings:', error);
                    return { success: false, error: 'Failed to save settings' };
                }
            },
            
            async signOut() {
                try {
                    // Clear all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') listener();
                    });
                    AppState.realtimeListeners = [];
                    
                    // Create audit log
                    await this.createAuditLog('admin_logout', {
                        adminId: AppState.currentUser.uid,
                        adminEmail: AppState.currentUser.email,
                        timestamp: Date.now()
                    });
                    
                    // Clear application state
                    AppState.currentUser = null;
                    AppState.adminData = null;
                    AppState.agents = [];
                    AppState.customers = [];
                    AppState.loans = [];
                    AppState.commissions = [];
                    AppState.repayments = [];
                    AppState.transactions = [];
                    AppState.auditLogs = [];
                    
                    // Sign out from Firebase
                    await auth.signOut();
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    ToastManager.show('Logout Error', 'Failed to sign out properly', 'error');
                }
            }
        };
        
        // ===== CLOUDINARY SERVICE =====
        const CloudinaryService = {
            widget: null,
            
            initUploadWidget() {
                this.widget = cloudinary.createUploadWidget({
                    cloudName: cloudinaryConfig.cloudName,
                    uploadPreset: cloudinaryConfig.uploadPreset,
                    sources: ['local', 'camera', 'url'],
                    multiple: false,
                    maxFiles: 1,
                    maxFileSize: cloudinaryConfig.maxFileSize,
                    clientAllowedFormats: cloudinaryConfig.allowedFormats,
                    showAdvancedOptions: false,
                    cropping: false,
                    theme: 'minimal',
                    folder: cloudinaryConfig.folder,
                    showPoweredBy: false
                }, (error, result) => {
                    this.handleUploadCallback(error, result);
                });
                
                console.log(" Cloudinary widget initialized for admin");
            },
            
            handleUploadCallback(error, result) {
                if (error) {
                    console.error('Cloudinary upload error:', error);
                    ToastManager.show('Upload Error', error.message || 'Failed to upload file', 'error');
                    return;
                }
                
                if (result && result.event === "success") {
                    this.handleUploadComplete(result.info);
                }
            },
            
            handleUploadComplete(info) {
                const documentType = AppState.currentUploadType;
                if (!documentType) return;
                
                const fileData = {
                    url: info.secure_url,
                    publicId: info.public_id,
                    format: info.format,
                    bytes: info.bytes,
                    originalFilename: info.original_filename,
                    documentType: documentType,
                    uploadedAt: Date.now(),
                    uploadedBy: AppState.currentUser.uid,
                    uploadedByName: AppState.adminData.fullName || AppState.currentUser.email
                };
                
                // Store in application state
                AppState.uploadedDocuments[documentType] = fileData;
                
                // Update preview
                const previewElement = document.getElementById(documentType + 'Preview');
                if (previewElement) {
                    previewElement.innerHTML = `
                        <img src="${fileData.url}" alt="${documentType}" style="width: 100%; height: 100%; object-fit: cover;">
                    `;
                    previewElement.style.cursor = 'pointer';
                    previewElement.onclick = () => DocumentManager.viewImage(fileData.url);
                }
                
                ToastManager.show('Upload Successful', `${documentType} uploaded successfully`, 'success');
                
                AppState.currentUploadType = null;
            },
            
            openUploadWidget(documentType) {
                if (!this.widget) {
                    this.initUploadWidget();
                }
                
                AppState.currentUploadType = documentType;
                this.widget.open();
            }
        };
        
        // ===== UI MANAGER =====
        const UIManager = {
            init() {
                this.cacheElements();
                this.bindEvents();
                this.initAuth();
                this.setupResponsive();
                this.setupRealtimeListeners();
            },
            
            cacheElements() {
                // Navigation
                this.navItems = document.querySelectorAll('.nav-item');
                this.contentSections = document.querySelectorAll('.content-section');
                this.mobileMenuToggle = document.getElementById('mobileMenuToggle');
                
                // User info
                this.adminName = document.getElementById('adminName');
                this.adminAvatar = document.getElementById('adminAvatar');
                this.greetingName = document.getElementById('greetingName');
                
                // Dashboard elements
                this.totalCustomers = document.getElementById('totalCustomers');
                this.totalAgents = document.getElementById('totalAgents');
                this.totalLoanValue = document.getElementById('totalLoanValue');
                this.defaultRate = document.getElementById('defaultRate');
                
                // Badges
                this.pendingLoansBadge = document.getElementById('pendingLoansBadge');
                this.pendingCustomersBadge = document.getElementById('pendingCustomersBadge');
                this.pendingCommissionsBadge = document.getElementById('pendingCommissionsBadge');
                
                // Buttons
                this.logoutBtn = document.getElementById('logoutBtn');
                
                // Forms
                this.createAgentForm = document.getElementById('createAgentForm');
                this.assignmentForm = document.getElementById('assignmentForm');
                
                // Tabs
                this.tabs = document.querySelectorAll('.tab');
                this.settingsTabs = document.querySelectorAll('.settings-tab');
                
                // Connection status
                this.connectionStatus = document.getElementById('connectionStatus');
            },
            
            bindEvents() {
                // Navigation
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        
                        this.navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Close mobile menu
                        if (window.innerWidth <= 1024) {
                            document.getElementById('sidebar').classList.remove('active');
                        }
                    });
                });
                
                // Logout
                this.logoutBtn.addEventListener('click', () => FirebaseService.signOut());
                
                // Mobile menu toggle
                this.mobileMenuToggle.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });
                
                // Search functionality
                const searchInputs = ['loanSearch', 'agentSearch', 'customerSearch', 'repaymentSearch', 'transactionSearch'];
                searchInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', Utils.debounce(() => {
                            this.handleSearch(id);
                        }, 300));
                    }
                });
                
                // Filter functionality
                const filterSelects = ['loanStatusFilter', 'repaymentStatusFilter', 'transactionTypeFilter'];
                filterSelects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.addEventListener('change', () => {
                            this.handleFilter(id);
                        });
                    }
                });
                
                // Date filters
                const dateFilters = ['startDate', 'endDate', 'commissionMonth', 'auditStartDate', 'auditEndDate'];
                dateFilters.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        // Set default value to today
                        if (id === 'endDate' || !input.value) {
                            input.value = new Date().toISOString().split('T')[0];
                        }
                        
                        input.addEventListener('change', () => {
                            this.handleDateFilter(id);
                        });
                    }
                });
                
                // Tab switching
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.switchTab(tabId);
                    });
                });
                
                // Settings tab switching
                document.querySelectorAll('.tabs .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.switchSettingsTab(tabId);
                    });
                });
                
                // Agent creation form
                if (this.createAgentForm) {
                    this.createAgentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        AgentManager.createAgent();
                    });
                }
                
                // Agent assignment form
                if (this.assignmentForm) {
                    this.assignmentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        AssignmentManager.assignAgent();
                    });
                }
                
                // Password confirmation
                const passwordInputs = ['agentPassword', 'agentConfirmPassword'];
                passwordInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => {
                            this.validatePasswordMatch();
                        });
                    }
                });
                
                // Online/offline detection
                window.addEventListener('online', this.updateConnectionStatus);
                window.addEventListener('offline', this.updateConnectionStatus);
            },
            
            setupResponsive() {
                const handleResize = () => {
                    if (window.innerWidth > 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                };
                
                window.addEventListener('resize', handleResize);
            },
            
            updateConnectionStatus() {
                if (navigator.onLine) {
                    this.connectionStatus.innerHTML = '<i class="fas fa-circle"></i> <span>Online</span>';
                    this.connectionStatus.className = 'connection-status online';
                } else {
                    this.connectionStatus.innerHTML = '<i class="fas fa-circle"></i> <span>Offline</span>';
                    this.connectionStatus.className = 'connection-status offline';
                    ToastManager.show('Connection Lost', 'You are offline. Some features may not work.', 'warning');
                }
            },
            
            async initAuth() {
                Utils.showLoading('Authenticating Admin...');
                
                try {
                    const adminData = await FirebaseService.checkAuth();
                    
                    if (!adminData) {
                        Utils.hideLoading();
                        return;
                    }
                    
                    // Initialize Cloudinary
                    CloudinaryService.initUploadWidget();
                    
                    // Load initial data
                    await FirebaseService.loadAllData();
                    
                    // Update UI
                    this.updateProfileUI();
                    this.updateDashboardUI();
                    this.updateBadges();
                    
                    // Initialize current section
                    this.showSection(AppState.currentSection);
                    
                    Utils.hideLoading();
                    
                    // Show welcome
                    ToastManager.show('Welcome Admin', 
                        `Hello ${adminData.fullName || 'Administrator'}!`, 
                        'success');
                    
                } catch (error) {
                    console.error('Authentication initialization error:', error);
                    Utils.hideLoading();
                    ToastManager.show('Authentication Error', 'Failed to authenticate. Please try again.', 'error');
                }
            },
            
            setupRealtimeListeners() {
                if (!AppState.currentUser) return;
                
                // Listen for agents
                const agentsRef = db.ref('users').orderByChild('userType').equalTo('agent');
                const agentsListener = agentsRef.on('value', (snapshot) => {
                    const agents = [];
                    snapshot.forEach((childSnapshot) => {
                        const agent = childSnapshot.val();
                        agent.id = childSnapshot.key;
                        agents.push(agent);
                    });
                    
                    AppState.agents = agents;
                    this.updateBadges();
                    
                    if (AppState.currentSection === 'agents' || AppState.currentSection === 'assignments') {
                        this.updateAgentsUI();
                    }
                    
                    if (AppState.currentSection === 'dashboard') {
                        this.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => agentsRef.off('value', agentsListener));
                
                // Listen for customers
                const customersRef = db.ref('users').orderByChild('userType').equalTo('customer');
                const customersListener = customersRef.on('value', (snapshot) => {
                    const customers = [];
                    snapshot.forEach((childSnapshot) => {
                        const customer = childSnapshot.val();
                        customer.id = childSnapshot.key;
                        customers.push(customer);
                    });
                    
                    AppState.customers = customers;
                    this.updateBadges();
                    
                    if (AppState.currentSection === 'customers' || AppState.currentSection === 'assignments') {
                        this.updateCustomersUI();
                    }
                    
                    if (AppState.currentSection === 'dashboard') {
                        this.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => customersRef.off('value', customersListener));
                
                // Listen for loans
                const loansRef = db.ref('loans');
                const loansListener = loansRef.on('value', (snapshot) => {
                    const loans = [];
                    snapshot.forEach((childSnapshot) => {
                        const loan = childSnapshot.val();
                        loan.id = childSnapshot.key;
                        loans.push(loan);
                    });
                    
                    loans.sort((a, b) => b.createdAt - a.createdAt);
                    AppState.loans = loans;
                    this.updateBadges();
                    
                    if (AppState.currentSection === 'loans') {
                        this.updateLoansUI();
                    }
                    
                    if (AppState.currentSection === 'dashboard') {
                        this.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => loansRef.off('value', loansListener));
                
                // Listen for commissions
                const commissionsRef = db.ref('commissions');
                const commissionsListener = commissionsRef.on('value', (snapshot) => {
                    const commissions = [];
                    snapshot.forEach((childSnapshot) => {
                        const commission = childSnapshot.val();
                        commission.id = childSnapshot.key;
                        commissions.push(commission);
                    });
                    
                    AppState.commissions = commissions;
                    this.updateBadges();
                    
                    if (AppState.currentSection === 'commissions') {
                        this.updateCommissionsUI();
                    }
                    
                    if (AppState.currentSection === 'dashboard') {
                        this.updateDashboardUI();
                    }
                });
                
                AppState.realtimeListeners.push(() => commissionsRef.off('value', commissionsListener));
                
                // Listen for audit logs
                const auditRef = db.ref('auditLogs');
                const auditListener = auditRef.on('value', (snapshot) => {
                    const logs = [];
                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        log.id = childSnapshot.key;
                        logs.push(log);
                    });
                    
                    logs.sort((a, b) => b.timestamp - a.timestamp);
                    AppState.auditLogs = logs;
                    
                    if (AppState.currentSection === 'audit') {
                        this.updateAuditUI();
                    }
                    
                    if (AppState.currentSection === 'dashboard') {
                        this.updateRecentActivity();
                    }
                });
                
                AppState.realtimeListeners.push(() => auditRef.off('value', auditListener));
            },
            
            showSection(sectionId) {
                AppState.currentSection = sectionId;
                
                // Hide all sections
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                    
                    // Update page title
                    const title = document.getElementById('pageTitle');
                    const titles = {
                        dashboard: 'Dashboard Overview',
                        loans: 'Loan Management',
                        agents: 'Agent Management',
                        customers: 'Customer Management',
                        assignments: 'Agent Assignment',
                        'agent-create': 'Create New Agent',
                        commissions: 'Commission Management',
                        repayments: 'Repayment Management',
                        transactions: 'Transaction Management',
                        audit: 'Audit Log',
                        settings: 'System Settings'
                    };
                    
                    title.textContent = titles[sectionId] || 'Admin Dashboard';
                    
                    // Load section-specific data
                    switch(sectionId) {
                        case 'dashboard':
                            this.updateDashboardUI();
                            break;
                        case 'loans':
                            this.updateLoansUI();
                            break;
                        case 'agents':
                            this.updateAgentsUI();
                            break;
                        case 'customers':
                            this.updateCustomersUI();
                            break;
                        case 'assignments':
                            this.updateAssignmentsUI();
                            break;
                        case 'agent-create':
                            this.updateAgentCreateUI();
                            break;
                        case 'commissions':
                            this.updateCommissionsUI();
                            break;
                        case 'repayments':
                            this.updateRepaymentsUI();
                            break;
                        case 'transactions':
                            this.updateTransactionsUI();
                            break;
                        case 'audit':
                            this.updateAuditUI();
                            break;
                        case 'settings':
                            this.updateSettingsUI();
                            break;
                    }
                }
            },
            
            updateProfileUI() {
                if (!AppState.adminData) return;
                
                const admin = AppState.adminData;
                this.adminName.textContent = admin.fullName || admin.email || 'Administrator';
                this.greetingName.textContent = admin.fullName || 'Admin';
                
                if (admin.profilePhoto) {
                    this.adminAvatar.innerHTML = `<img src="${admin.profilePhoto}" alt="Admin">`;
                }
            },
            
            updateDashboardUI() {
                // Update stats
                this.totalCustomers.textContent = AppState.customers.length;
                this.totalAgents.textContent = AppState.agents.filter(a => a.status === 'active').length;
                
                const activeLoansValue = AppState.loans
                    .filter(l => l.status === 'active')
                    .reduce((sum, loan) => sum + (loan.amount || 0), 0);
                this.totalLoanValue.textContent = Utils.formatCurrency(activeLoansValue);
                
                const totalLoans = AppState.loans.length;
                const defaultedLoans = AppState.loans.filter(l => l.status === 'defaulted').length;
                const defaultRate = totalLoans > 0 ? (defaultedLoans / totalLoans * 100).toFixed(1) : 0;
                this.defaultRate.textContent = `${defaultRate}%`;
                
                // Update charts
                this.updateCharts();
                
                // Update recent activity
                this.updateRecentActivity();
            },
            
            updateCharts() {
                // Loan Trend Chart
                const loanTrendCtx = document.getElementById('loanTrendChart');
                if (loanTrendCtx) {
                    const last7Days = this.getLast7Days();
                    const loanData = this.getLoansByDate(last7Days);
                    
                    if (AppState.charts.loanTrend) {
                        AppState.charts.loanTrend.destroy();
                    }
                    
                    AppState.charts.loanTrend = new Chart(loanTrendCtx, {
                        type: 'line',
                        data: {
                            labels: last7Days.map(d => d.label),
                            datasets: [{
                                label: 'Loan Applications',
                                data: loanData,
                                borderColor: 'var(--macos-blue)',
                                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Agent Performance Chart
                const agentPerfCtx = document.getElementById('agentPerformanceChart');
                if (agentPerfCtx) {
                    const topAgents = this.getTopAgents(5);
                    
                    if (AppState.charts.agentPerformance) {
                        AppState.charts.agentPerformance.destroy();
                    }
                    
                    AppState.charts.agentPerformance = new Chart(agentPerfCtx, {
                        type: 'bar',
                        data: {
                            labels: topAgents.map(a => a.name),
                            datasets: [{
                                label: 'Loans Processed',
                                data: topAgents.map(a => a.loans),
                                backgroundColor: 'rgba(52, 199, 89, 0.6)',
                                borderColor: 'var(--macos-green)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            },
            
            getLast7Days() {
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    days.push({
                        date: date.toISOString().split('T')[0],
                        label: date.toLocaleDateString('en-US', { weekday: 'short' })
                    });
                }
                return days;
            },
            
            getLoansByDate(days) {
                return days.map(day => {
                    return AppState.loans.filter(loan => {
                        const loanDate = new Date(loan.createdAt).toISOString().split('T')[0];
                        return loanDate === day.date;
                    }).length;
                });
            },
            
            getTopAgents(count) {
                const agentLoans = {};
                
                AppState.loans.forEach(loan => {
                    if (loan.agentId) {
                        if (!agentLoans[loan.agentId]) {
                            agentLoans[loan.agentId] = {
                                name: loan.agentName || 'Unknown Agent',
                                loans: 0
                            };
                        }
                        agentLoans[loan.agentId].loans++;
                    }
                });
                
                return Object.values(agentLoans)
                    .sort((a, b) => b.loans - a.loans)
                    .slice(0, count);
            },
            
            updateRecentActivity() {
                const table = document.getElementById('recentActivityTable');
                if (!table) return;
                
                const recentLogs = AppState.auditLogs.slice(0, 10);
                
                if (recentLogs.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <div class="empty-state-title">No recent activity</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                recentLogs.forEach(log => {
                    let actionText = '';
                    switch(log.action) {
                        case 'admin_login':
                            actionText = 'Admin Login';
                            break;
                        case 'loan_status_update':
                            actionText = 'Loan Status Updated';
                            break;
                        case 'agent_create':
                            actionText = 'Agent Created';
                            break;
                        case 'customer_create':
                            actionText = 'Customer Created';
                            break;
                        case 'agent_assignment':
                            actionText = 'Agent Assigned';
                            break;
                        default:
                            actionText = log.action.replace(/_/g, ' ');
                    }
                    
                    html += `
                        <tr>
                            <td>${Utils.formatDate(log.timestamp)}</td>
                            <td>${log.userName}</td>
                            <td>${actionText}</td>
                            <td>${Utils.truncateText(JSON.stringify(log.data), 50)}</td>
                            <td>${log.ipAddress || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
            },
            
            updateBadges() {
                // Pending loans badge
                const pendingLoans = AppState.loans.filter(l => l.status === 'pending').length;
                if (this.pendingLoansBadge) {
                    this.pendingLoansBadge.textContent = pendingLoans;
                    this.pendingLoansBadge.style.display = pendingLoans > 0 ? 'inline-block' : 'none';
                }
                
                // Pending customers badge (customers without agents)
                const unassignedCustomers = AppState.customers.filter(c => !c.assignedAgentId).length;
                if (this.pendingCustomersBadge) {
                    this.pendingCustomersBadge.textContent = unassignedCustomers;
                    this.pendingCustomersBadge.style.display = unassignedCustomers > 0 ? 'inline-block' : 'none';
                }
                
                // Pending commissions badge
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending').length;
                if (this.pendingCommissionsBadge) {
                    this.pendingCommissionsBadge.textContent = pendingCommissions;
                    this.pendingCommissionsBadge.style.display = pendingCommissions > 0 ? 'inline-block' : 'none';
                }
            },
            
            updateLoansUI() {
                const table = document.getElementById('loansTable');
                const stats = {
                    pending: document.getElementById('pendingLoansCount'),
                    approved: document.getElementById('approvedLoansCount'),
                    active: document.getElementById('totalActiveLoans'),
                    overdue: document.getElementById('overdueLoansCount')
                };
                
                if (!table) return;
                
                // Apply filters
                let filteredLoans = AppState.loans;
                
                if (AppState.filters.loans.status !== 'all') {
                    filteredLoans = filteredLoans.filter(l => l.status === AppState.filters.loans.status);
                }
                
                if (AppState.filters.loans.search) {
                    const searchTerm = AppState.filters.loans.search.toLowerCase();
                    filteredLoans = filteredLoans.filter(l => 
                        (l.id && l.id.toLowerCase().includes(searchTerm)) ||
                        (l.customerName && l.customerName.toLowerCase().includes(searchTerm)) ||
                        (l.agentName && l.agentName.toLowerCase().includes(searchTerm)) ||
                        (l.purpose && l.purpose.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Update stats
                if (stats.pending) stats.pending.textContent = AppState.loans.filter(l => l.status === 'pending').length;
                if (stats.approved) {
                    const today = new Date().toISOString().split('T')[0];
                    const approvedToday = AppState.loans.filter(l => {
                        if (l.status !== 'approved' || !l.approvedAt) return false;
                        const approvedDate = new Date(l.approvedAt).toISOString().split('T')[0];
                        return approvedDate === today;
                    }).length;
                    stats.approved.textContent = approvedToday;
                }
                if (stats.active) stats.active.textContent = AppState.loans.filter(l => l.status === 'active').length;
                if (stats.overdue) {
                    const overdueLoans = AppState.loans.filter(l => {
                        if (l.status !== 'active' || !l.repaymentSchedule) return false;
                        return l.repaymentSchedule.some(installment => 
                            Utils.isOverdue(installment.dueDate) && !installment.paid
                        );
                    }).length;
                    stats.overdue.textContent = overdueLoans;
                }
                
                // Pagination
                const pagination = AppState.pagination.loans;
                pagination.total = filteredLoans.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedLoans = filteredLoans.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedLoans.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <div class="empty-state-title">No loans found</div>
                                    <div class="empty-state-message">${filteredLoans.length === 0 ? 'No loans match your criteria' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedLoans.forEach(loan => {
                        const statusColor = Utils.getStatusColor(loan.status);
                        
                        html += `
                            <tr>
                                <td><strong>${loan.id}</strong></td>
                                <td>${loan.customerName || 'N/A'}</td>
                                <td>${loan.agentName || 'N/A'}</td>
                                <td>${Utils.formatCurrency(loan.amount)}</td>
                                <td>${Utils.truncateText(loan.purpose, 30)}</td>
                                <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${loan.status}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline btn-small" onclick="LoanManager.viewLoanDetails('${loan.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${loan.status === 'pending' ? `
                                            <button class="btn btn-success btn-small" onclick="LoanManager.approveLoan('${loan.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-danger btn-small" onclick="LoanManager.rejectLoan('${loan.id}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('loans', pagination);
            },
            
            updateAgentsUI() {
                const table = document.getElementById('agentsTable');
                const stats = {
                    active: document.getElementById('activeAgentsCount'),
                    pending: document.getElementById('pendingAgentsCount'),
                    suspended: document.getElementById('suspendedAgentsCount'),
                    topCommission: document.getElementById('topAgentCommission')
                };
                
                if (!table) return;
                
                // Apply filters
                let filteredAgents = AppState.agents;
                
                if (AppState.filters.agents.status !== 'all') {
                    filteredAgents = filteredAgents.filter(a => a.status === AppState.filters.agents.status);
                }
                
                if (AppState.filters.agents.search) {
                    const searchTerm = AppState.filters.agents.search.toLowerCase();
                    filteredAgents = filteredAgents.filter(a => 
                        (a.agentId && a.agentId.toLowerCase().includes(searchTerm)) ||
                        (a.fullName && a.fullName.toLowerCase().includes(searchTerm)) ||
                        (a.email && a.email.toLowerCase().includes(searchTerm)) ||
                        (a.phone && a.phone.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Update stats
                if (stats.active) stats.active.textContent = AppState.agents.filter(a => a.status === 'active').length;
                if (stats.pending) stats.pending.textContent = AppState.agents.filter(a => a.status === 'pending').length;
                if (stats.suspended) stats.suspended.textContent = AppState.agents.filter(a => a.status === 'suspended').length;
                if (stats.topCommission) {
                    const topAgent = AppState.agents.reduce((max, agent) => 
                        (agent.totalCommission || 0) > (max.totalCommission || 0) ? agent : max, 
                    { totalCommission: 0 });
                    stats.topCommission.textContent = Utils.formatCurrency(topAgent.totalCommission || 0);
                }
                
                // Pagination
                const pagination = AppState.pagination.agents;
                pagination.total = filteredAgents.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedAgents = filteredAgents.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedAgents.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <div class="empty-state-title">No agents found</div>
                                    <div class="empty-state-message">${filteredAgents.length === 0 ? 'No agents in the system' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedAgents.forEach(agent => {
                        const statusColor = Utils.getStatusColor(agent.status);
                        const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agent.id).length;
                        const agentLoans = AppState.loans.filter(l => l.agentId === agent.id).length;
                        
                        html += `
                            <tr>
                                <td><strong>${agent.agentId || 'N/A'}</strong></td>
                                <td>${agent.fullName || 'N/A'}</td>
                                <td>${agent.email || 'N/A'}</td>
                                <td>${agent.phone || 'N/A'}</td>
                                <td>${agentCustomers}</td>
                                <td>${agentLoans}</td>
                                <td>${Utils.formatCurrency(agent.totalCommission || 0)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${agent.status || 'active'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline btn-small" onclick="AgentManager.viewAgentDetails('${agent.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${agent.status === 'active' ? `
                                            <button class="btn btn-outline-danger btn-small" onclick="AgentManager.suspendAgent('${agent.id}')">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        ` : agent.status === 'suspended' ? `
                                            <button class="btn btn-success btn-small" onclick="AgentManager.activateAgent('${agent.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-danger btn-small" onclick="AgentManager.deleteAgent('${agent.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('agents', pagination);
            },
            
            updateCustomersUI() {
                const table = document.getElementById('customersTable');
                const stats = {
                    total: document.getElementById('totalCustomersCount'),
                    active: document.getElementById('activeCustomersCount'),
                    withLoans: document.getElementById('customersWithLoans'),
                    newToday: document.getElementById('newCustomersToday')
                };
                
                if (!table) return;
                
                // Apply filters
                let filteredCustomers = AppState.customers;
                
                if (AppState.filters.customers.status !== 'all') {
                    filteredCustomers = filteredCustomers.filter(c => c.status === AppState.filters.customers.status);
                }
                
                if (AppState.filters.customers.search) {
                    const searchTerm = AppState.filters.customers.search.toLowerCase();
                    filteredCustomers = filteredCustomers.filter(c => 
                        (c.fullName && c.fullName.toLowerCase().includes(searchTerm)) ||
                        (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                        (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                        (c.nrc && c.nrc.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Update stats
                if (stats.total) stats.total.textContent = AppState.customers.length;
                if (stats.active) stats.active.textContent = AppState.customers.filter(c => c.status === 'active').length;
                if (stats.withLoans) {
                    const customersWithLoans = AppState.customers.filter(c => 
                        AppState.loans.some(l => l.customerId === c.id && l.status === 'active')
                    ).length;
                    stats.withLoans.textContent = customersWithLoans;
                }
                if (stats.newToday) {
                    const today = new Date().toISOString().split('T')[0];
                    const newToday = AppState.customers.filter(c => {
                        const createdDate = new Date(c.createdAt).toISOString().split('T')[0];
                        return createdDate === today;
                    }).length;
                    stats.newToday.textContent = newToday;
                }
                
                // Pagination
                const pagination = AppState.pagination.customers;
                pagination.total = filteredCustomers.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedCustomers.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-user-friends"></i>
                                    <div class="empty-state-title">No customers found</div>
                                    <div class="empty-state-message">${filteredCustomers.length === 0 ? 'No customers in the system' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedCustomers.forEach(customer => {
                        const statusColor = Utils.getStatusColor(customer.status);
                        const activeLoans = AppState.loans.filter(l => 
                            l.customerId === customer.id && l.status === 'active'
                        ).length;
                        const totalBorrowed = AppState.loans
                            .filter(l => l.customerId === customer.id)
                            .reduce((sum, loan) => sum + (loan.amount || 0), 0);
                        
                        html += `
                            <tr>
                                <td><strong>${customer.id.substring(0, 8)}</strong></td>
                                <td>${customer.fullName || 'N/A'}</td>
                                <td>${customer.email || 'N/A'}</td>
                                <td>${customer.phone || 'N/A'}</td>
                                <td>${customer.assignedAgentName || 'Unassigned'}</td>
                                <td>${activeLoans}</td>
                                <td>${Utils.formatCurrency(totalBorrowed)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${customer.status || 'active'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline btn-small" onclick="CustomerManager.viewCustomerDetails('${customer.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${customer.status === 'active' ? `
                                            <button class="btn btn-outline-danger btn-small" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        ` : customer.status === 'suspended' ? `
                                            <button class="btn btn-success btn-small" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-danger btn-small" onclick="CustomerManager.deleteCustomer('${customer.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('customers', pagination);
            },
            
            updateAssignmentsUI() {
                this.updateAgentDropdowns();
                this.updateAssignmentsTable();
            },
            
            updateAgentDropdowns() {
                // Update customer dropdown for assignment
                const customerSelect = document.getElementById('assignmentCustomer');
                if (customerSelect) {
                    let html = '<option value="">Select a customer</option>';
                    AppState.customers.forEach(customer => {
                        html += `<option value="${customer.id}">${customer.fullName} - ${customer.email}</option>`;
                    });
                    customerSelect.innerHTML = html;
                }
                
                // Update agent dropdown for assignment
                const agentSelect = document.getElementById('assignmentAgent');
                if (agentSelect) {
                    let html = '<option value="">Select an agent</option>';
                    AppState.agents.forEach(agent => {
                        if (agent.status === 'active') {
                            html += `<option value="${agent.id}">${agent.fullName} (${agent.agentId})</option>`;
                        }
                    });
                    agentSelect.innerHTML = html;
                }
                
                // Update agent dropdown for customer creation
                const customerAgentSelect = document.getElementById('customerAgent');
                if (customerAgentSelect) {
                    let html = '<option value="">Select an agent</option>';
                    AppState.agents.forEach(agent => {
                        if (agent.status === 'active') {
                            html += `<option value="${agent.id}">${agent.fullName} (${agent.agentId})</option>`;
                        }
                    });
                    customerAgentSelect.innerHTML = html;
                }
            },
            
            updateAssignmentsTable() {
                const table = document.getElementById('assignmentsTable');
                if (!table) return;
                
                const assignments = AppState.customers
                    .filter(c => c.assignedAgentId)
                    .map(customer => {
                        const agent = AppState.agents.find(a => a.id === customer.assignedAgentId);
                        return {
                            customer: customer,
                            agent: agent
                        };
                    });
                
                if (assignments.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-link"></i>
                                    <div class="empty-state-title">No assignments found</div>
                                    <div class="empty-state-message">No customers have been assigned to agents yet</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    assignments.forEach(({ customer, agent }) => {
                        html += `
                            <tr>
                                <td>${customer.fullName}</td>
                                <td>${customer.id.substring(0, 8)}</td>
                                <td>${agent ? agent.fullName : 'Unknown Agent'}</td>
                                <td>${agent ? agent.agentId : 'N/A'}</td>
                                <td>${customer.assignedAt ? Utils.formatDateOnly(customer.assignedAt) : 'N/A'}</td>
                                <td>${customer.assignedByName || 'System'}</td>
                                <td>
                                    <button class="btn btn-outline-danger btn-small" onclick="AssignmentManager.removeAssignment('${customer.id}')">
                                        <i class="fas fa-unlink"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
            },
            
            updateAgentCreateUI() {
                // Nothing specific to update here
            },
            
            updateCommissionsUI() {
                const table = document.getElementById('commissionsTable');
                const title = document.getElementById('commissionTableTitle');
                const stats = {
                    totalPending: document.getElementById('totalPendingCommissions'),
                    readyPayout: document.getElementById('readyPayout'),
                    pendingVerification: document.getElementById('pendingVerification')
                };
                
                if (!table) return;
                
                // Apply filters
                let filteredCommissions = AppState.commissions;
                
                const activeTab = document.querySelector('.tab.active')?.dataset.tab || 'pending';
                switch(activeTab) {
                    case 'pending':
                        filteredCommissions = filteredCommissions.filter(c => c.status === 'pending');
                        if (title) title.textContent = 'Pending Commissions';
                        break;
                    case 'processed':
                        filteredCommissions = filteredCommissions.filter(c => c.status === 'paid');
                        if (title) title.textContent = 'Processed Commissions';
                        break;
                    case 'all':
                        if (title) title.textContent = 'All Commissions';
                        break;
                }
                
                // Apply month filter
                const monthFilter = document.getElementById('commissionMonth')?.value;
                if (monthFilter) {
                    filteredCommissions = filteredCommissions.filter(c => {
                        if (!c.createdAt) return false;
                        const commissionDate = new Date(c.createdAt);
                        const filterDate = new Date(monthFilter + '-01');
                        return commissionDate.getFullYear() === filterDate.getFullYear() &&
                               commissionDate.getMonth() === filterDate.getMonth();
                    });
                }
                
                // Update stats
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                const totalPending = pendingCommissions.reduce((sum, c) => sum + (c.amount || 0), 0);
                const readyForPayout = pendingCommissions
                    .filter(c => c.verified && !c.paid)
                    .reduce((sum, c) => sum + (c.amount || 0), 0);
                
                if (stats.totalPending) stats.totalPending.textContent = Utils.formatCurrency(totalPending);
                if (stats.readyPayout) stats.readyPayout.textContent = Utils.formatCurrency(readyForPayout);
                if (stats.pendingVerification) {
                    stats.pendingVerification.textContent = Utils.formatCurrency(totalPending - readyForPayout);
                }
                
                // Pagination
                const pagination = AppState.pagination.commissions;
                pagination.total = filteredCommissions.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedCommissions = filteredCommissions.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedCommissions.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-money-check-alt"></i>
                                    <div class="empty-state-title">No commissions found</div>
                                    <div class="empty-state-message">${filteredCommissions.length === 0 ? 'No commissions match your criteria' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedCommissions.forEach(commission => {
                        const statusColor = Utils.getStatusColor(commission.status);
                        
                        html += `
                            <tr>
                                <td><strong>${commission.id}</strong></td>
                                <td>${commission.agentName || 'N/A'}</td>
                                <td>${commission.customerName || 'N/A'}</td>
                                <td>${commission.loanId || 'N/A'}</td>
                                <td>${Utils.formatCurrency(commission.amount)}</td>
                                <td>${commission.type || 'loan_commission'}</td>
                                <td>${Utils.formatDateOnly(commission.createdAt)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${commission.status}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        ${commission.status === 'pending' ? `
                                            <button class="btn btn-success btn-small" onclick="CommissionManager.approveCommission('${commission.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-danger btn-small" onclick="CommissionManager.rejectCommission('${commission.id}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-outline btn-small" onclick="CommissionManager.viewCommissionDetails('${commission.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('commissions', pagination);
            },
            
            updateRepaymentsUI() {
                const table = document.getElementById('repaymentsTable');
                const stats = {
                    totalToday: document.getElementById('totalRepaymentsToday'),
                    pendingVerification: document.getElementById('pendingVerifications'),
                    overdue: document.getElementById('overdueRepayments'),
                    collectionRate: document.getElementById('collectionRate')
                };
                
                if (!table) return;
                
                // Apply filters
                let filteredRepayments = AppState.repayments;
                
                if (AppState.filters.repayments.status !== 'all') {
                    filteredRepayments = filteredRepayments.filter(r => r.status === AppState.filters.repayments.status);
                }
                
                if (AppState.filters.repayments.search) {
                    const searchTerm = AppState.filters.repayments.search.toLowerCase();
                    filteredRepayments = filteredRepayments.filter(r => 
                        (r.id && r.id.toLowerCase().includes(searchTerm)) ||
                        (r.customerName && r.customerName.toLowerCase().includes(searchTerm)) ||
                        (r.loanId && r.loanId.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Update stats
                const today = new Date().toISOString().split('T')[0];
                const todayRepayments = AppState.repayments.filter(r => {
                    if (!r.timestamp) return false;
                    const repaymentDate = new Date(r.timestamp).toISOString().split('T')[0];
                    return repaymentDate === today && r.status === 'verified';
                });
                const totalToday = todayRepayments.reduce((sum, r) => sum + (r.amount || 0), 0);
                
                const pendingVerification = AppState.repayments.filter(r => r.status === 'pending').length;
                
                const overdueRepayments = AppState.loans.filter(l => {
                    if (l.status !== 'active' || !l.repaymentSchedule) return false;
                    return l.repaymentSchedule.some(installment => 
                        Utils.isOverdue(installment.dueDate) && !installment.paid
                    );
                }).length;
                
                const totalActiveLoans = AppState.loans.filter(l => l.status === 'active').length;
                const collectionRate = totalActiveLoans > 0 ? 
                    ((totalActiveLoans - overdueRepayments) / totalActiveLoans * 100).toFixed(1) : 0;
                
                if (stats.totalToday) stats.totalToday.textContent = Utils.formatCurrency(totalToday);
                if (stats.pendingVerification) stats.pendingVerification.textContent = pendingVerification;
                if (stats.overdue) stats.overdue.textContent = overdueRepayments;
                if (stats.collectionRate) stats.collectionRate.textContent = `${collectionRate}%`;
                
                // Pagination
                const pagination = AppState.pagination.repayments;
                pagination.total = filteredRepayments.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedRepayments = filteredRepayments.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedRepayments.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-check"></i>
                                    <div class="empty-state-title">No repayments found</div>
                                    <div class="empty-state-message">${filteredRepayments.length === 0 ? 'No repayments match your criteria' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedRepayments.forEach(repayment => {
                        const statusColor = Utils.getStatusColor(repayment.status);
                        
                        html += `
                            <tr>
                                <td><strong>${repayment.id}</strong></td>
                                <td>${repayment.customerName || 'N/A'}</td>
                                <td>${repayment.loanId || 'N/A'}</td>
                                <td>${Utils.formatCurrency(repayment.amount)}</td>
                                <td>${Utils.formatDateOnly(repayment.dueDate)}</td>
                                <td>${repayment.timestamp ? Utils.formatDateOnly(repayment.timestamp) : 'N/A'}</td>
                                <td>${repayment.agentName || 'N/A'}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${repayment.status}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        ${repayment.status === 'pending' ? `
                                            <button class="btn btn-success btn-small" onclick="RepaymentManager.verifyRepayment('${repayment.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-outline btn-small" onclick="RepaymentManager.viewRepaymentDetails('${repayment.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('repayments', pagination);
            },
            
            updateTransactionsUI() {
                const table = document.getElementById('transactionsTable');
                const stats = {
                    totalToday: document.getElementById('totalTransactionsToday'),
                    volumeToday: document.getElementById('transactionVolumeToday'),
                    failedToday: document.getElementById('failedTransactions'),
                    avgValue: document.getElementById('avgTransactionValue')
                };
                
                if (!table) return;
                
                // Apply filters
                let filteredTransactions = AppState.transactions;
                
                if (AppState.filters.transactions.type !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => t.type === AppState.filters.transactions.type);
                }
                
                if (AppState.filters.transactions.search) {
                    const searchTerm = AppState.filters.transactions.search.toLowerCase();
                    filteredTransactions = filteredTransactions.filter(t => 
                        (t.id && t.id.toLowerCase().includes(searchTerm)) ||
                        (t.customerName && t.customerName.toLowerCase().includes(searchTerm)) ||
                        (t.agentName && t.agentName.toLowerCase().includes(searchTerm)) ||
                        (t.description && t.description.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Update stats
                const today = new Date().toISOString().split('T')[0];
                const todayTransactions = AppState.transactions.filter(t => {
                    if (!t.createdAt) return false;
                    const transactionDate = new Date(t.createdAt).toISOString().split('T')[0];
                    return transactionDate === today;
                });
                
                const totalToday = todayTransactions.length;
                const volumeToday = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                const failedToday = todayTransactions.filter(t => t.status === 'failed').length;
                const avgValue = totalToday > 0 ? volumeToday / totalToday : 0;
                
                if (stats.totalToday) stats.totalToday.textContent = totalToday;
                if (stats.volumeToday) stats.volumeToday.textContent = Utils.formatCurrency(volumeToday);
                if (stats.failedToday) stats.failedToday.textContent = failedToday;
                if (stats.avgValue) stats.avgValue.textContent = Utils.formatCurrency(avgValue);
                
                // Pagination
                const pagination = AppState.pagination.transactions;
                pagination.total = filteredTransactions.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedTransactions.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-exchange-alt"></i>
                                    <div class="empty-state-title">No transactions found</div>
                                    <div class="empty-state-message">${filteredTransactions.length === 0 ? 'No transactions match your criteria' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedTransactions.forEach(transaction => {
                        const statusColor = Utils.getStatusColor(transaction.status);
                        
                        html += `
                            <tr>
                                <td><strong>${transaction.id}</strong></td>
                                <td>${transaction.type.replace(/_/g, ' ')}</td>
                                <td>${Utils.formatCurrency(transaction.amount)}</td>
                                <td>${transaction.customerName || 'N/A'}</td>
                                <td>${transaction.agentName || 'N/A'}</td>
                                <td>${Utils.formatDate(transaction.createdAt)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${transaction.status}
                                    </span>
                                </td>
                                <td>${transaction.reference || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-outline btn-small" onclick="TransactionManager.viewTransactionDetails('${transaction.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('transactions', pagination);
            },
            
            updateAuditUI() {
                const table = document.getElementById('auditLogTable');
                const stats = {
                    total: document.getElementById('totalAuditEntries'),
                    today: document.getElementById('todayAuditEntries'),
                    adminActions: document.getElementById('adminActions'),
                    agentActions: document.getElementById('agentActions')
                };
                
                if (!table) return;
                
                // Apply date filter
                let filteredLogs = AppState.auditLogs;
                
                const startDate = document.getElementById('auditStartDate')?.value;
                const endDate = document.getElementById('auditEndDate')?.value;
                
                if (startDate) {
                    const start = new Date(startDate).getTime();
                    filteredLogs = filteredLogs.filter(log => log.timestamp >= start);
                }
                
                if (endDate) {
                    const end = new Date(endDate).getTime() + 86400000; // Add one day
                    filteredLogs = filteredLogs.filter(log => log.timestamp <= end);
                }
                
                // Update stats
                const today = new Date().toISOString().split('T')[0];
                const todayLogs = AppState.auditLogs.filter(log => {
                    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                    return logDate === today;
                });
                
                const adminActions = AppState.auditLogs.filter(log => log.userType === 'admin').length;
                const agentActions = AppState.auditLogs.filter(log => log.userType === 'agent').length;
                
                if (stats.total) stats.total.textContent = AppState.auditLogs.length;
                if (stats.today) stats.today.textContent = todayLogs.length;
                if (stats.adminActions) stats.adminActions.textContent = adminActions;
                if (stats.agentActions) stats.agentActions.textContent = agentActions;
                
                // Pagination
                const pagination = AppState.pagination.audit;
                pagination.total = filteredLogs.length;
                const startIndex = (pagination.page - 1) * pagination.limit;
                const endIndex = startIndex + pagination.limit;
                const paginatedLogs = filteredLogs.slice(startIndex, endIndex);
                
                // Update table
                if (paginatedLogs.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <div class="empty-state-title">No audit logs found</div>
                                    <div class="empty-state-message">${filteredLogs.length === 0 ? 'No logs match your criteria' : 'Try changing your filters'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    paginatedLogs.forEach(log => {
                        let actionText = '';
                        switch(log.action) {
                            case 'admin_login':
                                actionText = 'Admin Login';
                                break;
                            case 'loan_status_update':
                                actionText = 'Loan Status Updated';
                                break;
                            case 'agent_create':
                                actionText = 'Agent Created';
                                break;
                            case 'customer_create':
                                actionText = 'Customer Created';
                                break;
                            case 'agent_assignment':
                                actionText = 'Agent Assigned';
                                break;
                            default:
                                actionText = log.action.replace(/_/g, ' ');
                        }
                        
                        html += `
                            <tr>
                                <td>${Utils.formatDate(log.timestamp)}</td>
                                <td>${log.userName}</td>
                                <td>${log.userType}</td>
                                <td>${actionText}</td>
                                <td>${Utils.truncateText(JSON.stringify(log.data), 100)}</td>
                                <td>${log.ipAddress || 'N/A'}</td>
                                <td>${Utils.truncateText(log.userAgent, 50)}</td>
                            </tr>
                        `;
                    });
                    
                    table.innerHTML = html;
                }
                
                // Update pagination
                this.updatePagination('audit', pagination);
            },
            
            updateSettingsUI() {
                if (!AppState.systemSettings) return;
                
                const settings = AppState.systemSettings;
                
                // General settings
                document.getElementById('systemName').value = settings.general?.systemName || 'TruCash Loan System';
                document.getElementById('systemCurrency').value = settings.general?.currency || 'ZMW';
                document.getElementById('systemTimezone').value = settings.general?.timezone || 'Africa/Lusaka';
                document.getElementById('dateFormat').value = settings.general?.dateFormat || 'DD/MM/YYYY';
                document.getElementById('itemsPerPage').value = settings.general?.itemsPerPage || 25;
                
                // Loan settings
                document.getElementById('minLoanAmount').value = settings.loan?.minAmount || 100;
                document.getElementById('maxLoanAmount').value = settings.loan?.maxAmount || 50000;
                document.getElementById('minLoanTerm').value = settings.loan?.minTerm || 1;
                document.getElementById('maxLoanTerm').value = settings.loan?.maxTerm || 24;
                document.getElementById('defaultInterestRate').value = settings.loan?.defaultInterestRate || 15;
                document.getElementById('penaltyInterestRate').value = settings.loan?.penaltyInterestRate || 5;
                document.getElementById('gracePeriod').value = settings.loan?.gracePeriod || 7;
                document.getElementById('processingFee').value = settings.loan?.processingFee || 2;
                
                // Commission settings
                document.getElementById('defaultCommissionRate').value = settings.commission?.defaultRate || 2.5;
                document.getElementById('onboardingCommission').value = settings.commission?.onboardingCommission || 50;
                document.getElementById('minPayoutAmount').value = settings.commission?.minPayoutAmount || 100;
                document.getElementById('payoutSchedule').value = settings.commission?.payoutSchedule || 'monthly';
                document.getElementById('payoutDay').value = settings.commission?.payoutDay || 5;
            },
            
            updatePagination(type, pagination) {
                const container = document.getElementById(type + 'Pagination');
                if (!container) return;
                
                const totalPages = Math.ceil(pagination.total / pagination.limit);
                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let html = '';
                
                // Previous button
                html += `
                    <button class="page-btn" ${pagination.page === 1 ? 'disabled' : ''} 
                            onclick="UIManager.changePage('${type}', ${pagination.page - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
                
                // Page numbers
                const maxVisible = 5;
                let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible - 1);
                
                if (endPage - startPage + 1 < maxVisible) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `
                        <button class="page-btn ${i === pagination.page ? 'active' : ''}" 
                                onclick="UIManager.changePage('${type}', ${i})">
                            ${i}
                        </button>
                    `;
                }
                
                // Next button
                html += `
                    <button class="page-btn" ${pagination.page === totalPages ? 'disabled' : ''} 
                            onclick="UIManager.changePage('${type}', ${pagination.page + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
                
                container.innerHTML = html;
            },
            
            changePage(type, page) {
                const pagination = AppState.pagination[type];
                if (page < 1 || page > Math.ceil(pagination.total / pagination.limit)) {
                    return;
                }
                
                pagination.page = page;
                
                // Refresh the current section
                switch(AppState.currentSection) {
                    case 'loans':
                        this.updateLoansUI();
                        break;
                    case 'agents':
                        this.updateAgentsUI();
                        break;
                    case 'customers':
                        this.updateCustomersUI();
                        break;
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                    case 'repayments':
                        this.updateRepaymentsUI();
                        break;
                    case 'transactions':
                        this.updateTransactionsUI();
                        break;
                    case 'audit':
                        this.updateAuditUI();
                        break;
                }
                
                // Scroll to top
                document.querySelector('.main-content').scrollTop = 0;
            },
            
            handleSearch(inputId) {
                const searchTerm = document.getElementById(inputId).value.trim().toLowerCase();
                
                switch(inputId) {
                    case 'loanSearch':
                        AppState.filters.loans.search = searchTerm;
                        AppState.pagination.loans.page = 1;
                        this.updateLoansUI();
                        break;
                    case 'agentSearch':
                        AppState.filters.agents.search = searchTerm;
                        AppState.pagination.agents.page = 1;
                        this.updateAgentsUI();
                        break;
                    case 'customerSearch':
                        AppState.filters.customers.search = searchTerm;
                        AppState.pagination.customers.page = 1;
                        this.updateCustomersUI();
                        break;
                    case 'repaymentSearch':
                        AppState.filters.repayments.search = searchTerm;
                        AppState.pagination.repayments.page = 1;
                        this.updateRepaymentsUI();
                        break;
                    case 'transactionSearch':
                        AppState.filters.transactions.search = searchTerm;
                        AppState.pagination.transactions.page = 1;
                        this.updateTransactionsUI();
                        break;
                }
            },
            
            handleFilter(selectId) {
                const value = document.getElementById(selectId).value;
                
                switch(selectId) {
                    case 'loanStatusFilter':
                        AppState.filters.loans.status = value;
                        AppState.pagination.loans.page = 1;
                        this.updateLoansUI();
                        break;
                    case 'repaymentStatusFilter':
                        AppState.filters.repayments.status = value;
                        AppState.pagination.repayments.page = 1;
                        this.updateRepaymentsUI();
                        break;
                    case 'transactionTypeFilter':
                        AppState.filters.transactions.type = value;
                        AppState.pagination.transactions.page = 1;
                        this.updateTransactionsUI();
                        break;
                }
            },
            
            handleDateFilter(inputId) {
                // This is handled by individual sections
                switch(AppState.currentSection) {
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                    case 'audit':
                        this.updateAuditUI();
                        break;
                }
            },
            
            switchTab(tabId) {
                // Remove active class from all tabs
                this.tabs.forEach(tab => tab.classList.remove('active'));
                
                // Add active class to clicked tab
                document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add('active');
                
                // Update UI based on tab
                switch(AppState.currentSection) {
                    case 'commissions':
                        this.updateCommissionsUI();
                        break;
                }
            },
            
            switchSettingsTab(tabId) {
                // Hide all settings tabs
                this.settingsTabs.forEach(tab => tab.style.display = 'none');
                
                // Show selected tab
                document.getElementById(tabId + 'Tab').style.display = 'block';
                
                // Update tab active state
                document.querySelectorAll('.tabs .tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add('active');
            },
            
            validatePasswordMatch() {
                const password = document.getElementById('agentPassword').value;
                const confirmPassword = document.getElementById('agentConfirmPassword').value;
                
                if (password && confirmPassword && password !== confirmPassword) {
                    ToastManager.show('Validation Error', 'Passwords do not match', 'error');
                    return false;
                }
                
                return true;
            }
        };
        
        // ===== LOAN MANAGER =====
        const LoanManager = {
            async viewLoanDetails(loanId) {
                try {
                    Utils.showLoading('Loading loan details...');
                    
                    const loanRef = db.ref('loans/' + loanId);
                    const snapshot = await loanRef.once('value');
                    
                    if (!snapshot.exists()) {
                        ToastManager.show('Error', 'Loan not found', 'error');
                        return;
                    }
                    
                    const loan = snapshot.val();
                    loan.id = loanId;
                    
                    AppState.selectedLoan = loan;
                    
                    // Load customer and agent details
                    const customer = AppState.customers.find(c => c.id === loan.customerId);
                    const agent = AppState.agents.find(a => a.id === loan.agentId);
                    
                    this.displayLoanModal(loan, customer, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing loan details:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to load loan details', 'error');
                }
            },
            
            displayLoanModal(loan, customer, agent) {
                const modal = document.getElementById('loanDetailModal');
                const content = document.getElementById('loanDetailContent');
                
                const statusColor = Utils.getStatusColor(loan.status);
                
                // Get documents
                const documents = loan.documents || {};
                const collateralImages = loan.collateral?.images || [];
                
                let documentsHTML = '';
                if (documents.nrcFront || documents.nrcBack || documents.profilePhoto) {
                    documentsHTML += `
                        <div class="form-group">
                            <label class="form-label">Customer Documents</label>
                            <div class="document-viewer">
                                ${documents.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${documents.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${documents.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${documents.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${documents.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${documents.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${documents.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${documents.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${documents.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                let collateralHTML = '';
                if (collateralImages.length > 0) {
                    collateralHTML += `
                        <div class="form-group">
                            <label class="form-label">Collateral Images</label>
                            <div class="document-viewer">
                    `;
                    
                    collateralImages.forEach((image, index) => {
                        collateralHTML += `
                            <div class="document-card" onclick="DocumentManager.viewImage('${image}')">
                                <div class="document-preview">
                                    <img src="${image}" alt="Collateral ${index + 1}">
                                </div>
                                <div class="document-info">
                                    <div class="document-name">Collateral ${index + 1}</div>
                                    <div class="document-type">${loan.collateral?.category || 'General'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    collateralHTML += `
                            </div>
                        </div>
                    `;
                }
                
                let repaymentScheduleHTML = '';
                if (loan.repaymentSchedule && loan.repaymentSchedule.length > 0) {
                    repaymentScheduleHTML += `
                        <div class="form-group">
                            <label class="form-label">Repayment Schedule</label>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Due Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    loan.repaymentSchedule.forEach((installment, index) => {
                        const isOverdue = Utils.isOverdue(installment.dueDate);
                        const status = isOverdue ? 'overdue' : (installment.paid ? 'paid' : 'pending');
                        const statusColor = Utils.getStatusColor(status);
                        
                        repaymentScheduleHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${Utils.formatDateOnly(installment.dueDate)}</td>
                                <td>${Utils.formatCurrency(installment.totalDue)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                        ${status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    repaymentScheduleHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Loan ID</div>
                            <div class="detail-value">${loan.id}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Amount</div>
                            <div class="detail-value">${Utils.formatCurrency(loan.amount)}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                    ${loan.status}
                                </span>
                            </div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Interest Rate</div>
                            <div class="detail-value">${loan.interestRate || 15}%</div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Customer</div>
                            <div class="detail-value">${loan.customerName}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Agent</div>
                            <div class="detail-value">${loan.agentName || 'Unassigned'}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Applied Date</div>
                            <div class="detail-value">${Utils.formatDate(loan.createdAt)}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${loan.duration} months</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Loan Purpose</label>
                        <div class="form-input disabled">${loan.purpose || 'Not specified'}</div>
                    </div>
                    
                    ${loan.purposeDescription ? `
                        <div class="form-group">
                            <label class="form-label">Purpose Description</label>
                            <div class="form-input disabled">${loan.purposeDescription}</div>
                        </div>
                    ` : ''}
                    
                    ${documentsHTML}
                    
                    ${collateralHTML}
                    
                    ${repaymentScheduleHTML}
                    
                    ${loan.statusNotes ? `
                        <div class="form-group">
                            <label class="form-label">Status Notes</label>
                            <div class="form-input disabled">${loan.statusNotes}</div>
                        </div>
                    ` : ''}
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="ModalManager.closeLoanModal()">Close</button>
                        ${loan.status === 'pending' ? `
                            <button class="btn btn-success" onclick="LoanManager.approveLoan('${loan.id}')">
                                <i class="fas fa-check"></i>
                                Approve Loan
                            </button>
                            <button class="btn btn-danger" onclick="LoanManager.rejectLoan('${loan.id}')">
                                <i class="fas fa-times"></i>
                                Reject Loan
                            </button>
                        ` : ''}
                        ${loan.status === 'active' ? `
                            <button class="btn btn-outline-danger" onclick="LoanManager.markAsDefaulted('${loan.id}')">
                                <i class="fas fa-exclamation-triangle"></i>
                                Mark as Defaulted
                            </button>
                        ` : ''}
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async approveLoan(loanId) {
                const notes = prompt('Enter approval notes (optional):');
                if (notes === null) return; // User cancelled
                
                Utils.showLoading('Approving loan...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'approved', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Loan approved successfully', 'success');
                    ModalManager.closeLoanModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async rejectLoan(loanId) {
                const notes = prompt('Enter rejection reason (required):');
                if (!notes) {
                    ToastManager.show('Error', 'Rejection reason is required', 'error');
                    return;
                }
                
                Utils.showLoading('Rejecting loan...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'rejected', notes);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Loan rejected successfully', 'success');
                    ModalManager.closeLoanModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async markAsDefaulted(loanId) {
                if (!confirm('Are you sure you want to mark this loan as defaulted? This action cannot be undone.')) {
                    return;
                }
                
                Utils.showLoading('Updating loan status...');
                
                const result = await FirebaseService.updateLoanStatus(loanId, 'defaulted', 'Marked as defaulted by admin');
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Loan marked as defaulted', 'success');
                    ModalManager.closeLoanModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async exportLoans() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const loans = AppState.loans;
                    const headers = ['Loan ID', 'Customer', 'Agent', 'Amount', 'Purpose', 'Status', 'Applied Date', 'Approved Date'];
                    const rows = loans.map(loan => [
                        loan.id,
                        loan.customerName || '',
                        loan.agentName || '',
                        loan.amount || 0,
                        loan.purpose || '',
                        loan.status || '',
                        Utils.formatDateOnly(loan.createdAt),
                        loan.approvedAt ? Utils.formatDateOnly(loan.approvedAt) : ''
                    ]);
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `loans_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Loans exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting loans:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export loans', 'error');
                }
            }
        };
        
        // ===== AGENT MANAGER =====
        const AgentManager = {
            async viewAgentDetails(agentId) {
                try {
                    Utils.showLoading('Loading agent details...');
                    
                    const agent = AppState.agents.find(a => a.id === agentId);
                    if (!agent) {
                        ToastManager.show('Error', 'Agent not found', 'error');
                        return;
                    }
                    
                    AppState.selectedAgent = agent;
                    
                    // Load agent's customers and loans
                    const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agentId);
                    const agentLoans = AppState.loans.filter(l => l.agentId === agentId);
                    const agentCommissions = AppState.commissions.filter(c => c.agentId === agentId);
                    
                    this.displayAgentModal(agent, agentCustomers, agentLoans, agentCommissions);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing agent details:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to load agent details', 'error');
                }
            },
            
            displayAgentModal(agent, customers, loans, commissions) {
                const modal = document.getElementById('agentDetailModal');
                const content = document.getElementById('agentDetailContent');
                
                const statusColor = Utils.getStatusColor(agent.status);
                const totalCommission = commissions.reduce((sum, c) => sum + (c.amount || 0), 0);
                const pendingCommission = commissions
                    .filter(c => c.status === 'pending')
                    .reduce((sum, c) => sum + (c.amount || 0), 0);
                
                let documentsHTML = '';
                if (agent.nrcFront || agent.nrcBack || agent.profilePhoto) {
                    documentsHTML += `
                        <div class="form-group">
                            <label class="form-label">Agent Documents</label>
                            <div class="document-viewer">
                                ${agent.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${agent.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${agent.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${agent.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${agent.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${agent.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${agent.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${agent.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${agent.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${agent.additionalDoc ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${agent.additionalDoc}')">
                                        <div class="document-preview">
                                            <img src="${agent.additionalDoc}" alt="Additional Document">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Additional Document</div>
                                            <div class="document-type">Optional</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Agent ID</div>
                            <div class="detail-value">${agent.agentId}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${agent.fullName}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                    ${agent.status}
                                </span>
                            </div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Branch</div>
                            <div class="detail-value">${agent.branch || 'Main Branch'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${agent.email}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${agent.phone}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">NRC</div>
                            <div class="detail-value">${agent.nrc}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Created Date</div>
                            <div class="detail-value">${Utils.formatDate(agent.createdAt)}</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <div class="form-input disabled">${agent.residence || 'Not specified'}</div>
                    </div>
                    
                    ${documentsHTML}
                    
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Total Customers</div>
                            <div class="detail-value">${customers.length}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Total Loans</div>
                            <div class="detail-value">${loans.length}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Total Commission</div>
                            <div class="detail-value">${Utils.formatCurrency(totalCommission)}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Pending Commission</div>
                            <div class="detail-value">${Utils.formatCurrency(pendingCommission)}</div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="ModalManager.closeAgentModal()">Close</button>
                        ${agent.status === 'active' ? `
                            <button class="btn btn-outline-danger" onclick="AgentManager.suspendAgent('${agent.id}')">
                                <i class="fas fa-ban"></i>
                                Suspend Agent
                            </button>
                        ` : agent.status === 'suspended' ? `
                            <button class="btn btn-success" onclick="AgentManager.activateAgent('${agent.id}')">
                                <i class="fas fa-check"></i>
                                Activate Agent
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="AgentManager.deleteAgent('${agent.id}')">
                            <i class="fas fa-trash"></i>
                            Delete Agent
                        </button>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            async createAgent() {
                // Validate form
                if (!UIManager.validatePasswordMatch()) {
                    return;
                }
                
                const agentData = {
                    agentId: document.getElementById('agentIdInput').value.trim(),
                    fullName: document.getElementById('agentFullName').value.trim(),
                    email: document.getElementById('agentEmail').value.trim(),
                    phone: document.getElementById('agentPhone').value.trim(),
                    password: document.getElementById('agentPassword').value,
                    nrc: document.getElementById('agentNRC').value.trim(),
                    address: document.getElementById('agentAddress').value.trim(),
                    branch: document.getElementById('agentBranch').value.trim(),
                    notes: document.getElementById('agentNotes').value.trim()
                };
                
                // Validate required fields
                if (!agentData.agentId || !agentData.fullName || !agentData.email || !agentData.phone || !agentData.password) {
                    ToastManager.show('Validation Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(agentData.email)) {
                    ToastManager.show('Validation Error', 'Please enter a valid email address', 'error');
                    return;
                }
                
                if (!Utils.validatePhone(agentData.phone)) {
                    ToastManager.show('Validation Error', 'Please enter a valid phone number', 'error');
                    return;
                }
                
                if (agentData.nrc && !Utils.validateNRC(agentData.nrc)) {
                    ToastManager.show('Validation Error', 'Please enter a valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                // Validate documents
                const requiredDocs = ['nrcFront', 'nrcBack', 'profilePhoto'];
                const missingDocs = requiredDocs.filter(doc => !AppState.uploadedDocuments[doc]);
                
                if (missingDocs.length > 0) {
                    ToastManager.show('Validation Error', 
                        `Please upload all required documents: ${missingDocs.map(d => 
                            d === 'nrcFront' ? 'NRC Front' : 
                            d === 'nrcBack' ? 'NRC Back' : 'Profile Photo'
                        ).join(', ')}`, 
                        'error');
                    return;
                }
                
                // Add uploaded documents
                agentData.nrcFront = AppState.uploadedDocuments.nrcFront?.url || '';
                agentData.nrcBack = AppState.uploadedDocuments.nrcBack?.url || '';
                agentData.profilePhoto = AppState.uploadedDocuments.profilePhoto?.url || '';
                agentData.additionalDoc = AppState.uploadedDocuments.additionalDoc?.url || '';
                
                Utils.showLoading('Creating agent account...');
                
                const result = await FirebaseService.createAgent(agentData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Agent created successfully', 'success');
                    
                    // Reset form
                    document.getElementById('createAgentForm').reset();
                    AppState.uploadedDocuments = {};
                    
                    // Reset previews
                    ['nrcFront', 'nrcBack', 'profilePhoto', 'additionalDoc'].forEach(doc => {
                        const preview = document.getElementById(doc + 'Preview');
                        if (preview) {
                            preview.innerHTML = `<i class="fas fa-${doc === 'profilePhoto' ? 'user' : 'id-card'} fa-3x" style="color: var(--macos-gray-3);"></i>`;
                        }
                    });
                    
                    // Navigate to agents section
                    UIManager.showSection('agents');
                } else {
                    ToastManager.show('Creation Failed', result.error, 'error');
                }
            },
            
            async suspendAgent(agentId) {
                const reason = prompt('Enter suspension reason:');
                if (!reason) {
                    ToastManager.show('Error', 'Suspension reason is required', 'error');
                    return;
                }
                
                Utils.showLoading('Suspending agent...');
                
                const result = await FirebaseService.updateAgentStatus(agentId, 'suspended', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Agent suspended successfully', 'success');
                    ModalManager.closeAgentModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async activateAgent(agentId) {
                Utils.showLoading('Activating agent...');
                
                const result = await FirebaseService.updateAgentStatus(agentId, 'active', 'Activated by admin');
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Agent activated successfully', 'success');
                    ModalManager.closeAgentModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async deleteAgent(agentId) {
                if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                    return;
                }
                
                // Check if agent has active customers or loans
                const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agentId);
                const agentLoans = AppState.loans.filter(l => l.agentId === agentId && l.status === 'active');
                
                if (agentCustomers.length > 0 || agentLoans.length > 0) {
                    ToastManager.show('Cannot Delete', 
                        'Agent has active customers or loans. Please reassign them first.', 
                        'error');
                    return;
                }
                
                Utils.showLoading('Deleting agent...');
                
                try {
                    // Delete agent from Firebase Auth
                    await auth.deleteUser(agentId);
                    
                    // Delete agent from database
                    await db.ref('users/' + agentId).remove();
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('agent_delete', {
                        agentId: agentId,
                        deletedBy: AppState.currentUser.uid,
                        deletedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    Utils.hideLoading();
                    ToastManager.show('Success', 'Agent deleted successfully', 'success');
                    ModalManager.closeAgentModal();
                } catch (error) {
                    console.error('Error deleting agent:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to delete agent', 'error');
                }
            },
            
            async exportAgents() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const agents = AppState.agents;
                    const headers = ['Agent ID', 'Name', 'Email', 'Phone', 'Status', 'Branch', 'Total Customers', 'Total Loans', 'Total Commission'];
                    const rows = agents.map(agent => {
                        const agentCustomers = AppState.customers.filter(c => c.assignedAgentId === agent.id).length;
                        const agentLoans = AppState.loans.filter(l => l.agentId === agent.id).length;
                        const totalCommission = AppState.commissions
                            .filter(c => c.agentId === agent.id)
                            .reduce((sum, c) => sum + (c.amount || 0), 0);
                        
                        return [
                            agent.agentId || '',
                            agent.fullName || '',
                            agent.email || '',
                            agent.phone || '',
                            agent.status || '',
                            agent.branch || '',
                            agentCustomers,
                            agentLoans,
                            totalCommission
                        ];
                    });
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `agents_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Agents exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting agents:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export agents', 'error');
                }
            }
        };
        
        // ===== CUSTOMER MANAGER =====
        const CustomerManager = {
            async viewCustomerDetails(customerId) {
                try {
                    Utils.showLoading('Loading customer details...');
                    
                    const customer = AppState.customers.find(c => c.id === customerId);
                    if (!customer) {
                        ToastManager.show('Error', 'Customer not found', 'error');
                        return;
                    }
                    
                    AppState.selectedCustomer = customer;
                    
                    // Load customer's loans and agent
                    const customerLoans = AppState.loans.filter(l => l.customerId === customerId);
                    const agent = customer.assignedAgentId ? 
                        AppState.agents.find(a => a.id === customer.assignedAgentId) : null;
                    
                    this.displayCustomerModal(customer, customerLoans, agent);
                    
                    Utils.hideLoading();
                } catch (error) {
                    console.error('Error viewing customer details:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to load customer details', 'error');
                }
            },
            
            displayCustomerModal(customer, loans, agent) {
                const modal = document.getElementById('customerDetailModal');
                const content = document.getElementById('customerDetailContent');
                
                const statusColor = Utils.getStatusColor(customer.status);
                const activeLoans = loans.filter(l => l.status === 'active');
                const totalBorrowed = loans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                
                let documentsHTML = '';
                if (customer.nrcFront || customer.nrcBack || customer.profilePhoto) {
                    documentsHTML += `
                        <div class="form-group">
                            <label class="form-label">Customer Documents</label>
                            <div class="document-viewer">
                                ${customer.nrcFront ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${customer.nrcFront}')">
                                        <div class="document-preview">
                                            <img src="${customer.nrcFront}" alt="NRC Front">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Front</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.nrcBack ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${customer.nrcBack}')">
                                        <div class="document-preview">
                                            <img src="${customer.nrcBack}" alt="NRC Back">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">NRC Back</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${customer.profilePhoto ? `
                                    <div class="document-card" onclick="DocumentManager.viewImage('${customer.profilePhoto}')">
                                        <div class="document-preview">
                                            <img src="${customer.profilePhoto}" alt="Profile Photo">
                                        </div>
                                        <div class="document-info">
                                            <div class="document-name">Profile Photo</div>
                                            <div class="document-type">Required</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                let loansHTML = '';
                if (loans.length > 0) {
                    loansHTML += `
                        <div class="form-group">
                            <label class="form-label">Loan History</label>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Loan ID</th>
                                            <th>Amount</th>
                                            <th>Purpose</th>
                                            <th>Status</th>
                                            <th>Applied Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    loans.forEach(loan => {
                        const loanStatusColor = Utils.getStatusColor(loan.status);
                        
                        loansHTML += `
                            <tr onclick="LoanManager.viewLoanDetails('${loan.id}')" style="cursor: pointer;">
                                <td>${loan.id}</td>
                                <td>${Utils.formatCurrency(loan.amount)}</td>
                                <td>${Utils.truncateText(loan.purpose, 30)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${loanStatusColor}20; color: ${loanStatusColor};">
                                        ${loan.status}
                                    </span>
                                </td>
                                <td>${Utils.formatDateOnly(loan.createdAt)}</td>
                            </tr>
                        `;
                    });
                    
                    loansHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Customer ID</div>
                            <div class="detail-value">${customer.id.substring(0, 8)}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${customer.fullName}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge" style="background: ${statusColor}20; color: ${statusColor};">
                                    ${customer.status}
                                </span>
                            </div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Assigned Agent</div>
                            <div class="detail-value">${agent ? agent.fullName : 'Unassigned'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${customer.email}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${customer.phone}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">NRC</div>
                            <div class="detail-value">${customer.nrc || 'Not provided'}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Created Date</div>
                            <div class="detail-value">${Utils.formatDate(customer.createdAt)}</div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Total Loans</div>
                            <div class="detail-value">${loans.length}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Active Loans</div>
                            <div class="detail-value">${activeLoans.length}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Total Borrowed</div>
                            <div class="detail-value">${Utils.formatCurrency(totalBorrowed)}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Account Balance</div>
                            <div class="detail-value">${Utils.formatCurrency(customer.accountBalance || 0)}</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <div class="form-input disabled">${customer.residence || 'Not specified'}</div>
                    </div>
                    
                    ${documentsHTML}
                    
                    ${loansHTML}
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="ModalManager.closeCustomerModal()">Close</button>
                        ${customer.status === 'active' ? `
                            <button class="btn btn-outline-danger" onclick="CustomerManager.suspendCustomer('${customer.id}')">
                                <i class="fas fa-ban"></i>
                                Suspend Customer
                            </button>
                        ` : customer.status === 'suspended' ? `
                            <button class="btn btn-success" onclick="CustomerManager.activateCustomer('${customer.id}')">
                                <i class="fas fa-check"></i>
                                Activate Customer
                            </button>
                        ` : ''}
                        ${!customer.assignedAgentId ? `
                            <button class="btn btn-primary" onclick="CustomerManager.assignAgent('${customer.id}')">
                                <i class="fas fa-link"></i>
                                Assign Agent
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="CustomerManager.deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                            Delete Customer
                        </button>
                    </div>
                `;
                
                modal.classList.add('active');
            },
            
            createCustomerModal() {
                const modal = document.getElementById('createCustomerModal');
                modal.classList.add('active');
            },
            
            async createCustomer() {
                const customerData = {
                    fullName: document.getElementById('customerFullName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    nrc: document.getElementById('customerNRC').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    status: document.getElementById('customerStatus').value,
                    assignedAgentId: document.getElementById('customerAgent').value
                };
                
                // Validate required fields
                if (!customerData.fullName || !customerData.email || !customerData.phone) {
                    ToastManager.show('Validation Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                if (!Utils.validateEmail(customerData.email)) {
                    ToastManager.show('Validation Error', 'Please enter a valid email address', 'error');
                    return;
                }
                
                if (!Utils.validatePhone(customerData.phone)) {
                    ToastManager.show('Validation Error', 'Please enter a valid phone number', 'error');
                    return;
                }
                
                if (customerData.nrc && !Utils.validateNRC(customerData.nrc)) {
                    ToastManager.show('Validation Error', 'Please enter a valid NRC (format: 123456/78/9)', 'error');
                    return;
                }
                
                Utils.showLoading('Creating customer...');
                
                const result = await FirebaseService.createCustomer(customerData);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 
                        `Customer created successfully. Password: ${result.password}`, 
                        'success');
                    
                    // Reset form
                    document.getElementById('createCustomerForm').reset();
                    ModalManager.closeCreateCustomerModal();
                } else {
                    ToastManager.show('Creation Failed', result.error, 'error');
                }
            },
            
            async suspendCustomer(customerId) {
                const reason = prompt('Enter suspension reason:');
                if (!reason) {
                    ToastManager.show('Error', 'Suspension reason is required', 'error');
                    return;
                }
                
                Utils.showLoading('Suspending customer...');
                
                const result = await FirebaseService.updateCustomerStatus(customerId, 'suspended', reason);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Customer suspended successfully', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async activateCustomer(customerId) {
                Utils.showLoading('Activating customer...');
                
                const result = await FirebaseService.updateCustomerStatus(customerId, 'active', 'Activated by admin');
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Customer activated successfully', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async assignCustomerToAgent(customerId, agentId) {
                Utils.showLoading('Assigning agent...');
                
                const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Agent assigned successfully', 'success');
                    ModalManager.closeCustomerModal();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async deleteCustomer(customerId) {
                if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                    return;
                }
                
                // Check if customer has active loans
                const customerLoans = AppState.loans.filter(l => 
                    l.customerId === customerId && l.status === 'active'
                );
                
                if (customerLoans.length > 0) {
                    ToastManager.show('Cannot Delete', 
                        'Customer has active loans. Please close or reassign them first.', 
                        'error');
                    return;
                }
                
                Utils.showLoading('Deleting customer...');
                
                try {
                    // Delete customer from Firebase Auth
                    await auth.deleteUser(customerId);
                    
                    // Delete customer from database
                    await db.ref('users/' + customerId).remove();
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('customer_delete', {
                        customerId: customerId,
                        deletedBy: AppState.currentUser.uid,
                        deletedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    Utils.hideLoading();
                    ToastManager.show('Success', 'Customer deleted successfully', 'success');
                    ModalManager.closeCustomerModal();
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to delete customer', 'error');
                }
            },
            
            async exportCustomers() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const customers = AppState.customers;
                    const headers = ['Customer ID', 'Name', 'Email', 'Phone', 'NRC', 'Status', 'Agent', 'Active Loans', 'Total Borrowed', 'Created Date'];
                    const rows = customers.map(customer => {
                        const customerLoans = AppState.loans.filter(l => l.customerId === customer.id);
                        const activeLoans = customerLoans.filter(l => l.status === 'active').length;
                        const totalBorrowed = customerLoans.reduce((sum, loan) => sum + (loan.amount || 0), 0);
                        
                        return [
                            customer.id.substring(0, 8),
                            customer.fullName || '',
                            customer.email || '',
                            customer.phone || '',
                            customer.nrc || '',
                            customer.status || '',
                            customer.assignedAgentName || 'Unassigned',
                            activeLoans,
                            totalBorrowed,
                            Utils.formatDateOnly(customer.createdAt)
                        ];
                    });
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customers_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Customers exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting customers:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export customers', 'error');
                }
            }
        };
        
        // ===== ASSIGNMENT MANAGER =====
        const AssignmentManager = {
            async assignAgent() {
                const customerId = document.getElementById('assignmentCustomer').value;
                const agentId = document.getElementById('assignmentAgent').value;
                
                if (!customerId || !agentId) {
                    ToastManager.show('Validation Error', 'Please select both customer and agent', 'error');
                    return;
                }
                
                Utils.showLoading('Assigning agent...');
                
                const result = await FirebaseService.assignAgentToCustomer(customerId, agentId);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Agent assigned successfully', 'success');
                    document.getElementById('assignmentForm').reset();
                    UIManager.updateAssignmentsUI();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async removeAssignment(customerId) {
                if (!confirm('Are you sure you want to remove this assignment?')) {
                    return;
                }
                
                Utils.showLoading('Removing assignment...');
                
                try {
                    const customerRef = db.ref('users/' + customerId);
                    await customerRef.update({
                        assignedAgentId: '',
                        assignedAgentName: '',
                        assignedAt: null,
                        assignedBy: null,
                        assignedByName: null,
                        updatedAt: Date.now()
                    });
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('agent_assignment_remove', {
                        customerId: customerId,
                        removedBy: AppState.currentUser.uid,
                        removedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    Utils.hideLoading();
                    ToastManager.show('Success', 'Assignment removed successfully', 'success');
                    UIManager.updateAssignmentsUI();
                } catch (error) {
                    console.error('Error removing assignment:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to remove assignment', 'error');
                }
            },
            
            refreshAssignments() {
                UIManager.updateAssignmentsUI();
                ToastManager.show('Refreshed', 'Assignments list refreshed', 'info');
            }
        };
        
        // ===== COMMISSION MANAGER =====
        const CommissionManager = {
            async approveCommission(commissionId) {
                Utils.showLoading('Processing commission...');
                
                const result = await FirebaseService.processCommission(commissionId, 'approve');
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Commission approved and paid', 'success');
                    UIManager.updateCommissionsUI();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async rejectCommission(commissionId) {
                Utils.showLoading('Processing commission...');
                
                const result = await FirebaseService.processCommission(commissionId, 'reject');
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Commission rejected', 'success');
                    UIManager.updateCommissionsUI();
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            async processBulkCommissions() {
                const pendingCommissions = AppState.commissions.filter(c => c.status === 'pending');
                
                if (pendingCommissions.length === 0) {
                    ToastManager.show('Info', 'No pending commissions to process', 'info');
                    return;
                }
                
                if (!confirm(`Process ${pendingCommissions.length} pending commissions?`)) {
                    return;
                }
                
                Utils.showLoading('Processing bulk commissions...');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const commission of pendingCommissions) {
                    const result = await FirebaseService.processCommission(commission.id, 'approve');
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                Utils.hideLoading();
                
                if (errorCount === 0) {
                    ToastManager.show('Success', 
                        `Successfully processed ${successCount} commissions`, 
                        'success');
                } else {
                    ToastManager.show('Partial Success', 
                        `Processed ${successCount} commissions, ${errorCount} failed`, 
                        successCount > 0 ? 'warning' : 'error');
                }
                
                UIManager.updateCommissionsUI();
            },
            
            async viewCommissionDetails(commissionId) {
                // Similar to other detail views
                ToastManager.show('Info', 'Commission details view coming soon', 'info');
            },
            
            async exportCommissions() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const commissions = AppState.commissions;
                    const headers = ['Commission ID', 'Agent', 'Customer', 'Loan ID', 'Amount', 'Type', 'Status', 'Created Date', 'Paid Date'];
                    const rows = commissions.map(commission => [
                        commission.id,
                        commission.agentName || '',
                        commission.customerName || '',
                        commission.loanId || '',
                        commission.amount || 0,
                        commission.type || '',
                        commission.status || '',
                        Utils.formatDateOnly(commission.createdAt),
                        commission.paidAt ? Utils.formatDateOnly(commission.paidAt) : ''
                    ]);
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `commissions_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Commissions exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting commissions:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export commissions', 'error');
                }
            }
        };
        
        // ===== REPAYMENT MANAGER =====
        const RepaymentManager = {
            async verifyRepayment(repaymentId) {
                Utils.showLoading('Verifying repayment...');
                
                try {
                    const repaymentRef = db.ref('repayments/' + repaymentId);
                    await repaymentRef.update({
                        status: 'verified',
                        verifiedAt: Date.now(),
                        verifiedBy: AppState.currentUser.uid,
                        verifiedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    // Create audit log
                    await FirebaseService.createAuditLog('repayment_verify', {
                        repaymentId: repaymentId,
                        verifiedBy: AppState.currentUser.uid,
                        verifiedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    Utils.hideLoading();
                    ToastManager.show('Success', 'Repayment verified successfully', 'success');
                    UIManager.updateRepaymentsUI();
                } catch (error) {
                    console.error('Error verifying repayment:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to verify repayment', 'error');
                }
            },
            
            async viewRepaymentDetails(repaymentId) {
                // Similar to other detail views
                ToastManager.show('Info', 'Repayment details view coming soon', 'info');
            },
            
            async exportRepayments() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const repayments = AppState.repayments;
                    const headers = ['Repayment ID', 'Customer', 'Loan ID', 'Amount', 'Due Date', 'Paid Date', 'Agent', 'Status', 'Payment Method'];
                    const rows = repayments.map(repayment => [
                        repayment.id,
                        repayment.customerName || '',
                        repayment.loanId || '',
                        repayment.amount || 0,
                        Utils.formatDateOnly(repayment.dueDate),
                        repayment.timestamp ? Utils.formatDateOnly(repayment.timestamp) : '',
                        repayment.agentName || '',
                        repayment.status || '',
                        repayment.paymentMethod || ''
                    ]);
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `repayments_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Repayments exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting repayments:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export repayments', 'error');
                }
            }
        };
        
        // ===== TRANSACTION MANAGER =====
        const TransactionManager = {
            async viewTransactionDetails(transactionId) {
                // Similar to other detail views
                ToastManager.show('Info', 'Transaction details view coming soon', 'info');
            },
            
            async exportTransactions() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const transactions = AppState.transactions;
                    const headers = ['Transaction ID', 'Type', 'Amount', 'Customer', 'Agent', 'Date', 'Status', 'Reference', 'Description'];
                    const rows = transactions.map(transaction => [
                        transaction.id,
                        transaction.type || '',
                        transaction.amount || 0,
                        transaction.customerName || '',
                        transaction.agentName || '',
                        Utils.formatDate(transaction.createdAt),
                        transaction.status || '',
                        transaction.reference || '',
                        transaction.description || ''
                    ]);
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `transactions_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Transactions exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting transactions:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export transactions', 'error');
                }
            }
        };
        
        // ===== AUDIT MANAGER =====
        const AuditManager = {
            async filterAuditLog() {
                UIManager.updateAuditUI();
            },
            
            async exportAuditLog() {
                try {
                    Utils.showLoading('Preparing export...');
                    
                    const logs = AppState.auditLogs;
                    const headers = ['Timestamp', 'User', 'User Type', 'Action', 'Details', 'IP Address', 'User Agent'];
                    const rows = logs.map(log => [
                        Utils.formatDate(log.timestamp),
                        log.userName || '',
                        log.userType || '',
                        log.action || '',
                        JSON.stringify(log.data || {}),
                        log.ipAddress || '',
                        log.userAgent || ''
                    ]);
                    
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audit_log_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Utils.hideLoading();
                    ToastManager.show('Export Successful', 'Audit log exported to CSV', 'success');
                } catch (error) {
                    console.error('Error exporting audit log:', error);
                    Utils.hideLoading();
                    ToastManager.show('Export Failed', 'Failed to export audit log', 'error');
                }
            },
            
            async clearOldLogs() {
                if (!confirm('Are you sure you want to clear audit logs older than 30 days?')) {
                    return;
                }
                
                Utils.showLoading('Clearing old logs...');
                
                try {
                    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    const oldLogs = AppState.auditLogs.filter(log => log.timestamp < thirtyDaysAgo);
                    
                    for (const log of oldLogs) {
                        await db.ref('auditLogs/' + log.id).remove();
                    }
                    
                    // Create audit log for the cleanup
                    await FirebaseService.createAuditLog('audit_log_cleanup', {
                        clearedCount: oldLogs.length,
                        clearedBy: AppState.currentUser.uid,
                        clearedByName: AppState.adminData.fullName || AppState.currentUser.email
                    });
                    
                    Utils.hideLoading();
                    ToastManager.show('Success', `Cleared ${oldLogs.length} old audit logs`, 'success');
                    UIManager.updateAuditUI();
                } catch (error) {
                    console.error('Error clearing old logs:', error);
                    Utils.hideLoading();
                    ToastManager.show('Error', 'Failed to clear old logs', 'error');
                }
            }
        };
        
        // ===== SETTINGS MANAGER =====
        const SettingsManager = {
            async saveSettings() {
                Utils.showLoading('Saving settings...');
                
                const settings = {
                    general: {
                        systemName: document.getElementById('systemName').value,
                        currency: document.getElementById('systemCurrency').value,
                        timezone: document.getElementById('systemTimezone').value,
                        dateFormat: document.getElementById('dateFormat').value,
                        itemsPerPage: parseInt(document.getElementById('itemsPerPage').value)
                    },
                    loan: {
                        minAmount: parseFloat(document.getElementById('minLoanAmount').value),
                        maxAmount: parseFloat(document.getElementById('maxLoanAmount').value),
                        minTerm: parseInt(document.getElementById('minLoanTerm').value),
                        maxTerm: parseInt(document.getElementById('maxLoanTerm').value),
                        defaultInterestRate: parseFloat(document.getElementById('defaultInterestRate').value),
                        penaltyInterestRate: parseFloat(document.getElementById('penaltyInterestRate').value),
                        gracePeriod: parseInt(document.getElementById('gracePeriod').value),
                        processingFee: parseFloat(document.getElementById('processingFee').value)
                    },
                    commission: {
                        defaultRate: parseFloat(document.getElementById('defaultCommissionRate').value),
                        onboardingCommission: parseFloat(document.getElementById('onboardingCommission').value),
                        minPayoutAmount: parseFloat(document.getElementById('minPayoutAmount').value),
                        payoutSchedule: document.getElementById('payoutSchedule').value,
                        payoutDay: parseInt(document.getElementById('payoutDay').value)
                    }
                };
                
                const result = await FirebaseService.saveSystemSettings(settings);
                
                Utils.hideLoading();
                
                if (result.success) {
                    ToastManager.show('Success', 'Settings saved successfully', 'success');
                } else {
                    ToastManager.show('Error', result.error, 'error');
                }
            },
            
            resetSettings() {
                if (!confirm('Are you sure you want to reset all settings to defaults?')) {
                    return;
                }
                
                UIManager.updateSettingsUI();
                ToastManager.show('Settings Reset', 'All settings reset to defaults', 'info');
            }
        };
        
        // ===== DOCUMENT MANAGER =====
        const DocumentManager = {
            openUploadWidget(documentType) {
                CloudinaryService.openUploadWidget(documentType);
            },
            
            viewImage(imageUrl) {
                const modal = document.getElementById('imageModal');
                const image = document.getElementById('modalImage');
                
                image.src = imageUrl;
                modal.classList.add('active');
            }
        };
        
        // ===== MODAL MANAGER =====
        const ModalManager = {
            closeLoanModal() {
                document.getElementById('loanDetailModal').classList.remove('active');
                AppState.selectedLoan = null;
            },
            
            closeAgentModal() {
                document.getElementById('agentDetailModal').classList.remove('active');
                AppState.selectedAgent = null;
            },
            
            closeCustomerModal() {
                document.getElementById('customerDetailModal').classList.remove('active');
                AppState.selectedCustomer = null;
            },
            
            closeCreateCustomerModal() {
                document.getElementById('createCustomerModal').classList.remove('active');
                document.getElementById('createCustomerForm').reset();
            },
            
            closeCommissionModal() {
                document.getElementById('commissionProcessModal').classList.remove('active');
            },
            
            closeApprovalModal() {
                document.getElementById('approvalWorkflowModal').classList.remove('active');
            },
            
            closeImageModal() {
                document.getElementById('imageModal').classList.remove('active');
            }
        };
        
        // ===== DASHBOARD MANAGER =====
        const DashboardManager = {
            applyDateFilter() {
                ToastManager.show('Filter Applied', 'Date filter applied to dashboard data', 'info');
                // In a real implementation, this would filter the dashboard data
            }
        };
        
        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            
            // Set up online/offline detection
            UIManager.updateConnectionStatus();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Close modals with Escape key
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        activeModal.classList.remove('active');
                    }
                }
                
                // Navigation shortcuts (Ctrl/Cmd + number)
                if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
                    const sections = ['dashboard', 'loans', 'agents', 'customers', 'assignments', 'commissions', 'repayments', 'transactions', 'audit'];
                    const index = parseInt(e.key) - 1;
                    if (sections[index]) {
                        e.preventDefault();
                        UIManager.showSection(sections[index]);
                    }
                }
            });
        });
        
        // ===== GLOBAL EXPORTS =====
        window.UIManager = UIManager;
        window.LoanManager = LoanManager;
        window.AgentManager = AgentManager;
        window.CustomerManager = CustomerManager;
        window.AssignmentManager = AssignmentManager;
        window.CommissionManager = CommissionManager;
        window.RepaymentManager = RepaymentManager;
        window.TransactionManager = TransactionManager;
        window.AuditManager = AuditManager;
        window.SettingsManager = SettingsManager;
        window.DocumentManager = DocumentManager;
        window.ModalManager = ModalManager;
        window.DashboardManager = DashboardManager;
        window.Utils = Utils;
        window.ToastManager = ToastManager;
    </script>
</body>
</html>
