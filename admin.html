<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruCash | Advanced Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 for Better Modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* ===== CSS Reset & Variables ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
                       'Helvetica Neue', 'Segoe UI', Roboto, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --primary-color: #007AFF;
            --primary-dark: #0056CC;
            --primary-light: #409cff;
            --secondary-color: #5856D6;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --info-color: #5AC8FA;
            --dark-color: #1D1D1F;
            --light-color: #F5F5F7;
            --gray-100: #F2F2F7;
            --gray-200: #E5E5EA;
            --gray-300: #D1D1D6;
            --gray-400: #C7C7CC;
            --gray-500: #8E8E93;
            --gray-600: #636366;
            --gray-700: #48484A;
            --gray-800: #3A3A3C;
            --gray-900: #2C2C2E;
            --sidebar-width: 260px;
            --header-height: 70px;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--dark-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== Layout Structure ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(135deg, var(--dark-color), var(--gray-700));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-500);
            padding: 0 20px 8px;
            font-weight: 600;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            margin: 4px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--gray-700);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background: rgba(0, 122, 255, 0.08);
            color: var(--primary-color);
        }

        .nav-link.active {
            background: rgba(0, 122, 255, 0.12);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .nav-link i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger-color);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 122, 255, 0.05);
            border-radius: var(--border-radius-sm);
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .admin-details h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--dark-color);
        }

        .admin-details p {
            font-size: 12px;
            color: var(--gray-500);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            color: var(--danger-color);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: rgba(255, 59, 48, 0.1);
            border-color: var(--danger-color);
            transform: translateY(-1px);
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== Header ===== */
        .main-header {
            height: var(--header-height);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-left h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-700);
        }

        .notification-bell:hover {
            background: var(--gray-200);
            color: var(--primary-color);
        }

        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--danger-color);
            border-radius: 50%;
            border: 2px solid white;
        }

        .quick-stats {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--gray-100);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-item i {
            color: var(--primary-color);
        }

        /* ===== Content Area ===== */
        .content-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Dashboard Overview ===== */
        .dashboard-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.total-users::before {
            background: var(--primary-color);
        }

        .stat-card.active-agents::before {
            background: var(--success-color);
        }

        .stat-card.pending-apps::before {
            background: var(--warning-color);
        }

        .stat-card.pending-tx::before {
            background: var(--danger-color);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .total-users .stat-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        }

        .active-agents .stat-icon {
            background: linear-gradient(135deg, var(--success-color), #2DB867);
        }

        .pending-apps .stat-icon {
            background: linear-gradient(135deg, var(--warning-color), #FF9500);
        }

        .pending-tx .stat-icon {
            background: linear-gradient(135deg, var(--danger-color), #FF2D55);
        }

        .stat-title {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
            line-height: 1;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* ===== Charts Section ===== */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* ===== Recent Activity ===== */
        .recent-activity {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--gray-50);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .activity-icon.approval {
            background: var(--success-color);
        }

        .activity-icon.rejection {
            background: var(--danger-color);
        }

        .activity-icon.warning {
            background: var(--warning-color);
        }

        .activity-icon.info {
            background: var(--info-color);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark-color);
        }

        .activity-description {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* ===== Data Tables ===== */
        .data-table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table-tools {
            display: flex;
            gap: 12px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 16px 8px 40px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            width: 200px;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            color: var(--gray-700);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            background: var(--gray-200);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-100);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
            color: var(--gray-800);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* ===== Status Badges ===== */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
        }

        .status-approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
        }

        .status-active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
        }

        .status-suspended {
            background: rgba(142, 142, 147, 0.1);
            color: var(--gray-600);
        }

        .status-banned {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
        }

        /* ===== Action Buttons ===== */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 14px;
        }

        .btn-view {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
        }

        .btn-view:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        .btn-edit {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .btn-edit:hover {
            background: rgba(52, 199, 89, 0.2);
        }

        .btn-delete {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
        }

        .btn-delete:hover {
            background: rgba(255, 59, 48, 0.2);
        }

        .btn-approve {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .btn-approve:hover {
            background: rgba(52, 199, 89, 0.2);
        }

        .btn-reject {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .btn-reject:hover {
            background: rgba(255, 59, 48, 0.2);
        }

        /* ===== Modal Styles ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-large {
            max-width: 1000px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--gray-200);
            color: var(--danger-color);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--gray-50);
        }

        /* ===== Form Elements ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2DB867);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #2DB867, var(--success-color));
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.35);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #FF2D55);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #FF2D55, var(--danger-color));
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.35);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #FFA500);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.25);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #FFA500, var(--warning-color));
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.35);
        }

        /* ===== Loading States ===== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--gray-500);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== Empty States ===== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--gray-500);
            text-align: center;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--gray-400);
        }

        /* ===== Tab Navigation ===== */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Card Grid ===== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .info-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .info-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        .info-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-color);
        }

        /* ===== Document Preview ===== */
        .document-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .document-item {
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            transition: var(--transition);
        }

        .document-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .document-image {
            height: 120px;
            overflow: hidden;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .document-info {
            padding: 12px;
            background: white;
        }

        .document-info h5 {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 4px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .document-info p {
            font-size: 11px;
            color: var(--gray-500);
        }

        /* ===== Timeline ===== */
        .timeline {
            position: relative;
            padding-left: 20px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-300);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 16px;
            padding-left: 24px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .timeline-date {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .timeline-content {
            font-size: 14px;
            color: var(--gray-800);
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .dashboard-overview {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .table-tools {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box input {
                width: 100%;
            }

            .header-right {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .quick-stats {
                flex-wrap: wrap;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Mobile Menu Toggle ===== */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.1);
        }

        /* ===== Notification Dropdown ===== */
        .notification-dropdown {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            z-index: 1000;
            display: none;
        }

        .notification-dropdown.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .notification-header {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: var(--gray-50);
        }

        .notification-item.unread {
            background: rgba(0, 122, 255, 0.05);
        }

        .notification-content h5 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark-color);
        }

        .notification-content p {
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 11px;
            color: var(--gray-500);
        }

        /* ===== Badge Counter ===== */
        .badge-counter {
            display: inline-block;
            padding: 2px 8px;
            background: var(--danger-color);
            color: white;
            font-size: 10px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* ===== Toast Notifications ===== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border: 1px solid var(--gray-200);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast.info {
            border-left-color: var(--info-color);
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--success-color);
        }

        .toast.error .toast-icon {
            color: var(--danger-color);
        }

        .toast.warning .toast-icon {
            color: var(--warning-color);
        }

        .toast.info .toast-icon {
            color: var(--info-color);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--dark-color);
        }

        .toast-message {
            font-size: 13px;
            color: var(--gray-600);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition);
        }

        .toast-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        /* ===== Profile Header ===== */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--border-radius);
            color: white;
            margin-bottom: 24px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-info p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .stat-box .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 4px;
        }

        .stat-box .label {
            font-size: 12px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== Password Strength ===== */
        .password-strength {
            height: 4px;
            background: var(--gray-300);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .strength-weak {
            background: var(--danger-color);
            width: 25%;
        }

        .strength-fair {
            background: var(--warning-color);
            width: 50%;
        }

        .strength-good {
            background: var(--info-color);
            width: 75%;
        }

        .strength-strong {
            background: var(--success-color);
            width: 100%;
        }

        /* ===== Toggle Switch ===== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* ===== Admin Controls ===== */
        .admin-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .control-btn {
            padding: 12px 20px;
            border-radius: var(--border-radius-sm);
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* ===== Audit Trail ===== */
        .audit-trail {
            background: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .audit-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        .audit-item:last-child {
            border-bottom: none;
        }

        .audit-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--gray-700);
            flex-shrink: 0;
        }

        .audit-content {
            flex: 1;
        }

        .audit-content h5 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark-color);
        }

        .audit-content p {
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .audit-time {
            font-size: 11px;
            color: var(--gray-500);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">T</div>
                <div class="logo-text">TruCash Admin</div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-title">Dashboard</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#overview" class="nav-link active" data-section="overview">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Overview</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#analytics" class="nav-link" data-section="analytics">
                                <i class="fas fa-chart-line"></i>
                                <span>Analytics</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#notifications" class="nav-link" data-section="notifications">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                                <span class="nav-badge" id="notificationCount">0</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Agent Management</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#applications" class="nav-link" data-section="applications">
                                <i class="fas fa-user-clock"></i>
                                <span>Applications</span>
                                <span class="nav-badge" id="applicationCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#agents" class="nav-link" data-section="agents">
                                <i class="fas fa-users"></i>
                                <span>All Agents</span>
                                <span class="badge-counter" id="totalAgents">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#agent-approvals" class="nav-link" data-section="agent-approvals">
                                <i class="fas fa-user-check"></i>
                                <span>Credential Setup</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#performance" class="nav-link" data-section="performance">
                                <i class="fas fa-chart-bar"></i>
                                <span>Performance</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Customer Management</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#customers" class="nav-link" data-section="customers">
                                <i class="fas fa-user-friends"></i>
                                <span>All Customers</span>
                                <span class="badge-counter" id="totalCustomers">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#verification" class="nav-link" data-section="verification">
                                <i class="fas fa-check-circle"></i>
                                <span>Verification</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#transactions" class="nav-link" data-section="transactions">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Transactions</span>
                                <span class="nav-badge" id="pendingTxCount">0</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Account Controls</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#suspended" class="nav-link" data-section="suspended">
                                <i class="fas fa-ban"></i>
                                <span>Suspended Accounts</span>
                                <span class="nav-badge" id="suspendedCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#banned" class="nav-link" data-section="banned">
                                <i class="fas fa-user-slash"></i>
                                <span>Banned Accounts</span>
                                <span class="nav-badge" id="bannedCount">0</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Compliance</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#disputes" class="nav-link" data-section="disputes">
                                <i class="fas fa-gavel"></i>
                                <span>Disputes</span>
                                <span class="nav-badge" id="disputeCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#audit" class="nav-link" data-section="audit">
                                <i class="fas fa-history"></i>
                                <span>Audit Trail</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#settings" class="nav-link" data-section="settings">
                                <i class="fas fa-cog"></i>
                                <span>System Settings</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="admin-info">
                    <div class="admin-avatar" id="adminAvatar">A</div>
                    <div class="admin-details">
                        <h4 id="adminName">Admin User</h4>
                        <p id="adminEmail">Loading...</p>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <h1 id="pageTitle">Dashboard Overview</h1>
                </div>
                
                <div class="header-right">
                    <div class="quick-stats">
                        <div class="stat-item">
                            <i class="fas fa-globe"></i>
                            <span>Live</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-database"></i>
                            <span id="lastUpdated">Just now</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Admin Mode</span>
                        </div>
                    </div>
                    
                    <div class="notification-container">
                        <div class="notification-bell" id="notificationBell">
                            <i class="fas fa-bell"></i>
                            <div class="notification-badge"></div>
                        </div>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <button class="btn-secondary btn-sm" id="markAllRead">Mark all read</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="empty-state">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>No notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Overview Section -->
                <section id="overview" class="content-section active">
                    <div class="dashboard-overview">
                        <div class="stat-card total-users">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Total Users</div>
                                    <div class="stat-value" id="totalUsers">0</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="userChange">0%</span> from last week
                            </div>
                        </div>
                        
                        <div class="stat-card active-agents">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Active Agents</div>
                                    <div class="stat-value" id="activeAgents">0</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="agentChange">0%</span> from last week
                            </div>
                        </div>
                        
                        <div class="stat-card pending-apps">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Pending Applications</div>
                                    <div class="stat-value" id="pendingApps">0</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-up"></i>
                                <span id="appChange">0</span> new today
                            </div>
                        </div>
                        
                        <div class="stat-card pending-tx">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Pending Transactions</div>
                                    <div class="stat-value" id="pendingTx">0</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-down"></i>
                                <span id="txChange">0</span> resolved today
                            </div>
                        </div>
                    </div>

                    <div class="charts-section">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Transaction Volume</h3>
                                <select class="form-control" id="chartPeriod" style="width: auto;">
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="transactionChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>User Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="userDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="recent-activity">
                        <h3 style="margin-bottom: 20px;">Recent Activity</h3>
                        <div class="activity-list" id="recentActivity">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Loading activities...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Applications Section -->
                <section id="applications" class="content-section">
                    <div class="admin-controls">
                        <button class="control-btn" onclick="refreshApplications()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="control-btn" onclick="exportApplications()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="control-btn" onclick="showBulkActions()">
                            <i class="fas fa-tasks"></i> Bulk Actions
                        </button>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Agent Applications</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="appSearch" placeholder="Search applications...">
                                </div>
                                <select class="form-select" id="appFilter" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="reviewed">Reviewed</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="loading" id="appsLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading applications...</p>
                        </div>
                        
                        <div id="applicationsTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" id="selectAllApps">
                                        </th>
                                        <th>Application ID</th>
                                        <th>Applicant Name</th>
                                        <th>Phone</th>
                                        <th>NRC</th>
                                        <th>Submitted</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsBody">
                                    <!-- Applications will be loaded here -->
                                </tbody>
                            </table>
                            
                            <div class="pagination" id="appPagination">
                                <!-- Pagination will be loaded here -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Active Agents Section -->
                <section id="agents" class="content-section">
                    <div class="admin-controls">
                        <button class="control-btn" onclick="createAgentAccount()">
                            <i class="fas fa-plus-circle"></i> Create Agent
                        </button>
                        <button class="control-btn" onclick="refreshAgents()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="control-btn" onclick="exportAgents()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>All Agents</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="agentSearch" placeholder="Search agents...">
                                </div>
                                <select class="form-select" id="agentFilter" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="loading" id="agentsLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading agents...</p>
                        </div>
                        
                        <div id="agentsTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Agent ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Clients</th>
                                        <th>Loans</th>
                                        <th>Commission</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsBody">
                                    <!-- Agents will be loaded here -->
                                </tbody>
                            </table>
                            
                            <div class="pagination" id="agentPagination">
                                <!-- Pagination will be loaded here -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Agent Credential Setup -->
                <section id="agent-approvals" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Manual Agent Credential Setup</h3>
                            <button class="btn btn-primary" onclick="openManualAgentCreation()">
                                <i class="fas fa-plus"></i> Create Agent Manually
                            </button>
                        </div>
                        
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Application Selection</label>
                                <select class="form-select" id="pendingAppsSelect">
                                    <option value="">Select an application to set credentials</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Manual Credential Setup</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Agent Email *</label>
                                        <input type="email" class="form-control" id="manualAgentEmail" placeholder="agent@trucash.com">
                                    </div>
                                    <div class="form-group">
                                        <label>Agent ID *</label>
                                        <input type="text" class="form-control" id="manualAgentId" placeholder="AG123456">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Password *</label>
                                        <input type="text" class="form-control" id="manualAgentPassword" placeholder="Enter secure password">
                                        <div class="password-strength">
                                            <div class="password-strength-bar" id="passwordStrength"></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Confirm Password *</label>
                                        <input type="text" class="form-control" id="manualAgentPasswordConfirm" placeholder="Confirm password">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Custom Commission Rate (%)</label>
                                    <input type="number" class="form-control" id="agentCommissionRate" min="1" max="20" step="0.5" value="5">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="sendCredentialsEmail" checked>
                                    <label class="form-check-label">Send credentials via email</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="requirePasswordChange">
                                    <label class="form-check-label">Require password change on first login</label>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="resetCredentialForm()">Clear Form</button>
                                <button class="btn btn-primary" onclick="saveAgentCredentials()">Save & Create Account</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Customers Section -->
                <section id="customers" class="content-section">
                    <div class="admin-controls">
                        <button class="control-btn" onclick="createCustomerAccount()">
                            <i class="fas fa-user-plus"></i> Create Customer
                        </button>
                        <button class="control-btn" onclick="refreshCustomers()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="control-btn" onclick="exportCustomers()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Customer Accounts</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="customerSearch" placeholder="Search customers...">
                                </div>
                                <select class="form-select" id="customerFilter" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="banned">Banned</option>
                                    <option value="verified">Verified</option>
                                    <option value="unverified">Unverified</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="loading" id="customersLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading customers...</p>
                        </div>
                        
                        <div id="customersTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Loans</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Verification</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersBody">
                                    <!-- Customers will be loaded here -->
                                </tbody>
                            </table>
                            
                            <div class="pagination" id="customerPagination">
                                <!-- Pagination will be loaded here -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Suspended Accounts -->
                <section id="suspended" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Suspended Accounts</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="suspendedSearch" placeholder="Search suspended accounts...">
                                </div>
                                <select class="form-select" id="suspendedFilter" style="width: 150px;">
                                    <option value="all">All Types</option>
                                    <option value="agent">Agents</option>
                                    <option value="customer">Customers</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="loading" id="suspendedLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading suspended accounts...</p>
                        </div>
                        
                        <div id="suspendedTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Account ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Type</th>
                                        <th>Suspended On</th>
                                        <th>Reason</th>
                                        <th>Suspended By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="suspendedBody">
                                    <!-- Suspended accounts will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Banned Accounts -->
                <section id="banned" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Banned Accounts</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="bannedSearch" placeholder="Search banned accounts...">
                                </div>
                                <select class="form-select" id="bannedFilter" style="width: 150px;">
                                    <option value="all">All Types</option>
                                    <option value="agent">Agents</option>
                                    <option value="customer">Customers</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="loading" id="bannedLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading banned accounts...</p>
                        </div>
                        
                        <div id="bannedTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Account ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Type</th>
                                        <th>Banned On</th>
                                        <th>Reason</th>
                                        <th>Banned By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bannedBody">
                                    <!-- Banned accounts will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Transactions Section -->
                <section id="transactions" class="content-section">
                    <div class="admin-controls">
                        <button class="control-btn" onclick="createTransaction()">
                            <i class="fas fa-plus-circle"></i> Create Transaction
                        </button>
                        <button class="control-btn" onclick="refreshTransactions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="control-btn" onclick="exportTransactions()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Transaction History</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="transactionSearch" placeholder="Search transactions...">
                                </div>
                                <select class="form-select" id="transactionFilter" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                    <option value="reversed">Reversed</option>
                                </select>
                                <input type="date" class="form-control" id="transactionDate" style="width: 150px;">
                            </div>
                        </div>
                        
                        <div class="loading" id="transactionsLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading transactions...</p>
                        </div>
                        
                        <div id="transactionsTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsBody">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                            
                            <div class="pagination" id="transactionPagination">
                                <!-- Pagination will be loaded here -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Disputes Section -->
                <section id="disputes" class="content-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>Active Disputes</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="disputeSearch" placeholder="Search disputes...">
                                </div>
                                <select class="form-select" id="disputeFilter" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="open">Open</option>
                                    <option value="investigating">Investigating</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="loading" id="disputesLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading disputes...</p>
                        </div>
                        
                        <div id="disputesTable" style="display: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Agent</th>
                                        <th>Amount</th>
                                        <th>Opened</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="disputesBody">
                                    <!-- Disputes will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings" class="content-section">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="system">System Settings</button>
                        <button class="tab-btn" data-tab="security">Security</button>
                        <button class="tab-btn" data-tab="notifications">Notifications</button>
                        <button class="tab-btn" data-tab="api">API Settings</button>
                    </div>
                    
                    <div id="system" class="tab-content active">
                        <div class="data-table-container">
                            <div class="table-header">
                                <h3>System Configuration</h3>
                            </div>
                            
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Transaction Limits</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Minimum Transaction Amount ($)</label>
                                            <input type="number" class="form-control" id="minTransaction" placeholder="10">
                                        </div>
                                        <div class="form-group">
                                            <label>Maximum Transaction Amount ($)</label>
                                            <input type="number" class="form-control" id="maxTransaction" placeholder="10000">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Commission & Fees</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Standard Commission (%)</label>
                                            <input type="number" class="form-control" id="standardCommission" placeholder="5" step="0.1">
                                        </div>
                                        <div class="form-group">
                                            <label>Premium Commission (%)</label>
                                            <input type="number" class="form-control" id="premiumCommission" placeholder="7.5" step="0.1">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Transaction Fee (%)</label>
                                            <input type="number" class="form-control" id="transactionFee" placeholder="1.5" step="0.1">
                                        </div>
                                        <div class="form-group">
                                            <label>Minimum Fee ($)</label>
                                            <input type="number" class="form-control" id="minFee" placeholder="0.50" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Penalty Settings</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Late Payment Penalty (%)</label>
                                            <input type="number" class="form-control" id="latePenalty" placeholder="2" step="0.1">
                                        </div>
                                        <div class="form-group">
                                            <label>Grace Period (Days)</label>
                                            <input type="number" class="form-control" id="gracePeriod" placeholder="7">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">System Maintenance</label>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="maintenanceMode">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <label for="maintenanceMode" style="font-weight: 600;">Enable Maintenance Mode</label>
                                    </div>
                                    <textarea class="form-control form-textarea" id="maintenanceMessage" placeholder="Maintenance message (shown to users)"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="security" class="tab-content">
                        <div class="data-table-container">
                            <div class="table-header">
                                <h3>Security Settings</h3>
                            </div>
                            
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Login Security</label>
                                    <div style="margin-bottom: 16px;">
                                       
                                    </div>
                                    <div style="margin-bottom: 16px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="loginNotifications" checked>
                                            <label class="form-check-label" for="loginNotifications">Email notifications for admin logins</label>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Session Timeout (Minutes)</label>
                                            <input type="number" class="form-control" id="sessionTimeout" value="30" min="5" max="480">
                                        </div>
                                        <div class="form-group">
                                            <label>Max Login Attempts</label>
                                            <input type="number" class="form-control" id="maxLoginAttempts" value="5" min="1" max="10">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Password Policy</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Minimum Length</label>
                                            <input type="number" class="form-control" id="minPasswordLength" value="8" min="6" max="32">
                                        </div>
                                        <div class="form-group">
                                            <label>Require Special Characters</label>
                                            <select class="form-select" id="requireSpecialChars">
                                                <option value="true">Yes</option>
                                                <option value="false">No</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Password Expiry (Days)</label>
                                            <input type="number" class="form-control" id="passwordExpiry" value="90" min="30" max="365">
                                        </div>
                                        <div class="form-group">
                                            <label>Password History (Remember last)</label>
                                            <input type="number" class="form-control" id="passwordHistory" value="5" min="0" max="10">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">IP Whitelist</label>
                                    <textarea class="form-control form-textarea" id="ipWhitelist" placeholder="Enter allowed IP addresses (one per line)"></textarea>
                                    <small class="text-muted">Leave empty to allow from any IP</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="notifications" class="tab-content">
                        <div class="data-table-container">
                            <div class="table-header">
                                <h3>Notification Settings</h3>
                            </div>
                            
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Email Notifications</label>
                                    <div style="margin-bottom: 12px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="emailApplications" checked>
                                            <label class="form-check-label" for="emailApplications">New agent applications</label>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="emailTransactions" checked>
                                            <label class="form-check-label" for="emailTransactions">Large transactions</label>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="emailDisputes" checked>
                                            <label class="form-check-label" for="emailDisputes">New disputes</label>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="emailSuspensions" checked>
                                            <label class="form-check-label" for="emailSuspensions">Account suspensions</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">SMS Notifications</label>
                                    <div style="margin-bottom: 12px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="smsCritical" checked>
                                            <label class="form-check-label" for="smsCritical">Critical alerts</label>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="smsSecurity">
                                            <label class="form-check-label" for="smsSecurity">Security alerts</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notification Thresholds</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Large Transaction Amount ($)</label>
                                            <input type="number" class="form-control" id="largeTxThreshold" value="1000">
                                        </div>
                                        <div class="form-group">
                                            <label>Daily Report Time</label>
                                            <input type="time" class="form-control" id="dailyReportTime" value="08:00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="api" class="tab-content">
                        <div class="data-table-container">
                            <div class="table-header">
                                <h3>API & Integration Settings</h3>
                            </div>
                            
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">API Keys</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Cloudinary Cloud Name</label>
                                            <input type="text" class="form-control" id="cloudinaryCloud" placeholder="your-cloud-name">
                                        </div>
                                        <div class="form-group">
                                            <label>Cloudinary Upload Preset</label>
                                            <input type="text" class="form-control" id="cloudinaryPreset" placeholder="your-upload-preset">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Payment Gateway</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Gateway Provider</label>
                                            <select class="form-select" id="paymentGateway">
                                                <option value="stripe">Stripe</option>
                                                <option value="paypal">PayPal</option>
                                                <option value="razorpay">Razorpay</option>
                                                <option value="custom">Custom</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>API Key</label>
                                            <input type="password" class="form-control" id="paymentApiKey" placeholder="">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Secret Key</label>
                                            <input type="password" class="form-control" id="paymentSecret" placeholder="">
                                        </div>
                                        <div class="form-group">
                                            <label>Webhook Secret</label>
                                            <input type="password" class="form-control" id="webhookSecret" placeholder="">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">SMS Gateway</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Provider</label>
                                            <select class="form-select" id="smsGateway">
                                                <option value="twilio">Twilio</option>
                                                <option value="plivo">Plivo</option>
                                                <option value="nexmo">Nexmo</option>
                                                <option value="custom">Custom</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Account SID</label>
                                            <input type="text" class="form-control" id="smsAccountSid" placeholder="Account SID">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Auth Token</label>
                                            <input type="password" class="form-control" id="smsAuthToken" placeholder="Auth Token">
                                        </div>
                                        <div class="form-group">
                                            <label>From Number</label>
                                            <input type="text" class="form-control" id="smsFromNumber" placeholder="+1234567890">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="resetAllSettings()">Reset All</button>
                        <button class="btn btn-primary" onclick="saveAllSettings()">Save All Settings</button>
                    </div>
                </section>

                <!-- Other sections will be loaded similarly -->
            </div>
        </main>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Modals -->
    <!-- Application Details Modal -->
    <div class="modal-overlay" id="appDetailsModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">Application Details & Credential Setup</h3>
                <button class="modal-close" onclick="closeModal('appDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="appDetailsContent">
                <!-- Application details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('appDetailsModal')">Close</button>
                <button class="btn btn-danger" onclick="rejectApplicationModal()">Reject Application</button>
                <button class="btn btn-success" onclick="approveApplicationModal()">Setup Credentials & Approve</button>
            </div>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div class="modal-overlay" id="agentDetailsModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">Agent Account Details</h3>
                <button class="modal-close" onclick="closeModal('agentDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="agentDetailsContent">
                <!-- Agent details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('agentDetailsModal')">Close</button>
                <button class="btn btn-warning" id="suspendAgentBtn">Suspend Account</button>
                <button class="btn btn-danger" id="banAgentBtn">Ban Account</button>
                <button class="btn btn-success" id="activateAgentBtn">Activate Account</button>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal-overlay" id="customerDetailsModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">Customer Account Details</h3>
                <button class="modal-close" onclick="closeModal('customerDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="customerDetailsContent">
                <!-- Customer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('customerDetailsModal')">Close</button>
                <button class="btn btn-warning" id="suspendCustomerBtn">Suspend Account</button>
                <button class="btn btn-danger" id="banCustomerBtn">Ban Account</button>
                <button class="btn btn-success" id="activateCustomerBtn">Activate Account</button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal-overlay" id="createAgentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent Account</h3>
                <button class="modal-close" onclick="closeModal('createAgentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Agent Information</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" class="form-control" id="createAgentName" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" class="form-control" id="createAgentPhone" placeholder="+1234567890">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" class="form-control" id="createAgentEmail" placeholder="agent@trucash.com">
                        </div>
                        <div class="form-group">
                            <label>Agent ID *</label>
                            <input type="text" class="form-control" id="createAgentId" placeholder="AG123456">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Credentials</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="text" class="form-control" id="createAgentPassword" placeholder="Enter secure password">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password *</label>
                            <input type="text" class="form-control" id="createAgentPasswordConfirm" placeholder="Confirm password">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Commission Settings</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Commission Rate (%)</label>
                            <input type="number" class="form-control" id="createAgentCommission" min="1" max="20" step="0.5" value="5">
                        </div>
                        <div class="form-group">
                            <label>Account Status</label>
                            <select class="form-select" id="createAgentStatus">
                                <option value="active">Active</option>
                                <option value="pending">Pending Review</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewAgent()">Create Agent Account</button>
            </div>
        </div>
    </div>

    <!-- Create Customer Modal -->
    <div class="modal-overlay" id="createCustomerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Customer Account</h3>
                <button class="modal-close" onclick="closeModal('createCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Customer Information</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" class="form-control" id="createCustomerName" placeholder="Jane Smith">
                        </div>
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" class="form-control" id="createCustomerPhone" placeholder="+1234567890">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" class="form-control" id="createCustomerEmail" placeholder="customer@example.com">
                        </div>
                        <div class="form-group">
                            <label>Initial Balance ($)</label>
                            <input type="number" class="form-control" id="createCustomerBalance" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Credentials</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="text" class="form-control" id="createCustomerPassword" placeholder="Enter secure password">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password *</label>
                            <input type="text" class="form-control" id="createCustomerPasswordConfirm" placeholder="Confirm password">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Settings</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Account Status</label>
                            <select class="form-select" id="createCustomerStatus">
                                <option value="active">Active</option>
                                <option value="pending">Pending Verification</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Verification Level</label>
                            <select class="form-select" id="createCustomerVerification">
                                <option value="unverified">Unverified</option>
                                <option value="basic">Basic</option>
                                <option value="full">Full KYC</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createCustomerModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewCustomer()">Create Customer Account</button>
            </div>
        </div>
    </div>

    <!-- Suspension/Ban Modal -->
    <div class="modal-overlay" id="suspensionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="suspensionTitle">Suspend Account</h3>
                <button class="modal-close" onclick="closeModal('suspensionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Account Information</label>
                    <div class="info-card">
                        <div id="suspensionAccountInfo"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Action Type</label>
                    <select class="form-select" id="suspensionType" onchange="updateSuspensionType()">
                        <option value="suspend">Suspend Account</option>
                        <option value="ban">Ban Account Permanently</option>
                        <option value="warning">Issue Warning</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="suspensionReasonLabel">Reason for Suspension *</label>
                    <textarea class="form-control form-textarea" id="suspensionReason" placeholder="Please provide detailed reason for this action..."></textarea>
                </div>
                
                <div class="form-group" id="durationGroup">
                    <label class="form-label">Suspension Duration</label>
                    <div class="form-row">
                        <div class="form-group">
                            <select class="form-select" id="suspensionDuration">
                                <option value="1">1 Day</option>
                                <option value="7">7 Days</option>
                                <option value="30">30 Days</option>
                                <option value="90">90 Days</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="customDurationGroup" style="display: none;">
                            <input type="number" class="form-control" id="customDuration" placeholder="Number of days" min="1" max="365">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Additional Actions</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="notifyUser" checked>
                        <label class="form-check-label" for="notifyUser">Notify user via email</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="restrictTransactions">
                        <label class="form-check-label" for="restrictTransactions">Restrict all transactions</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="freezeFunds">
                        <label class="form-check-label" for="freezeFunds">Freeze account funds</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('suspensionModal')">Cancel</button>
                <button class="btn btn-danger" onclick="processSuspension()">Confirm Action</button>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal-overlay" id="transactionDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Transaction Details</h3>
                <button class="modal-close" onclick="closeModal('transactionDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="transactionDetailsContent">
                <!-- Transaction details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('transactionDetailsModal')">Close</button>
                <button class="btn btn-danger" id="reverseTxBtn">Reverse Transaction</button>
                <button class="btn btn-success" id="approveTxBtn">Approve Transaction</button>
            </div>
        </div>
    </div>

    <!-- Dispute Details Modal -->
    <div class="modal-overlay" id="disputeDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Dispute Case Details</h3>
                <button class="modal-close" onclick="closeModal('disputeDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="disputeDetailsContent">
                <!-- Dispute details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('disputeDetailsModal')">Close</button>
                <button class="btn btn-primary" id="resolveDisputeBtn">Mark as Resolved</button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div class="modal-overlay" id="bulkActionsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Actions</h3>
                <button class="modal-close" onclick="closeModal('bulkActionsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Action</label>
                    <select class="form-select" id="bulkAction">
                        <option value="">Choose an action...</option>
                        <option value="approve">Approve Selected</option>
                        <option value="reject">Reject Selected</option>
                        <option value="suspend">Suspend Selected</option>
                        <option value="export">Export Selected</option>
                        <option value="delete">Delete Selected</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulkReasonGroup" style="display: none;">
                    <label class="form-label">Reason</label>
                    <textarea class="form-control form-textarea" id="bulkReason" placeholder="Reason for action..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Selected Items: <span id="selectedCount">0</span></label>
                    <div id="selectedItems" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bulkActionsModal')">Cancel</button>
                <button class="btn btn-primary" onclick="processBulkAction()">Execute Action</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Implementation -->
    <script>
        // ===== Firebase Configuration =====
        const firebaseConfig = {
            apiKey: "AIzaSyCWm9yvg5he7Lncy3h51n7ytOq7AZrA9gs",
            authDomain: "trucash-9fee8.firebaseapp.com",
            databaseURL: "https://trucash-9fee8-default-rtdb.firebaseio.com",
            projectId: "trucash-9fee8",
            storageBucket: "trucash-9fee8.firebasestorage.app",
            messagingSenderId: "622416212225",
            appId: "1:622416212225:web:07418a9b16f955c330ab00",
            measurementId: "G-6TEZFNFDBK"
        };

        // Initialize Firebase
        let firebaseApp, auth, db, storage;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showToast('Firebase Error', 'Failed to initialize database. Please refresh.', 'error');
        }

        // ===== Application State =====
        const AppState = {
            
            isAuthenticated: false,
            
            realTimeListeners: [],
            currentView: 'overview',
            applications: [],
            agents: [],
            customers: [],
            transactions: [],
            disputes: [],
            suspendedAccounts: [],
            bannedAccounts: [],
            notifications: [],
            stats: {
                totalUsers: 0,
                activeAgents: 0,
                pendingApps: 0,
                pendingTx: 0,
                suspendedCount: 0,
                bannedCount: 0
            },
            charts: {
                transactionChart: null,
                userDistributionChart: null
            },
            selectedApps: new Set(),
            selectedAgents: new Set(),
            selectedCustomers: new Set(),
            currentEditingAccount: null
        };

        // ===== Utility Functions =====
        const Utils = {
            formatDate: (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            
            formatDateShort: (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            },
            
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2
                }).format(amount || 0);
            },
            
            showToast: (title, message, type = 'info', duration = 5000) => {
                const toastContainer = document.querySelector('.toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto remove after duration
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideInRight 0.3s ease reverse';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
                
                // Close button
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                });
            },
            
            showLoading: (elementId) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'flex';
                }
            },
            
            hideLoading: (elementId) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            },
            
            showTable: (elementId) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'block';
                }
            },
            
            hideTable: (elementId) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            },
            
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            generateId: (prefix) => {
                return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2, 3).toUpperCase();
            },
            
            generatePassword: (length = 12) => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let password = '';
                for (let i = 0; i < length; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return password;
            },
            
            generateAgentId: () => {
                const prefix = 'AG';
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.random().toString(36).substr(2, 3).toUpperCase();
                return prefix + timestamp + random;
            },
            
            validateEmail: (email) => {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePhone: (phone) => {
                const re = /^\+?[\d\s\-\(\)]{10,}$/;
                return re.test(phone);
            },
            
            calculatePasswordStrength: (password) => {
                let strength = 0;
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                return strength;
            },
            
            exportToCSV: (data, filename) => {
                if (!data || data.length === 0) {
                    Utils.showToast('Error', 'No data to export', 'error');
                    return;
                }
                
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => headers.map(header => {
                        const cell = row[header] === null || row[header] === undefined ? '' : row[header];
                        return typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell;
                    }).join(','))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}_${Date.now()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Utils.showToast('Success', `Data exported to ${filename}.csv`, 'success');
            }
        };

        // ===== Firebase Service =====
       
            // Real-time Listeners
            setupRealTimeListeners() {
                // Listen for applications
                const appsRef = db.ref('agentApplications');
                appsRef.on('value', (snapshot) => {
                    this.handleApplicationsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(appsRef);
                
                // Listen for agents
                const agentsRef = db.ref('agents');
                agentsRef.on('value', (snapshot) => {
                    this.handleAgentsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(agentsRef);
                
                // Listen for users (customers)
                const usersRef = db.ref('users');
                usersRef.on('value', (snapshot) => {
                    this.handleUsersUpdate(snapshot);
                });
                AppState.realTimeListeners.push(usersRef);
                
                // Listen for transactions
                const transactionsRef = db.ref('transactions');
                transactionsRef.on('value', (snapshot) => {
                    this.handleTransactionsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(transactionsRef);
                
                // Listen for disputes
                const disputesRef = db.ref('disputes');
                disputesRef.on('value', (snapshot) => {
                    this.handleDisputesUpdate(snapshot);
                });
                AppState.realTimeListeners.push(disputesRef);
                
                // Listen for notifications
                const notificationsRef = db.ref('adminNotifications');
                notificationsRef.on('value', (snapshot) => {
                    this.handleNotificationsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(notificationsRef);
                
                // Listen for suspended accounts
                const suspendedRef = db.ref('suspendedAccounts');
                suspendedRef.on('value', (snapshot) => {
                    this.handleSuspendedAccountsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(suspendedRef);
                
                // Listen for banned accounts
                const bannedRef = db.ref('bannedAccounts');
                bannedRef.on('value', (snapshot) => {
                    this.handleBannedAccountsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(bannedRef);
                
                // Listen for system stats
                const statsRef = db.ref('systemStats');
                statsRef.on('value', (snapshot) => {
                    this.handleStatsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(statsRef);
                
                // Listen for audit logs
                const auditRef = db.ref('auditLogs');
                auditRef.on('value', (snapshot) => {
                    this.handleAuditLogsUpdate(snapshot);
                });
                AppState.realTimeListeners.push(auditRef);
            },
            
            // Data Handlers
            handleApplicationsUpdate(snapshot) {
                AppState.applications = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const app = child.val();
                        if (app.status === 'pending' || app.status === 'under_review') {
                            AppState.applications.push({
                                id: child.key,
                                ...app
                            });
                        }
                    });
                }
                updateApplicationsUI();
                updateDashboardStats();
                updatePendingAppsSelect();
            },
            
            handleAgentsUpdate(snapshot) {
                AppState.agents = [];
                let activeCount = 0;
                let suspendedCount = 0;
                let bannedCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const agent = {
                            id: child.key,
                            ...child.val()
                        };
                        AppState.agents.push(agent);
                        
                        if (agent.status === 'active') activeCount++;
                        else if (agent.status === 'suspended') suspendedCount++;
                        else if (agent.status === 'banned') bannedCount++;
                    });
                }
                
                updateAgentsUI();
                updateDashboardStats();
                
                // Update counters in UI
                document.getElementById('totalAgents').textContent = AppState.agents.length;
                document.getElementById('activeAgents').textContent = activeCount;
            },
            
            handleUsersUpdate(snapshot) {
                AppState.customers = [];
                let customerCount = 0;
                let verifiedCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const user = child.val();
                        if (user.userType === 'customer') {
                            AppState.customers.push({
                                id: child.key,
                                ...user
                            });
                            customerCount++;
                            if (user.verificationStatus === 'verified') verifiedCount++;
                        }
                    });
                }
                
                updateCustomersUI();
                updateDashboardStats();
                
                // Update counters in UI
                document.getElementById('totalCustomers').textContent = customerCount;
            },
            
            handleTransactionsUpdate(snapshot) {
                AppState.transactions = [];
                let pendingCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const tx = {
                            id: child.key,
                            ...child.val()
                        };
                        AppState.transactions.push(tx);
                        if (tx.status === 'pending') pendingCount++;
                    });
                }
                
                updateTransactionsUI();
                updateDashboardStats();
                
                // Update badge
                document.getElementById('pendingTxCount').textContent = pendingCount;
            },
            
            handleDisputesUpdate(snapshot) {
                AppState.disputes = [];
                let openCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const dispute = {
                            id: child.key,
                            ...child.val()
                        };
                        AppState.disputes.push(dispute);
                        if (dispute.status === 'open' || dispute.status === 'investigating') openCount++;
                    });
                }
                
                updateDisputesUI();
                updateDashboardStats();
                
                document.getElementById('disputeCount').textContent = openCount;
            },
            
            handleSuspendedAccountsUpdate(snapshot) {
                AppState.suspendedAccounts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        AppState.suspendedAccounts.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                updateSuspendedAccountsUI();
                updateDashboardStats();
            },
            
            handleBannedAccountsUpdate(snapshot) {
                AppState.bannedAccounts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        AppState.bannedAccounts.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                updateBannedAccountsUI();
                updateDashboardStats();
            },
            
            handleNotificationsUpdate(snapshot) {
                AppState.notifications = [];
                let unreadCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const notification = {
                            id: child.key,
                            ...child.val()
                        };
                        AppState.notifications.push(notification);
                        if (!notification.read) unreadCount++;
                    });
                }
                
                updateNotificationsUI();
                updateDashboardStats();
                
                document.getElementById('notificationCount').textContent = unreadCount;
            },
            
            handleStatsUpdate(snapshot) {
                if (snapshot.exists()) {
                    AppState.stats = snapshot.val();
                    updateDashboardStats();
                }
            },
            
            handleAuditLogsUpdate(snapshot) {
                updateRecentActivity();
            },
            
            // Application Management
            async getApplicationDetails(appId) {
                try {
                    const appRef = db.ref('agentApplications/' + appId);
                    const snapshot = await appRef.once('value');
                    if (snapshot.exists()) {
                        return { success: true, data: snapshot.val() };
                    } else {
                        return { success: false, error: 'Application not found' };
                    }
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async approveApplicationWithCredentials(appId, credentials, commissionRate = 5) {
                try {
                    // Get application details first
                    const appResult = await this.getApplicationDetails(appId);
                    if (!appResult.success) {
                        throw new Error(appResult.error);
                    }
                    
                    const application = appResult.data;
                    
                    // Validate credentials
                    if (!Utils.validateEmail(credentials.email)) {
                        throw new Error('Invalid email address');
                    }
                    
                    if (credentials.password.length < 8) {
                        throw new Error('Password must be at least 8 characters');
                    }
                    
                    if (!credentials.agentId || credentials.agentId.trim() === '') {
                        throw new Error('Agent ID is required');
                    }
                    
                    // Check if email already exists
                    try {
                        await auth.getUserByEmail(credentials.email);
                        throw new Error('Email already exists');
                    } catch (error) {
                        // Email doesn't exist, proceed
                    }
                    
                    // Create user account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        credentials.email,
                        credentials.password
                    );
                    
                    // Prepare agent data
                    const agentData = {
                        uid: userCredential.user.uid,
                        fullName: application.fullName,
                        email: credentials.email,
                        phone: application.phone,
                        residence: application.residence,
                        nrc: application.nrc,
                        nrcFront: application.nrcFront,
                        nrcBack: application.nrcBack,
                        profilePhoto: application.profilePhoto,
                        additionalDoc: application.additionalDoc || '',
                        userType: 'agent',
                        agentId: credentials.agentId,
                        status: 'active',
                        applicationId: appId,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        lastLogin: null,
                        emailVerified: false,
                        totalClients: 0,
                        totalLoans: 0,
                        commissionEarned: 0,
                        commissionRate: parseFloat(commissionRate),
                        performance: {
                            successRate: 0,
                            completionRate: 0,
                            avgProcessingTime: 0,
                            rating: 0,
                            totalTransactions: 0
                        },
                        settings: {
                            notifications: true,
                            twoFactorAuth: false,
                            autoApprove: false
                        },
                        assignedBy: AppState.currentUser.email,
                        assignedAt: Date.now()
                    };
                    
                    // Update application status
                    const appRef = db.ref('agentApplications/' + appId);
                    await appRef.update({
                        status: 'approved',
                        reviewedAt: Date.now(),
                        reviewedBy: AppState.currentUser.email,
                        approvedBy: AppState.currentUser.email,
                        assignedCredentials: {
                            email: credentials.email,
                            agentId: credentials.agentId
                        }
                    });
                    
                    // Save agent to database
                    const userRef = db.ref('users/' + userCredential.user.uid);
                    await userRef.set(agentData);
                    
                    // Add to agents list
                    const agentsRef = db.ref('agents/' + userCredential.user.uid);
                    await agentsRef.set(agentData);
                    
                    // Add to users list
                    const usersListRef = db.ref('usersList/' + userCredential.user.uid);
                    await usersListRef.set({
                        email: credentials.email,
                        fullName: application.fullName,
                        userType: 'agent',
                        status: 'active',
                        agentId: credentials.agentId,
                        createdAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'APPROVE_APPLICATION',
                        targetId: appId,
                        targetType: 'agent_application',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            applicationId: appId,
                            applicantName: application.fullName,
                            assignedEmail: credentials.email,
                            assignedAgentId: credentials.agentId,
                            commissionRate: commissionRate
                        },
                        timestamp: Date.now(),
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'application_approved',
                        title: 'Application Approved',
                        message: `Agent application ${appId} has been approved and account created`,
                        recipient: 'admin',
                        data: {
                            appId: appId,
                            applicantName: application.fullName,
                            agentEmail: credentials.email
                        },
                        timestamp: Date.now(),
                        read: false
                    });
                    
                    // Send welcome email if enabled
                    if (document.getElementById('sendCredentialsEmail')?.checked) {
                        await this.sendWelcomeEmail(credentials.email, credentials.agentId, credentials.password);
                    }
                    
                    return { 
                        success: true, 
                        data: {
                            email: credentials.email,
                            agentId: credentials.agentId,
                            password: credentials.password
                        }
                    };
                } catch (error) {
                    console.error('Error approving application:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async rejectApplication(appId, reason) {
                try {
                    // Get application details
                    const appResult = await this.getApplicationDetails(appId);
                    if (!appResult.success) {
                        throw new Error(appResult.error);
                    }
                    
                    const application = appResult.data;
                    
                    // Update application status
                    const appRef = db.ref('agentApplications/' + appId);
                    await appRef.update({
                        status: 'rejected',
                        reviewedAt: Date.now(),
                        reviewedBy: AppState.currentUser.email,
                        rejectionReason: reason,
                        rejectedBy: AppState.currentUser.email
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'REJECT_APPLICATION',
                        targetId: appId,
                        targetType: 'agent_application',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            applicationId: appId,
                            applicantName: application.fullName,
                            rejectionReason: reason
                        },
                        timestamp: Date.now(),
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'application_rejected',
                        title: 'Application Rejected',
                        message: `Agent application ${appId} has been rejected`,
                        recipient: 'admin',
                        data: {
                            appId: appId,
                            applicantName: application.fullName,
                            reason: reason
                        },
                        timestamp: Date.now(),
                        read: false
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error rejecting application:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // Agent Management
            async createAgentAccount(agentData) {
                try {
                    // Validate data
                    if (!Utils.validateEmail(agentData.email)) {
                        throw new Error('Invalid email address');
                    }
                    
                    if (!Utils.validatePhone(agentData.phone)) {
                        throw new Error('Invalid phone number');
                    }
                    
                    if (agentData.password.length < 8) {
                        throw new Error('Password must be at least 8 characters');
                    }
                    
                    if (!agentData.agentId || agentData.agentId.trim() === '') {
                        throw new Error('Agent ID is required');
                    }
                    
                    // Check if email already exists
                    try {
                        await auth.getUserByEmail(agentData.email);
                        throw new Error('Email already exists');
                    } catch (error) {
                        // Email doesn't exist, proceed
                    }
                    
                    // Create user account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        agentData.email,
                        agentData.password
                    );
                    
                    // Prepare agent data for database
                    const dbAgentData = {
                        uid: userCredential.user.uid,
                        fullName: agentData.fullName,
                        email: agentData.email,
                        phone: agentData.phone,
                        userType: 'agent',
                        agentId: agentData.agentId,
                        status: agentData.status || 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        lastLogin: null,
                        emailVerified: false,
                        totalClients: 0,
                        totalLoans: 0,
                        commissionEarned: 0,
                        commissionRate: parseFloat(agentData.commissionRate) || 5,
                        performance: {
                            successRate: 0,
                            completionRate: 0,
                            avgProcessingTime: 0,
                            rating: 0,
                            totalTransactions: 0
                        },
                        settings: {
                            notifications: true,
                            twoFactorAuth: false,
                            autoApprove: false
                        },
                        createdBy: AppState.currentUser.email,
                        createdByAdmin: true
                    };
                    
                    // Save agent to database
                    const userRef = db.ref('users/' + userCredential.user.uid);
                    await userRef.set(dbAgentData);
                    
                    // Add to agents list
                    const agentsRef = db.ref('agents/' + userCredential.user.uid);
                    await agentsRef.set(dbAgentData);
                    
                    // Add to users list
                    const usersListRef = db.ref('usersList/' + userCredential.user.uid);
                    await usersListRef.set({
                        email: agentData.email,
                        fullName: agentData.fullName,
                        userType: 'agent',
                        status: agentData.status || 'active',
                        agentId: agentData.agentId,
                        createdAt: Date.now()
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'CREATE_AGENT',
                        targetId: userCredential.user.uid,
                        targetType: 'agent',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            agentId: agentData.agentId,
                            agentName: agentData.fullName,
                            agentEmail: agentData.email,
                            status: agentData.status || 'active',
                            commissionRate: agentData.commissionRate || 5
                        },
                        timestamp: Date.now(),
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'agent_created',
                        title: 'Agent Account Created',
                        message: `New agent account created: ${agentData.agentId}`,
                        recipient: 'admin',
                        data: {
                            agentId: agentData.agentId,
                            agentName: agentData.fullName,
                            agentEmail: agentData.email
                        },
                        timestamp: Date.now(),
                        read: false
                    });
                    
                    return { 
                        success: true, 
                        data: {
                            uid: userCredential.user.uid,
                            email: agentData.email,
                            agentId: agentData.agentId
                        }
                    };
                } catch (error) {
                    console.error('Error creating agent account:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async suspendAccount(accountId, accountType, reason, duration = 7, additionalActions = {}) {
                try {
                    const timestamp = Date.now();
                    const suspensionData = {
                        accountId: accountId,
                        accountType: accountType,
                        reason: reason,
                        suspendedAt: timestamp,
                        suspendedBy: AppState.currentUser.email,
                        suspendedById: AppState.currentUser.uid,
                        duration: duration,
                        expiresAt: timestamp + (duration * 24 * 60 * 60 * 1000),
                        additionalActions: additionalActions,
                        status: 'suspended'
                    };
                    
                    // Save to suspended accounts
                    const suspensionRef = db.ref('suspendedAccounts/' + accountId);
                    await suspensionRef.set(suspensionData);
                    
                    // Update account status
                    const accountRef = db.ref('users/' + accountId);
                    await accountRef.update({
                        status: 'suspended',
                        suspensionReason: reason,
                        suspendedAt: timestamp,
                        suspendedBy: AppState.currentUser.email,
                        suspensionExpires: timestamp + (duration * 24 * 60 * 60 * 1000)
                    });
                    
                    // Update in agents/customers list if applicable
                    if (accountType === 'agent') {
                        const agentRef = db.ref('agents/' + accountId);
                        await agentRef.update({
                            status: 'suspended',
                            suspensionReason: reason,
                            suspendedAt: timestamp
                        });
                    }
                    
                    // Update users list
                    const usersListRef = db.ref('usersList/' + accountId);
                    await usersListRef.update({
                        status: 'suspended'
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'SUSPEND_ACCOUNT',
                        targetId: accountId,
                        targetType: accountType,
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            accountId: accountId,
                            accountType: accountType,
                            reason: reason,
                            duration: duration,
                            additionalActions: additionalActions
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'account_suspended',
                        title: 'Account Suspended',
                        message: `${accountType} account ${accountId} has been suspended`,
                        recipient: 'admin',
                        data: {
                            accountId: accountId,
                            accountType: accountType,
                            reason: reason,
                            duration: duration
                        },
                        timestamp: timestamp,
                        read: false
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error suspending account:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async banAccount(accountId, accountType, reason, additionalActions = {}) {
                try {
                    const timestamp = Date.now();
                    const banData = {
                        accountId: accountId,
                        accountType: accountType,
                        reason: reason,
                        bannedAt: timestamp,
                        bannedBy: AppState.currentUser.email,
                        bannedById: AppState.currentUser.uid,
                        additionalActions: additionalActions,
                        status: 'banned'
                    };
                    
                    // Save to banned accounts
                    const banRef = db.ref('bannedAccounts/' + accountId);
                    await banRef.set(banData);
                    
                    // Update account status
                    const accountRef = db.ref('users/' + accountId);
                    await accountRef.update({
                        status: 'banned',
                        banReason: reason,
                        bannedAt: timestamp,
                        bannedBy: AppState.currentUser.email
                    });
                    
                    // Update in agents/customers list if applicable
                    if (accountType === 'agent') {
                        const agentRef = db.ref('agents/' + accountId);
                        await agentRef.update({
                            status: 'banned',
                            banReason: reason,
                            bannedAt: timestamp
                        });
                    }
                    
                    // Update users list
                    const usersListRef = db.ref('usersList/' + accountId);
                    await usersListRef.update({
                        status: 'banned'
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'BAN_ACCOUNT',
                        targetId: accountId,
                        targetType: accountType,
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            accountId: accountId,
                            accountType: accountType,
                            reason: reason,
                            additionalActions: additionalActions
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'account_banned',
                        title: 'Account Banned',
                        message: `${accountType} account ${accountId} has been permanently banned`,
                        recipient: 'admin',
                        data: {
                            accountId: accountId,
                            accountType: accountType,
                            reason: reason
                        },
                        timestamp: timestamp,
                        read: false
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error banning account:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async activateAccount(accountId, accountType) {
                try {
                    const timestamp = Date.now();
                    
                    // Remove from suspended/banned
                    const suspendedRef = db.ref('suspendedAccounts/' + accountId);
                    await suspendedRef.remove();
                    
                    const bannedRef = db.ref('bannedAccounts/' + accountId);
                    await bannedRef.remove();
                    
                    // Update account status
                    const accountRef = db.ref('users/' + accountId);
                    await accountRef.update({
                        status: 'active',
                        suspensionReason: null,
                        suspendedAt: null,
                        suspendedBy: null,
                        suspensionExpires: null,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        updatedAt: timestamp
                    });
                    
                    // Update in agents/customers list if applicable
                    if (accountType === 'agent') {
                        const agentRef = db.ref('agents/' + accountId);
                        await agentRef.update({
                            status: 'active',
                            suspensionReason: null,
                            suspendedAt: null,
                            banReason: null,
                            bannedAt: null
                        });
                    }
                    
                    // Update users list
                    const usersListRef = db.ref('usersList/' + accountId);
                    await usersListRef.update({
                        status: 'active'
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'ACTIVATE_ACCOUNT',
                        targetId: accountId,
                        targetType: accountType,
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            accountId: accountId,
                            accountType: accountType
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'account_activated',
                        title: 'Account Activated',
                        message: `${accountType} account ${accountId} has been activated`,
                        recipient: 'admin',
                        data: {
                            accountId: accountId,
                            accountType: accountType
                        },
                        timestamp: timestamp,
                        read: false
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error activating account:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async getAgentDetails(agentId) {
                try {
                    const agentRef = db.ref('agents/' + agentId);
                    const snapshot = await agentRef.once('value');
                    if (snapshot.exists()) {
                        return { success: true, data: snapshot.val() };
                    } else {
                        return { success: false, error: 'Agent not found' };
                    }
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getCustomerDetails(customerId) {
                try {
                    const customerRef = db.ref('users/' + customerId);
                    const snapshot = await customerRef.once('value');
                    if (snapshot.exists() && snapshot.val().userType === 'customer') {
                        return { success: true, data: snapshot.val() };
                    } else {
                        return { success: false, error: 'Customer not found' };
                    }
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Transaction Management
            async approveTransaction(txId, notes = '') {
                try {
                    const txRef = db.ref('transactions/' + txId);
                    const timestamp = Date.now();
                    
                    await txRef.update({
                        status: 'completed',
                        reviewedAt: timestamp,
                        reviewedBy: AppState.currentUser.email,
                        adminNotes: notes,
                        completedAt: timestamp
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'APPROVE_TRANSACTION',
                        targetId: txId,
                        targetType: 'transaction',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            transactionId: txId,
                            notes: notes
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async rejectTransaction(txId, reason) {
                try {
                    const txRef = db.ref('transactions/' + txId);
                    const timestamp = Date.now();
                    
                    await txRef.update({
                        status: 'rejected',
                        reviewedAt: timestamp,
                        reviewedBy: AppState.currentUser.email,
                        rejectionReason: reason,
                        rejectedAt: timestamp
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'REJECT_TRANSACTION',
                        targetId: txId,
                        targetType: 'transaction',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            transactionId: txId,
                            reason: reason
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async reverseTransaction(txId, reason) {
                try {
                    const txRef = db.ref('transactions/' + txId);
                    const timestamp = Date.now();
                    
                    await txRef.update({
                        status: 'reversed',
                        reversedAt: timestamp,
                        reversedBy: AppState.currentUser.email,
                        reversalReason: reason,
                        reviewedAt: timestamp
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'REVERSE_TRANSACTION',
                        targetId: txId,
                        targetType: 'transaction',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            transactionId: txId,
                            reason: reason
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Dispute Management
            async resolveDispute(disputeId, resolution, notes = '') {
                try {
                    const disputeRef = db.ref('disputes/' + disputeId);
                    const timestamp = Date.now();
                    
                    await disputeRef.update({
                        status: 'resolved',
                        resolvedAt: timestamp,
                        resolvedBy: AppState.currentUser.email,
                        resolution: resolution,
                        resolutionNotes: notes
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'RESOLVE_DISPUTE',
                        targetId: disputeId,
                        targetType: 'dispute',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            disputeId: disputeId,
                            resolution: resolution,
                            notes: notes
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Settings Management
            async loadSettings() {
                try {
                    const settingsRef = db.ref('systemSettings');
                    const snapshot = await settingsRef.once('value');
                    if (snapshot.exists()) {
                        return { success: true, settings: snapshot.val() };
                    } else {
                        // Create default settings
                        const defaultSettings = {
                            transactionLimits: {
                                min: 10,
                                max: 10000
                            },
                            commissionRates: {
                                standard: 5,
                                premium: 7.5
                            },
                            fees: {
                                transaction: 1.5,
                                minFee: 0.50
                            },
                            penaltySettings: {
                                latePayment: 2,
                                gracePeriod: 7
                            },
                            notifications: {
                                email: {
                                    applications: true,
                                    transactions: true,
                                    disputes: true,
                                    suspensions: true
                                },
                                sms: {
                                    critical: true,
                                    security: false
                                },
                                thresholds: {
                                    largeTransaction: 1000,
                                    dailyReportTime: "08:00"
                                }
                            },
                            security: {
                                twoFactorAuth: true,
                                loginNotifications: true,
                                sessionTimeout: 30,
                                maxLoginAttempts: 5,
                                passwordPolicy: {
                                    minLength: 8,
                                    requireSpecialChars: true,
                                    passwordExpiry: 90,
                                    passwordHistory: 5
                                },
                                ipWhitelist: ""
                            },
                            maintenance: {
                                enabled: false,
                                message: ""
                            },
                            api: {
                                cloudinary: {
                                    cloudName: "",
                                    uploadPreset: ""
                                },
                                paymentGateway: {
                                    provider: "stripe",
                                    apiKey: "",
                                    secret: "",
                                    webhookSecret: ""
                                },
                                smsGateway: {
                                    provider: "twilio",
                                    accountSid: "",
                                    authToken: "",
                                    fromNumber: ""
                                }
                            }
                        };
                        
                        await settingsRef.set(defaultSettings);
                        return { success: true, settings: defaultSettings };
                    }
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async saveSettings(settings) {
                try {
                    const settingsRef = db.ref('systemSettings');
                    await settingsRef.set(settings);
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'UPDATE_SETTINGS',
                        targetId: 'system_settings',
                        targetType: 'settings',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: settings,
                        timestamp: Date.now(),
                        ipAddress: 'N/A'
                    });
                    
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Audit Logs
            async createAuditLog(logData) {
                try {
                    const logId = Utils.generateId('AUDIT_');
                    const logRef = db.ref('auditLogs/' + logId);
                    await logRef.set(logData);
                    
                    // Also add to recent activity
                    const activityRef = db.ref('recentActivity/' + logId);
                    await activityRef.set({
                        ...logData,
                        id: logId
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error creating audit log:', error);
                    return { success: false };
                }
            },
            
            async getAuditLogs(limit = 50) {
                try {
                    const auditRef = db.ref('auditLogs');
                    const snapshot = await auditRef.limitToLast(limit).once('value');
                    const logs = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((child) => {
                            logs.push({
                                id: child.key,
                                ...child.val()
                            });
                        });
                    }
                    
                    return { success: true, logs: logs.reverse() };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Notifications
            async createNotification(notificationData) {
                try {
                    const notificationId = Utils.generateId('NOTIF_');
                    const notificationRef = db.ref('adminNotifications/' + notificationId);
                    await notificationRef.set(notificationData);
                    return { success: true };
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return { success: false };
                }
            },
            
            async markNotificationRead(notificationId) {
                try {
                    const notificationRef = db.ref('adminNotifications/' + notificationId);
                    await notificationRef.update({ read: true });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async markAllNotificationsRead() {
                try {
                    const updates = {};
                    AppState.notifications.forEach(notification => {
                        if (!notification.read) {
                            updates[`${notification.id}/read`] = true;
                        }
                    });
                    
                    if (Object.keys(updates).length > 0) {
                        await db.ref('adminNotifications').update(updates);
                    }
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Email Service (Simulated)
            async sendWelcomeEmail(email, agentId, password) {
                // In production, integrate with email service
                console.log(`Welcome email sent to ${email} with agent ID: ${agentId}`);
                return { success: true };
            },
            
            // Customer Management
            async createCustomerAccount(customerData) {
                try {
                    // Validate data
                    if (!Utils.validateEmail(customerData.email)) {
                        throw new Error('Invalid email address');
                    }
                    
                    if (!Utils.validatePhone(customerData.phone)) {
                        throw new Error('Invalid phone number');
                    }
                    
                    if (customerData.password.length < 8) {
                        throw new Error('Password must be at least 8 characters');
                    }
                    
                    // Check if email already exists
                    try {
                        await auth.getUserByEmail(customerData.email);
                        throw new Error('Email already exists');
                    } catch (error) {
                        // Email doesn't exist, proceed
                    }
                    
                    // Create user account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        customerData.email,
                        customerData.password
                    );
                    
                    // Prepare customer data for database
                    const dbCustomerData = {
                        uid: userCredential.user.uid,
                        fullName: customerData.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        userType: 'customer',
                        status: customerData.status || 'active',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        lastLogin: null,
                        emailVerified: false,
                        accountBalance: parseFloat(customerData.balance) || 0,
                        loanCount: 0,
                        totalBorrowed: 0,
                        totalRepaid: 0,
                        outstandingBalance: 0,
                        verificationStatus: customerData.verification || 'unverified',
                        kycStatus: 'pending',
                        settings: {
                            notifications: true,
                            twoFactorAuth: false
                        },
                        createdBy: AppState.currentUser.email,
                        createdByAdmin: true
                    };
                    
                    // Save customer to database
                    const userRef = db.ref('users/' + userCredential.user.uid);
                    await userRef.set(dbCustomerData);
                    
                    // Add to users list
                    const usersListRef = db.ref('usersList/' + userCredential.user.uid);
                    await usersListRef.set({
                        email: customerData.email,
                        fullName: customerData.fullName,
                        userType: 'customer',
                        status: customerData.status || 'active',
                        createdAt: Date.now(),
                        verificationStatus: customerData.verification || 'unverified'
                    });
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: 'CREATE_CUSTOMER',
                        targetId: userCredential.user.uid,
                        targetType: 'customer',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            customerName: customerData.fullName,
                            customerEmail: customerData.email,
                            initialBalance: customerData.balance || 0,
                            status: customerData.status || 'active',
                            verification: customerData.verification || 'unverified'
                        },
                        timestamp: Date.now(),
                        ipAddress: 'N/A'
                    });
                    
                    // Create notification
                    await this.createNotification({
                        type: 'customer_created',
                        title: 'Customer Account Created',
                        message: `New customer account created: ${customerData.email}`,
                        recipient: 'admin',
                        data: {
                            customerName: customerData.fullName,
                            customerEmail: customerData.email
                        },
                        timestamp: Date.now(),
                        read: false
                    });
                    
                    return { 
                        success: true, 
                        data: {
                            uid: userCredential.user.uid,
                            email: customerData.email
                        }
                    };
                } catch (error) {
                    console.error('Error creating customer account:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // Bulk Operations
            async bulkUpdateApplications(appIds, action, reason = '') {
                try {
                    const updates = {};
                    const timestamp = Date.now();
                    
                    appIds.forEach(appId => {
                        updates[`agentApplications/${appId}/status`] = action === 'approve' ? 'approved' : 'rejected';
                        updates[`agentApplications/${appId}/reviewedAt`] = timestamp;
                        updates[`agentApplications/${appId}/reviewedBy`] = AppState.currentUser.email;
                        
                        if (action === 'reject') {
                            updates[`agentApplications/${appId}/rejectionReason`] = reason;
                        }
                    });
                    
                    await db.ref().update(updates);
                    
                    // Create audit log
                    await this.createAuditLog({
                        action: `BULK_${action.toUpperCase()}_APPLICATIONS`,
                        targetId: 'multiple',
                        targetType: 'agent_application',
                        performedBy: AppState.currentUser.uid,
                        performedByEmail: AppState.currentUser.email,
                        details: {
                            applicationIds: appIds,
                            action: action,
                            reason: reason,
                            count: appIds.length
                        },
                        timestamp: timestamp,
                        ipAddress: 'N/A'
                    });
                    
                    return { success: true, count: appIds.length };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // Statistics
            async updateStatistics() {
                try {
                    const stats = {
                        totalUsers: AppState.customers.length + AppState.agents.length,
                        activeAgents: AppState.agents.filter(a => a.status === 'active').length,
                        pendingApps: AppState.applications.length,
                        pendingTx: AppState.transactions.filter(t => t.status === 'pending').length,
                        suspendedCount: AppState.suspendedAccounts.length,
                        bannedCount: AppState.bannedAccounts.length,
                        updatedAt: Date.now()
                    };
                    
                    const statsRef = db.ref('systemStats');
                    await statsRef.set(stats);
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error updating statistics:', error);
                    return { success: false };
                }
            },
            
            // UI Updates
            updateAdminUI() {
                if (AppState.adminData) {
                    const adminName = document.getElementById('adminName');
                    const adminEmail = document.getElementById('adminEmail');
                    const adminAvatar = document.getElementById('adminAvatar');
                    
                    if (adminName) adminName.textContent = AppState.adminData.fullName || 'Admin';
                    if (adminEmail) adminEmail.textContent = AppState.currentUser?.email || '';
                    if (adminAvatar) {
                        const initials = AppState.adminData.fullName
                            ? AppState.adminData.fullName.split(' ').map(n => n[0]).join('').toUpperCase()
                            : 'A';
                        adminAvatar.textContent = initials;
                    }
                }
            },
            
            // Cleanup
            cleanupListeners() {
                AppState.realTimeListeners.forEach(ref => ref.off());
                AppState.realTimeListeners = [];
            }
        };

        // ===== UI Update Functions =====
        function updateDashboardStats() {
            // Update stats cards
            document.getElementById('totalUsers').textContent = AppState.stats.totalUsers || 0;
            document.getElementById('activeAgents').textContent = AppState.stats.activeAgents || 0;
            document.getElementById('pendingApps').textContent = AppState.stats.pendingApps || 0;
            document.getElementById('pendingTx').textContent = AppState.stats.pendingTx || 0;
            
            // Update badge counts
            document.getElementById('applicationCount').textContent = AppState.stats.pendingApps || 0;
            document.getElementById('pendingTxCount').textContent = AppState.stats.pendingTx || 0;
            document.getElementById('disputeCount').textContent = AppState.stats.openDisputes || 0;
            document.getElementById('suspendedCount').textContent = AppState.stats.suspendedCount || 0;
            document.getElementById('bannedCount').textContent = AppState.stats.bannedCount || 0;
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = 'Just now';
            
            // Update statistics in Firebase
            FirebaseService.updateStatistics();
        }
        
        function updateApplicationsUI() {
            const container = document.getElementById('applicationsBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.applications.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No pending applications</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('appsLoading');
                Utils.showTable('applicationsTable');
                return;
            }
            
            AppState.applications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="width: 50px;">
                        <input type="checkbox" class="app-checkbox" data-app-id="${app.id}" onchange="toggleAppSelection('${app.id}', this.checked)">
                    </td>
                    <td>${app.id.substring(0, 8)}...</td>
                    <td>${app.fullName || 'N/A'}</td>
                    <td>${app.phone || 'N/A'}</td>
                    <td>${app.nrc || 'N/A'}</td>
                    <td>${Utils.formatDateShort(app.submittedAt)}</td>
                    <td><span class="status-badge status-${app.status || 'pending'}">${app.status || 'pending'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewApplication('${app.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-approve" onclick="approveApplicationModal('${app.id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon btn-reject" onclick="rejectApplicationPrompt('${app.id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            // Hide loading, show table
            Utils.hideLoading('appsLoading');
            Utils.showTable('applicationsTable');
        }
        
        function updateAgentsUI() {
            const container = document.getElementById('agentsBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.agents.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="9" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No agents found</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('agentsLoading');
                Utils.showTable('agentsTable');
                return;
            }
            
            AppState.agents.forEach(agent => {
                const statusClass = agent.status === 'active' ? 'status-active' : 
                                  agent.status === 'suspended' ? 'status-suspended' : 
                                  agent.status === 'banned' ? 'status-banned' : 'status-pending';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agent.agentId || agent.id.substring(0, 8)}...</td>
                    <td>${agent.fullName || 'N/A'}</td>
                    <td>${agent.email || 'N/A'}</td>
                    <td>${agent.phone || 'N/A'}</td>
                    <td>${agent.totalClients || 0}</td>
                    <td>${agent.totalLoans || 0}</td>
                    <td>${agent.commissionRate || 5}%</td>
                    <td><span class="status-badge ${statusClass}">${agent.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewAgent('${agent.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-edit" onclick="editAgent('${agent.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon ${agent.status === 'suspended' || agent.status === 'banned' ? 'btn-success' : 'btn-warning'}" 
                                    onclick="toggleAgentStatus('${agent.id}', '${agent.status}')"
                                    title="${agent.status === 'active' ? 'Suspend' : agent.status === 'suspended' ? 'Activate' : 'Unban'}">
                                <i class="fas fa-${agent.status === 'active' ? 'ban' : 'check'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            Utils.hideLoading('agentsLoading');
            Utils.showTable('agentsTable');
        }
        
        function updateCustomersUI() {
            const container = document.getElementById('customersBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.customers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="9" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-user-friends"></i>
                            <p>No customers found</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('customersLoading');
                Utils.showTable('customersTable');
                return;
            }
            
            AppState.customers.forEach(customer => {
                const statusClass = customer.status === 'active' ? 'status-active' : 
                                   customer.status === 'suspended' ? 'status-suspended' : 
                                   customer.status === 'banned' ? 'status-banned' : 'status-pending';
                
                const verificationClass = customer.verificationStatus === 'verified' ? 'status-approved' : 
                                        customer.verificationStatus === 'pending' ? 'status-pending' : 'status-rejected';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id.substring(0, 8)}...</td>
                    <td>${customer.fullName || 'N/A'}</td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.phone || 'N/A'}</td>
                    <td>${customer.loanCount || 0}</td>
                    <td>${Utils.formatCurrency(customer.accountBalance || 0)}</td>
                    <td><span class="status-badge ${statusClass}">${customer.status || 'active'}</span></td>
                    <td><span class="status-badge ${verificationClass}">${customer.verificationStatus || 'unverified'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewCustomer('${customer.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-edit" onclick="editCustomer('${customer.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon ${customer.status === 'suspended' || customer.status === 'banned' ? 'btn-success' : 'btn-warning'}" 
                                    onclick="toggleCustomerStatus('${customer.id}', '${customer.status}')"
                                    title="${customer.status === 'active' ? 'Suspend' : customer.status === 'suspended' ? 'Activate' : 'Unban'}">
                                <i class="fas fa-${customer.status === 'active' ? 'ban' : 'check'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            Utils.hideLoading('customersLoading');
            Utils.showTable('customersTable');
        }
        
        function updateSuspendedAccountsUI() {
            const container = document.getElementById('suspendedBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.suspendedAccounts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-ban"></i>
                            <p>No suspended accounts</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('suspendedLoading');
                Utils.showTable('suspendedTable');
                return;
            }
            
            AppState.suspendedAccounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.accountId.substring(0, 8)}...</td>
                    <td>${account.accountName || 'N/A'}</td>
                    <td>${account.accountEmail || 'N/A'}</td>
                    <td><span class="status-badge">${account.accountType}</span></td>
                    <td>${Utils.formatDateShort(account.suspendedAt)}</td>
                    <td>${account.reason || 'No reason provided'}</td>
                    <td>${account.suspendedBy || 'System'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-success" onclick="activateSuspendedAccount('${account.accountId}', '${account.accountType}')" title="Activate">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon btn-danger" onclick="banAccount('${account.accountId}', '${account.accountType}')" title="Ban Permanently">
                                <i class="fas fa-user-slash"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            Utils.hideLoading('suspendedLoading');
            Utils.showTable('suspendedTable');
        }
        
        function updateBannedAccountsUI() {
            const container = document.getElementById('bannedBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.bannedAccounts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-user-slash"></i>
                            <p>No banned accounts</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('bannedLoading');
                Utils.showTable('bannedTable');
                return;
            }
            
            AppState.bannedAccounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.accountId.substring(0, 8)}...</td>
                    <td>${account.accountName || 'N/A'}</td>
                    <td>${account.accountEmail || 'N/A'}</td>
                    <td><span class="status-badge">${account.accountType}</span></td>
                    <td>${Utils.formatDateShort(account.bannedAt)}</td>
                    <td>${account.reason || 'No reason provided'}</td>
                    <td>${account.bannedBy || 'System'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-success" onclick="activateBannedAccount('${account.accountId}', '${account.accountType}')" title="Unban">
                                <i class="fas fa-unlock"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            Utils.hideLoading('bannedLoading');
            Utils.showTable('bannedTable');
        }
        
        function updateTransactionsUI() {
            const container = document.getElementById('transactionsBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.transactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-exchange-alt"></i>
                            <p>No transactions found</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('transactionsLoading');
                Utils.showTable('transactionsTable');
                return;
            }
            
            // Sort by date, newest first
            const sortedTransactions = [...AppState.transactions].sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            sortedTransactions.forEach(tx => {
                const statusClass = tx.status === 'completed' ? 'status-approved' :
                                  tx.status === 'pending' ? 'status-pending' :
                                  tx.status === 'failed' ? 'status-rejected' :
                                  tx.status === 'reversed' ? 'status-suspended' : 'status-pending';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tx.id.substring(0, 8)}...</td>
                    <td>${tx.type || 'N/A'}</td>
                    <td>${tx.customerName || tx.customerId?.substring(0, 8) || 'N/A'}...</td>
                    <td>${tx.agentName || tx.agentId?.substring(0, 8) || 'N/A'}...</td>
                    <td>${Utils.formatCurrency(tx.amount || 0)}</td>
                    <td>${Utils.formatDateShort(tx.timestamp)}</td>
                    <td><span class="status-badge ${statusClass}">${tx.status || 'pending'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewTransaction('${tx.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${tx.status === 'pending' ? `
                            <button class="btn-icon btn-approve" onclick="approveTransaction('${tx.id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon btn-reject" onclick="rejectTransactionPrompt('${tx.id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                            ` : ''}
                            ${tx.status === 'completed' ? `
                            <button class="btn-icon btn-danger" onclick="reverseTransactionPrompt('${tx.id}')" title="Reverse">
                                <i class="fas fa-undo"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            Utils.hideLoading('transactionsLoading');
            Utils.showTable('transactionsTable');
        }
        
        function updateDisputesUI() {
            const container = document.getElementById('disputesBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            const activeDisputes = AppState.disputes.filter(d => 
                d.status === 'open' || d.status === 'investigating'
            );
            
            if (activeDisputes.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-gavel"></i>
                            <p>No active disputes</p>
                        </div>
                    </td>
                `;
                container.appendChild(row);
                Utils.hideLoading('disputesLoading');
                Utils.showTable('disputesTable');
                return;
            }
            
            activeDisputes.forEach(dispute => {
                const statusClass = dispute.status === 'open' ? 'status-pending' :
                                  dispute.status === 'investigating' ? 'status-warning' : 'status-approved';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dispute.id.substring(0, 8)}...</td>
                    <td>${dispute.type || 'N/A'}</td>
                    <td>${dispute.customerName || dispute.customerId?.substring(0, 8) || 'N/A'}...</td>
                    <td>${dispute.agentName || dispute.agentId?.substring(0, 8) || 'N/A'}...</td>
                    <td>${Utils.formatCurrency(dispute.amount || 0)}</td>
                    <td>${Utils.formatDateShort(dispute.openedAt)}</td>
                    <td><span class="status-badge ${statusClass}">${dispute.status || 'open'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewDispute('${dispute.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-success" onclick="resolveDisputePrompt('${dispute.id}')" title="Resolve">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
            
            Utils.hideLoading('disputesLoading');
            Utils.showTable('disputesTable');
        }
        
        function updateNotificationsUI() {
            const container = document.getElementById('notificationList');
            const badge = document.querySelector('.notification-badge');
            const countElement = document.getElementById('notificationCount');
            
            if (!container) return;
            
            // Filter unread notifications
            const unreadNotifications = AppState.notifications.filter(n => !n.read);
            const unreadCount = unreadNotifications.length;
            
            // Update badge
            if (badge) {
                badge.style.display = unreadCount > 0 ? 'block' : 'none';
            }
            
            // Update count in sidebar
            if (countElement) {
                countElement.textContent = unreadCount;
            }
            
            // Update notification list
            container.innerHTML = '';
            
            if (AppState.notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications</p>
                    </div>
                `;
                return;
            }
            
            // Show latest 10 notifications
            const recentNotifications = [...AppState.notifications]
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);
            
            recentNotifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                item.onclick = () => markNotificationRead(notification.id);
                
                let icon = 'fa-info-circle';
                let iconClass = 'info';
                
                switch(notification.type) {
                    case 'application_approved':
                    case 'transaction_approved':
                        icon = 'fa-check-circle';
                        iconClass = 'success';
                        break;
                    case 'application_rejected':
                    case 'transaction_rejected':
                        icon = 'fa-times-circle';
                        iconClass = 'danger';
                        break;
                    case 'dispute_opened':
                    case 'account_suspended':
                    case 'account_banned':
                        icon = 'fa-exclamation-triangle';
                        iconClass = 'warning';
                        break;
                    case 'agent_created':
                    case 'customer_created':
                        icon = 'fa-user-plus';
                        iconClass = 'success';
                        break;
                }
                
                item.innerHTML = `
                    <div class="notification-content">
                        <h5>${notification.title || 'Notification'}</h5>
                        <p>${notification.message || ''}</p>
                        <div class="notification-time">${Utils.formatDate(notification.timestamp)}</div>
                    </div>
                    <div class="notification-icon ${iconClass}">
                        <i class="fas ${icon}"></i>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            // Load audit logs for recent activity
            FirebaseService.getAuditLogs(10).then(result => {
                if (result.success) {
                    const logs = result.logs;
                    
                    if (logs.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <p>No recent activity</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    logs.forEach(log => {
                        const activity = document.createElement('div');
                        activity.className = 'activity-item';
                        
                        let icon = 'fa-info-circle';
                        let iconClass = 'info';
                        
                        switch(log.action) {
                            case 'APPROVE_APPLICATION':
                            case 'APPROVE_TRANSACTION':
                            case 'ACTIVATE_ACCOUNT':
                                icon = 'fa-check-circle';
                                iconClass = 'approval';
                                break;
                            case 'REJECT_APPLICATION':
                            case 'REJECT_TRANSACTION':
                            case 'SUSPEND_ACCOUNT':
                            case 'BAN_ACCOUNT':
                                icon = 'fa-times-circle';
                                iconClass = 'rejection';
                                break;
                            case 'CREATE_AGENT':
                            case 'CREATE_CUSTOMER':
                                icon = 'fa-user-plus';
                                iconClass = 'info';
                                break;
                            case 'UPDATE_SETTINGS':
                                icon = 'fa-cog';
                                iconClass = 'info';
                                break;
                            default:
                                icon = 'fa-history';
                                iconClass = 'info';
                        }
                        
                        activity.innerHTML = `
                            <div class="activity-icon ${iconClass}">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${log.action.replace(/_/g, ' ')}</div>
                                <div class="activity-description">${log.details ? JSON.stringify(log.details) : ''}</div>
                                <div class="activity-time">${Utils.formatDate(log.timestamp)}  By ${log.performedByEmail}</div>
                            </div>
                        `;
                        container.appendChild(activity);
                    });
                }
            });
        }
        
        function updatePendingAppsSelect() {
            const select = document.getElementById('pendingAppsSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select an application to set credentials</option>';
            
            AppState.applications.forEach(app => {
                const option = document.createElement('option');
                option.value = app.id;
                option.textContent = `${app.fullName} (${app.phone}) - ${app.id.substring(0, 8)}...`;
                select.appendChild(option);
            });
            
            // Add change listener
            select.onchange = function() {
                if (this.value) {
                    loadApplicationForCredentials(this.value);
                }
            };
        }
        
        // ===== Application Management Functions =====
        async function viewApplication(appId) {
            try {
                const result = await FirebaseService.getApplicationDetails(appId);
                if (result.success) {
                    const app = result.data;
                    const container = document.getElementById('appDetailsContent');
                    
                    // Generate suggested credentials
                    const suggestedEmail = `${app.fullName.toLowerCase().replace(/\s+/g, '.')}.${Date.now().toString().slice(-3)}@trucash.agent.com`;
                    const suggestedPassword = Utils.generatePassword(12);
                    const suggestedAgentId = Utils.generateAgentId();
                    
                    container.innerHTML = `
                        <div class="profile-header">
                            <div class="profile-avatar-large">
                                ${app.profilePhoto ? 
                                    `<img src="${app.profilePhoto}" alt="Profile">` : 
                                    `<span>${app.fullName?.charAt(0) || 'A'}</span>`
                                }
                            </div>
                            <div class="profile-info">
                                <h2>${app.fullName || 'Applicant'}</h2>
                                <p>Application ID: ${appId}</p>
                                <p>Submitted: ${Utils.formatDate(app.submittedAt)}</p>
                            </div>
                        </div>
                        
                        <div class="tab-nav" style="margin-top: 20px;">
                            <button class="tab-btn active" data-tab="details">Details</button>
                            <button class="tab-btn" data-tab="documents">Documents</button>
                            <button class="tab-btn" data-tab="credentials">Credentials</button>
                        </div>
                        
                        <div id="details" class="tab-content active">
                            <div class="card-grid">
                                <div class="info-card">
                                    <div class="info-card-header">
                                        <div class="info-card-title">Personal Information</div>
                                    </div>
                                    <div style="display: grid; gap: 12px;">
                                        <div>
                                            <small style="color: var(--gray-500);">Full Name</small>
                                            <p style="font-weight: 600;">${app.fullName || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <small style="color: var(--gray-500);">Phone Number</small>
                                            <p style="font-weight: 600;">${app.phone || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <small style="color: var(--gray-500);">Email</small>
                                            <p style="font-weight: 600;">${app.email || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <small style="color: var(--gray-500);">NRC Number</small>
                                            <p style="font-weight: 600;">${app.nrc || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <small style="color: var(--gray-500);">Residence</small>
                                            <p style="font-weight: 600;">${app.residence || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-card-header">
                                        <div class="info-card-title">Application Status</div>
                                    </div>
                                    <div style="display: grid; gap: 12px;">
                                        <div>
                                            <small style="color: var(--gray-500);">Status</small>
                                            <p><span class="status-badge status-${app.status || 'pending'}">${app.status || 'pending'}</span></p>
                                        </div>
                                        <div>
                                            <small style="color: var(--gray-500);">Submitted On</small>
                                            <p style="font-weight: 600;">${Utils.formatDate(app.submittedAt)}</p>
                                        </div>
                                        ${app.reviewedAt ? `
                                        <div>
                                            <small style="color: var(--gray-500);">Reviewed On</small>
                                            <p style="font-weight: 600;">${Utils.formatDate(app.reviewedAt)}</p>
                                        </div>
                                        <div>
                                            <small style="color: var(--gray-500);">Reviewed By</small>
                                            <p style="font-weight: 600;">${app.reviewedBy || 'N/A'}</p>
                                        </div>
                                        ` : ''}
                                        ${app.rejectionReason ? `
                                        <div>
                                            <small style="color: var(--gray-500);">Rejection Reason</small>
                                            <p style="color: var(--danger-color); font-weight: 600;">${app.rejectionReason}</p>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="documents" class="tab-content">
                            <div class="document-preview">
                                ${app.nrcFront ? `
                                <div class="document-item" onclick="viewDocument('${app.nrcFront}', 'NRC Front')">
                                    <div class="document-image">
                                        <img src="${app.nrcFront}" alt="NRC Front" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzk5OSI+TlJDIEZyb250PC90ZXh0Pjwvc3ZnPg=='">
                                    </div>
                                    <div class="document-info">
                                        <h5>NRC Front</h5>
                                        <p>ID Document</p>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${app.nrcBack ? `
                                <div class="document-item" onclick="viewDocument('${app.nrcBack}', 'NRC Back')">
                                    <div class="document-image">
                                        <img src="${app.nrcBack}" alt="NRC Back" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzk5OSI+TlJDIEJhY2s8L3RleHQ+PC9zdmc+'">
                                    </div>
                                    <div class="document-info">
                                        <h5>NRC Back</h5>
                                        <p>ID Document</p>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${app.profilePhoto ? `
                                <div class="document-item" onclick="viewDocument('${app.profilePhoto}', 'Profile Photo')">
                                    <div class="document-image">
                                        <img src="${app.profilePhoto}" alt="Profile Photo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzk5OSI+UHJvZmlsZSBQaG90bzwvdGV4dD48L3N2Zz4='">
                                    </div>
                                    <div class="document-info">
                                        <h5>Profile Photo</h5>
                                        <p>Portrait</p>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${app.additionalDoc ? `
                                <div class="document-item" onclick="viewDocument('${app.additionalDoc}', 'Additional Document')">
                                    <div class="document-image">
                                        <img src="${app.additionalDoc}" alt="Additional Document" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzk5OSI+QWRkaXRpb25hbCBEb2M8L3RleHQ+PC9zdmc+'">
                                    </div>
                                    <div class="document-info">
                                        <h5>Additional Document</h5>
                                        <p>Supporting Document</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div id="credentials" class="tab-content">
                            <div class="form-group">
                                <label class="form-label">Manual Credential Setup</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Agent Email *</label>
                                        <input type="email" class="form-control" id="agentEmailInput" value="${suggestedEmail}">
                                    </div>
                                    <div class="form-group">
                                        <label>Agent ID *</label>
                                        <input type="text" class="form-control" id="agentIdInput" value="${suggestedAgentId}">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Password *</label>
                                        <input type="text" class="form-control" id="agentPasswordInput" value="${suggestedPassword}" oninput="updatePasswordStrength(this.value)">
                                        <div class="password-strength">
                                            <div class="password-strength-bar" id="passwordStrengthBar"></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Confirm Password *</label>
                                        <input type="text" class="form-control" id="agentPasswordConfirmInput" value="${suggestedPassword}">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Commission Rate (%)</label>
                                        <input type="number" class="form-control" id="agentCommissionInput" min="1" max="20" step="0.5" value="5">
                                    </div>
                                    <div class="form-group">
                                        <label>Initial Status</label>
                                        <select class="form-select" id="agentStatusInput">
                                            <option value="active">Active</option>
                                            <option value="pending">Pending Review</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="sendWelcomeEmail" checked>
                                        <label class="form-check-label">Send welcome email with credentials</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="requirePasswordChange">
                                        <label class="form-check-label">Require password change on first login</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px; background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            <h4 style="margin-bottom: 8px;">Admin Notes</h4>
                            <textarea id="appNotes" class="form-control form-textarea" placeholder="Add any notes for this application...">${app.adminNotes || ''}</textarea>
                        </div>
                    `;
                    
                    // Initialize tab functionality
                    initTabs();
                    
                    // Store application ID for approval
                    window.currentAppId = appId;
                    
                    // Setup approve button
                    openModal('appDetailsModal');
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                console.error('Error viewing application:', error);
                Utils.showToast('Error', 'Failed to load application', 'error');
            }
        }
        
        async function loadApplicationForCredentials(appId) {
            try {
                const result = await FirebaseService.getApplicationDetails(appId);
                if (result.success) {
                    const app = result.data;
                    
                    // Generate suggested credentials
                    const suggestedEmail = `${app.fullName.toLowerCase().replace(/\s+/g, '.')}.${Date.now().toString().slice(-3)}@trucash.agent.com`;
                    const suggestedPassword = Utils.generatePassword(12);
                    const suggestedAgentId = Utils.generateAgentId();
                    
                    // Populate form fields
                    document.getElementById('manualAgentEmail').value = suggestedEmail;
                    document.getElementById('manualAgentId').value = suggestedAgentId;
                    document.getElementById('manualAgentPassword').value = suggestedPassword;
                    document.getElementById('manualAgentPasswordConfirm').value = suggestedPassword;
                    
                    // Update password strength
                    updatePasswordStrength(suggestedPassword);
                    
                    // Store app ID for later use
                    document.getElementById('manualAgentEmail').dataset.appId = appId;
                }
            } catch (error) {
                Utils.showToast('Error', 'Failed to load application', 'error');
            }
        }
        
        async function approveApplicationModal(appId = null) {
            const targetAppId = appId || window.currentAppId;
            if (!targetAppId) return;
            
            // Get values from form
            const email = document.getElementById('agentEmailInput')?.value.trim();
            const agentId = document.getElementById('agentIdInput')?.value.trim();
            const password = document.getElementById('agentPasswordInput')?.value;
            const passwordConfirm = document.getElementById('agentPasswordConfirmInput')?.value;
            const commissionRate = document.getElementById('agentCommissionInput')?.value || 5;
            const notes = document.getElementById('appNotes')?.value || '';
            
            // Validate inputs
            if (!email || !Utils.validateEmail(email)) {
                Utils.showToast('Error', 'Please enter a valid email address', 'error');
                return;
            }
            
            if (!agentId || agentId.length < 3) {
                Utils.showToast('Error', 'Please enter a valid Agent ID', 'error');
                return;
            }
            
            if (!password || password.length < 8) {
                Utils.showToast('Error', 'Password must be at least 8 characters', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                Utils.showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            // Show confirmation
            Swal.fire({
                title: 'Confirm Approval',
                html: `
                    <p>Are you sure you want to approve this application?</p>
                    <div style="text-align: left; margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <p><strong>Email:</strong> ${email}</p>
                        <p><strong>Agent ID:</strong> ${agentId}</p>
                        <p><strong>Commission Rate:</strong> ${commissionRate}%</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Approve',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#34C759',
                cancelButtonColor: '#FF3B30'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Creating agent account...', 'info');
                        
                        const credentials = {
                            email: email,
                            password: password,
                            agentId: agentId
                        };
                        
                        const result = await FirebaseService.approveApplicationWithCredentials(
                            targetAppId, 
                            credentials, 
                            commissionRate
                        );
                        
                        if (result.success) {
                            Utils.showToast('Success', 'Application approved successfully', 'success');
                            closeModal('appDetailsModal');
                            
                            // Show credentials to admin
                            Swal.fire({
                                title: 'Account Created Successfully!',
                                html: `
                                    <div style="text-align: left; margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 6px;">
                                        <p><strong>Agent Credentials:</strong></p>
                                        <p><strong>Email:</strong> ${email}</p>
                                        <p><strong>Agent ID:</strong> ${agentId}</p>
                                        <p><strong>Password:</strong> ${password}</p>
                                        <p><strong>Commission Rate:</strong> ${commissionRate}%</p>
                                    </div>
                                    <p style="margin-top: 16px; color: #FF9500;">
                                        <i class="fas fa-exclamation-triangle"></i> Please save these credentials securely
                                    </p>
                                `,
                                icon: 'success',
                                confirmButtonText: 'Copy Credentials',
                                showCancelButton: true,
                                cancelButtonText: 'Close'
                            }).then((copyResult) => {
                                if (copyResult.isConfirmed) {
                                    const credentialsText = `Email: ${email}\nAgent ID: ${agentId}\nPassword: ${password}\nCommission Rate: ${commissionRate}%`;
                                    navigator.clipboard.writeText(credentialsText);
                                    Utils.showToast('Copied', 'Credentials copied to clipboard', 'success');
                                }
                            });
                        } else {
                            Utils.showToast('Error', result.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message || 'Failed to approve application', 'error');
                    }
                }
            });
        }
        
        async function rejectApplicationPrompt(appId) {
            Swal.fire({
                title: 'Reject Application',
                input: 'textarea',
                inputLabel: 'Reason for rejection',
                inputPlaceholder: 'Please provide a reason for rejecting this application...',
                inputAttributes: {
                    'aria-label': 'Reason for rejection'
                },
                showCancelButton: true,
                confirmButtonText: 'Reject',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#FF3B30',
                cancelButtonColor: '#8E8E93',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Please provide a reason!';
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Rejecting application...', 'info');
                        const response = await FirebaseService.rejectApplication(appId, result.value);
                        
                        if (response.success) {
                            Utils.showToast('Success', 'Application rejected successfully', 'success');
                            closeModal('appDetailsModal');
                        } else {
                            Utils.showToast('Error', response.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        // ===== Agent Management Functions =====
        async function viewAgent(agentId) {
            try {
                const result = await FirebaseService.getAgentDetails(agentId);
                if (result.success) {
                    const agent = result.data;
                    const container = document.getElementById('agentDetailsContent');
                    
                    // Calculate performance metrics
                    const successRate = agent.performance?.successRate || 0;
                    const completionRate = agent.performance?.completionRate || 0;
                    const rating = agent.performance?.rating || 0;
                    
                    container.innerHTML = `
                        <div class="profile-header">
                            <div class="profile-avatar-large">
                                ${agent.profilePhoto ? 
                                    `<img src="${agent.profilePhoto}" alt="Profile">` : 
                                    `<span>${agent.fullName?.charAt(0) || 'A'}</span>`
                                }
                            </div>
                            <div class="profile-info">
                                <h2>${agent.fullName || 'Agent'}</h2>
                                <p>Agent ID: ${agent.agentId || agentId}</p>
                                <p>Status: <span class="status-badge ${agent.status === 'active' ? 'status-active' : agent.status === 'suspended' ? 'status-suspended' : 'status-banned'}">${agent.status}</span></p>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="value">${agent.totalClients || 0}</div>
                                <div class="label">Total Clients</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${agent.totalLoans || 0}</div>
                                <div class="label">Total Loans</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${Utils.formatCurrency(agent.commissionEarned || 0)}</div>
                                <div class="label">Commission Earned</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${agent.commissionRate || 5}%</div>
                                <div class="label">Commission Rate</div>
                            </div>
                        </div>
                        
                        <div class="card-grid">
                            <div class="info-card">
                                <div class="info-card-header">
                                    <div class="info-card-title">Contact Information</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <small style="color: var(--gray-500);">Email</small>
                                        <p style="font-weight: 600;">${agent.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Phone</small>
                                        <p style="font-weight: 600;">${agent.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Residence</small>
                                        <p style="font-weight: 600;">${agent.residence || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">NRC Number</small>
                                        <p style="font-weight: 600;">${agent.nrc || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-card">
                                <div class="info-card-header">
                                    <div class="info-card-title">Performance Metrics</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <small style="color: var(--gray-500);">Success Rate</small>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="flex: 1; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${successRate}%; height: 100%; background: var(--success-color);"></div>
                                            </div>
                                            <span style="font-weight: 600;">${successRate}%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Completion Rate</small>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="flex: 1; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${completionRate}%; height: 100%; background: var(--primary-color);"></div>
                                            </div>
                                            <span style="font-weight: 600;">${completionRate}%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Average Rating</small>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            ${Array.from({length: 5}).map((_, i) => `
                                                <i class="fas fa-star" style="color: ${i < Math.floor(rating) ? '#FF9500' : '#D1D1D6'};"></i>
                                            `).join('')}
                                            <span style="margin-left: 8px; font-weight: 600;">${rating.toFixed(1)}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Total Transactions</small>
                                        <p style="font-weight: 600;">${agent.performance?.totalTransactions || 0}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-card">
                                <div class="info-card-header">
                                    <div class="info-card-title">Account Information</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <small style="color: var(--gray-500);">Account Created</small>
                                        <p style="font-weight: 600;">${Utils.formatDate(agent.createdAt)}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Last Login</small>
                                        <p style="font-weight: 600;">${agent.lastLogin ? Utils.formatDate(agent.lastLogin) : 'Never'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Email Verified</small>
                                        <p><span class="status-badge ${agent.emailVerified ? 'status-approved' : 'status-rejected'}">${agent.emailVerified ? 'Verified' : 'Not Verified'}</span></p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Created By</small>
                                        <p style="font-weight: 600;">${agent.assignedBy || agent.createdBy || 'System'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${agent.suspensionReason || agent.banReason ? `
                        <div style="margin-top: 24px; padding: 16px; background: ${agent.status === 'suspended' ? 'rgba(255, 149, 0, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; border-radius: 8px; border-left: 4px solid ${agent.status === 'suspended' ? 'var(--warning-color)' : 'var(--danger-color)'};">
                            <h4 style="margin-bottom: 8px; color: ${agent.status === 'suspended' ? 'var(--warning-color)' : 'var(--danger-color)'};">
                                <i class="fas fa-${agent.status === 'suspended' ? 'ban' : 'user-slash'}"></i>
                                Account ${agent.status === 'suspended' ? 'Suspended' : 'Banned'}
                            </h4>
                            <p><strong>Reason:</strong> ${agent.suspensionReason || agent.banReason}</p>
                            ${agent.suspendedAt ? `<p><strong>Suspended On:</strong> ${Utils.formatDate(agent.suspendedAt)}</p>` : ''}
                            ${agent.suspendedBy ? `<p><strong>Suspended By:</strong> ${agent.suspendedBy}</p>` : ''}
                            ${agent.suspensionExpires ? `<p><strong>Suspension Expires:</strong> ${Utils.formatDate(agent.suspensionExpires)}</p>` : ''}
                        </div>
                        ` : ''}
                    `;
                    
                    // Store agent ID for actions
                    window.currentAgentId = agentId;
                    window.currentAgentType = 'agent';
                    
                    // Setup action buttons
                    const suspendBtn = document.getElementById('suspendAgentBtn');
                    const banBtn = document.getElementById('banAgentBtn');
                    const activateBtn = document.getElementById('activateAgentBtn');
                    
                    if (suspendBtn) suspendBtn.onclick = () => openSuspensionModal(agentId, 'agent', agent);
                    if (banBtn) banBtn.onclick = () => openBanModal(agentId, 'agent', agent);
                    if (activateBtn) activateBtn.onclick = () => activateAccount(agentId, 'agent');
                    
                    // Show/hide buttons based on status
                    if (agent.status === 'active') {
                        if (activateBtn) activateBtn.style.display = 'none';
                    } else {
                        if (suspendBtn) suspendBtn.style.display = 'none';
                        if (banBtn) banBtn.style.display = 'none';
                    }
                    
                    openModal('agentDetailsModal');
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                console.error('Error viewing agent:', error);
                Utils.showToast('Error', 'Failed to load agent details', 'error');
            }
        }
        
        async function toggleAgentStatus(agentId, currentStatus) {
            if (currentStatus === 'active') {
                // Open suspension modal
                openSuspensionModal(agentId, 'agent');
            } else if (currentStatus === 'suspended' || currentStatus === 'banned') {
                // Activate account
                activateAccount(agentId, 'agent');
            }
        }
        
        // ===== Customer Management Functions =====
        async function viewCustomer(customerId) {
            try {
                const result = await FirebaseService.getCustomerDetails(customerId);
                if (result.success) {
                    const customer = result.data;
                    const container = document.getElementById('customerDetailsContent');
                    
                    container.innerHTML = `
                        <div class="profile-header">
                            <div class="profile-avatar-large">
                                ${customer.profilePhoto ? 
                                    `<img src="${customer.profilePhoto}" alt="Profile">` : 
                                    `<span>${customer.fullName?.charAt(0) || 'C'}</span>`
                                }
                            </div>
                            <div class="profile-info">
                                <h2>${customer.fullName || 'Customer'}</h2>
                                <p>Customer ID: ${customerId.substring(0, 8)}...</p>
                                <p>Status: <span class="status-badge ${customer.status === 'active' ? 'status-active' : customer.status === 'suspended' ? 'status-suspended' : 'status-banned'}">${customer.status}</span></p>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="value">${Utils.formatCurrency(customer.accountBalance || 0)}</div>
                                <div class="label">Account Balance</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${customer.loanCount || 0}</div>
                                <div class="label">Total Loans</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${Utils.formatCurrency(customer.totalBorrowed || 0)}</div>
                                <div class="label">Total Borrowed</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${Utils.formatCurrency(customer.outstandingBalance || 0)}</div>
                                <div class="label">Outstanding Balance</div>
                            </div>
                        </div>
                        
                        <div class="card-grid">
                            <div class="info-card">
                                <div class="info-card-header">
                                    <div class="info-card-title">Contact Information</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <small style="color: var(--gray-500);">Email</small>
                                        <p style="font-weight: 600;">${customer.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Phone</small>
                                        <p style="font-weight: 600;">${customer.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Address</small>
                                        <p style="font-weight: 600;">${customer.address || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Date of Birth</small>
                                        <p style="font-weight: 600;">${customer.dateOfBirth || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-card">
                                <div class="info-card-header">
                                    <div class="info-card-title">Account Information</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <small style="color: var(--gray-500);">Account Created</small>
                                        <p style="font-weight: 600;">${Utils.formatDate(customer.createdAt)}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Last Login</small>
                                        <p style="font-weight: 600;">${customer.lastLogin ? Utils.formatDate(customer.lastLogin) : 'Never'}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Verification Status</small>
                                        <p><span class="status-badge ${customer.verificationStatus === 'verified' ? 'status-approved' : customer.verificationStatus === 'pending' ? 'status-pending' : 'status-rejected'}">${customer.verificationStatus || 'unverified'}</span></p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">KYC Status</small>
                                        <p><span class="status-badge ${customer.kycStatus === 'verified' ? 'status-approved' : customer.kycStatus === 'pending' ? 'status-pending' : 'status-rejected'}">${customer.kycStatus || 'pending'}</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-card">
                                <div class="info-card-header">
                                    <div class="info-card-title">Loan Information</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <small style="color: var(--gray-500);">Active Loans</small>
                                        <p style="font-weight: 600;">${customer.activeLoans || 0}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Total Repaid</small>
                                        <p style="font-weight: 600;">${Utils.formatCurrency(customer.totalRepaid || 0)}</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Default Rate</small>
                                        <p style="font-weight: 600;">${customer.defaultRate || 0}%</p>
                                    </div>
                                    <div>
                                        <small style="color: var(--gray-500);">Credit Score</small>
                                        <p style="font-weight: 600;">${customer.creditScore || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${customer.suspensionReason || customer.banReason ? `
                        <div style="margin-top: 24px; padding: 16px; background: ${customer.status === 'suspended' ? 'rgba(255, 149, 0, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; border-radius: 8px; border-left: 4px solid ${customer.status === 'suspended' ? 'var(--warning-color)' : 'var(--danger-color)'};">
                            <h4 style="margin-bottom: 8px; color: ${customer.status === 'suspended' ? 'var(--warning-color)' : 'var(--danger-color)'};">
                                <i class="fas fa-${customer.status === 'suspended' ? 'ban' : 'user-slash'}"></i>
                                Account ${customer.status === 'suspended' ? 'Suspended' : 'Banned'}
                            </h4>
                            <p><strong>Reason:</strong> ${customer.suspensionReason || customer.banReason}</p>
                            ${customer.suspendedAt ? `<p><strong>Suspended On:</strong> ${Utils.formatDate(customer.suspendedAt)}</p>` : ''}
                            ${customer.suspendedBy ? `<p><strong>Suspended By:</strong> ${customer.suspendedBy}</p>` : ''}
                            ${customer.suspensionExpires ? `<p><strong>Suspension Expires:</strong> ${Utils.formatDate(customer.suspensionExpires)}</p>` : ''}
                        </div>
                        ` : ''}
                    `;
                    
                    // Store customer ID for actions
                    window.currentCustomerId = customerId;
                    window.currentCustomerType = 'customer';
                    
                    // Setup action buttons
                    const suspendBtn = document.getElementById('suspendCustomerBtn');
                    const banBtn = document.getElementById('banCustomerBtn');
                    const activateBtn = document.getElementById('activateCustomerBtn');
                    
                    if (suspendBtn) suspendBtn.onclick = () => openSuspensionModal(customerId, 'customer', customer);
                    if (banBtn) banBtn.onclick = () => openBanModal(customerId, 'customer', customer);
                    if (activateBtn) activateBtn.onclick = () => activateAccount(customerId, 'customer');
                    
                    // Show/hide buttons based on status
                    if (customer.status === 'active') {
                        if (activateBtn) activateBtn.style.display = 'none';
                    } else {
                        if (suspendBtn) suspendBtn.style.display = 'none';
                        if (banBtn) banBtn.style.display = 'none';
                    }
                    
                    openModal('customerDetailsModal');
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                console.error('Error viewing customer:', error);
                Utils.showToast('Error', 'Failed to load customer details', 'error');
            }
        }
        
        async function toggleCustomerStatus(customerId, currentStatus) {
            if (currentStatus === 'active') {
                // Open suspension modal
                openSuspensionModal(customerId, 'customer');
            } else if (currentStatus === 'suspended' || currentStatus === 'banned') {
                // Activate account
                activateAccount(customerId, 'customer');
            }
        }
        
        // ===== Account Suspension/Ban Functions =====
        function openSuspensionModal(accountId, accountType, accountData = null) {
            window.currentSuspensionAccount = {
                id: accountId,
                type: accountType,
                data: accountData
            };
            
            const title = document.getElementById('suspensionTitle');
            const accountInfo = document.getElementById('suspensionAccountInfo');
            
            if (title) title.textContent = 'Suspend Account';
            if (accountInfo && accountData) {
                accountInfo.innerHTML = `
                    <p><strong>Name:</strong> ${accountData.fullName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${accountData.email || 'N/A'}</p>
                    <p><strong>Account Type:</strong> ${accountType}</p>
                    <p><strong>Current Status:</strong> <span class="status-badge ${accountData.status === 'active' ? 'status-active' : 'status-suspended'}">${accountData.status}</span></p>
                `;
            }
            
            // Reset form
            document.getElementById('suspensionType').value = 'suspend';
            document.getElementById('suspensionReason').value = '';
            document.getElementById('suspensionDuration').value = '7';
            document.getElementById('customDurationGroup').style.display = 'none';
            document.getElementById('notifyUser').checked = true;
            document.getElementById('restrictTransactions').checked = false;
            document.getElementById('freezeFunds').checked = false;
            
            openModal('suspensionModal');
        }
        
        function openBanModal(accountId, accountType, accountData = null) {
            window.currentSuspensionAccount = {
                id: accountId,
                type: accountType,
                data: accountData
            };
            
            const title = document.getElementById('suspensionTitle');
            const accountInfo = document.getElementById('suspensionAccountInfo');
            
            if (title) title.textContent = 'Ban Account Permanently';
            if (accountInfo && accountData) {
                accountInfo.innerHTML = `
                    <p><strong>Name:</strong> ${accountData.fullName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${accountData.email || 'N/A'}</p>
                    <p><strong>Account Type:</strong> ${accountType}</p>
                    <p><strong>Current Status:</strong> <span class="status-badge ${accountData.status === 'active' ? 'status-active' : accountData.status === 'suspended' ? 'status-suspended' : 'status-banned'}">${accountData.status}</span></p>
                `;
            }
            
            // Set to ban mode
            document.getElementById('suspensionType').value = 'ban';
            document.getElementById('suspensionReason').value = '';
            document.getElementById('durationGroup').style.display = 'none';
            document.getElementById('notifyUser').checked = true;
            document.getElementById('restrictTransactions').checked = true;
            document.getElementById('freezeFunds').checked = true;
            
            openModal('suspensionModal');
        }
        
        function updateSuspensionType() {
            const type = document.getElementById('suspensionType').value;
            const durationGroup = document.getElementById('durationGroup');
            const reasonLabel = document.getElementById('suspensionReasonLabel');
            const title = document.getElementById('suspensionTitle');
            
            if (type === 'ban') {
                durationGroup.style.display = 'none';
                if (reasonLabel) reasonLabel.textContent = 'Reason for Ban *';
                if (title) title.textContent = 'Ban Account Permanently';
            } else if (type === 'suspend') {
                durationGroup.style.display = 'block';
                if (reasonLabel) reasonLabel.textContent = 'Reason for Suspension *';
                if (title) title.textContent = 'Suspend Account';
            } else {
                durationGroup.style.display = 'none';
                if (reasonLabel) reasonLabel.textContent = 'Reason for Warning *';
                if (title) title.textContent = 'Issue Warning';
            }
            
            // Show custom duration field if selected
            const durationSelect = document.getElementById('suspensionDuration');
            const customDurationGroup = document.getElementById('customDurationGroup');
            customDurationGroup.style.display = durationSelect.value === 'custom' ? 'block' : 'none';
        }
        
        async function processSuspension() {
            const account = window.currentSuspensionAccount;
            if (!account) return;
            
            const type = document.getElementById('suspensionType').value;
            const reason = document.getElementById('suspensionReason').value.trim();
            const notifyUser = document.getElementById('notifyUser').checked;
            const restrictTransactions = document.getElementById('restrictTransactions').checked;
            const freezeFunds = document.getElementById('freezeFunds').checked;
            
            if (!reason) {
                Utils.showToast('Error', 'Please provide a reason', 'error');
                return;
            }
            
            const additionalActions = {
                notifyUser: notifyUser,
                restrictTransactions: restrictTransactions,
                freezeFunds: freezeFunds
            };
            
            try {
                if (type === 'ban') {
                    Utils.showToast('Processing', 'Banning account...', 'info');
                    const result = await FirebaseService.banAccount(
                        account.id,
                        account.type,
                        reason,
                        additionalActions
                    );
                    
                    if (result.success) {
                        Utils.showToast('Success', 'Account banned successfully', 'success');
                        closeModal('suspensionModal');
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } else if (type === 'suspend') {
                    let duration = parseInt(document.getElementById('suspensionDuration').value);
                    
                    if (document.getElementById('suspensionDuration').value === 'custom') {
                        duration = parseInt(document.getElementById('customDuration').value) || 7;
                    }
                    
                    if (duration < 1 || duration > 365) {
                        Utils.showToast('Error', 'Duration must be between 1 and 365 days', 'error');
                        return;
                    }
                    
                    Utils.showToast('Processing', 'Suspending account...', 'info');
                    const result = await FirebaseService.suspendAccount(
                        account.id,
                        account.type,
                        reason,
                        duration,
                        additionalActions
                    );
                    
                    if (result.success) {
                        Utils.showToast('Success', `Account suspended for ${duration} days`, 'success');
                        closeModal('suspensionModal');
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } else {
                    // Warning only
                    Utils.showToast('Success', 'Warning issued to account', 'success');
                    closeModal('suspensionModal');
                }
            } catch (error) {
                Utils.showToast('Error', error.message, 'error');
            }
        }
        
        async function activateAccount(accountId, accountType) {
            Swal.fire({
                title: 'Activate Account',
                text: `Are you sure you want to activate this ${accountType} account?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Activate',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#34C759',
                cancelButtonColor: '#FF3B30'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Activating account...', 'info');
                        const response = await FirebaseService.activateAccount(accountId, accountType);
                        
                        if (response.success) {
                            Utils.showToast('Success', 'Account activated successfully', 'success');
                            closeModal('agentDetailsModal');
                            closeModal('customerDetailsModal');
                        } else {
                            Utils.showToast('Error', response.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        async function activateSuspendedAccount(accountId, accountType) {
            await activateAccount(accountId, accountType);
        }
        
        async function activateBannedAccount(accountId, accountType) {
            await activateAccount(accountId, accountType);
        }
        
        async function banAccount(accountId, accountType) {
            openBanModal(accountId, accountType);
        }
        
        // ===== Transaction Functions =====
        async function viewTransaction(txId) {
            // Find transaction
            const tx = AppState.transactions.find(t => t.id === txId);
            if (!tx) {
                Utils.showToast('Error', 'Transaction not found', 'error');
                return;
            }
            
            const container = document.getElementById('transactionDetailsContent');
            container.innerHTML = `
                <div class="card-grid">
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-title">Transaction Details</div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <small style="color: var(--gray-500);">Transaction ID</small>
                                <p style="font-weight: 600;">${tx.id}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Type</small>
                                <p style="font-weight: 600;">${tx.type || 'N/A'}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Amount</small>
                                <p style="font-weight: 600;">${Utils.formatCurrency(tx.amount || 0)}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Status</small>
                                <p><span class="status-badge ${tx.status === 'completed' ? 'status-approved' : tx.status === 'pending' ? 'status-pending' : 'status-rejected'}">${tx.status || 'pending'}</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-title">Parties Involved</div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <small style="color: var(--gray-500);">Customer</small>
                                <p style="font-weight: 600;">${tx.customerName || tx.customerId || 'N/A'}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Agent</small>
                                <p style="font-weight: 600;">${tx.agentName || tx.agentId || 'N/A'}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Initiated By</small>
                                <p style="font-weight: 600;">${tx.initiatedBy || 'Customer'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-title">Timestamps</div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <small style="color: var(--gray-500);">Created</small>
                                <p style="font-weight: 600;">${Utils.formatDate(tx.timestamp)}</p>
                            </div>
                            ${tx.completedAt ? `
                            <div>
                                <small style="color: var(--gray-500);">Completed</small>
                                <p style="font-weight: 600;">${Utils.formatDate(tx.completedAt)}</p>
                            </div>
                            ` : ''}
                            ${tx.reviewedAt ? `
                            <div>
                                <small style="color: var(--gray-500);">Reviewed</small>
                                <p style="font-weight: 600;">${Utils.formatDate(tx.reviewedAt)}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                ${tx.description || tx.notes ? `
                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 8px;">Description</h4>
                    <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <p>${tx.description || tx.notes || 'No description provided'}</p>
                    </div>
                </div>
                ` : ''}
                
                ${tx.adminNotes ? `
                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 8px;">Admin Notes</h4>
                    <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <p>${tx.adminNotes}</p>
                    </div>
                </div>
                ` : ''}
                
                ${tx.rejectionReason ? `
                <div style="margin-top: 24px; padding: 16px; background: rgba(255, 59, 48, 0.1); border-radius: 8px;">
                    <h4 style="margin-bottom: 8px; color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle"></i> Rejection Reason
                    </h4>
                    <p>${tx.rejectionReason}</p>
                </div>
                ` : ''}
            `;
            
            // Store transaction ID for actions
            window.currentTransactionId = txId;
            
            // Setup action buttons
            const reverseBtn = document.getElementById('reverseTxBtn');
            const approveBtn = document.getElementById('approveTxBtn');
            
            if (reverseBtn) reverseBtn.onclick = () => reverseTransactionPrompt(txId);
            if (approveBtn) approveBtn.onclick = () => approveTransaction(txId);
            
            // Show/hide buttons based on status
            if (tx.status === 'completed') {
                if (approveBtn) approveBtn.style.display = 'none';
            } else if (tx.status === 'pending') {
                if (reverseBtn) reverseBtn.style.display = 'none';
            }
            
            openModal('transactionDetailsModal');
        }
        
        async function approveTransaction(txId) {
            Swal.fire({
                title: 'Approve Transaction',
                input: 'textarea',
                inputLabel: 'Add notes (optional)',
                inputPlaceholder: 'Add any notes for this approval...',
                showCancelButton: true,
                confirmButtonText: 'Approve',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#34C759',
                cancelButtonColor: '#8E8E93'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Approving transaction...', 'info');
                        const response = await FirebaseService.approveTransaction(txId, result.value);
                        
                        if (response.success) {
                            Utils.showToast('Success', 'Transaction approved successfully', 'success');
                            closeModal('transactionDetailsModal');
                        } else {
                            Utils.showToast('Error', response.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        async function rejectTransactionPrompt(txId) {
            Swal.fire({
                title: 'Reject Transaction',
                input: 'textarea',
                inputLabel: 'Reason for rejection',
                inputPlaceholder: 'Please provide a reason for rejecting this transaction...',
                inputAttributes: {
                    'aria-label': 'Reason for rejection'
                },
                showCancelButton: true,
                confirmButtonText: 'Reject',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#FF3B30',
                cancelButtonColor: '#8E8E93',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Please provide a reason!';
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Rejecting transaction...', 'info');
                        const response = await FirebaseService.rejectTransaction(txId, result.value);
                        
                        if (response.success) {
                            Utils.showToast('Success', 'Transaction rejected successfully', 'success');
                            closeModal('transactionDetailsModal');
                        } else {
                            Utils.showToast('Error', response.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        async function reverseTransactionPrompt(txId) {
            Swal.fire({
                title: 'Reverse Transaction',
                input: 'textarea',
                inputLabel: 'Reason for reversal',
                inputPlaceholder: 'Please provide a reason for reversing this transaction...',
                inputAttributes: {
                    'aria-label': 'Reason for reversal'
                },
                showCancelButton: true,
                confirmButtonText: 'Reverse',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#FF3B30',
                cancelButtonColor: '#8E8E93',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Please provide a reason!';
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Reversing transaction...', 'info');
                        const response = await FirebaseService.reverseTransaction(txId, result.value);
                        
                        if (response.success) {
                            Utils.showToast('Success', 'Transaction reversed successfully', 'success');
                            closeModal('transactionDetailsModal');
                        } else {
                            Utils.showToast('Error', response.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        // ===== Dispute Functions =====
        async function viewDispute(disputeId) {
            // Find dispute
            const dispute = AppState.disputes.find(d => d.id === disputeId);
            if (!dispute) {
                Utils.showToast('Error', 'Dispute not found', 'error');
                return;
            }
            
            const container = document.getElementById('disputeDetailsContent');
            container.innerHTML = `
                <div class="card-grid">
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-title">Dispute Details</div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <small style="color: var(--gray-500);">Case ID</small>
                                <p style="font-weight: 600;">${dispute.id}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Type</small>
                                <p style="font-weight: 600;">${dispute.type || 'N/A'}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Amount</small>
                                <p style="font-weight: 600;">${Utils.formatCurrency(dispute.amount || 0)}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Status</small>
                                <p><span class="status-badge ${dispute.status === 'resolved' ? 'status-approved' : dispute.status === 'investigating' ? 'status-warning' : 'status-pending'}">${dispute.status || 'open'}</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-title">Parties Involved</div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <small style="color: var(--gray-500);">Customer</small>
                                <p style="font-weight: 600;">${dispute.customerName || dispute.customerId || 'N/A'}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Agent</small>
                                <p style="font-weight: 600;">${dispute.agentName || dispute.agentId || 'N/A'}</p>
                            </div>
                            <div>
                                <small style="color: var(--gray-500);">Opened By</small>
                                <p style="font-weight: 600;">${dispute.openedBy || 'Customer'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-title">Timestamps</div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <small style="color: var(--gray-500);">Opened</small>
                                <p style="font-weight: 600;">${Utils.formatDate(dispute.openedAt)}</p>
                            </div>
                            ${dispute.resolvedAt ? `
                            <div>
                                <small style="color: var(--gray-500);">Resolved</small>
                                <p style="font-weight: 600;">${Utils.formatDate(dispute.resolvedAt)}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 8px;">Description</h4>
                    <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <p>${dispute.description || 'No description provided'}</p>
                    </div>
                </div>
                
                ${dispute.evidence ? `
                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 8px;">Evidence</h4>
                    <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <p>${dispute.evidence}</p>
                    </div>
                </div>
                ` : ''}
                
                ${dispute.resolution ? `
                <div style="margin-top: 24px; padding: 16px; background: rgba(52, 199, 89, 0.1); border-radius: 8px;">
                    <h4 style="margin-bottom: 8px; color: var(--success-color);">
                        <i class="fas fa-check-circle"></i> Resolution
                    </h4>
                    <p><strong>Decision:</strong> ${dispute.resolution}</p>
                    ${dispute.resolutionNotes ? `<p><strong>Notes:</strong> ${dispute.resolutionNotes}</p>` : ''}
                    <p><strong>Resolved By:</strong> ${dispute.resolvedBy || 'N/A'}</p>
                </div>
                ` : ''}
            `;
            
            // Store dispute ID for actions
            window.currentDisputeId = disputeId;
            
            // Setup action button
            const resolveBtn = document.getElementById('resolveDisputeBtn');
            if (resolveBtn) resolveBtn.onclick = () => resolveDisputePrompt(disputeId);
            
            openModal('disputeDetailsModal');
        }
        
        async function resolveDisputePrompt(disputeId) {
            Swal.fire({
                title: 'Resolve Dispute',
                html: `
                    <div style="text-align: left; margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Resolution</label>
                        <select id="resolutionType" class="swal2-select" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="customer_favored">Customer Favored</option>
                            <option value="agent_favored">Agent Favored</option>
                            <option value="partial_refund">Partial Refund</option>
                            <option value="full_refund">Full Refund</option>
                            <option value="dismissed">Dismissed</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="text-align: left;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Notes</label>
                        <textarea id="resolutionNotes" class="swal2-textarea" placeholder="Add resolution notes..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Resolve',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#007AFF',
                cancelButtonColor: '#8E8E93',
                preConfirm: () => {
                    const resolution = document.getElementById('resolutionType').value;
                    const notes = document.getElementById('resolutionNotes').value;
                    return { resolution, notes };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Utils.showToast('Processing', 'Resolving dispute...', 'info');
                        const response = await FirebaseService.resolveDispute(
                            disputeId, 
                            result.value.resolution, 
                            result.value.notes
                        );
                        
                        if (response.success) {
                            Utils.showToast('Success', 'Dispute resolved successfully', 'success');
                            closeModal('disputeDetailsModal');
                        } else {
                            Utils.showToast('Error', response.error, 'error');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        // ===== Agent Creation Functions =====
        function createAgentAccount() {
            // Generate suggested values
            const suggestedAgentId = Utils.generateAgentId();
            const suggestedPassword = Utils.generatePassword(12);
            
            document.getElementById('createAgentId').value = suggestedAgentId;
            document.getElementById('createAgentPassword').value = suggestedPassword;
            document.getElementById('createAgentPasswordConfirm').value = suggestedPassword;
            document.getElementById('createAgentCommission').value = 5;
            document.getElementById('createAgentStatus').value = 'active';
            
            openModal('createAgentModal');
        }
        
        async function createNewAgent() {
            const agentData = {
                fullName: document.getElementById('createAgentName').value.trim(),
                email: document.getElementById('createAgentEmail').value.trim(),
                phone: document.getElementById('createAgentPhone').value.trim(),
                agentId: document.getElementById('createAgentId').value.trim(),
                password: document.getElementById('createAgentPassword').value,
                commissionRate: document.getElementById('createAgentCommission').value,
                status: document.getElementById('createAgentStatus').value
            };
            
            // Validate inputs
            if (!agentData.fullName) {
                Utils.showToast('Error', 'Please enter agent name', 'error');
                return;
            }
            
            if (!Utils.validateEmail(agentData.email)) {
                Utils.showToast('Error', 'Please enter a valid email', 'error');
                return;
            }
            
            if (!Utils.validatePhone(agentData.phone)) {
                Utils.showToast('Error', 'Please enter a valid phone number', 'error');
                return;
            }
            
            if (!agentData.agentId) {
                Utils.showToast('Error', 'Please enter agent ID', 'error');
                return;
            }
            
            if (agentData.password.length < 8) {
                Utils.showToast('Error', 'Password must be at least 8 characters', 'error');
                return;
            }
            
            const passwordConfirm = document.getElementById('createAgentPasswordConfirm').value;
            if (agentData.password !== passwordConfirm) {
                Utils.showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            try {
                Utils.showToast('Processing', 'Creating agent account...', 'info');
                const result = await FirebaseService.createAgentAccount(agentData);
                
                if (result.success) {
                    Utils.showToast('Success', 'Agent account created successfully', 'success');
                    closeModal('createAgentModal');
                    
                    // Clear form
                    document.getElementById('createAgentName').value = '';
                    document.getElementById('createAgentEmail').value = '';
                    document.getElementById('createAgentPhone').value = '';
                    document.getElementById('createAgentPassword').value = '';
                    document.getElementById('createAgentPasswordConfirm').value = '';
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                Utils.showToast('Error', error.message, 'error');
            }
        }
        
        function openManualAgentCreation() {
            // Generate suggested values
            const suggestedAgentId = Utils.generateAgentId();
            const suggestedEmail = `agent.${Date.now().toString().slice(-6)}@trucash.com`;
            const suggestedPassword = Utils.generatePassword(12);
            
            document.getElementById('manualAgentEmail').value = suggestedEmail;
            document.getElementById('manualAgentId').value = suggestedAgentId;
            document.getElementById('manualAgentPassword').value = suggestedPassword;
            document.getElementById('manualAgentPasswordConfirm').value = suggestedPassword;
            document.getElementById('agentCommissionRate').value = 5;
            
            // Clear app selection
            document.getElementById('pendingAppsSelect').value = '';
            document.getElementById('manualAgentEmail').dataset.appId = '';
            
            updatePasswordStrength(suggestedPassword);
        }
        
        async function saveAgentCredentials() {
            const email = document.getElementById('manualAgentEmail').value.trim();
            const agentId = document.getElementById('manualAgentId').value.trim();
            const password = document.getElementById('manualAgentPassword').value;
            const passwordConfirm = document.getElementById('manualAgentPasswordConfirm').value;
            const commissionRate = document.getElementById('agentCommissionRate').value;
            const appId = document.getElementById('manualAgentEmail').dataset.appId;
            
            // Validate inputs
            if (!Utils.validateEmail(email)) {
                Utils.showToast('Error', 'Please enter a valid email', 'error');
                return;
            }
            
            if (!agentId) {
                Utils.showToast('Error', 'Please enter agent ID', 'error');
                return;
            }
            
            if (password.length < 8) {
                Utils.showToast('Error', 'Password must be at least 8 characters', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                Utils.showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            // If application ID is provided, approve that application
            if (appId) {
                const credentials = {
                    email: email,
                    password: password,
                    agentId: agentId
                };
                
                try {
                    Utils.showToast('Processing', 'Creating agent account...', 'info');
                    const result = await FirebaseService.approveApplicationWithCredentials(
                        appId, 
                        credentials, 
                        commissionRate
                    );
                    
                    if (result.success) {
                        Utils.showToast('Success', 'Agent account created and application approved', 'success');
                        resetCredentialForm();
                        
                        // Show credentials
                        Swal.fire({
                            title: 'Account Created Successfully!',
                            html: `
                                <div style="text-align: left; margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 6px;">
                                    <p><strong>Agent Credentials:</strong></p>
                                    <p><strong>Email:</strong> ${email}</p>
                                    <p><strong>Agent ID:</strong> ${agentId}</p>
                                    <p><strong>Password:</strong> ${password}</p>
                                    <p><strong>Commission Rate:</strong> ${commissionRate}%</p>
                                </div>
                            `,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    Utils.showToast('Error', error.message, 'error');
                }
            } else {
                // Create standalone agent account
                const agentData = {
                    fullName: 'Agent ' + agentId, // Default name
                    email: email,
                    phone: 'N/A', // Will need to be updated
                    agentId: agentId,
                    password: password,
                    commissionRate: commissionRate,
                    status: 'active'
                };
                
                try {
                    Utils.showToast('Processing', 'Creating agent account...', 'info');
                    const result = await FirebaseService.createAgentAccount(agentData);
                    
                    if (result.success) {
                        Utils.showToast('Success', 'Agent account created successfully', 'success');
                        resetCredentialForm();
                    } else {
                        Utils.showToast('Error', result.error, 'error');
                    }
                } catch (error) {
                    Utils.showToast('Error', error.message, 'error');
                }
            }
        }
        
        function resetCredentialForm() {
            document.getElementById('manualAgentEmail').value = '';
            document.getElementById('manualAgentId').value = '';
            document.getElementById('manualAgentPassword').value = '';
            document.getElementById('manualAgentPasswordConfirm').value = '';
            document.getElementById('agentCommissionRate').value = 5;
            document.getElementById('pendingAppsSelect').value = '';
            document.getElementById('sendCredentialsEmail').checked = true;
            document.getElementById('requirePasswordChange').checked = false;
            
            // Reset password strength indicator
            const strengthBar = document.getElementById('passwordStrength');
            if (strengthBar) {
                strengthBar.className = 'password-strength-bar';
                strengthBar.style.width = '0%';
            }
        }
        
        // ===== Customer Creation Functions =====
        function createCustomerAccount() {
            // Generate suggested password
            const suggestedPassword = Utils.generatePassword(12);
            
            document.getElementById('createCustomerPassword').value = suggestedPassword;
            document.getElementById('createCustomerPasswordConfirm').value = suggestedPassword;
            document.getElementById('createCustomerStatus').value = 'active';
            document.getElementById('createCustomerVerification').value = 'unverified';
            document.getElementById('createCustomerBalance').value = '0.00';
            
            openModal('createCustomerModal');
        }
        
        async function createNewCustomer() {
            const customerData = {
                fullName: document.getElementById('createCustomerName').value.trim(),
                email: document.getElementById('createCustomerEmail').value.trim(),
                phone: document.getElementById('createCustomerPhone').value.trim(),
                password: document.getElementById('createCustomerPassword').value,
                balance: document.getElementById('createCustomerBalance').value,
                status: document.getElementById('createCustomerStatus').value,
                verification: document.getElementById('createCustomerVerification').value
            };
            
            // Validate inputs
            if (!customerData.fullName) {
                Utils.showToast('Error', 'Please enter customer name', 'error');
                return;
            }
            
            if (!Utils.validateEmail(customerData.email)) {
                Utils.showToast('Error', 'Please enter a valid email', 'error');
                return;
            }
            
            if (!Utils.validatePhone(customerData.phone)) {
                Utils.showToast('Error', 'Please enter a valid phone number', 'error');
                return;
            }
            
            if (customerData.password.length < 8) {
                Utils.showToast('Error', 'Password must be at least 8 characters', 'error');
                return;
            }
            
            const passwordConfirm = document.getElementById('createCustomerPasswordConfirm').value;
            if (customerData.password !== passwordConfirm) {
                Utils.showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            try {
                Utils.showToast('Processing', 'Creating customer account...', 'info');
                const result = await FirebaseService.createCustomerAccount(customerData);
                
                if (result.success) {
                    Utils.showToast('Success', 'Customer account created successfully', 'success');
                    closeModal('createCustomerModal');
                    
                    // Clear form
                    document.getElementById('createCustomerName').value = '';
                    document.getElementById('createCustomerEmail').value = '';
                    document.getElementById('createCustomerPhone').value = '';
                    document.getElementById('createCustomerPassword').value = '';
                    document.getElementById('createCustomerPasswordConfirm').value = '';
                    document.getElementById('createCustomerBalance').value = '0.00';
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                Utils.showToast('Error', error.message, 'error');
            }
        }
        
        // ===== Settings Functions =====
        async function loadAllSettings() {
            try {
                const result = await FirebaseService.loadSettings();
                if (result.success) {
                    const settings = result.settings;
                    
                    // System Settings
                    document.getElementById('minTransaction').value = settings.transactionLimits?.min || 10;
                    document.getElementById('maxTransaction').value = settings.transactionLimits?.max || 10000;
                    document.getElementById('standardCommission').value = settings.commissionRates?.standard || 5;
                    document.getElementById('premiumCommission').value = settings.commissionRates?.premium || 7.5;
                    document.getElementById('transactionFee').value = settings.fees?.transaction || 1.5;
                    document.getElementById('minFee').value = settings.fees?.minFee || 0.50;
                    document.getElementById('latePenalty').value = settings.penaltySettings?.latePayment || 2;
                    document.getElementById('gracePeriod').value = settings.penaltySettings?.gracePeriod || 7;
                    document.getElementById('maintenanceMode').checked = settings.maintenance?.enabled || false;
                    document.getElementById('maintenanceMessage').value = settings.maintenance?.message || '';
                    
                    // Security Settings
                    
                    document.getElementById('loginNotifications').checked = settings.security?.loginNotifications || true;
                    document.getElementById('sessionTimeout').value = settings.security?.sessionTimeout || 30;
                    document.getElementById('maxLoginAttempts').value = settings.security?.maxLoginAttempts || 5;
                    document.getElementById('minPasswordLength').value = settings.security?.passwordPolicy?.minLength || 8;
                    document.getElementById('requireSpecialChars').value = settings.security?.passwordPolicy?.requireSpecialChars ? 'true' : 'false';
                    document.getElementById('passwordExpiry').value = settings.security?.passwordPolicy?.passwordExpiry || 90;
                    document.getElementById('passwordHistory').value = settings.security?.passwordPolicy?.passwordHistory || 5;
                    document.getElementById('ipWhitelist').value = settings.security?.ipWhitelist || '';
                    
                    // Notification Settings
                    document.getElementById('emailApplications').checked = settings.notifications?.email?.applications || true;
                    document.getElementById('emailTransactions').checked = settings.notifications?.email?.transactions || true;
                    document.getElementById('emailDisputes').checked = settings.notifications?.email?.disputes || true;
                    document.getElementById('emailSuspensions').checked = settings.notifications?.email?.suspensions || true;
                    document.getElementById('smsCritical').checked = settings.notifications?.sms?.critical || true;
                    document.getElementById('smsSecurity').checked = settings.notifications?.sms?.security || false;
                    document.getElementById('largeTxThreshold').value = settings.notifications?.thresholds?.largeTransaction || 1000;
                    document.getElementById('dailyReportTime').value = settings.notifications?.thresholds?.dailyReportTime || "08:00";
                    
                    // API Settings
                    document.getElementById('cloudinaryCloud').value = settings.api?.cloudinary?.cloudName || '';
                    document.getElementById('cloudinaryPreset').value = settings.api?.cloudinary?.uploadPreset || '';
                    document.getElementById('paymentGateway').value = settings.api?.paymentGateway?.provider || 'stripe';
                    document.getElementById('paymentApiKey').value = settings.api?.paymentGateway?.apiKey || '';
                    document.getElementById('paymentSecret').value = settings.api?.paymentGateway?.secret || '';
                    document.getElementById('webhookSecret').value = settings.api?.paymentGateway?.webhookSecret || '';
                    document.getElementById('smsGateway').value = settings.api?.smsGateway?.provider || 'twilio';
                    document.getElementById('smsAccountSid').value = settings.api?.smsGateway?.accountSid || '';
                    document.getElementById('smsAuthToken').value = settings.api?.smsGateway?.authToken || '';
                    document.getElementById('smsFromNumber').value = settings.api?.smsGateway?.fromNumber || '';
                    
                    Utils.showToast('Success', 'Settings loaded successfully', 'success');
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                Utils.showToast('Error', 'Failed to load settings', 'error');
            }
        }
        
        async function saveAllSettings() {
            try {
                const settings = {
                    transactionLimits: {
                        min: parseFloat(document.getElementById('minTransaction').value) || 10,
                        max: parseFloat(document.getElementById('maxTransaction').value) || 10000
                    },
                    commissionRates: {
                        standard: parseFloat(document.getElementById('standardCommission').value) || 5,
                        premium: parseFloat(document.getElementById('premiumCommission').value) || 7.5
                    },
                    fees: {
                        transaction: parseFloat(document.getElementById('transactionFee').value) || 1.5,
                        minFee: parseFloat(document.getElementById('minFee').value) || 0.50
                    },
                    penaltySettings: {
                        latePayment: parseFloat(document.getElementById('latePenalty').value) || 2,
                        gracePeriod: parseInt(document.getElementById('gracePeriod').value) || 7
                    },
                    notifications: {
                        email: {
                            applications: document.getElementById('emailApplications').checked,
                            transactions: document.getElementById('emailTransactions').checked,
                            disputes: document.getElementById('emailDisputes').checked,
                            suspensions: document.getElementById('emailSuspensions').checked
                        },
                        sms: {
                            critical: document.getElementById('smsCritical').checked,
                            security: document.getElementById('smsSecurity').checked
                        },
                        thresholds: {
                            largeTransaction: parseFloat(document.getElementById('largeTxThreshold').value) || 1000,
                            dailyReportTime: document.getElementById('dailyReportTime').value || "08:00"
                        }
                    },
                    security: {
                        
                        loginNotifications: document.getElementById('loginNotifications').checked,
                        sessionTimeout: parseInt(document.getElementById('sessionTimeout').value) || 30,
                        maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value) || 5,
                        passwordPolicy: {
                            minLength: parseInt(document.getElementById('minPasswordLength').value) || 8,
                            requireSpecialChars: document.getElementById('requireSpecialChars').value === 'true',
                            passwordExpiry: parseInt(document.getElementById('passwordExpiry').value) || 90,
                            passwordHistory: parseInt(document.getElementById('passwordHistory').value) || 5
                        },
                        ipWhitelist: document.getElementById('ipWhitelist').value || ''
                    },
                    maintenance: {
                        enabled: document.getElementById('maintenanceMode').checked,
                        message: document.getElementById('maintenanceMessage').value || ''
                    },
                    api: {
                        cloudinary: {
                            cloudName: document.getElementById('cloudinaryCloud').value || '',
                            uploadPreset: document.getElementById('cloudinaryPreset').value || ''
                        },
                        paymentGateway: {
                            provider: document.getElementById('paymentGateway').value || 'stripe',
                            apiKey: document.getElementById('paymentApiKey').value || '',
                            secret: document.getElementById('paymentSecret').value || '',
                            webhookSecret: document.getElementById('webhookSecret').value || ''
                        },
                        smsGateway: {
                            provider: document.getElementById('smsGateway').value || 'twilio',
                            accountSid: document.getElementById('smsAccountSid').value || '',
                            authToken: document.getElementById('smsAuthToken').value || '',
                            fromNumber: document.getElementById('smsFromNumber').value || ''
                        }
                    }
                };
                
                const result = await FirebaseService.saveSettings(settings);
                if (result.success) {
                    Utils.showToast('Success', 'All settings saved successfully', 'success');
                } else {
                    Utils.showToast('Error', result.error, 'error');
                }
            } catch (error) {
                Utils.showToast('Error', error.message, 'error');
            }
        }
        
        function resetAllSettings() {
            Swal.fire({
                title: 'Reset All Settings?',
                text: 'This will reset all settings to their default values. This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Reset All',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#FF3B30',
                cancelButtonColor: '#8E8E93'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // Clear all settings in Firebase
                        const settingsRef = db.ref('systemSettings');
                        await settingsRef.remove();
                        
                        // Reload default settings
                        await loadAllSettings();
                        
                        Utils.showToast('Success', 'All settings reset to default', 'success');
                    } catch (error) {
                        Utils.showToast('Error', 'Failed to reset settings', 'error');
                    }
                }
            });
        }
        
        // ===== Notification Functions =====
        async function markNotificationRead(notificationId) {
            try {
                const result = await FirebaseService.markNotificationRead(notificationId);
                if (result.success) {
                    // Notification UI will update automatically via real-time listener
                }
            } catch (error) {
                console.error('Error marking notification read:', error);
            }
        }
        
        // ===== Bulk Actions =====
        function toggleAppSelection(appId, checked) {
            if (checked) {
                AppState.selectedApps.add(appId);
            } else {
                AppState.selectedApps.delete(appId);
            }
            
            // Update select all checkbox
            const selectAll = document.getElementById('selectAllApps');
            const checkboxes = document.querySelectorAll('.app-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAll.checked = allChecked;
        }
        
        function showBulkActions() {
            const selectedCount = AppState.selectedApps.size;
            if (selectedCount === 0) {
                Utils.showToast('Info', 'Please select applications first', 'info');
                return;
            }
            
            const selectedItemsDiv = document.getElementById('selectedItems');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            selectedCountSpan.textContent = selectedCount;
            selectedItemsDiv.innerHTML = '';
            
            // Show selected items
            AppState.selectedApps.forEach(appId => {
                const app = AppState.applications.find(a => a.id === appId);
                if (app) {
                    const div = document.createElement('div');
                    div.style.padding = '4px 0';
                    div.style.borderBottom = '1px solid #eee';
                    div.textContent = `${app.fullName} (${app.id.substring(0, 8)}...)`;
                    selectedItemsDiv.appendChild(div);
                }
            });
            
            openModal('bulkActionsModal');
        }
        
        function processBulkAction() {
            const action = document.getElementById('bulkAction').value;
            const reason = document.getElementById('bulkReason').value.trim();
            
            if (!action) {
                Utils.showToast('Error', 'Please select an action', 'error');
                return;
            }
            
            if ((action === 'reject' || action === 'suspend') && !reason) {
                Utils.showToast('Error', 'Please provide a reason', 'error');
                return;
            }
            
            const appIds = Array.from(AppState.selectedApps);
            
            Swal.fire({
                title: 'Confirm Bulk Action',
                html: `
                    <p>Are you sure you want to ${action} ${appIds.length} selected application(s)?</p>
                    ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: `Yes, ${action.charAt(0).toUpperCase() + action.slice(1)}`,
                cancelButtonText: 'Cancel',
                confirmButtonColor: action === 'approve' ? '#34C759' : action === 'reject' ? '#FF3B30' : '#FF9500',
                cancelButtonColor: '#8E8E93'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        if (action === 'approve' || action === 'reject') {
                            Utils.showToast('Processing', `Processing ${action}...`, 'info');
                            const response = await FirebaseService.bulkUpdateApplications(appIds, action, reason);
                            
                            if (response.success) {
                                Utils.showToast('Success', `${response.count} applications ${action}d successfully`, 'success');
                                closeModal('bulkActionsModal');
                                
                                // Clear selections
                                AppState.selectedApps.clear();
                                document.querySelectorAll('.app-checkbox').forEach(cb => cb.checked = false);
                                document.getElementById('selectAllApps').checked = false;
                            } else {
                                Utils.showToast('Error', response.error, 'error');
                            }
                        } else if (action === 'export') {
                            const selectedApps = AppState.applications.filter(app => AppState.selectedApps.has(app.id));
                            Utils.exportToCSV(selectedApps, 'applications');
                            closeModal('bulkActionsModal');
                        }
                    } catch (error) {
                        Utils.showToast('Error', error.message, 'error');
                    }
                }
            });
        }
        
        // ===== Chart Functions =====
        function initializeCharts() {
            // Transaction Volume Chart
            const transactionCtx = document.getElementById('transactionChart');
            if (transactionCtx) {
                if (AppState.charts.transactionChart) {
                    AppState.charts.transactionChart.destroy();
                }
                
                // Generate sample data
                const labels = [];
                const data = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    data.push(Math.floor(Math.random() * 1000) + 500); // Random data
                }
                
                AppState.charts.transactionChart = new Chart(transactionCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Transactions',
                            data: data,
                            borderColor: '#007AFF',
                            backgroundColor: 'rgba(0, 122, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#007AFF',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#007AFF',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // User Distribution Chart
            const distributionCtx = document.getElementById('userDistributionChart');
            if (distributionCtx) {
                if (AppState.charts.userDistributionChart) {
                    AppState.charts.userDistributionChart.destroy();
                }
                
                AppState.charts.userDistributionChart = new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Customers', 'Agents', 'Admins'],
                        datasets: [{
                            data: [
                                AppState.customers.length, 
                                AppState.agents.length, 
                                1 // Assuming 1 admin
                            ],
                            backgroundColor: [
                                '#007AFF',
                                '#34C759',
                                '#5856D6'
                            ],
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
        }
        
        // ===== Utility UI Functions =====
        function updatePasswordStrength(password) {
            const strength = Utils.calculatePasswordStrength(password);
            const strengthBar = document.getElementById('passwordStrength') || document.getElementById('passwordStrengthBar');
            
            if (strengthBar) {
                let width = '0%';
                let className = '';
                
                switch(strength) {
                    case 1:
                        width = '25%';
                        className = 'strength-weak';
                        break;
                    case 2:
                        width = '50%';
                        className = 'strength-fair';
                        break;
                    case 3:
                        width = '75%';
                        className = 'strength-good';
                        break;
                    case 4:
                        width = '100%';
                        className = 'strength-strong';
                        break;
                }
                
                strengthBar.style.width = width;
                strengthBar.className = `password-strength-bar ${className}`;
            }
        }
        
        function viewDocument(url, title) {
            Swal.fire({
                title: title,
                html: `<img src="${url}" style="max-width: 100%; max-height: 400px; border-radius: 8px;">`,
                showCloseButton: true,
                showConfirmButton: false,
                width: 'auto',
                padding: '20px'
            });
        }
        
        function initTabs() {
            // Initialize tab functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    // Update active tab button
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show active tab content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }
        
        // ===== Navigation Functions =====
        function switchSection(sectionId) {
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });
            
            // Update active content section
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');
                }
            });
            
            // Update page title
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"] span`);
                pageTitle.textContent = activeLink ? activeLink.textContent : 'Dashboard';
            }
            
            // Update AppState
            AppState.currentView = sectionId;
            
            // Initialize charts if needed
            if (sectionId === 'overview') {
                setTimeout(initializeCharts, 100);
            }
            
            // Load settings if needed
            if (sectionId === 'settings') {
                loadAllSettings();
            }
        }
        
        // ===== Export Functions =====
        function exportApplications() {
            Utils.exportToCSV(AppState.applications, 'applications');
        }
        
        function exportAgents() {
            Utils.exportToCSV(AppState.agents, 'agents');
        }
        
        function exportCustomers() {
            Utils.exportToCSV(AppState.customers, 'customers');
        }
        
        function exportTransactions() {
            Utils.exportToCSV(AppState.transactions, 'transactions');
        }
        
        // ===== Refresh Functions =====
        function refreshApplications() {
            Utils.showToast('Refreshing', 'Loading applications...', 'info');
            // Data will refresh automatically via real-time listeners
        }
        
        function refreshAgents() {
            Utils.showToast('Refreshing', 'Loading agents...', 'info');
            // Data will refresh automatically via real-time listeners
        }
        
        function refreshCustomers() {
            Utils.showToast('Refreshing', 'Loading customers...', 'info');
            // Data will refresh automatically via real-time listeners
        }
        
        function refreshTransactions() {
            Utils.showToast('Refreshing', 'Loading transactions...', 'info');
            // Data will refresh automatically via real-time listeners
        }
        
        // ===== Modal Functions =====
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }
        
        // ===== Event Listeners =====
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.dataset.section;
                    switchSection(sectionId);
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 992) {
                        document.querySelector('.sidebar').classList.remove('active');
                    }
                });
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                FirebaseService.logout();
            });
            
            // Notification bell
            document.getElementById('notificationBell').addEventListener('click', () => {
                const dropdown = document.getElementById('notificationDropdown');
                dropdown.classList.toggle('active');
            });
            
            // Mark all notifications as read
            document.getElementById('markAllRead')?.addEventListener('click', async () => {
                try {
                    const result = await FirebaseService.markAllNotificationsRead();
                    if (result.success) {
                        Utils.showToast('Success', 'All notifications marked as read', 'success');
                    }
                } catch (error) {
                    Utils.showToast('Error', 'Failed to mark notifications as read', 'error');
                }
            });
            
            // Mobile menu toggle
            document.getElementById('mobileMenuToggle').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.notification-container')) {
                    document.getElementById('notificationDropdown').classList.remove('active');
                }
                
                // Close modals when clicking outside
                if (e.target.classList.contains('modal-overlay')) {
                    const openModal = document.querySelector('.modal-overlay.active');
                    if (openModal) {
                        openModal.classList.remove('active');
                        document.body.style.overflow = 'auto';
                    }
                }
            });
            
            // Search functionality
            document.getElementById('appSearch')?.addEventListener('input', Utils.debounce((e) => {
                filterApplications(e.target.value);
            }, 300));
            
            document.getElementById('agentSearch')?.addEventListener('input', Utils.debounce((e) => {
                filterAgents(e.target.value);
            }, 300));
            
            document.getElementById('customerSearch')?.addEventListener('input', Utils.debounce((e) => {
                filterCustomers(e.target.value);
            }, 300));
            
            // Filter functionality
            document.getElementById('appFilter')?.addEventListener('change', (e) => {
                filterApplicationsByStatus(e.target.value);
            });
            
            document.getElementById('agentFilter')?.addEventListener('change', (e) => {
                filterAgentsByStatus(e.target.value);
            });
            
            document.getElementById('customerFilter')?.addEventListener('change', (e) => {
                filterCustomersByStatus(e.target.value);
            });
            
            // Settings tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    // Update active tab button
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show active tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Suspension duration change
            document.getElementById('suspensionDuration')?.addEventListener('change', function() {
                const customGroup = document.getElementById('customDurationGroup');
                customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            // Password strength indicator
            document.getElementById('manualAgentPassword')?.addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
            
            // Select all applications
            document.getElementById('selectAllApps')?.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.app-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    const appId = cb.dataset.appId;
                    if (appId) {
                        AppState.selectedApps[this.checked ? 'add' : 'delete'](appId);
                    }
                });
            });
            
            // Bulk action change
            document.getElementById('bulkAction')?.addEventListener('change', function() {
                const reasonGroup = document.getElementById('bulkReasonGroup');
                reasonGroup.style.display = (this.value === 'reject' || this.value === 'suspend') ? 'block' : 'none';
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 992) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
            
            // Before unload
            window.addEventListener('beforeunload', () => {
                FirebaseService.cleanupListeners();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Escape key closes modals
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal-overlay.active');
                    if (openModal) {
                        openModal.classList.remove('active');
                        document.body.style.overflow = 'auto';
                    }
                    
                    // Close notification dropdown
                    document.getElementById('notificationDropdown').classList.remove('active');
                }
                
                // Ctrl + R to refresh current view
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    switch(AppState.currentView) {
                        case 'applications':
                            refreshApplications();
                            break;
                        case 'agents':
                            refreshAgents();
                            break;
                        case 'customers':
                            refreshCustomers();
                            break;
                        case 'transactions':
                            refreshTransactions();
                            break;
                    }
                }
            });
        }
        
        // ===== Filter Functions =====
        function filterApplications(searchTerm) {
            const rows = document.querySelectorAll('#applicationsBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }
        
        function filterApplicationsByStatus(status) {
            const rows = document.querySelectorAll('#applicationsBody tr');
            rows.forEach(row => {
                if (status === 'all') {
                    row.style.display = '';
                    return;
                }
                
                const statusCell = row.querySelector('.status-badge');
                if (statusCell) {
                    const rowStatus = statusCell.textContent.toLowerCase();
                    row.style.display = rowStatus.includes(status) ? '' : 'none';
                }
            });
        }
        
        function filterAgents(searchTerm) {
            const rows = document.querySelectorAll('#agentsBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }
        
        function filterAgentsByStatus(status) {
            const rows = document.querySelectorAll('#agentsBody tr');
            rows.forEach(row => {
                if (status === 'all') {
                    row.style.display = '';
                    return;
                }
                
                const statusCell = row.querySelector('.status-badge');
                if (statusCell) {
                    const rowStatus = statusCell.textContent.toLowerCase();
                    row.style.display = rowStatus.includes(status) ? '' : 'none';
                }
            });
        }
        
        function filterCustomers(searchTerm) {
            const rows = document.querySelectorAll('#customersBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }
        
        function filterCustomersByStatus(status) {
            const rows = document.querySelectorAll('#customersBody tr');
            rows.forEach(row => {
                if (status === 'all') {
                    row.style.display = '';
                    return;
                }
                
                const statusCell = row.querySelector('.status-badge:nth-of-type(1)');
                if (statusCell) {
                    const rowStatus = statusCell.textContent.toLowerCase();
                    row.style.display = rowStatus.includes(status) ? '' : 'none';
                }
            });
        }
        
        // ===== Initialize Application =====
        async function initializeApp() {
            try {
                // Check authentication
               
                
                // Setup real-time listeners
                FirebaseService.setupRealTimeListeners();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize charts
                setTimeout(initializeCharts, 500);
                
                // Update recent activity periodically
                setInterval(updateRecentActivity, 30000);
                
                // Initialize tabs
                initTabs();
                
                console.log('Admin dashboard initialized successfully');
                
                // Show welcome message
                setTimeout(() => {
                    Utils.showToast('Welcome', 'Admin dashboard loaded successfully', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Failed to initialize admin dashboard:', error);
                Utils.showToast('Initialization Error', 'Failed to load dashboard. Please refresh.', 'error');
            }
        }
        
        // ===== Start Application =====
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Make functions available globally
        window.viewApplication = viewApplication;
        window.approveApplicationModal = approveApplicationModal;
        window.rejectApplicationPrompt = rejectApplicationPrompt;
        window.viewAgent = viewAgent;
        window.toggleAgentStatus = toggleAgentStatus;
        window.viewCustomer = viewCustomer;
        window.toggleCustomerStatus = toggleCustomerStatus;
        window.viewTransaction = viewTransaction;
        window.approveTransaction = approveTransaction;
        window.rejectTransactionPrompt = rejectTransactionPrompt;
        window.reverseTransactionPrompt = reverseTransactionPrompt;
        window.viewDispute = viewDispute;
        window.resolveDisputePrompt = resolveDisputePrompt;
        window.markNotificationRead = markNotificationRead;
        window.closeModal = closeModal;
        window.openModal = openModal;
        window.createAgentAccount = createAgentAccount;
        window.createNewAgent = createNewAgent;
        window.createCustomerAccount = createCustomerAccount;
        window.createNewCustomer = createNewCustomer;
        window.openManualAgentCreation = openManualAgentCreation;
        window.saveAgentCredentials = saveAgentCredentials;
        window.resetCredentialForm = resetCredentialForm;
        window.updatePasswordStrength = updatePasswordStrength;
        window.updateSuspensionType = updateSuspensionType;
        window.processSuspension = processSuspension;
        window.activateAccount = activateAccount;
        window.activateSuspendedAccount = activateSuspendedAccount;
        window.activateBannedAccount = activateBannedAccount;
        window.banAccount = banAccount;
        window.viewDocument = viewDocument;
        window.showBulkActions = showBulkActions;
        window.processBulkAction = processBulkAction;
        window.toggleAppSelection = toggleAppSelection;
        window.refreshApplications = refreshApplications;
        window.refreshAgents = refreshAgents;
        window.refreshCustomers = refreshCustomers;
        window.refreshTransactions = refreshTransactions;
        window.exportApplications = exportApplications;
        window.exportAgents = exportAgents;
        window.exportCustomers = exportCustomers;
        window.exportTransactions = exportTransactions;
        window.loadAllSettings = loadAllSettings;
        window.saveAllSettings = saveAllSettings;
        window.resetAllSettings = resetAllSettings;
        
        // Global toast function
        window.showToast = Utils.showToast;
        
    </script>
</body>
</html>
